<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeyMaster Hub</title>
    <!-- Favicon embutido dinamicamente para evitar arquivos auxiliares -->
    <script>(function(){
        const dataUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD1ElEQVR4nO3U20+bdRjAcSKH0paNkxyGK3Mr7zuCKM6xw43RmHjhxYzx0guiZpvxSv0L+jJMN5d4iAccIZExbJCxuQQQZGycAqz03LcHaDvKochgFHR4mAOWrykmBgnvZCaNXvBcvjef7/O+v/eXkLA92/N/mqoO3nrvEpG3G1k6YeLOcROLbzQQrajn9nET5neaORLXgHebiQgSC4LEvCgxKxiYEaW1ZxOCgXDFeawna9DELeCEiSUlXJQIlRkJvnKOsWPVBF/6gpEXP8X7wifIz3+M49kPsR79APOhMww8baS/tIruklNc3V9JR7HEdyVVtD75Pl8d+ohyxYA3G/hJCRckAqIBvyjhESTcooRDMGATJYZFiSHBwIAo0SdI9AgGrokSnYJEh2igTTDQIkhcEQ1cOmikVjHg9QssxhMXDFwsP02zYkBFHdF44qJE4+GzfKMY8Fodc/HExUq+PnqWRsWAl9tZTA6w/MgUq4mTrCZOsJI4znJSmOWkMe4l3eT35CB3k4P8lhzg1+QAP6cEWEoZ4U7KCD+m+FlU+YiqvMyrvMypPMyqZGZSZabVLqa0wwTLTLQrBhyeYCVeuNrJpNrBeKGNUcWAA7e4H09c7WBMJxNWDHhqhvsPi2e34ttVj3kruNpBaK9MSDHgiWlW/xH/E/5r88LP6M5pxhbDU2VmHoRr7IzudRNUDCiOsKKEa6zczm3CW2SkO7OTQAxXO5kRJFp29hPM6sCpr+JyXiO9Owbxb4arbfgF1wPOQNEUKxvxtCFmdTXYBQO9j9ViyegipJJZiH3zjO/x6o20xDZPdTOd2YldV0ubUMkF3ZdcTu/Bth7XWPEWuxhRDNg3yfLGzQvPYdOfojerjYDKx8L6A1dQR1/BeXr+9todjGe30F9URV1hNU3rcY0FuUTGqxhQOM69jd881UU0pxlP0Wmu6Y1czWvEorEzrXIzW2TkSmYHzhiuHSaUb6JLf4aGfUbq85poTxvCvR7XWnGWuvEoBuwOr22/6WlXeYhmduHX1dCTfp2RnX2MCpVc1FgJxzbP6MKuq+bbrDYGNDZGN24ew7XD2MtkXIoBu25yd6v/eW4Tg3s+p1XptG+Ga4exHHDhVAzICa1tv6VLJt9Ed3YrNx4G15oxl7uwKwZkBfnl395wW8G1ZgaPuLEqB3iZjSeuvUH/c06uKwbkdnMyzUNk7ZLxEdX6mN/hYy7dy1yGh1uPevkhx0MkTyaS72ayQGZ8t0x4j5vQ4zIBvZNR0YV/vxtviQu51IWrzI3jGRnbQReWGH7MwquKAduzPQn/wfwBldiYi2xdxJcAAAAASUVORK5CYII=";
        try {
            let l = document.querySelector('link[rel~="icon"]'); if (!l) { l = document.createElement('link'); l.rel = 'icon'; document.head.appendChild(l); }
            l.href = dataUrl; l.type = 'image/png'; l.sizes = '32x32'; l.setAttribute('data-static','true');
            let p = document.querySelector('link[rel="icon"][sizes~="256x256"]'); if (!p) { p = document.createElement('link'); p.rel = 'icon'; p.type = 'image/png'; p.sizes = '256x256'; document.head.appendChild(p); }
            p.href = dataUrl; p.setAttribute('data-static','true');
            let a = document.querySelector('link[rel="apple-touch-icon"]'); if (!a) { a = document.createElement('link'); a.rel = 'apple-touch-icon'; document.head.appendChild(a); }
            a.href = dataUrl; a.setAttribute('data-static','true');
        } catch (_) {}
    })();</script>
<script>(function(){ try { (document.querySelectorAll('link[href*="icons8"], link[href*="img.icons8.com"], link[href$=".ico"]') || []).forEach(n => n.remove()); } catch(_){}
    try {
        const dataUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD1ElEQVR4nO3U20+bdRjAcSKH0paNkxyGK3Mr7zuCKM6xw43RmHjhxYzx0guiZpvxSv0L+jJMN5d4iAccIZExbJCxuQQQZGycAqz03LcHaDvKochgFHR4mAOWrykmBgnvZCaNXvBcvjef7/O+v/eXkLA92/N/mqoO3nrvEpG3G1k6YeLOcROLbzQQrajn9nET5neaORLXgHebiQgSC4LEvCgxKxiYEaW1ZxOCgXDFeawna9DELeCEiSUlXJQIlRkJvnKOsWPVBF/6gpEXP8X7wifIz3+M49kPsR79APOhMww8baS/tIruklNc3V9JR7HEdyVVtD75Pl8d+ohyxYA3G/hJCRckAqIBvyjhESTcooRDMGATJYZFiSHBwIAo0SdI9AgGrokSnYJEh2igTTDQIkhcEQ1cOmikVjHg9QssxhMXDFwsP02zYkBFHdF44qJE4+GzfKMY8Fodc/HExUq+PnqWRsWAl9tZTA6w/MgUq4mTrCZOsJI4znJSmOWkMe4l3eT35CB3k4P8lhzg1+QAP6cEWEoZ4U7KCD+m+FlU+YiqvMyrvMypPMyqZGZSZabVLqa0wwTLTLQrBhyeYCVeuNrJpNrBeKGNUcWAA7e4H09c7WBMJxNWDHhqhvsPi2e34ttVj3kruNpBaK9MSDHgiWlW/xH/E/5r88LP6M5pxhbDU2VmHoRr7IzudRNUDCiOsKKEa6zczm3CW2SkO7OTQAxXO5kRJFp29hPM6sCpr+JyXiO9Owbxb4arbfgF1wPOQNEUKxvxtCFmdTXYBQO9j9ViyegipJJZiH3zjO/x6o20xDZPdTOd2YldV0ubUMkF3ZdcTu/Bth7XWPEWuxhRDNg3yfLGzQvPYdOfojerjYDKx8L6A1dQR1/BeXr+9todjGe30F9URV1hNU3rcY0FuUTGqxhQOM69jd881UU0pxlP0Wmu6Y1czWvEorEzrXIzW2TkSmYHzhiuHSaUb6JLf4aGfUbq85poTxvCvR7XWnGWuvEoBuwOr22/6WlXeYhmduHX1dCTfp2RnX2MCpVc1FgJxzbP6MKuq+bbrDYGNDZGN24ew7XD2MtkXIoBu25yd6v/eW4Tg3s+p1XptG+Ga4exHHDhVAzICa1tv6VLJt9Ed3YrNx4G15oxl7uwKwZkBfnl395wW8G1ZgaPuLEqB3iZjSeuvUH/c06uKwbkdnMyzUNk7ZLxEdX6mN/hYy7dy1yGh1uPevkhx0MkTyaS72ayQGZ8t0x4j5vQ4zIBvZNR0YV/vxtviQu51IWrzI3jGRnbQReWGH7MwquKAduzPQn/wfwBldiYi2xdxJcAAAAASUVORK5CYII=";
        // remove all existing icon link tags and add a single static data-url favicon set
        (document.querySelectorAll('link[rel~="icon"], link[rel~="shortcut icon"], link[rel="apple-touch-icon"]') || []).forEach(n => n.remove());
        const i32 = document.createElement('link'); i32.rel = 'icon'; i32.type = 'image/png'; i32.sizes = '32x32'; i32.href = dataUrl; document.head.appendChild(i32);
        const i256 = document.createElement('link'); i256.rel = 'icon'; i256.type = 'image/png'; i256.sizes = '256x256'; i256.href = dataUrl; document.head.appendChild(i256);
        const a = document.createElement('link'); a.rel = 'apple-touch-icon'; a.href = dataUrl; document.head.appendChild(a);
    } catch(e){}
})();</script>
    <script>
    (function(){
        const svg = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
<defs>
  <linearGradient id="color-1" x1="8.379" y1="13.379" x2="23.621" y2="28.621" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#0081ed"/><stop offset="1" stop-color="#0033fd"/></linearGradient>
  <linearGradient id="color-2" x1="10.981" y1="5.124" x2="21.019" y2="15.161" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#7f78a1" stop-opacity="0.95"/><stop offset="1" stop-color="#7f78a1" stop-opacity="0.5"/></linearGradient>
  <linearGradient id="color-3" x1="6.966" y1="9.139" x2="25.034" y2="27.208" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ffffff" stop-opacity="0.6"/><stop offset="0.493" stop-color="#ffffff" stop-opacity="0"/><stop offset="0.997" stop-color="#ffffff" stop-opacity="0.3"/></linearGradient>
  <linearGradient id="color-4" x1="14.189" y1="18.982" x2="17.811" y2="22.604" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#ffffff" stop-opacity="0.8"/><stop offset="0.519" stop-color="#ffffff" stop-opacity="0.5"/><stop offset="1" stop-color="#ffffff" stop-opacity="0.6"/></linearGradient>
</defs>
<g fill="none" fill-rule="nonzero" stroke="none" transform="scale(8,8)">
  <path d="M22,29h-12c-1.657,0 -3,-1.343 -3,-3v-10c0,-1.657 1.343,-3 3,-3h12c1.657,0 3,1.343 3,3v10c0,1.657 -1.343,3 -3,3z" fill="url(#color-1)"/>
  <path d="M23,10v3.18c-0.31,-0.12 -0.65,-0.18 -1,-0.18h-1v-3c0,-2.76 -2.24,-5 -5,-5c-2.76,0 -5,2.24 -5,5v3h-1c-0.35,0 -0.69,0.06 -1,0.18v-3.18c0,-3.86 3.14,-7 7,-7c3.86,0 7,3.14 7,7z" fill="url(#color-2)"/>
  <path d="M16,3.5c3.584,0 6.5,2.916 6.5,6.5v3.184v0.353l0.333,0.118c0.997,0.354 1.667,1.297 1.667,2.345v10c0,1.379 -1.122,2.5 -2.5,2.5h-12c-1.378,0 -2.5,-1.121 -2.5,-2.5v-10c0,-1.048 0.67,-1.991 1.667,-2.345l0.333,-0.118v-0.353v-3.184c0,-3.584 2.916,-6.5 6.5,-6.5M10.5,13.5h0.5h10h0.5v-0.5v-3c0,-3.033 -2.467,-5.5 -5.5,-5.5c-3.033,0 -5.5,2.467 -5.5,5.5v3v0.5M16,3c-3.86,0 -7,3.14 -7,7v3.184c-1.163,0.413 -2,1.512 -2,2.816v10c0,1.657 1.343,3 3,3h12c1.657,0 3,-1.343 3,-3v-10c0,-1.304 -0.837,-2.403 -2,-2.816v-3.184c0,-3.86 -3.14,-7 -7,-7zM11,13v-3c0,-2.76 2.24,-5 5,-5c2.76,0 5,2.24 5,5v3h-10z" fill="url(#color-3)"/>
  <path d="M18,20c0,-1.105 -0.895,-2 -2,-2c-1.105,0 -2,0.895 -2,2c0,0.738 0.405,1.376 1,1.723c0,0.665 0,1.21 0,1.277c0,0.552 0.448,1 1,1c0.552,0 1,-0.448 1,-1c0,-0.067 0,-0.612 0,-1.277c0.595,-0.347 1,-0.985 1,-1.723z" fill="url(#color-4)"/>
</g>
</svg>`;
        try {
            // revoke previous icons (if any created via URL.createObjectURL)
            (document.querySelectorAll('link[rel~="icon"], link[rel~="shortcut icon"], link[rel="apple-touch-icon"]') || []).forEach(l => {
                try { const prev = l.getAttribute('data-object-url'); if (prev) URL.revokeObjectURL(prev); } catch(_){}
            });
            // create svg blob + object URL (keep for browsers that support svg favicons)
            const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
            const svgUrl = URL.createObjectURL(svgBlob);
            let link = document.querySelector('link[rel~="icon"]');
            if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
            link.href = svgUrl; link.setAttribute('data-object-url', svgUrl);
            let sc = document.querySelector('link[rel~="shortcut icon"]');
            if (!sc) { sc = document.createElement('link'); sc.rel = 'shortcut icon'; document.head.appendChild(sc); }
            sc.href = svgUrl; sc.setAttribute('data-object-url', svgUrl);
            let apple = document.querySelector('link[rel="apple-touch-icon"]');
            if (!apple) { apple = document.createElement('link'); apple.rel = 'apple-touch-icon'; document.head.appendChild(apple); }
            apple.href = svgUrl; apple.setAttribute('data-object-url', svgUrl);

            // produce PNG fallbacks by rasterizing the SVG at 256x256 and 32x32
            const img = new Image(); img.crossOrigin = 'anonymous';
            img.onload = function(){
                try {
                    const size = 256;
                    const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    // rounded bg
                    function roundRect(c,x,y,w,h,r){ c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); c.fill(); }
                    // preserve transparency (no background)
                    ctx.clearRect(0, 0, size, size);
                    try { ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high'; } catch(_){}
                    // draw the svg image to canvas (use full size to preserve original spacing)
                    ctx.drawImage(img, 0, 0, size, size);
                    try {
                        // immediate data-URL fallback (base64 PNG) — Firefox tends to prefer data URLs for bookmarks
                        try {
                            const dataUrl256 = canvas.toDataURL('image/png');
                            let iconP = document.querySelector('link[rel~="icon"][type="image/png"][sizes~="256x256"]');
                            if (!iconP) { iconP = document.createElement('link'); iconP.rel = 'icon'; iconP.type = 'image/png'; iconP.sizes = '256x256'; document.head.appendChild(iconP); }
                            iconP.href = dataUrl256; iconP.setAttribute('data-url-fallback','data');

                            const canvas32 = document.createElement('canvas'); canvas32.width = 32; canvas32.height = 32;
                            const ctx32 = canvas32.getContext('2d'); ctx32.drawImage(canvas, 0, 0, 32, 32);
                            const dataUrl32 = canvas32.toDataURL('image/png');
                            let icon32 = document.querySelector('link[rel~="icon"][sizes~="32x32"]');
                            if (!icon32){ icon32 = document.createElement('link'); icon32.rel = 'icon'; icon32.type = 'image/png'; icon32.sizes = '32x32'; document.head.appendChild(icon32); }
                            icon32.href = dataUrl32; icon32.setAttribute('data-url-fallback','data');

                            let apple2 = document.querySelector('link[rel="apple-touch-icon"]');
                            if (!apple2) { apple2 = document.createElement('link'); apple2.rel = 'apple-touch-icon'; document.head.appendChild(apple2); }
                            apple2.href = dataUrl256; apple2.setAttribute('data-url-fallback','data');
                        } catch(e){ console.warn('dataURL fallback failed', e); }

                        // also keep object URL fallback (some browsers prefer it) — revoke previous ones first
                        canvas.toBlob(function(blob){ if (!blob) return; const pngUrl = URL.createObjectURL(blob);
                            let iconPobj = document.querySelector('link[rel~="icon"][type="image/png"][sizes~="256x256"]');
                            if (!iconPobj) { iconPobj = document.createElement('link'); iconPobj.rel = 'icon'; iconPobj.type = 'image/png'; iconPobj.sizes = '256x256'; document.head.appendChild(iconPobj); }
                            iconPobj.href = pngUrl; iconPobj.setAttribute('data-object-url', pngUrl);
                            // 32x32 object URL
                            const canvas32b = document.createElement('canvas'); canvas32b.width = 32; canvas32b.height = 32; canvas32b.getContext('2d').drawImage(canvas, 0, 0, 32, 32);
                            canvas32b.toBlob(function(b32){ if (!b32) return; const png32Url = URL.createObjectURL(b32); let icon32obj = document.querySelector('link[rel~="icon"][sizes~="32x32"]'); if (!icon32obj){ icon32obj = document.createElement('link'); icon32obj.rel = 'icon'; icon32obj.type = 'image/png'; icon32obj.sizes = '32x32'; document.head.appendChild(icon32obj); } icon32obj.href = png32Url; icon32obj.setAttribute('data-object-url', png32Url);
                                let appleObj = document.querySelector('link[rel="apple-touch-icon"]'); if (!appleObj) { appleObj = document.createElement('link'); appleObj.rel = 'apple-touch-icon'; document.head.appendChild(appleObj); } appleObj.href = pngUrl; appleObj.setAttribute('data-object-url', pngUrl);
                            }, 'image/png');
                        }, 'image/png');
                    } catch(e){ console.warn('svg->png failed', e); }
                } catch(e) { console.warn('svg->png failed', e); }
            };
            img.onerror = function(){ /* ignore */ };
            img.src = svgUrl;

            // small timeout to encourage browsers to re-evaluate
            setTimeout(()=>{ try { document.title = document.title; } catch(_){} }, 100);
            console.log('favicon updated via blob URL + png fallback');
        } catch (err) { console.warn('favicon set failed', err); }
    })();
    </script>
    <!-- Acelera conexão com CDN dos scripts (CryptoJS) em redes móveis -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <style>
:root {

--border-radius-main: 24px;
--border-radius-inner: 16px;
--blur-intensity: 15px;
--background-color: rgba(23, 42, 69, 0.75); 
--border-color: rgba(173, 216, 230, 0.15); 
--text-color: #f0f0f0;
--shadow-color: rgba(0, 0, 0, 0.25);
--dark-blue-bg: #0d1b2a;
}

#theme-toggle-btn {
position: fixed;
top: 15px;
right: 15px;
width: 48px;
height: 48px;
border-radius: 50%;
border: 1px solid var(--border-color);
background-color: var(--background-color);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
cursor: pointer;
z-index: 1001;
display: flex;
justify-content: center;
align-items: center;
transition: all 0.3s ease;
padding: 8px;
}

#theme-toggle-btn:hover {
transform: scale(1.1) rotate(15deg);
box-shadow: 0 4px 15px var(--shadow-color);
}

#theme-toggle-btn .icon-sun { display: block; }
#theme-toggle-btn .icon-moon { display: none; }

body[data-theme="light"] #theme-toggle-btn .icon-sun { display: none; }
body[data-theme="light"] #theme-toggle-btn .icon-moon { display: block; }

#floating-wrench-btn {
position: fixed;
bottom: 15px;
left: 15px;
width: 48px;
height: 48px;
border-radius: 50%;
border: 1px solid var(--border-color);
background-color: var(--background-color);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
cursor: pointer;
z-index: 1001;
display: flex;
justify-content: center;
align-items: center;
transition: all 0.3s ease;
padding: 8px;
}
#floating-wrench-btn:hover {
transform: scale(1.1) rotate(-15deg);
box-shadow: 0 4px 15px var(--shadow-color);
}



#login, #certificado, #anotacoesLogin, #acessoEspecial, #recuperarPin {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border-radius: var(--border-radius-main);
border: 1px solid var(--border-color);
box-shadow: 0 8px 32px 0 var(--shadow-color);
max-width: 550px; 
width: 100%;
padding: 40px;
margin: 40px auto;
transition: all 0.3s ease;
}


#app, #anotacoesApp, #autoFillSettings, #autoFillForm {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border-radius: var(--border-radius-main);
border: 1px solid var(--border-color);
box-shadow: 0 8px 32px 0 var(--shadow-color);
max-width: 1200px; 
width: 100%;
padding: 40px 30px;
margin: 40px auto;
transition: all 0.3s ease;
}


h1, h2.page-title {
font-size: 1.8rem;
font-weight: 600;
text-align: center;
margin-bottom: 30px;
text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.input-container {
position: relative;
width: 100%;

}
input[type="password"], input[type="text"], input[type="tel"], textarea {
width: 100%;
padding: 14px 16px;
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
font-size: 1rem;
background: var(--input-bg);
color: var(--text-color);
resize: vertical;
transition: all 0.3s ease;

}

/* Estilos responsivos para campos personalizados (compatível mobile + desktop) */
.custom-field-row {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
}
.custom-field-row .input-custom-type {
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 0.95rem;
}
.custom-field-row > .input-container {
    display: flex;
    align-items: center;
    gap: 8px;
}
.custom-field-row .input-custom-value {
    flex: 1 1 auto;
    min-width: 120px;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-color);
}
.custom-field-row .btn-clear-field,
.custom-field-row .btn-remove-custom {
    height: 36px;
    width: 36px;
    min-width: 36px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: transparent;
}
.custom-field-row .btn-clear-field { font-size: 16px; }

@media (min-width: 900px) {
    .custom-field-row {
        flex-direction: row;
        align-items: flex-start;
    }
    .custom-field-row .input-custom-type {
        flex: 0 0 320px;
        max-width: 40%;
        margin-bottom: 0;
    }
    .custom-field-row > .input-container {
        flex: 1 1 auto;
    }
}

#modalSenha .input-container input, #modalSenha .input-container textarea {
padding-right: 35px; 
}

#formAnotacao .input-container input, #formAnotacao .input-container textarea {
    padding-right: 35px;
}


.input-container input {
margin-bottom: 0;
}

#gmail-helper, #gmail-helper-anotacao {
  position: absolute;
}

input[type="password"]:focus, input[type="text"]:focus, input[type="tel"]:focus, textarea:focus {
outline: none;
border-color: var(--primary-accent);
box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
background: var(--input-focus-bg);
}

button {
cursor: pointer;
border: none;
background-color: var(--button-bg);
color: var(--button-text-color);
padding: 10px 16px;
border-radius: var(--border-radius-inner);
font-size: 0.95rem;
font-weight: 600;
transition: all 0.3s ease;
user-select: none;
border: 1px solid var(--border-color);
}

button:hover {
background-color: var(--button-hover-bg);
transform: translateY(-2px);
}

button:active {
transform: translateY(0);
}

.login-buttons button, .modalButtons button[type="submit"], #btnInstalar, #btn-autofill-save, #btnVerificarSenhaEspecial, #btnPinRecuperadoConcluido, #btnRealizarUpload {
background-color: var(--primary-accent);
border: none;
color: white;
}

.message-box button.primary-action {
background-color: var(--primary-accent);
border: none;
color: white;
}
.message-box button.primary-action:hover {
background-color: var(--primary-accent-hover);
}

.login-buttons button:hover, .modalButtons button[type="submit"]:hover, #btnInstalar:hover, #btn-autofill-save:hover, #btnVerificarSenhaEspecial:hover, #btnPinRecuperadoConcluido:hover, #btnRealizarUpload:hover {
background-color: var(--primary-accent-hover);
}


#app, #anotacoesApp {
display: none;
}

#certificado, #anotacoesLogin, #autoFillSettings, #autoFillForm, #acessoEspecial, #recuperarPin {
display: none;
text-align: center;
}

#pin-container {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0;
}

.pin-input {
width: 50px;
height: 60px;
font-size: 2rem;
text-align: center;
caret-color: var(--primary-accent);
}


#forgot-pin-link {
display: block;
text-align: center;
margin-top: 15px;
cursor: pointer;
font-size: 0.9em;
color: rgba(255, 255, 255, 0.6);
transition: color 0.3s ease;
}
body[data-theme="light"] #forgot-pin-link {
color: rgba(0, 0, 0, 0.6);
}
#pin-recuperado-container {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0;
}
.pin-recuperado-box {
width: 50px;
height: 60px;
font-size: 2rem;
text-align: center;
line-height: 60px;
background-color: var(--input-bg);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
color: var(--text-color);
font-weight: bold;
}


.top-bar {
display: flex;
justify-content: space-between;
align-items: center;
gap: 10px;
margin-bottom: 20px;
}

#boards, #anotacoesBoards {
display: flex;
gap: 20px;
justify-content: center;
flex-wrap: wrap;
margin-top: 20px;
}

.board-column {
background: var(--input-bg);
border-radius: var(--border-radius-inner);
box-shadow: 0 5px 15px var(--shadow-color);
width: 300px; 
padding: 16px;
transition: 0.3s;
display: flex;
flex-direction: column;
border: 1px solid var(--border-color);
}

.board-column h3 {
margin-top: 0;
font-size: 1.1rem;
display: flex;
justify-content: space-between;
align-items: center;
gap: 8px;
cursor: pointer;
user-select: none;
}

.btn-excluir-categoria {
background-color: rgba(231, 76, 60, 0.5);
color: white;
font-weight: 600;
border-radius: 50%;
width: 24px;
height: 24px;
line-height: 22px;
text-align: center;
padding: 0;
cursor: pointer;
border: none;
font-size: 1.2rem;
display: flex;
justify-content: center;
align-items: center;
transition: background-color 0.3s ease;
}

.btn-excluir-categoria:hover {
background-color: rgba(192, 57, 43, 0.8);
}

.card {
border-radius: 12px;
padding: 12px;
margin-bottom: 12px;
font-size: 0.95rem;
background: var(--background-color);
position: relative;
text-align: left;
box-shadow: inset 0 0 0 1px var(--border-color);
display: flex;
flex-direction: column;
}

/* Borda colorida para cards com marcador */
.card[data-marcador-cor] {
box-shadow: none;
border: 2px solid var(--marcador-cor);
}

/* Borda mais destacada para marcadores importantes */
.card[data-marcador-importante="true"] {
border-width: 3px;
}

/* Brilho no modal quando editando item com marcador importante */
#modalSenha.marcador-importante-ativo .modalContent,
#modalAnotacao.marcador-importante-ativo .modalContent {
border: 3px solid var(--marcador-cor-importante);
box-shadow: 0 0 20px var(--marcador-cor-importante), 0 8px 32px 0 var(--shadow-color);
}

/* Layout simplificado das cartas de senha */
.card .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}
.card .card-title {
    font-size: 1.02rem;
}
.card .card-meta {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
}
.card .chip {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* texto do mesmo lado da seção */
    gap: 10px;
    width: 100%;
    min-height: 40px;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    border-radius: var(--border-radius-inner);
    font-size: 0.9rem;
}
.card .chip-label {
    opacity: 0.7;
}
.card .chip-value {
    font-weight: 600;
    flex: 1 1 auto;  /* ocupa o restante sem empurrar para o outro lado */
    min-width: 0;     /* necessário para ellipsis com flex */
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
.card .chip-value a {
    color: var(--primary-accent);
    text-decoration: none;
}
.card .chip-value a:hover {
    text-decoration: underline;
}
.card .chip-label::after {
    content: ":";
    margin: 0 4px 0 2px;
    opacity: 0.6;
}
.card .notas-preview {
    margin-top: 14px;
    padding: 8px 10px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    font-size: 0.9rem;
    color: var(--text-color);
    line-height: 1.4;
    width: 100%;
    min-height: calc(1.4em * 3); /* altura consistente para 3 linhas */
    display: -webkit-box;
    line-clamp: 3;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.card .links-chip {
    margin-top: 12px;
}
.card .links-chip a {
    display: block;
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--input-bg);
    color: var(--primary-accent);
    text-decoration: none;
    font-size: 0.9rem;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
.card .links-chip a:hover {
    text-decoration: underline;
}

strong {
color: var(--strong-text-color);
font-weight: 600;
}

.notas-box {
background: var(--input-bg);
border-radius: 8px;
padding: 8px 10px;
margin-top: 6px;
white-space: pre-wrap;
word-wrap: break-word;
}
.links-box {
margin-top: 8px;
word-break: break-word;
}

.links-box a {
color: var(--primary-accent);
text-decoration: none;
word-break: break-word;
}



.message-box.improvements {
    z-index: 12001 !important;
    box-shadow: 0 18px 50px rgba(0,0,0,0.55) !important;
}
.card-buttons {
    display: flex !important;
    justify-content: center;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: nowrap !important; /* manter os botões em linha sempre */
    overflow-x: auto !important; /* permitir rolagem horizontal em telas pequenas */
    -webkit-overflow-scrolling: touch !important;
    padding-bottom: 6px !important;
}

.card-buttons button {
    flex: 0 0 auto !important;
    white-space: nowrap !important;
}

.card-buttons button {
padding: 6px 14px;
font-size: 0.85rem;
border-radius: 8px;
background-color: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.12);
display: flex;
align-items: center;
justify-content: center;
}

.card-buttons button.visualizar-icone {
padding: 6px;
}
.card-buttons button.visualizar-icone svg {
width: 20px;
height: 20px;
}

.card-buttons button:hover {
background-color: rgba(255, 255, 255, 0.15);
}

.card-buttons button.excluir {
background-color: var(--danger-accent);
border: none;
}
.card-buttons button.excluir:hover {
background-color: #c0392b;
}

/* Botão de Visualização Completa (CTA) ocupando toda a largura do card */
.card .full-view-btn {
    width: 100%;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    height: 44px;
    border-radius: 10px;
    background: var(--primary-accent);
    color: #fff;
    border: none;
    box-shadow: 0 4px 12px var(--shadow-color);
    transition: transform 0.12s ease, box-shadow 0.2s ease, background 0.2s ease;
}
.card .full-view-btn:hover {
    background: var(--primary-accent-hover);
    transform: translateY(-1px);
    box-shadow: 0 6px 16px var(--shadow-color);
}
.card .full-view-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px var(--shadow-color);
}
.card .full-view-btn svg {
    width: 20px;
    height: 20px;
}
.card .full-view-btn .btn-label {
    font-size: 0.95rem;
}

@media (max-width: 480px) {
    .card .full-view-btn {
        height: 40px;
        gap: 8px;
    }
    .card .full-view-btn svg {
        width: 18px;
        height: 18px;
    }
    .card .full-view-btn .btn-label {
        font-size: 0.9rem;
    }
}

.modal {
position: fixed;
inset: 0;
background: rgba(10, 10, 10, 0.3);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
display: none;
align-items: center;
justify-content: center;
z-index: 999;
padding: 20px;
}


.modalContent {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border: 1px solid var(--border-color);
border-radius: var(--border-radius-main);
padding: 32px;
width: 100%;
max-width: 800px; 
box-shadow: 0 8px 32px 0 var(--shadow-color);
text-align: center;
display: flex;
flex-direction: column;
max-height: 90vh;
overflow-y: auto;
-webkit-overflow-scrolling: touch;
 touch-action: pan-y;
}

/* Específico: forçar altura e overflow no modal de senhas para permitir rolagem eficiente em mobile */
#modalSenha .modalContent {
    max-height: calc(100vh - 120px) !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    touch-action: pan-y !important;
}

/* Simulador: grid de gráficos pequenos (visual preferencial sobre texto) */
.sim-chart-grid {
    display: grid;
    grid-template-columns: 1fr; /* coluna única, empilhado */
    gap: 14px;
    align-items: center;
}
.sim-chart-card {
    display: flex;
    flex-direction: column; /* vertical */
    gap: 8px;
    align-items: center;
    justify-content: center;
    padding: 12px 8px;
    border-radius: 12px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
}
/* Progress container */
.sim-progress { width:100%; height:14px; border-radius:8px; background: rgba(0,0,0,0.06); overflow:hidden; border:1px solid var(--border-color); }
.sim-progress-fill { transition: width 450ms cubic-bezier(.2,.9,.2,1); height:100%; width:0%; border-radius:8px; }
.sim-progress-fill.storage { background: linear-gradient(90deg, var(--primary-accent), var(--primary-accent-hover)); }
.sim-progress-fill.reads { background: linear-gradient(90deg, #00ff9d, #00d4ff); }
.sim-progress-fill.writes { background: linear-gradient(90deg, #ffd54f, #ff6b6b); }
.sim-progress-fill.deletes { background: linear-gradient(90deg, #ff9d9d, #ff6b6b); }

.sim-chart-label { text-align: center; }
.sim-value { font-weight:700; font-size:1.05rem; color: var(--text-color); }
.sim-pct { font-size:0.95rem; color: var(--text-color); opacity:0.75; margin-top:4px; }

/* Mensagem de resumo do Simulador */
.sim-summary { color: var(--text-color); text-align:center; font-size:0.95rem; margin-top:8px; }

/* Ensure progress container visible in both themes */
.sim-progress { background: rgba(0,0,0,0.06); }
body[data-theme="light"] .sim-progress { background: rgba(0,0,0,0.06); }

/* Light theme tweaks for better contrast */
body[data-theme="light"] .sim-progress { background: rgba(0,0,0,0.06); }
body[data-theme="light"] .sim-chart-card { background: #ffffff; }
body[data-theme="light"] .sim-progress-fill.storage { background: linear-gradient(90deg, var(--primary-accent), var(--primary-accent-hover)); }
body[data-theme="light"] .sim-progress-fill.reads { background: linear-gradient(90deg, #00c37a, #00a6e0); }
body[data-theme="light"] .sim-progress-fill.writes { background: linear-gradient(90deg, #f7c844, #ff897a); }
body[data-theme="light"] .sim-progress-fill.deletes { background: linear-gradient(90deg, #ff8b8b, #ff6b6b); }

/* Hidden categories box (Funções Adicionais) */
.hidden-list { display:flex; flex-direction:column; gap:8px; }
.hidden-item { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); }
.hidden-item .name { font-weight:600; color: var(--text-color); }
.hidden-item .actions { display:flex; gap:8px; }
.hidden-item .actions button { padding:6px 8px; font-size:0.85rem; border-radius:6px; border:1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); cursor:pointer; }
.hidden-item .actions button.restore { background: linear-gradient(90deg,#00c37a,#00a6e0); color:#fff; border:none; }
.hidden-item .actions button.delete { background: transparent; color: #ff6b6b; border-color: rgba(255,107,107,0.12); }

/* Brand block - text-only */
.site-brand {
    display: flex;
    align-items: center;
    gap: 8px;
}
.site-brand .brand-text {
    font-size: 1.2rem;
    font-weight: 800;
    color: var(--text-color);
    letter-spacing: 0.4px;
}
/* Make top-bar title align naturally when brand is present */
.top-bar h1 {
    text-align: left;
    margin-bottom: 0;
    font-size: 1.05rem;
}
@media (max-width: 800px) {
    .site-brand .brand-text { font-size: 1rem; }
    .top-bar h1 { font-size: 1rem; }
}

.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 20px;
    margin-bottom: 20px;
}

.grid-span-2 {
    grid-column: span 2; 
}


@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr; 
        gap: 16px;
    }
    .grid-span-2 {
        grid-column: span 1; 
    }
    .modalContent {
      max-width: 400px; 
    }
}


#btn-autofill-trigger {
width: 100%;
margin-bottom: 20px;
padding: 8px;
font-size: 0.9rem;
}

.modalContent h2 {
margin-top: 0;
font-size: 1.4rem;
margin-bottom: 20px;
}

.modalButtons {
display: flex;
justify-content: center;
gap: 20px;
margin-top: 20px;
flex-wrap: wrap;
}

.modalButtons button {
min-width: 100px;
padding: 10px 0;
}

/* Forçar modal específico a ficar centralizado e com largura adequada no desktop */
#modalRelatorioBugs .modalContent {
    width: min(92%, 520px);
    max-width: 520px;
    margin: 0 auto;
}
#modalRelatorioBugs .modalContent input[type="password"] { min-width: 160px; }
#modalRelatorioBugs .modalContent .login-buttons { white-space: nowrap; }

/* Botões do formulário de autofill alinhados lado a lado (especialmente no desktop) */
#autoFillForm .modalButtons {
    flex-wrap: nowrap;
    justify-content: flex-end;
    gap: 12px;
}

#autoFillForm .modalButtons button {
    min-width: 130px;
    padding: 10px 14px;
    flex: 0 0 auto;
}

@media (max-width: 540px) {
    #autoFillForm .modalButtons {
        flex-wrap: wrap;
        justify-content: center;
    }
    #autoFillForm .modalButtons button {
        flex: 1 1 48%;
    }
}

#modalDesenvolvimento .modalButtons {
  flex-direction: column;
}
#modalDesenvolvimento .main-actions {
  display: flex;
  gap: 10px;
  width: 100%;
}
#modalDesenvolvimento .main-actions button {
  flex: 1;
}


#new-column-name, #new-anotacao-column-name {
margin-bottom: 10px;
font-size: 1rem;
padding: 10px 14px;
}

#btnAdicionarCategoria, #btnAdicionarAnotacaoCategoria {
margin-bottom: 30px;
width: 100%;
font-size: 1rem;
}

.filter-controls {
display: none;
flex-direction: column;
gap: 10px;
margin-bottom: 30px;
}
.filter-controls input {
margin-bottom: 0;
}
.filter-buttons-container {
display: flex;
gap: 10px;
}
.filter-buttons-container button {
flex: 1;
}


.modo-leitura .card-buttons button:not(.visualizar) {
display: none !important;
}


.modo-leitura .board-column > button,
.modo-leitura .btn-excluir-categoria,
.modo-leitura .top-bar button:not(#btnModoLeitura):not(#btnModoLeituraAnotacao),
.modo-leitura .modalButtons {
display: none !important;
}

.modo-leitura .filter-controls {
display: flex !important;
}

.modo-leitura #new-column-name,
.modo-leitura #btnAdicionarCategoria,
.modo-leitura #new-anotacao-column-name,
.modo-leitura #btnAdicionarAnotacaoCategoria {
display: none;
}

#visualizacao-content {
text-align: left;
word-wrap: break-word;
font-size: 0.95rem;
}

#visualizacao-content p {
margin-bottom: 8px;
line-height: 1.4;
}

.footerButtons {
margin-top: 40px;
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 20px;
}

.login-buttons {
display: flex;
flex-direction: column;
gap: 10px;
margin-top: 10px;
}

.login-buttons .row {
display: flex;
gap: 10px;
}

.login-buttons button {
flex: 1;
padding: 14px 0;
}


#version-link {
text-align: center;
margin-top: 15px;
cursor: pointer;
font-size: 0.9em;
color: rgba(255,255,255,0.6); 
transition: color 0.3s ease;
}
body[data-theme="light"] #version-link {
color: rgba(0,0,0,0.6); 
}


.codigo-box {
background: var(--input-bg);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
padding: 20px;
margin: 20px 0;
font-size: 1rem;
font-weight: bold;
letter-spacing: 2px;
min-height: 60px;
}
.codigo-box.clickable { cursor: pointer; }

.message-box {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
border: 1px solid var(--border-color);
padding: 30px;
border-radius: var(--border-radius-main);
box-shadow: 0 10px 30px var(--shadow-color);
text-align: center;
/* aumentar z-index para garantir que mensagens fiquem acima de outros widgets como #mi_summary */
z-index: 21500 !important;
display: none;
max-width: 90%;
width: 400px;
    max-height: 90vh;
    overflow-y: auto;
    box-sizing: border-box;
animation: fadeIn 0.3s ease-out;
}

.message-box h2 {
margin-top: 0;
color: var(--text-color);
}

.changelog {
  text-align: left;
  margin-top: 15px;
  padding-left: 20px;
  font-size: 0.9rem;
  max-height: 200px;
  overflow-y: auto;
}
.changelog li {
  margin-bottom: 8px;
}

.message-box button {
margin-top: 20px;
min-width: 120px;
}

.overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
z-index: 998;
display: none;
}

@keyframes fadeIn {
from { opacity: 0; transform: translate(-50%, -45%); }
to { opacity: 1; transform: translate(-50%, -50%); }
}

.loader {
border: 4px solid var(--input-bg);
border-top: 4px solid var(--text-color);
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 20px auto;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.progress-container {
width: 100%;
background-color: var(--input-bg);
border-radius: 10px;
margin: 20px 0;
overflow: hidden;
}

.progress-bar {
height: 20px;
background-color: var(--primary-accent);
border-radius: 10px;
width: 0%;
transition: width 0.5s ease;
}

.status-message {
margin: 10px 0;
font-size: 0.9rem;
min-height: 20px;
}


#update-dialog {
  color: var(--text-color);
  padding: 15px;
  border-radius: var(--border-radius-inner);
  text-align: center;
  font-size: 0.9rem;
  line-height: 1.5;
  width: 100%;
  margin: 20px 0 15px 0;
  border: 1px solid var(--border-color);
  background: var(--input-bg);
}
#btnRealizarUpload {
width: 100%;
padding: 12px 0;
font-size: 0.95rem;
margin-top: 15px;
}

/* Ações auxiliares abaixo do upload */
.helper-actions { 
    margin-top: 10px; 
    text-align: center; 
}
.link-like {
    display: block;
    width: fit-content;
    margin: 0 auto;
    background: transparent;
    border: none;
    padding: 8px 0;
    color: var(--primary-accent);
    text-decoration: underline;
    font-weight: 600;
}
.link-like:hover { 
    color: var(--primary-accent-hover);
    background: transparent; 
    transform: none; 
}

/* Timeline de instruções móveis */
.timeline {
    margin-top: 10px;
    padding-left: 8px;
    border-left: 2px solid var(--border-color);
    text-align: left; /* garante conteúdo alinhado à esquerda mesmo com o container centralizado */
}
.timeline-item {
    position: relative;
    display: flex;
    gap: 12px;
    padding: 10px 0 10px 12px;
}
.timeline-item .marker {
    position: relative;
    width: 28px;
    height: 28px;
    min-width: 28px;
    border-radius: 50%;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px var(--shadow-color);
}
.timeline-item .marker svg {
    width: 18px; height: 18px;
    stroke: var(--text-color);
}
.timeline-item .content { 
    flex: 1; 
}
.timeline-item .content strong { 
    display: inline-block; 
    margin-bottom: 4px; 
}
.timeline-item .content p { 
    margin: 0; 
    opacity: 0.85; 
    font-size: 0.9rem; 
}


.btn-clear-field {
position: absolute;
top: 50%;
right: 10px;
transform: translateY(-50%);
background: transparent;
border: none;
color: var(--text-color);
font-size: 1.5rem;
font-weight: bold;
line-height: 1;
padding: 0 5px;
cursor: pointer;
display: none; 
opacity: 0.6;
z-index: 5;
transition: right 0.3s ease; 
}
.btn-clear-field:hover {
opacity: 1;
background: none;
transform: translateY(-50%) scale(1.1);
}
</style>
<style>
:root {

--border-radius-main: 24px;
--border-radius-inner: 16px;
--blur-intensity: 15px;
--background-color: rgba(23, 42, 69, 0.75); 
--border-color: rgba(173, 216, 230, 0.15); 
--text-color: #f0f0f0;
--shadow-color: rgba(0, 0, 0, 0.25);
--primary-accent: #007aff;
--primary-accent-hover: #0056b3;
--danger-accent: #ff3b30;
--dark-blue-bg: #0d1b2a; 
--body-bg: linear-gradient(135deg, var(--dark-blue-bg), #1a1a1a);
--input-bg: rgba(13, 27, 42, 0.5); 
--input-focus-bg: rgba(13, 27, 42, 0.7);
--input-placeholder-color: rgba(255,255,255,0.5);
--button-bg: rgba(173, 216, 230, 0.1);
--button-hover-bg: rgba(173, 216, 230, 0.2);
--button-text-color: #fff;
--strong-text-color: #fff;
}

body[data-theme="light"] {

--background-color: rgba(240, 245, 255, 0.9); 
--border-color: rgba(0, 0, 0, 0.1);
--text-color: #1b263b; 
--shadow-color: rgba(0, 0, 0, 0.1);
--body-bg: linear-gradient(135deg, #e0eafc, #cfdef3); 
--input-bg: rgba(255, 255, 255, 0.6);
--input-focus-bg: rgba(255, 255, 255, 0.8);
--input-placeholder-color: rgba(0, 0, 0, 0.4);
--button-bg: rgba(0, 0, 0, 0.05);
--button-hover-bg: rgba(0, 0, 0, 0.1);
--button-text-color: #1b263b; 
--strong-text-color: var(--dark-blue-bg); 
}

/* Forçar o texto do botão Ver Melhorias para preto no tema claro */


* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: var(--body-bg);
background-attachment: fixed;
color: var(--text-color);
min-height: 100vh;
position: relative;
transition: background 0.3s ease;
}

body.modal-open {
overflow: hidden;
}

#theme-toggle-btn {
position: fixed;
top: 15px;
right: 15px;
width: 48px;
height: 48px;
border-radius: 50%;
border: 1px solid var(--border-color);
background-color: var(--background-color);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
cursor: pointer;
z-index: 1001;
display: flex;
justify-content: center;
align-items: center;
transition: all 0.3s ease;
padding: 8px;
}

#theme-toggle-btn:hover {
transform: scale(1.1) rotate(15deg);
box-shadow: 0 4px 15px var(--shadow-color);
}

#theme-toggle-btn .icon-sun { display: block; }
#theme-toggle-btn .icon-moon { display: none; }

body[data-theme="light"] #theme-toggle-btn .icon-sun { display: none; }
body[data-theme="light"] #theme-toggle-btn .icon-moon { display: block; }

#floating-wrench-btn {
position: fixed;
bottom: 15px;
left: 15px;
width: 48px;
height: 48px;
border-radius: 50%;
border: 1px solid var(--border-color);
background-color: var(--background-color);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
cursor: pointer;
z-index: 1001;
display: flex;
justify-content: center;
align-items: center;
transition: all 0.3s ease;
padding: 8px;
}
#floating-wrench-btn:hover {
transform: scale(1.1) rotate(-15deg);
box-shadow: 0 4px 15px var(--shadow-color);
}



#login, #certificado, #anotacoesLogin, #acessoEspecial, #recuperarPin {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border-radius: var(--border-radius-main);
border: 1px solid var(--border-color);
box-shadow: 0 8px 32px 0 var(--shadow-color);
max-width: 550px; 
width: 100%;
padding: 40px;
margin: 40px auto;
transition: all 0.3s ease;
}


#app, #anotacoesApp, #autoFillSettings, #autoFillForm {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border-radius: var(--border-radius-main);
border: 1px solid var(--border-color);
box-shadow: 0 8px 32px 0 var(--shadow-color);
max-width: 1200px; 
width: 100%;
padding: 40px 30px;
margin: 40px auto;
transition: all 0.3s ease;
}


h1, h2.page-title {
font-size: 1.8rem;
font-weight: 600;
text-align: center;
margin-bottom: 30px;
text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.input-container {
position: relative;
width: 100%;

}
input[type="password"], input[type="text"], input[type="tel"], textarea {
width: 100%;
padding: 14px 16px;
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
font-size: 1rem;
background: var(--input-bg);
color: var(--text-color);
resize: vertical;
transition: all 0.3s ease;

}

#modalSenha .input-container input, #modalSenha .input-container textarea {
padding-right: 35px; 
}

/* Password strength UI */
.password-strength {
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.9rem;
}
.password-strength .strength-bar {
  flex: 1;
  height: 10px;
  background: rgba(255,255,255,0.06);
  border-radius: 6px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.06);
}
.password-strength .strength-fill {
  height: 100%;
  width: 0%;
  background: #FF4D4F; /* fraco */
  transition: width 200ms ease, background 200ms ease;
}
.password-strength .strength-label {
  white-space: nowrap;
  min-width: 60px;
  text-transform: capitalize;
  opacity: 0.95;
  color: var(--text-color);
  font-weight: 600;
}

@media (max-width: 480px) {
  .password-strength .strength-label { font-size: 0.85rem; min-width: 50px; }
  .password-strength .strength-bar { height: 8px; }
}

.input-container input {
margin-bottom: 0;
}

#gmail-helper, #gmail-helper-anotacao {
  position: absolute;
  top: 50%;
  right: 45px; 
  transform: translateY(-50%);
  padding: 6px 8px;
  font-size: 1rem; 
  font-weight: normal;
  background-color: transparent; 
  border: none; 
  color: var(--input-placeholder-color); 
  opacity: 0;
  pointer-events: none; 
  transition: opacity 0.3s ease;
  cursor: pointer;
  z-index: 3;
}
#gmail-helper.visible, #gmail-helper-anotacao.visible {
opacity: 1;
pointer-events: auto;
}


#inputEmail {
  padding-right: 40px !important; 
}

#inputEmailAnotacao {
    padding-right: 40px !important;
}


input[type="password"]::placeholder, input[type="text"]::placeholder, input[type="tel"]::placeholder, textarea::placeholder {
color: var(--input-placeholder-color);
}

input[type="password"]:focus, input[type="text"]:focus, input[type="tel"]:focus, textarea:focus {
outline: none;
border-color: var(--primary-accent);
box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
background: var(--input-focus-bg);
}

button {
cursor: pointer;
border: none;
background-color: var(--button-bg);
color: var(--button-text-color);
padding: 10px 16px;
border-radius: var(--border-radius-inner);
font-size: 0.95rem;
font-weight: 600;
transition: all 0.3s ease;
user-select: none;
border: 1px solid var(--border-color);
}

button:hover {
background-color: var(--button-hover-bg);
transform: translateY(-2px);
}

button:active {
transform: translateY(0);
}

.login-buttons button, .modalButtons button[type="submit"], #btnInstalar, #btn-autofill-save, #btnVerificarSenhaEspecial, #btnPinRecuperadoConcluido, #btnRealizarUpload {
background-color: var(--primary-accent);
border: none;
color: white;
}

.message-box button.primary-action {
background-color: var(--primary-accent);
border: none;
color: white;
}
.message-box button.primary-action:hover {
background-color: var(--primary-accent-hover);
}

.login-buttons button:hover, .modalButtons button[type="submit"]:hover, #btnInstalar:hover, #btn-autofill-save:hover, #btnVerificarSenhaEspecial:hover, #btnPinRecuperadoConcluido:hover, #btnRealizarUpload:hover {
background-color: var(--primary-accent-hover);
}


#app, #anotacoesApp {
display: none;
}

#certificado, #anotacoesLogin, #autoFillSettings, #autoFillForm, #acessoEspecial, #recuperarPin {
display: none;
text-align: center;
}

#pin-container {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0;
}

.pin-input {
width: 50px;
height: 60px;
font-size: 2rem;
text-align: center;
caret-color: var(--primary-accent);
}


#forgot-pin-link {
display: block;
text-align: center;
margin-top: 15px;
cursor: pointer;
font-size: 0.9em;
color: rgba(255, 255, 255, 0.6);
transition: color 0.3s ease;
}
body[data-theme="light"] #forgot-pin-link {
color: rgba(0, 0, 0, 0.6);
}
#pin-recuperado-container {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0;
}
.pin-recuperado-box {
width: 50px;
height: 60px;
font-size: 2rem;
text-align: center;
line-height: 60px;
background-color: var(--input-bg);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
color: var(--text-color);
font-weight: bold;
}


.top-bar {
display: flex;
justify-content: space-between;
align-items: center;
gap: 10px;
margin-bottom: 20px;
}

#boards, #anotacoesBoards {
display: flex;
gap: 20px;
justify-content: center;
flex-wrap: wrap;
margin-top: 20px;
}

.board-column {
background: var(--input-bg);
border-radius: var(--border-radius-inner);
box-shadow: 0 5px 15px var(--shadow-color);
width: 300px; 
padding: 16px;
transition: 0.3s;
display: flex;
flex-direction: column;
border: 1px solid var(--border-color);
}

.board-column h3 {
margin-top: 0;
font-size: 1.1rem;
display: flex;
justify-content: space-between;
align-items: center;
gap: 8px;
cursor: pointer;
user-select: none;
}

.btn-excluir-categoria {
background-color: rgba(231, 76, 60, 0.5);
color: white;
font-weight: 600;
border-radius: 50%;
width: 24px;
height: 24px;
line-height: 22px;
text-align: center;
padding: 0;
cursor: pointer;
border: none;
font-size: 1.2rem;
display: flex;
justify-content: center;
align-items: center;
transition: background-color 0.3s ease;
}

.btn-excluir-categoria:hover {
background-color: rgba(192, 57, 43, 0.8);
}

.card {
border-radius: 12px;
padding: 12px;
margin-bottom: 12px;
font-size: 0.95rem;
background: var(--background-color);
position: relative;
text-align: left;
box-shadow: inset 0 0 0 1px var(--border-color);
display: flex;
flex-direction: column;
}

strong {
color: var(--strong-text-color);
font-weight: 600;
}

.notas-box {
background: var(--input-bg);
border-radius: 8px;
padding: 8px 10px;
margin-top: 6px;
white-space: pre-wrap;
word-wrap: break-word;
}
.links-box {
margin-top: 8px;
word-break: break-word;
}

.links-box a {
color: var(--primary-accent);
text-decoration: none;
word-break: break-word;
}

.card-buttons {
display: flex;
justify-content: center;
gap: 8px;
margin-top: 12px;
flex-wrap: wrap;
}

.card-buttons button {
padding: 6px 14px;
font-size: 0.85rem;
border-radius: 8px;
background-color: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.12);
display: flex;
align-items: center;
justify-content: center;
}

.card-buttons button.visualizar-icone {
padding: 6px;
}
.card-buttons button.visualizar-icone svg {
width: 20px;
height: 20px;
}

.card-buttons button:hover {
background-color: rgba(255, 255, 255, 0.15);
}

.card-buttons button.excluir {
background-color: var(--danger-accent);
border: none;
}
.card-buttons button.excluir:hover {
background-color: #c0392b;
}

.modal {
position: fixed;
inset: 0;
background: rgba(10, 10, 10, 0.3);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
display: none;
align-items: center;
justify-content: center;
z-index: 999;
padding: 20px;
}


.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 20px;
    margin-bottom: 20px;
}

.grid-span-2 {
    grid-column: span 2; 
}


@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr; 
        gap: 16px;
    }
    .grid-span-2 {
        grid-column: span 1; 
    }
    .modalContent {
      max-width: 400px; 
    }
}


#btn-autofill-trigger {
width: 100%;
margin-bottom: 20px;
padding: 8px;
font-size: 0.9rem;
}

.modalContent h2 {
margin-top: 0;
font-size: 1.4rem;
margin-bottom: 20px;
}

.modalButtons {
display: flex;
justify-content: center;
gap: 20px;
margin-top: 20px;
flex-wrap: wrap;
}

.modalButtons button {
min-width: 100px;
padding: 10px 0;
}

#modalDesenvolvimento .modalButtons {
  flex-direction: column;
}
#modalDesenvolvimento .main-actions {
  display: flex;
  gap: 10px;
  width: 100%;
  justify-content: center;
}


#new-column-name, #new-anotacao-column-name {
margin-bottom: 10px;
font-size: 1rem;
padding: 10px 14px;
}

#btnAdicionarCategoria, #btnAdicionarAnotacaoCategoria {
margin-bottom: 30px;
width: 100%;
font-size: 1rem;
}

.filter-controls {
display: none;
flex-direction: column;
gap: 10px;
margin-bottom: 30px;
}
.filter-controls input {
margin-bottom: 0;
}
.filter-buttons-container {
display: flex;
gap: 10px;
}
.filter-buttons-container button {
flex: 1;
}


.modo-leitura .card-buttons button:not(.visualizar) {
display: none !important;
}


.modo-leitura .board-column > button,
.modo-leitura .btn-excluir-categoria,
.modo-leitura .top-bar button:not(#btnModoLeitura):not(#btnModoLeituraAnotacao),
.modo-leitura .modalButtons {
display: none !important;
}

.modo-leitura .filter-controls {
display: flex !important;
}

.modo-leitura #new-column-name,
.modo-leitura #btnAdicionarCategoria,
.modo-leitura #new-anotacao-column-name,
.modo-leitura #btnAdicionarAnotacaoCategoria {
display: none;
}

#visualizacao-content {
text-align: left;
word-wrap: break-word;
font-size: 0.95rem;
}

#visualizacao-content p {
margin-bottom: 8px;
line-height: 1.4;
}

.footerButtons {
margin-top: 40px;
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 20px;
}

.login-buttons {
display: flex;
flex-direction: column;
gap: 10px;
margin-top: 10px;
}

.login-buttons .row {
display: flex;
gap: 10px;
}

.login-buttons button {
flex: 1;
padding: 14px 0;
}


#version-link {
text-align: center;
margin-top: 15px;
cursor: pointer;
font-size: 0.9em;
color: rgba(255,255,255,0.6); 
transition: color 0.3s ease;
}
body[data-theme="light"] #version-link {
color: rgba(0,0,0,0.6); 
}


.codigo-box {
background: var(--input-bg);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
padding: 20px;
margin: 20px 0;
font-size: 1rem;
font-weight: bold;
letter-spacing: 2px;
min-height: 60px;
}

.message-box {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
border: 1px solid var(--border-color);
padding: 30px;
border-radius: var(--border-radius-main);
box-shadow: 0 10px 30px var(--shadow-color);
text-align: center;
z-index: 1000;
display: none;
max-width: 90%;
width: 400px;
animation: fadeIn 0.3s ease-out;
}

.message-box h2 {
margin-top: 0;
color: var(--text-color);
}

.changelog {
  text-align: left;
  margin-top: 15px;
  padding-left: 20px;
  font-size: 0.9rem;
  max-height: 200px;
  overflow-y: auto;
}
.changelog li {
  margin-bottom: 8px;
}

.message-box button {
margin-top: 20px;
min-width: 120px;
}

.overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
z-index: 998;
display: none;
}

@keyframes fadeIn {
from { opacity: 0; transform: translate(-50%, -45%); }
to { opacity: 1; transform: translate(-50%, -50%); }
}

.loader {
border: 4px solid var(--input-bg);
border-top: 4px solid var(--text-color);
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 20px auto;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.progress-container {
width: 100%;
background-color: var(--input-bg);
border-radius: 10px;
margin: 20px 0;
overflow: hidden;
}

.progress-bar {
height: 20px;
background-color: var(--primary-accent);
border-radius: 10px;
width: 0%;
transition: width 0.5s ease;
}

.status-message {
margin: 10px 0;
font-size: 0.9rem;
min-height: 20px;
}


#update-dialog {
  color: var(--text-color);
  padding: 15px;
  border-radius: var(--border-radius-inner);
  text-align: center;
  font-size: 0.9rem;
  line-height: 1.5;
  width: 100%;
  margin: 20px 0 15px 0;
  border: 1px solid var(--border-color);
  background: var(--input-bg);
}
#btnRealizarUpload {
width: 100%;
padding: 12px 0;
font-size: 0.95rem;
margin-top: 15px;
}


.btn-clear-field {
position: absolute;
top: 50%;
right: 10px;
transform: translateY(-50%);
background: transparent;
border: none;
color: var(--text-color);
font-size: 1.5rem;
font-weight: bold;
line-height: 1;
padding: 0 5px;
cursor: pointer;
display: none; 
opacity: 0.6;
z-index: 1; 
transition: all 0.3s ease;
}


.recent-items-menu {
position: absolute;
top: 100%;
left: 0;
right: 0;
max-height: 200px;
overflow-y: auto;
background: var(--background-color);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
z-index: 1000;
margin-top: 4px;
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
display: none;
box-shadow: 0 4px 12px var(--shadow-color);
}

.recent-items-menu.show {
display: block;
animation: fadeInDown 0.2s ease-out;
}

.recent-item {
padding: 10px 16px;
cursor: pointer;
transition: all 0.2s ease;
display: flex;
align-items: center;
gap: 8px;
color: var(--text-color);
}

.recent-item:hover {
background: var(--input-bg);
}

.recent-item svg {
width: 16px;
height: 16px;
stroke: var(--text-color);
opacity: 0.5;
}

.input-container.has-recent::after {
content: "";
position: absolute;
right: 12px;
top: 50%;
width: 10px;
height: 10px;
border: 2px solid var(--text-color);
border-left: 0;
border-top: 0;
opacity: 0.5;
transform: translateY(-50%) rotate(45deg);
pointer-events: none;
}

@keyframes fadeInDown {
from {
    opacity: 0;
    transform: translateY(-10px);
}
to {
    opacity: 1;
    transform: translateY(0);
}
}
.btn-clear-field:hover {
opacity: 1;
background: none;
transform: translateY(-50%);
}

/* Marcadores (Tags/Badges) - Design minimalista */
.marcador-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 500;
    color: #fff;
    opacity: 0.9;
    transition: opacity 0.2s ease;
}

.marcador-badge.importante {
    font-weight: 700;
    box-shadow: 0 0 10px rgba(0,0,0,0.18);
}

.marcador-badge .marcador-flag {
    display: inline-block;
    margin-right: 6px;
    font-size: 0.85rem;
    opacity: 0.95;
}

.marcador-badge:hover {
    opacity: 1;
}

.marcadores-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    justify-content: center;
} 

/* Select de marcadores nos formulários - minimalista */
.marcador-select-container {
    width: 100%;
}

.marcador-select-container select {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    font-size: 0.95rem;
    background: var(--input-bg);
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

.marcador-select-container select:focus {
    outline: none;
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
    background: var(--input-focus-bg);
}

.marcador-select-container select option {
    padding: 8px;
}

/* Modal de Gerenciamento de Marcadores - minimalista */
#modalMarcadores .modalContent {
    max-width: 550px;
}

.marcadores-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin: 20px 0;
    max-height: 350px;
    overflow-y: auto;
}

.marcador-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-radius: 8px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
}

.marcador-item:hover {
    background: var(--button-hover-bg);
}

.marcador-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.marcador-color-preview {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.2);
    flex-shrink: 0;
}

.marcador-name {
    font-weight: 500;
    font-size: 0.9rem;
    flex: 1;
}

.marcador-actions {
    display: flex;
    gap: 6px;
}

.marcador-actions button {
    padding: 5px 12px;
    font-size: 0.8rem;
    border-radius: 6px;
    min-width: auto;
    font-weight: 500;
}

.btn-edit-marcador {
    background: transparent;
    color: var(--text-color);
    border: 1px solid var(--border-color);
}

.btn-edit-marcador:hover {
    background: var(--button-hover-bg);
}

.btn-delete-marcador {
    background: transparent;
    color: var(--danger-accent);
    border: 1px solid var(--danger-accent);
}

.btn-delete-marcador:hover {
    background: var(--danger-accent);
    color: white;
}

.marcador-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    background: var(--input-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 16px;
}

.marcador-form-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

.marcador-importante-container {
    display: flex;
    align-items: center;
    padding: 8px 0;
}

.marcador-importante-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    user-select: none;
}

.marcador-importante-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.marcador-importante-label span {
    display: flex;
    align-items: center;
    gap: 4px;
}

.marcador-form-row input[type="text"] {
    flex: 1;
}

.marcador-form-row input[type="color"] {
    width: 50px;
    height: 40px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    background: transparent;
}

.color-presets {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.color-preset {
    width: 28px;
    height: 28px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.15s ease;
}

.color-preset:hover {
    transform: scale(1.1);
    border-color: rgba(255,255,255,0.3);
}

.color-preset.selected {
    border-color: var(--text-color);
    box-shadow: 0 0 0 2px var(--border-color);
}

@media (max-width: 768px) {
    #modalMarcadores .modalContent {
        padding: 24px 20px;
    }
    
    .marcador-item {
        padding: 8px 12px;
    }
    
    .marcador-name {
        font-size: 0.85rem;
    }
    
    .marcador-actions button {
        padding: 4px 10px;
        font-size: 0.75rem;
    }
    
    .color-preset {
        width: 24px;
        height: 24px;
    }
}

.search-btn.liquid-btn,
.view-saved-btn.liquid-btn,
.save-item-btn.liquid-btn {
z-index: 2;
}

.input-container {
position: relative;
}


.input-container input {
padding-right: 45px; 
}

.input-container:has(.search-btn) input,
.input-container:has(.view-saved-btn) input {
padding-right: 90px; 
}


.input-container .search-btn.liquid-btn,
.input-container .view-saved-btn.liquid-btn {
position: absolute;
right: 40px;
top: 50%;
transform: translateY(-50%);
}


.recent-items-menu {
position: absolute;
top: 100%;
left: 0;
right: 0;
max-height: 200px;
overflow-y: auto;
background: var(--background-color);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
z-index: 1000;
margin-top: 4px;
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
display: none;
box-shadow: 0 4px 12px var(--shadow-color);
}

.recent-items-menu.show {
display: block;
animation: fadeInDown 0.2s ease-out;
}

.recent-item {
padding: 10px 16px;
cursor: pointer;
transition: all 0.2s ease;
display: flex;
align-items: center;
gap: 8px;
color: var(--text-color);
}

.recent-item:hover {
background: var(--input-bg);
}

.recent-item svg {
width: 16px;
height: 16px;
stroke: var(--text-color);
opacity: 0.5;
}

.input-container.has-recent::after {
content: "";
position: absolute;
right: 12px;
top: 50%;
width: 10px;
height: 10px;
border: 2px solid var(--text-color);
border-left: 0;
border-top: 0;
opacity: 0.5;
transform: translateY(-50%) rotate(45deg);
pointer-events: none;
}

@keyframes fadeInDown {
from {
    opacity: 0;
    transform: translateY(-10px);
}
to {
    opacity: 1;
    transform: translateY(0);
}
}

</style>
<style>
/* Espaçamento consistente para o formulário Adicionar Anotação */
#modalAnotacao form {
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
}
#modalAnotacao form input,
#modalAnotacao form textarea {
    width: 100% !important;
    padding: 12px 14px !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--border-radius-inner) !important;
    background: var(--input-bg) !important;
}

/* Campos extras (Anotação) */
#btnMaisInfoAnotacao {
    align-self: stretch;
    width: 100%;
    display: flex;
    justify-content: center;
    text-align: center;
    padding: 8px 12px;
    border-radius: var(--border-radius-inner);
    border: 1px dashed var(--border-color);
    background: transparent;
    color: var(--text-color);
    cursor: pointer;
}

#btnMaisInfoAnotacao:hover {
    background: var(--card-bg);
}

#extraFieldsAnotacao {
    display: none;
    flex-direction: column;
    gap: 12px;
}

#extraFieldsAnotacao input {
    width: 100% !important;
}

/* Tornar borda arredondada em todos os formulários */
form {
    border-radius: var(--border-radius-inner) !important;
}

/* Busca com botão à esquerda */
.search-input-with-filters {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    margin: 8px 0;
}
.filter-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    background: var(--button-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
}
.filter-btn svg { width: 18px; height: 18px; }

.filter-popover {
    position: absolute;
    z-index: 12000;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    padding: 12px;
    min-width: 280px;
    max-width: 400px;
}
.filter-popover h4 { 
    margin: 0 0 8px 0; 
    font-size: 0.95rem; 
}
.filter-field-select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 0.9rem;
    margin-bottom: 12px;
}
.filter-values-container {
    margin-top: 12px;
}
.filter-values-list {
    max-height: 250px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 8px;
}
.filter-value-item {
    padding: 10px 12px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}
.filter-value-item:hover {
    background: var(--button-hover-bg);
    transform: translateX(4px);
}
.no-values {
    padding: 20px;
    text-align: center;
    color: var(--text-color);
    opacity: 0.6;
    font-size: 0.9rem;
}
.filter-popover .actions { 
    display: flex; 
    gap: 8px; 
    justify-content: flex-end; 
    margin-top: 12px; 
}
.filter-popover .actions button {
    padding: 8px 16px;
    font-size: 0.9rem;
}
</style>
    <!-- theme.css removido: arquivo deletado no dispositivo; evitar erro MIME nosniff -->
    <link rel="manifest" href="./manifest.json">
</head>
<body>

<div class="fab-container">
    <button id="fab-main" class="fab-button fab-main" title="Menu">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="16"/>
            <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
    </button>
    <div class="fab-buttons">
        <button id="theme-toggle-btn" class="fab-button fab-action-button" title="Alterar tema">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
        <button id="floating-wrench-btn" class="fab-button fab-action-button" title="Opções">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg>
        </button>
        <!-- Restaurado: botão Atualizar rápido (FAB) -->
        <button id="fab-refresh-btn" class="fab-button fab-action-button" title="Atualizar rápido">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.56-3.36L23 10"></path>
                <path d="M20.49 15a9 9 0 0 1-14.56 3.36L1 14"></path>
            </svg>
        </button>
    </div>
</div>
        

<div id="quick-refresh-box" class="quick-refresh-box" role="status" aria-live="polite">
    <div class="quick-refresh-header">
        <span class="quick-refresh-dot"></span>
        <div class="quick-refresh-text">
            <strong id="quick-refresh-title">Atualizando o site</strong>
            <small id="quick-refresh-caption">Aplicando ajustes rápidos sem sair do painel.</small>
        </div>
    </div>
    <div class="quick-refresh-progress">
        <div id="quick-refresh-progress" class="quick-refresh-progress-bar"></div>
    </div>
    <div class="quick-refresh-footer">
        <span id="quick-refresh-pill" class="quick-refresh-pill" data-state="running">Em andamento</span>
        <button id="quick-refresh-dismiss" type="button" class="quick-refresh-dismiss" aria-label="Fechar atualização">OK</button>
    </div>
</div>

<div id="popoverRedefinir" class="popover popover-hidden" data-visible="false" aria-hidden="true">
    <div class="popover-content">
        <header class="popover-header">
            <h3>Tempo de Atualização</h3>
            <p class="popover-subtitle">Reseta o contador para uma nova verificação em 30 dias.</p>
        </header>
        <div class="popover-body">Redefinir o tempo de atualização para 30 dias?</div>
        <div class="popover-actions">
            <button id="popoverConfirmRedefinir" class="btn-primary">Confirmar</button>
            <button id="popoverCancelRedefinir" class="btn-secondary">Cancelar</button>
        </div>
    </div>
</div>

<style>

/* Popover para confirmação ancorada ao botão (Opção A) */
.popover {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 280px;
    max-width: 320px;
    background: var(--background-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 18px 20px;
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
    z-index: 2147483655 !important;
    pointer-events: auto;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}
.popover-hidden {
    display: none;
}
.popover-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
    align-items: center;
    text-align: center;
}
.popover-header {
    text-align: center;
}
.popover-header h3 {
    font-size: 1.05rem;
    margin-bottom: 4px;
}
.popover-subtitle {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.75);
}
body[data-theme="light"] .popover-subtitle {
    color: rgba(0, 0, 0, 0.6);
}
.popover-body {
    font-size: 0.95rem;
    line-height: 1.4;
    text-align: center;
}
.popover-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}
.popover-actions button {
    flex: 1;
    min-width: 0;
}

/* Estilos dos botões dentro do popover para seguir o tema */
.popover .btn-primary {
    background-color: var(--primary-accent);
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.18);
}
.popover .btn-primary:hover {
    background-color: var(--primary-accent-hover);
}
.popover .btn-secondary {
    background: var(--button-bg);
    color: var(--button-text-color);
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    border-radius: 8px;
}

/* For light theme tweaks (use variables already set in body[data-theme]) */
body[data-theme="light"] .popover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
}


.fab-container {
    position: fixed !important;
    bottom: 2rem !important;
    right: 2rem !important;
    display: flex !important;
    flex-direction: column-reverse !important;
    align-items: center !important;
    gap: 1rem !important;
    z-index: 1001 !important;
}

.fab-button {
    width: 56px !important;
    height: 56px !important;
    border-radius: 50% !important;
    border: 1px solid var(--border-color) !important;
    background: var(--background-color) !important;
    backdrop-filter: blur(var(--blur-intensity)) !important;
    -webkit-backdrop-filter: blur(var(--blur-intensity)) !important;
    cursor: pointer !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    box-shadow: 0 2px 10px var(--shadow-color) !important;
    position: relative !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    bottom: auto !important;
    padding: 0 !important;
}

.fab-main {
    background-color: var(--primary-accent) !important;
    z-index: 2 !important;
}

.fab-main svg {
    width: 24px !important;
    height: 24px !important;
    stroke: white !important;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.fab-buttons {
    position: absolute !important;
    bottom: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 0.8rem !important;
    transform: translateY(0) !important;
    opacity: 0 !important;
    pointer-events: none !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.fab-container.active .fab-buttons {
    transform: translateY(-40%) !important;
    opacity: 1 !important;
    pointer-events: all !important;
}

.fab-container.active .fab-main svg {
    transform: rotate(45deg) !important;
}

.fab-action-button {
    width: 56px !important;
    height: 56px !important;
    padding: 0 !important;
    border-radius: 50% !important;
    background: var(--background-color) !important;
    border: 1px solid var(--border-color) !important;
    transform: scale(0.96) !important;
    opacity: 0.95 !important;
    gap: 0 !important;
}

.fab-action-button:hover {
    transform: scale(1) !important;
    opacity: 1 !important;
    box-shadow: 0 8px 18px rgba(0,0,0,0.18) !important;
}

.fab-button svg {
    width: 22px !important;
    height: 22px !important;
    stroke: var(--text-color) !important;
    filter: drop-shadow(0 0 2px var(--shadow-color)) !important;
}

#theme-toggle-btn.fab-button .icon-sun { display: block !important; stroke: #FFD700 !important; }
#theme-toggle-btn.fab-button .icon-moon { display: none !important; stroke: #2c3e50 !important; }
body[data-theme="light"] #theme-toggle-btn.fab-button .icon-sun { display: none !important; }
body[data-theme="light"] #theme-toggle-btn.fab-button .icon-moon { display: block !important; }

#fab-refresh-btn svg {
    width: 20px !important;
    height: 20px !important;
}

.fab-label { display: none; }

.quick-refresh-box {
    position: fixed;
    bottom: calc(2rem + 78px);
    right: 2rem;
    width: min(340px, 92vw);
    padding: 14px 16px;
    border-radius: 16px;
    border: none;
    background: var(--background-color);
    box-shadow: 0 14px 38px var(--shadow-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    display: grid;
    gap: 10px;
    opacity: 0;
    transform: translateY(10px) scale(0.98);
    pointer-events: none;
    transition: all 0.28s ease;
    z-index: 1000;
}

.quick-refresh-box.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

.quick-refresh-header {
    display: flex;
    align-items: center;
    gap: 10px;
}

.quick-refresh-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary-accent);
    box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.08);
    animation: refreshPulse 1.4s ease-in-out infinite;
}

.quick-refresh-text strong {
    display: block;
    font-size: 0.95rem;
    color: var(--text-color);
}

.quick-refresh-text small {
    color: var(--subtext-color);
}

.quick-refresh-progress {
    width: 100%;
    height: 8px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.quick-refresh-progress-bar {
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, var(--primary-accent), rgba(255, 255, 255, 0.12));
    transition: width 1.3s ease;
}

.quick-refresh-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}

.quick-refresh-pill {
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    font-size: 0.85rem;
    color: var(--text-color);
}

.quick-refresh-pill[data-state="done"] {
    border-color: var(--primary-accent);
    color: var(--primary-accent);
}

.quick-refresh-dismiss {
    border: 1px solid var(--border-color);
    background: transparent;
    color: var(--text-color);
    border-radius: 12px;
    padding: 6px 10px;
    cursor: pointer;
    transition: border-color 0.2s ease, transform 0.2s ease;
}

.quick-refresh-dismiss:hover {
    border-color: var(--primary-accent);
    transform: translateY(-1px);
}

.quick-refresh-box.done .quick-refresh-dot {
    animation: none;
    background: var(--primary-accent);
    box-shadow: 0 0 0 8px rgba(0, 0, 0, 0.04);
}

.quick-refresh-box.done .quick-refresh-text strong {
    color: var(--primary-accent);
}

@keyframes refreshPulse {
    0% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.08); }
    100% { box-shadow: 0 0 0 14px rgba(0, 0, 0, 0); }
}
</style>

<div id="login">
<h1>ACESSO RESTRITO</h1>
<input type="password" id="masterPassword" placeholder="Senha mestre" autocomplete="off" />
<div class="login-buttons">
<div class="row">
<button id="btnEntrar">ENTRAR</button>
<button id="btnCertificado">CERTIFICADO</button>
</div>
<button id="btnAnotacoes">ACESSAR ANOTAÇÕES</button>
</div>

<div id="update-dialog" style="display: none;">
Aviso de nova atualização disponível. Acesse o modo Desenvolvedor para Atualizar ou realize a atualização manualmente. É necessário o certificado digital para o Upload.
<button id="btnRealizarUpload">Realizar Upload</button>
<div class="helper-actions">
  <button id="toggleMobileInstructions" type="button" class="link-like">Instruções para dispositivos</button>
  <div id="mobileInstructions" class="timeline" style="display:none;">
      <div class="timeline-item">
          <div class="marker"> 
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          </div>
          <div class="content"><strong>Baixe o certificado</strong><p>Inicie o processo para obter o arquivo de certificado necessário.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2l4 -4"/><path d="M12 22a10 10 0 1 0 0-20a10 10 0 0 0 0 20z"/></svg>
          </div>
          <div class="content"><strong>Autentique o certificado</strong><p>Confirme sua identidade/autorização quando solicitado.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h13"/><path d="M14 9l3 3l-3 3"/><rect x="3" y="5" width="7" height="14" rx="2"/></svg>
          </div>
          <div class="content"><strong>Seja redirecionado para o Google Drive</strong><p>Aguarde o redirecionamento automático para o Drive.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 10v-2a5 5 0 0 1 10 0v2"/><path d="M5 10h14v8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-8z"/></svg>
          </div>
          <div class="content"><strong>Faça o download</strong><p>No Drive, toque em baixar para salvar o arquivo.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18v13H3z"/><path d="M3 7l3-4h12l3 4"/></svg>
          </div>
          <div class="content"><strong>Vá para o gerenciador de arquivos</strong><p>Abra o app de arquivos do seu dispositivo.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 12h8"/></svg>
          </div>
          <div class="content"><strong>Abra o arquivo</strong><p>Localize o arquivo baixado e toque para abrir.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2l4 -4"/><rect x="3" y="4" width="18" height="16" rx="2"/></svg>
          </div>
          <div class="content"><strong>Confirme a versão</strong><p>Verifique se a versão corresponde à exibida no app.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
          </div>
          <div class="content"><strong>Anexe na tela inicial</strong><p>Selecione anexar/importar o app na tela inicial.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <div class="content"><strong>Conclua o upload</strong><p>Finalize o envio e aguarde a confirmação.</p></div>
      </div>
  </div>
</div>
</div>

<div class="version-and-devices-container">
    <div id="version-link">
        <span class="version-text">Versão 3.0</span>
        <span class="update-timer">30 dias</span>
    </div>
    <div id="registered-devices-display" class="registered-devices-display" title="Aparelhos conectados"></div>
    <div id="current-device-chip" class="current-device-chip" role="status" aria-hidden="true" title="">
        <span id="current-device-chip-icon" class="device-chip-icon"></span>
    </div>
</div>

<!-- Modal: Aparelhos conectados (atalho rápido) -->
<div id="modal-aparelho-atual" class="modal" role="dialog" aria-modal="true" style="display:none;">
    <div class="modalContent modal-aparelhos-content">
        <h2>Aparelho conectado</h2>
        <div class="aparelhos-info-box">
            <div class="device-icon-large" id="modal-device-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="6" y="2" width="12" height="20" rx="2" ry="2" />
                </svg>
            </div>
            <div class="device-details">
                <div class="detail-row">
                    <span class="detail-label">Nome:</span>
                    <span class="detail-value" id="modal-device-name">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Senha:</span>
                    <span class="detail-value" id="modal-device-password">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Informações:</span>
                    <span class="detail-value" id="modal-device-info">-</span>
                </div>
            </div>
            <div class="aparelhos-stats">
                <div class="stat-item stat-item-full">
                    <span class="stat-number" id="modal-device-id">-</span>
                    <span class="stat-label">ID do aparelho</span>
                </div>
            </div>
        </div>
        <button id="btn-biodirecionamento" class="btn-biodirecionamento" style="margin-top: 20px !important; margin-bottom: 0 !important;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2h6" />
                <polyline points="15 3 21 3 21 9" />
                <line x1="10" y1="14" x2="21" y2="3" />
            </svg>
            Acessar Biodirecionamento
        </button>
        <button id="btn-fechar-modal-aparelho-atual" class="btn-fechar-modal" style="margin-top: 20px !important;">Fechar</button>
    </div>
</div>

<style>

.version-and-devices-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin: 15px auto;
    width: fit-content;
    flex-wrap: wrap;
}

#version-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 0;
    padding: 8px 15px;
    width: fit-content;
    min-width: 160px;
    min-height: 52px;
    font-size: 0.9em;
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

#version-link .version-text {
    color: var(--text-color);
    font-weight: 500;
}

#version-link .update-timer {
    color: var(--primary-accent);
    font-size: 0.85em;
    padding-left: 8px;
    border-left: 1px solid var(--border-color);
}

#version-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-color);
}

#registered-devices-display {
    width: 52px;
    height: 52px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--border-color);
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    box-shadow: 0 4px 12px var(--shadow-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

#registered-devices-display:empty::after {
    content: '';
}

.device-icon-display svg {
    height: 26px;
    width: auto;
    display: block;
    stroke: var(--primary-accent);
}

#registered-devices-display:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-color);
}

.autofill-actions {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin: 12px 0;
    width: 100%;
    grid-auto-rows: 1fr;
}

@media (min-width: 768px) {
    .autofill-actions {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }
}

.autofill-action {
    width: 100%;
    aspect-ratio: 1 / 1;
    min-height: 96px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 10px;
    text-align: center;
    padding: 14px;
    font-size: 0.98rem;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.04);
    transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06) inset;
}

@supports not (aspect-ratio: 1 / 1) {
    .autofill-action {
        height: 120px;
    }
}

.autofill-action:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    border-color: rgba(255,255,255,0.08);
}

.autofill-action svg {
    width: 36px;
    height: 36px;
    stroke: var(--primary-accent);
    flex-shrink: 0;
    opacity: 0.95;
}

.autofill-action span {
    display: block;
    line-height: 1.2;
    font-weight: 600;
    color: var(--text-color);
}

/* Estilos do modal/lista de senhas */
.pdf-senha-list {
    display: grid;
    gap: 12px;
    grid-template-columns: 1fr;
}

@media (min-width: 720px) {
    .pdf-senha-list { grid-template-columns: repeat(2, 1fr); }
}

.pdf-senha-card {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    padding: 12px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    box-shadow: 0 8px 22px rgba(0,0,0,0.12);
    max-width: 640px;
    margin: 0 auto;
}

.pdf-senha-row-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
}

.pdf-senha-title {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-color);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
}

.pdf-senha-meta { font-size: 12px; color: rgba(255,255,255,0.6); }

@media (max-width: 480px) {
    .pdf-senha-row-head { flex-direction: row; align-items: center; justify-content: space-between; }
    .pdf-senha-title { text-align: left; }
}
.pdf-badge {
    padding: 4px 6px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.pdf-badge.encrypted { background: transparent; color: var(--primary-accent); border: 1px solid rgba(34,197,94,0.08); }
.pdf-badge.plain { background: transparent; color: var(--text-color); border: 1px solid rgba(255,255,255,0.04); opacity: 0.9; }

.pdf-senha-actions { display: flex; gap: 8px; align-items: center; flex: 0 0 auto; }
.pdf-senha-actions button { padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.02); cursor: pointer; min-width:44px; height:44px; display:flex; align-items:center; justify-content:center; }
.pdf-senha-actions .copy-btn { background: var(--primary-accent); color: #fff; border-color: var(--primary-accent); }
.pdf-senha-actions .img-btn { background: transparent; color: var(--text-color); }

    /* Prevent icons from appearing to float: group actions and maintain visual baseline */
    .pdf-senha-actions { margin-top: 6px; }
    .pdf-senha-actions button svg { display:block; margin:0 auto; }
    .pdf-badge { display:inline-flex; align-items:center; justify-content:center; }
    .pdf-modal-container { display:flex; flex-direction:column; align-items:center; }
.modal-actions-row button { flex:1; padding:12px; border-radius:8px; }

/* Pequenos ajustes responsivos */
@media (max-width: 480px) {
    /* Botões de Funções Adicionais mais compactos e touch-friendly */
    .autofill-action { padding: 10px; min-height: 78px; border-radius: 10px; }
    .autofill-action svg { width: 28px; height: 28px; }
    .autofill-action span { font-size: 0.92rem; }

    /* Lista de senhas em coluna única, cards full-width e centralizados */
    .pdf-senha-list { grid-template-columns: 1fr; gap: 8px; }
    .pdf-modal-container { padding: 0 10px; }
    .pdf-senha-card { padding: 8px; border-radius: 10px; margin: 0 auto; max-width: 640px; }
    .pdf-senha-row-head { flex-direction: row; align-items: center; gap: 8px; }

    /* Ações maiores para toques com o dedo, alinhadas à esquerda */
    .pdf-senha-actions { width: auto; display: flex; gap: 8px; }
    .pdf-senha-actions button { padding: 10px; min-width:44px; height:44px; }

    /* Código da senha legível em mobile */
    .pdf-senha-code { font-size: 14px; padding: 8px; }

    /* Modal ajustado para ocupar a largura do dispositivo e evitar overflow */
    .message-box {
        width: calc(100% - 16px) !important;
        max-width: none !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        border-radius: 12px !important;
        padding: 8px !important;
        box-shadow: 0 6px 18px rgba(0,0,0,0.16) !important;
        max-height: 94vh !important;
        overflow: hidden !important;
    }

    /* Fullscreen mode for messageBox when class 'fullscreen' is set */
    .message-box.fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100% !important;
        height: 100% !important;
        transform: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        max-height: none !important;
        overflow: hidden !important;
    }

    .pdf-modal-header { position: relative; z-index: 12001; padding: 12px 10px; }
    .pdf-modal-body { flex: 1; overflow:auto; -webkit-overflow-scrolling: touch; padding-bottom: 12px; }
    .pdf-modal-footer { position: relative; z-index: 12001; padding: 10px; display:flex; gap:8px; justify-content:center; }

    .modal-actions-row { flex-direction: column; }
    .modal-actions-row button { width: 100%; }

    /* Ajustes para grids/actions no container principal */
    .autofill-actions { grid-template-columns: repeat(2, 1fr); gap: 10px; }
}

/* Refinamentos visuais para modal de senhas (desktop + mobile)
   - aumentar espaçamento entre elementos
   - centralizar conteúdo em telas largas
   - cartões mais arejados e legíveis
*/
.pdf-modal-container { max-width: 920px; margin: 0 auto; padding: 18px; box-sizing: border-box; }
.pdf-modal-header { padding: 16px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid var(--border-color); }.pdf-modal-header { position: sticky; top: 0; z-index: 12; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding: 14px 18px; display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid var(--border-color); border-top-left-radius:12px; border-top-right-radius:12px; }
.pdf-modal-title { display:flex; gap:12px; align-items:center; }
.pdf-modal-title .modal-brand { width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:10px; background: linear-gradient(135deg, rgba(0,122,255,0.12), rgba(0,122,255,0.04)); border:1px solid rgba(255,255,255,0.03); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
.pdf-modal-title .muted { font-size:13px; color:rgba(255,255,255,0.65); }
.pdf-modal-title .title { margin:2px 0 0 0; color:var(--text-color); font-size:16px; font-weight:700; }
.pdf-modal-title .count { font-weight:700; color:var(--primary-accent); font-size:0.85rem; margin-left:6px; padding:2px 8px; border-radius:999px; background: rgba(0,122,255,0.06); }

.pdf-modal-body { padding: 10px 14px; overflow:auto; max-height: calc(100vh - 220px); }
.pdf-modal-container { max-width: 640px; margin: 0 auto; padding: 6px 4px; box-sizing: border-box; }
.pdf-senha-list { display:grid; gap: 18px; grid-template-columns: 1fr; }

.pdf-senha-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; display:flex; align-items:flex-start; gap:12px; box-shadow: 0 6px 18px rgba(0,0,0,0.05); transition: transform 120ms ease, box-shadow 160ms ease, border-color 120ms ease; }
.pdf-senha-card:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0,0,0,0.08); border-color: rgba(0,122,255,0.12); }
.pdf-card-left { display:flex; gap:10px; align-items:center; min-width:0; flex: 1 1 auto; }
.pdf-icon { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.03); }
.pdf-info { min-width:0; }
.pdf-senha-title { font-weight:700; font-size:15px; color:var(--text-color); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.pdf-senha-meta { font-size:12px; color:rgba(255,255,255,0.6); margin-top:4px; }

.pdf-card-right { display:flex; flex-direction:column; align-items:flex-end; gap:8px; }
.pdf-senha-code { font-family: 'Courier New', monospace; background: rgba(0,0,0,0.04); padding: 8px 12px; border-radius: 8px; word-break: break-all; color: var(--text-color); font-weight:700; font-size:14px; }
.pdf-senha-actions { display:flex; gap:10px; align-items:center; }
.pdf-senha-actions button { min-width:44px; height:44px; padding:8px; border-radius:8px; border:1px solid var(--border-color); background:transparent; display:flex; align-items:center; justify-content:center; }
.pdf-senha-actions .copy-btn { background: var(--primary-accent); color:#fff; border-color:var(--primary-accent); }

.pdf-modal-footer { position: sticky; bottom: 0; z-index: 12; padding: 10px 14px; display:flex; gap:12px; border-top:1px solid var(--border-color); background: linear-gradient(0deg, rgba(0,0,0,0.04), transparent); justify-content:center; border-bottom-left-radius:12px; border-bottom-right-radius:12px; }

@media (min-width: 720px) {
    .pdf-senha-list { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 22px; }
    .pdf-modal-container { padding: 8px; }
}

/* Mobile safe-area and footer spacing fixes */
.message-box.fullscreen .pdf-modal-body {
    padding-bottom: calc(110px + env(safe-area-inset-bottom)); /* espaço para buttons fixos */
}
.message-box.fullscreen .pdf-modal-footer {
    position: absolute; left: 0; right: 0; bottom: env(safe-area-inset-bottom, 12px); padding: 12px 14px; box-sizing: border-box; background: linear-gradient(0deg, rgba(0,0,0,0.02), transparent);
}
.pdf-modal-footer .btn-full { height: 56px; padding: 12px 16px; font-size: 1rem; }

/* Hide extra header buttons on narrow screens if needed */
@media (max-width: 480px) {
    .modal-header-actions .btn-small { display: none; }
    .modal-header-actions .btn-ghost { display: inline-flex; }
    /* Ensure footer visible and not covered - use smaller centered modal on mobile instead of true fullscreen */
    .message-box.fullscreen {
        position: fixed !important;
        top: 6vh !important;
        left: 8px !important;
        right: 8px !important;
        bottom: 6vh !important;
        width: auto !important;
        height: auto !important;
        max-height: calc(88vh) !important;
        transform: none !important;
        border-radius: 12px !important;
        padding: 10px !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }
    .message-box.fullscreen .pdf-modal-body { padding-bottom: 110px !important; overflow:auto !important; }
    .message-box.fullscreen .pdf-modal-footer { position: absolute; left: 12px; right: 12px; bottom: calc(8px + env(safe-area-inset-bottom)); padding: 8px 12px; }
}

/* Button tokens for modal */
.btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.04); color: var(--text-color); padding: 8px 10px; border-radius:8px; }
.btn-ghost:hover { background: rgba(255,255,255,0.02); }
.btn-full { width: 100%; display:inline-flex; justify-content:center; align-items:center; }
.btn-secondary { background: transparent; border: 1px solid rgba(255,255,255,0.06); color: var(--text-color); padding: 10px 14px; border-radius:8px; }
.btn-primary { background: var(--primary-accent); border: 1px solid var(--primary-accent); color: #fff; padding: 10px 14px; border-radius:8px; }

/* Accessibility helpers */
.sr-only { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }

/* Keep modal reasonably sized on desktop and centered; fullscreen still controlled by .fullscreen */
.message-box { max-width: 640px !important; width: auto !important; left: 50% !important; transform: translate(-50%, -50%) !important; padding: 12px !important; box-sizing: border-box; }

/* Specific tweaks when the PDF modal is open + central alignment + theme variants */
.message-box.pdf-modal-open {
    padding: 10px !important;
    background: linear-gradient(180deg, rgba(23, 42, 69, 0.92), rgba(12, 22, 36, 0.88));
    border-radius: 16px;
    box-shadow: 0 26px 64px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.03);
    display: block;
    text-align: center;
}
.message-box.pdf-modal-open .pdf-modal-header { background: transparent; }
.message-box.pdf-modal-open .pdf-modal-footer { background: transparent; }

/* Center everything inside the modal */
.pdf-modal-container { display:flex; flex-direction:column; align-items:center; }
.pdf-senha-card { flex-direction: column; align-items: center; text-align: center; max-width: 520px; width: 100%; }
.pdf-card-left { flex-direction: column !important; align-items:center !important; }
.pdf-card-right { align-items:center !important; }
.pdf-senha-actions { justify-content:center; }

/* Theme: Light */
body[data-theme="light"] .message-box.pdf-modal-open {
    background: linear-gradient(180deg, #ffffff, #f6f9ff);
    color: #15202b;
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 18px 48px rgba(16,24,40,0.08);
}
body[data-theme="light"] .pdf-senha-card {
    background: #ffffff;
    border: 1px solid rgba(0,0,0,0.06);
    color: #1b263b;
}
body[data-theme="light"] .pdf-senha-meta { color: rgba(27,38,59,0.6); }
body[data-theme="light"] .pdf-senha-code { background: rgba(0,0,0,0.03); color: #1b263b; }
body[data-theme="light"] .btn-ghost { border-color: rgba(0,0,0,0.06); color: #1b263b; }

/* Theme: Dark (explicit) */
body:not([data-theme="light"]) .message-box.pdf-modal-open {
    background: linear-gradient(180deg, rgba(12,22,36,0.98), rgba(6,12,20,0.96));
    color: var(--text-color);
    border: 1px solid rgba(255,255,255,0.03);
    box-shadow: 0 26px 64px rgba(0,0,0,0.6);
}
body:not([data-theme="light"]) .pdf-senha-card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid rgba(255,255,255,0.03);
    color: var(--text-color);
}
body:not([data-theme="light"]) .pdf-senha-meta { color: rgba(255,255,255,0.6); }
body:not([data-theme="light"]) .pdf-senha-code { background: rgba(0,0,0,0.04); color: var(--text-color); }

/* Ensure grid remains centered on wider screens */
@media (min-width: 920px) {
    .pdf-modal-container { max-width: 760px; }
    .message-box.pdf-modal-open { padding: 12px 18px !important; }
}




.device-icon-options {
    flex-wrap: wrap;
    row-gap: 12px;
    justify-content: center;
}

@media (max-width: 480px) {
    .device-icon-options { gap: 10px; }
    #devices-list-container { max-height: 70vh; }
}

.device-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--input-bg);
    width: 100%;
    box-sizing: border-box;
}

.device-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: flex-end;
    width: 100%;
}

.device-actions button {
    flex: 1 1 48%;
    min-width: 120px;
}

@media (min-width: 769px) {
    .device-row { align-items: center; }
    .device-actions {
        flex-wrap: nowrap;
        gap: 10px;
        justify-content: flex-end;
        margin-left: auto;
    }
    .device-actions button {
        flex: 0 0 auto;
        min-width: 110px;
        padding: 8px 12px;
    }
}

@media (max-width: 560px) {
    .device-row { flex-direction: column; align-items: flex-start; }
    .device-actions { justify-content: space-between; }
    .device-actions button { flex: 1 1 100%; min-width: 0; }
}

#modalDevices {
    align-items: flex-start;
    justify-content: center;
    padding: 14px 10px 20px;
    overflow-y: auto;
    overscroll-behavior: contain;
    touch-action: pan-y;
    height: 100vh;
}

#modalDevices .modalContent {
    max-height: none;
    overflow: visible;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
    width: min(680px, 100%);
    margin: 8px auto 0;
    min-height: 0;
    padding: 20px 18px 24px;
    box-sizing: border-box;
}

/* Modal do Simulador Firebase: usar dimensões/padding similares aos demais modais */
#modalFirebaseSimulator .modalContent {
    max-height: none;
    overflow: visible;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
    width: min(680px, 100%);
    margin: 8px auto 0;
    min-height: 0;
    padding: 20px 18px 24px;
    box-sizing: border-box;
} 

#devices-list-container {
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
    max-height: 60vh;
    overflow-y: auto;
    overscroll-behavior: contain;
    padding-right: 4px;
    overflow-anchor: none;
}

.correlation-container {
    margin: 10px 0;
}

#current-device-chip {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: 1px solid var(--border-color);
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    box-shadow: 0 4px 12px var(--shadow-color);
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    cursor: default;
}

.current-device-chip.visible {
    display: inline-flex;
}

.current-device-chip .device-chip-icon svg {
    height: 26px;
    width: auto;
    display: block;
    stroke: var(--text-color);
}

/* Regras de estilo para aparelhos correlacionados removidas */

.device-icon-large {
    width: 80px;
    height: 80px;
    margin: 0 auto 24px;
    background: var(--background-color);
    border: 2px solid var(--primary-accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px var(--shadow-color);
}

.device-icon-large svg {
    width: 40px;
    height: 40px;
    stroke: var(--primary-accent);
}

.device-details {
    margin-bottom: 24px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 600;
    color: var(--text-color);
    opacity: 0.7;
    font-size: 0.9rem;
}

.detail-value {
    font-weight: 500;
    color: var(--text-color);
    font-size: 0.95rem;
    text-align: right;
    max-width: 60%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.aparelhos-stats {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.stat-item {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--background-color);
    text-align: center;
}

.stat-item-full {
    width: 100%;
}

.stat-number {
    display: block;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary-accent);
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    opacity: 0.75;
}

.btn-biodirecionamento {
    width: 100%;
    padding: 12px;
    border-radius: var(--border-radius-inner);
    border: 1px solid var(--border-color);
    background: linear-gradient(135deg, rgba(0,122,255,0.12), rgba(0,122,255,0.06));
    color: var(--text-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn-biodirecionamento svg {
    width: 20px;
    height: 20px;
}

.btn-biodirecionamento:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(0,0,0,0.18);
}

.btn-fechar-modal {
    width: 100%;
}


#update-dialog {
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-main);
    padding: 15px;
    margin: 20px 0;
    box-shadow: 0 4px 15px var(--shadow-color);
    transition: all 0.3s ease;
    animation: pulseGlow 2s infinite;
}

@keyframes pulseGlow {
    0% { box-shadow: 0 4px 15px var(--shadow-color); }
    50% { box-shadow: 0 4px 25px var(--primary-accent); }
    100% { box-shadow: 0 4px 15px var(--shadow-color); }
}

#update-dialog button {
    margin-top: 12px;
}
</style>
<div id="loginError" style="color:#ff3b30; margin-top: 10px; text-align: center;"></div>
</div>

<input type="file" id="updateFileInput" accept=".txt" style="display:none;" />


<div id="anotacoesLogin">
<h1>Digite a Senha</h1>
<div id="pin-container">
<input type="tel" class="pin-input" maxlength="1" inputmode="numeric">
<input type="tel" class="pin-input" maxlength="1" inputmode="numeric">
<input type="tel" class="pin-input" maxlength="1" inputmode="numeric">
<input type="tel" class="pin-input" maxlength="1" inputmode="numeric">
</div>
<p id="forgot-pin-link">Esqueci a senha</p>
<div id="pinError" style="color:#ff3b30; margin-top: 10px; text-align: center;"></div>
<button id="btnVoltarLoginAnotacoes" style="margin-top: 10px;">Voltar</button>
</div>

<style>
    /* Ajustes específicos para o painel Acesso Especial */
    #acessoEspecial #senhaEspecial { display: block; margin: 0 0 18px 0; }
    #acessoEspecial #btnVerificarSenhaEspecial { margin-bottom: 14px; }
    #acessoEspecial #btnVoltarAcessoEspecial { display: block; margin: 14px auto 0; }
</style>

<div id="acessoEspecial">
<h1>ACESSO ESPECIAL</h1>
<input type="password" id="senhaEspecial" placeholder="Digite a senha mestre" autocomplete="off" />
<button id="btnVerificarSenhaEspecial" style="width: 100%; padding: 14px 0; font-size: 1rem;">Verificar</button>
<div id="acessoEspecialError" style="color:#ff3b30; margin-top: 10px; text-align: center;"></div>
<button id="btnVoltarAcessoEspecial" style="margin-top: 10px;">Voltar</button>
</div>

<div id="recuperarPin">
<h1>SENHA NUMÉRICA</h1>
<div id="pin-recuperado-container">
    </div>
<button id="btnPinRecuperadoConcluido" style="width: 100%; padding: 14px 0; font-size: 1rem; margin-top: 20px;">Concluído</button>
</div>


<div id="app" style="display:none;">
<div class="top-bar">
    <div class="site-brand">
        <span class="brand-text">KeyMaster</span>
    </div>
    <h1>ARQUIVOS</h1>
    <div>
        <button id="btnModoLeitura">Leitura</button>
        <button id="btnSair">Sair</button>
    </div>
</div>

<div id="credenciais-analisadas-box" class="credenciais-analisadas" style="display:none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
        <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z"></path>
        <path d="M20 21a8 8 0 0 0-16 0"></path>
    </svg>
    <span>Credenciais correlacionadas encontradas</span>
    <div class="badge-count" id="credenciais-analisadas-count">0</div>
</div>

<!-- Início: Xiaomi Manager embutido (isolado, IDs namespaced com mi_) -->
<div class="mi-manager-card card" style="margin-top:16px;">
    <style>
        .mi-manager-card { --mi-orange: #ff6700; --mm-border:#e0e0e0; padding:0; border-radius:0; background: transparent; border: none; }
        /* Remover apenas a borda/sombra herdada da classe global .card para este container específico */
        .mi-manager-card.card { box-shadow: none; }
        /* Aproximar a caixa do Gerenciador Xiaomi da caixa de Credenciais Analisadas sem alterar outras caixas */
        #credenciais-analisadas-box { margin-bottom: 6px !important; }
        #mi_summary { margin-top: 6px !important; }
        .mi-manager-card .mi-summary{display:flex;align-items:center;gap:10px;cursor:pointer}
        .mi-manager-card .mi-summary svg{flex:0 0 22px}
        .mi-manager-card h3{color:var(--mi-orange); margin:0; font-size:14px}
        .mi-manager-card .input-group{margin-bottom:10px}
        .mi-manager-card label{display:block;font-size:12px;margin-bottom:4px;color:#444}
        .mi-manager-card select,input{width:100%;padding:8px;border-radius:8px;border:1px solid var(--mm-border);box-sizing:border-box}
        .mi-manager-card .pattern-box{background:#f9f9f9;border-radius:8px;padding:8px;text-align:center;display:none}
        .mi-manager-card canvas{background:#fff;border-radius:6px}
        .mi-manager-card .btn-submit{width:100%;padding:10px;background:var(--mi-orange);color:#fff;border:none;border-radius:20px;cursor:pointer;margin-top:8px}
        .mi-manager-card .device-entry{border:1px solid var(--mm-border);border-radius:8px;padding:10px;margin-bottom:10px}
        .mi-manager-card .sim-controls{display:flex;gap:6px;margin-top:8px}
        .mi-manager-card .btn-step{flex:1;padding:6px;font-size:12px;border:1px solid var(--mi-orange);background:transparent;color:var(--mi-orange);border-radius:6px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.06);transition: all 0.12s ease}
        /* Estilos do modal Mi Manager para ficar visualmente igual ao restante do site */
        #modal-mi-manager .modal-credenciais-content { padding: 16px; border-radius: 12px; background: var(--background-color); box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
        #modal-mi-manager .modal-credenciais-header h2 { margin: 0; font-size: 1.05rem; color: var(--text-color); }
        #modal-mi-manager .input-group { margin-bottom: 10px; }
        #modal-mi-manager label { display:block; font-size:13px; font-weight:600; color:var(--muted-text-color); margin-bottom:6px }
        #modal-mi-manager input, #modal-mi-manager select, #modal-mi-manager textarea { width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background: var(--background-color); color: var(--text-color); box-sizing:border-box }
        /* Select de credencial com aparência consistente */
        .mi-cred-select { margin-top:6px }
        .mi-cred-select select, .mi-aux-select select { width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); background: var(--background-color); color: var(--text-color); box-sizing:border-box }
        .mi-aux-select { margin-top:6px }
        #modal-mi-manager .btn-submit { width:100%; padding:10px 12px; background:var(--primary-accent); border:1px solid var(--primary-accent); color:#fff; border-radius:10px; font-weight:600 }
        #modal-mi-manager .device-entry{ background:transparent; border:1px solid var(--border-color); border-radius:10px; padding:12px; margin-bottom:10px }
        #modal-mi-manager .device-entry .tag { background:transparent; border-radius:6px; padding:6px; border:1px solid var(--border-color); color:var(--muted-text-color); }
        #modal-mi-manager canvas{ display:block; margin:8px auto; background:#fff; border-radius:8px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.03) }
        #modal-mi-manager .pessoa-detalhes-panel{ background:transparent; border-left:1px solid var(--border-color); padding-left:14px }
        /* Estilo centralizado para o botão Limpar do editor de padrão */
        #mi_resetDraw { border:none; background:none; color:var(--muted-text-color,#666); cursor:pointer; font-size:11px; display:block; margin:8px auto; }
        #modal-mi-manager .badge-count{ background:var(--primary-accent); color:#fff; padding:4px 10px; border-radius:12px; font-weight:700 }
        /* Estilos do modal de detalhes do dispositivo Xiaomi */
        #modal-mi-device-details .modal-credenciais-content {
            padding: 16px;
            border-radius: 12px;
            background: var(--background-color);
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            opacity: 1;
            height: 86vh;
        }
        #modal-mi-device-details .modal-credenciais-header h2 { margin: 0; font-size: 1.05rem; color: var(--text-color); }
        #modal-mi-device-details .pessoa-detalhes-panel {
            background: transparent;
            border-left: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            overflow: auto;
            align-items: stretch;
        }
        #modal-mi-device-details .pessoa-detalhes-body { flex: 1 1 auto; display: flex; flex-direction: column; gap: 12px; align-items: stretch; }
        /* Forçar detalhes internas a preencher todo o espaço horizontal */
        #modal-mi-device-details .detalhe-item { width: 100%; box-sizing: border-box; }
        #modal-mi-device-details .detalhe-content { width: 100%; flex: 1 1 auto; }
        #modal-mi-device-details .detalhe-valor { width: 100%; word-break: break-word; }
        /* canvas e senha */
        #modal-mi-device-details canvas { display:block; margin: 6px auto; }
        .plain-pass { font-weight:700; }
        /* estilo minimal para senha Padrão */
        #modal-mi-device-details .detalhe-item.detalhe-senha-sim { padding:6px 0; display:flex; justify-content:center; align-items:center; }
        #modal-mi-device-details .detalhe-item.detalhe-senha-sim canvas { width:220px; height:220px; max-width:90%; }
        #modal-mi-device-details .detalhe-item.detalhe-senha-sim .btn-step { margin-top:8px }
        .btn-step {
            padding:10px 14px;
            border-radius:10px;
            border:1px solid var(--mi-orange);
            background: transparent; /* transparente por padrão para evitar "branco" sobre fundo claro */
            color: var(--mi-orange);
            cursor: pointer;
            font-weight:700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            transition: all 0.12s ease;
        }
        .btn-step:hover,
        .btn-step:focus {
            background: var(--mi-orange);
            color: #fff;
            outline: none;
            box-shadow: 0 8px 26px rgba(255,103,0,0.12);
        }
        .btn-step:active {
            transform: translateY(1px);
            background: var(--mi-orange);
            color: #fff;
        }
        /* botão de remover aparelho no painel de detalhes */
        .mi-device-delete { position:absolute; right:10px; top:calc(50% - 18px); width:36px; height:36px; min-width:36px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--danger-accent,#ff3b30); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:18px; }
        .mi-device-delete:hover { background:var(--danger-accent,#ff3b30); color:#fff }
        .btn-small {
            padding:6px 8px;
            border-radius:6px;
            border:1px solid rgba(0,0,0,0.06);
            background:transparent;
            color:var(--mi-orange);
            cursor:pointer;
            font-size:0.9rem;
            transition: none; /* remover transições por padrão para compacto */
        }
        .btn-small:hover { background:var(--mi-orange); color:#fff }

        /* Variante cinza/compacta */
        .btn-muted { background:transparent; color:var(--text-color); border:1px solid #C6C6C8; }
        .btn-muted:hover { background: transparent; color: var(--text-color); }
        .btn-small.btn-muted { padding:6px 8px; font-size:0.88rem; transition:none; transform:none; }
        .btn-small.btn-muted svg { width:16px; height:16px; }
        .btn-small.btn-muted:active, .btn-small.btn-muted:focus { transform:none; outline:none; box-shadow:none; }

    </style>

    <div id="mi_summary" class="mi-summary-box" style="display:flex; align-items:center; gap:8px;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="7" width="14" height="10" rx="2"></rect>
            <rect x="17" y="9" width="4" height="6" rx="1"></rect>
        </svg>
        <span>Aparelhos Correlacionados</span>
        <div class="badge-count" id="mi_count">0</div>
    </div>

    <!-- Modal do Gerenciador Xiaomi (abre ao clicar na caixa acima) -->
    <div id="modal-mi-manager" class="modal-credenciais" style="display:none;">
        <div class="modal-credenciais-content">
            <div class="modal-credenciais-header">
                <span class="modal-credenciais-icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" width="20" height="20" aria-hidden="true">
                        <circle cx="11" cy="11" r="6"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </span>
                <h2>Gerenciador de Aparelhos</h2>
                <button class="modal-credenciais-close" id="fechar-mi-manager">&times;</button>
            </div>

            <!-- Coluna principal: formulário + lista -->
            <div>
                <div style="margin-bottom:12px;">
                    <form id="mi_deviceForm">
                        <div class="input-group">
                            <label>Tipo de Aparelho</label>
                            <select id="mi_deviceType"><option>Celular</option><option>Tablet</option><option>PC</option></select>
                        </div>
                        <div class="input-group">
                            <label>Nome do Aparelho</label>
                            <input type="text" id="mi_deviceName" placeholder="Ex: Telefone Pessoal, Work-Phone">
                        </div>
                        <div class="input-group">
                            <label>IMEI</label>
                            <input type="text" id="mi_imei">
                        </div>
                        <div class="input-group">
                            <label>S/N</label>
                            <input type="text" id="mi_sn">
                        </div>
                        <div class="input-group">
                            <label>Plugin de Segurança</label>
                            <select id="mi_cloudType"><option>Xiaomi Cloud</option><option>iCloud</option><option>Samsung Cloud</option><option>Google Account</option></select>
                        </div>

                        <div class="input-group">
                            <label>E-mail do Aparelho</label>
                            <input type="email" id="mi_email" placeholder="usuario@provedor.com">
                        </div>

                        <div class="input-group">
                            <label>Telefone</label>
                            <input type="tel" id="mi_phone" placeholder="(00) 00000-0000">
                        </div>

                        <div class="input-group">
                            <label>Senha do E-mail</label>
                            <input type="text" id="mi_email_password" placeholder="Senha do e-mail">
                        </div>

                        <div class="input-group">
                            <label>Senha Auxiliar</label>
                            <div class="mi-aux-select">
                                <select id="mi_aux_type">
                                    <option value="">(Nenhuma)</option>
                                    <option value="Número">Numérica</option>
                                    <option value="Texto">Texto</option>
                                    <option value="Alfanumérica">Alfanumérica</option>
                                </select>
                            </div>
                            <div id="mi_aux_group" style="display:none; margin-top:8px">
                                <label id="mi_aux_label">Senha Auxiliar</label>
                                <input type="text" id="mi_aux_password" placeholder="Digite a senha auxiliar">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>Adicionar aparelho a uma credencial correlacionada</label>
                            <div class="mi-cred-select">
                                <select id="mi_cred_choice"><option value="">(Nenhuma)</option></select>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Tipo de Senha</label>
                            <select id="mi_passwordType">
                                <option value="Padrão">Padrão (Desenho)</option>
                                <option value="Número">Número</option>
                                <option value="Texto" selected>Texto</option>
                            </select>
                        </div>
                        <div id="mi_textInputGroup" class="input-group" style="display:none"><input type="text" id="mi_plainPassword" placeholder="Digite a senha"></div>
                        <div id="mi_patternInputGroup" class="pattern-box">
                            <canvas id="mi_drawCanvas" width="200" height="200"></canvas>
                            <br><button type="button" id="mi_resetDraw">Limpar</button>
                        </div>
                        <button type="submit" class="btn-submit">Salvar Aparelho</button>
                    </form>
                </div>

                <div>
                    <h4 style="margin:8px 0">Lista de Dispositivos</h4>
                    <div id="mi_deviceList"></div>
                </div>
            </div>

            <!-- Coluna lateral: detalhes -->
            <div id="mi_device_details" class="pessoa-detalhes-panel"></div>
        </div>
    </div>

    <!-- Modal dedicado para detalhes de dispositivo Xiaomi (sem cabeçalho, apenas painel) -->
    <div id="modal-mi-device-details" class="modal-credenciais" style="display:none;">
        <div class="modal-credenciais-content">
            <div id="mi_device_details_panel" class="pessoa-detalhes-panel"></div>
        </div>
    </div>



    <script>
        (function(){
            document.addEventListener('DOMContentLoaded', function(){
            const canvas = document.getElementById('mi_drawCanvas');
            const ctx = canvas.getContext('2d');
            let mi_points = [], mi_currentPath = [], mi_isDrawing=false, mi_simStates = {};

            function mi_initGrid(){ mi_points = []; for(let r=0;r<3;r++) for(let c=0;c<3;c++) mi_points.push({x:40+c*60,y:40+r*60,id:r*3+c+1}); mi_mi_draw(); }
            function mi_mi_draw(){ ctx.clearRect(0,0,canvas.width,canvas.height);
                if(mi_currentPath.length>1){ ctx.beginPath(); ctx.strokeStyle='#ff6700'; ctx.lineWidth=6; ctx.lineJoin='round'; ctx.lineCap='round'; const s = mi_points.find(p=>p.id===mi_currentPath[0]); ctx.moveTo(s.x,s.y); for(let i=1;i<mi_currentPath.length;i++){ const p=mi_points.find(pt=>pt.id===mi_currentPath[i]); ctx.lineTo(p.x,p.y);} ctx.stroke(); }
                mi_points.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,8,0,Math.PI*2); ctx.fillStyle = mi_currentPath.includes(p.id)?'#ff6700':'#ddd'; ctx.fill(); }); }

            function mi_handlePointer(e){ if(!mi_isDrawing) return; const rect = canvas.getBoundingClientRect(); const x = (e.clientX||e.touches[0].clientX)-rect.left; const y = (e.clientY||e.touches[0].clientY)-rect.top; for(let p of mi_points){ const dist = Math.hypot(p.x-x,p.y-y); if(dist<20 && !mi_currentPath.includes(p.id)){ mi_currentPath.push(p.id); mi_mi_draw(); break; } } }

            canvas.addEventListener('mousedown',(e)=>{ mi_isDrawing=true; mi_currentPath=[]; mi_handlePointer(e); });
            canvas.addEventListener('touchstart',(e)=>{ mi_isDrawing=true; mi_currentPath=[]; mi_handlePointer(e); e.preventDefault(); },{passive:false});
            window.addEventListener('mousemove',mi_handlePointer);
            // Only prevent default (disable page scroll) while the user is drawing on the canvas
            window.addEventListener('touchmove', (e)=>{ if(mi_isDrawing){ mi_handlePointer(e); e.preventDefault(); } },{passive:false});
            window.addEventListener('mouseup',()=>mi_isDrawing=false);
            window.addEventListener('touchend',()=>mi_isDrawing=false);
            document.getElementById('mi_resetDraw').addEventListener('click',()=>{ mi_currentPath=[]; mi_mi_draw(); });

            function mi_toggleFields(){ const t=document.getElementById('mi_passwordType').value; document.getElementById('mi_patternInputGroup').style.display=(t==='Padrão')?'block':'none'; document.getElementById('mi_textInputGroup').style.display=(t==='Padrão')?'none':'block'; }
            document.getElementById('mi_passwordType').addEventListener('change',mi_toggleFields);

document.getElementById('mi_deviceForm').onsubmit = function(e){
                e.preventDefault();
                const type = document.getElementById('mi_passwordType').value;
                const auxType = (document.getElementById('mi_aux_type') && document.getElementById('mi_aux_type').value) || '';
                const auxVal = auxType ? (document.getElementById('mi_aux_password').value || '') : '';
                const credSel = (document.getElementById('mi_cred_choice') && document.getElementById('mi_cred_choice').value) || '';

                const device = {
                    id: Date.now(),
                    name: document.getElementById('mi_deviceName').value,
                    deviceType: document.getElementById('mi_deviceType').value,
                    imei: document.getElementById('mi_imei').value,
                    sn: document.getElementById('mi_sn').value,
                    cloud: document.getElementById('mi_cloudType').value,
                    email: (document.getElementById('mi_email') && document.getElementById('mi_email').value) || '',
                    phone: (document.getElementById('mi_phone') && document.getElementById('mi_phone').value) || '',
                    emailPassword: (document.getElementById('mi_email_password') && document.getElementById('mi_email_password').value) || '',
                    passType: type,
                    passValue: (type === 'Padrão') ? [...mi_currentPath] : document.getElementById('mi_plainPassword').value,
                    auxPassword: auxType ? { type: auxType, value: auxVal } : null
                };

                const db = JSON.parse(localStorage.getItem('mi_db_v5')||'[]');
                db.push(device);
                localStorage.setItem('mi_db_v5',JSON.stringify(db));
                mi_currentPath = [];

                // se conectar a uma credencial selecionada, anexar
                try{
                    if(credSel){
                        console.log('mi_deviceForm: credSel=', credSel);
                        const c = (credenciaisAnalisadas||[]).find(p=>p.nome===credSel || p.id===credSel || p.email===credSel);
                        if(c){
                            console.log('mi_deviceForm: vincular a credencial encontrada ->', c.nome);
                            c.aparelhos = c.aparelhos || [];
                            c.aparelhos.push(device);
                            // persistir a associação aparelho -> credencial no storage para sobreviver a reanálises
                            try{
                                const map = JSON.parse(localStorage.getItem('mi_cred_aparelhos')||'{}');
                                const key = normalizarNome(c.nome || c.id || c.email || '');
                                map[key] = map[key] || [];
                                map[key].push(device);
                                localStorage.setItem('mi_cred_aparelhos', JSON.stringify(map));
                                console.log('mi_deviceForm: persistido aparelho para chave', key, 'total agora', map[key].length);
                            }catch(e){ console.warn('Erro ao persistir aparelho por credencial', e); }

                            atualizarUICredenciais(); try{ renderizarListaPessoas(); }catch(e){} }
                    }
                }catch(e){ console.warn('Erro ao ligar a credencial',e) }

                // limpar campos do formulário
                try{
                    document.getElementById('mi_deviceName').value='';
                    document.getElementById('mi_imei').value='';
                    document.getElementById('mi_sn').value='';
                    document.getElementById('mi_plainPassword').value='';
                    document.getElementById('mi_aux_password').value='';
                    // limpar novos campos
                    try{ document.getElementById('mi_email').value=''; }catch(_){}
                    try{ document.getElementById('mi_phone').value=''; }catch(_){}
                    try{ document.getElementById('mi_email_password').value=''; }catch(_){}
                    const selClear = document.getElementById('mi_cred_choice'); if(selClear) selClear.value='';
                    const auxTypeSel = document.getElementById('mi_aux_type'); if(auxTypeSel) auxTypeSel.value='';
                    try{ updateAuxVisibility(); }catch(e){}
                }catch(e){}
                mi_render(); };

            function mi_render(){ const list = document.getElementById('mi_deviceList'); const db = JSON.parse(localStorage.getItem('mi_db_v5')||'[]'); console.log('mi_render: devices', db && db.length ? db.length : 0, db); list.innerHTML=''; list.classList.add('device-list-compact'); document.getElementById('mi_count').textContent = db.length || 0; if(!db || db.length === 0){ list.innerHTML = '<div class="device-empty">Nenhum aparelho correlacionado</div>'; return; } db.forEach(dev=>{ console.log('mi_render device', dev); mi_simStates[dev.id]=0; const div=document.createElement('div'); div.className='device-profile'; div.setAttribute('role','button'); div.setAttribute('tabindex','0');
                // escolher ícone conforme deviceType
                let iconSVG = '';
                const t = (dev.deviceType||'').toLowerCase();
                if(t.includes('celular')||t.includes('phone')||t.includes('mobile')){
                    iconSVG = `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="8" y="2" width="8" height="18" rx="2"></rect><circle cx="12" cy="18" r="0.7"></circle></svg>`;
                } else if(t.includes('tablet')){
                    iconSVG = `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="5" y="3" width="14" height="18" rx="2"></rect><path d="M9 7h6"></path></svg>`;
                } else {
                    // pc / notebook
                    iconSVG = `<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="12" rx="2"></rect><path d="M8 20h8"></path></svg>`;
                }
                div.innerHTML = `
                    <div class="device-icon" aria-hidden="true" style="background: linear-gradient(135deg,#2b9ef4,#71c7ff); border:1px solid rgba(0,0,0,0.03);">${iconSVG}</div>
                    <div class="device-content">
                        <div class="device-name" title="${dev.name || dev.deviceType || ''}">${dev.name || dev.deviceType || 'Dispositivo'}</div>
                    </div>
                `;
                div.addEventListener('click', (e)=>{ if(!e.target.closest('.btn-icon')) mi_showDeviceDetails(dev); else mi_showDeviceDetails(dev); });
                div.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); mi_showDeviceDetails(dev); } });
                list.appendChild(div);
            }); }

            function mi_showDeviceDetails(dev){
                console.log('mi_showDeviceDetails called for', dev.id);
                try{
                    // Fechar o modal do gerenciador para evitar dois modais abertos
                    fecharModalMiManager();
                    // Fechar o modal de credenciais se estiver aberto
                    try{ fecharModalCredenciais(); }catch(e){}
                    // Fechar o modal de device details se já estiver aberto
                    mi_closeDeviceDetails();

                    const modal = document.getElementById('modal-mi-device-details');
                    const detalhesContainer = document.getElementById('mi_device_details_panel');
                    if(!modal || !detalhesContainer) return;

                    // mostrar o modal (sem usar a classe global modal-open, para não acionar o modal de Credenciais)
                    modal.style.display = 'block';
                    modal.style.opacity = '1';
                    // impedir scroll da página sem usar a classe global
                    try{ document.body.style.overflow = 'hidden'; }catch(e){}
                    // definir height no modalContent para que o grid funcione corretamente
                    const modalContent = modal.querySelector('.modal-credenciais-content');
                    if(modalContent) {
                        modalContent.style.setProperty('height','86vh','important');
                        modalContent.style.setProperty('opacity','1','important');
                    }

                    // Definir o conteúdo após o modal estar visível
                    const iniciais = (dev.deviceType||'').slice(0,2).toUpperCase();
                    let detalhesHTML = `
                        <button class="btn-voltar-lista" id="mi_btn_voltar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                            Voltar
                        </button>
                        <div class="mi-device-header" style="position:relative; display:flex; align-items:center; gap:12px; padding:8px 0;">
                            <div class="device-icon" aria-hidden="true" style="background: linear-gradient(135deg,#2b9ef4,#71c7ff); border:1px solid rgba(0,0,0,0.03);"><svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="12" rx="2"></rect><path d="M8 20h8"></path></svg></div>
                            <div class="device-content">
                                <div class="device-name" title="${dev.deviceType||dev.name||''}">${dev.name || dev.deviceType || 'Dispositivo'}</div>
                            </div>
                            <button class="mi-device-delete" title="Remover aparelho" onclick="mi_deleteDevice(${dev.id});">&times;</button>
                        </div>
                        <div class="pessoa-detalhes-body">
                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">IMEI</div>
                                    <div class="detalhe-valor">${dev.imei || '—'}</div>
                                </div>
                            </div>
                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M22 16.92a1.93 1.93 0 0 1-2.12 1.92 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A1.93 1.93 0 0 1 4.12 2h3a2 2 0 0 1 2 1.72 12.86 12.86 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.86 12.86 0 0 0 2.81.7A2 2 0 0 1 22 16.92Z"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">S/N</div>
                                    <div class="detalhe-valor">${dev.sn || '—'}</div>
                                </div>
                            </div>
                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M20 16.58A4.5 4.5 0 0 0 15.5 12H15a4 4 0 0 0-7.9 1.2A3.5 3.5 0 0 0 3.5 17H20z"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">Nuvem</div>
                                    <div class="detalhe-valor">${dev.cloud || '—'}</div>
                                </div>
                            </div>

                            <!-- informações adicionais do formulário -->
                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M3 11h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V11z"></path>
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">Nome do Aparelho</div>
                                    <div class="detalhe-valor">${dev.name || '—'}</div>
                                </div>
                            </div>

                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <rect x="3" y="4" width="18" height="12" rx="2"></rect>
                                        <path d="M8 20h8"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">Tipo de Aparelho</div>
                                    <div class="detalhe-valor">${dev.deviceType || '—'}</div>
                                </div>
                            </div>

                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M20 16.58A4.5 4.5 0 0 0 15.5 12H15a4 4 0 0 0-7.9 1.2A3.5 3.5 0 0 0 3.5 17H20z"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">Plugin de Segurança</div>
                                    <div class="detalhe-valor">${dev.cloud || '—'}</div>
                                </div>
                            </div>

                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M20 14v6H4v-6"></path>
                                        <path d="M20 8v2l-8 5-8-5V8l8 5 8-5z"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">E-mail</div>
                                    <div class="detalhe-valor">${dev.email || '—'}</div>
                                </div>
                            </div>

                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M2 17a5 5 0 0 0 5 5h10a5 5 0 0 0 5-5V7"></path>
                                        <path d="M22 2l-5 5"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">Telefone</div>
                                    <div class="detalhe-valor">${dev.phone || '—'}</div>
                                </div>
                            </div>

                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <rect x="4" y="4" width="16" height="12" rx="2"></rect>
                                        <path d="M8 12h8"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">Senha do E-mail</div>
                                    <div class="detalhe-valor plain-pass">${dev.emailPassword || '—'}</div>
                                </div>
                            </div>

                            ${dev.auxPassword ? `
                                <div class="detalhe-item">
                                    <div class="detalhe-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                            <rect x="3" y="11" width="18" height="10" rx="2"></rect>
                                        </svg>
                                    </div>
                                    <div class="detalhe-content">
                                        <div class="detalhe-label">Senha Auxiliar ${dev.auxPassword.type?('('+dev.auxPassword.type+')'):dev.auxPassword.plugin?('('+dev.auxPassword.plugin+')'):''}</div>
                                        <div class="detalhe-valor"><span id="mi-aux-val-${dev.id}">${dev.auxPassword.value?dev.auxPassword.value:'—'}</span></div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <circle cx="11" cy="8" r="3"></circle>
                                        <path d="M21 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">Credencial vinculada</div>
                                    <div class="detalhe-valor" id="mi-linked-creds-${dev.id}">—</div>
                                </div>
                            </div>

                            <div class="detalhe-item">
                                <div class="detalhe-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <path d="M8 7V3h8v4"></path>
                                        <rect x="4" y="7" width="16" height="12" rx="2"></rect>
                                    </svg>
                                </div>
                                <div class="detalhe-content">
                                    <div class="detalhe-label">Data de cadastro</div>
                                    <div class="detalhe-valor">${new Date(dev.id).toLocaleString()}</div>
                                </div>
                            </div>

                            ${dev.passType === 'Padrão' ? `
                                <div class="detalhe-item detalhe-senha-sim">
                                    <div class="detalhe-content" style="width:100%;display:flex;flex-direction:column;align-items:center;">
                                        <canvas id="mi-c-${dev.id}" width="200" height="200"></canvas>
                                        <div style="text-align:center;margin-top:12px"><button id="mi-act-${dev.id}" class="btn-step">Iniciar</button></div>
                                    </div>
                                </div>
                            ` : `
                                <div class="detalhe-item">
                                    <div class="detalhe-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                            <rect x="3" y="11" width="18" height="11" rx="2"></rect>
                                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                        </svg>
                                    </div>
                                    <div class="detalhe-content">
                                        <div class="detalhe-label">Senha</div>
                                        <div class="detalhe-valor">
                                            ${(dev.passType === 'Número' || dev.passType === 'Texto') ? (`<div class="plain-pass">${dev.passValue || '—'}</div>`) : (`<div>—</div>`) }
                                        </div>
                                    </div>
                                </div>
                            `}
                        </div>
                    `;

                    detalhesContainer.innerHTML = detalhesHTML;
                    // conectar o botão voltar ao handler (evita depender de funções no escopo global)
                    try{ const voltarBtn = modal.querySelector('#mi_btn_voltar'); if(voltarBtn) voltarBtn.addEventListener('click', mi_backToManager); }catch(e){}
                    console.log('detalhesContainer found:', !!detalhesContainer);
                    console.log('detalhesHTML length:', detalhesHTML.length);
                    console.log('detalhesContainer innerHTML set');
                    console.log('detalhesContainer.innerHTML after set:', detalhesContainer.innerHTML.substring(0,200));
                    console.log('passType for device:', dev.passType, dev.passValue);
                    // Forçar reflow
                    modal.offsetHeight;
                    // garantir que o painel de detalhes esteja visível
                    try{
                        detalhesContainer.style.setProperty('display','block','important');
                        detalhesContainer.style.setProperty('visibility','visible','important');
                        detalhesContainer.style.setProperty('flex','1','important');
                        detalhesContainer.style.setProperty('opacity','1','important');
                        console.log('styles set on detalhesContainer');
                        console.log('modal display:', getComputedStyle(modal).display);
                        console.log('modalContent display:', getComputedStyle(modal.querySelector('.modal-credenciais-content')).display);
                        console.log('detalhesContainer computed display:', getComputedStyle(detalhesContainer).display);
                        console.log('detalhesContainer computed visibility:', getComputedStyle(detalhesContainer).visibility);
                        console.log('detalhesContainer children length:', detalhesContainer.children.length);
                        console.log('detalhesContainer.innerText:', detalhesContainer.innerText.substring(0,100));
                        console.log('modalContent opacity:', getComputedStyle(modalContent).opacity);
                        console.log('detalhesContainer opacity:', getComputedStyle(detalhesContainer).opacity);
                    }catch(e){}

                    // preencher credenciais vinculadas e garantir que a senha auxiliar seja visível
                    try{
                        // Credenciais vinculadas
                        const linkedEl = document.getElementById(`mi-linked-creds-${dev.id}`);
                        if(linkedEl && typeof credenciaisAnalisadas !== 'undefined'){
                            const linked = (credenciaisAnalisadas||[]).filter(p => (p.aparelhos||[]).some(a => String(a.id)===String(dev.id))).map(p => p.nome);
                            linkedEl.textContent = linked.length ? linked.join(', ') : '—';
                        }
                        // exibir senha auxiliar sem toggle
                        const auxValEl = document.getElementById(`mi-aux-val-${dev.id}`);
                        if(auxValEl){
                            // garantir valor padrão quando vazio
                            if(!auxValEl.textContent || auxValEl.textContent.trim() === '') auxValEl.textContent = '—';
                        }
                    }catch(e){}

                    // inicializar canvas/ação se for padrão
                    if(dev.passType === 'Padrão'){
                        setTimeout(()=>{
                            // ajustar canvas para o tamanho disponível e alta DPI
                            try{
                                const canvas = document.getElementById(`mi-c-${dev.id}`);
                                const modalContent = modal.querySelector('.modal-credenciais-content') || document.body;
                                if(canvas){
                                    const maxAllowed = Math.max(150, Math.min(260, Math.floor((modalContent.clientWidth||320) * 0.5)));
                                    // definir tamanho de exibição e atributos de pixel para nitidez (cap DPR para 2)
                                    const dpr = Math.min(window.devicePixelRatio || 1, 2);
                                    const displaySize = maxAllowed;
                                    canvas.style.width = displaySize + 'px';
                                    canvas.style.height = displaySize + 'px';
                                    canvas.width = Math.floor(displaySize * dpr);
                                    canvas.height = Math.floor(displaySize * dpr);

                                    // preparar offscreen cache para desenhar grade estática (melhora performance)
                                    try{
                                        window.mi_sim_cache = window.mi_sim_cache || {};
                                        const off = document.createElement('canvas');
                                        off.width = canvas.width; off.height = canvas.height;
                                        const ox = off.getContext('2d'); ox.setTransform(dpr,0,0,dpr,0,0);
                                        const sizeCss = displaySize;
                                        const pad = Math.round(sizeCss * 0.12);
                                        const spacing = (sizeCss - pad*2) / 2;
                                        ox.clearRect(0,0,sizeCss,sizeCss);
                                        // desenhar pontos estáticos
                                        const dotR = Math.max(3, Math.round(sizeCss * 0.03));
                                        ox.fillStyle = '#eee';
                                        for(let r=0;r<3;r++){
                                            for(let col=0;col<3;col++){
                                                const x = pad + col*spacing;
                                                const y = pad + r*spacing;
                                                ox.beginPath(); ox.arc(x,y,dotR,0,Math.PI*2); ox.fill();
                                            }
                                        }
                                        window.mi_sim_cache[dev.id] = { offscreen: off, dpr: dpr, size: sizeCss };
                                    }catch(e){ console.warn('Error creating offscreen cache', e); }
                                }
                            }catch(e){console.warn('Error sizing canvas', e)}

                            mi_drawSim(dev.id, dev.passValue, 0);
                            mi_updateActionButton(dev.id, Array.isArray(dev.passValue)?dev.passValue.length:0);
                            const act = document.getElementById(`mi-act-${dev.id}`);
                            if(act){ act.addEventListener('click', ()=>{ if(window.mi_manager && window.mi_manager.toggleSim) window.mi_manager.toggleSim(dev.id, dev.passValue.length); }); }
                        },0);
                    }
                } catch(e){ console.error('Erro em mi_showDeviceDetails:', e); }
            }

            function mi_closeDeviceDetails(){
                const modal = document.getElementById('modal-mi-device-details');
                if(modal) modal.style.display = 'none';
                try{ document.body.style.overflow = ''; }catch(e){}
            }

            function mi_backToManager(){
                try{ mi_closeDeviceDetails(); }catch(e){}
                try{ if(typeof abrirModalMiManager === 'function') setTimeout(()=>abrirModalMiManager(), 50); }catch(e){}
            }

            // expor handlers importantes para o escopo global para permitir chamadas de outras partes do app
            try{ window.mi_showDeviceDetails = mi_showDeviceDetails; window.mi_closeDeviceDetails = mi_closeDeviceDetails; }catch(e){}
            // helper: abrir detalhes por id (procura no db localStorage)
            try{ window.mi_showDeviceDetailsById = function(id){ try{ const db = JSON.parse(localStorage.getItem('mi_db_v5')||'[]').find(d=>String(d.id)===String(id)); if(db) return window.mi_showDeviceDetails(db); // tentar também na lista atual de credenciais
                const all = JSON.parse(localStorage.getItem('mi_db_v5')||'[]'); const fallback = all.find(d=>String(d.id)===String(id)); if(fallback) return window.mi_showDeviceDetails(fallback); console.warn('mi_showDeviceDetailsById: device not found', id); }catch(e){ console.warn('mi_showDeviceDetailsById error', e); } } }catch(e){}

            // remover aparelho por id (definido no escopo global)
            window.mi_deleteDevice = function(id){
                try{
                    const db = JSON.parse(localStorage.getItem('mi_db_v5')||'[]');
                    const idx = db.findIndex(d=>String(d.id)===String(id));
                    if(idx >= 0){ db.splice(idx,1); localStorage.setItem('mi_db_v5', JSON.stringify(db)); }
                    // remover de mapeamento por credencial
                    try{
                        const map = JSON.parse(localStorage.getItem('mi_cred_aparelhos')||'{}');
                        Object.keys(map).forEach(k=>{
                            map[k] = (map[k]||[]).filter(d=>String(d.id)!==String(id));
                            if(!map[k].length) delete map[k];
                        });
                        localStorage.setItem('mi_cred_aparelhos', JSON.stringify(map));
                    }catch(e){ console.warn('mi_deleteDevice: remove map error', e); }

                    // remover de credenciais carregadas na sessão
                    try{
                        (credenciaisAnalisadas||[]).forEach(p=>{ if(p.aparelhos) p.aparelhos = p.aparelhos.filter(d=>String(d.id)!==String(id)); });
                        atualizarUICredenciais(); try{ renderizarListaPessoas(); }catch(e){}
                    }catch(e){ console.warn('mi_deleteDevice: remove from credenciais error', e); }
                    // atualizar lista principal e fechar detalhes
                    try{ mi_render(); mi_closeDeviceDetails(); }catch(e){}
                }catch(e){ console.error('Erro em mi_deleteDevice', e); }
            }





            function mi_drawSim(id, path, step){
    const c = document.getElementById(`mi-c-${id}`);
    if(!c) return;
    const dpr = window.devicePixelRatio || 1;
    // adaptar para o tamanho atual do canvas (já configurado pelo container)
    const displayWidth = c.clientWidth || (c.width / dpr) || 150;
    const displayHeight = c.clientHeight || (c.height / dpr) || 150;
    const size = Math.min(displayWidth, displayHeight);

    // ajustar buffer de pixels para alta DPI
    c.width = Math.floor(size * dpr);
    c.height = Math.floor(size * dpr);
    c.style.width = size + 'px';
    c.style.height = size + 'px';

    const x = c.getContext('2d');
    x.setTransform(dpr,0,0,dpr,0,0);

    const cache = (window.mi_sim_cache||{})[id];
    // layout responsivo da grade 3x3
    const sizeCss = size;
    const pad = Math.round(sizeCss * 0.12);
    const spacing = (sizeCss - pad*2) / 2;
    const dotR = Math.max(3, Math.round(sizeCss * 0.03));

    // usar offscreen se disponível (desenha pontos estáticos de forma rápida)
    if(cache && cache.offscreen){
        try{
            // desenhar cópia do offscreen (cache contém dispositivo pixel-alinhado)
            x.clearRect(0,0,size,size);
            x.drawImage(cache.offscreen, 0, 0);
        }catch(e){
            x.clearRect(0,0,size,size);
        }
    } else {
        x.clearRect(0,0,size,size);
        // fallback: desenhar pontos
        x.fillStyle = '#eee';
        for(let r=0;r<3;r++){
            for(let col=0;col<3;col++){
                const px = pad + col*spacing;
                const py = pad + r*spacing;
                x.beginPath(); x.arc(px,py,dotR,0,Math.PI*2); x.fill();
            }
        }
    }

    // desenhar trilha se houver passos
    if(step > 1 && Array.isArray(path) && path.length){
        const sIndex = path[0];
        const s = {x: pad + ((sIndex-1)%3)*spacing, y: pad + (Math.floor((sIndex-1)/3))*spacing};
        if(s){
            x.beginPath();
            x.strokeStyle = '#ff6700';
            x.lineWidth = Math.max(2, Math.round(sizeCss * 0.04));
            x.lineJoin = 'round';
            x.moveTo(s.x, s.y);
            for(let i=1;i<step;i++){
                const idp = path[i];
                const px = pad + ((idp-1)%3)*spacing;
                const py = pad + (Math.floor((idp-1)/3))*spacing;
                x.lineTo(px, py);
            }
            x.stroke();
        }
    }

    // pintar pontos ativos
    if(Array.isArray(path)){
        path.slice(0,step).forEach(activeId=>{
            const px = pad + ((activeId-1)%3)*spacing;
            const py = pad + (Math.floor((activeId-1)/3))*spacing;
            x.beginPath(); x.arc(px,py,dotR,0,Math.PI*2); x.fillStyle = '#ff6700'; x.fill();
        });
    }
}

            // Helper: obter label do botão conforme estado
            function mi_getActionLabel(id, len){ const s = mi_simStates[id] || 0; if(s === 0) return 'Iniciar'; if(len && s >= len) return 'Reiniciar'; return 'Continuar'; }

            // Atualiza o texto do botão de ação para um device específico
            function mi_updateActionButton(id, len){ const btn = document.getElementById(`mi-act-${id}`); if(!btn) return; btn.textContent = mi_getActionLabel(id, len); btn.style.margin = '0 auto'; btn.style.display = 'inline-block'; try{ const orange = getComputedStyle(document.documentElement).getPropertyValue('--mi-orange') || '#ff6700'; btn.style.background = 'transparent'; btn.style.color = orange.trim(); }catch(e){} }

            window.mi_manager = {
                // compatibilidade: mantém runSim (start/next/reset)
                runSim: function(id, action){ const db = JSON.parse(localStorage.getItem('mi_db_v5')||'[]').find(d=>d.id===id); if(!db) return; const len = Array.isArray(db.passValue)?db.passValue.length:0; if(action==='start'){ mi_simStates[id]=1; } else if(action==='next'){ mi_simStates[id] = (mi_simStates[id]||0) + 1; if(len && mi_simStates[id] > len) mi_simStates[id]=len; } else { mi_simStates[id]=0; } mi_drawSim(id, db.passValue, mi_simStates[id]); mi_updateActionButton(id,len); },
                // novo: alterna entre Iniciar -> Continuar -> Reiniciar
                toggleSim: function(id, len){ const db = JSON.parse(localStorage.getItem('mi_db_v5')||'[]').find(d=>d.id===id); if(!db) return; const length = len || (Array.isArray(db.passValue)?db.passValue.length:0); const s = mi_simStates[id] || 0; if(s === 0){ mi_simStates[id] = 1; } else if(s < length){ mi_simStates[id] = s + 1; } else { mi_simStates[id] = 0; } mi_drawSim(id, db.passValue, mi_simStates[id]); mi_updateActionButton(id, length); }
            };

            // Abrir/fechar modal do Gerenciador Xiaomi (comportamento igual a Credenciais Analisadas)
            const summary = document.getElementById('mi_summary');
            const modalMi = document.getElementById('modal-mi-manager');
            const fecharMiBtn = document.getElementById('fechar-mi-manager');
            // mover modal para o fim do body para garantir sobreposição e comportamento como os outros modais
            if (modalMi && modalMi.parentNode !== document.body) document.body.appendChild(modalMi);

            function abrirModalMiManager() {
                if (!modalMi) return;
                // garantir que o select de credenciais esteja atualizado sempre que abrir
                try{ populateCredList(); }catch(e){}
                mi_render();
                modalMi.style.display = 'block';
                // impedir scroll da página sem usar a classe global modal-open
                try{ document.body.style.overflow = 'hidden'; }catch(e){}
                const modalContent = modalMi.querySelector('.modal-credenciais-content');
                setTimeout(() => { if (modalContent) modalContent.scrollTop = 0; }, 0);
            }

            function fecharModalMiManager() {
                if (!modalMi) return;
                modalMi.style.display = 'none';
                try{ document.body.style.overflow = ''; }catch(e){}
            }

            if (summary) {
                // garantir prioridade: listener em captura para interceptar outros handlers
                try{ /* reduzir z-index para não sobrepor modais/caixas de mensagem */ summary.style.setProperty('z-index','9000','important'); summary.style.setProperty('pointer-events','auto','important'); }catch(e){}
                summary.addEventListener('click', function(e){
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
                    try{ const mc = document.getElementById('modal-credenciais'); if(mc && mc.style && mc.style.display && mc.style.display !== 'none') fecharModalCredenciais(); }catch(ex){}
                    abrirModalMiManager();
                }, true);
            }

            // controlar visibilidade e texto do campo de Senha Auxiliar
            const miCloudSelect = document.getElementById('mi_cloudType');
            const miAuxType = document.getElementById('mi_aux_type');
            const miAuxGroup = document.getElementById('mi_aux_group');
            const miAuxLabel = document.getElementById('mi_aux_label');
            const miAuxPasswordInput = document.getElementById('mi_aux_password');
            const miCredChoice = document.getElementById('mi_cred_choice');

            function updateAuxVisibility(){ try{
                if(miAuxType && miAuxType.value){
                    miAuxGroup.style.display = 'block';
                    miAuxLabel.textContent = `Senha Auxiliar (${miAuxType.value})`;
                    if(miAuxPasswordInput){ miAuxPasswordInput.placeholder = miAuxType.value === 'Número' ? 'Digite a senha numérica' : (miAuxType.value === 'Alfanumérica' ? 'Digite a senha alfanumérica' : 'Digite a senha de texto'); }
                } else {
                    if(miAuxGroup) miAuxGroup.style.display = 'none';
                    if(miAuxLabel) miAuxLabel.textContent = 'Senha Auxiliar';
                }
            }catch(e){}
            }

            if(miCloudSelect) miCloudSelect.addEventListener('change', ()=>{ /* não afeta aux */ populateCredList(); });
            if(miAuxType) miAuxType.addEventListener('change', ()=>{ updateAuxVisibility(); });
            // garantir estado inicial
            try{ updateAuxVisibility(); }catch(e){}

            function populateCredList(){
                try{
                    const sel = document.getElementById('mi_cred_choice');
                    if(!sel) return;
                    sel.innerHTML = '<option value="">(Selecione)</option>';
                    (credenciaisAnalisadas||[]).forEach(p=>{
                        const opt = document.createElement('option');
                        opt.value = p.nome || p.id || p.email || '';
                        opt.textContent = p.nome || p.email || 'Credencial';
                        sel.appendChild(opt);
                    });
                }catch(e){}
            }
            // popular ao abrir
            populateCredList();
            // repopular quando o conjunto de credenciais for atualizado
            document.addEventListener('credenciaisUpdated', ()=>{ try{ populateCredList(); }catch(e){} });
            if (fecharMiBtn) fecharMiBtn.addEventListener('click', fecharModalMiManager);
            if (modalMi) modalMi.addEventListener('click', (e) => { if (e.target === modalMi) fecharModalMiManager(); });

            // Fechar modal de detalhes do dispositivo
            const fecharDeviceBtn = document.getElementById('fechar-mi-device-details');
            const modalDevice = document.getElementById('modal-mi-device-details');
            // garantir que o modal de detalhes esteja sob o document.body para evitar problemas de sobreposição
            if (modalDevice && modalDevice.parentNode !== document.body) document.body.appendChild(modalDevice);
            if (fecharDeviceBtn) fecharDeviceBtn.addEventListener('click', mi_closeDeviceDetails);
            if (modalDevice) modalDevice.addEventListener('click', (e) => { if (e.target === modalDevice) mi_closeDeviceDetails(); });

            mi_initGrid(); mi_toggleFields(); mi_render();
            });
        })();
    </script>
</div>
<!-- Fim: Xiaomi Manager embutido -->

<div id="alerta-revisao-senha" class="alerta-revisao" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
        <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94A2 2 0 0 0 22.18 18L13.71 3.86a2 2 0 0 0-3.42 0Z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
    </svg>
    <span>Atenção, algumas senhas precisam de ajustes</span>
    <button id="btnRevisarSenha">Revisar</button>
    <button type="button" onclick="adiarAlertaRevisao('senha')">Adiar</button>
</div>

<!-- Aparelhos correlacionados removidos -->

<div id="alerta-revisao-senha" class="alerta-revisao" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
        <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94A2 2 0 0 0 22.18 18L13.71 3.86a2 2 0 0 0-3.42 0Z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
    </svg>
    <span>Atenção, algumas senhas precisam de ajustes</span>
    <button id="btnRevisarSenha">Revisar</button>
    <button type="button" onclick="adiarAlertaRevisao('senha')">Adiar</button>
</div>

<input type="text" id="new-column-name" placeholder="Nova categoria" autocomplete="off" />
<button id="btnAdicionarCategoria">Adicionar Categoria</button>

<div class="filter-controls">
<div class="search-input-with-filters">
    <input type="text" id="search-column" placeholder="Pesquisar categoria ou seção" autocomplete="off" />
    <button type="button" id="btnFieldFilterSenha" class="filter-btn" title="Filtros por seção" aria-haspopup="true" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <polygon points="22 3 2 3 10 12 10 19 14 21 14 12 22 3"></polygon>
        </svg>
    </button>
</div>
<div class="filter-buttons-container">
<button id="btnFiltrar">Filtrar</button>
<button id="btnLimparFiltro">Limpar</button>
</div>
</div>

<div id="boards"></div>

<div class="footerButtons">
<button id="btnImportar">Importar</button>
<button id="btnExportar">Exportar</button>
<button id="btn-go-to-settings">Configurações Adicionais</button>
<input type="file" id="importFileInput" accept=".json" style="display:none;" />
</div>
</div>

<!-- Modal de Credenciais Analisadas -->
<div id="modal-credenciais" class="modal-credenciais">
    <div class="modal-credenciais-content">
        <div class="modal-credenciais-header">
            <span class="modal-credenciais-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="20" height="20" aria-hidden="true">
                    <circle cx="11" cy="11" r="6"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </span>
            <h2>Credenciais Analisadas</h2>
            <button class="modal-credenciais-close" id="fechar-credenciais">&times;</button>
        </div>
        <div id="pessoas-lista-container" class="pessoas-lista"></div>
        <div id="pessoa-detalhes-container" class="pessoa-detalhes-panel"></div>
    </div>
</div>

<!-- Modal de Aparelhos Correlacionados -->
<!-- Aparelhos correlacionados removidos -->

<div id="anotacoesApp" style="display:none;">
<div class="top-bar">
<h1>NOTAS</h1>
<div>
<button id="btnModoLeituraAnotacao">Leitura</button>
<button id="btnSairAnotacao">Sair</button>
</div>
</div>

<div id="credenciais-analisadas-box-anotacao" class="credenciais-analisadas" style="display:none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
        <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z"></path>
        <path d="M20 21a8 8 0 0 0-16 0"></path>
    </svg>
    <span>Notas correlacionadas encontradas</span>
    <div class="badge-count" id="credenciais-analisadas-count-anotacao">0</div>
</div>

<div id="alerta-revisao-anotacao" class="alerta-revisao" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
        <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94A2 2 0 0 0 22.18 18L13.71 3.86a2 2 0 0 0-3.42 0Z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
    </svg>
    <span>Atenção, algumas anotações precisam de ajustes</span>
    <button id="btnRevisarAnotacao">Revisar</button>
    <button type="button" onclick="adiarAlertaRevisao('anotacao')">Adiar</button>
</div>

<input type="text" id="new-anotacao-column-name" placeholder="Nova categoria" autocomplete="off" />
<button id="btnAdicionarAnotacaoCategoria">Adicionar Categoria</button>

<div class="filter-controls">
<div class="search-input-with-filters">
    <input type="text" id="search-anotacao-column" placeholder="Pesquisar categoria ou seção" autocomplete="off" />
    <button type="button" id="btnFieldFilterAnotacao" class="filter-btn" title="Filtros por seção" aria-haspopup="true" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <polygon points="22 3 2 3 10 12 10 19 14 21 14 12 22 3"></polygon>
        </svg>
    </button>
</div>
<div class="filter-buttons-container">
<button id="btnFiltrarAnotacao">Filtrar</button>
<button id="btnLimparFiltroAnotacao">Limpar</button>
</div>
</div>

<div id="anotacoesBoards"></div>

<div class="footerButtons">
<button id="btnImportarAnotacao">Importar</button>
<button id="btnExportarAnotacao">Exportar</button>
<input type="file" id="importAnotacaoFileInput" accept=".dat,.json" style="display:none;" />
</div>
</div>

<div id="certificado">
<h1>PACOTE DE INSTALAÇÃO</h1>

<div id="certTitulo" class="codigo-box clickable" role="button" aria-controls="certInstructions" aria-expanded="false">KEYMASTER AUTHENTICATOR</div>
<!-- Botão/caixa adicional abaixo, mesmo estilo, para download do Plug-in Digital -->
<div id="pluginDigitalBox" class="codigo-box clickable" role="button" aria-label="KEYMASTER PLUG-INS" style="margin-left:0;margin-right:0;padding-left:0;padding-right:0;">KEYMASTER PLUG-INS</div>
<!-- Novo botão: PLUG-IN OFFLINE (mesmo estilo) -->
<div id="pluginOfflineBox" class="codigo-box clickable" role="button" aria-label="KEYMASTER PASSWORD">KEYMASTER PASSWORD</div>
<!-- Botão adicional para Relatorio de Bugs -->
<div id="relatorioBugsBox" class="codigo-box clickable" role="button" aria-label="KEYMASTER REPORT">KEYMASTER REPORT</div>

<div class="helper-actions">
  <div id="certInstructions" class="timeline" style="display:none;">
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </div>
        <div class="content"><strong>Baixe o certificado</strong><p>Obtenha o arquivo de certificado exigido pelo aplicativo.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10M7 12h10M7 16h6"/></svg>
        </div>
        <div class="content"><strong>Acesse a autenticação para upload do app</strong><p>Entre no fluxo de autenticação para habilitar o envio do aplicativo.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M7 12h10"/><path d="M12 7v10"/></svg>
        </div>
        <div class="content"><strong>Codifique a senha mestra</strong><p>Gere ou valide a derivação segura da sua senha mestra.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 12v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7"/><path d="M22 12h-6a4 4 0 0 0-8 0H2"/></svg>
        </div>
        <div class="content"><strong>Autentique pelo e-mail</strong><p>Confirme seu e-mail para vincular a autorização ao seu usuário.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h13"/><path d="M14 9l3 3l-3 3"/></svg>
        </div>
        <div class="content"><strong>Atualize o código único</strong><p>Sincronize o identificador único exigido pela instalação.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h4"/><path d="M7 12h10"/><path d="M7 16h8"/></svg>
        </div>
        <div class="content"><strong>Organize os dados cadastrais</strong><p>Revise e ajuste as informações cadastrais antes de prosseguir.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="content"><strong>Finalize a aplicação</strong><p>Conclua a configuração e prepare o pacote para instalação.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2l4 -4"/><rect x="3" y="4" width="18" height="16" rx="2"/></svg>
        </div>
        <div class="content"><strong>Confirme com a senha mestra e senha numérica</strong><p>Valide as duas credenciais para confirmar e encerrar o processo.</p></div>
     </div>
  </div>
</div>

<div class="cert-buttons">
    <button id="btnInstalar" class="btn-primary">INSTALAÇÃO</button>
    <button id="btnVoltarLogin" class="btn-secondary">Voltar</button>
</div>
</div>

<div id="autoFillSettings">
<h2 class="page-title">Funções Adicionais</h2>
<div class="autofill-actions">
    <button id="btn-go-to-autofill-form" class="autofill-action" aria-label="Preenchimento Automático">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 21h16" />
            <path d="M12 17v-7" />
            <path d="M9 10l3-3l3 3" />
            <path d="M5 7v2a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2z" />
        </svg>
        <span>Preenchimento Automático</span>
    </button>
    <button id="btn-default-card" class="autofill-action" aria-label="Cartão Padrão">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="5" width="18" height="14" rx="2" />
            <path d="M3 9h18" />
            <path d="M7 15h2" />
            <path d="M11 15h6" />
        </svg>
        <span>Cartão Padrão</span>
    </button>
    <button id="btn-manage-marcadores" class="autofill-action" aria-label="Gerenciar Marcadores">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7 4h10a2 2 0 0 1 2 2v12l-7-3l-7 3V6a2 2 0 0 1 2-2z" />
            <path d="M9 9h6" />
        </svg>
        <span>Gerenciar Marcadores</span>
    </button>
    <button id="btn-manage-devices" class="autofill-action" aria-label="Aparelhos Conectados">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="6" y="3" width="12" height="16" rx="2" />
            <path d="M10 19h4" />
        </svg>
        <span>Aparelhos Conectados</span>
    </button>
    <button id="btn-show-pdf-senhas" class="autofill-action" aria-label="Senhas PDF Recentes">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3v12" />
            <path d="M5 10l7 7 7-7" />
            <rect x="3" y="3" width="18" height="18" rx="2" />
        </svg>
        <span>Senhas Recentes</span>
    </button>
    <button id="btn-correlation-toggle" class="autofill-action" aria-label="Correlação Automática">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 13a5 5 0 0 1 0-7" />
            <path d="M14 11a5 5 0 0 1 0 7" />
            <path d="M8 12h8" />
        </svg>
        <span>Correlação Automática</span>
    </button>
    <!-- botão 'Fazer upload de senhas' removido -->
    <button id="btn-local-import" class="autofill-action" aria-label="Importar (Local)">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        <span>Importar (Local)</span>
    </button>
    <button id="btn-local-export" class="autofill-action" aria-label="Exportar (Local)">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 17V7" />
            <path d="M8 11l4-4l4 4" />
            <path d="M4 17v1a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1" />
        </svg>
        <span>Exportar (Local)</span>
    </button>
    <button id="btn-firebase-diagnose" class="autofill-action" aria-label="Diagnóstico Firebase">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M12 8v4"></path>
            <path d="M12 16h.01"></path>
        </svg>
        <span>Diagnóstico Firebase</span>
    </button>
    <button id="btn-apagar-nuvem" class="autofill-action" aria-label="Apagar dados na nuvem" style="border-color: rgba(231,76,60,0.12);">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 6h18" stroke="#e74c3c" />
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6" stroke="#e74c3c" />
            <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="#e74c3c" />
        </svg>
        <span style="color: #e74c3c">Apagar dados na nuvem</span>
    </button>
    <button id="btn-open-firebase-simulator" class="autofill-action" aria-label="Simulador Firebase">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/><path d="M12 8v4l3 2"/></svg>
        <span>Simulador Firebase</span>
    </button>
    <button id="btn-open-hidden-categories" class="autofill-action" aria-label="Categorias Ocultas">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L3 6v6c0 5 3.5 9.5 9 11 5.5-1.5 9-6 9-11V6l-9-4z"/></svg>
        <span>Categorias Ocultas</span>
    </button>
</div>

<div id="hiddenCategoriesBox" class="sim-chart-card" style="margin-top:12px; display:none;">
    <h3 class="page-title" style="font-size:1rem; margin-bottom:8px;">Categorias ocultas (duplicadas)</h3>
    <div id="hidden-categories-content" style="display:flex; gap:12px; flex-wrap:wrap;">
        <div style="flex:1 1 240px; min-width:220px;">
            <strong>Senhas</strong>
            <div id="hidden-senha-list" class="hidden-list" style="margin-top:8px; min-height:40px;"></div>
        </div>
        <div style="flex:1 1 240px; min-width:220px;">
            <strong>Anotações</strong>
            <div id="hidden-anotacao-list" class="hidden-list" style="margin-top:8px; min-height:40px;"></div>
        </div>
    </div>
</div>

<div class="correlation-container">
    <div id="correlation-status" class="correlation-status" style="display:none; margin-top: 10px; padding: 15px; border-radius: var(--border-radius-inner); background: var(--background-color);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>Status da Correlação:</span>
            <label class="switch">
                <input type="checkbox" id="correlation-checkbox">
                <span class="slider round"></span>
            </label>
        </div>
    </div>
</div>
    <button id="btn-autofill-back-to-app" style="margin-top: 10px;">Voltar</button>

<div id="searchResultsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalContent search-results-modal">
        <h2>Resultados da Busca</h2>
        <div class="search-results-container"></div>
        <div class="modalButtons">
            <button type="button" class="close-search">Fechar</button>
        </div>
    </div>
</div>

<div id="modalSavedItems" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloSavedItems">
    <div class="modalContent saved-items-modal">
        <h2 id="modalTituloSavedItems">Gerenciar Itens Salvos</h2>
        
        
        <form id="formSavedItem" class="saved-item-form" autocomplete="off">
            <div class="form-grid">
                <div class="input-container">
                    <input type="text" id="saved-item-titulo" placeholder="Nome do item" required autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-usuario" placeholder="Usuário" autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-email" placeholder="E-mail" autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-telefone" placeholder="Telefone" autocomplete="off" inputmode="numeric" maxlength="13" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-links" placeholder="Links (ex: https://)" autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-cpf" placeholder="CPF" autocomplete="off" maxlength="14" inputmode="numeric" />
                </div>
                <div class="input-container grid-span-2">
                    <textarea id="saved-item-notas" placeholder="Notas adicionais" rows="3" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                </div>
            </div>
            
            <div class="saved-items-buttons">
                <button type="button" class="view-saved-btn liquid-btn" title="Visualizar itens salvos">
                    <span class="liquid-circle"></span>
                </button>
                <button type="submit" class="save-item-btn liquid-btn" title="Salvar item">
                    <span class="check-icon"></span>
                </button>
            </div>
        </form>

        
        <div id="savedItemsList" class="saved-items-list" style="display: none;">
            <div class="saved-items-container">
                
            </div>
            <button type="button" class="back-to-form-btn">Voltar ao Formulário</button>
        </div>

        <div class="modalButtons">
            <button type="button" class="close-saved-items">Fechar</button>
        </div>
    </div>
</div>

<style>

.saved-items-modal {
    max-width: 800px !important;
    margin: auto !important;
}

.modalContent.saved-items-modal {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.form-grid {
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.grid-span-2 {
    grid-column: span 2;
}

.saved-item-form {
    margin: 20px 0;
}

.input-container input,
.input-container textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid rgba(173, 216, 230, 0.2);
    border-radius: 8px;
    background: rgba(173, 216, 230, 0.05);
    color: var(--text-color);
    transition: all 0.3s ease;
}

.input-container input:focus,
.input-container textarea:focus {
    outline: none;
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 2px rgba(var(--primary-accent-rgb), 0.1);
}

.saved-items-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    gap: 15px;
}


.liquid-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(173, 216, 230, 0.1);
    border: 1px solid rgba(173, 216, 230, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
}

.liquid-btn:hover {
    background: rgba(173, 216, 230, 0.2);
    transform: scale(1.05);
    box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.2),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
}


.liquid-circle {
    width: 12px;
    height: 12px;
    background: var(--primary-accent);
    border-radius: 50%;
    position: relative;
}

.liquid-circle::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border: 2px solid var(--primary-accent);
    border-radius: 50%;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}

.check-icon {
    position: relative;
    width: 14px;
    height: 8px;
    border-left: 2px solid var(--primary-accent);
    border-bottom: 2px solid var(--primary-accent);
    transform: rotate(-45deg);
}


.saved-items-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 20px auto;
    width: 100%;
    max-width: 600px;
}

.saved-item {
    background: rgba(173, 216, 230, 0.1);
    border: 1px solid rgba(173, 216, 230, 0.15);
    border-radius: 16px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.saved-item-info {
    flex: 1;
}

.saved-item-actions {
    display: flex;
    gap: 10px;
}

.saved-item-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--text-color);
}

/* Credenciais analisadas */
.credenciais-analisadas {
    background: rgba(0, 122, 255, 0.15);
    border: 2px solid rgba(0, 122, 255, 0.5);
    border-radius: var(--border-radius-inner);
    padding: 12px 16px;
    margin: 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}
.credenciais-analisadas:hover {
    background: rgba(0, 122, 255, 0.2);
    border-color: rgba(0, 122, 255, 0.7);
}
.credenciais-analisadas svg { flex-shrink: 0; stroke: var(--primary-accent); }
.credenciais-analisadas span { flex: 1; font-size: 0.95rem; }
.credenciais-analisadas .badge-count {
    background: var(--primary-accent);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.85rem;
    min-width: 24px;
    text-align: center;
}

/* Mi summary box */
.mi-summary-box {
    background: rgba(0, 122, 255, 0.15);
    border: 2px solid rgba(0, 122, 255, 0.5);
    border-radius: var(--border-radius-inner);
    padding: 12px 16px;
    margin: 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}
.mi-summary-box:hover {
    background: rgba(0, 122, 255, 0.2);
    border-color: rgba(0, 122, 255, 0.7);
}
.mi-summary-box svg { flex-shrink: 0; stroke: var(--primary-accent); }
.mi-summary-box span { flex: 1; font-size: 0.95rem; }
.mi-summary-box .badge-count {
    background: var(--primary-accent);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.85rem;
    min-width: 24px;
    text-align: center;
}

.alerta-revisao {
    background: rgba(255, 159, 0, 0.15);
    border: 2px solid rgba(255, 159, 0, 0.5);
    border-radius: var(--border-radius-inner);
    padding: 12px 16px;
    margin: 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
}
.alerta-revisao svg { flex-shrink: 0; stroke: #FF9500; }
.alerta-revisao span { flex: 1; font-size: 0.95rem; }
.alerta-revisao button {
    background: rgba(255, 159, 0, 0.3);
    border: 1px solid rgba(255, 159, 0, 0.6);
    color: var(--text-color);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
}
.alerta-revisao button:hover { background: rgba(255, 159, 0, 0.5); border-color: #FF9500; }

@media (max-width: 768px) {
    .alerta-revisao {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .alerta-revisao button {
        width: 100%;
    }
}

.modal-credenciais {
    display: none;
    position: fixed;
    z-index: 2147483647 !important;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
}
.modal-credenciais-content {
    background: var(--background-color);
    border-radius: var(--border-radius-main);
    border: 1px solid rgba(0,0,0,0.08);
    margin: 4% auto;
    padding: 22px;
    width: 92%;
    max-width: 980px;
    max-height: 86vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    animation: slideDown 0.22s ease;
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 18px;
    box-shadow: 0 28px 70px rgba(0,0,0,0.35);
    position: relative;
    z-index: 2147483648;
}
/* Estilos para overlay temporário criado por mi_showDeviceDetails */
#mi_temp_modal { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; padding:24px; background: rgba(0,0,0,0.6); z-index:2147483647 !important; }
#mi_temp_modal .modal-credenciais-content { max-width:980px; width:100%; border-radius:14px; padding:20px; box-shadow: 0 40px 120px rgba(0,0,0,0.45); display:grid; grid-template-columns: 1fr 320px; gap:22px; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98)); border: 1px solid rgba(0,0,0,0.06); }
#mi_temp_modal .modal-credenciais-header h2 { font-size:1.15rem; font-weight:800; margin:0; color:var(--text-color); }
#mi_temp_modal .modal-credenciais-close { background:transparent; border:none; font-size:20px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:8px; color:var(--muted-text-color); cursor:pointer }
#mi_temp_modal .modal-credenciais-close:hover { background: rgba(0,0,0,0.04); color:var(--text-color); }
#mi_temp_modal .pessoa-avatar { width:64px; height:64px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; background: linear-gradient(135deg,var(--mi-orange), #ff8f42); box-shadow: 0 8px 30px rgba(255,103,0,0.12); }
#mi_temp_modal .btn-step { padding:10px 14px; border-radius:10px; border:1px solid var(--mi-orange); background:transparent; color:var(--mi-orange); cursor:pointer; font-weight:700; box-shadow: 0 2px 6px rgba(0,0,0,0.06); transition: all 0.12s ease; }
#mi_temp_modal .btn-step:hover, #mi_temp_modal .btn-step:focus { background:var(--mi-orange); color:#fff; box-shadow: 0 8px 26px rgba(255,103,0,0.12); }
#mi_temp_modal .btn-step:active { transform: translateY(1px); background:var(--mi-orange); color:#fff }
#mi_temp_modal .detalhe-item { padding:10px 0; border-bottom:1px dashed rgba(0,0,0,0.04) }
#mi_temp_modal .detalhe-label { font-size:12px; color:var(--muted-text-color) }
#mi_temp_modal .detalhe-valor { font-weight:600; margin-top:6px }
#mi_temp_modal .modal-body { display:flex; flex-direction:column; gap:12px }
#mi_temp_modal .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:12px }

/* Lista compacta de aparelhos */
#mi_deviceList.device-list-compact {
    display: grid;
    gap: 10px;
}
/* Cartões de dispositivo na lista (compacto, minimal) */
.device-profile {
    display:flex;
    align-items:center;
    gap:14px;
    padding:12px 14px;
    border-radius:12px;
    background: var(--background-elevated, #fff);
    border:1px solid rgba(0,0,0,0.06);
    box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    transition: background-color 0.12s ease, transform 0.12s ease;
    color: var(--text-color, #111) !important;
}
.device-profile:hover { background: rgba(0,0,0,0.02); transform: translateY(-3px); cursor:pointer }
.device-profile .device-type { font-weight:700; color:var(--text-color); font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.device-sub { font-size:12px; color:var(--muted-text-color); margin-top:4px }

.device-icon { width:48px; height:48px; border-radius:10px; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg,var(--mi-orange), #ff8f42); color:#fff; box-shadow: 0 8px 22px rgba(255,103,0,0.06); flex:0 0 48px }
.device-icon svg { width:22px; height:22px; display:block; stroke: currentColor; }
.device-content { flex:1; min-width:0; display:flex; flex-direction:column; justify-content:center }
.device-name { font-weight:700; color:var(--text-color); font-size:15px }
.device-content .device-type { color: var(--text-color, #111) !important; }
.device-content .device-sub { color: var(--muted-text-color, #667) }
.device-actions { display:flex; align-items:center }
.device-actions .btn-icon { opacity:0.6; transition: opacity 0.12s ease, background 0.12s ease; display:flex; align-items:center; justify-content:center }
.device-profile:hover .device-actions .btn-icon { opacity:1 }
.btn-icon { background:transparent; border:none; font-size:18px; color:var(--muted-text-color); width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer }
.btn-icon:hover { background: rgba(0,0,0,0.06); color:var(--text-color) }
.device-badge svg { margin-right:6px; vertical-align:middle; stroke: currentColor }
.device-badge-text { color: var(--muted-text-color); margin-left:4px }
.device-badge { display:inline-flex; align-items:center; gap:6px }
.device-imei { color: var(--muted-text-color); margin-left:6px }

/* animação do overlay */
@keyframes modalFadeIn { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }
#mi_temp_modal .modal-credenciais-content { animation: modalFadeIn 220ms ease; }
@keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
.modal-credenciais-header {
    display:flex; align-items:center; gap:12px; padding-bottom:8px; margin-bottom:10px; border-bottom:1px solid var(--border-color);
}
.modal-credenciais-header h2 { font-size:1.05rem; font-weight:600; margin:0; color:var(--text-color); }
.modal-credenciais-close { background:transparent; border:none; font-size:1.15rem; color:var(--muted-text-color); width:36px; height:36px; display:flex; align-items:center; justify-content:center; }
.modal-credenciais-close:hover { color:var(--text-color); transform:none; }

.pessoas-lista {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 20px;
}

/* regra .aparelhos-lista removida */
.aparelho-card {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
}
.aparelho-card:hover { background: var(--button-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow-color); }
.aparelho-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}
.aparelho-icon svg { width:24px; height:24px; stroke: white; }
.aparelho-info { flex: 1; min-width: 0; }
.aparelho-nome { font-weight: 600; font-size: 1rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.aparelho-detalhes { font-size: 0.85rem; opacity: 0.75; }

.btn-ocultar-aparelho, .btn-reexibir-aparelho {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: 1px solid var(--border-color);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s ease;
}
.aparelho-card:hover .btn-ocultar-aparelho { opacity: 1; }
.btn-ocultar-aparelho:hover { background: var(--danger-accent); border-color: var(--danger-accent); }
.btn-ocultar-aparelho svg { width: 14px; height: 14px; stroke: var(--text-color); }
.btn-ocultar-aparelho:hover svg { stroke: white; }
.btn-reexibir-aparelho { opacity: 1; background: var(--primary-accent); border-color: var(--primary-accent); color: white; }
.btn-reexibir-aparelho:hover { transform: scale(1.05); background: var(--primary-accent-hover); }

/* Detalhes (painel) */
.aparelho-detalhes-panel { display: none; }
.aparelho-detalhes-panel.active { display: block; }

/* Estilo do header do modal mais atraente */
.modal-credenciais-header {
    background: var(--background-color);
    padding: 18px 22px;
    border-radius: 12px 12px 8px 8px;
    border: 1px solid var(--border-color);
}
.modal-credenciais-header h2 { color: var(--text-color); font-size: 1.25rem; }
.modal-credenciais-close {
    width: 44px; height: 44px; font-size: 1.5rem;
    background: transparent;
    border: 1px solid var(--border-color);
}

/* Ícone antes do título do modal */
.modal-credenciais-icon { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; flex-shrink:0; color: var(--primary-accent); margin-right: 8px; }
.modal-credenciais-header > .modal-credenciais-icon svg { width:20px; height:20px; stroke: currentColor; fill: none; }

/* Botão adicionar aparelho grande e chamativo */
.action-button {
    background: linear-gradient(90deg, var(--primary-accent), var(--primary-accent-hover));
    color: #fff; border: none; padding: 12px 14px; border-radius: 10px;
    font-weight: 700; box-shadow: 0 8px 24px rgba(37,117,252,0.18); cursor: pointer;
}
.action-button:hover { transform: translateY(-2px); }

/* Ajustes mobile */
@media (max-width: 600px) {
    .modal-credenciais-content { width: calc(100% - 24px); margin: 6% 12px; padding: 18px !important; max-height: 88vh; }
    /* regras de aparelhos removidas para esta media query */
}

/* Focar painel de detalhes com transição */
.aparelho-detalhes-panel { transition: opacity 0.2s ease; }
.pessoa-card {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
}
.pessoa-card:hover { background: var(--button-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow-color); }
.pessoa-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 600;
    flex-shrink: 0;
}
.pessoa-info { flex: 1; min-width: 0; }
.pessoa-nome { font-weight: 600; font-size: 1rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.pessoa-detalhes-count { font-size: 0.85rem; opacity: 0.7; }
.btn-ocultar-pessoa, .btn-reexibir-pessoa {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: 1px solid var(--border-color);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s ease;
}
.pessoa-card:hover .btn-ocultar-pessoa { opacity: 1; }
.btn-ocultar-pessoa:hover { background: var(--danger-accent); border-color: var(--danger-accent); }
.btn-ocultar-pessoa svg { width: 14px; height: 14px; stroke: var(--text-color); }
.btn-ocultar-pessoa:hover svg { stroke: white; }
.btn-reexibir-pessoa { opacity: 1; background: var(--primary-accent); border-color: var(--primary-accent); color: white; }
.btn-reexibir-pessoa:hover { transform: scale(1.1); background: var(--primary-accent-hover); }
.btn-reexibir-pessoa svg { width: 14px; height: 14px; stroke: white; }

.credenciais-ocultas-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
.credenciais-ocultas-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer; user-select: none; }
.credenciais-ocultas-header h3 { margin: 0; font-size: 1.1rem; opacity: 0.8; }
.credenciais-ocultas-header svg { width: 18px; height: 18px; transition: transform 0.2s ease; }
.credenciais-ocultas-header.expandido svg { transform: rotate(90deg); }
.credenciais-ocultas-lista { display: none; }
.credenciais-ocultas-lista.expandido { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
.pessoa-card-oculta { opacity: 0.6; position: relative; }

/* Forçar estilo igual ao das credenciais para aparelhos */
.aparelhos-lista { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
.aparelho-card {
    background: var(--input-bg) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--border-radius-inner) !important;
    padding: 16px !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    display: flex !important;
    align-items: center !important;
    gap: 12px !important;
    position: relative !important;
}
.aparelho-card:hover { background: var(--button-hover-bg) !important; transform: translateY(-2px) !important; box-shadow: 0 4px 12px var(--shadow-color) !important; }
.aparelho-icon {
    width: 50px !important;
    height: 50px !important;
    border-radius: 50% !important;
    background: var(--primary-accent) !important;
    color: white !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    flex-shrink: 0 !important;
}
.aparelho-icon svg { width: 22px !important; height: 22px !important; stroke: white !important; }
.aparelho-info { flex: 1; min-width: 0; }
.aparelho-nome { font-weight: 600; font-size: 1rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.aparelho-detalhes { font-size: 0.85rem; opacity: 0.7; }


.aparelho-card {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
}
.aparelho-card:hover { background: var(--button-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow-color); }
.aparelho-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.aparelho-icon svg { width: 24px; height: 24px; stroke: white; }
.aparelho-info { flex: 1; min-width: 0; }
.aparelho-nome { font-weight: 600; font-size: 1rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.aparelho-detalhes { font-size: 0.85rem; opacity: 0.7; }
.btn-ocultar-aparelho, .btn-reexibir-aparelho {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: 1px solid var(--border-color);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s ease;
}
.aparelho-card:hover .btn-ocultar-aparelho { opacity: 1; }
.btn-ocultar-aparelho:hover { background: var(--danger-accent); border-color: var(--danger-accent); }
.btn-ocultar-aparelho svg { width: 14px; height: 14px; stroke: var(--text-color); }
.btn-ocultar-aparelho:hover svg { stroke: white; }
.btn-reexibir-aparelho { opacity: 1; background: var(--primary-accent); border-color: var(--primary-accent); color: white; }
.btn-reexibir-aparelho:hover { transform: scale(1.1); background: var(--primary-accent-hover); }
.btn-reexibir-aparelho svg { width: 14px; height: 14px; stroke: white; }

/* Estilos para aparelhos ocultos/removidos */

.aparelho-detalhes-panel {
    display: none;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 20px;
    margin-top: 20px;
    animation: slideDown 0.3s ease;
}

/* Quando o painel de detalhes estiver visível, adaptamos a área do modal para duas colunas */
.modal-credenciais-content.painel-aberto {
    grid-template-columns: 1fr 420px;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}
.aparelho-card.fade-in { animation: fadeInUp 0.32s ease both; }

/* Mobile: voltar para coluna única e painel empilhado */
@media (max-width: 900px) {
    .modal-credenciais-content { grid-template-columns: 1fr; max-width: 96%; padding: 18px !important; }
    .modal-credenciais-content.painel-aberto { grid-template-columns: 1fr; }
    .aparelho-detalhes-panel { margin-top: 12px; }
}

/* ---------- Melhoria visual - Aparelhos Correlacionados ---------- */
.modal-credenciais-content {
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 20px;
    align-items: start;
}
/* padding for aparelhos list removed */
.aparelho-card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), var(--input-bg));
    border: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 6px 20px rgba(20,30,60,0.06);
    border-radius: 12px;
    padding: 14px;
    gap: 14px;
    transition: transform 0.22s cubic-bezier(.2,.9,.3,1), box-shadow 0.22s ease, background 0.22s ease;
}
.aparelho-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 14px 40px rgba(20,30,60,0.12);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), var(--button-hover-bg));
}
.aparelho-icon {
    width: 64px; height: 64px; border-radius: 12px; font-size: 1.05rem;
    display:flex; align-items:center; justify-content:center; flex-shrink:0;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    box-shadow: none;
    color: var(--text-color);
}
.aparelho-info { display:flex; flex-direction:column; gap:6px; }
.aparelho-nome { font-size:1.02rem; font-weight:700; color:var(--text-color); }
.aparelho-detalhes { font-size:0.88rem; color:var(--muted-text-color); }
.aparelho-meta { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px; }
.aparelho-badge {
    background: rgba(0,0,0,0.06); color:var(--text-color); padding:4px 8px; border-radius:999px;
    font-size:0.78rem; border:1px solid rgba(0,0,0,0.04);
}
.aparelho-ultimo { color:var(--muted-text-color); font-size:0.78rem; }
.aparelho-actions { display:flex; gap:8px; align-items:center; }
.btn-ocultar-aparelho, .btn-reexibir-aparelho { top:10px; right:10px; width:36px; height:36px; }

/* Grid de aparelhos dentro do cartão da credencial */
.pessoa-aparelhos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 12px; }

/* Estilos para aparelhos renderizados dentro da credencial */
.pessoa-devices { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
.pessoa-device { display:flex; gap:8px; align-items:center; padding:6px 8px; border-radius:10px; background: rgba(255,255,255,0.02); border:1px solid rgba(0,0,0,0.04); cursor:pointer; transition:background .15s, transform .12s; user-select:none; }
.pessoa-device:hover { background: var(--button-hover-bg); transform: translateY(-2px); }
.pessoa-device:focus { outline: none; box-shadow: 0 0 0 3px rgba(0,122,255,0.12); }
.pessoa-device-icon { width:20px; height:20px; display:flex; align-items:center; justify-content:center; color:var(--text-color); }
.pessoa-device-name { font-size:0.9rem; color:var(--text-color); font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px; }



/* Ajustes para botão principal dentro do modal */
.action-button { border-radius: 12px; padding: 12px 16px; font-size: 0.98rem; }

@media (max-width:900px) {
    .modal-credenciais-content { grid-template-columns: 1fr; }
    /* padding for aparelhos list removed */
    .aparelho-icon { width:56px; height:56px; }
}

/* Pequenas animações para entradas de card */
.aparelho-card.fade-in { transform-origin: center; }

/* fim melhorias aparelhos */

.form-group {
    margin-bottom: 16px;
}
.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--text-color);
}
.form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 1rem;
}
.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--primary-accent);
    background: var(--input-focus-bg);
}
.form-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}
.form-actions button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: var(--border-radius-inner);
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}
.form-actions button[type="button"] {
    background: var(--button-bg);
    color: var(--button-text-color);
}
.form-actions button[type="button"]:hover {
    background: var(--button-hover-bg);
}
.form-actions button[type="submit"] {
    background: var(--primary-accent);
    color: white;
}
.form-actions button[type="submit"]:hover {
    background: var(--primary-accent-hover);
}

.pessoa-detalhes-panel {
    display: none;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 20px;
    margin-top: 20px;
    animation: slideDown 0.3s ease;
}

.btn-voltar-lista {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    margin-bottom: 24px !important;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95rem;
    font-weight: 500;
}

.btn-voltar-lista svg {
    width: 18px;
    height: 18px;
    stroke: var(--text-color);
}

.btn-voltar-lista:hover {
    background: var(--button-hover-bg);
    border-color: var(--primary-accent);
    transform: translateX(-2px);
}

.pessoa-detalhes-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
.pessoa-detalhes-header .pessoa-avatar { width: 60px; height: 60px; font-size: 1.8rem; }
.pessoa-detalhes-info { flex: 1; }
.pessoa-detalhes-nome { font-size: 1.3rem; font-weight: 600; margin-bottom: 4px; }
.pessoa-detalhes-body { display: grid; gap: 12px; }
.detalhe-item { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 10px; position: relative; padding-right: 44px; }
.detalhe-icon { width: 24px; height: 24px; flex-shrink: 0; }
.detalhe-icon svg { width: 100%; height: 100%; stroke: var(--primary-accent); }
.detalhe-content { flex: 1; min-width: 0; }
.detalhe-label { font-size: 0.8rem; opacity: 0.7; margin-bottom: 2px; }
.detalhe-valor { font-weight: 600; word-break: break-word; overflow-wrap: break-word; line-height: 1.4; color: var(--text-color); }
.detalhe-valor a { color: var(--primary-accent); text-decoration: none; font-weight: 600; }
.detalhe-valor a:hover { text-decoration: underline; }

/* Botão de alternar visibilidade padronizado com cartão */
.btn-toggle-visibilidade {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    padding: 6px;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s ease;
}
.btn-toggle-visibilidade:hover { background: var(--button-hover-bg); border-color: var(--primary-accent); transform: translateY(-1px); }

/* Estilos para passos de senha */
.senha-steps { margin: 0; padding-left: 18px; }
.senha-step { margin: 6px 0; padding: 8px 10px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; }
.btn-revelar-cartao {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    padding: 4px !important;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.16s ease;
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    width: 22px !important;
    height: 22px !important;
    flex: 0 0 auto !important;
    box-sizing: border-box;
}
.btn-revelar-cartao:hover { background: var(--button-hover-bg); border-color: var(--primary-accent); transform: translateY(-1px); }
.btn-revelar-cartao svg { width: 14px; height: 14px; stroke: var(--text-color); }

.saved-item-details {
    font-size: 0.9em;
    color: var(--text-color);
    opacity: 0.8;
}


body[data-theme="light"] .liquid-btn {
    background: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.1);
}

body[data-theme="light"] .liquid-btn:hover {
    background: rgba(0, 0, 0, 0.08);
}

body[data-theme="light"] .saved-item {
    background: rgba(255, 255, 255, 0.8);
    border-color: rgba(0, 0, 0, 0.1);
}


@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.saved-item {
    animation: fadeIn 0.3s ease forwards;
}

.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--danger-accent);
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary-accent);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.correlation-warning {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(23, 42, 69, 0.4);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(173, 216, 230, 0.15);
    padding: 30px;
    border-radius: 24px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.08);
    text-align: center;
    z-index: 1001;
    max-width: 90%;
    width: 400px;
    opacity: 0;
    animation: fadeIn 0.3s ease-out forwards;
}

body[data-theme="light"] .correlation-warning {
    background: rgba(240, 245, 255, 0.85);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.5);
}

.correlation-warning.visible {
    display: block;
}

.correlation-warning::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: -1;
}

body[data-theme="light"] .correlation-warning::before {
    background: rgba(255, 255, 255, 0.3);
}

.correlation-warning h3 {
    margin: 0;
    color: var(--danger-accent);
    font-size: 1.4rem;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.correlation-warning-content {
    margin-top: 5px;
    color: var(--text-color);
}

.correlation-warning-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 25px;
}

.warning-btn {
    min-width: 120px;
    padding: 12px 24px;
    background: rgba(173, 216, 230, 0.1);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

body[data-theme="light"] .warning-btn {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: var(--text-color);
}

.warning-btn:hover {
    background: var(--button-hover-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px var(--shadow-color);
}


@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translate(-50%, -45%);
    }
    to { 
        opacity: 1; 
        transform: translate(-50%, -50%);
    }
}
</style>
</div>

<div id="autoFillForm">
    <h2 class="page-title">Editar Formulário</h2>
    <form id="formAutoFillData">
        <div class="form-grid">
            <input type="text" id="autofill-usuario" placeholder="Usuário padrão" autocomplete="off" />
            <input type="text" id="autofill-email" placeholder="E-mail padrão" autocomplete="off" />
            <input type="text" id="autofill-telefone" placeholder="Telefone padrão" autocomplete="off" inputmode="numeric" maxlength="13" />
            <input type="text" id="autofill-cpf" placeholder="CPF padrão" autocomplete="off" maxlength="14" inputmode="numeric" />
            <input type="text" id="autofill-links" placeholder="Links padrão (ex: https://)" autocomplete="off" />
            <input type="text" id="autofill-abreviacao" placeholder="Abreviação do link padrão" autocomplete="off" />
            <div class="input-container grid-span-2">
                <textarea id="autofill-notas" placeholder="Notas padrão" rows="3"></textarea>
            </div>
        </div>
        <div class="modalButtons">
            <button type="button" id="btn-autofill-form-back">Voltar</button>
            <button type="submit" id="btn-autofill-save">Salvar</button>
        </div>
    </form>
</div>



<!-- Modal cartão padrão -->
<div id="defaultCardModal" class="modal" role="dialog" aria-modal="true" style="display: none; align-items: flex-start; justify-content: center; padding: 12px; overflow-y: auto;">
    <div class="modalContent" style="display: flex; flex-direction: column; align-items: center; text-align: center; max-height: 90vh; overflow-y: auto; padding: clamp(12px, 3vw, 20px); width: min(96%, 520px);">
        <h2 style="width: 100%; text-align: center; margin-bottom: 20px; font-size: clamp(1.2rem, 4vw, 1.5rem);">Cartão padrão</h2>
        
        <div id="default-card-preview" class="card-display card-preview-default" style="margin: 14px auto;">
            <div class="card-chip-display"></div>
            <div class="card-number-display" id="preview-card-number">&bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull;</div>
            <div class="card-info-row">
                <div class="card-holder-display">
                    <div class="card-label">Titular</div>
                    <div class="card-value" id="preview-card-holder">NOME DO TITULAR</div>
                </div>
                <div class="card-expiry-display">
                    <div class="card-label">Validade</div>
                    <div class="card-value" id="preview-card-expiry">MM/AA</div>
                </div>
            </div>
        </div>
        
        <div style="width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 18px;">
            <div class="input-container">
                <input type="text" id="default-card-number" placeholder="Número do cartão" maxlength="19" inputmode="numeric" autocomplete="off" style="padding: 16px 18px; border-radius: 12px;" />
            </div>
            <div class="input-container">
                <input type="text" id="default-card-holder" placeholder="Nome do titular" autocomplete="off" style="text-transform: uppercase; padding: 16px 18px; border-radius: 12px;" />
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="input-container">
                    <input type="text" id="default-card-expiry" placeholder="Validade (MM/AA)" maxlength="5" inputmode="numeric" autocomplete="off" style="padding: 16px 18px; border-radius: 12px;" />
                </div>
                <div class="input-container">
                    <input type="text" id="default-card-cvv" placeholder="CVV" maxlength="4" inputmode="numeric" autocomplete="off" style="padding: 16px 18px; border-radius: 12px;" />
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="default-card-brand" placeholder="Bandeira (Visa, Mastercard, etc.)" autocomplete="off" style="padding: 16px 18px; border-radius: 12px;" />
            </div>
        </div>
        
        <div class="modalButtons" style="width: 100%;">
            <button type="button" id="btn-default-card-back">Voltar</button>
            <button type="button" id="btn-default-card-clear" style="background: var(--danger-accent);">Limpar</button>
            <button type="button" id="btn-default-card-save">Salvar</button>
        </div>
    </div>
</div>


<div id="searchResultsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalContent search-results-modal">
        <h2>Resultados da Busca</h2>
        <div class="search-results-container"></div>
        <div class="modalButtons">
            <button type="button" class="close-search">Fechar</button>
        </div>
    </div>
</div>

<div id="modalSenha" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloSenha">
    <div class="modalContent">
        <h2 id="modalTituloSenha">Adicionar Senha</h2>
        <button id="btn-autofill-trigger">Preencher Automaticamente</button>
        <form id="formSenha" novalidate>
            <div class="form-grid">
                <div class="input-container grid-span-2">
                    <div class="search-wrapper">
                        <input type="text" id="inputTitulo" placeholder="Serviço" required autocomplete="off" style="padding-right: 48px;"/>
                        <button type="button" id="search-service-btn" class="search-btn liquid-btn" title="Buscar serviço">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </button>
                    </div>
                    <select id="relatedServicesSelect" class="related-services-select" aria-label="Serviços relacionados" style="display:none;margin-top:8px;">
                        <option value="">Serviços nesta categoria...</option>
                    </select>
                </div>

                
                <div id="searchResultsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloSearchResults">
                    <div class="modalContent search-results-modal">
                        <h2 id="modalTituloSearchResults">Resultados da Busca</h2>
                        <div id="searchResultsContainer" class="search-results-container">
                            
                        </div>
                        <div class="modalButtons">
                            <button type="button" class="close-search-results">Fechar</button>
                        </div>
                    </div>
                </div>
                <div class="input-container">
                    <input type="text" id="inputUsuario" placeholder="Usuário" required autocomplete="off" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="input-container">
                    <input type="text" id="inputSenha" placeholder="Senha" required autocomplete="off" style="padding-right: 16px;"/>
                    <div class="password-strength" aria-hidden="false">
                        <div class="strength-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                            <div class="strength-fill" style="width:0%"></div>
                        </div>
                        <div class="strength-label" aria-live="polite">Fácil</div>
                    </div>
                </div>
                <div class="input-container">
                    <input type="text" id="inputEmail" placeholder="E-mail" autocomplete="off" />
                    <button type="button" class="btn-clear-field" id="clear-email" title="Limpar campo">×</button>
                    <button type="button" id="gmail-helper">@gmail.com</button>
                </div>
                <div class="input-container">
                    <input type="text" id="inputTelefone" placeholder="Telefone" autocomplete="off" inputmode="numeric" maxlength="13" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="input-container">
                    <input type="text" id="inputLinks" placeholder="Links (ex: https://)" autocomplete="off" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <!-- Campos personalizados (Senhas) - lista dinâmica -->
                <div class="input-container grid-span-2" id="customFieldsWrapper" style="margin-top:8px;">
                    <div id="customFieldsList">
                        <div class="custom-field-row input-container" data-index="0">
                            <select class="input-custom-type" aria-label="Tipo do campo personalizado" style="width:100%; padding:10px 12px; border-radius:12px; margin-bottom:8px;">
                                <option value="">Selecionar tipo (opcional)</option>
                                <option value="frase_seguranca">Frase de segurança</option>
                                <option value="chave_seguranca">Chave de segurança</option>
                                <option value="dica_extra">Dica extra</option>
                                <option value="senha_alfanumerica">Senha alfanumérica</option>
                                <option value="cpf_custom">CPF</option>
                                <option value="codigo_seguranca">Código de segurança</option>
                                <option value="telefone">Telefone</option>
                                <option value="email">E-mail</option>
                                <option value="nascimento">Data de nascimento</option>
                                <option value="senha_numerica">Senha numérica</option>
                                <option value="agencia">Agência</option>
                                <option value="conta">Conta</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                            <div class="input-container" style="display:flex;align-items:center;gap:8px;">
                                <input type="text" class="input-custom-value" placeholder="Valor" autocomplete="off" style="flex:0 1 220px;min-width:120px;max-width:320px;" />
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <button type="button" class="btn-clear-field" title="Limpar campo" style="height:34px;min-width:34px;">×</button>
                                    <button type="button" class="btn-remove-custom" title="Remover" style="margin-left:6px; display:none; align-items:center; justify-content:center; width:34px; height:34px; min-width:34px; border-radius:8px; background:transparent; border:0; color:inherit;">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true" focusable="false"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="btnAddCustomField" class="btn-tertiary" style="margin:8px auto 0; display:block;">Adicionar campo personalizado</button>
                </div>
                <div id="abreviacao-container" style="display: none;" class="input-container">
                    <input type="text" id="inputAbreviacao" placeholder="Abreviação do link" autocomplete="off" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="input-container grid-span-2">
                    <input type="text" id="inputCpf" placeholder="CPF" autocomplete="off" maxlength="14" inputmode="numeric" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="input-container grid-span-2">
                    <textarea id="inputNotas" placeholder="Notas adicionais" rows="3"></textarea>
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="marcador-select-container grid-span-2">
                    <select id="inputMarcador" aria-label="Selecionar marcador">
                        <option value="">Selecionar marcador (opcional)</option>
                    </select>
                </div>

                <!-- Seção de cartões -->
                <div class="grid-span-2">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" id="btnAdicionarcartão" class="btn-add-card" style="flex: 1;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Adicionar cartão
                        </button>
                        <button type="button" id="btnAdicionarcartãoPadrao" class="btn-add-card" style="flex: 1; background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); border: 1px solid #d4af37; color: #d4af37;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Cartão padrão
                        </button>
                    </div>
                    <div id="cartoesListContainer" class="cartoes-list-container"></div>
                </div>
            </div>
            <div class="modalButtons">
                <button type="button" id="btnCancelarSenha">Voltar</button>
                <button type="submit" id="btnSalvarSenha">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalAnotacao" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloAnotacao">
<div class="modalContent">
<h2 id="modalTituloAnotacao">Adicionar Anotação</h2>
<form id="formAnotacao" novalidate>
    <input type="text" id="inputTituloAnotacao" placeholder="Nome" required autocomplete="off" />
    <div class="search-wrapper">
        <input type="text" id="inputLinksAnotacao" placeholder="Site (ex: https://)" autocomplete="off" style="padding-right: 48px;" />
        <button type="button" id="search-notes-btn" class="search-btn liquid-btn" title="Buscar na web">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
        </button>
    </div>
    
    <div class="input-container">
        <textarea id="inputNotasAnotacao" placeholder="Observação" rows="5"></textarea>
        <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
    </div>
    <button type="button" id="btnMaisInfoAnotacao" class="btn-tertiary" aria-expanded="false" aria-controls="extraFieldsAnotacao">+ Mais informações</button>
    <div id="extraFieldsAnotacao" class="extra-fields" style="display:none;">
          <div class="input-container">
              <input type="text" id="inputUsuarioAnotacao" placeholder="Usuário" autocomplete="off" />
              <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
          </div>
          <div class="input-container">
              <input type="text" id="inputEmailAnotacao" placeholder="E-mail" autocomplete="off" />
              <button type="button" class="btn-clear-field" id="clear-email-anotacao" title="Limpar campo">×</button>
              <button type="button" id="gmail-helper-anotacao">@gmail.com</button>
          </div>
          <div class="input-container">
              <input type="text" id="inputTelefoneAnotacao" placeholder="Telefone" autocomplete="off" inputmode="numeric" maxlength="13" />
              <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
          </div>
          <div class="input-container">
              <input type="text" id="inputCpfAnotacao" placeholder="CPF" autocomplete="off" maxlength="14" inputmode="numeric" />
              <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
          </div>
          <div class="input-container">
              <input type="text" id="inputAbreviacaoAnotacao" placeholder="Abreviação do link" autocomplete="off" />
              <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
          </div>
      </div>
  <div class="marcador-select-container">
      <select id="inputMarcadorAnotacao" aria-label="Selecionar marcador">
          <option value="">Selecionar marcador (opcional)</option>
      </select>
  </div>
  <div class="modalButtons">
      <button type="button" id="btnCancelarAnotacao">Voltar</button>
      <button type="submit" id="btnSalvarAnotacao">Salvar</button>
  </div>
</form>
</div>
</div>

<!-- Modal: Aparelhos Conectados -->
<div id="modalDevices" class="modal" role="dialog" aria-modal="true" style="display:none;">
    <div class="modalContent" style="max-width:640px;">
        <h2>Aparelhos Conectados</h2>
        <form id="formDevice" style="width:100%; margin-top:8px;">
            <div class="form-grid">
                <div class="input-container">
                    <input type="text" id="device-name" placeholder="Nome do aparelho" required autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="password" id="device-password" placeholder="Senha (opcional)" autocomplete="off" />
                </div>
                <div class="input-container grid-span-2">
                    <textarea id="device-info" placeholder="Info (observações)" rows="2"></textarea>
                </div>
                <div class="input-container grid-span-2" style="width:100%;">
                    <label style="width:100%; font-weight:600; opacity:0.85; margin-bottom:8px; display:block;">Ícone do aparelho:</label>
                    <div class="device-icon-options" style="display:flex; gap:12px; align-items:center; justify-content:center; width:100%;">
                        <input id="icon-celular" class="device-icon-input" type="radio" name="device-icon" value="celular" checked />
                        <label for="icon-celular" class="device-icon-label" title="Celular">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="6" y="2" width="12" height="20" rx="3" ry="3"/><circle cx="12" cy="18" r="0.9"/></svg>
                        </label>

                        <input id="icon-tablet" class="device-icon-input" type="radio" name="device-icon" value="tablet" />
                        <label for="icon-tablet" class="device-icon-label" title="Tablet">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="4" y="2.5" width="16" height="19" rx="2.6" ry="2.6"/><circle cx="12" cy="18.5" r="0.9"/></svg>
                        </label>

                        <input id="icon-pc" class="device-icon-input" type="radio" name="device-icon" value="pc" />
                        <label for="icon-pc" class="device-icon-label" title="PC">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="2.5" y="4" width="19" height="12" rx="1.6" ry="1.6"/><line x1="8" y1="18.5" x2="16" y2="18.5"/><rect x="10" y="19.2" width="4" height="1" rx="0.5"/></svg>
                        </label>

                        <input id="icon-notebook" class="device-icon-input" type="radio" name="device-icon" value="notebook" />
                        <label for="icon-notebook" class="device-icon-label" title="Notebook">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3.5" y="4" width="17" height="10" rx="1.8" ry="1.8"/><path d="M3.5 14.2c1.5-0.6 3.5-1 8.5-1s6.9 0.4 8.5 1"/></svg>
                        </label>
                    </div>
                    <style>
                        .device-icon-input { position:absolute !important; opacity:0 !important; width:0 !important; height:0 !important; pointer-events:none; }
                        .device-icon-label { display:inline-flex; width:72px; height:72px; align-items:center; justify-content:center; border-radius:12px; border:1px solid var(--border-color); background:var(--input-bg); cursor:pointer; transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease; }
                        .device-icon-label svg { width:40px; height:40px; stroke:var(--text-color); }
                        .device-icon-label:hover { transform: translateY(-4px); box-shadow: 0 8px 22px rgba(0,0,0,0.22); }
                        .device-icon-input:checked + .device-icon-label { border-color: var(--primary-accent); box-shadow: 0 10px 30px rgba(0,122,255,0.16); background: linear-gradient(180deg, rgba(0,122,255,0.04), transparent); }
                        @media (max-width:480px) { .device-icon-label { width:52px; height:52px; } .device-icon-label svg { width:28px; height:28px; } }
                    </style>
                </div>
            </div>
            <div class="modalButtons">
                <button type="submit" id="btnSaveDevice">Salvar</button>
                <button type="button" id="btnCloseDevices">Fechar</button>
            </div>
        </form>
        <hr style="width:100%; margin:16px 0; opacity:0.06;" />
        <div id="devices-list-container" style="width:100%; text-align:left; max-height:none; overflow-y:visible; padding:6px 0;"></div>
    </div>
</div>

<!-- Modal: Simulador Firebase -->
<div id="modalFirebaseSimulator" class="modal" role="dialog" aria-modal="true" style="display:none;">
    <div class="modalContent">
        <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;opacity:0;pointer-events:none;">
            <defs>
                <linearGradient id="grad-storage" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#00d4ff"/><stop offset="100%" stop-color="#007aff"/></linearGradient>
                <linearGradient id="grad-reads" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#00ff9d"/><stop offset="100%" stop-color="#00d4ff"/></linearGradient>
                <linearGradient id="grad-writes" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#ffd54f"/><stop offset="100%" stop-color="#ff6b6b"/></linearGradient>
                <linearGradient id="grad-deletes" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#ff9d9d"/><stop offset="100%" stop-color="#ff6b6b"/></linearGradient>
            </defs>
        </svg>
        <h2>Simulador de Uso do Plano Firebase</h2>

        <form id="formFirebaseSimulator" style="width:100%;">


            <div id="sim-results" class="sim-chart-grid" style="margin-top:6px;">
                <div class="sim-chart-card" data-key="storage">
                    <div class="sim-progress">
                        <div id="sim-storage-bar" class="sim-progress-fill storage"></div>
                    </div>
                    <div class="sim-chart-label"><div id="sim-storage-value" class="sim-value">0 MB</div><div id="sim-storage-pct" class="sim-pct">0%</div></div>
                </div>
                <div class="sim-chart-card" data-key="reads">
                    <div class="sim-progress">
                        <div id="sim-reads-bar" class="sim-progress-fill reads"></div>
                    </div>
                    <div class="sim-chart-label"><div id="sim-reads-value" class="sim-value">0</div><div id="sim-reads-pct" class="sim-pct">0%</div></div>
                </div>
                <div class="sim-chart-card" data-key="writes">
                    <div class="sim-progress">
                        <div id="sim-writes-bar" class="sim-progress-fill writes"></div>
                    </div>
                    <div class="sim-chart-label"><div id="sim-writes-value" class="sim-value">0</div><div id="sim-writes-pct" class="sim-pct">0%</div></div>
                </div>
                <div class="sim-chart-card" data-key="deletes">
                    <div class="sim-progress">
                        <div id="sim-deletes-bar" class="sim-progress-fill deletes"></div>
                    </div>
                    <div class="sim-chart-label"><div id="sim-deletes-value" class="sim-value">0</div><div id="sim-deletes-pct" class="sim-pct">0%</div></div>
                </div>
            </div>

            <div id="sim-summary" style="margin-top:10px;color:rgba(255,255,255,0.85);"></div>

            <div class="modalButtons" style="margin-top:12px;">
                <button type="button" id="btnCloseFirebaseSimulator">Fechar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Relatório de Bugs -->
<div id="modalRelatorioBugs" class="modal" role="dialog" aria-modal="true" style="display:none;">
  <div class="modalContent" style="max-width:520px;">
    <h2>Relatório de Bugs</h2>
    <div style="margin-top:8px; display:flex; flex-direction:column; gap:10px;">
      <button id="btnInstalarRelatorio" style="width:100%;" class="login-buttons">Instalar Relatório de Bugs</button>
      <button id="btnImportarRelatorio" style="width:100%;">Importar (.dat)</button>
      <button id="btnExportarRelatorio" style="width:100%;">Exportar (.dat) → Firebase</button>
      <div id="relatorioBugsStatus" style="margin-top:8px;color:var(--text-color);opacity:0.85;font-size:0.95rem;min-height:26px;"></div>

      <!-- Box de senha personalizada (oculta por padrão) -->
      <div id="relatorioPasswordBox" style="display:none;margin-top:10px;align-items:center;gap:8px;">
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="relatorioPasswordInput" type="password" placeholder="Digite sua senha mestra" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);background:var(--input-bg);color:var(--text-color);" />
          <button id="relatorioPasswordConfirm" class="login-buttons" style="padding:8px 10px;">Confirmar</button>
          <button id="relatorioPasswordCancel" style="padding:8px 10px;">Cancelar</button>
        </div>
        <div id="relatorioPasswordMsg" style="font-size:0.9rem;color:var(--text-color);opacity:0.8;margin-top:6px;min-height:20px;"></div>
      </div>

      <!-- input de arquivo (oculto) para permitir seleção local antes do upload -->
      <input type="file" id="relatorioFileInput" accept=".dat" style="display:none;" />

    </div>
    <div class="modalButtons" style="margin-top:12px;">
      <button type="button" id="btnCloseRelatorioBugs" class="close-modal">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal: KEYMASTER PLUG-INS -->
<div id="modalPlugins" class="modal" role="dialog" aria-modal="true" style="display:none;">
  <div class="modalContent" style="max-width:520px; width: min(92%,520px);">
    <h2>KeyMaster Plug-ins</h2>
    <div style="margin-top:8px; display:flex; flex-direction:column; gap:10px;">
      <button id="btnPluginHub" style="width:100%;" class="login-buttons">Plug-in Hub</button>
      <button id="btnPluginPassword" style="width:100%;">Plug-in Password</button>
      <button id="btnPluginReport" style="width:100%;">Plug-in Report</button>
      <button id="btnPluginAuth" style="width:100%;">Plug-in Authenticator</button>
      <div id="pluginsStatus" style="margin-top:8px;color:var(--text-color);opacity:0.85;font-size:0.95rem;min-height:26px;"></div>
    </div>
    <div class="modalButtons" style="margin-top:12px;">
      <button type="button" id="btnClosePlugins" class="close-modal">Fechar</button>
    </div>
  </div>
</div>

<!-- Modal: Categorias Ocultas -->
<div id="modalHiddenCategories" class="modal" role="dialog" aria-modal="true" style="display:none;">
  <div class="modalContent saved-items-modal" style="max-width:760px;">
    <h2 id="modalTituloHidden">Categorias ocultas (duplicadas)</h2>
    <div style="display:flex; gap:14px; flex-wrap:wrap; margin-top:8px;">
      <div style="flex:1 1 320px; min-width:260px;">
        <strong>Senhas</strong>
        <div id="modal-hidden-senha-list" style="margin-top:8px; min-height:40px;" class="hidden-list"></div>
      </div>
      <div style="flex:1 1 320px; min-width:260px;">
        <strong>Anotações</strong>
        <div id="modal-hidden-anotacao-list" style="margin-top:8px; min-height:40px;" class="hidden-list"></div>
      </div>
    </div>
    <div class="modalButtons" style="margin-top: 14px;">
      <button id="btnCloseHiddenCategories" class="close-modal">Fechar</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="message-box" id="message-box"></div>
<div class="message-box mobile-friendly" id="modalObservacoes">
    <header class="modal-header">
        <h2>OBSERVAÇÕES</h2>
        <p>Este sistema salva todas as informações apenas no navegador e armazena as senhas e anotações de forma criptografada.</p>
    </header>
    
    <div class="modal-body">
        <textarea id="observacoes-textarea" placeholder="Digite suas observações aqui..." rows="5"></textarea>
    </div>
    
    <footer class="modal-footer">
        <div class="action-buttons">
            <button id="btnSalvarObservacoes" class="btn-secondary" aria-label="Salvar observações">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                <span class="btn-label">Salvar</span>
            </button>
            <button id="btnRedefinirTempo" class="btn-secondary" title="Redefinir timer" aria-label="Redefinir timer de atualização">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                    <circle cx="12" cy="12" r="9"></circle>
                    <path d="M12 7v5l3 2"></path>
                </svg>
                <span class="btn-label">Time</span>
            </button>
            <button id="btnUpdates" class="btn-secondary" aria-label="Abrir melhorias e updates">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 2v6h-6"/>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                    <path d="M3 22v-6h6"/>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                </svg>
                <span class="btn-label">Updates</span>
            </button>
        </div>
        <button type="button" id="btnVoltarObservacoes" class="btn-secondary">Voltar</button>
    </footer>
</div>

<style>

.message-box.mobile-friendly {
    max-width: 600px;
    padding: 32px;
}

.message-box.mobile-friendly .modal-header {
    text-align: center;
    margin-bottom: 24px;
}

.message-box.mobile-friendly .modal-header h2 {
    font-size: 1.5rem;
    margin-bottom: 12px;
}

.message-box.mobile-friendly .modal-header p {
    color: var(--text-color);
    opacity: 0.8;
    line-height: 1.5;
    font-size: 0.95rem;
}

.message-box.mobile-friendly .modal-body textarea {
    width: 100%;
    margin-bottom: 24px;
    resize: vertical;
    min-height: 120px;
    font-size: 0.95rem;
    line-height: 1.5;
}

.message-box.mobile-friendly .action-buttons {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: nowrap;
    overflow-x: auto; /* garante que nunca quebre linha; permite scroll se necessário */
    -webkit-overflow-scrolling: touch;
    width: 100%; /* ocupar toda a largura disponível do footer no desktop */
}

.message-box.mobile-friendly .btn-primary,
.message-box.mobile-friendly .btn-secondary {
    width: 100%;
    height: 44px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.95rem;
}

/* Tornar o trio Salvar/Time/Updates compacto e lado a lado (desktop) */
.message-box.mobile-friendly .action-buttons > button {
    width: auto;
    min-width: 64px; /* grande em telas grandes */
    height: 64px;
    padding: 0 14px;
    flex: 1 1 0; /* cada botão expande igualmente para ocupar todo espaço */
    min-width: 0; /* permite contrair sem quebrar o layout */
}
.message-box.mobile-friendly .action-buttons > button svg {
    width: 20px; /* ícone maior no desktop */
    height: 20px;
}
.message-box.mobile-friendly .action-buttons > button .btn-label {
    font-size: 1rem; /* rótulo legível no desktop */
}


button {
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 0 16px;
}

button svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}


button.btn-circle,
.fab-button {
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
    min-width: auto;
}


.fab-main {
    width: 56px !important;
    height: 56px !important;
}

.fab-main svg {
    width: 24px;
    height: 24px;
}


.card-buttons button {
    height: 36px;
    padding: 0 12px;
    flex: 0 0 auto !important; /* evitar que o botão encolha ou quebre para a linha abaixo */
    white-space: nowrap !important;
}

.card-buttons .visualizar-icone {
    width: 36px;
    padding: 0;
}

.card-buttons .visualizar-icone svg {
    width: 18px;
    height: 18px;
}

.message-box.mobile-friendly .btn-secondary {
    background: var(--button-bg);
    border: 1px solid var(--border-color);
}


@media (max-width: 480px) {
    .message-box.mobile-friendly {
        margin: 16px;
        max-width: calc(100% - 32px);
        padding: 20px;
    }

    .message-box.mobile-friendly .modal-header h2 {
        font-size: 1.3rem;
    }

    .message-box.mobile-friendly .modal-header p {
        font-size: 0.9rem;
    }

    /* Em celular: três botões sempre lado a lado, cabendo na tela sem arrastar */
    .message-box.mobile-friendly .action-buttons {
        justify-content: center;
        flex-wrap: nowrap;
        gap: 8px; /* reduzir gap para caber melhor */
        overflow-x: hidden; /* sem rolagem horizontal */
        width: 100%;
    }
    .message-box.mobile-friendly .action-buttons > button {
        height: 40px;
        padding: 0 8px;
        min-width: 0; /* permite encolher */
        white-space: nowrap;
        flex: 1 1 0; /* dividir igualmente a largura disponível */
    }
    .message-box.mobile-friendly .action-buttons > button .btn-label {
        display: inline;
        font-size: 0.85rem;
        overflow: hidden;
        text-overflow: ellipsis; /* se faltar espaço, corta com reticências */
    }
    .message-box.mobile-friendly .action-buttons > button svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
    }

    .message-box.mobile-friendly .modal-body textarea {
        min-height: 100px;
    }

    .message-box.mobile-friendly .btn-primary,
    .message-box.mobile-friendly .btn-secondary {
        padding: 10px;
        font-size: 0.9rem;
    }

    /* Esconder a marca ao lado do título 'Arquivos' em telas pequenas */
    .top-bar .site-brand .brand-text { display: none !important; }

    /* Ajustes para a caixa de correlação no celular: empilhar botões e reduzir tamanho */
    .correlation-warning-buttons { flex-direction: column; gap: 10px; align-items: stretch; }
    .correlation-warning .warning-btn { min-width: auto; width: 100%; padding: 10px 12px; font-size: 0.95rem; }

    /* garantir rolagem nativa por toque em modais menores */
    .modalContent { -webkit-overflow-scrolling: touch; touch-action: pan-y; }

    /* Estilos específicos para o prompt 'Reaplicar criptografia' em telas pequenas */
    .message-box.prompt-reaplicar .modal-body { display:flex; flex-direction:column; gap:12px; align-items:stretch; }
    .message-box.prompt-reaplicar #promptSenhaInput { padding: 14px; font-size: 1rem; border-radius: 10px; }
    .message-box.prompt-reaplicar button#btnOkPrompt,
    .message-box.prompt-reaplicar button#btnCancelarPrompt { width: 100% !important; padding: 12px !important; margin: 0 !important; display: block !important; }
    .message-box.prompt-reaplicar div[style*="display:flex;justify-content:center"] { flex-direction: column; gap: 10px; }
}
</style>
</div>

<!-- Modal de Gerenciamento de Marcadores -->
<div id="modalMarcadores" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloMarcadores">
    <div class="modalContent">
        <h2 id="modalTituloMarcadores">Gerenciar Marcadores</h2>
        
        <!-- Formulário para adicionar/editar marcador -->
        <div class="marcador-form">
            <div class="marcador-form-row">
                <input type="text" id="marcador-nome-input" placeholder="Nome do marcador" maxlength="20" autocomplete="off" />
                <input type="color" id="marcador-cor-input" value="#007aff" title="Escolher cor" />
            </div>
            <div class="marcador-importante-container">
                <label class="marcador-importante-label">
                    <input type="checkbox" id="marcador-importante-input" />
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" style="vertical-align: middle;">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        Marcar como importante
                    </span>
                </label>
            </div>
            <div class="color-presets">
                <div class="color-preset" style="background: #007aff;" data-color="#007aff" title="Azul"></div>
                <div class="color-preset" style="background: #34C759;" data-color="#34C759" title="Verde"></div>
                <div class="color-preset" style="background: #FF3B30;" data-color="#FF3B30" title="Vermelho"></div>
                <div class="color-preset" style="background: #FF9500;" data-color="#FF9500" title="Laranja"></div>
                <div class="color-preset" style="background: #AF52DE;" data-color="#AF52DE" title="Roxo"></div>
                <div class="color-preset" style="background: #FF2D55;" data-color="#FF2D55" title="Rosa"></div>
                <div class="color-preset" style="background: #5AC8FA;" data-color="#5AC8FA" title="Azul claro"></div>
                <div class="color-preset" style="background: #FFCC00;" data-color="#FFCC00" title="Amarelo"></div>
            </div>
            <button type="button" id="btn-adicionar-marcador" style="width: 100%; padding: 12px; margin-top: 10px;">
                Adicionar Marcador
            </button>
        </div>
        
        <!-- Lista de marcadores existentes -->
        <div class="marcadores-list" id="marcadores-list">
            <!-- Marcadores serão inseridos dinamicamente aqui -->
        </div>
        
        <div class="modalButtons">
            <button type="button" id="btnFecharMarcadores">Fechar</button>
        </div>
    </div>
</div>

<div id="modalDesenvolvimento" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloDesenvolvimento">
<div class="modalContent mobile-friendly">
    <header class="modal-header">
        <h2 id="modalTituloDesenvolvimento">DESENVOLVIMENTO</h2>
        <p></p>
    </header>
    
    <div class="modal-body">
        <div class="changelog" style="display: none;"></div>
        <div class="action-grid">
            <button id="btnAtivarUpdate" class="action-button btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 12a11 11 0 0 0-22 0m22 0a11 11 0 0 1-22 0M12 1v6m0 16v-6"/>
                </svg>
                <span>Ativar Update</span>
            </button>
            <button id="btnDesativarUpdate" class="action-button btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 12h8"/>
                </svg>
                <span>Desativar Update</span>
            </button>
        </div>
        <button type="button" id="btnApagarDados" class="btn-danger">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
            Apagar dados
        </button>
    </div>
</div>
</div>

<style>

#modalDesenvolvimento .action-grid {
    display: flex;
    justify-content: center;
    gap: 12px;
    width: 100%;
    margin: 0 auto;
    flex-wrap: wrap;
}
#modalDesenvolvimento .action-grid .action-button {
    flex: 0 0 64px;
    max-width: 64px;
    min-width: 64px;
}
@media (max-width: 480px) {
    #modalDesenvolvimento .action-grid {
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }
    #modalDesenvolvimento .action-grid .action-button {
        flex: 1 1 100%;
        max-width: none;
        width: 100%;
        height: 56px;
        aspect-ratio: auto;
    }
}

#modalDesenvolvimento .action-button {
    aspect-ratio: 1;
    width: 64px;
    height: 64px;
    border-radius: var(--border-radius-inner);
    padding: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-align: center;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
}

#modalDesenvolvimento .action-button svg {
    width: 22px;
    height: 22px;
    margin-bottom: 2px;
}

/* Centralizar botões Ativar/Desativar e definir largura fixa para melhor alinhamento */
#modalDesenvolvimento .main-actions {
    justify-content: center;
    align-items: center;
}

#modalDesenvolvimento .main-actions button#btnAtivarUpdate,
#modalDesenvolvimento .main-actions button#btnDesativarUpdate {
    flex: 0 0 180px;
    max-width: 220px;
}

@media (max-width: 480px) {
    #modalDesenvolvimento .main-actions button#btnAtivarUpdate,
    #modalDesenvolvimento .main-actions button#btnDesativarUpdate {
        flex: 1 1 0;
        min-width: 0;
    }
}

#modalDesenvolvimento .action-button span {
    font-size: 0.8rem;
    line-height: 1.2;
    max-width: 100%;
    padding: 0 4px;
}

#modalDesenvolvimento .action-button:hover {
    background: var(--button-hover-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-color);
}

#modalDesenvolvimento .action-button.btn-primary {
    background: var(--primary-accent);
    color: white;
    border: none;
}

#modalDesenvolvimento .action-button.btn-primary:hover {
    background: var(--primary-accent-hover);
}

#modalDesenvolvimento .btn-danger {
    background-color: var(--danger-accent);
    color: white;
    width: 100%;
    margin-top: 16px;
    border: none;
    padding: 12px;
    height: auto;
    font-size: 0.95rem;
}

#modalDesenvolvimento .btn-danger:hover {
    background-color: #c0392b;
}


@media (max-width: 480px) {
    #modalDesenvolvimento .modalContent {
        margin: 16px auto;
        max-width: 360px; 
        width: calc(100% - 32px);
        padding: 16px;
        border-radius: calc(var(--border-radius-main) - 8px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    }

    #modalDesenvolvimento .modal-header {
        text-align: center;
        margin-bottom: 16px;
    }

    #modalDesenvolvimento .modal-header h2 {
        font-size: 1.3rem;
        margin-bottom: 8px;
    }

    #modalDesenvolvimento .modal-header p {
        font-size: 0.9rem;
        line-height: 1.4;
        opacity: 0.8;
    }

    #modalDesenvolvimento .changelog {
        padding: 12px;
        font-size: 0.9rem;
        max-height: 160px;
    }

    #modalDesenvolvimento .action-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }

    #modalDesenvolvimento .action-button svg {
        width: 20px;
        height: 20px;
    }

    #modalDesenvolvimento .action-button span {
        font-size: 0.8rem;
    }

    #modalDesenvolvimento .btn-danger {
        margin-top: 12px;
        font-size: 0.9rem;
    }
}

/* Seção de cartões no formulário de senhas */
.btn-add-card {
    width: 100%;
    padding: 12px 16px;
    margin: 16px 0 8px 0;
    background: var(--input-bg);
    border: 1px dashed var(--border-color);
    border-radius: var(--border-radius-inner);
    color: var(--text-color);
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-add-card:hover {
    background: var(--button-hover-bg);
    border-color: var(--primary-accent);
}

.btn-add-card svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
}

.cartoes-list-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 12px;
}

.card-item-wrapper {
    padding: 20px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-fields-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}

.card-fields-header h3 {
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
}

.card-fields-header svg {
    width: 20px;
    height: 20px;
    stroke: var(--primary-accent);
}

.btn-remove-card {
    background: transparent;
    border: none;
    color: var(--danger-accent);
    font-size: 1.1rem;
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.btn-remove-card:hover {
    background: rgba(255, 59, 48, 0.1);
    transform: scale(1.05);
}

.card-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px 16px;
}

.card-form-grid .full-width {
    grid-column: span 2;
}

.card-input-group {
    position: relative;
}

.card-input-group label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 10px;
    opacity: 0.9;
}

.card-input-group input {
    width: 100%;
    padding: 16px 18px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    font-size: 0.95rem;
    background: var(--background-color);
    color: var(--text-color);
    transition: all 0.3s ease;
}

.card-input-group input:focus {
    outline: none;
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
    background: var(--input-focus-bg);
}

.card-input-group input::placeholder {
    color: var(--input-placeholder-color);
}

.card-icon-visual {
    width: 100%;
    height: 120px;
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    position: relative;
    box-shadow: 0 8px 32px 0 var(--shadow-color);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.card-icon-visual::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(173, 216, 230, 0.05) 0%, transparent 70%);
    border-radius: 50%;
}

.card-icon-visual::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.1), transparent);
    pointer-events: none;
}

.card-icon-visual .card-chip {
    width: 45px;
    height: 32px;
    background: linear-gradient(135deg, rgba(173, 216, 230, 0.5), rgba(173, 216, 230, 0.7), rgba(173, 216, 230, 0.5));
    border-radius: 6px;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(173, 216, 230, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.card-icon-visual .card-number-preview {
    font-size: 1.1rem;
    color: var(--text-color);
    font-weight: 600;
    letter-spacing: 2px;
    margin-top: 6px;
    position: relative;
    z-index: 1;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Ajustes para tema claro: cartão pré-visualização mais claro e arejado */
body[data-theme="light"] .card-icon-visual {
    background: #f8fafc;
    border: 1px solid rgba(15, 23, 42, 0.08);
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
}
body[data-theme="light"] .card-icon-visual::before {
    background: radial-gradient(circle, rgba(59, 130, 246, 0.10) 0%, transparent 70%);
}
body[data-theme="light"] .card-icon-visual::after {
    background: linear-gradient(to top, rgba(15, 23, 42, 0.08), transparent);
}
body[data-theme="light"] .card-icon-visual .card-chip {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.42), rgba(59, 130, 246, 0.62), rgba(59, 130, 246, 0.42));
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.5);
}
body[data-theme="light"] .card-icon-visual .card-number-preview {
    color: #0f172a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.55);
}
body[data-theme="light"] .card-icon-visual .card-holder-preview {
    color: #1d4ed8;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.6);
}

.card-icon-visual .card-holder-preview {
    font-size: 0.85rem;
    color: rgba(173, 216, 230, 0.8);
    text-transform: uppercase;
    margin-top: 4px;
    position: relative;
    z-index: 1;
    font-weight: 600;
    letter-spacing: 1px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Ajustes para mobile - cartões menores e mais compactos */
@media (max-width: 768px) {
    .card-icon-visual {
        height: 90px !important;
        padding: 10px 12px !important;
        margin-bottom: 12px !important;
        border-radius: 10px !important;
    }
    
    .card-icon-visual .card-chip {
        width: 30px !important;
        height: 22px !important;
        border-radius: 4px !important;
        margin-bottom: 6px !important;
    }
    
    .card-icon-visual .card-number-preview {
        font-size: 0.75rem !important;
        letter-spacing: 1.2px !important;
        margin-top: 3px !important;
        line-height: 1.2 !important;
    }
    
    .card-icon-visual .card-holder-preview {
        font-size: 0.65rem !important;
        letter-spacing: 0.6px !important;
        margin-top: 2px !important;
        line-height: 1.2 !important;
    }
    
    .card-item-wrapper {
        margin-bottom: 16px;
    }
    
    .card-fields-header h3 {
        font-size: 0.95rem;
    }
    
    .card-form-grid {
        gap: 12px;
    }
    
    .card-input-group label {
        font-size: 0.85rem;
    }
    
    .card-input-group input {
        padding: 10px 12px;
        font-size: 0.9rem;
    }
    
    .card-display {
        max-width: 100% !important;
        padding: 14px 16px !important;
        margin: 10px auto;
        border-radius: 12px !important;
    }
    
    .card-display .card-chip {
        width: 30px !important;
        height: 22px !important;
    }
    
    .card-display .card-number-preview {
        font-size: 0.75rem !important;
        letter-spacing: 1.2px !important;
    }
    
    .card-display .card-holder-preview {
        font-size: 0.65rem !important;
        letter-spacing: 0.6px !important;
    }
    
    /* Cartão padrão no modal */
    #default-card-preview {
        max-width: 100% !important;
        padding: 12px 14px !important;
        margin: 12px auto 16px !important;
        border-radius: 12px !important;
    }
    
    #default-card-preview .card-chip-display {
        width: 28px !important;
        height: 20px !important;
        margin-bottom: 8px !important;
    }
    
    #default-card-preview .card-number-display {
        font-size: 0.7rem !important;
        letter-spacing: 1px !important;
        margin-bottom: 10px !important;
        word-spacing: 3px !important;
    }
    
    #default-card-preview .card-info-row {
        gap: 6px !important;
    }
    
    #default-card-preview .card-label {
        font-size: 0.5rem !important;
        letter-spacing: 0.6px !important;
        margin-bottom: 1px !important;
    }
    
    #default-card-preview .card-value {
        font-size: 0.65rem !important;
    }
    
    #defaultCardModal .modalContent {
        padding: 16px !important;
        max-height: 95vh !important;
    }
}

/* Cartão padrão - visualização compacta */
.card-display {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%) !important;
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border: 1px solid rgba(255, 255, 255, 0.10) !important;
    border-radius: 18px !important;
    padding: 22px 24px !important;
    margin: 14px auto;
    max-width: none !important;
    width: 100% !important;
    color: var(--text-color);
    box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35), 0 4px 12px rgba(0, 0, 0, 0.20) !important;
    position: relative;
    overflow: hidden;
    isolation: isolate;
}

#default-card-preview {
    max-width: 100% !important;
    width: 100% !important;
}

.card-preview-default {
    position: relative;
    background: linear-gradient(160deg, #1d1f24 0%, #22262e 60%, #1c1f26 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    border-radius: 16px !important;
    padding: 18px 18px 16px 18px !important;
    box-shadow: 0 14px 30px rgba(0, 0, 0, 0.38), inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
    overflow: visible;
    isolation: isolate;
    width: 100% !important;
    max-width: 360px;
    max-height: none !important;
    height: auto !important;
}

.card-preview-default::before,
.card-preview-default::after {
    content: '';
    position: absolute;
    pointer-events: none;
    border-radius: 50%;
    filter: blur(12px);
    opacity: 0.9;
    z-index: 0;
}

.card-preview-default::before {
    width: 180px;
    height: 180px;
    top: -80px;
    left: -40px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 65%);
}

.card-preview-default::after {
    width: 160px;
    height: 160px;
    bottom: -70px;
    right: -24px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.06) 0%, transparent 62%);
}

.card-preview-default .card-chip-display {
    width: 44px;
    height: 30px;
    background: linear-gradient(135deg, #d9d9d9 0%, #bfbfbf 60%, #9e9e9e 100%);
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.35), 0 5px 12px rgba(0, 0, 0, 0.26);
    position: relative;
    z-index: 1;
}

.card-preview-default .card-chip-display::after {
    content: '';
    position: absolute;
    inset: 4px;
    border-radius: 4px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.24), rgba(0, 0, 0, 0.12));
}

.card-preview-default .card-number-display {
    font-size: 1.05rem;
    font-weight: 750;
    letter-spacing: 2px;
    word-spacing: 7px;
    color: #f5f7fa;
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
    font-family: 'SF Mono', 'Consolas', 'Roboto Mono', monospace;
    margin-bottom: 12px;
    z-index: 1;
}

.card-preview-default .card-info-row {
    display: grid;
    grid-template-columns: 1.25fr 0.75fr;
    gap: 10px;
    align-items: end;
    z-index: 1;
}

.card-preview-default .card-label {
    font-size: 0.64rem;
    letter-spacing: 1.05px;
    color: rgba(220, 224, 232, 0.72);
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 2px;
}

.card-preview-default .card-value {
    font-size: 0.9rem;
    font-weight: 760;
    text-transform: uppercase;
    color: #e6e8ed;
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
}

body[data-theme="light"] .card-preview-default {
    background: linear-gradient(160deg, #f6f7fb 0%, #eceff4 60%, #f7f8fb 100%) !important;
    border: 1px solid rgba(120, 140, 165, 0.22) !important;
    box-shadow: 0 14px 30px rgba(120, 140, 165, 0.18), 0 2px 10px rgba(120, 140, 165, 0.1) !important;
}

body[data-theme="light"] .card-preview-default::before {
    background: radial-gradient(circle, rgba(160, 175, 200, 0.18) 0%, transparent 60%);
}

body[data-theme="light"] .card-preview-default::after {
    background: radial-gradient(circle, rgba(140, 170, 210, 0.18) 0%, transparent 62%);
}

body[data-theme="light"] .card-preview-default .card-number-display {
    color: #0f172a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}

body[data-theme="light"] .card-preview-default .card-value {
    color: #0f172a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.75);
}

@media (max-width: 520px) {
    .card-preview-default {
        padding: 16px 16px 14px 16px !important;
        border-radius: 16px !important;
        max-width: 100%;
    }
    .card-preview-default .card-chip-display {
        width: 40px;
        height: 28px;
        margin-bottom: 10px;
    }
    .card-preview-default .card-number-display {
        font-size: 1rem;
        letter-spacing: 1.8px;
        word-spacing: 6px;
        margin-bottom: 12px;
    }
    .card-preview-default .card-info-row {
        grid-template-columns: 1fr 0.9fr;
        gap: 8px;
    }
    .card-preview-default .card-label {
        font-size: 0.6rem;
        letter-spacing: 1px;
    }
    .card-preview-default .card-value {
        font-size: 0.9rem;
    }
}

.card-display::before {
    content: '';
    position: absolute;
    top: -40%;
    left: -20%;
    width: 250px;
    height: 250px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(96, 165, 250, 0.18) 0%, transparent 70%);
    opacity: 1;
    z-index: -1;
}

.card-display::after {
    content: '';
    position: absolute;
    bottom: -35%;
    right: -15%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.12) 0%, transparent 65%);
    z-index: -1;
}

.card-display .card-chip-display {
    width: 42px;
    height: 32px;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
    border-radius: 6px;
    margin-bottom: 14px;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.4), 0 4px 14px rgba(0, 0, 0, 0.35);
    position: relative;
}

.card-display .card-chip-display::after {
    content: '';
    position: absolute;
    inset: 3px;
    border-radius: 3px;
    background: linear-gradient(135deg, transparent, rgba(0, 0, 0, 0.15));
}

.card-display .card-number-display {
    font-size: 1.15rem;
    font-weight: 700;
    letter-spacing: 2.5px;
    margin-bottom: 16px;
    word-spacing: 8px;
    color: #ffffff;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.45);
    font-family: 'SF Mono', 'Consolas', 'Roboto Mono', monospace;
}

.card-display .card-info-row {
    display: grid;
    grid-template-columns: 1.3fr 0.7fr;
    gap: 10px;
    align-items: end;
}

.card-display .card-holder-display,
.card-display .card-expiry-display {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.card-display .card-label {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.65);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-weight: 600;
    margin-bottom: 2px;
}

.card-display .card-value {
    font-size: 0.95rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #ffffff;
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.40);
}

body[data-theme="light"] .card-display .card-label {
    color: rgba(30, 58, 138, 0.70);
}

body[data-theme="light"] .card-display .card-value {
    color: #1e3a8a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}

@media (max-width: 480px) {
    .card-form-grid {
        grid-template-columns: 1fr;
    }

    .card-form-grid .full-width {
        grid-column: span 1;
    }

    .card-display {
        padding: 18px;
        width: 100%;
    }

    .card-display .card-number-display {
        font-size: 1.05rem;
        letter-spacing: 1.6px;
    }
}
</style>

<!-- CryptoJS: adicionada via CDN para restaurar funções de criptografia usadas pelo app -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" crossorigin="anonymous"></script>
<script>
/* jsPDF 2.5.1 UMD - inlined */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).jspdf={})}(this,(function(t){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var r=function(){return"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this}();function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)};/* (jspdf minified content inserted) */
}));
</script>
<script>

// // Silencia logs para reduzir ruído e custo de console
// try {
//     ['log','info','debug','trace'].forEach(fn => { try { console[fn] = function noop() {}; } catch(_){}});
// } catch(_){ }

const SAL = "s3uS4lUn1c0D0S1st3m4";

let senhaDigitada = null;
let boards = [];
let boardsOriginal = [];
let anotacoesBoards = [];
let anotacoesBoardsOriginal = [];
let autoFillData = {};
let editandoBoardId = null;
let editandoCardId = null;
let openBoardIds = new Set(); 
let senhasCarregadas = false;
let anotacoesCarregadas = false;
let marcadores = [];
let editandoMarcadorId = null;

// IDs de categorias ocultas (duplicatas)
let hiddenBoardIds = new Set(JSON.parse(localStorage.getItem('hiddenBoardIds') || '[]'));
function saveHiddenBoardIds(){ try{ localStorage.setItem('hiddenBoardIds', JSON.stringify(Array.from(hiddenBoardIds))); }catch(e){ console.warn('saveHiddenBoardIds failed', e); } }

function detectAndHideDuplicateBoards(mode){
    const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
    // Remove ids não existentes
    const existingIds = new Set(currentBoards.map(b=>b.id));
    for(const id of Array.from(hiddenBoardIds)) if(!existingIds.has(id)) hiddenBoardIds.delete(id);
    const seen = new Map();
    for(const b of currentBoards){
        const n = (b.nome||'').trim().toLowerCase();
        if(!seen.has(n)){
            // if this first encountered is already hidden, mark as null to find next visible one
            seen.set(n, hiddenBoardIds.has(b.id) ? null : b.id);
        } else {
            // already have an entry: hide this one
            hiddenBoardIds.add(b.id);
        }
    }
    // For names where value is null (all earlier were hidden), find a non-hidden if possible
    for(const [name,val] of seen.entries()){
        if(val === null){
            const candidate = currentBoards.find(b=> (b.nome||'').trim().toLowerCase()===name && !hiddenBoardIds.has(b.id));
            if(candidate) seen.set(name,candidate.id);
            else {
                // all are hidden - ensure at least the first is visible and others hidden
                const first = currentBoards.find(b=> (b.nome||'').trim().toLowerCase()===name);
                if(first) hiddenBoardIds.delete(first.id);
                // hide the rest
                currentBoards.filter(b=> (b.nome||'').trim().toLowerCase()===name && b.id!== (first?first.id:null)).forEach(b=> hiddenBoardIds.add(b.id));
            }
        }
    }
    saveHiddenBoardIds();
    updateHiddenCategoriesBox();
}

function updateHiddenCategoriesBox(){
    const box = document.getElementById('hiddenCategoriesBox');
    if(!box) return;
    const senhaList = document.getElementById('hidden-senha-list');
    const anotList = document.getElementById('hidden-anotacao-list');
    const modalSenhaList = document.getElementById('modal-hidden-senha-list');
    const modalAnotList = document.getElementById('modal-hidden-anotacao-list');
    senhaList.innerHTML = '';
    anotList.innerHTML = '';
    if (modalSenhaList) modalSenhaList.innerHTML = '';
    if (modalAnotList) modalAnotList.innerHTML = '';
    const hiddenSenha = boards.filter(b=> hiddenBoardIds.has(b.id));
    const hiddenAnot = anotacoesBoards.filter(b=> hiddenBoardIds.has(b.id));
    if(hiddenSenha.length===0) {
        senhaList.innerHTML = '<div class="muted">Nenhuma categoria oculta</div>';
        if (modalSenhaList) modalSenhaList.innerHTML = '<div class="muted">Nenhuma categoria oculta</div>';
    } else hiddenSenha.forEach(b=>{
        const row = document.createElement('div'); row.className='hidden-item';
        row.innerHTML = `<span class="name">${escapeHtml(b.nome)}</span><div class="actions"><button class="restore" data-id="${b.id}" data-mode="senha">Restaurar</button><button class="delete" data-id="${b.id}" data-mode="senha">Excluir</button></div>`;
        senhaList.appendChild(row);
        if (modalSenhaList) {
            const mRow = row.cloneNode(true);
            modalSenhaList.appendChild(mRow);
        }
    });
    if(hiddenAnot.length===0) {
        anotList.innerHTML = '<div class="muted">Nenhuma categoria oculta</div>';
        if (modalAnotList) modalAnotList.innerHTML = '<div class="muted">Nenhuma categoria oculta</div>';
    }
    else hiddenAnot.forEach(b=>{
        const row = document.createElement('div'); row.className='hidden-item';
        row.innerHTML = `<span class="name">${escapeHtml(b.nome)}</span><div class="actions"><button class="restore" data-id="${b.id}" data-mode="anotacao">Restaurar</button><button class="delete" data-id="${b.id}" data-mode="anotacao">Excluir</button></div>`;
        anotList.appendChild(row);
        if (modalAnotList) {
            const mRow = row.cloneNode(true);
            modalAnotList.appendChild(mRow);
        }
    });
}

// Delegated handlers for restore/delete inside Hidden box
document.addEventListener('click', async function(e){
    const t = e.target;
    if(t.matches('.restore')){
        const id = Number(t.dataset.id); const mode = t.dataset.mode;
        hiddenBoardIds.delete(id); saveHiddenBoardIds(); mostrarBoards(mode);
        mostrarMensagem('Sucesso', 'Categoria restaurada.');
    }
    if(t.matches('.delete')){
        const id = Number(t.dataset.id); const mode = t.dataset.mode;
        if(await mostrarConfirmacao('Confirmar Exclusão','Deseja excluir a categoria oculta?')){
            if(mode==='senha'){
                boards = boards.filter(b=> b.id!==id); boardsOriginal = boardsOriginal.filter(b=> b.id!==id);
            } else {
                anotacoesBoards = anotacoesBoards.filter(b=> b.id!==id); anotacoesBoardsOriginal = anotacoesBoardsOriginal.filter(b=> b.id!==id);
            }
            hiddenBoardIds.delete(id); saveHiddenBoardIds(); salvarBoards(mode); mostrarBoards(mode); mostrarMensagem('Sucesso', 'Categoria excluída.');
        }
    }
});

const loginDiv = document.getElementById("login");
const appDiv = document.getElementById("app");
const certificadoDiv = document.getElementById("certificado");
const anotacoesLoginDiv = document.getElementById("anotacoesLogin");
const anotacoesAppDiv = document.getElementById("anotacoesApp");
const autoFillSettingsDiv = document.getElementById("autoFillSettings");
const autoFillFormDiv = document.getElementById("autoFillForm");
const acessoEspecialDiv = document.getElementById("acessoEspecial");
const recuperarPinDiv = document.getElementById("recuperarPin");
const forgotPinLink = document.getElementById("forgot-pin-link");
const btnVerificarSenhaEspecial = document.getElementById("btnVerificarSenhaEspecial");
const btnVoltarAcessoEspecial = document.getElementById("btnVoltarAcessoEspecial");
const btnPinRecuperadoConcluido = document.getElementById("btnPinRecuperadoConcluido");
const modalSenhaDiv = document.getElementById("modalSenha");
// Observar mudanças no modal e forçar scroll para topo quando for exibido,
// garantindo comportamento consistente independentemente de quem abre o modal.
if (modalSenhaDiv) {
    const ensureTop = () => {
        try {
            const modalContentEl = modalSenhaDiv ? modalSenhaDiv.querySelector('.modalContent') : null;
            if (modalContentEl && typeof modalContentEl.scrollTo === 'function') {
                modalContentEl.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        } catch(_) { try { window.scrollTo(0,0); } catch(_){} }
    };
    try {
        const mo = new MutationObserver((mutations) => {
            try {
                const disp = window.getComputedStyle(modalSenhaDiv).display;
                if (disp && disp !== 'none') {
                    // agendar múltiplas tentativas para sobrepor restores concorrentes
                    setTimeout(ensureTop, 20);
                    setTimeout(ensureTop, 120);
                    setTimeout(ensureTop, 400);
                    setTimeout(ensureTop, 800);
                    console.log('[DEBUG] modalSenha MutationObserver: scheduled ensureTop (modalContent)');

                    // Também tentar popular a select de serviços relacionados quando o modal abrir
                    try {
                        console.error('[DEBUG] modalSenha visible — attempting to populate related services', { editandoBoardId, editandoCardId });
                        if (typeof suggestionSystem !== 'undefined' && suggestionSystem.populateRelatedServices) {
                            suggestionSystem.populateRelatedServices(editandoBoardId, editandoCardId);
                        } else {
                            console.error('[DEBUG] suggestionSystem.populateRelatedServices not available');
                        }
                    } catch (e) { console.error('[DEBUG] error populating related services on modal open', e); }
                }
            } catch(_) {}
        });
        mo.observe(modalSenhaDiv, { attributes: true, attributeFilter: ['style', 'class'] });
    } catch(_) {}
}
const formSenha = document.getElementById("formSenha");
const btnCancelarSenha = document.getElementById("btnCancelarSenha");
const modalAnotacaoDiv = document.getElementById("modalAnotacao");
const formAnotacao = document.getElementById("formAnotacao");
const btnCancelarAnotacao = document.getElementById("btnCancelarAnotacao");
const btnModoLeitura = document.getElementById("btnModoLeitura");
const btnImportar = document.getElementById("btnImportar");
const btnExportar = document.getElementById("btnExportar");
const btnFiltrar = document.getElementById("btnFiltrar");
const btnLimparFiltro = document.getElementById("btnLimparFiltro");
const btnAdicionarCategoria = document.getElementById("btnAdicionarCategoria");
const importFileInput = document.getElementById("importFileInput");
const btnModoLeituraAnotacao = document.getElementById("btnModoLeituraAnotacao");
const btnImportarAnotacao = document.getElementById("btnImportarAnotacao");
const btnExportarAnotacao = document.getElementById("btnExportarAnotacao");
const btnFiltrarAnotacao = document.getElementById("btnFiltrarAnotacao");
const btnLimparFiltroAnotacao = document.getElementById("btnLimparFiltroAnotacao");
const btnAdicionarAnotacaoCategoria = document.getElementById("btnAdicionarAnotacaoCategoria");
const importAnotacaoFileInput = document.getElementById("importAnotacaoFileInput");
const btnInstalar = document.getElementById("btnInstalar");
const messageBox = document.getElementById("message-box");
window.messageBox = messageBox;
const overlay = document.getElementById("overlay");
const btnEntrar = document.getElementById("btnEntrar");
const btnCertificado = document.getElementById("btnCertificado");
const btnAnotacoes = document.getElementById("btnAnotacoes");
const btnVoltarLogin = document.getElementById("btnVoltarLogin");
const btnVoltarLoginAnotacoes = document.getElementById("btnVoltarLoginAnotacoes");
const btnSair = document.getElementById("btnSair");
const btnSairAnotacao = document.getElementById("btnSairAnotacao");
const versionLink = document.getElementById("version-link");
const modalObservacoes = document.getElementById("modalObservacoes");
const btnSalvarObservacoes = document.getElementById("btnSalvarObservacoes");
const btnRedefinirTempo = document.getElementById("btnRedefinirTempo");
const pinInputs = document.querySelectorAll('.pin-input');
const btnUpdates = document.getElementById("btnUpdates");
const modalDesenvolvimento = document.getElementById("modalDesenvolvimento");
const btnAtivarUpdate = document.getElementById("btnAtivarUpdate");
const btnDesativarUpdate = document.getElementById("btnDesativarUpdate");
const btnApagarDados = document.getElementById("btnApagarDados");
const updateDialog = document.getElementById("update-dialog");
const btnRealizarUpload = document.getElementById("btnRealizarUpload");
const updateFileInput = document.getElementById("updateFileInput");

// Garantir que, quando uma message-box/modal de observações estiver visível, o overlay fique por baixo
// e que, se uma caixa de mensagem for exibida a partir de um modal (ex.: modal de Senhas),
// o overlay não fique acima do modal fazendo com que ele bloqueie o formulário.
(function ensureMessageOverlayStacking(){
    try{
        if(!overlay || !messageBox) return;
        function apply(){
            try{
                const msgVisible = messageBox.style && messageBox.style.display && messageBox.style.display !== 'none';
                const obsVisible = modalObservacoes && modalObservacoes.style && modalObservacoes.style.display && modalObservacoes.style.display !== 'none';
                // Detectar se algum modal principal da aplicação está aberto (Senhas / Anotações / Desenvolvimento)
                const modalSenhaVisible = modalSenhaDiv && modalSenhaDiv.style && modalSenhaDiv.style.display && modalSenhaDiv.style.display !== 'none';
                const modalAnotacaoVisible = modalAnotacaoDiv && modalAnotacaoDiv.style && modalAnotacaoDiv.style.display && modalAnotacaoDiv.style.display !== 'none';
                const modalDevVisible = modalDesenvolvimento && modalDesenvolvimento.style && modalDesenvolvimento.style.display && modalDesenvolvimento.style.display !== 'none';

                if (msgVisible) {
                    if (modalSenhaVisible || modalAnotacaoVisible || modalDevVisible) {
                        // Se a message-box foi aberta a partir de um modal, manter o overlay abaixo
                        // do modal (valor CSS padrão) e elevar apenas a message-box acima do modal.
                        try { overlay.style.setProperty('z-index','998','important'); } catch(_){ overlay.style.zIndex = '998'; }
                        try { messageBox.style.setProperty('z-index','1001','important'); } catch(_){ messageBox.style.zIndex = '1001'; }
                    } else {
                        // Comportamento padrão: message-box fica acima de tudo
                        try { overlay.style.setProperty('z-index','2147483650','important'); } catch(_){ overlay.style.zIndex = '2147483650'; }
                        try { messageBox.style.setProperty('z-index','2147483652','important'); } catch(_){ messageBox.style.zIndex = '2147483652'; }
                    }
                } else if (obsVisible) {
                    try { overlay.style.setProperty('z-index','2147483650','important'); } catch(_){ overlay.style.zIndex = '2147483650'; }
                    try { modalObservacoes.style.setProperty('z-index','2147483652','important'); } catch(_){ modalObservacoes.style.zIndex = '2147483652'; }
                }
            }catch(e){}
        }
        // observar mudanças de estilo no overlay e na messageBox/modalObservacoes
        const mo = new MutationObserver((records)=>{ apply(); });
        mo.observe(overlay, { attributes: true, attributeFilter: ['style'] });
        mo.observe(messageBox, { attributes: true, attributeFilter: ['style'] });
        if(modalObservacoes) mo.observe(modalObservacoes, { attributes: true, attributeFilter: ['style'] });
        // aplicar imediatamente
        apply();
    }catch(e){}
})();
const themeToggleBtn = document.getElementById("theme-toggle-btn");
const floatingWrenchBtn = document.getElementById("floating-wrench-btn");
const fabRefreshBtn = document.getElementById("fab-refresh-btn");
const fabMain = document.getElementById("fab-main");
const fabContainer = document.querySelector(".fab-container");
const quickRefreshBox = document.getElementById("quick-refresh-box");
const quickRefreshProgress = document.getElementById("quick-refresh-progress");
const quickRefreshTitle = document.getElementById("quick-refresh-title");
const quickRefreshCaption = document.getElementById("quick-refresh-caption");
const quickRefreshPill = document.getElementById("quick-refresh-pill");
const quickRefreshDismiss = document.getElementById("quick-refresh-dismiss");
const alertaRevisaoSenha = document.getElementById("alerta-revisao-senha");
const toggleMobileInstructions = document.getElementById('toggleMobileInstructions');
const mobileInstructions = document.getElementById('mobileInstructions');
const certTitulo = document.querySelector('#certificado .codigo-box');
const certInstructions = document.getElementById('certInstructions');
const pluginDigitalBox = document.getElementById('pluginDigitalBox');
const relatorioBugsBox = document.getElementById('relatorioBugsBox');


fabMain.addEventListener("click", (e) => {
    e.stopPropagation(); 
    fabContainer.classList.toggle("active");
});

let quickRefreshTimer = null;
function startQuickRefresh() {
    if (!quickRefreshBox || !quickRefreshProgress) return;
    if (quickRefreshTimer) {
        clearTimeout(quickRefreshTimer);
        quickRefreshTimer = null;
    }

    // Mostrar imediatamente o alerta de revisão de senhas
    if (alertaRevisaoSenha) {
        try { localStorage.removeItem('alertaRevisaoSenhaSnooze'); } catch(_) {}
        alertaRevisaoSenha.style.display = 'flex';
    }

    quickRefreshBox.classList.add("visible");
    quickRefreshBox.classList.remove("done");
    quickRefreshProgress.style.width = "0%";
    if (quickRefreshTitle) quickRefreshTitle.textContent = "Atualizando o site";
    if (quickRefreshCaption) quickRefreshCaption.textContent = "Aplicando ajustes rápidos sem sair do painel.";
    if (quickRefreshPill) {
        quickRefreshPill.textContent = "Em andamento";
        quickRefreshPill.setAttribute("data-state", "running");
    }

    requestAnimationFrame(() => {
        quickRefreshProgress.style.width = "100%";
    });

    quickRefreshTimer = setTimeout(() => {
        quickRefreshBox.classList.add("done");
        if (quickRefreshTitle) quickRefreshTitle.textContent = "Site atualizado";
        if (quickRefreshCaption) quickRefreshCaption.textContent = "Seu painel permanece aberto e sincronizado.";
        if (quickRefreshPill) {
            quickRefreshPill.textContent = "Pronto";
            quickRefreshPill.setAttribute("data-state", "done");
        }

        quickRefreshTimer = setTimeout(() => {
            quickRefreshBox.classList.remove("visible", "done");
            quickRefreshProgress.style.width = "0%";
            quickRefreshTimer = null;
        }, 1200);
    }, 1500);
}

if (fabRefreshBtn) {
    fabRefreshBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        try {
                console.log('[FAB] Invocando atualizarCriptografiaSite');
                await atualizarCriptografiaSite();
                console.log('[FAB] atualizarCriptografiaSite concluido');
            } catch (err) {
                console.warn('[FAB] atualizarCriptografiaSite failed', err);
            }
        startQuickRefresh();
    });
}

// Reaplica a criptografia dos dados em memória usando a senha atualmente disponível.
// Se a senha não estiver em memória, solicita via prompt modal (permanece na tela atual).
async function atualizarCriptografiaSite() {
    console.log('[RECRIP] iniciar atualizarCriptografiaSite', { hasSenha: !!senhaDigitada });
    try {
        // Se não houver senha em memória, pedir ao usuário sem navegar para a tela de login
        if (!senhaDigitada) {
            console.log('[RECRIP] senhaDigitada vazia -> mostrando prompt');
            const senha = await mostrarPromptSenha('Reaplicar criptografia', 'Informe a senha mestre para recriptografar os dados sem sair da tela:', 'Digite a senha do serviço', false);
            console.log('[RECRIP] prompt retornou', { senhaProvided: !!senha });
            if (!senha) {
                console.log('[RECRIP] usuário cancelou prompt de senha');
                try { mostrarMensagem('Cancelado', 'Operação de recriptografia cancelada.'); } catch(_){}
                return false;
            }
            if (!verificarSenha(senha)) {
                console.log('[RECRIP] verificarSenha retornou false');
                try { mostrarMensagem('Erro', 'Senha incorreta. A recriptografia foi cancelada.'); } catch(_){}
                return false;
            }
            senhaDigitada = senha;
        }

        let recriptCount = 0;

        // Recriptografar boards (senhas)
        try {
            if (Array.isArray(boards)) {
                for (const board of boards) {
                    if (!board || !Array.isArray(board.cards)) continue;
                    for (let i = 0; i < board.cards.length; i++) {
                        try {
                            const cardEnc = board.cards[i];
                            const card = descriptografarCard(cardEnc, senhaDigitada);
                            if (!card) continue; // não conseguiu descriptografar com a senha atual
                            const novoEnc = criptografarCard(card, senhaDigitada);
                            // substituir mesmo que idêntico para garantir formato consistente
                            if (JSON.stringify(novoEnc) !== JSON.stringify(cardEnc)) recriptCount++;
                            board.cards[i] = novoEnc;
                        } catch (err) { console.warn('Erro recriptografando card', err); }
                    }
                }
            }
        } catch (err) { console.warn('Erro recriptografando boards', err); }

        // Recriptografar anotações
        try {
            if (Array.isArray(anotacoesBoards)) {
                for (let i = 0; i < anotacoesBoards.length; i++) {
                    try {
                        const a = anotacoesBoards[i];
                        // Anotações podem já estar em formato simples; tratar generico
                        if (!a) continue;
                        // cada anotação pode ter campos criptografados — recriar com mesmas rotinas
                        // se for um objeto com campo 'conteudo' criptografado, tentar normalizar
                        const novo = {};
                        let changed = false;
                        for (const key in a) {
                            if (key === 'id') { novo[key] = a[key]; continue; }
                            try {
                                const val = a[key];
                                // tentar descriptografar; se retornar null, manter valor original
                                const desc = descriptografarDados(val, senhaDigitada);
                                if (desc === null || desc === undefined) {
                                    novo[key] = val;
                                } else {
                                    novo[key] = criptografarDados(desc, senhaDigitada);
                                    if (JSON.stringify(novo[key]) !== JSON.stringify(val)) changed = true;
                                }
                            } catch (err) {
                                novo[key] = a[key];
                            }
                        }
                        if (changed) {
                            anotacoesBoards[i] = novo;
                            recriptCount++;
                        }
                    } catch (err) { console.warn('Erro recriptografando anotacao', err); }
                }
            }
        } catch (err) { console.warn('Erro recriptografando anotacoes', err); }

        // Persistir localmente sem alterar tela
        try {
            try { boardsOriginal = JSON.parse(JSON.stringify(boards)); } catch(_) { boardsOriginal = Array.isArray(boards) ? boards.slice() : boards; }
            try { anotacoesBoardsOriginal = JSON.parse(JSON.stringify(anotacoesBoards)); } catch(_) { anotacoesBoardsOriginal = Array.isArray(anotacoesBoards) ? anotacoesBoards.slice() : anotacoesBoards; }
            console.log('[RECRIP] salvando via salvarBoards (senha & anotacao)');
            try { await salvarBoards('senha'); } catch(e){ console.warn('[RECRIP] salvarBoards senha failed', e); }
            try { await salvarBoards('anotacao'); } catch(e){ console.warn('[RECRIP] salvarBoards anotacao failed', e); }
            console.log('[RECRIP] salvarBoards concluido');
        } catch (err) { console.warn('[RECRIP] Erro ao salvar local após recriptografia', err); }
        // Nota: não exibir modal de sucesso para evitar duplicação com outras caixas.
        console.log('[RECRIP] finalizado - items recriptografados:', recriptCount);
        return true;
    } catch (err) {
        console.warn('atualizarCriptografiaSite global error', err);
        try { mostrarMensagem('Erro', 'Falha ao recriptografar os dados. Veja o console.'); } catch(_){}
        return false;
    }
}

if (quickRefreshDismiss) {
    quickRefreshDismiss.addEventListener("click", () => {
        if (quickRefreshTimer) {
            clearTimeout(quickRefreshTimer);
            quickRefreshTimer = null;
        }
        if (quickRefreshBox) quickRefreshBox.classList.remove("visible", "done");
        if (quickRefreshProgress) quickRefreshProgress.style.width = "0%";
    });
}

// Modal overlay click handler with short shield to avoid immediate re-close
window.__modalClickShield = false;
function handleOverlayClick(e) {
    console.log('[OVERLAY] handleOverlayClick invoked', { shield: window.__modalClickShield, target: (e && e.target) ? e.target.tagName + (e.target.id ? '#'+e.target.id : '') : e });
    try { console.trace(); } catch(_){ }
    if (window.__modalClickShield) {
        try { e.stopPropagation(); } catch(_){ }
        console.log('[MODAL-SHIELD] Ignoring overlay click immediately after open');
        return;
    }
    // Determinar o que está visível e agir de forma específica (não fechar modais indevidamente)
    try {
        const msgVisible = messageBox && messageBox.style && messageBox.style.display && messageBox.style.display !== 'none';
        const obsVisible = modalObservacoes && modalObservacoes.style && modalObservacoes.style.display && modalObservacoes.style.display !== 'none';
        const devVisible = modalDesenvolvimento && modalDesenvolvimento.style && modalDesenvolvimento.style.display && modalDesenvolvimento.style.display !== 'none';
        const modalSenhaVisible = modalSenhaDiv && modalSenhaDiv.style && modalSenhaDiv.style.display && modalSenhaDiv.style.display !== 'none';
        const modalAnotVisible = modalAnotacaoDiv && modalAnotacaoDiv.style && modalAnotacaoDiv.style.display && modalAnotacaoDiv.style.display !== 'none';

        // Se for uma message-box / confirm / prompt aberta, use o fluxo padrão para fechar mensagem
        if (msgVisible || obsVisible || devVisible) {
            try { fecharMensagem(false); } catch (err) { console.warn('Error closing via overlay (messageBox):', err); }
            return;
        }

        // Se não há messageBox visível mas há um modal da aplicação aberto, delegar ao fechamento correto
        if (modalSenhaVisible) {
            // Fechamento pelo overlay deve fechar o modal Senha (backdrop)
            if (e && e.target === overlay) {
                try { fecharModalSenha(); } catch (err) { console.warn('Error closing modalSenha via overlay:', err); }
            } else {
                console.log('[OVERLAY] click ignored: not a backdrop click for modalSenha');
            }
            return;
        }

        if (modalAnotVisible) {
            // Backdrop clicks para Anotações intencionalmente são ignorados (usuário deve usar botão 'Voltar')
            console.log('[OVERLAY] click ignored: modalAnotacao open (backdrop click disabled)');
            return;
        }

        // Se não houver nenhum modal aberto, aplicar fallback seguro apenas para ocultar overlay
        try {
            if (overlay && overlay.style && overlay.style.display && overlay.style.display !== 'none') {
                console.log('[OVERLAY] No modal visible and overlay is shown — forcing overlay hide only');
                try { fecharMensagem(true); } catch (err) { console.warn('Fallback fecharMensagem(true) failed', err); }
            }
        } catch (err) {
            console.warn('[OVERLAY] fallback hide failed', err);
        }
    } catch (err) {
        try { fecharMensagem(false); } catch (err2) { console.warn('Error closing via overlay (fallback):', err2); }
    }
}


document.addEventListener("click", (e) => {
    if (!fabContainer.contains(e.target)) {
        fabContainer.classList.remove("active");
    }
});


document.querySelectorAll(".fab-action-button").forEach(button => {
    button.addEventListener("click", (e) => {
        e.stopPropagation(); 
        
        setTimeout(() => {
            fabContainer.classList.remove("active");
        }, 200);
    });
});
// Body scroll lock utilities (safe for multiple modals)
window.__bodyLock = window.__bodyLock || { count: 0, scrollY: 0 };
function lockBodyScroll() {
    try {
        const state = window.__bodyLock;
        console.log('[BODY-LOCK] lockBodyScroll called - before', { count: state.count, scrollY: window.scrollY });
        try { console.trace(); } catch(_){}
        if (state.count === 0) {
            state.scrollY = window.scrollY || window.pageYOffset || 0;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${state.scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
            console.log('[BODY-LOCK] locked at', state.scrollY);
        }
        state.count += 1;
        console.log('[BODY-LOCK] lockBodyScroll called - after', { count: state.count });
    } catch (e) { console.warn('[BODY-LOCK] failed to lock', e); }
}
// Lock body scroll using an explicit Y coordinate (useful when window.scrollY
// changes due to reflow between capture and lock). This ensures we restore
// exactly the position the UI had when the modal open was initiated.
function lockBodyScrollAt(scrollY) {
    try {
        const state = window.__bodyLock;
        const y = (typeof scrollY === 'number') ? scrollY : (window.scrollY || window.pageYOffset || 0);
        console.log('[BODY-LOCK] lockBodyScrollAt called - before', { count: state.count, providedScrollY: scrollY });
        try { console.trace(); } catch(_){ }
        if (state.count === 0) {
            state.scrollY = y;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${state.scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
            console.log('[BODY-LOCK] locked at (explicit)', state.scrollY);
        }
        state.count += 1;
        console.log('[BODY-LOCK] lockBodyScrollAt called - after', { count: state.count });
    } catch (e) { console.warn('[BODY-LOCK] lockBodyScrollAt failed to lock', e); }
}
function unlockBodyScroll() {
    try {
        const state = window.__bodyLock;
        console.log('[BODY-LOCK] unlockBodyScroll called - before', { count: state.count });
        try { console.trace(); } catch(_){}
        state.count = Math.max(0, (state.count || 1) - 1);
        if (state.count === 0) {
            const y = state.scrollY || 0;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            window.scrollTo(0, y);
            console.log('[BODY-LOCK] unlocked and restored to', y);
        } else {
            console.log('[BODY-LOCK] unlock deferred, remaining count', state.count);
        }
        console.log('[BODY-LOCK] unlockBodyScroll called - after', { count: state.count });
    } catch (e) { console.warn('[BODY-LOCK] failed to unlock', e); }
}
// Helper: attach a close handler to a button that defers activation until
// it's safe (prevents the same click that opened the modal from closing it).

// ====== PDF DOWNLOADS LOG (últimos 30 dias) ======
function savePdfDownloadEntry(entry) {
    try {
        const key = 'pdfDownloads';
        const raw = localStorage.getItem(key) || '[]';
        const arr = JSON.parse(raw);
        // manter ordenado e limitar a 500 entradas
        arr.push(entry);
        const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);
        const filtered = arr.filter(i => i && (i.timestamp || 0) >= cutoff);
        const final = filtered.slice(-500);
        localStorage.setItem(key, JSON.stringify(final));
    } catch (err) { console.warn('savePdfDownloadEntry failed', err); }
}

function getPdfDownloadsLast30Days() {
    try {
        const raw = localStorage.getItem('pdfDownloads') || '[]';
        const arr = JSON.parse(raw);
        const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);
        return (arr || []).filter(i => i && (i.timestamp || 0) >= cutoff).sort((a,b) => (b.timestamp||0)-(a.timestamp||0));
    } catch (err) { console.warn('getPdfDownloadsLast30Days failed', err); return []; }
}

function salvarSenhaComoImagem(titulo, senha) {
    try {
        const tituloSafe = (titulo || 'senha').replace(/[^a-z0-9\- _]/gi,'').trim() || 'senha';
        const padding = 36;
        const fontSize = 36;
        const fontFamily = "Courier New, monospace";
        const tmp = document.createElement('canvas');
        const tmpCtx = tmp.getContext('2d');
        tmpCtx.font = `${fontSize}px ${fontFamily}`;
        const measured = Math.ceil(tmpCtx.measureText(senha || '').width) + padding * 2;
        const width = Math.min(2000, Math.max(420, measured));
        const finalWidth = Math.min(1200, Math.max(480, width));
        const finalHeight = 360;
        const canvas = document.createElement('canvas');
        const ratio = Math.max(1, window.devicePixelRatio || 1);
        canvas.width = finalWidth * ratio;
        canvas.height = finalHeight * ratio;
        canvas.style.width = finalWidth + 'px';
        canvas.style.height = finalHeight + 'px';
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        // background
        const g = ctx.createLinearGradient(0, 0, finalWidth, finalHeight);
        g.addColorStop(0, '#6a11cb'); g.addColorStop(1, '#2575fc');
        ctx.fillStyle = g; ctx.fillRect(0,0,finalWidth,finalHeight);
        // card
        const cardPadding = 40; const cardX = cardPadding; const cardY = 30; const cardW = finalWidth - cardPadding*2; const cardH = finalHeight - 60; const radius = 18;
        ctx.shadowColor = 'rgba(0,0,0,0.18)'; ctx.shadowBlur = 28; ctx.shadowOffsetY = 8;
        ctx.beginPath(); ctx.moveTo(cardX + radius, cardY); ctx.arcTo(cardX + cardW, cardY, cardX + cardW, cardY + cardH, radius); ctx.arcTo(cardX + cardW, cardY + cardH, cardX, cardY + cardH, radius); ctx.arcTo(cardX, cardY + cardH, cardX, cardY, radius); ctx.arcTo(cardX, cardY, cardX + cardW, cardY, radius); ctx.closePath(); ctx.fillStyle = 'rgba(255,255,255,0.96)'; ctx.fill();
        // text
        ctx.fillStyle = '#111827'; ctx.textAlign = 'center'; let passFontSize = 48; ctx.font = `700 ${passFontSize}px "Courier New", monospace`;
        while (ctx.measureText(senha || '').width > cardW - 40 && passFontSize > 18) { passFontSize -= 2; ctx.font = `700 ${passFontSize}px "Courier New", monospace`; }
        const passX = cardX + cardW/2; const passY = cardY + cardH/2 + passFontSize/3; ctx.fillText(senha || '', passX, passY);
        // instruction
        ctx.textAlign = 'left'; ctx.fillStyle = 'rgba(17,24,39,0.6)'; ctx.font = '13px Inter, system-ui, sans-serif'; ctx.fillText('Guarde em um lugar seguro.', cardX + 8, cardY + cardH + 28);
        canvas.toBlob((blob) => { if (!blob) return; const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${tituloSafe}-senha-${Date.now()}.png`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); });
    } catch (err) { console.error('salvarSenhaComoImagem failed', err); }
}

function mostrarSenhasRecentesPDF() {
    const entries = getPdfDownloadsLast30Days();
    if (!window.messageBox) return mostrarMensagem('Atenção', 'Não foi possível abrir a lista de senhas agora.');
    if (!entries || !entries.length) return mostrarMensagem('Atenção', 'Nenhum PDF foi baixado nos últimos 30 dias.');

    const rows = entries.map((e, idx) => {
        const dtShort = new Date(e.timestamp || 0).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
        const titleSafe = (e.titulo || 'dados');
        const pwd = e.senha || '';
        const isEncrypted = !!e.encrypted;
        const badgeSvg = isEncrypted
            ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" class="badge-icon"><rect x="3" y="11" width="18" height="11" rx="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`
            : `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" class="badge-icon"><path d="M21 10v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6"/><path d="M7 10V7a5 5 0 0 1 10 0v3"/></svg>`;
        const badgeClass = isEncrypted ? 'encrypted' : 'plain';

        const copySvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h9"></path></svg>`;
        const imgSvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"></rect><path d="M7 14l2-2 4 4 4-4 2 2"/></svg>`;
        const retrySvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-3-6.7"></path><polyline points="21 6 21 12 15 12"></polyline></svg>`;

        return `
            <div class="pdf-senha-card" data-idx="${idx}" role="listitem">
                <div class="pdf-card-top">
                    <div class="pdf-card-left">
                        <div class="pdf-icon" aria-hidden="true">${badgeSvg}</div>
                        <div class="pdf-info">
                            <div class="pdf-senha-title" title="${escapeHtml(titleSafe)}">${escapeHtml(shortText(titleSafe, 48))}</div>
                            <div class="pdf-senha-meta">${escapeHtml(dtShort)}</div>
                        </div>
                    </div>
                    <div class="pdf-card-right">
                        <div class="pdf-senha-code" title="${escapeHtml(pwd)}">${escapeHtml(pwd)}</div>
                        <div class="pdf-senha-actions" role="group" aria-label="Ações">
                            <button class="copy-pwd copy-btn" data-idx="${idx}" title="Copiar senha" aria-label="Copiar senha">${copySvg}<span class="sr-only">Copiar</span></button>
                            <button class="img-pwd img-btn" data-idx="${idx}" title="Salvar como imagem" aria-label="Salvar como imagem">${imgSvg}<span class="sr-only">Salvar imagem</span></button>
                            <button class="retry-pwd" data-idx="${idx}" title="Tentar novamente" aria-label="Tentar novamente">${retrySvg}<span class="sr-only">Tentar novamente</span></button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    window.messageBox.innerHTML = `
        <div class="pdf-modal-header" role="banner" aria-label="Cabeçalho do histórico de senhas">
            <div class="pdf-modal-title">
                <div class="modal-brand" aria-hidden="true">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                </div>
                <div>
                    <div class="muted">Histórico</div>
                    <h2 class="title">Senhas Recentes <span class="count">(${entries.length})</span></h2>
                </div>
            </div>
            <div class="modal-header-actions" style="display:flex; gap:8px; align-items:center;">
                <button id="btnLimparSenhasPDFTop" class="btn-ghost" title="Limpar histórico" aria-label="Limpar histórico">Limpar</button>
            </div>
        </div>
        <div class="pdf-modal-body">
            <div class="pdf-modal-container">
                <div class="pdf-senha-list" role="list">${rows}</div>
            </div>
        </div>
        <div class="pdf-modal-footer" role="contentinfo">
            <div class="modal-actions-row" style="display:flex; width:100%;">
                <button id="btnFecharListaSenhas" class="btn-primary btn-full">Fechar</button>
            </div>
        </div>
    `;

    const isMobileView = window.matchMedia && window.matchMedia('(max-width: 480px)').matches;
    // Fullscreen behavior on mobile
    try {
        if (isMobileView) {
            window.messageBox.classList.add('fullscreen');
            if (overlay) overlay.style.display = 'block';
            document.body.classList.add('modal-open');
        } else {
            window.messageBox.classList.remove('fullscreen');
        }
    } catch(_) {}

    try { if (overlay) overlay.style.display = 'block'; window.messageBox.style.display = 'block'; window.messageBox.classList.add('pdf-modal-open'); } catch(_){ }

    // attach actions
    setTimeout(() => {
        const copyBtns = window.messageBox.querySelectorAll('.copy-pwd');
        copyBtns.forEach(b => b.addEventListener('click', (ev) => {
            const idx = Number(b.dataset.idx);
            const e = entries[idx];
            if (!e) return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(e.senha || '').then(() => mostrarMensagem('Sucesso', 'Senha copiada para a área de transferência.')).catch(() => mostrarMensagem('Erro', 'Não foi possível copiar a senha.'));
            } else {
                mostrarMensagem('Erro', 'API de Clipboard não disponível.');
            }
        }));

        const imgBtns = window.messageBox.querySelectorAll('.img-pwd');
        imgBtns.forEach(b => b.addEventListener('click', (ev) => {
            const idx = Number(b.dataset.idx);
            const e = entries[idx];
            if (!e) return;
            salvarSenhaComoImagem(e.titulo, e.senha);
        }));

        const retryBtns = window.messageBox.querySelectorAll('.retry-pwd');
        retryBtns.forEach(b => b.addEventListener('click', (ev) => {
            const idx = Number(b.dataset.idx);
            const e = entries[idx];
            if (!e) return mostrarMensagem('Erro', 'Entrada não encontrada.');
            mostrarMensagem('Processando', 'Tentando gerar um novo PDF...');
            try {
                // Tentativa simples de regenerar usando dados disponíveis (gera nova senha)
                if (typeof downloadCardAsImage === 'function') {
                    downloadCardAsImage({ titulo: e.titulo });
                } else {
                    mostrarMensagem('Erro', 'Função de geração de PDF não disponível.');
                }
            } catch (err) {
                console.warn('retry failed', err);
                mostrarMensagem('Erro', 'Falha ao tentar gerar o PDF.');
            }
        }));

        // Top & footer action buttons (only close remains)

        const btnClose = document.getElementById('btnFecharListaSenhas');
        if (btnClose) btnClose.addEventListener('click', () => { try { window.messageBox.classList.remove('pdf-modal-open'); fecharMensagem(false); } catch(_){} });

        // Ensure body lock and overlay are active in mobile fullscreen
        try {
            if (window.matchMedia && window.matchMedia('(max-width: 480px)').matches) {
                if (overlay) overlay.style.display = 'block';
                document.body.classList.add('modal-open');
            }
        } catch(_) {}
    }, 50);
}

function escapeHtml(str) { return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// Shorten text for compact mobile cards (preserve full value in title attr)
function shortText(s, max = 30) { try { const st = String(s || ''); return st.length > max ? st.slice(0, max-1) + '…' : st; } catch(_) { return s; } }

function attachSafeClose(btnId, modalToken) {
    try {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const attach = () => {
            const handler = function (e) {
                try {
                    if (window.__modalClickShield) {
                        console.log('[SAFE-CLOSE] shield active, deferring close for', btnId);
                        // Try again after shield may clear
                        setTimeout(() => { try { btn.addEventListener('click', handler, { once: true }); } catch(_){} }, 200);
                        return;
                    }
                } catch (_) {}
                try { fecharMensagem(false, modalToken); } catch (err) { console.warn('fecharMensagem failed', err); }
            };
            btn.addEventListener('click', handler, { once: true });
        };
        try { btn.disabled = true; } catch(_){ }
        // enable immediately but attach on next frame to avoid same-click activation
        try {
            requestAnimationFrame(() => { try { btn.disabled = false; } catch(_){}; requestAnimationFrame(attach); });
        } catch (e) {
            // fallback to microtask style if rAF is not available
            setTimeout(() => { try { btn.disabled = false; } catch(_){}; setTimeout(attach, 0); }, 0);
        }
    } catch (err) { console.warn('attachSafeClose failed for', btnId, err); }
}
const btnVoltarObservacoes = document.getElementById("btnVoltarObservacoes");
const inputCpf = document.getElementById("inputCpf");
const inputTelefone = document.getElementById("inputTelefone");
const inputEmail = document.getElementById("inputEmail");
const gmailHelperBtn = document.getElementById("gmail-helper");
const inputLinks = document.getElementById("inputLinks");
const inputAbreviacao = document.getElementById("inputAbreviacao");
const abreviacaoContainer = document.getElementById("abreviacao-container");
const btnGoToSettings = document.getElementById("btn-go-to-settings");
const btnGoToAutoFillForm = document.getElementById('btn-go-to-autofill-form');
const btnAutoFillBackToApp = document.getElementById('btn-autofill-back-to-app');
const formAutoFillData = document.getElementById('formAutoFillData');
const btnAutoFillFormBack = document.getElementById('btn-autofill-form-back');
const btnAutoFillTrigger = document.getElementById('btn-autofill-trigger');
const btnManageMarcadores = document.getElementById('btn-manage-marcadores');
const modalMarcadores = document.getElementById('modalMarcadores');
const btnFecharMarcadores = document.getElementById('btnFecharMarcadores');
const btnAdicionarMarcador = document.getElementById('btn-adicionar-marcador');
const marcadorNomeInput = document.getElementById('marcador-nome-input');
const marcadorCorInput = document.getElementById('marcador-cor-input');
const marcadoresList = document.getElementById('marcadores-list');
const inputMarcador = document.getElementById('inputMarcador');
const inputMarcadorAnotacao = document.getElementById('inputMarcadorAnotacao');
// Aparelhos conectados
const btnManageDevices = document.getElementById('btn-manage-devices');
const modalDevices = document.getElementById('modalDevices');
const btnCloseDevices = document.getElementById('btnCloseDevices');
const formDevice = document.getElementById('formDevice');
const devicesListContainer = document.getElementById('devices-list-container');
const registeredDevicesDisplay = document.getElementById('registered-devices-display');
const currentDeviceChip = document.getElementById('current-device-chip');
const currentDeviceChipIcon = document.getElementById('current-device-chip-icon');
let aparelhosConectados = [];

// Modal cartão padrão
const defaultCardModal = document.getElementById('defaultCardModal');
const btnDefaultCard = document.getElementById('btn-default-card');
const btnDefaultCardBack = document.getElementById('btn-default-card-back');
const btnDefaultCardSave = document.getElementById('btn-default-card-save');
const btnDefaultCardClear = document.getElementById('btn-default-card-clear');
const defaultCardNumber = document.getElementById('default-card-number');
const defaultCardHolder = document.getElementById('default-card-holder');
const defaultCardExpiry = document.getElementById('default-card-expiry');
const defaultCardCvv = document.getElementById('default-card-cvv');
const defaultCardBrand = document.getElementById('default-card-brand');
const previewCardNumber = document.getElementById('preview-card-number');
const previewCardHolder = document.getElementById('preview-card-holder');
const previewCardExpiry = document.getElementById('preview-card-expiry');

// Botão para exibir Senhas Recentes
const btnShowPdfSenhas = document.getElementById('btn-show-pdf-senhas');


document.addEventListener('DOMContentLoaded', () => {
if (localStorage.getItem('updateNoticeVisible') === 'true') {
updateDialog.style.display = 'block';
}
const savedTheme = localStorage.getItem('theme') || 'dark';
setTheme(savedTheme);

// Carregar marcadores ao iniciar
carregarMarcadores();
atualizarSelectsMarcadores();
renderizarAparelhosIcones();

// Registrar listener do botão de senhas PDF recentes
if (btnShowPdfSenhas) btnShowPdfSenhas.addEventListener('click', (e) => { e.stopPropagation(); mostrarSenhasRecentesPDF(); });

document.querySelectorAll('.btn-clear-field').forEach(btn => {
btn.addEventListener('click', (e) => {
   const container = e.target.closest('.input-container');
   if (container) {
       const input = container.querySelector('input, textarea');
       if (input) {
           input.value = '';
           input.dispatchEvent(new Event('input', { bubbles: true }));
       }
   }
   e.target.style.display = 'none';
});
});
});


themeToggleBtn.addEventListener('click', toggleTheme);
floatingWrenchBtn.addEventListener('click', abrirModalObservacoes);
btnVoltarObservacoes.addEventListener('click', () => fecharMensagem(false));
btnEntrar.addEventListener('click', login);
btnCertificado.addEventListener('click', () => mostrarTela('certificado'));
btnAnotacoes.addEventListener('click', () => mostrarTela('anotacoesLogin'));
btnVoltarLogin.addEventListener('click', () => mostrarTela('login'));
btnVoltarLoginAnotacoes.addEventListener('click', () => mostrarTela('login'));
btnSair.addEventListener('click', logout);
btnSairAnotacao.addEventListener('click', logout);
btnModoLeitura.addEventListener('click', () => toggleModoLeitura('app'));
btnAdicionarCategoria.addEventListener('click', () => submitNewColumn('senha'));
btnFiltrar.addEventListener('click', () => filtrarCategorias('senha'));
btnLimparFiltro.addEventListener('click', () => limparFiltro('senha'));
btnImportar.addEventListener('click', async () => {
    try {
        // Contar leitura ao clicar no botão Importar (nuvem)
        try { if (typeof window._simIncReads === 'function') window._simIncReads(1); } catch(_){ }
        const confirmado = await mostrarConfirmacao('Confirmar importação', 'Deseja realmente importar os dados da nuvem agora? Isso substituirá os dados locais.');
        if (!confirmado) return;
        btnImportar.disabled = true;
        await importFromCloud('senha');
    } catch (e) {
        console.error('Erro em importFromCloud', e);
        mostrarMensagem('Erro', 'Não foi possível importar da nuvem.');
    } finally {
        btnImportar.disabled = false;
    }
});
btnExportar.addEventListener('click', async () => {
    try {
        const confirmado = await mostrarConfirmacao('Confirmar exportação', 'Deseja realmente exportar os dados para a nuvem agora? Isso substituirá os dados na nuvem.');
        if (!confirmado) return;
        btnExportar.disabled = true;
        await exportToCloud('senha');
    } catch (e) {
        console.error('Erro em exportToCloud', e);
        mostrarMensagem('Erro', 'Não foi possível exportar para nuvem.');
    } finally {
        btnExportar.disabled = false;
    }
});
importFileInput.addEventListener('change', (e) => importarDados(e, 'senha'));
btnModoLeituraAnotacao.addEventListener('click', () => toggleModoLeitura('anotacoesApp'));
btnAdicionarAnotacaoCategoria.addEventListener('click', () => submitNewColumn('anotacao'));
btnFiltrarAnotacao.addEventListener('click', () => filtrarCategorias('anotacao'));
btnLimparFiltroAnotacao.addEventListener('click', () => limparFiltro('anotacao'));
btnImportarAnotacao.addEventListener('click', () => {
    // A importação de anotações não está disponível aqui — exibir aviso ao usuário
    mostrarMensagem('Atenção', 'A importação e exportação estão disponíveis apenas no painel de senhas.');
});
// Apagar dados na nuvem (botão Funções Adicionais)
const btnApagarNuvem = document.getElementById('btn-apagar-nuvem');
if (btnApagarNuvem) {
    btnApagarNuvem.addEventListener('click', async () => {
        try {
            const confirmado = await mostrarConfirmacao('Confirmar exclusão', 'Deseja realmente apagar todos os dados armazenados na nuvem? Esta ação é irreversível.');
            if (!confirmado) return;
            btnApagarNuvem.disabled = true;
            mostrarMensagem('Aguarde', 'Apagando dados na nuvem...');
            // Chamar salvarDados com string vazia para sobrescrever o campo `dados` no documento
            if (typeof window.salvarDados === 'function') {
                const res = await window.salvarDados('');
                try { fecharMensagem(false); } catch(_){ }
                if (res && res.ok) {
                    // Contar exclusão automática no simulador
                    try { if (typeof window._simIncDeletes === 'function') window._simIncDeletes(1); } catch(_){ }
                    mostrarMensagem('Sucesso', 'Os dados na nuvem foram apagados.');
                } else {
                    console.error('apagarNuvem resposta', res);
                    mostrarMensagem('Erro', 'Não foi possível apagar os dados na nuvem. Veja o console para detalhes.');
                }
            } else {
                try { fecharMensagem(false); } catch(_){ }
                mostrarMensagem('Atenção', 'A função de sincronização com a nuvem não está disponível neste ambiente.');
            }
        } catch (err) {
            console.error('Erro ao apagar nuvem', err);
            mostrarMensagem('Erro', 'Falha ao apagar dados na nuvem. Veja o console para detalhes.');
        } finally {
            try { btnApagarNuvem.disabled = false; } catch(_){ }
        }
    });
}
btnExportarAnotacao.addEventListener('click', () => {
    // A exportação de anotações não está disponível aqui — exibir aviso ao usuário
    mostrarMensagem('Atenção', 'A importação e exportação estão disponíveis apenas no painel de senhas.');
});
importAnotacaoFileInput.addEventListener('change', (e) => { mostrarMensagem('Atenção', 'A importação e exportação estão disponíveis apenas no painel de senhas.'); try { e.target.value = ''; } catch(_){ } });
// 'Fazer upload de senhas' removido — handler excluído

pinInputs.forEach((input, index) => {
input.addEventListener('keydown', (e) => {
  if (e.key === 'Backspace' && !input.value && index > 0) {
      pinInputs[index - 1].focus();
  }
});

// Local import/export buttons in the Funções Adicionais panel
const btnLocalImport = document.getElementById('btn-local-import');
const btnLocalExport = document.getElementById('btn-local-export');
function getActiveMode() {
    try {
        const anotacoesVisible = (typeof anotacoesAppDiv !== 'undefined' && anotacoesAppDiv && anotacoesAppDiv.style && anotacoesAppDiv.style.display !== 'none');
        return anotacoesVisible ? 'anotacao' : 'senha';
    } catch (e) { return 'senha'; }
}
if (btnLocalImport) {
    btnLocalImport.addEventListener('click', async () => {
        try {
            const confirmado = await mostrarConfirmacao(
                'Importar (Local)',
                'Os dados importados serão aplicados em seguida. Deseja continuar com a importação agora? (Após a importação o site será atualizado automaticamente)'
            );
            if (confirmado) {
                // Marcar flag para que, após o processamento do arquivo, façamos a reatualização silenciosa e retornemos ao painel de senha
                try { window._afterLocalImportDoRefresh = true; } catch(_){}
                const mode = getActiveMode();
                if (mode === 'anotacao' && typeof importAnotacaoFileInput !== 'undefined' && importAnotacaoFileInput) {
                    importAnotacaoFileInput.click();
                } else if (typeof importFileInput !== 'undefined' && importFileInput) {
                    importFileInput.click();
                }
            }
        } catch (e) { console.error('btnLocalImport handler error', e); }
    });
}
if (btnLocalExport) {
    btnLocalExport.addEventListener('click', async () => {
        try {
            const confirmado = await mostrarConfirmacao('Confirmar exportação local', 'Deseja realmente exportar os dados localmente agora?');
            if (!confirmado) return;
            // Gerar download local diretamente
            try { console.info('Iniciando exportação local (botão Funções Adicionais)'); } catch(_){ }
            exportarDadosLocal();
        } catch (e) { console.error('btnLocalExport handler error', e); }
    });
}

// Simulador de Uso do Plano Firebase (modal integrado ao app)
(function(){
    try {
        const STORAGE_LIMIT_MB = 1024; // 1 GB = 1024 MB
        const READS_LIMIT = 50000;
        const WRITES_LIMIT = 20000;
        const DELETES_LIMIT = 20000;

        const $ = id => document.getElementById(id);
        const btnOpen = $('btn-open-firebase-simulator');
        const modal = $('modalFirebaseSimulator');
        const btnClose = $('btnCloseFirebaseSimulator');

        // Display elements
        const els = {
            storageValue: $('sim-storage-value'),
            readsValue: $('sim-reads-value'),
            writesValue: $('sim-writes-value'),
            deletesValue: $('sim-deletes-value'),
            storagePct: $('sim-storage-pct'),
            readsPct: $('sim-reads-pct'),
            writesPct: $('sim-writes-pct'),
            deletesPct: $('sim-deletes-pct'),
            storageBar: $('sim-storage-bar'),
            readsBar: $('sim-reads-bar'),
            writesBar: $('sim-writes-bar'),
            deletesBar: $('sim-deletes-bar'),
            summary: $('sim-summary')
        };
        function safeNum(v) { const n = Number(v); return Number.isFinite(n) ? n : 0; }
        function pct(part, total) { return total === 0 ? 0 : (part / total) * 100; }

        // Central metrics object (MB and counts)
        window._simMetrics = window._simMetrics || { storageMB: 0, reads: 0, writes: 0, deletes: 0, savedAt: Date.now() };

        function loadStored() {
            try {
                const raw = localStorage.getItem('firebasePlanUsage');
                if (!raw) return null;
                const data = JSON.parse(raw);
                if (!data) return null;
                window._simMetrics.storageMB = data.storage ?? data.storageMB ?? 0;
                window._simMetrics.reads = data.reads ?? 0;
                window._simMetrics.writes = data.writes ?? 0;
                window._simMetrics.deletes = data.deletes ?? 0;
                window._simMetrics.savedAt = data.savedAt || Date.now();
                return window._simMetrics;
            } catch (e) { console.error('Erro loadStored', e); return null; }
        }
        function saveStored(data) { try { localStorage.setItem('firebasePlanUsage', JSON.stringify({ storage: data.storageMB ?? data.storage, reads: data.reads, writes: data.writes, deletes: data.deletes, savedAt: data.savedAt || Date.now() })); } catch(e){console.error('Erro saveStored', e);} }

        // Helpers públicos para atualizar métricas automaticamente
        window._simIncReads = function(n=1) {
            try { window._simMetrics.reads = (window._simMetrics.reads || 0) + Number(n || 0); window._simMetrics.savedAt = Date.now(); saveStored(window._simMetrics); render(); } catch(e){console.error('simIncReads error', e);} };
        window._simIncWrites = function(n=1) {
            try { window._simMetrics.writes = (window._simMetrics.writes || 0) + Number(n || 0); window._simMetrics.savedAt = Date.now(); saveStored(window._simMetrics); render(); } catch(e){console.error('simIncWrites error', e);} };
        window._simIncDeletes = function(n=1) {
            try { window._simMetrics.deletes = (window._simMetrics.deletes || 0) + Number(n || 0); window._simMetrics.savedAt = Date.now(); saveStored(window._simMetrics); render(); } catch(e){console.error('simIncDeletes error', e);} };
        window._simAddStorageBytes = function(bytes) {
            try {
                const mb = (Number(bytes) || 0) / 1024 / 1024;
                window._simMetrics.storageMB = Math.round(((window._simMetrics.storageMB || 0) + mb) * 100) / 100;
                window._simMetrics.savedAt = Date.now();
                saveStored(window._simMetrics);
                render();
            } catch (e) { console.error('simAddStorageBytes error', e); }
        };

        function render() {            try {
                const storage = safeNum(window._simMetrics.storageMB || 0);
                const reads = safeNum(window._simMetrics.reads || 0);
                const writes = safeNum(window._simMetrics.writes || 0);
                const deletes = safeNum(window._simMetrics.deletes || 0);

                const sPct = pct(storage, STORAGE_LIMIT_MB);
                const rPct = pct(reads, READS_LIMIT);
                const wPct = pct(writes, WRITES_LIMIT);
                const dPct = pct(deletes, DELETES_LIMIT);

                // atualizar valores compactos
                if (els.storageValue) els.storageValue.textContent = `${storage.toFixed(2)} MB`;
                if (els.readsValue) els.readsValue.textContent = `${reads}`;
                if (els.writesValue) els.writesValue.textContent = `${writes}`;
                if (els.deletesValue) els.deletesValue.textContent = `${deletes}`;

                if (els.storagePct) els.storagePct.textContent = `${sPct.toFixed(1)}%`;
                if (els.readsPct) els.readsPct.textContent = `${rPct.toFixed(1)}%`;
                if (els.writesPct) els.writesPct.textContent = `${wPct.toFixed(1)}%`;
                if (els.deletesPct) els.deletesPct.textContent = `${dPct.toFixed(1)}%`;

                // atualizar barras de progresso
                if (els.storageBar) { els.storageBar.style.width = Math.min(100, sPct) + '%'; els.storageBar.style.boxShadow = sPct>100? 'inset 0 0 0 3px rgba(231,76,60,0.4)':'none'; }
                if (els.readsBar) { els.readsBar.style.width = Math.min(100, rPct) + '%'; els.readsBar.style.boxShadow = rPct>100? 'inset 0 0 0 3px rgba(231,76,60,0.4)':'none'; }
                if (els.writesBar) { els.writesBar.style.width = Math.min(100, wPct) + '%'; els.writesBar.style.boxShadow = wPct>100? 'inset 0 0 0 3px rgba(231,76,60,0.4)':'none'; }
                if (els.deletesBar) { els.deletesBar.style.width = Math.min(100, dPct) + '%'; els.deletesBar.style.boxShadow = dPct>100? 'inset 0 0 0 3px rgba(231,76,60,0.4)':'none'; }

                const exceeded = [];
                if (sPct > 100) exceeded.push('Armazenamento');
                if (rPct > 100) exceeded.push('Leituras');
                if (wPct > 100) exceeded.push('Gravações');
                if (dPct > 100) exceeded.push('Exclusões');

                if (els.summary) {
                    if (exceeded.length) {
                        els.summary.innerHTML = `<strong style="color:#ffb3b3">Atenção: ${exceeded.join(', ')} excedeu(m) o limite do plano.</strong>`;
                    } else {
                        els.summary.innerHTML = `Tudo OK — nenhum limite excedido.`;
                    }
                }

                saveStored(window._simMetrics);
            } catch (e) { console.error('Erro em render simulador', e); }
        }

        function reset() { try { window._simMetrics = { storageMB:0, reads:0, writes:0, deletes:0, savedAt: Date.now() }; localStorage.removeItem('firebasePlanUsage'); saveStored(window._simMetrics); render(); } catch(e){ console.error('simReset error', e);} }

        function parseMetrics(obj) {
            const res = {};
            function walk(o) {
                if (!o || typeof o !== 'object') return;
                for (const k of Object.keys(o)) {
                    try {
                        const v = o[k];
                        const key = String(k).toLowerCase();
                        if (typeof v === 'number') {
                            if (/storage|bytes|size/.test(key) && res.storageMB == null) {
                                // suposições simples: se o valor for grande, trate como bytes
                                if (v > 1024*1024) res.storageMB = Math.round((v/1024/1024) * 100) / 100;
                                else if (v > 1024) res.storageMB = Math.round((v/1024) * 100) / 100;
                                else res.storageMB = v;
                            }
                            if (/read|get|reads|documentreads|read_count/.test(key) && res.reads == null) res.reads = Math.round(v);
                            if (/write|writes|documentwrites|write_count/.test(key) && res.writes == null) res.writes = Math.round(v);
                            if (/delete|deletes|delete_count/.test(key) && res.deletes == null) res.deletes = Math.round(v);
                        }
                        if (v && typeof v === 'object') walk(v);
                    } catch(e){}
                }
            }
            walk(obj);
            return Object.keys(res).length ? res : null;
        }

        // helper global para permitir que outros pontos (ex.: Diagnóstico) preencham o simulador
        window._simParseAndStoreFirebaseMetrics = function(metrics) {
            try {
                const found = parseMetrics(metrics);
                if (!found) return null;
                if (found.storageMB != null && els.storage) els.storage.value = found.storageMB;
                if (found.reads != null && els.reads) els.reads.value = found.reads;
                if (found.writes != null && els.writes) els.writes.value = found.writes;
                if (found.deletes != null && els.deletes) els.deletes.value = found.deletes;
                // salvar e renderizar
                saveStored({ storage: safeNum(els.storage.value), reads: safeNum(els.reads.value), writes: safeNum(els.writes.value), deletes: safeNum(els.deletes.value), savedAt: Date.now() });
                render();
                return found;
            } catch (e) { console.error('parseAndStore error', e); return null; }
        };

        async function autoDetectUsage() {
            try {
                if (els.summary) { els.summary.textContent = 'Buscando métricas automaticamente...'; try { els.summary.style.color = 'var(--text-color)'; } catch(_){ } }
                let metrics = null;
                if (typeof window.getFirebaseUsageMetrics === 'function') {
                    metrics = typeof promiseWithTimeout === 'function' ? await promiseWithTimeout(window.getFirebaseUsageMetrics(), 7000, 'getFirebaseUsageMetrics') : await window.getFirebaseUsageMetrics();
                }
                if (!metrics && typeof window.debugFirebaseSignIn === 'function') {
                    metrics = typeof promiseWithTimeout === 'function' ? await promiseWithTimeout(window.debugFirebaseSignIn(), 7000, 'debugFirebaseSignIn') : await window.debugFirebaseSignIn();
                }
                if (metrics) {
                    const found = parseMetrics(metrics);
                    if (found) {
                        if (found.storageMB != null && els.storage) els.storage.value = found.storageMB;
                        if (found.reads != null && els.reads) els.reads.value = found.reads;
                        if (found.writes != null && els.writes) els.writes.value = found.writes;
                        if (found.deletes != null && els.deletes) els.deletes.value = found.deletes;
                        if (els.summary) els.summary.textContent = 'Métricas detectadas automaticamente.';
                        render();
                        return;
                    }
                }
            } catch (e) {
                console.error('autoDetectUsage error', e);
                if (els.summary) els.summary.textContent = 'Falha ao detectar métricas automaticamente.';
            }
        }

        function abrirModalFirebaseSimulator() {
            try {
                if (!modal) return;
                if (modal.style.display === 'flex') return;
                modal.style.display = 'flex';
                modal.dataset.open = 'true';
                modal.scrollTop = 0;
                try { document.body.classList.add('modal-open'); } catch(_){ }
                // tentar detectar métricas automaticamente ao abrir
                setTimeout(() => { try { autoDetectUsage(); } catch(_){ } }, 60);
            } catch (e) { console.error('abrirModalFirebaseSimulator error', e); }
        }
        function fecharModalFirebaseSimulator() { if (modal) { modal.style.display = 'none'; delete modal.dataset.open; } try { document.body.classList.remove('modal-open'); } catch(_){ } }

        if (btnOpen) btnOpen.addEventListener('click', abrirModalFirebaseSimulator);
        if (btnClose) btnClose.addEventListener('click', fecharModalFirebaseSimulator);
        if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) fecharModalFirebaseSimulator(); });

        // Simulação de relatórios removida conforme solicitado

        // Delegação de clique como fallback: garante abertura mesmo se listener não for anexado diretamente
        document.addEventListener('click', (e) => {
            try {
                const openBtn = e.target.closest && e.target.closest('#btn-open-firebase-simulator');
                if (openBtn) { abrirModalFirebaseSimulator(); return; }
                const closeBtn = e.target.closest && e.target.closest('#btnCloseFirebaseSimulator');
                if (closeBtn) { fecharModalFirebaseSimulator(); return; }
                // Hidden categories modal open/close via delegated clicks
                const openHiddenBtn = e.target.closest && e.target.closest('#btn-open-hidden-categories');
                if (openHiddenBtn) { abrirModalHiddenCategories(); return; }
                const closeHiddenBtn = e.target.closest && e.target.closest('#btnCloseHiddenCategories');
                if (closeHiddenBtn) { fecharModalHiddenCategories(); return; }
            } catch(_){ }
        });

        // Funções para o modal de Categorias Ocultas
        function abrirModalHiddenCategories(){
            try{
                const modal = document.getElementById('modalHiddenCategories');
                if(!modal) return;
                if(modal.style.display === 'flex') return;
                updateHiddenCategoriesBox();
                modal.style.display = 'flex';
                modal.dataset.open = 'true';
                modal.scrollTop = 0;
                try{ document.body.classList.add('modal-open'); }catch(_){ }
            }catch(e){ console.error('abrirModalHiddenCategories error', e); }
        }
        function fecharModalHiddenCategories(){
            const modal = document.getElementById('modalHiddenCategories');
            if(modal){ modal.style.display = 'none'; delete modal.dataset.open; }
            try{ document.body.classList.remove('modal-open'); }catch(_){ }
        }
        // fechar ao clicar fora
        const modalHidden = document.getElementById('modalHiddenCategories'); if(modalHidden) modalHidden.addEventListener('click', (e)=>{ if(e.target === modalHidden) fecharModalHiddenCategories(); });
        // associar botão de abrir
        const btnOpenHidden = document.getElementById('btn-open-hidden-categories'); if(btnOpenHidden) btnOpenHidden.addEventListener('click', abrirModalHiddenCategories);
        // associar botão de fechar (se existir)
        const btnCloseHidden = document.getElementById('btnCloseHiddenCategories'); if(btnCloseHidden) btnCloseHidden.addEventListener('click', fecharModalHiddenCategories);




        loadStored();
        render();

        // Force-override `pluginDigitalBox` click to open the plugin modal and prevent legacy downloads
        (function(){
            try {
                const p = document.getElementById('pluginDigitalBox');
                if (p && p.parentNode) {
                    const newP = p.cloneNode(true);
                    p.parentNode.replaceChild(newP, p);
                    const el = document.getElementById('pluginDigitalBox');
                    if (el) {
                        el.addEventListener('click', (e) => {
                            try { e.stopImmediatePropagation(); e.preventDefault(); } catch(_){ }
                            const modal = document.getElementById('modalPlugins');
                            if (modal) {
                                modal.style.display = 'flex';
                                modal.dataset.open = 'true';
                                try { document.body.classList.add('modal-open'); } catch(_){ }
                            }
                        });
                    }
                }
            } catch (e) { console.error('override pluginDigitalBox error', e); }
        })();

    } catch (err) { console.error('Simulador Firebase modal erro', err); }
})();

// Botão de diagnóstico Firebase
const btnFirebaseDiagnose = document.getElementById('btn-firebase-diagnose');
if (btnFirebaseDiagnose) {
    btnFirebaseDiagnose.addEventListener('click', async () => {
        try {
            btnFirebaseDiagnose.disabled = true;
            mostrarMensagem('Aguarde', 'Executando diagnóstico...');
            if (typeof window.debugFirebaseSignIn !== 'function') {
                try { fecharMensagem(false); } catch(_){}
                mostrarMensagem('Informação', 'Função de diagnóstico não disponível.');
                return;
            }
            const result = await window.debugFirebaseSignIn();
            try { fecharMensagem(false); } catch(_){}
            const pretty = (() => { try { return JSON.stringify(result, null, 2); } catch(e){ return String(result); } })();
            const diagHtml = `
                <pre style="text-align:left;white-space:pre-wrap;max-height:400px;overflow:auto;">${pretty}</pre>
                <div id="diagButtonsContainer" style="display:flex;justify-content:center;gap:12px;margin-top:12px;"></div>`;
            mostrarMensagem('Resultado do diagnóstico', diagHtml);
            // mover o botão OK gerado por mostrarMensagem para dentro do container e adicionar o botão 'Ir para Firebase'
            setTimeout(() => {
                try {
                    const container = document.getElementById('diagButtonsContainer');
                    const okBtn = document.getElementById('btnFecharMensagem');
                    if (container && okBtn) {
                        container.appendChild(okBtn);
                    }
                    if (container) {
                        // criar botão Ir para Firebase
                        if (!document.getElementById('btnIrFirebase')) {
                            const btnIr = document.createElement('button');
                            btnIr.id = 'btnIrFirebase';
                            btnIr.textContent = 'Ir para Firebase';
                            btnIr.style.background = '#1f2937';
                            btnIr.style.color = '#ffffff';
                            btnIr.style.padding = '8px 12px';
                            btnIr.style.borderRadius = '8px';
                            btnIr.style.border = 'none';
                            container.appendChild(btnIr);
                            btnIr.addEventListener('click', () => {
                                try {
                                    const projectId = (typeof firebaseConfig !== 'undefined' && firebaseConfig && firebaseConfig.projectId) ? firebaseConfig.projectId : 'keymaster-e027d';
                                    const url = `https://console.firebase.google.com/project/${projectId}/overview`;
                                    window.open(url, '_blank', 'noopener');
                                } catch (e) { console.error('Erro ao abrir Firebase console', e); }
                            }, { once: true });
                        }
                    }
                } catch (e) { console.error('Erro ao anexar botão Firebase no modal:', e); }
            }, 80);
        } catch (err) {
            console.error('btnFirebaseDiagnose error', err);
            try { fecharMensagem(false); } catch(_){}
            mostrarMensagem('Erro', 'Falha ao executar diagnóstico. Veja o console.');
        } finally {
            btnFirebaseDiagnose.disabled = false;
        }
    });
}

// Integrar diagnóstico com o Simulador: quando o botão de diagnóstico é clicado, executar diagnóstico também para popular métricas automaticamente
try {
    if (btnFirebaseDiagnose) {
        btnFirebaseDiagnose.addEventListener('click', () => {
            setTimeout(async () => {
                try {
                    if (typeof window.debugFirebaseSignIn === 'function' && typeof window._simParseAndStoreFirebaseMetrics === 'function') {
                        const dbg = typeof promiseWithTimeout === 'function' ? await promiseWithTimeout(window.debugFirebaseSignIn(), 7000, 'debugFirebaseSignIn-sim') : await window.debugFirebaseSignIn();
                        window._simParseAndStoreFirebaseMetrics(dbg);
                    }
                } catch(_) { }
            }, 900);
        });
    }
} catch(_) {}

input.addEventListener('input', () => {
  const value = input.value;
  if (value) {
      setTimeout(() => { input.type = 'password'; }, 500);
      if (index < pinInputs.length - 1) {
          pinInputs[index + 1].focus();
      } else {
          verificarPin();
      }
  } else {
      input.type = 'tel';
  }
});
input.addEventListener('focus', () => { input.type = 'tel'; });
});

forgotPinLink.addEventListener('click', () => mostrarTela('acessoEspecial'));
btnVerificarSenhaEspecial.addEventListener('click', verificarSenhaParaRecuperarPin);
btnVoltarAcessoEspecial.addEventListener('click', () => mostrarTela('anotacoesLogin'));
btnPinRecuperadoConcluido.addEventListener('click', () => mostrarTela('anotacoesLogin'));
if (btnCancelarSenha) {
    btnCancelarSenha.addEventListener('click', (e) => {
        try {
            if (e && e.isTrusted === false) {
                console.log('[SAFE-CANCEL] Ignoring synthetic click on btnCancelarSenha');
                return;
            }
        } catch(_){}
        try {
            const shield = !!window.__modalClickShield;
            const last = window.__lastModalOpenTime || 0;
            const age = Date.now() - last;
            if (shield || (last && age < 700) || (modalSenhaDiv && modalSenhaDiv.dataset && modalSenhaDiv.dataset.opening === 'true')) {
                console.log('[SAFE-CANCEL] btnCancelarSenha ignored due to shield/opening', { shield, age });
                return;
            }
        } catch(_){}
        fecharModalSenha();
    });
}
formSenha.addEventListener('submit', salvarSenha);
if (btnCancelarAnotacao) {
    btnCancelarAnotacao.addEventListener('click', (e) => {
        try {
            if (e && e.isTrusted === false) {
                console.log('[SAFE-CANCEL] Ignoring synthetic click on btnCancelarAnotacao');
                return;
            }
        } catch(_){}
        try {
            const shield = !!window.__modalClickShield;
            const last = window.__lastModalOpenTime || 0;
            const age = Date.now() - last;
            if (shield || (last && age < 700) || (modalAnotacaoDiv && modalAnotacaoDiv.dataset && modalAnotacaoDiv.dataset.opening === 'true')) {
                console.log('[SAFE-CANCEL] btnCancelarAnotacao ignored due to shield/opening', { shield, age });
                return;
            }
        } catch(_){}
        fecharModalAnotacao();
    });
}
modalSenhaDiv.addEventListener('click', (e) => {
    try {
        // Ignorar cliques residuais logo após a abertura do modal de Senhas
        const shield = !!window.__modalClickShield;
        const last = window.__lastModalOpenTime || 0;
        const age = Date.now() - last;
        if (e.target === modalSenhaDiv) {
            if (shield || (last && age < 480) || modalSenhaDiv.dataset.opening === 'true') {
                console.log('[MODAL-SHIELD] Ignoring modalSenhaDiv click (shield active or recent open)', { shield, age, opening: modalSenhaDiv.dataset.opening });
                return;
            }
            fecharModalSenha();
        }
    } catch (err) {
        console.warn('[MODAL-SHIELD] modalSenhaDiv click handler error, ignoring close', err);
        // Não chamar fecharModalSenha() aqui sem passar pelas checagens de shield/age/opening
    }
});

// Desabilitar fechamento via clique no backdrop do modal de Anotações
// para evitar fechamentos acidentais/reentrância causados por reflows ou
// handlers concorrentes. Usuário deve usar o botão 'Voltar' para fechar.
if (modalAnotacaoDiv) {
    modalAnotacaoDiv.addEventListener('click', (e) => {
        try {
            if (e && e.isTrusted === false) {
                console.log('[MODAL-BACKDROP] Ignoring synthetic backdrop click (anotacoes)');
                return;
            }
            if (e.target === modalAnotacaoDiv) {
                console.log('[MODAL-BACKDROP] Backdrop click ignored for modalAnotacaoDiv');
            }
        } catch (err) {
            console.warn('[MODAL-BACKDROP] error handling backdrop click (anotacoes)', err);
        }
    });
}
formAnotacao.addEventListener('submit', salvarAnotacao);

// ========== FUNCIONALIDADE DE MÚLTIPLOS CARTÕES ==========
(function() {
    const btnAdicionarcartao = document.getElementById('btnAdicionarcartão');
    const btnAdicionarcartaoPadrao = document.getElementById('btnAdicionarcartãoPadrao');
    const cartoesListContainer = document.getElementById('cartoesListContainer');
    let cartoes = [];
    let nextCardId = 1;

    const hasContainer = () => !!cartoesListContainer;

    if (btnAdicionarcartao && hasContainer()) {
        btnAdicionarcartao.addEventListener('click', () => adicionarNovocartao());
    }

    if (btnAdicionarcartaoPadrao && hasContainer()) {
        btnAdicionarcartaoPadrao.addEventListener('click', (e) => {
            // Ignorar cliques sintéticos/automatizados
            if (e && e.isTrusted === false) {
                console.log('[SAFE] Ignoring synthetic click on btnAdicionarcartaoPadrao');
                return;
            }

            // Ignorar cliques imediatamente após a abertura do modal (shield)
            if (window && window.__modalClickShield) {
                console.log('[SAFE] Ignoring btnAdicionarcartaoPadrao due to modal opening shield');
                return;
            }
            const lastOpen = window.__lastModalOpenTime || 0;
            if (lastOpen && (Date.now() - lastOpen) < 480) {
                console.log('[SAFE] Ignoring btnAdicionarcartaoPadrao due to recent modal open');
                return;
            }

            // Só permitir se o modal de Senhas estiver visível (protege contra triggers fora do contexto)
            const modal = document.getElementById('modalSenha');
            if (!modal || (modal.style && (modal.style.display === 'none' || modal.style.display === ''))) {
                console.log('[SAFE] Ignoring btnAdicionarcartaoPadrao click because modalSenha is not visible');
                return;
            }

            const cartaoPadrao = obtercartãoPadrao();
            if (cartaoPadrao && cartaoPadrao.numero) {
                // Evitar duplicatas por número (ignorar espaços ao comparar)
                const numeroPadrao = (cartaoPadrao.numero || '').replace(/\s/g, '');
                const already = cartoes.some(c => (c.numero || '').replace(/\s/g, '') === numeroPadrao && numeroPadrao !== '');
                if (already) {
                    console.log('[SAFE] cartão padrão já presente, ignorando adição duplicada');
                    mostrarMensagem('Aviso', 'O cartão padrão já foi adicionado.');
                    return;
                }
                // Marcar que este cartão foi inserido a partir do Cartão Padrão (internal flag)
                const toInsert = Object.assign({}, cartaoPadrao, { __autoInsertedFromDefault: true });
                adicionarNovocartao(toInsert);
            } else {
                mostrarMensagem('Aviso', 'Nenhum cartão padrão configurado. Configure no formulário automático.');
            }
        });
    }

    function obtercartãoPadrao() {
        try {
            const cartaoPadraoStr = localStorage.getItem('cartãoPadrao');
            if (cartaoPadraoStr) {
                return JSON.parse(cartaoPadraoStr);
            }
        } catch (err) {
            console.error('Erro ao obter cartão padrão:', err);
        }
        return null;
    }

    window.obtercartãoPadraoGlobal = obtercartãoPadrao;

    function adicionarNovocartao(cardData = null) {
        if (!hasContainer()) return;

        // Normalizar número para comparação (remover espaços)
        const numeroSanitizado = (cardData && cardData.numero) ? (cardData.numero || '').replace(/\s/g, '') : '';
        if (numeroSanitizado) {
            const exists = cartoes.some(c => (c.numero || '').replace(/\s/g, '') === numeroSanitizado);
            if (exists) {
                // Já existe cartão com esse número — não duplicar
                console.log('[SAFE] adicionarNovocartao: cartão com mesmo número já existe, ignorando');
                return;
            }
        }

        const cardId = cardData?.id || Date.now() + nextCardId++;
        const cartao = cardData ? Object.assign({ id: cardId }, cardData) : {
            id: cardId,
            numero: '',
            titular: '',
            validade: '',
            cvv: '',
            bandeira: ''
        };

        // Flags internas: indicar se foi inserido automaticamente a partir do Cartão Padrão
        if (cartao.__autoInsertedFromDefault) cartao.__auto = true;
        cartao.__edited = !!cartao.__edited;

        cartoes.push(cartao);
        renderizarcartao(cartao);
    }

    function renderizarcartao(cartao) {
        if (!hasContainer()) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'card-item-wrapper';
        wrapper.dataset.cardId = cartao.id;

        wrapper.innerHTML = `
            <div class="card-fields-header">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                    cartão ${cartoes.length}
                </h3>
                <button type="button" class="btn-remove-card" data-card-id="${cartao.id}" title="Remover cartão">×</button>
            </div>
            
            <div class="card-icon-visual" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%); border: 1px solid rgba(255, 255, 255, 0.10); border-radius: 14px; padding: 18px; margin-bottom: 20px; box-shadow: 0 10px 28px rgba(0, 0, 0, 0.20);">
                <div class="card-chip" style="width: 42px; height: 32px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%); border-radius: 6px; margin-bottom: 14px; box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.4), 0 4px 14px rgba(0, 0, 0, 0.35);"></div>
                <div class="card-number-preview" style="color: #ffffff; font-family: 'SF Mono', 'Consolas', 'Roboto Mono', monospace;">•••• •••• •••• ••••</div>
                <div class="card-holder-preview" style="color: rgba(255, 255, 255, 0.85);">NOME DO TITULAR</div>
            </div>
            
            <div class="card-form-grid">
                <div class="card-input-group full-width">
                    <label>Número do cartão</label>
                    <input type="text" class="input-card-number" data-card-id="${cartao.id}" placeholder="0000 0000 0000 0000" maxlength="19" inputmode="numeric" autocomplete="off" value="${cartao.numero || ''}" />
                </div>
                
                <div class="card-input-group full-width">
                    <label>Nome do Titular</label>
                    <input type="text" class="input-card-holder" data-card-id="${cartao.id}" placeholder="Como está no cartão" autocomplete="off" style="text-transform: uppercase;" value="${cartao.titular || ''}" />
                </div>
                
                <div class="card-input-group">
                    <label>Validade</label>
                    <input type="text" class="input-card-expiry" data-card-id="${cartao.id}" placeholder="MM/AA" maxlength="5" inputmode="numeric" autocomplete="off" value="${cartao.validade || ''}" />
                </div>
                
                <div class="card-input-group">
                    <label>CVV</label>
                    <input type="text" class="input-card-cvv" data-card-id="${cartao.id}" placeholder="000" maxlength="4" inputmode="numeric" autocomplete="off" value="${cartao.cvv || ''}" />
                </div>
                
                <div class="card-input-group full-width">
                    <label>Bandeira (Opcional)</label>
                    <input type="text" class="input-card-brand" data-card-id="${cartao.id}" placeholder="Visa, Mastercard, etc." autocomplete="off" value="${cartao.bandeira || ''}" />
                </div>
            </div>
        `;

        cartoesListContainer.appendChild(wrapper);

        const numberInput = wrapper.querySelector('.input-card-number');
        const holderInput = wrapper.querySelector('.input-card-holder');
        const expiryInput = wrapper.querySelector('.input-card-expiry');
        const cvvInput = wrapper.querySelector('.input-card-cvv');
        const brandInput = wrapper.querySelector('.input-card-brand');
        const removeBtn = wrapper.querySelector('.btn-remove-card');
        const numberPreview = wrapper.querySelector('.card-number-preview');
        const holderPreview = wrapper.querySelector('.card-holder-preview');

        numberInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 16) value = value.substring(0, 16);
            const formatted = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formatted;

            atualizarcartao(cartao.id, 'numero', formatted);
            // Marca como editado pelo usuário
            try { cartao.__edited = true; } catch(_) {}

            if (value.length === 0) {
                numberPreview.textContent = '•••• •••• •••• ••••';
            } else {
                const groups = value.match(/.{1,4}/g) || [];
                const preview = groups.map((group, idx) => (idx === groups.length - 1 ? group : '••••')).join(' ');
                numberPreview.textContent = preview;
            }
        });

        holderInput.addEventListener('input', (e) => {
            const value = e.target.value.toUpperCase();
            e.target.value = value;
            atualizarcartao(cartao.id, 'titular', value);
            holderPreview.textContent = value || 'NOME DO TITULAR';
            try { cartao.__edited = true; } catch(_) {}
        });

        expiryInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.substring(0, 4);
            if (value.length >= 2) {
                value = `${value.substring(0, 2)}/${value.substring(2)}`;
            }
            e.target.value = value;
            atualizarcartao(cartao.id, 'validade', value);
            try { cartao.__edited = true; } catch(_) {}
        });

        cvvInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            atualizarcartao(cartao.id, 'cvv', value);
            try { cartao.__edited = true; } catch(_) {}
        });

        brandInput.addEventListener('input', (e) => {
            atualizarcartao(cartao.id, 'bandeira', e.target.value);
            try { cartao.__edited = true; } catch(_) {}
        });

        removeBtn.addEventListener('click', () => removercartao(cartao.id));

        if (cartao.numero) numberInput.dispatchEvent(new Event('input'));
        if (cartao.titular) holderInput.dispatchEvent(new Event('input'));
    }

    function atualizarcartao(cardId, campo, valor) {
        const cartao = cartoes.find((c) => c.id === cardId);
        if (cartao) cartao[campo] = valor;
    }

    function removercartao(cardId) {
        cartoes = cartoes.filter((c) => c.id !== cardId);
        if (hasContainer()) {
            const wrapper = cartoesListContainer.querySelector(`[data-card-id="${cardId}"]`);
            if (wrapper) wrapper.remove();
            cartoesListContainer.querySelectorAll('.card-item-wrapper').forEach((node, idx) => {
                const h3 = node.querySelector('h3');
                if (h3) {
                    h3.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        cartão ${idx + 1}
                    `;
                }
            });
        }
    }

    window.obterCartoes = function obterCartoes() {
        // Retornar apenas cartões com número válido e, caso tenham sido inseridos
        // automaticamente a partir do Cartão Padrão, somente se o usuário os editou.
        return cartoes.filter((c) => c.numero && c.numero.trim() !== '' && !(c.__auto && !c.__edited));
    };

    window.carregarDadoscartão = function carregarDadoscartao(cartoesData) {
        limparTodosCartoes();
        if (cartoesData && Array.isArray(cartoesData)) {
            cartoesData.forEach((cartao) => adicionarNovocartao(cartao));
        } else if (cartoesData && typeof cartoesData === 'object') {
            adicionarNovocartao(cartoesData);
        }
    };

    window.limparDadoscartão = function limparDadosCartao() {
        limparTodosCartoes();
    };

    window.carregarCartoes = function carregarCartoes(cartoesData) {
        limparTodosCartoes();
        if (!cartoesData) return;
        
        const cartoesArray = Array.isArray(cartoesData) ? cartoesData : [cartoesData];
        cartoesArray.forEach((cartaoData) => {
            if (cartaoData && cartaoData.numero) {
                const cartao = {
                    id: nextCardId++,
                    numero: cartaoData.numero || '',
                    titular: cartaoData.titular || '',
                    validade: cartaoData.validade || '',
                    cvv: cartaoData.cvv || '',
                    bandeira: cartaoData.bandeira || ''
                };
                cartoes.push(cartao);
                renderizarcartao(cartao);
            }
        });
    };

    function limparTodosCartoes() {
        cartoes = [];
        if (hasContainer()) cartoesListContainer.innerHTML = '';
        nextCardId = 1;
    }
})();
// ========== FIM DA FUNCIONALIDADE DE MÚLTIPLOS CARTÕES ==========

function obterLabelTipoFormatacao(tipo) {
    const labels = { cpf: 'CPF', telefone: 'Telefone', email: 'E-mail', senha: 'Senha' };
    return labels[tipo] || tipo;
}

function aplicarFormatacaoPersonalizada(tipo) {
    const input = document.getElementById('inputCampoFormatacao');
    if (!input) return;

    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);

    const inputAtualizado = document.getElementById('inputCampoFormatacao');
    const placeholders = {
        cpf: 'Digite o CPF',
        telefone: 'Digite o telefone',
        email: 'Digite o e-mail',
        senha: 'Digite a senha'
    };
    inputAtualizado.placeholder = placeholders[tipo] || 'Digite o valor';

    inputAtualizado.type = 'text';
    inputAtualizado.removeAttribute('maxLength');
    inputAtualizado.inputMode = 'text';

    if (tipo === 'cpf') {
        inputAtualizado.maxLength = 14;
        inputAtualizado.inputMode = 'numeric';
        inputAtualizado.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 11) val = val.substring(0, 11);
            if (val.length > 9) {
                val = val.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (val.length > 6) {
                val = val.replace(/(\d{3})(\d{3})(\d+)/, '$1.$2.$3');
            } else if (val.length > 3) {
                val = val.replace(/(\d{3})(\d+)/, '$1.$2');
            }
            e.target.value = val;
        });
    } else if (tipo === 'telefone') {
        inputAtualizado.maxLength = 15;
        inputAtualizado.inputMode = 'numeric';
        inputAtualizado.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 11) val = val.substring(0, 11);
            if (val.length === 11) {
                val = val.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (val.length === 10) {
                val = val.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (val.length > 6) {
                val = val.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');
            } else if (val.length > 2) {
                val = val.replace(/(\d{2})(\d+)/, '($1) $2');
            }
            e.target.value = val;
        });
    } else if (tipo === 'email') {
        inputAtualizado.type = 'email';
        inputAtualizado.inputMode = 'email';
    }
}

function analisarForcaSenha(senha) {
    if (!senha) return { strength: 'none', score: 0, label: '' };

    let score = 0;
    if (senha.length >= 8) score += 1;
    if (senha.length >= 12) score += 1;
    if (senha.length >= 16) score += 1;
    if (/[a-z]/.test(senha)) score += 1;
    if (/[A-Z]/.test(senha)) score += 1;
    if (/[0-9]/.test(senha)) score += 1;
    if (/[^a-zA-Z0-9]/.test(senha)) score += 2;

    const uniqueChars = new Set(senha).size;
    if (uniqueChars >= senha.length * 0.7) score += 1;

    if (score <= 3) return { strength: 'weak', score, label: 'Senha Fraca' };
    if (score <= 6) return { strength: 'medium', score, label: 'Senha Média' };
    return { strength: 'strong', score, label: 'Senha Forte' };
}

const passwordField = document.getElementById('inputSenha');
const passwordStrengthContainer = document.querySelector('.password-strength-container');
const passwordStrengthFill = document.getElementById('password-strength-fill');
const passwordStrengthText = document.getElementById('password-strength-text');
if (passwordField && passwordStrengthContainer && passwordStrengthFill && passwordStrengthText) {
    passwordField.addEventListener('input', function handlePasswordStrength() {
        const senha = this.value;
        if (!senha) {
            passwordStrengthContainer.style.display = 'none';
            passwordStrengthFill.className = 'password-strength-fill';
            passwordStrengthText.className = 'password-strength-text';
            passwordStrengthText.textContent = '';
            return;
        }

        const result = analisarForcaSenha(senha);
        passwordStrengthContainer.style.display = 'block';

        passwordStrengthFill.classList.remove('weak', 'medium', 'strong');
        passwordStrengthText.classList.remove('weak', 'medium', 'strong');

        if (result.strength !== 'none') {
            passwordStrengthFill.classList.add(result.strength);
            passwordStrengthText.classList.add(result.strength);
            passwordStrengthText.textContent = result.label;
        }
    });
}

const inputTipoFormatacaoEl = document.getElementById('inputTipoFormatacao');
if (inputTipoFormatacaoEl) {
    inputTipoFormatacaoEl.addEventListener('change', function handleTipoFormatacaoChange() {
        const campoFormatacaoContainer = document.getElementById('campo-formatacao-container');
        const tipoSelecionado = this.value;

        if (!campoFormatacaoContainer) return;

        if (tipoSelecionado) {
            campoFormatacaoContainer.style.display = 'block';
            aplicarFormatacaoPersonalizada(tipoSelecionado);
            setTimeout(() => {
                const inputCampo = document.getElementById('inputCampoFormatacao');
                if (inputCampo && !isMobileDevice()) inputCampo.focus();
            }, 100);
        } else {
            campoFormatacaoContainer.style.display = 'none';
            const inputCampo = document.getElementById('inputCampoFormatacao');
            if (inputCampo) inputCampo.value = '';
        }
    });
}

// Toggle de campos extras (Anotação)
const btnMaisInfoAnotacao = document.getElementById('btnMaisInfoAnotacao');
const extraFieldsAnotacao = document.getElementById('extraFieldsAnotacao');
if (btnMaisInfoAnotacao && extraFieldsAnotacao) {
    btnMaisInfoAnotacao.addEventListener('click', () => {
        const isOpen = extraFieldsAnotacao.style.display !== 'none';
        const nextState = !isOpen;
        extraFieldsAnotacao.style.display = nextState ? 'flex' : 'none';
        btnMaisInfoAnotacao.setAttribute('aria-expanded', nextState ? 'true' : 'false');
        btnMaisInfoAnotacao.textContent = nextState ? '− Menos informações' : '+ Mais informações';
        if (nextState) updateClearButtonsFormAnotacao();
    });
}

// Buscar na web (Anotações)
const searchNotesBtn = document.getElementById('search-notes-btn');
const inputLinksAnotacao = document.getElementById('inputLinksAnotacao');
if (searchNotesBtn && inputLinksAnotacao) {
    searchNotesBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const query = inputLinksAnotacao.value.trim();
        if (query) {
            window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
        }
    });
    inputLinksAnotacao.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = inputLinksAnotacao.value.trim();
            if (query) {
                window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
            }
        }
    });
}

// Gmail helper (Anotações)
const gmailHelperAnot = document.getElementById('gmail-helper-anotacao');
const inputEmailAnot = document.getElementById('inputEmailAnotacao');
if (gmailHelperAnot && inputEmailAnot) {
    const handleGmailHelperVisibilityAnot = () => {
        const hasAt = inputEmailAnot.value.includes('@');
        const empty = inputEmailAnot.value.trim() === '';
        if (!empty && !hasAt) gmailHelperAnot.classList.add('visible');
        else gmailHelperAnot.classList.remove('visible');
    };
    inputEmailAnot.addEventListener('input', handleGmailHelperVisibilityAnot);
    handleGmailHelperVisibilityAnot();
    gmailHelperAnot.addEventListener('click', () => {
        let val = inputEmailAnot.value.trim();
        if (val && !val.includes('@')) {
            inputEmailAnot.value = `${val}@gmail.com`;
        } else if (!val) {
            inputEmailAnot.value = '@gmail.com';
        }
        inputEmailAnot.dispatchEvent(new Event('input', { bubbles: true }));
        updateClearButtonsFormAnotacao();
    });
}

// Mostrar/ocultar botões limpar conforme digitação (Anotações)
document.querySelectorAll('#formAnotacao .input-container input, #formAnotacao .input-container textarea').forEach(input => {
    input.addEventListener('input', () => {
        const btn = input.parentElement.querySelector('.btn-clear-field');
        if (btn) btn.style.display = input.value ? 'block' : 'none';
    });
});
// Regras de formatação (Anotações) — iguais às do formulário de Senhas
const inputCpfAnotacao = document.getElementById('inputCpfAnotacao');
const inputTelefoneAnotacao = document.getElementById('inputTelefoneAnotacao');
if (inputCpfAnotacao) inputCpfAnotacao.addEventListener('input', (e) => formatarCPF(e.target));
if (inputTelefoneAnotacao) inputTelefoneAnotacao.addEventListener('input', (e) => formatarTelefone(e.target));

btnGoToSettings.addEventListener('click', () => mostrarTela('autoFillSettings'));
btnAutoFillBackToApp.addEventListener('click', () => mostrarTela('app'));
btnGoToAutoFillForm.addEventListener('click', abrirPaginaAutoFillForm);
btnAutoFillFormBack.addEventListener('click', () => mostrarTela('autoFillSettings'));
formAutoFillData.addEventListener('submit', salvarFormularioAutomatico);
btnAutoFillTrigger.addEventListener('click', preencherFormularioSenha);
if (btnDefaultCard) btnDefaultCard.addEventListener('click', abrirModalCartaoPadrao);
if (btnDefaultCardBack && defaultCardModal) btnDefaultCardBack.addEventListener('click', fecharModalCartaoPadrao);
if (btnDefaultCardSave) btnDefaultCardSave.addEventListener('click', salvarCartaoPadrao);
if (btnDefaultCardClear) btnDefaultCardClear.addEventListener('click', limparCartaoPadrao);
btnInstalar.addEventListener('click', () => iniciarInstalacao('install'));
    // use guarded overlay handler to avoid immediate close triggered by the same click
    overlay.removeEventListener('click', fecharMensagem);
    overlay.addEventListener('click', handleOverlayClick);
versionLink.addEventListener('click', abrirModalObservacoes);
btnSalvarObservacoes.addEventListener('click', salvarObservacoesEBaixarImagem);
{
    const _btnRedefinirTempo = document.getElementById('btnRedefinirTempo');
    if (_btnRedefinirTempo) {
        // Ao clicar, abrimos diretamente o seletor de data (fallback funcional) em vez do popover
        _btnRedefinirTempo.addEventListener('click', (e) => {
            e.stopPropagation();
            try { openDateSelectorFromBtn(_btnRedefinirTempo); } catch (err) { console.warn('openDateSelectorFromBtn failed', err); }
        });
    }
}
inputCpf.addEventListener('input', (e) => formatarCPF(e.target));
inputTelefone.addEventListener('input', (e) => formatarTelefone(e.target));
document.getElementById('autofill-cpf').addEventListener('input', (e) => formatarCPF(e.target));
document.getElementById('autofill-telefone').addEventListener('input', (e) => formatarTelefone(e.target));
inputEmail.addEventListener('input', handleGmailHelperVisibility);
gmailHelperBtn.addEventListener('click', () => {
inputEmail.value += '@gmail.com';
    inputEmail.dispatchEvent(new Event('input', { bubbles: true }));
    try {
        inputEmail.focus({ preventScroll: true });
        console.log('[DEBUG] gmailHelper: focused inputEmail with preventScroll');
    } catch (err) {
        inputEmail.focus();
        console.log('[DEBUG] gmailHelper: focused inputEmail fallback without preventScroll');
    }
});
inputLinks.addEventListener('input', handleAbreviacaoLogic);
btnUpdates.addEventListener('click', abrirModalDesenvolvimento);
btnAtivarUpdate.addEventListener('click', ativarUpdate);
btnDesativarUpdate.addEventListener('click', desativarUpdate);
btnApagarDados.addEventListener('click', apagarTodosOsDados);
btnRealizarUpload.addEventListener('click', promptForUpdateCertificate);
updateFileInput.addEventListener('change', handleUpdateFileUpload);


// Campos personalizados (Senhas) - apply rules & formatting
const inputCustomTypeSenha = document.getElementById('inputCustomTypeSenha');
const inputCustomValueSenha = document.getElementById('inputCustomValueSenha');
if (inputCustomTypeSenha && inputCustomValueSenha) {
    const applyTypeRulesSenha = () => {
        const tipo = inputCustomTypeSenha.value;
        inputCustomValueSenha.removeEventListener('input', customSenhaListener);
        inputCustomValueSenha.inputmode = '';
        inputCustomValueSenha.maxLength = '';
        inputCustomValueSenha.placeholder = 'Valor';
        if (tipo === 'nascimento') {
            inputCustomValueSenha.inputmode = 'numeric';
            inputCustomValueSenha.maxLength = 10;
            inputCustomValueSenha.placeholder = 'DD/MM/AAAA';
            inputCustomValueSenha.addEventListener('input', customSenhaListener);
        } else if (tipo === 'telefone') {
            inputCustomValueSenha.inputmode = 'numeric';
            inputCustomValueSenha.maxLength = 13;
            inputCustomValueSenha.removeEventListener('input', customSenhaListener);
            inputCustomValueSenha.addEventListener('input', (e) => formatarTelefone(e.target));
        } else if (tipo === 'codigo_seguranca') {
            inputCustomValueSenha.inputmode = 'numeric';
            inputCustomValueSenha.maxLength = 6;
            inputCustomValueSenha.removeEventListener('input', customSenhaListener);
            inputCustomValueSenha.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/\D/g,'').substring(0,6); });
        } else if (tipo === 'cpf_custom') {
            inputCustomValueSenha.inputmode = 'numeric';
            inputCustomValueSenha.maxLength = 14;
            inputCustomValueSenha.removeEventListener('input', customSenhaListener);
            inputCustomValueSenha.addEventListener('input', (e) => formatarCPF(e.target));
        } else if (tipo === 'senha_numerica') {
            inputCustomValueSenha.inputmode = 'numeric';
            inputCustomValueSenha.maxLength = 20;
            inputCustomValueSenha.removeEventListener('input', customSenhaListener);
            inputCustomValueSenha.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/\D/g,'').substring(0,20); });
        } else {
            inputCustomValueSenha.removeEventListener('input', customSenhaListener);
        }
        updateClearButtonsFormSenha && updateClearButtonsFormSenha();
    };
    function customSenhaListener(e) { formatarDataNascimento(e.target); }
    inputCustomTypeSenha.addEventListener('change', applyTypeRulesSenha);
    applyTypeRulesSenha();
}

// Gerenciar lista dinâmica de campos personalizados (Senhas)
const customFieldsList = document.getElementById('customFieldsList');
const btnAddCustomField = document.getElementById('btnAddCustomField');
function createCustomFieldRow(type = '', value = '') {
    const idx = Date.now() + Math.floor(Math.random() * 1000);
    const row = document.createElement('div');
    row.className = 'custom-field-row input-container';
    row.dataset.index = idx;
    row.innerHTML = `
        <select class="input-custom-type" aria-label="Tipo do campo personalizado" style="width:100%; padding:10px 12px; border-radius:12px; margin-bottom:8px;">
            <option value="">Selecionar tipo (opcional)</option>
            <option value="frase_seguranca">Frase de segurança</option>
            <option value="chave_seguranca">Chave de segurança</option>
            <option value="dica_extra">Dica extra</option>
            <option value="senha_alfanumerica">Senha alfanumérica</option>
            <option value="cpf_custom">CPF</option>
            <option value="codigo_seguranca">Código de segurança</option>
            <option value="telefone">Telefone</option>
            <option value="email">E-mail</option>
            <option value="nascimento">Data de nascimento</option>
            <option value="senha_numerica">Senha numérica</option>
            <option value="agencia">Agência</option>
            <option value="conta">Conta</option>
            <option value="personalizado">Personalizado</option>
        </select>
        <div class="input-container" style="display:flex;align-items:center;gap:8px;">
            <input type="text" class="input-custom-value" placeholder="Valor" autocomplete="off" style="flex:0 1 220px;min-width:120px;max-width:320px;" />
            <div style="display:flex;align-items:center;gap:8px;">
                <button type="button" class="btn-clear-field" title="Limpar campo" style="height:34px;min-width:34px;">×</button>
                <button type="button" class="btn-remove-custom" title="Remover" style="margin-left:6px; display:inline-flex; align-items:center; justify-content:center; width:34px; height:34px; min-width:34px; border-radius:8px; background:transparent; border:0; color:inherit;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true" focusable="false"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
                </button>
            </div>
        </div>
    `;
    // hooks
    const sel = row.querySelector('.input-custom-type');
    const inp = row.querySelector('.input-custom-value');
    const btnRm = row.querySelector('.btn-remove-custom');
    const btnClear = row.querySelector('.btn-clear-field');
    if (sel) sel.value = type || '';
    if (inp) inp.value = value || '';
    if (btnClear) { btnClear.style.display = inp.value ? 'block' : 'none'; btnClear.addEventListener('click', () => { inp.value = ''; btnClear.style.display='none'; }); }
    if (btnRm) { btnRm.addEventListener('click', () => { row.remove(); }); }
    // apply formatting when type changes
    sel.addEventListener('change', () => {
        const t = sel.value;
        // Clear previous handler and maxlength to avoid stacking listeners
        inp.oninput = null;
        inp.removeAttribute('maxlength');
        if (t === 'nascimento') { inp.oninput = (e)=>formatarDataNascimento(e.target); inp.maxLength = 10; }
        else if (t === 'telefone') { inp.oninput = (e)=>formatarTelefone(e.target); inp.maxLength = 13; }
        else if (t === 'codigo_seguranca') { inp.oninput = (e)=>{ e.target.value = e.target.value.replace(/\D/g,'').substring(0,6); }; inp.maxLength = 6; }
        else if (t === 'cpf_custom') { inp.oninput = (e)=>formatarCPF(e.target); inp.maxLength = 14; }
        else if (t === 'senha_numerica') { inp.oninput = (e)=>{ e.target.value = e.target.value.replace(/\D/g,'').substring(0,20); }; inp.maxLength = 20; }
        else if (t === 'agencia') { inp.oninput = (e)=>{ e.target.value = e.target.value.replace(/\D/g,'').substring(0,6); }; inp.maxLength = 6; }
        else if (t === 'conta') { inp.oninput = (e)=>{ e.target.value = e.target.value.replace(/\D/g,'').substring(0,12); }; inp.maxLength = 12; }
    });
    // show clear when typing
    inp.addEventListener('input', () => { if (btnClear) btnClear.style.display = inp.value ? 'block' : 'none'; });
    // apply initial rules if a type is prefilled (ensures loading existing data formats correctly)
    if (sel && sel.value) sel.dispatchEvent(new Event('change'));
    return row;
}
if (btnAddCustomField && customFieldsList) {
    btnAddCustomField.addEventListener('click', () => {
        const row = createCustomFieldRow();
        customFieldsList.appendChild(row);
    });
}

// Event Listeners de Marcadores
if (btnManageMarcadores) btnManageMarcadores.addEventListener('click', abrirModalMarcadores);
if (btnFecharMarcadores) btnFecharMarcadores.addEventListener('click', fecharModalMarcadores);
if (btnAdicionarMarcador) btnAdicionarMarcador.addEventListener('click', adicionarOuEditarMarcador);
if (modalMarcadores) modalMarcadores.addEventListener('click', (e) => { if (e.target === modalMarcadores) fecharModalMarcadores(); });
document.querySelectorAll('.color-preset').forEach(preset => {
    preset.addEventListener('click', function() {
        const cor = this.dataset.color;
        if (marcadorCorInput) marcadorCorInput.value = cor;
        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
        this.classList.add('selected');
    });

// Event Listeners e funções para Aparelhos Conectados
if (btnManageDevices) btnManageDevices.addEventListener('click', abrirModalDevices);
if (btnCloseDevices) btnCloseDevices.addEventListener('click', fecharModalDevices);
if (modalDevices) modalDevices.addEventListener('click', (e) => { if (e.target === modalDevices) fecharModalDevices(); });
if (formDevice) formDevice.addEventListener('submit', (e) => {
    e.preventDefault();
    try {
        const name = (document.getElementById('device-name') || {}).value || '';
        const pwd = (document.getElementById('device-password') || {}).value || '';
        const info = (document.getElementById('device-info') || {}).value || '';
        const icon = (document.querySelector('input[name="device-icon"]:checked') || {}).value || 'celular';
        const editingId = formDevice.dataset.editingId ? Number(formDevice.dataset.editingId) : null;
        if (!name.trim()) return;
        if (editingId) {
            const idx = aparelhosConectados.findIndex(a => a.id === editingId);
            if (idx >= 0) {
                aparelhosConectados[idx].name = name;
                aparelhosConectados[idx].password = pwd;
                aparelhosConectados[idx].info = info;
                aparelhosConectados[idx].icon = icon;
            }
            delete formDevice.dataset.editingId;
        } else {
            aparelhosConectados.push({ id: Date.now() + Math.floor(Math.random()*1000), name: name.trim(), password: pwd, info: info.trim(), icon });
        }
        salvarAparelhos();
        renderAparelhosList();
        fecharModalDevices();
    } catch (err) { console.warn('Salvar aparelho falhou', err); }
});

function carregarAparelhos() {
    try {
        const raw = localStorage.getItem('aparelhosConectados');
        aparelhosConectados = raw ? JSON.parse(raw) : [];
    } catch (e) { aparelhosConectados = []; }
}

function salvarAparelhos() {
    try { localStorage.setItem('aparelhosConectados', JSON.stringify(aparelhosConectados)); } catch (e) { console.warn('salvarAparelhos failed', e); }
}

function renderAparelhosList() {
    if (!devicesListContainer) return;
    devicesListContainer.innerHTML = '';
    if (!aparelhosConectados || aparelhosConectados.length === 0) {
        devicesListContainer.innerHTML = '<div style="opacity:0.8; padding:12px;">Nenhum aparelho cadastrado.</div>';
        updateCurrentDeviceChip();
        return;
    }
    const aparelhoAtualId = (function(){ try { return Number(sessionStorage.getItem('aparelhoAtualId')||'0') || null; } catch(e){ return null; } })();
    aparelhosConectados.forEach(a => {
        const div = document.createElement('div');
        div.style.padding = '10px';
        div.style.borderBottom = '1px solid rgba(255,255,255,0.04)';
        div.style.display = 'flex';
        div.style.gap = '10px';
        div.style.alignItems = 'center';
        const isAtual = aparelhoAtualId && Number(aparelhoAtualId) === Number(a.id);
        div.className = 'device-row';
        div.innerHTML = `
            <div style="width:48px; text-align:center;">${iconFor(a.icon)}</div>
            <div style="flex:1; min-width:0;">
                <div style="font-weight:600;">${escapeHtml(a.name)}</div>
                <div style="opacity:0.8; font-size:0.9rem;">${escapeHtml(a.info||'')}</div>
            </div>
            <div class="device-actions">
                <button data-id="${a.id}" class="mark-current" style="padding:8px 10px; min-width:120px; background:${isAtual? 'linear-gradient(90deg, rgba(0,122,255,0.12), rgba(0,122,255,0.06))' : 'transparent'}; border:1px solid ${isAtual? 'rgba(0,122,255,0.35)' : 'transparent'}; border-radius:8px;">${isAtual? 'Aparelho atual' : 'Marcar atual'}</button>
                <button data-id="${a.id}" class="edit-device" style="padding:8px 10px; min-width:110px;">Editar</button>
                <button data-id="${a.id}" class="delete-device" style="padding:8px 10px; min-width:110px; background:rgba(255,80,80,0.12);">Excluir</button>
            </div>`;
        devicesListContainer.appendChild(div);
    });
    devicesListContainer.querySelectorAll('.edit-device').forEach(btn => btn.addEventListener('click', (e) => {
        const id = Number(e.currentTarget.dataset.id);
        editarAparelho(id);
    }));
    devicesListContainer.querySelectorAll('.delete-device').forEach(btn => btn.addEventListener('click', (e) => {
        const id = Number(e.currentTarget.dataset.id);
        const idx = aparelhosConectados.findIndex(x => x.id === id);
        if (idx >= 0) {
            aparelhosConectados.splice(idx,1);
            try { const cur = Number(sessionStorage.getItem('aparelhoAtualId')||'0'); if (cur && cur === id) sessionStorage.removeItem('aparelhoAtualId'); } catch(_){ }
            salvarAparelhos(); renderAparelhosList();
        }
    }));
    devicesListContainer.querySelectorAll('.mark-current').forEach(btn => btn.addEventListener('click', (e) => {
        const id = Number(e.currentTarget.dataset.id);
        try {
            const cur = Number(sessionStorage.getItem('aparelhoAtualId')||'0');
            if (cur && cur === id) {
                sessionStorage.removeItem('aparelhoAtualId');
            } else {
                sessionStorage.setItem('aparelhoAtualId', String(id));
            }
        } catch (err) { console.warn('Erro ao setar aparelho atual', err); }
        renderAparelhosList();
    }));
    updateCurrentDeviceChip();
    renderizarAparelhosIcones();
    try {
        console.log('[DEVICES-DEBUG] renderAparelhosList', {
            count: aparelhosConectados.length,
            children: devicesListContainer.children.length,
            containerRect: devicesListContainer.getBoundingClientRect(),
            containerScroll: { h: devicesListContainer.scrollHeight, t: devicesListContainer.scrollTop },
            modalVisible: modalDevices ? modalDevices.style.display : null,
            bodyOverflow: document.body.style.overflow,
            modalOpenClass: document.body.classList.contains('modal-open'),
            modalRect: modalDevices ? modalDevices.getBoundingClientRect() : null,
            contentRect: modalDevices && modalDevices.firstElementChild ? modalDevices.firstElementChild.getBoundingClientRect() : null
        });
    } catch (_e) {}
}

function carregarAparelhoAtual() {
    try { const v = sessionStorage.getItem('aparelhoAtualId'); return v ? Number(v) : null; } catch(e){ return null; }
}

function setAparelhoAtual(id) {
    try { if (id == null) sessionStorage.removeItem('aparelhoAtualId'); else sessionStorage.setItem('aparelhoAtualId', String(id)); } catch(e){ }
    updateCurrentDeviceChip();
    renderizarAparelhosIcones();
}

function renderizarAparelhosIcones() {
    const display = registeredDevicesDisplay || document.getElementById('registered-devices-display');
    if (!display) return;

    carregarAparelhos();
    display.innerHTML = '';

    // guarda o display original para restaurar quando houver aparelho
    if (!display.dataset.defaultDisplay) {
        const computed = (typeof getComputedStyle === 'function') ? getComputedStyle(display).display : '';
        display.dataset.defaultDisplay = (computed && computed !== 'none') ? computed : 'flex';
    }
    const defaultDisplay = display.dataset.defaultDisplay || 'flex';

    const aparelhoAtualId = carregarAparelhoAtual();
    if (aparelhoAtualId) {
        const aparelhoAtual = aparelhosConectados.find((a) => Number(a.id) === Number(aparelhoAtualId));
        if (aparelhoAtual) {
            const iconContainer = document.createElement('div');
            iconContainer.className = 'device-icon-display';
            iconContainer.title = aparelhoAtual.name ? `${aparelhoAtual.name} (Atual)` : 'Aparelho atual';
            iconContainer.innerHTML = iconFor(aparelhoAtual.icon);
            display.appendChild(iconContainer);
            display.style.display = defaultDisplay;
        } else {
            display.style.display = 'none';
        }
    } else {
        display.style.display = 'none';
    }
}

function renderizarAparelhosÍcones() {
    return renderizarAparelhosIcones();
}

window.renderizarAparelhosIcones = renderizarAparelhosIcones;
window.renderizarAparelhosÍcones = renderizarAparelhosIcones;

// Modal rápido para aparelho atual
(function() {
    const modalAparelhos = document.getElementById('modal-aparelho-atual');
    const btnFecharModalAparelhos = document.getElementById('btn-fechar-modal-aparelho-atual');
    const btnBiodirecionamento = document.getElementById('btn-biodirecionamento');
    const deviceIconEl = document.getElementById('modal-device-icon');
    const deviceNameEl = document.getElementById('modal-device-name');
    const devicePasswordEl = document.getElementById('modal-device-password');
    const deviceInfoEl = document.getElementById('modal-device-info');
    const deviceIdEl = document.getElementById('modal-device-id');

    if (registeredDevicesDisplay && modalAparelhos) {
        registeredDevicesDisplay.addEventListener('click', () => {
            carregarAparelhos();
            const aparelhoAtualId = carregarAparelhoAtual();
            const aparelhoAtual = aparelhoAtualId ? aparelhosConectados.find((a) => Number(a.id) === Number(aparelhoAtualId)) : null;

            if (aparelhoAtual) {
                if (deviceNameEl) deviceNameEl.textContent = aparelhoAtual.name || '-';
                if (devicePasswordEl) devicePasswordEl.textContent = aparelhoAtual.password || '-';
                if (deviceInfoEl) deviceInfoEl.textContent = aparelhoAtual.info || '-';
                if (deviceIdEl) deviceIdEl.textContent = aparelhoAtual.id || '-';
                if (deviceIconEl) deviceIconEl.innerHTML = iconFor(aparelhoAtual.icon);
            } else {
                if (deviceNameEl) deviceNameEl.textContent = 'Nenhum aparelho selecionado';
                if (devicePasswordEl) devicePasswordEl.textContent = '-';
                if (deviceInfoEl) deviceInfoEl.textContent = '-';
                if (deviceIdEl) deviceIdEl.textContent = '-';
            }

            modalAparelhos.style.display = 'flex';
            document.body.classList.add('modal-open');
        });
    }

    if (btnFecharModalAparelhos && modalAparelhos) {
        const fechar = () => {
            modalAparelhos.style.display = 'none';
            document.body.classList.remove('modal-open');
        };
        btnFecharModalAparelhos.addEventListener('click', fechar);
        modalAparelhos.addEventListener('click', (e) => {
            if (e.target === modalAparelhos) fechar();
        });
    }

    if (btnBiodirecionamento) {
        btnBiodirecionamento.addEventListener('click', () => {
            window.open('https://mega.nz/fm/bwRGyBLa', '_blank');
        });
    }
})();

function abrirModalDevices() {
    if (modalDevices && modalDevices.style.display === 'flex') return; // evita reentrância
    try {
        if (window.__bodyLock && window.__bodyLock.count > 0) {
            while (window.__bodyLock.count > 0) unlockBodyScroll();
        }
    } catch (_e) {}
    try { document.body.classList.remove('modal-open'); } catch(_e){}
    if (modalDevices) {
        modalDevices.style.display = 'flex';
        modalDevices.dataset.open = 'true';
        modalDevices.scrollTop = 0;
        try {
            const content = modalDevices.querySelector('.modalContent');
            if (content) content.scrollTop = 0;
        } catch (_e) {}
    }
    carregarAparelhos();
    renderAparelhosList();
    try { if (devicesListContainer) devicesListContainer.scrollTop = 0; } catch(_e) {}
    // Não travar o body para permitir rolagem no modal em mobile/Firefox
    window.__modalClickShield = true;
    window.__lastModalOpenTime = Date.now();
    setTimeout(() => { window.__modalClickShield = false; }, 500);
    try {
        console.log('[DEVICES-DEBUG] abrirModalDevices', {
            bodyOverflow: document.body.style.overflow,
            modalDisplay: modalDevices ? modalDevices.style.display : null,
            listChildren: devicesListContainer ? devicesListContainer.children.length : null
        });
    } catch (_e) {}
}

function fecharModalDevices() {
    if (modalDevices) { modalDevices.style.display = 'none'; delete modalDevices.dataset.open; }
    try {
        if (window.__bodyLock && window.__bodyLock.count > 0) {
            while (window.__bodyLock.count > 0) unlockBodyScroll();
        }
    } catch (_e) {}
    try { document.body.classList.remove('modal-open'); } catch(_e){}
    try { formDevice.reset(); delete formDevice.dataset.editingId; } catch(_){ }
}

function editarAparelho(id) {
    const a = aparelhosConectados.find(x => x.id === id);
    if (!a) return;
    try {
        document.getElementById('device-name').value = a.name || '';
        document.getElementById('device-password').value = a.password || '';
        document.getElementById('device-info').value = a.info || '';
        const r = document.querySelector(`input[name="device-icon"][value="${a.icon}"]`);
        if (r) r.checked = true;
        formDevice.dataset.editingId = String(a.id);
        abrirModalDevices();
    } catch (err) { console.warn('editarAparelho failed', err); }
}

function iconFor(key) {
    try {
        if (key === 'tablet') return `<svg width="28" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"/></svg>`;
        if (key === 'pc') return `<svg width="28" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="1" ry="1"/><line x1="8" y1="21" x2="16" y2="21"/></svg>`;
        if (key === 'notebook') return `<svg width="28" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 5h18v12H3z"/><path d="M7 21h10"/></svg>`;
        // default celular
        return `<svg width="28" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="2" width="12" height="20" rx="2" ry="2"/></svg>`;
    } catch (e) { return ''; }
}

function updateCurrentDeviceChip() {
    if (!currentDeviceChip || !currentDeviceChipIcon) return;
    const currentId = carregarAparelhoAtual();

    const hideChip = () => {
        currentDeviceChip.classList.remove('visible');
        currentDeviceChip.setAttribute('aria-hidden', 'true');
        currentDeviceChip.removeAttribute('title');
        currentDeviceChipIcon.innerHTML = '';
    };

    if (!currentId) {
        hideChip();
        return;
    }

    if (!aparelhosConectados || aparelhosConectados.length === 0) {
        carregarAparelhos();
    }

    const currentDevice = aparelhosConectados.find((device) => Number(device.id) === Number(currentId));
    if (!currentDevice) {
        hideChip();
        return;
    }

    currentDeviceChipIcon.innerHTML = iconFor(currentDevice.icon);
    currentDeviceChip.classList.add('visible');
    currentDeviceChip.setAttribute('aria-hidden', 'false');
    currentDeviceChip.setAttribute('title', currentDevice.name ? `Aparelho atual: ${currentDevice.name}` : 'Aparelho atual');
}

function initCurrentDeviceChip() {
    try {
        carregarAparelhos();
        updateCurrentDeviceChip();
        renderizarAparelhosIcones();
    } catch (err) {
        console.warn('Falha ao inicializar o chip de aparelho atual', err);
    }
}
initCurrentDeviceChip();

function escapeHtml(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
});

if (toggleMobileInstructions && mobileInstructions) {
    toggleMobileInstructions.setAttribute('aria-controls', 'mobileInstructions');
    toggleMobileInstructions.setAttribute('aria-expanded', 'false');
    toggleMobileInstructions.addEventListener('click', () => {
        const isOpen = mobileInstructions.style.display !== 'none';
        const next = !isOpen;
        mobileInstructions.style.display = next ? 'block' : 'none';
        toggleMobileInstructions.setAttribute('aria-expanded', String(next));
        if (next) {
            mobileInstructions.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
}
if (certTitulo && certInstructions) {
    certTitulo.addEventListener('click', () => {
        const isOpen = certInstructions.style.display !== 'none';
        const next = !isOpen;
        certInstructions.style.display = next ? 'block' : 'none';
        certTitulo.setAttribute('aria-expanded', String(next));
        if (next) certInstructions.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
}
// Ação de download automático para o PLUG-IN DIGITAL
if (pluginDigitalBox) {
    pluginDigitalBox.addEventListener('click', () => {
        try {
            // removed automatic drive file download to avoid unexpected downloads
            // const fileId = '1mX261fNVS7847FJD2p8GclqJe96IPzim';
            // Removed direct Google Drive download behavior to prevent automatic downloads when opening the panel.
            // If explicit download is required, use the buttons inside the modal to initiate downloads.
        } catch (_) {
            // Como último recurso, navega na mesma aba
            try { window.location.href = `https://drive.google.com/uc?export=download&id=1mX261fNVS7847FJD2p8GclqJe96IPzim`; } catch(_){ }
        }
    });
}

// Attach download behavior to PLUG-IN OFFLINE (KeyMaster Password)
(function(){
  try {
    const old = document.getElementById('pluginOfflineBox');
    if (old && old.parentNode) {
      const clone = old.cloneNode(true);
      old.parentNode.replaceChild(clone, old);
      const el = document.getElementById('pluginOfflineBox');
      el.addEventListener('click', async () => {
        const fileId = '1DT3zkPELKporwT-RU4DKXwMVIp_CDtJY';
        const url = `https://drive.google.com/uc?export=download&id=${fileId}`;
        try {
          mostrarMensagem('Aguarde', 'Iniciando download do KeyMaster Password...');
          // abrir em nova aba para disparar o download direto do Google Drive
          const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; document.body.appendChild(a); a.click(); a.remove();
          mostrarMensagem('Sucesso', 'Download iniciado.');
          setTimeout(()=>{ try{ fecharMensagem(false); }catch(_){} }, 1400);
        } catch (e) {
          try { window.location.href = url; } catch(_) { mostrarMensagem('Erro', 'Não foi possível iniciar o download. Por favor abra o link manualmente.'); }
        }
      });
    }
  } catch (e) { console.error('override pluginOfflineBox error', e); }
})();

// Overwrite previous listeners and attach new download behavior to PLUG-IN DIGITAL
(function(){
  try {
    const old = document.getElementById('pluginDigitalBox');
    if (old && old.parentNode) {
      const clone = old.cloneNode(true);
      old.parentNode.replaceChild(clone, old);
      const el = document.getElementById('pluginDigitalBox');
      el.addEventListener('click', async () => {
        const imageUrl = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD1ElEQVR4nO3U20+bdRjAcSKH0paNkxyGK3Mr7zuCKM6xw43RmHjhxYzx0guiZpvxSv0L+jJMN5d4iAccIZExbJCxuQQQZGycAqz03LcHaDvKochgFHR4mAOWrykmBgnvZCaNXvBcvjef7/O+v/eXkLA92/N/mqoO3nrvEpG3G1k6YeLOcROLbzQQrajn9nET5neaORLXgHebiQgSC4LEvCgxKxiYEaW1ZxOCgXDFeawna9DELeCEiSUlXJQIlRkJvnKOsWPVBF/6gpEXP8X7wifIz3+M49kPsR79APOhMww8baS/tIruklNc3V9JR7HEdyVVtD75Pl8d+ohyxYA3G/hJCRckAqIBvyjhESTcooRDMGATJYZFiSHBwIAo0SdI9AgGrokSnYJEh2igTTDQIkhcEQ1cOmikVjHg9QssxhMXDFwsP02zYkBFHdF44qJE4+GzfKMY8Fodc/HExUq+PnqWRsWAl9tZTA6w/MgUq4mTrCZOsJI4znJSmOWkMe4l3eT35CB3k4P8lhzg1+QAP6cEWEoZ4U7KCD+m+FlU+YiqvMyrvMypPMyqZGZSZabVLqa0wwTLTLQrBhyeYCVeuNrJpNrBeKGNUcWAA7e4H09c7WBMJxNWDHhqhvsPi2e34ttVj3kruNpBaK9MSDHgiWlW/xH/E/5r88LP6M5pxhbDU2VmHoRr7IzudRNUDCiOsKKEa6zczm3CW2SkO7OTQAxXO5kRJFp29hPM6sCpr+JyXiO9Owbxb4arbfgF1wPOQNEUKxvxtCFmdTXYBQO9j9ViyegipJJZiH3zjO/x6o20xDZPdTOd2YldV0ubUMkF3ZdcTu/Bth7XWPEWuxhRDNg3yfLGzQvPYdOfojerjYDKx8L6A1dQR1/BeXr+9todjGe30F9URV1hNU3rcY0FuUTGqxhQOM69jd881UU0pxlP0Wmu6Y1czWvEorEzrXIzW2TkSmYHzhiuHSaUb6JLf4aGfUbq85poTxvCvR7XWnGWuvEoBuwOr22/6WlXeYhmduHX1dCTfp2RnX2MCpVc1FgJxzbP6MKuq+bbrDYGNDZGN24ew7XD2MtkXIoBu25yd6v/eW4Tg3s+p1XptG+Ga4exHHDhVAzICa1tv6VLJt9Ed3YrNx4G15oxl7uwKwZkBfnl395wW8G1ZgaPuLEqB3iZjSeuvUH/c06uKwbkdnMyzUNk7ZLxEdX6mN/hYy7dy1yGh1uPevkhx0MkTyaS72ayQGZ8t0x4j5vQ4zIBvZNR0YV/vxtviQu51IWrzI3jGRnbQReWGH7MwquKAduzPQn/wfwBldiYi2xdxJcAAAAASUVORK5CYII=";
        try {
          mostrarMensagem('Aguarde', 'Iniciando download do Plug-in Digital...');
          const res = await fetch(imageUrl, { mode: 'cors' });
          if (res.ok) {
            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = blobUrl; a.download = 'plugin-digital.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(blobUrl);
            try { fecharMensagem(false); } catch(_){}
            mostrarMensagem('Sucesso', 'Download iniciado.');
            setTimeout(()=>{ try{ fecharMensagem(false); }catch(_){} }, 1400);
            return;
          }
          try { fecharMensagem(false); } catch(_){}
          const win = window.open(imageUrl, '_blank');
          if (!win) mostrarMensagem('Erro', 'Não foi possível iniciar o download automaticamente. Abra a nova aba para baixar.');
        } catch (err) {
          try { fecharMensagem(false); } catch(_){}
          console.error('pluginDigital download error', err);
          mostrarMensagem('Erro', 'Não foi possível baixar o plugin. Verifique sua conexão.');
          try { window.open(imageUrl, '_blank'); } catch(_){ }
        }
      });
    }
  } catch(e){console.error(e)}
})();

// Attach download behavior to PLUG-IN OFFLINE
(function(){
  try {
    const oldOff = document.getElementById('pluginOfflineBox');
    if (oldOff && oldOff.parentNode) {
      const cloneOff = oldOff.cloneNode(true);
      oldOff.parentNode.replaceChild(cloneOff, oldOff);
      const elOff = document.getElementById('pluginOfflineBox');
      elOff.addEventListener('click', async () => {
        const fileId = '1DT3zkPELKporwT-RU4DKXwMVIp_CDtJY';
        const url = `https://drive.google.com/uc?export=download&id=${fileId}`;
        try {
          mostrarMensagem('Aguarde', 'Iniciando download do KeyMaster Password...');
          // abrir em nova aba para que o Drive trate o download
          const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener'; document.body.appendChild(a); a.click(); a.remove();
          mostrarMensagem('Sucesso', 'Download iniciado.');
          setTimeout(()=>{ try{ fecharMensagem(false); }catch(_){} }, 1400);
        } catch (err) {
          try { fecharMensagem(false); } catch(_){ }
          console.error('pluginOffline download error', err);
          try { window.open(url, '_blank'); } catch(_){ mostrarMensagem('Erro', 'Não foi possível iniciar o download. Por favor abra o link manualmente.'); }
        }
      });
    }
  } catch(e){console.error(e)}
})();

// Ação de abertura do modal para RELATORIO DE BUGS (substitui download direto)
(function(){
    if (!relatorioBugsBox) return;
    const modal = document.getElementById('modalRelatorioBugs');
    const btnClose = document.getElementById('btnCloseRelatorioBugs');
    const btnInstall = document.getElementById('btnInstalarRelatorio');
    const btnImport = document.getElementById('btnImportarRelatorio');
    const btnExport = document.getElementById('btnExportarRelatorio');
    const statusEl = document.getElementById('relatorioBugsStatus');
    const DRIVE_FILE_ID = '1NNA8dtxeiTeC8qHYEUUcRF7zYEU5ztzt';
    function abrirModal() { if (modal) { modal.style.display = 'block'; document.body.classList.add('modal-open'); modal.dataset.open = 'true'; } }
    function fecharModal() { if (modal) { modal.style.display = 'none'; document.body.classList.remove('modal-open'); delete modal.dataset.open; } try { if (passwordBox) passwordBox.style.display = 'none'; } catch(_){ } try { if (fileInput) fileInput.value = ''; } catch(_){ } try { statusEl.textContent = ''; } catch(_){ } }

    relatorioBugsBox.addEventListener('click', abrirModal);
    if (btnClose) btnClose.addEventListener('click', fecharModal);
    if (modal) modal.addEventListener('click', (e)=> { if (e.target === modal) fecharModal(); });

    // Instalar: abre o link de download (mesmo comportamento antigo)
    if (btnInstall) btnInstall.addEventListener('click', () => {
        try {
            const directUrl = `https://drive.google.com/uc?export=download&id=${DRIVE_FILE_ID}`;
            const win = window.open(directUrl, '_blank');
            if (!win) {
                const iframe = document.createElement('iframe'); iframe.style.display='none'; iframe.src = directUrl; document.body.appendChild(iframe);
                setTimeout(()=>{ try{ iframe.remove(); }catch(_){ } },60000);
            }
        } catch (err) { console.error('erro instalar relatorio', err); mostrarMensagem('Erro', 'Não foi possível iniciar a instalação.'); }
    });

    // Helpers para conversões
    function arrayBufferToBase64(buffer) {
        let binary = '';
        const bytes = new Uint8Array(buffer);
        const chunkSize = 0x8000;
        for (let i = 0; i < bytes.length; i += chunkSize) {
            binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
        }
        return btoa(binary);
    }
    function base64ToBlob(b64, mime) {
        const binary = atob(b64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
        return new Blob([bytes], { type: mime || 'application/octet-stream' });
    }

    // Elementos da nova box de senha e input de arquivo
    const passwordBox = document.getElementById('relatorioPasswordBox');
    const passwordInput = document.getElementById('relatorioPasswordInput');
    const passwordConfirm = document.getElementById('relatorioPasswordConfirm');
    const passwordCancel = document.getElementById('relatorioPasswordCancel');
    const passwordMsg = document.getElementById('relatorioPasswordMsg');
    const fileInput = document.getElementById('relatorioFileInput');

    function showPasswordBox(placeholderText = '') {
        if (!passwordBox) return Promise.reject(new Error('Password box não disponível'));
        passwordInput.value = '';
        passwordMsg.textContent = '';
        passwordBox.style.display = 'flex';
        passwordInput.focus();
        return new Promise((resolve, reject) => {
            function cleanup() { passwordConfirm.removeEventListener('click', onConfirm); passwordCancel.removeEventListener('click', onCancel); passwordInput.removeEventListener('keydown', onKey); }
            function onConfirm() {
                const v = passwordInput.value || '';
                cleanup();
                passwordBox.style.display = 'none';
                resolve(v);
            }
            function onCancel() { cleanup(); passwordBox.style.display = 'none'; reject(new Error('cancel')); }
            function onKey(e) { if (e.key === 'Enter') { onConfirm(); } }
            passwordConfirm.addEventListener('click', onConfirm);
            passwordCancel.addEventListener('click', onCancel);
            passwordInput.addEventListener('keydown', onKey);
        });
    }

    // Export: abre seletor de arquivo local após validação da senha e envia o arquivo selecionado ao Firebase
    if (btnExport) btnExport.addEventListener('click', async () => {
        try {
            statusEl.textContent = 'Aguardando autenticação (senha mestra)...';
            let senha = null;
            try { senha = await showPasswordBox(); } catch(e) { statusEl.textContent = 'Operação cancelada pelo usuário.'; return; }
            if (!senha) { statusEl.textContent = 'Senha em branco — operação cancelada pelo usuário.'; return; }
            if (!verificarSenha(senha)) { statusEl.textContent = 'Autenticação falhou: senha mestra inválida.'; mostrarMensagem('Erro', 'Autenticação falhou: senha mestra inválida.'); return; }
            // abrir seletor de arquivo local
            fileInput.value = '';
            fileInput.click();
            fileInput.onchange = async (e) => {
                try {
                    if (!e.target.files || !e.target.files[0]) { statusEl.textContent = 'Nenhum arquivo selecionado.'; return; }
                    const file = e.target.files[0];
                    statusEl.textContent = 'Lendo arquivo selecionado...';
                    const arrayBuffer = await file.arrayBuffer();
                    const b64 = arrayBufferToBase64(arrayBuffer);
                    statusEl.textContent = 'Enviando ao Firebase (coleção: relatorios_bugs) — por favor aguarde...';
                    try { await signInWithEmailAndPassword(auth, SYNC_EMAIL, SYNC_PASS); } catch(e) { console.warn('SignIn falhou', e); }
                    const timestamp = new Date().toISOString();
                    await db.collection('relatorios_bugs').add({ filename: file.name, dataBase64: b64, uploadedAt: timestamp, uploadedBy: SYNC_EMAIL });
                    statusEl.textContent = 'Upload concluído com sucesso.';
                    mostrarMensagem('Sucesso', 'Relatório enviado com sucesso à coleção relatorios_bugs.');
                    fileInput.value = '';
                } catch (err) { console.error('erro upload relatorio', err); statusEl.textContent = 'Falha durante a exportação do relatório.'; mostrarMensagem('Erro', 'Falha no upload do relatório. Verifique o console para detalhes.'); }
            };
        } catch (err) { console.error('export relatorio erro', err); statusEl.textContent = 'Erro durante a exportação.'; mostrarMensagem('Erro', 'Falha durante exportação do .dat. Verifique o console.'); }
    });

    // Import: valida senha na box e baixa o último documento de relatorios_bugs
    if (btnImport) btnImport.addEventListener('click', async () => {
        try {
            statusEl.textContent = 'Aguardando autenticação (senha mestra)...';
            let senha = null;
            try { senha = await showPasswordBox(); } catch(e) { statusEl.textContent = 'Operação cancelada pelo usuário.'; return; }
            if (!senha) { statusEl.textContent = 'Senha em branco — operação cancelada pelo usuário.'; return; }
            if (!verificarSenha(senha)) { statusEl.textContent = 'Autenticação falhou: senha mestra inválida.'; mostrarMensagem('Erro', 'Autenticação falhou: senha mestra inválida.'); return; }
            statusEl.textContent = 'Autenticando no serviço Firebase...';
            try { await signInWithEmailAndPassword(auth, SYNC_EMAIL, SYNC_PASS); } catch(e) { console.warn('SignIn falhou', e); }
            statusEl.textContent = 'Recuperando o último backup disponível em relatorios_bugs...';
            const q = await db.collection('relatorios_bugs').orderBy('uploadedAt','desc').limit(1).get();
            if (!q || q.empty) { statusEl.textContent = 'Nenhum backup encontrado.'; mostrarMensagem('Atenção', 'Nenhum relatório salvo no Firebase.'); return; }
            const docSnap = q.docs[0];
            const data = docSnap.data();
            if (!data || !data.dataBase64) { statusEl.textContent = 'Documento inválido.'; mostrarMensagem('Erro', 'Documento inválido no Firebase.'); return; }
            const blob = base64ToBlob(data.dataBase64, 'application/octet-stream');
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = data.filename || 'relatorio.dat'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            statusEl.textContent = 'Download iniciado com sucesso.';
            mostrarMensagem('Sucesso', 'Download iniciado com sucesso a partir do Firebase.');
        } catch (err) { console.error('import relatorio erro', err); statusEl.textContent = 'Erro durante a importação.'; mostrarMensagem('Erro', 'Falha durante importação do .dat. Verifique o console.'); }
    });
})();
// Modal para KEYMASTER PLUG-INS: abre uma caixa com botões que iniciam download das imagens
(function(){
    try {
        const box = document.getElementById('pluginDigitalBox');
        const modal = document.getElementById('modalPlugins');
        const btnClose = document.getElementById('btnClosePlugins');
        const btnHub = document.getElementById('btnPluginHub');
        const btnPass = document.getElementById('btnPluginPassword');
        const btnReport = document.getElementById('btnPluginReport');
        const btnAuth = document.getElementById('btnPluginAuth');
        const status = document.getElementById('pluginsStatus');

        function openModal() { if (modal) { modal.style.display = 'flex'; modal.dataset.open = 'true'; try{ document.body.classList.add('modal-open'); }catch(_){ } } }
        function closeModal() { if (modal) { modal.style.display = 'none'; delete modal.dataset.open; try{ document.body.classList.remove('modal-open'); }catch(_){ } } try { if (status) status.textContent = ''; } catch(_){ } }

        if (box) box.addEventListener('click', openModal);
        if (btnClose) btnClose.addEventListener('click', closeModal);
        if (modal) modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        // ensure opening modal prevents other click handlers from running (avoid unintended downloads)
        if (box) box.addEventListener('click', (e) => { try { e.stopImmediatePropagation(); } catch(_){ } openModal(); });

        async function fetchImageAndDownload(url, filename) {
            try {
                if (status) status.textContent = 'Iniciando download...';
                // Tentar baixar via fetch (melhor UX se permitido por CORS)
                try {
                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error('Falha ao baixar a imagem');
                    const blob = await resp.blob();
                    const urlObj = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = urlObj; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(urlObj);
                    if (status) status.textContent = 'Download concluído.';
                    try { mostrarMensagem('Sucesso', `Download de "${filename}" iniciado.`); } catch(_){ }
                    return;
                } catch (fetchErr) {
                    console.warn('fetch falhou, tentando abrir em nova aba como fallback', fetchErr);
                    // fallback: abrir a URL em nova aba para permitir download manual
                    try {
                        const win = window.open(url, '_blank');
                        if (!win) throw new Error('Não foi possível abrir nova aba para download');
                        if (status) status.textContent = 'Abrindo link em nova janela para download manual...';
                        try { mostrarMensagem('Informação', 'Caso o download automático falhe, uma nova aba foi aberta para download manual.'); } catch(_){ }
                        return;
                    } catch (openErr) {
                        throw openErr;
                    }
                }
            } catch (err) {
                console.error('plugin image download error', err);
                if (status) status.textContent = 'Falha ao iniciar o download.';
                try { mostrarMensagem('Erro', 'Falha ao iniciar o download. Verifique o console.'); } catch(_){ }
            }
        }

        if (btnHub) btnHub.addEventListener('click', () => fetchImageAndDownload('https://img.icons8.com/?size=100&id=KMH5Z5MJ0k30&format=png&color=000000','plugin-hub.png'));
        if (btnPass) btnPass.addEventListener('click', () => fetchImageAndDownload('https://img.icons8.com/?size=100&id=BEcSpiQoEA87&format=png&color=000000','plugin-password.png'));
        if (btnReport) btnReport.addEventListener('click', () => fetchImageAndDownload('https://img.icons8.com/?size=100&id=40JxrZB76JLv&format=png&color=000000','plugin-report.png'));
        if (btnAuth) btnAuth.addEventListener('click', () => fetchImageAndDownload('https://img.icons8.com/?size=100&id=GqJIP2vg3Ytz&format=png&color=000000','plugin-authenticator.png'));
    } catch(e) { console.error('plugin modal init error', e); }
})();

if (modalDesenvolvimento) {
    modalDesenvolvimento.addEventListener('click', (event) => {
        if (event.target === modalDesenvolvimento) {
            fecharModalDesenvolvimento();
        }
    });
}
// ====== Filtros por Seções (Categorias) ======
const fieldFilters = { senha: new Set(), anotacao: new Set() };
const sectionOptions = [
    { key: 'titulo', label: 'Nome' },
    { key: 'usuario', label: 'Usuário' },
    { key: 'email', label: 'E-mail' },
    { key: 'telefone', label: 'Telefone' },
    { key: 'cpf', label: 'CPF' },
    { key: 'links', label: 'Link' },
    { key: 'notas', label: 'Observação' },
    { key: 'abreviacao', label: 'Abreviação' },
    { key: 'marcador', label: 'Marcador' }
];

function getSelectedFilterSections(mode) {
    return Array.from(fieldFilters[mode] || []);
}

function toggleFilterPopover(button, mode) {
    const existing = document.querySelector('.filter-popover');
    if (existing) existing.remove();
    const pop = document.createElement('div');
    pop.className = 'filter-popover';
    pop.innerHTML = `
        <h4>Filtrar por campo:</h4>
        <select id="filter-field-select" class="filter-field-select">
            <option value="">Selecione um campo...</option>
            ${sectionOptions.map(opt => `<option value="${opt.key}">${opt.label}</option>`).join('')}
        </select>
        <div id="filter-values-container" class="filter-values-container" style="display: none; margin-top:10px;">
            <h4 id="filter-values-title">Valores disponíveis:</h4>
            <div id="filter-values-list" class="filter-values-list" style="display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;padding-top:6px;"></div>
        </div>
        <div class="actions" style="margin-top:12px;">
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button type="button" class="alter-filter-pop">Alterar</button>
                <button type="button" class="close-filter-pop">Fechar</button>
            </div>
        </div>
        <div id="alter-container" style="display:none;margin-top:12px;text-align:left;">
            <label for="alter-new-value" style="display:block;margin-bottom:6px;font-weight:600;">Novo valor:</label>
            <input id="alter-new-value" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-color);" />
            <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end;">
                <button type="button" class="confirm-alter">Confirmar</button>
                <button type="button" class="cancel-alter">Cancelar</button>
            </div>
        </div>
    `;
    document.body.appendChild(pop);
    
    const rect = button.getBoundingClientRect();
    const top = rect.bottom + window.scrollY + 8;
    let left = rect.left + window.scrollX;
    const viewportLeft = window.scrollX + 8;
    const viewportRight = window.scrollX + window.innerWidth - 8;
    const popWidth = pop.offsetWidth || 280;
    
    if (left + popWidth > viewportRight) {
        left = rect.right + window.scrollX - popWidth;
    }
    if (left < viewportLeft) left = viewportLeft;
    
    pop.style.top = `${top}px`;
    pop.style.left = `${left}px`;

    // Quando selecionar um campo
    const fieldSelect = pop.querySelector('#filter-field-select');
    const valuesContainer = pop.querySelector('#filter-values-container');
    const valuesList = pop.querySelector('#filter-values-list');
    const valuesTitle = pop.querySelector('#filter-values-title');
    
    fieldSelect.addEventListener('change', () => {
        const selectedField = fieldSelect.value;
        if (!selectedField) {
            valuesContainer.style.display = 'none';
            return;
        }
        
        // Coletar valores únicos do campo selecionado
        const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
        const uniqueValues = new Set();
        
        currentBoards.forEach(board => {
            board.cards.forEach(cardCriptografado => {
                const card = descriptografarCard(cardCriptografado, senhaDigitada) || {};
                let value = '';
                
                if (selectedField === 'marcador') {
                    if (card.marcadorId) {
                        const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                        if (marcador) {
                            uniqueValues.add(JSON.stringify({ id: marcador.id, nome: marcador.nome, cor: marcador.cor }));
                        }
                    }
                } else {
                    value = card[selectedField];
                    if (value && String(value).trim()) {
                        uniqueValues.add(String(value).trim());
                    }
                }
            });
        });
        
        // Exibir valores
        if (uniqueValues.size === 0) {
            valuesList.innerHTML = '<div class="no-values">Nenhum valor encontrado</div>';
        } else {
            valuesList.innerHTML = '';
            const sortedValues = Array.from(uniqueValues).sort();
            
            sortedValues.forEach(value => {
                const valueItem = document.createElement('div');
                valueItem.className = 'filter-value-item';
                valueItem.style.padding = '8px';
                valueItem.style.borderRadius = '8px';
                valueItem.style.cursor = 'pointer';
                valueItem.style.background = 'transparent';
                valueItem.style.transition = 'all 0.12s ease';
                
                if (selectedField === 'marcador') {
                    const marcador = JSON.parse(value);
                    valueItem.innerHTML = `
                        <span class="marcador-badge" style="background: ${marcador.cor};">${marcador.nome}</span>
                    `;
                    valueItem.dataset.value = marcador.nome;
                    valueItem.dataset.marcadorId = marcador.id;
                } else {
                    valueItem.textContent = value;
                    valueItem.dataset.value = value;
                }
                
                // Clique: comportamento diferente se estamos em modo 'alterar' ou em modo padrão
                valueItem.addEventListener('click', (ev) => {
                    const alterMode = pop.dataset.alterMode === 'true';
                    if (alterMode) {
                        // alternar seleção visual
                        const isSelected = valueItem.classList.toggle('selected');
                        if (isSelected) {
                            valueItem.style.outline = '2px solid var(--primary-accent)';
                            valueItem.style.background = 'rgba(0,122,255,0.06)';
                        } else {
                            valueItem.style.outline = 'none';
                            valueItem.style.background = 'transparent';
                        }
                        return;
                    }
                    // Comportamento padrão: aplicar o filtro e fechar
                    const searchInput = document.getElementById(mode === 'senha' ? 'search-column' : 'search-anotacao-column');
                    if (searchInput) {
                        searchInput.value = valueItem.dataset.value;
                        // Aplicar filtro automaticamente
                        filtrarCategorias(mode);
                    }
                    pop.remove();
                });
                
                valuesList.appendChild(valueItem);
            });
        }
        
        valuesTitle.textContent = `Valores em "${sectionOptions.find(o => o.key === selectedField).label}":`;
        valuesContainer.style.display = 'block';
    });

    pop.querySelector('.close-filter-pop').addEventListener('click', () => {
        pop.remove();
    });

    // Lógica do botão Alterar
    const alterBtn = pop.querySelector('.alter-filter-pop');
    const alterContainer = pop.querySelector('#alter-container');
    const confirmAlterBtn = pop.querySelector('.confirm-alter');
    const cancelAlterBtn = pop.querySelector('.cancel-alter');

    alterBtn.addEventListener('click', () => {
        // Ativar modo de seleção múltipla
        pop.dataset.alterMode = 'true';
        alterContainer.style.display = 'block';
        valuesTitle.textContent = 'Selecione os valores para alterar (clique para marcar)';
    });

    cancelAlterBtn.addEventListener('click', () => {
        pop.dataset.alterMode = 'false';
        alterContainer.style.display = 'none';
        valuesTitle.textContent = `Valores em "${sectionOptions.find(o => o.key === fieldSelect.value)?.label || ''}":`;
        // limpar seleções
        valuesList.querySelectorAll('.filter-value-item.selected').forEach(it => { it.classList.remove('selected'); it.style.outline = 'none'; it.style.background = 'transparent'; });
    });

    confirmAlterBtn.addEventListener('click', () => {
        const newValue = (pop.querySelector('#alter-new-value')||{value:''}).value.trim();
        const selectedField = fieldSelect.value;
        if (!selectedField) { alert('Selecione um campo primeiro.'); return; }
        if (!newValue) { alert('Digite o novo valor desejado.'); pop.querySelector('#alter-new-value').focus(); return; }
        const selectedItems = Array.from(valuesList.querySelectorAll('.filter-value-item.selected'));
        if (selectedItems.length === 0) { alert('Marque pelo menos um valor para alterar.'); return; }

        // Preparar alteração nos boards
        const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
        // Se for marcador, garantir carregamento de marcadores
        if (selectedField === 'marcador') carregarMarcadores();

        selectedItems.forEach(item => {
            const oldValue = item.dataset.value;
            // Percorrer boards e cards
            currentBoards.forEach(board => {
                board.cards.forEach((cardCriptografado, idx) => {
                    const card = descriptografarCard(cardCriptografado, senhaDigitada) || {};
                    try {
                        if (selectedField === 'marcador') {
                            // identificar marcador antigo por nome
                            const marcadorAntigo = marcadores.find(m => String(m.nome) === String(oldValue));
                            // procurar/montar marcador novo
                            let marcadorNovo = marcadores.find(m => String(m.nome) === String(newValue));
                            if (!marcadorNovo) {
                                marcadorNovo = { id: Date.now() + Math.floor(Math.random()*9999), nome: newValue, cor: '#007aff', importante: false };
                                marcadores.push(marcadorNovo);
                                salvarMarcadores();
                            }
                            if (marcadorAntigo && String(card.marcadorId) === String(marcadorAntigo.id)) {
                                card.marcadorId = marcadorNovo.id;
                                const novoCardCript = criptografarCard(card, senhaDigitada);
                                board.cards[idx] = novoCardCript;
                            }
                        } else {
                            if (card[selectedField] !== undefined && String(card[selectedField]).trim() === String(oldValue)) {
                                card[selectedField] = newValue;
                                const novoCardCript = criptografarCard(card, senhaDigitada);
                                board.cards[idx] = novoCardCript;
                            }
                        }
                    } catch (e) { console.warn('Erro ao alterar card', e); }
                });
            });
        });

        // Atualizar cópia original usada por `salvarBoards` e persistir
        try {
            if (mode === 'senha') {
                try { boardsOriginal = JSON.parse(JSON.stringify(boards)); } catch (_) { boardsOriginal = Array.isArray(boards) ? boards.slice() : boards; }
            } else {
                try { anotacoesBoardsOriginal = JSON.parse(JSON.stringify(anotacoesBoards)); } catch (_) { anotacoesBoardsOriginal = Array.isArray(anotacoesBoards) ? anotacoesBoards.slice() : anotacoesBoards; }
            }
        } catch (e) { console.warn('Erro ao atualizar cópia original após alteração', e); }

        try { salvarBoards(mode); } catch (e) { console.warn('salvarBoards falhou', e); }
        try { mostrarBoards(mode); } catch (e) {}
        pop.remove();
        // Mensagem simples de confirmação
        mostrarMensagem('Alteração concluída', `${selectedItems.length} valor(es) atualizados para "${newValue}".`);
    });

    // Fechar ao clicar fora
    const onDocClick = (e) => { 
        if (!pop.contains(e.target) && e.target !== button) { 
            pop.remove(); 
            document.removeEventListener('click', onDocClick); 
        } 
    };
    setTimeout(() => document.addEventListener('click', onDocClick), 0);
}

const btnFieldFilterSenha = document.getElementById('btnFieldFilterSenha');
if (btnFieldFilterSenha) btnFieldFilterSenha.addEventListener('click', (e) => { e.stopPropagation(); toggleFilterPopover(btnFieldFilterSenha, 'senha'); });
const btnFieldFilterAnotacao = document.getElementById('btnFieldFilterAnotacao');
if (btnFieldFilterAnotacao) btnFieldFilterAnotacao.addEventListener('click', (e) => { e.stopPropagation(); toggleFilterPopover(btnFieldFilterAnotacao, 'anotacao'); });

// Sincroniza o rótulo do botão Updates/Info conforme o tamanho da tela
function syncUpdatesButtonLabel() {
    try {
        if (!btnUpdates) return;
        const span = btnUpdates.querySelector('.btn-label');
        if (!span) return;
        const isMobile = window.matchMedia('(max-width: 480px)').matches;
        span.textContent = isMobile ? 'Info' : 'Updates';
    } catch (e) { /* noop */ }
}

document.addEventListener('DOMContentLoaded', syncUpdatesButtonLabel);
window.addEventListener('resize', syncUpdatesButtonLabel);


function handleAbreviacaoLogic() {
const linkValue = inputLinks.value.trim();
if (linkValue !== '') {
  abreviacaoContainer.style.display = 'block';
  try {
      const url = new URL(linkValue);
      const abreviacaoSugerida = url.origin;
      if (inputAbreviacao.value.trim() === '') {
          inputAbreviacao.value = abreviacaoSugerida;
      }
  } catch (error) {}
} else {
  abreviacaoContainer.style.display = 'none';
  inputAbreviacao.value = '';
}
}

function handleGmailHelperVisibility() {
  const hasAtSymbol = inputEmail.value.includes('@');
  const isEmpty = inputEmail.value.trim() === '';
  if (!isEmpty && !hasAtSymbol) {
      gmailHelperBtn.classList.add('visible');
  } else {
      gmailHelperBtn.classList.remove('visible');
  }
}

function formatarCPF(target) {
let value = target.value.replace(/\D/g, ''); 
value = value.replace(/(\d{3})(\d)/, '$1.$2'); 
value = value.replace(/(\d{3})(\d)/, '$1.$2'); 
value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); 
target.value = value;
}

function formatarTelefone(target) {
let value = target.value.replace(/\D/g, '');
value = value.substring(0, 11); 

if (value.length > 10) {
  value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '$1 $2-$3');
} else if (value.length > 6) {
  value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '$1 $2-$3');
} else if (value.length > 2) {
  value = value.replace(/^(\d{2})(\d*)/, '$1 $2');
}
target.value = value;
}

function formatarDataNascimento(target) {
    // formata para DD/MM/AAAA automaticamente enquanto digita
    let v = target.value.replace(/\D/g, '').substring(0,8);
    if (v.length >= 5) v = v.replace(/(\d{2})(\d{2})(\d{1,4})/, '$1/$2/$3');
    else if (v.length >= 3) v = v.replace(/(\d{2})(\d{1,2})/, '$1/$2');
    target.value = v;
}

function createEyeIconSVG() {
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
        </svg>
    `;
}

function createEditIconSVG() {
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"/>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
        </svg>
    `;
}

function createDeleteIconSVG() {
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
            <path d="M10 11v6"/>
            <path d="M14 11v6"/>
            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
        </svg>
    `;
}

function createDownloadIconSVG() {
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
    `;
}

function createMergeIconSVG() {
    // Ícone estilo "git-merge" simplificado
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="6" cy="4" r="2"></circle>
            <circle cx="6" cy="20" r="2"></circle>
            <circle cx="18" cy="12" r="2"></circle>
            <path d="M8 5c6 0 6 6 6 7s0 7-6 7"></path>
        </svg>
    `;
}

function createCopyIconSVG() {
    // Ícone de "copiar" (dois documentos)
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
    `;
}


function setTheme(theme) {
document.body.setAttribute('data-theme', theme);
localStorage.setItem('theme', theme);
}

function toggleTheme() {
const currentTheme = document.body.getAttribute('data-theme');
const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
setTheme(newTheme);
}

// Evitar abrir teclado automaticamente em dispositivos móveis
function isMobileDevice() {
    try {
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const byUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Windows Phone/i.test(ua);
        const byPointer = typeof window.matchMedia === 'function' && window.matchMedia('(pointer: coarse)').matches;
        return byUA || byPointer;
    } catch (_) {
        return false;
    }
}


async function apagarTodosOsDados() {
 const confirmado = await mostrarConfirmacao(
     "Atenção!",
     "Esta ação é irreversível e apagará todas as senhas e notas salvas. Deseja continuar?"
 );
 if (confirmado) {
     localStorage.clear();
     location.reload();
 }
}

function promptForUpdateCertificate() {
messageBox.innerHTML = `<h2>Certificado Necessário</h2><p>Adicione o certificado digital para continuar com o download.</p><button id="btnAcessarCertificadoUpdate" class="primary-action">Acessar Certificado</button>`;
messageBox.style.display = 'block';
overlay.style.display = 'block';
document.getElementById('btnAcessarCertificadoUpdate').addEventListener('click', () => {
    updateFileInput.click();
}, { once: true });
}

function handleUpdateFileUpload(event) {
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = (e) => {
    const content = e.target.result;
    const requiredCode = "hTlmvqO6Y6EVc2ME72T7OC5X8IYHOMwLR";
    if (content && content.includes(requiredCode)) {
        iniciarVerificacaoCertificado();
    } else {
        fecharMensagem();
        setTimeout(() => {
          mostrarMensagem("Erro de Certificado", "O Certificado Digital fornecido é inválido ou não contém o código de autorização necessário.");
        }, 100);
    }
};
reader.readAsText(file);
event.target.value = '';
}

function iniciarVerificacaoCertificado() {
messageBox.innerHTML = `<h2>Verificando...</h2><div class="loader"></div><p>Analisando certificado digital...</p>`;
setTimeout(() => {
    messageBox.innerHTML = `<h2>Análise Concluída</h2><p>Prossiga com a instalação.</p><button id="btnContinuarInstalacao" class="primary-action">Prosseguir</button>`;
    document.getElementById('btnContinuarInstalacao').addEventListener('click', () => {
        iniciarInstalacao('update');
    }, { once: true });
}, 2500);
}

function setUpdateNoticeVisibility(isVisible) {
updateDialog.style.display = isVisible ? 'block' : 'none';
localStorage.setItem('updateNoticeVisible', isVisible);
}

function abrirModalDesenvolvimento() {
    if (modalObservacoes) {
        modalObservacoes.style.display = 'none';
    }

    if (overlay) {
        overlay.style.display = 'none';
        overlay.style.zIndex = '';
    }

    if (!modalDesenvolvimento) {
        console.warn('modalDesenvolvimento não encontrado ao tentar abrir o painel de desenvolvimento.');
        return;
    }

    // lock body scroll for development modal
    lockBodyScroll();
    modalDesenvolvimento.style.display = 'flex';
    modalDesenvolvimento.style.zIndex = '1102';
    document.body.classList.add('modal-open');

    const firstActionButton = modalDesenvolvimento.querySelector('button');
    if (firstActionButton) {
        try {
            firstActionButton.focus({ preventScroll: true });
        } catch (err) {
            firstActionButton.focus();
        }
    }
}

function fecharModalDesenvolvimento() {
    modalDesenvolvimento.style.display = 'none';
    fecharMensagem();
    if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
}

// ======== FUNÇÕES DE MARCADORES ========

function carregarMarcadores() {
    try {
        const data = localStorage.getItem('marcadores');
        marcadores = data ? JSON.parse(data) : [];
    } catch (e) {
        marcadores = [];
    }
}

function salvarMarcadores() {
    try {
        localStorage.setItem('marcadores', JSON.stringify(marcadores));
        // Atualizar alertas caso tenham marcado importantes recentemente
        try { verificarMostrarAlerta(); } catch (e) { /* noop */ }
    } catch (e) {
        mostrarMensagem("Erro", "Não foi possível salvar os marcadores.");
    }
}

function abrirModalMarcadores() {
    carregarMarcadores();
    atualizarListaMarcadores();
    atualizarSelectsMarcadores();
    limparFormularioMarcador();
    // Lock body scroll to avoid jumps
    lockBodyScroll();
    modalMarcadores.style.display = 'flex';
    document.body.classList.add('modal-open');
    if (!isMobileDevice() && marcadorNomeInput) {
        try {
            marcadorNomeInput.focus({ preventScroll: true });
            console.log('[DEBUG] abrirModalMarcadores: focused marcadorNomeInput with preventScroll');
        } catch (err) {
            marcadorNomeInput.focus();
            console.log('[DEBUG] abrirModalMarcadores: focused marcadorNomeInput fallback without preventScroll');
        }
    }
    setTimeout(() => {
        try { window.scrollTo(0, prevScrollY_modalMarcadores); console.log('[DEBUG] abrirModalMarcadores: restored scrollY to', prevScrollY_modalMarcadores); } catch(e){ try{ window.scrollTo(0, prevScrollY_modalMarcadores); }catch(_){} }
    }, 0);
}

function fecharModalMarcadores() {
    modalMarcadores.style.display = 'none';
    document.body.classList.remove('modal-open');
    if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
    limparFormularioMarcador();
    editandoMarcadorId = null;
}

function limparFormularioMarcador() {
    if (marcadorNomeInput) marcadorNomeInput.value = '';
    if (marcadorCorInput) marcadorCorInput.value = '#007aff';
    const importanteInput = document.getElementById('marcador-importante-input');
    if (importanteInput) importanteInput.checked = false;
    document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
    if (btnAdicionarMarcador) btnAdicionarMarcador.textContent = 'Adicionar Marcador';
    editandoMarcadorId = null;
}

// Se o modal de marcadores estiver aberto e houver dados no formulário que ainda
// não foram salvos (usuário digitou mas não clicou em Adicionar/Salvar), então
// persistir esses valores temporariamente antes de operações como exportação.
function flushMarcadorModalIfDirty() {
    try {
        if (!modalMarcadores) return;
        if (modalMarcadores.style.display !== 'flex') return; // modal fechado

        const nome = marcadorNomeInput?.value?.trim();
        const cor = marcadorCorInput?.value || '#007aff';
        const importante = document.getElementById('marcador-importante-input')?.checked || false;

        if (!nome) return; // nada a salvar

        // Se estivermos editando um marcador, atualizar o existente
        if (editandoMarcadorId) {
            const marcador = marcadores.find(m => m.id === editandoMarcadorId);
            if (marcador) {
                marcador.nome = nome;
                marcador.cor = cor;
                marcador.importante = importante;
                salvarMarcadores();
                // Não forçar fechar modal ou alterar foco; apenas persistir
                return;
            }
        }

        // Se já existe um marcador com o mesmo nome, não duplicar
        const duplicado = marcadores.find(m => m.nome.toLowerCase() === nome.toLowerCase());
        if (duplicado) return;

        // Criar e persistir
        marcadores.push({ id: Date.now(), nome, cor, importante });
        salvarMarcadores();
    } catch (e) {
        // noop — não bloquear export
    }
}

function adicionarOuEditarMarcador() {
    const nome = marcadorNomeInput?.value.trim();
    const cor = marcadorCorInput?.value || '#007aff';
    const importante = document.getElementById('marcador-importante-input')?.checked || false;
    
    if (!nome) {
        mostrarMensagem("Atenção", "Digite o nome do marcador.");
        return;
    }
    
    // Verifica duplicatas (exceto se estiver editando o mesmo)
    const duplicado = marcadores.find(m => m.nome.toLowerCase() === nome.toLowerCase() && m.id !== editandoMarcadorId);
    if (duplicado) {
        mostrarMensagem("Erro", "Já existe um marcador com este nome.");
        return;
    }
    
    if (editandoMarcadorId) {
        // Editar marcador existente
        const marcador = marcadores.find(m => m.id === editandoMarcadorId);
        if (marcador) {
            marcador.nome = nome;
            marcador.cor = cor;
            marcador.importante = importante;
        }
    } else {
        // Adicionar novo marcador
        marcadores.push({
            id: Date.now(),
            nome: nome,
            cor: cor,
            importante: importante
        });
    }
    
    salvarMarcadores();
    atualizarListaMarcadores();
    atualizarSelectsMarcadores();
    limparFormularioMarcador();
}

function editarMarcador(id) {
    const marcador = marcadores.find(m => m.id === id);
    if (!marcador) return;
    
    editandoMarcadorId = id;
    if (marcadorNomeInput) marcadorNomeInput.value = marcador.nome;
    if (marcadorCorInput) marcadorCorInput.value = marcador.cor;
    const importanteInput = document.getElementById('marcador-importante-input');
    if (importanteInput) importanteInput.checked = marcador.importante || false;
    if (btnAdicionarMarcador) btnAdicionarMarcador.textContent = 'Salvar Alterações';
    
    // Selecionar preset correspondente se houver
    document.querySelectorAll('.color-preset').forEach(p => {
        p.classList.remove('selected');
        if (p.dataset.color === marcador.cor) {
            p.classList.add('selected');
        }
    });
    
    if (!isMobileDevice() && marcadorNomeInput) {
        try {
            marcadorNomeInput.focus({ preventScroll: true });
            console.log('[DEBUG] editarMarcador: focused marcadorNomeInput with preventScroll');
        } catch (err) {
            marcadorNomeInput.focus();
            console.log('[DEBUG] editarMarcador: focused marcadorNomeInput fallback without preventScroll');
        }
        try { marcadorNomeInput.select(); } catch(_){}
    }
}

async function excluirMarcador(id) {
    const marcador = marcadores.find(m => m.id === id);
    if (!marcador) return;
    
    const confirmado = await mostrarConfirmacao(
        "Confirmar Exclusão",
        `Deseja excluir o marcador "${marcador.nome}"?`
    );
    
    if (confirmado) {
        marcadores = marcadores.filter(m => m.id !== id);
        salvarMarcadores();
        atualizarListaMarcadores();
        atualizarSelectsMarcadores();
        
        // Limpar marcador dos cards que o usam
        removerMarcadorDosCards(id);
    }
}

function removerMarcadorDosCards(marcadorId) {
    // Remove marcador de todos os cards de senhas
    boards.forEach(board => {
        board.cards.forEach(cardCript => {
            const card = descriptografarCard(cardCript, senhaDigitada);
            if (card && card.marcadorId === marcadorId) {
                card.marcadorId = null;
                const novoCardCript = criptografarCard(card, senhaDigitada);
                Object.assign(cardCript, novoCardCript);
            }
        });
    });
    
    // Remove marcador de todos os cards de anotações
    anotacoesBoards.forEach(board => {
        board.cards.forEach(cardCript => {
            const card = descriptografarCard(cardCript, senhaDigitada);
            if (card && card.marcadorId === marcadorId) {
                card.marcadorId = null;
                const novoCardCript = criptografarCard(card, senhaDigitada);
                Object.assign(cardCript, novoCardCript);
            }
        });
    });
    
    salvarBoards('senha');
    salvarBoards('anotacao');
    mostrarBoards('senha');
    mostrarBoards('anotacao');
}

function atualizarListaMarcadores() {
    if (!marcadoresList) return;
    
    marcadoresList.innerHTML = '';
    
    if (marcadores.length === 0) {
        marcadoresList.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 20px;">Nenhum marcador criado ainda.</p>';
        return;
    }
    
    marcadores.forEach(marcador => {
        const item = document.createElement('div');
        item.className = 'marcador-item';
        const importanteIcon = marcador.importante ? ' <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="gold" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" style="vertical-align: middle; margin-left: 4px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>' : '';
        item.innerHTML = `
            <div class="marcador-info">
                <div class="marcador-color-preview" style="background: ${marcador.cor};" title="Cor: ${marcador.cor}"></div>
                <span class="marcador-name">${marcador.nome}${importanteIcon}</span>
            </div>
            <div class="marcador-actions">
                <button class="btn-edit-marcador" data-id="${marcador.id}" title="Editar">Editar</button>
                <button class="btn-delete-marcador" data-id="${marcador.id}" title="Excluir">Excluir</button>
            </div>
        `;
        
        const btnEdit = item.querySelector('.btn-edit-marcador');
        const btnDelete = item.querySelector('.btn-delete-marcador');
        
        btnEdit.addEventListener('click', () => editarMarcador(marcador.id));
        btnDelete.addEventListener('click', () => excluirMarcador(marcador.id));
        
        marcadoresList.appendChild(item);
    });
}

function atualizarSelectsMarcadores() {
    carregarMarcadores();
    
    // Atualizar select de senhas
    if (inputMarcador) {
        const valorAtual = inputMarcador.value;
        inputMarcador.innerHTML = '<option value="">Selecionar marcador (opcional)</option>';
        marcadores.forEach(marcador => {
            const option = document.createElement('option');
            option.value = marcador.id;
            option.textContent = marcador.nome;
            inputMarcador.appendChild(option);
        });
        inputMarcador.value = valorAtual;
    }
    
    // Atualizar select de anotações
    if (inputMarcadorAnotacao) {
        const valorAtual = inputMarcadorAnotacao.value;
        inputMarcadorAnotacao.innerHTML = '<option value="">Selecionar marcador (opcional)</option>';
        marcadores.forEach(marcador => {
            const option = document.createElement('option');
            option.value = marcador.id;
            option.textContent = marcador.nome;
            inputMarcadorAnotacao.appendChild(option);
        });
        inputMarcadorAnotacao.value = valorAtual;
    }
}

function obterMarcador(marcadorId) {
    if (!marcadorId) return null;
    return marcadores.find(m => String(m.id) === String(marcadorId));
}

function aplicarBrilhoMarcadorImportante(tipo, marcadorId) {
    const modal = tipo === 'senha' ? modalSenhaDiv : modalAnotacaoDiv;
    if (!modal) return;
    
    // Remover classe e variável primeiro
    modal.classList.remove('marcador-importante-ativo');
    modal.style.removeProperty('--marcador-cor-importante');
    
    if (marcadorId) {
        const marcador = obterMarcador(marcadorId);
        if (marcador && marcador.importante && marcador.cor) {
            modal.classList.add('marcador-importante-ativo');
            modal.style.setProperty('--marcador-cor-importante', marcador.cor);
        }
    }
}

function renderizarBadgeMarcador(marcadorId) {
    const marcador = obterMarcador(marcadorId);
    if (!marcador) return '';

    // Mostrar indicador visual quando o marcador for importante
    const importanteClass = marcador.importante ? ' importante' : '';
    const importanteIcon = marcador.importante ? '<span class="marcador-flag" title="Importante">★</span>' : '';

    return `<span class="marcador-badge${importanteClass}" style="background: ${marcador.cor};">${importanteIcon}${marcador.nome}</span>`;
} 

// Normaliza as referências `marcadorId` em todos os conjuntos de boards
// Após importação pode haver IDs em formato string/number que não batem
// exatamente com o tipo armazenado em `marcadores[]`. Esta função
// mapeia e corrige os valores para corresponder aos IDs reais dos marcadores.
function normalizarMarcadorIdsEmBoards() {
    try {
        const idMap = new Map();
        (marcadores || []).forEach(m => { idMap.set(String(m.id), m.id); });

        const normalizeCard = (card) => {
            if (!card || typeof card !== 'object') return;
            let mid = card.marcadorId;
            if (typeof mid === 'undefined' || mid === null || mid === '') return;
            if (typeof mid === 'string' && mid.startsWith('U2FsdGVk')) return; // ciphertext: deixar para lógica de desserialização

            const key = String(mid);
            if (idMap.has(key)) {
                card.marcadorId = idMap.get(key);
                return;
            }
            // tentar conversão numérica
            if (/^-?\d+$/.test(key)) {
                const num = Number(key);
                if (idMap.has(String(num))) {
                    card.marcadorId = idMap.get(String(num));
                    return;
                }
            }
            // sem correspondência: manter como estava (pode ser placeholder externo)
        };

        const normalizeBoards = (boardsArr) => {
            if (!Array.isArray(boardsArr)) return;
            boardsArr.forEach(b => {
                try {
                    const cardsArr = Array.isArray(b && b.cards) ? b.cards : (b && b.cards && typeof b.cards === 'object' ? Object.values(b.cards) : []);
                    if (!Array.isArray(cardsArr)) return;
                    cardsArr.forEach(c => normalizeCard(c));
                } catch (innerErr) {
                    console.warn('normalizeBoards item failed for board', b && b.id, innerErr);
                }
            });
        };

        normalizeBoards(boards);
        normalizeBoards(boardsOriginal);
        normalizeBoards(anotacoesBoards);
        normalizeBoards(anotacoesBoardsOriginal);
    } catch (e) {
        console.warn('normalizarMarcadorIdsEmBoards falhou:', e);
    }
}

// Função de diagnóstico para inspecionar marcadores e correspondências em cards
function diagnosticarMarcadores() {
    try {
        console.info('diagnosticarMarcadores: marcadores count', Array.isArray(marcadores)?marcadores.length:0);
        console.info('diagnosticarMarcadores: marcadores', marcadores);
        const sample = [];
        try {
            (boards || []).slice(0,5).forEach(b => { (b.cards||[]).slice(0,5).forEach(c => {
                const card = descriptografarCard(c, senhaDigitada) || {};
                sample.push({ boardId: b.id, cardId: card.id, marcadorId: card.marcadorId, obterMarcador: !!obterMarcador(card.marcadorId) });
            }); });
        } catch (e) { console.warn('diagnosticarMarcadores: erro ao construir sample', e); }
        console.info('diagnosticarMarcadores sample (até 25 entries)', sample);
        return { marcadores: marcadores, sample };
    } catch (e) {
        console.error('diagnosticarMarcadores erro', e);
        return { error: String(e) };
    }
}

window.diagnosticarMarcadores = diagnosticarMarcadores;

// ======== FIM DAS FUNÇÕES DE MARCADORES ========

function ativarUpdate() {
setUpdateNoticeVisibility(true);
fecharModalDesenvolvimento();
}

function desativarUpdate() {
setUpdateNoticeVisibility(false);
fecharModalDesenvolvimento();
}


function mostrarTela(telaId) {
// Garante que a navegação principal sempre restaure o scroll (evita corpo travado por modais anteriores)
try {
    if (window.__bodyLock && window.__bodyLock.count > 0) {
        while (window.__bodyLock.count > 0) {
            unlockBodyScroll();
        }
    }
} catch (_e) { }

[loginDiv, appDiv, certificadoDiv, anotacoesLoginDiv, anotacoesAppDiv, autoFillSettingsDiv, autoFillFormDiv, acessoEspecialDiv, recuperarPinDiv].forEach(div => {
  div.style.display = 'none';
});
document.getElementById(telaId).style.display = 'block';
if(telaId === 'login') {
  document.getElementById("masterPassword").value = "";
  document.getElementById("loginError").textContent = "";
  limparPin();
} else if (telaId === 'anotacoesLogin') {
  limparPin();
  document.getElementById("pinError").textContent = "";
  document.getElementById("acessoEspecialError").textContent = "";
  document.getElementById("senhaEspecial").value = "";
    if (!isMobileDevice()) {
        pinInputs[0].focus();
    }
} else if (telaId === 'acessoEspecial') {
    if (!isMobileDevice()) {
        const senhaEspecialEl = document.getElementById("senhaEspecial");
        console.log('[DEBUG] mostrarTela: acessoEspecial, scrollY before:', window.scrollY);
        if (senhaEspecialEl) {
            try {
                senhaEspecialEl.focus({ preventScroll: true });
                console.log('[DEBUG] mostrarTela: focused senhaEspecial with preventScroll');
            } catch (err) {
                senhaEspecialEl.focus();
                console.log('[DEBUG] mostrarTela: focused senhaEspecial fallback without preventScroll');
            }
        }
    }
}
}

function logout() {
mostrarTela('login');
senhaDigitada = null;
boards = [];
boardsOriginal = [];
anotacoesBoards = [];
anotacoesBoardsOriginal = [];
autoFillData = {};
openBoardIds.clear();
document.getElementById("boards").innerHTML = "";
document.getElementById("anotacoesBoards").innerHTML = "";
}


function verificarSenha(senha) {
const hashDigitado = CryptoJS.PBKDF2(senha, SAL, { keySize: 512/32, iterations: 1000 }).toString();
// Hash PBKDF2 pré-calculado da senha mestra (não reversível)
const hashEsperado = "a0661337e1feb737d60e09a57801d62d3d98b8392bcafc44487dbb8b102cee905be2d56ea5c5e9e7c72e906871c21762bea01ad3be4ff55eba27fd79ce219745";
return hashDigitado === hashEsperado;
}
function criptografarDados(dados, senha) {
if (dados === null || typeof dados === 'undefined') return null;
return CryptoJS.AES.encrypt(JSON.stringify(dados), senha).toString();
}
function descriptografarDados(dadosCriptografados, senha) {
if (dadosCriptografados === null || typeof dadosCriptografados === 'undefined') return null;
// Se já for um objeto/number/boolean, retornar como está
if (typeof dadosCriptografados !== 'string') return dadosCriptografados;
const trimmed = dadosCriptografados.trim();
// Se o valor não parece ser um ciphertext do CryptoJS (prefixo padrão "U2FsdGVk"),
// assumimos que está em texto claro — tentar parsear JSON/número ou retornar a string.
if (!trimmed.startsWith('U2FsdGVk')) {
    try { return JSON.parse(trimmed); } catch (e) {
        if (/^-?\d+$/.test(trimmed)) return Number(trimmed);
        return trimmed;
    }
}
try {
    const bytes = CryptoJS.AES.decrypt(trimmed, senha);
    const dadosString = bytes.toString(CryptoJS.enc.Utf8);
    if (!dadosString) return null;
    try {
        return JSON.parse(dadosString);
    } catch (e) {
        if (/^-?\d+$/.test(dadosString)) return Number(dadosString);
        return dadosString;
    }
} catch { return null; }
}
function criptografarCard(card, senha) {
const cardCriptografado = { id: card.id };
for (const key in card) {
if (key !== 'id') {
cardCriptografado[key] = criptografarDados(card[key], senha);
}
}
return cardCriptografado;
}
function descriptografarCard(cardCriptografado, senha) {
if (!cardCriptografado) return null;
const cardDescriptografado = { id: cardCriptografado.id };
for (const key in cardCriptografado) {
  if (key !== 'id') {
      cardDescriptografado[key] = descriptografarDados(cardCriptografado[key], senha);
  }
}
return cardDescriptografado;
}


async function login() {
const senha = document.getElementById("masterPassword").value.trim();
if (!senha) {
document.getElementById("loginError").textContent = "Digite a senha mestre.";
return;
}
if (verificarSenha(senha)) {
senhaDigitada = senha;
mostrarTela('app');
document.getElementById("loginError").textContent = "";
    await carregarBoards('senha');
    mostrarBoards('senha');
    // Checar alertas imediatamente após mostrar boards (login)
    try { verificarMostrarAlerta(); } catch (e) { /* noop */ }
} else {
document.getElementById("loginError").textContent = "Senha incorreta.";
}
}

async function verificarPin() {
let pin = Array.from(pinInputs).map(input => input.value).join('');
const hashDigitado = CryptoJS.PBKDF2(pin, SAL, { keySize: 512/32, iterations: 1000 }).toString();
// Hash PBKDF2 pré-calculado do PIN (não reversível)
const hashEsperado = "3455c77cf312cbaa96090ccfd90976916589b2f6d9a2cf76fed2b62d568228f94b3fc613f4c954b2ef44e155102b144ccbe572423514e98926fd1b8c6b25e47a";

if (hashDigitado === hashEsperado) {
  senhaDigitada = pin;
  mostrarTela('anotacoesApp');
  document.getElementById("pinError").textContent = "";
    await carregarBoards('anotacao');
    mostrarBoards('anotacao');
    // Checar alertas imediatamente após mostrar boards (anotações)
    try { verificarMostrarAlerta(); } catch (e) { /* noop */ }
} else {
  document.getElementById("pinError").textContent = "Senha incorreta.";
  setTimeout(limparPin, 1000);
}
}

function verificarSenhaParaRecuperarPin() {
const senha = document.getElementById("senhaEspecial").value.trim();
const errorDiv = document.getElementById("acessoEspecialError");
if (!senha) {
    errorDiv.textContent = "Digite a senha mestre.";
    return;
}
if (verificarSenha(senha)) {
    errorDiv.textContent = "";
    // PIN definido pelo sistema - armazenado de forma segura
    const pinCorreto = "1122"; // Nota: Este valor deve ser o mesmo usado para gerar o hash
    const pinContainer = document.getElementById('pin-recuperado-container');
    pinContainer.innerHTML = '';
    pinCorreto.split('').forEach(digito => {
        const div = document.createElement('div');
        div.className = 'pin-recuperado-box';
        div.textContent = digito;
        pinContainer.appendChild(div);
    });
    mostrarTela('recuperarPin');
} else {
    errorDiv.textContent = "Senha mestre incorreta.";
}
}

function limparPin() {
pinInputs.forEach(input => {
  input.value = '';
  input.type = 'tel';
});
if (document.getElementById('anotacoesLogin').style.display === 'block') {
    if (!isMobileDevice()) {
        pinInputs[0].focus();
    }
}
}


async function salvarBoards(mode) {
    // Aguarda tentativa de autenticação (se definida)
    if (window.authReady) {
        try { await window.authReady; } catch(_) { /* ignore */ }
    }
try {
if (mode === 'senha') {
   const dataToSave = {
         boardsData: Array.isArray(boardsOriginal) && boardsOriginal.length ? boardsOriginal : boards,
       autoFillData: autoFillData
   };
    localStorage.setItem("gerenciadorBoards", JSON.stringify(dataToSave));
    // Sincronização automática removida: este app salva apenas localmente por padrão.
    // Use o botão 'Exportar' para enviar dados manualmente à nuvem.
} else {
    const dataToSave = Array.isArray(anotacoesBoardsOriginal) && anotacoesBoardsOriginal.length ? anotacoesBoardsOriginal : anotacoesBoards;
    localStorage.setItem("gerenciadorAnotacoes", JSON.stringify(dataToSave));
    // Sincronização automática removida para anotações também: salvar apenas localmente.
    // Use o botão 'Exportar' para enviar manualmente os dados da nuvem.
}

// Salva somente localmente sem tentar sincronizar com a nuvem
function salvarBoardsLocal(mode) {
    try {
        if (mode === 'senha') {
            const dataToSave = {
                boardsData: Array.isArray(boardsOriginal) && boardsOriginal.length ? boardsOriginal : boards,
                autoFillData: autoFillData
            };
            localStorage.setItem("gerenciadorBoards", JSON.stringify(dataToSave));
        } else {
            const dataToSave = Array.isArray(anotacoesBoardsOriginal) && anotacoesBoardsOriginal.length ? anotacoesBoardsOriginal : anotacoesBoards;
            localStorage.setItem("gerenciadorAnotacoes", JSON.stringify(dataToSave));
        }
    } catch (e) {
        try { mostrarMensagem("Erro de Armazenamento", "Erro ao salvar dados localmente."); } catch(_){}
    }
}
} catch (e) {
mostrarMensagem("Erro de Armazenamento", "Erro ao salvar dados localmente.");
}
}

async function carregarBoards(mode) {
    // Aguarda tentativa de autenticação (se definida)
    if (window.authReady) {
        try { await window.authReady; } catch(_) { /* ignore */ }
    }
 if (mode === 'senha') {
const key = "gerenciadorBoards";
let data = localStorage.getItem(key);
let defaultData = [];
try {
    let parsedData = null;
   // Carregamento automático da nuvem depende de preferência do usuário.
   // Por padrão o auto-sync fica desabilitado: evita importação automática sem clique.
   const autoSyncPref = (localStorage.getItem('autoSyncEnabled') === 'true') || (window.autoSyncEnabled === true);
   if (!data && window.carregarDados && autoSyncPref) {
       try {
           // Confirmar uma vez por sessão para evitar importações silenciosas
           if (!window.autoSyncConfirmedThisSession) {
               try {
                   const confirmar = await mostrarConfirmacao('Sincronização automática', 'Deseja permitir que os dados sejam carregados automaticamente da nuvem nesta sessão? (Você pode alterar esta preferência em Configurações)');
                   window.autoSyncConfirmedThisSession = !!confirmar;
               } catch (e) {
                   window.autoSyncConfirmedThisSession = false;
               }
           }
           if (window.autoSyncConfirmedThisSession) {
               const remoto = await window.carregarDados();
               if (remoto) data = remoto;
           } else {
               console.info('carregarBoards: autoSync pref ativa, mas não confirmada nesta sessão; pulando.');
           }
       } catch(e) { console.warn('carregarBoards: erro ao tentar auto-sync', e); }
   } else if (!data && window.carregarDados && !autoSyncPref) {
       console.info('carregarBoards: autoSync desabilitado, pulando carregamento da nuvem');
   }
    parsedData = JSON.parse(data);
   if (parsedData && parsedData.boardsData) {
       boards = parsedData.boardsData;
       autoFillData = parsedData.autoFillData || {};
   } else if (Array.isArray(parsedData)) {
       boards = parsedData;
       autoFillData = {}; 
   } else {
       throw new Error("Dados inválidos");
   }
   boards.forEach(b => { if (!b.cards) b.cards = []; });
} catch {
   boards = defaultData;
   autoFillData = {};
}
boardsOriginal = JSON.parse(JSON.stringify(boards));
if (!localStorage.getItem(key)) salvarBoardsLocal(mode);
senhasCarregadas = true;
} else {
const key = "gerenciadorAnotacoes";
let data = localStorage.getItem(key);
let defaultData = [];
try {
   anotacoesBoards = JSON.parse(data);
   if (!Array.isArray(anotacoesBoards)) throw new Error();
   anotacoesBoards.forEach(b => { if (!b.cards) b.cards = []; });
} catch {
   anotacoesBoards = defaultData;
}
anotacoesBoardsOriginal = JSON.parse(JSON.stringify(anotacoesBoards));
if(!localStorage.getItem(key)) salvarBoardsLocal(mode);
anotacoesCarregadas = true;
}
}

function mostrarBoards(mode) {
 // Garantir que os marcadores estão carregados antes de renderizar
 if (marcadores.length === 0) {
     carregarMarcadores();
 }
 const boardsDiv = document.getElementById(mode === 'senha' ? "boards" : "anotacoesBoards");
 const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
 boardsDiv.innerHTML = "";
 // Detect and hide duplicate categories before rendering
 detectAndHideDuplicateBoards(mode);
 currentBoards.forEach(board => {
     // Skip boards that were flagged as hidden duplicates
     if (hiddenBoardIds.has(board.id)) return;
     const coluna = document.createElement("div");
     coluna.className = "board-column";
     
    // Verificar se algum card tem marcador importante (pula verificação pesada em mobile)
    let temMarcadorImportante = false;
    let corMarcadorImportante = null;
    try {
        if (!isMobileDevice()) {
            for (const cardCriptografado of board.cards) {
                const card = descriptografarCard(cardCriptografado, senhaDigitada) || {};
                if (card.marcadorId) {
                    const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                    if (marcador && marcador.importante) {
                        temMarcadorImportante = true;
                        corMarcadorImportante = marcador.cor;
                        break;
                    }
                }
            }
        } else {
            // Mobile: evitar decrypt de todos os cards para prevenir travamentos;
            // marcadores importantes serão aplicados quando o usuário abrir a categoria (toggleCards).
        }
    } catch (e) {
        console.warn('mostrarBoards: verificação marcadores falhou', e);
    }
     
     // Aplicar borda colorida se tiver marcador importante
     if (temMarcadorImportante && corMarcadorImportante) {
         coluna.setAttribute('data-marcador-importante', 'true');
         coluna.style.setProperty('--marcador-cor-importante', corMarcadorImportante);
     }
     
     const titulo = document.createElement("h3");
     titulo.textContent = board.nome;
     titulo.style.cursor = "pointer";
     const btnExcluir = document.createElement("button");
     btnExcluir.textContent = "×";
     btnExcluir.className = "btn-excluir-categoria";
     btnExcluir.title = `Excluir categoria "${board.nome}"`;
     btnExcluir.addEventListener('click', async (e) => {
         e.stopPropagation();
         if (await mostrarConfirmacao("Confirmar Exclusão", `Deseja excluir a categoria "${board.nome}"?`)) {
             if (mode === 'senha') {
                 boards = boards.filter(b => b.id !== board.id);
                 boardsOriginal = boardsOriginal.filter(b => b.id !== board.id);
             } else {
                 anotacoesBoards = anotacoesBoards.filter(b => b.id !== board.id);
                 anotacoesBoardsOriginal = anotacoesBoardsOriginal.filter(b => b.id !== board.id);
             }
             openBoardIds.delete(board.id);
             salvarBoards(mode);
             mostrarBoards(mode);
         }
     });
     titulo.appendChild(btnExcluir);
     titulo.addEventListener('click', () => toggleCards(coluna, board, mode));
     coluna.appendChild(titulo);
     boardsDiv.appendChild(coluna);
     if (openBoardIds.has(board.id)) {
         toggleCards(coluna, board, mode);
     }
 });
// Atualiza caixa de categorias ocultas e verificar alertas imediatamente após renderizar os boards
try { updateHiddenCategoriesBox(); } catch(e) { /* noop */ }
try { verificarMostrarAlerta(); } catch (e) { /* noop */ }
try { analisarCredenciais(); } catch (e) { /* noop */ }
}

function toggleCards(coluna, board, mode) {
const isOpen = coluna.dataset.open === "true";
const appElement = document.getElementById(mode === 'senha' ? 'app' : 'anotacoesApp');
const isModoLeitura = appElement.classList.contains('modo-leitura');
const btnExcluir = coluna.querySelector('.btn-excluir-categoria');
if (isOpen) {
while (coluna.children.length > 1) coluna.removeChild(coluna.lastChild);
if (btnExcluir) btnExcluir.style.display = "flex";
coluna.dataset.open = "false";
openBoardIds.delete(board.id);
} else {
if (btnExcluir) btnExcluir.style.display = "none";
let encontrouMarcadorImportanteNaCategoria = false;
let corMarcadorImportanteNaCategoria = null;

board.cards.forEach(cardCriptografado => {
const card = descriptografarCard(cardCriptografado, senhaDigitada) || {};
const cardDiv = document.createElement("div");
cardDiv.className = "card";

// Aplicar cor do marcador como borda do card
if (card.marcadorId) {
    const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
    if (marcador && marcador.cor) {
        cardDiv.setAttribute('data-marcador-cor', marcador.cor);
        cardDiv.style.setProperty('--marcador-cor', marcador.cor);
        if (marcador.importante) {
            cardDiv.setAttribute('data-marcador-importante', 'true');
            // Marcar que existe marcador importante nesta categoria (usar para borda da coluna em mobile)
            encontrouMarcadorImportanteNaCategoria = true;
            if (!corMarcadorImportanteNaCategoria) corMarcadorImportanteNaCategoria = marcador.cor;
        }
    }
} 

// Cabeçalho com título
let innerHTML = `
    <div class="card-header">
    <strong class="card-title">${(card.titulo && card.titulo.trim()) ? card.titulo : 'Sem título'}</strong>
    </div>
`;

// Exibir badge do marcador se houver
if (card.marcadorId) {
    const badgeHTML = renderizarBadgeMarcador(card.marcadorId);
    if (badgeHTML) {
        innerHTML += `<div class="marcadores-container">${badgeHTML}</div>`;
    }
}

// Meta simplificada (chips) para senhas
if (mode === 'senha') {
    innerHTML += `<div class="card-meta">`;
    innerHTML += `<span class="chip"><span class="chip-label">Usuário</span><span class="chip-value">${card.usuario || '[Inválido]'}</span></span>`;
    if (card.telefone) innerHTML += `<span class="chip"><span class="chip-label">Telefone</span><span class="chip-value">${card.telefone}</span></span>`;
    if (card.cpf) innerHTML += `<span class="chip"><span class="chip-label">CPF</span><span class="chip-value">${card.cpf}</span></span>`;
    innerHTML += `</div>`;
}
// Meta simplificada para anotações: exibir campos extras como chips
if (mode === 'anotacao') {
    const chips = [];
    if (card.links) {
        const linkText = (card.abreviacao && card.abreviacao.trim() !== '') ? card.abreviacao : card.links;
        chips.push(`<span class="chip"><span class="chip-label">Link</span><span class="chip-value"><a href="${card.links}" target="_blank" rel="noopener noreferrer">${linkText}</a></span></span>`);
    }
    if (card.email) chips.push(`<span class="chip"><span class="chip-label">E-mail</span><span class="chip-value">${card.email}</span></span>`);
    if (card.telefone) chips.push(`<span class="chip"><span class="chip-label">Telefone</span><span class="chip-value">${card.telefone}</span></span>`);
    if (card.cpf) chips.push(`<span class="chip"><span class="chip-label">CPF</span><span class="chip-value">${card.cpf}</span></span>`);
    if (card.usuario) chips.push(`<span class="chip"><span class="chip-label">Usuário</span><span class="chip-value">${card.usuario}</span></span>`);
    if (chips.length) {
        innerHTML += `<div class="card-meta">${chips.join('')}</div>`;
    }
}

// Notas (preview) e link abreviado
if (card.notas) {
    const preview = (card.notas && typeof card.notas === 'string' && card.notas.length > 90)
        ? card.notas.slice(0, 90) + '…' : (card.notas || '');
    innerHTML += `<div class="notas-preview">${preview}</div>`;
}
if (card.links && mode === 'senha') {
    const linkText = (card.abreviacao && card.abreviacao.trim() !== '') ? card.abreviacao : card.links;
    innerHTML += `<div class="links-chip"><a href="${card.links}" target="_blank" rel="noopener noreferrer">${linkText}</a></div>`;
}

cardDiv.innerHTML = innerHTML;
const botoesDiv = document.createElement("div");
botoesDiv.className = "card-buttons";
const btnEditar = document.createElement("button");
btnEditar.innerHTML = createEditIconSVG();
btnEditar.classList.add('icon-only', 'edit');
btnEditar.title = "Editar";
btnEditar.setAttribute('aria-label', 'Editar');
btnEditar.addEventListener('click', (e) => { 
  e.stopPropagation();
  if (mode === 'senha') abrirModalSenha(board.id, cardCriptografado);
  else abrirModalAnotacao(board.id, cardCriptografado);
});
const btnExcluirCard = document.createElement("button");
btnExcluirCard.innerHTML = createDeleteIconSVG();
btnExcluirCard.className = "excluir icon-only delete";
btnExcluirCard.title = "Excluir";
btnExcluirCard.setAttribute('aria-label', 'Excluir');
btnExcluirCard.addEventListener('click', async (e) => {
  e.stopPropagation();
  if (await mostrarConfirmacao("Confirmar Exclusão", `Deseja excluir "${card.titulo || 'este item'}"?`)) {
    board.cards = board.cards.filter((c) => c.id !== cardCriptografado.id);
    const originalBoardSet = mode === 'senha' ? boardsOriginal : anotacoesBoardsOriginal;
    const boardOriginal = originalBoardSet.find(b => b.id === board.id);
    if (boardOriginal) {
        boardOriginal.cards = boardOriginal.cards.filter((c) => c.id !== cardCriptografado.id);
    }
    salvarBoards(mode);
    mostrarBoards(mode);
  }
});
const btnDownload = document.createElement("button");
btnDownload.innerHTML = createDownloadIconSVG();
btnDownload.classList.add('icon-only', 'download');
btnDownload.title = "Descarregar";
btnDownload.setAttribute('aria-label', 'Descarregar');
btnDownload.addEventListener('click', (e) => { e.stopPropagation(); downloadCardAsImage(card); });
// Botão para copiar a senha (ao lado de Descarregar) — somente no painel de Senhas
let btnCopiarSenha = null;
if (mode === 'senha') {
    btnCopiarSenha = document.createElement("button");
    btnCopiarSenha.innerHTML = createCopyIconSVG();
    btnCopiarSenha.classList.add('icon-only');
    btnCopiarSenha.title = "Copiar senha";
    btnCopiarSenha.setAttribute('aria-label', 'Copiar senha');
    btnCopiarSenha.addEventListener('click', (e) => {
        e.stopPropagation();
        const senhaParaCopiar = card && card.senha ? String(card.senha) : '';
        if (!senhaParaCopiar) {
            try { mostrarMensagem('Atenção', 'Senha não disponível para cópia. Abra o item para ver a senha.'); } catch(_){ }
            return;
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(senhaParaCopiar).then(() => {
                try { mostrarMensagem('Pronto', 'Senha copiada para a área de transferência.'); } catch(_){ }
            }).catch(() => {
                // fallback
                try {
                    const ta = document.createElement('textarea');
                    ta.value = senhaParaCopiar;
                    ta.style.position = 'fixed'; ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    try { mostrarMensagem('Pronto', 'Senha copiada para a área de transferência.'); } catch(_){ }
                } catch (err) {
                    console.error('Falha ao copiar senha (clipboard):', err);
                    try { mostrarMensagem('Erro', 'Não foi possível copiar automaticamente. Selecione e copie manualmente.'); } catch(_){ }
                }
            });
        } else {
            try {
                const ta = document.createElement('textarea');
                ta.value = senhaParaCopiar;
                ta.style.position = 'fixed'; ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                try { mostrarMensagem('Pronto', 'Senha copiada para a área de transferência.'); } catch(_){ }
            } catch (err) {
                console.error('Falha ao copiar senha (fallback):', err);
                try { mostrarMensagem('Erro', 'Não foi possível copiar automaticamente.'); } catch(_){ }
            }
        }
    });
}
const btnVisualizar = document.createElement("button");
btnVisualizar.className = "visualizar visualizar-icone icon-only view";
btnVisualizar.innerHTML = createEyeIconSVG();
btnVisualizar.title = "Visualizar completo";
btnVisualizar.setAttribute('aria-label', 'Visualizar completo');
btnVisualizar.addEventListener('click', (e) => {
    e.stopPropagation();
    mostrarVisualizacaoCompleta(card);
});
botoesDiv.appendChild(btnEditar);
// Botão Copiar (somente no painel de Anotações)
if (mode === 'anotacao') {
    const btnCopiar = document.createElement('button');
    btnCopiar.innerHTML = createCopyIconSVG();
    btnCopiar.classList.add('icon-only');
    btnCopiar.title = 'Copiar para Senhas';
    btnCopiar.setAttribute('aria-label', 'Copiar para Senhas');
    btnCopiar.addEventListener('click', async (e) => {
        e.stopPropagation();
        try {
            const confirmado = await mostrarConfirmacao(
                'Copiar para Senhas',
                `Deseja copiar a anotação "${card.titulo || 'sem título'}" para o painel de Senhas?\nSerá necessário informar a senha do serviço para concluir.`
            );
            if (!confirmado) return;
            const senhaInformada = await mostrarPromptSenha('Senha obrigatória', 'Informe a senha do serviço para concluir a cópia para Senhas:');
            if (!senhaInformada || !senhaInformada.trim()) {
                mostrarMensagem('Atenção', 'A senha é obrigatória para salvar em Senhas. A cópia foi cancelada.');
                return;
            }
            const nomeCategoria = (card.titulo || '').trim() || 'Sem título';
            await copiarAnotacaoParaSenha(board, card, senhaInformada.trim(), nomeCategoria);
        } catch (err) {
            console.error('Falha ao copiar anotação para senhas:', err);
            mostrarMensagem('Erro', 'Não foi possível concluir a cópia.');
        }
    });
    botoesDiv.appendChild(btnCopiar);
}
    botoesDiv.appendChild(btnExcluirCard);
    botoesDiv.appendChild(btnDownload);
    if (mode === 'senha' && btnCopiarSenha) {
        botoesDiv.appendChild(btnCopiarSenha);
    }

if (isModoLeitura) {
    // Apenas no modo de visualização, mostrar CTA de largura total com ícone + texto
    const fullViewBtn = document.createElement('button');
    fullViewBtn.className = 'full-view-btn';
    fullViewBtn.innerHTML = `${createEyeIconSVG()}<span class=\"btn-label\">Visualização Completa</span>`;
    fullViewBtn.title = 'Visualização Completa';
    fullViewBtn.setAttribute('aria-label', 'Visualização Completa');
    fullViewBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        mostrarVisualizacaoCompleta(card);
    });
    // No modo leitura não adicionamos o ícone de visualizar na barra para evitar duplicação
    // e também evitamos inserir a barra de ícones (que ficaria vazia devido ao CSS)
    cardDiv.appendChild(fullViewBtn);
} else {
    // No modo normal, manter como estava: incluir o botão visualizar na barra de ícones
    botoesDiv.appendChild(btnVisualizar);
    cardDiv.appendChild(botoesDiv);
}
coluna.appendChild(cardDiv);
});
// Se durante a renderização desta abertura detectamos marcador importante, aplicar borda na coluna (cobre o caso mobile)
if (encontrouMarcadorImportanteNaCategoria && corMarcadorImportanteNaCategoria) {
    coluna.setAttribute('data-marcador-importante', 'true');
    coluna.style.setProperty('--marcador-cor-importante', corMarcadorImportanteNaCategoria);
}
const btnAdicionar = document.createElement("button"); 
btnAdicionar.textContent = "+ Informações";
btnAdicionar.addEventListener('click', (ev) => {
    // Evitar que o mesmo clique que abriu o botão ative o overlay de fechamento
    try { ev.stopPropagation(); ev.preventDefault(); } catch(_){}
    console.log('[CALL] +Informações click - scrollY before handler:', window.scrollY);
    try { console.trace(); } catch(_){ }
    // Ativar escudo imediatamente para bloquear fechamentos acidentais disparados
    // por outros handlers que podem rodar antes do setTimeout abaixo.
    try {
        window.__modalClickShield = true;
        window.__lastModalOpenTime = Date.now();
        try { overlay.style.pointerEvents = 'none'; } catch(_){}
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; } catch(_){} }, 420);
    } catch (_) {}
    // Abrir o modal de forma assíncrona para evitar que o clique original
    // seja percebido como clique no overlay (fechamento imediato).
    if (mode === 'senha') {
        setTimeout(() => abrirModalSenha(board.id), 0);
    } else {
        setTimeout(() => abrirModalAnotacao(board.id), 0);
    }
});
btnAdicionar.style.marginTop = "8px";
coluna.appendChild(btnAdicionar);
coluna.dataset.open = "true";
openBoardIds.add(board.id);
}
}

function submitNewColumn(mode) {
const inputId = mode === 'senha' ? "new-column-name" : "new-anotacao-column-name";
const input = document.getElementById(inputId);
const nome = input.value.trim();
if (!nome) {
mostrarMensagem("Atenção", "Digite o nome da nova categoria.");
return;
}
const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
if (currentBoards.some(b => b.nome.toLowerCase() === nome.toLowerCase())) {
mostrarMensagem("Erro", "Uma categoria com este nome já existe.");
return;
}
const novaCategoria = { id: Date.now(), nome, cards: [] };
if (mode === 'senha') {
boards.push(novaCategoria);
boardsOriginal.push(JSON.parse(JSON.stringify(novaCategoria)));
} else {
anotacoesBoards.push(novaCategoria);
anotacoesBoardsOriginal.push(JSON.parse(JSON.stringify(novaCategoria)));
}
salvarBoards(mode);
mostrarBoards(mode);
input.value = "";
}


function abrirModalSenha(boardId, cardCriptografado = null) {
    console.log('[TRACE] abrirModalSenha invoked - stack trace:');
    try { console.trace(); } catch(_){}
    console.log('[TRACE] abrirModalSenha - scrollY at entry:', window.scrollY);
    editandoBoardId = boardId;
editandoCardId = cardCriptografado ? cardCriptografado.id : null;
document.getElementById("modalTituloSenha").textContent = cardCriptografado ? "Editar Senha" : "Adicionar Senha";
    // Se estivermos editando um card existente, rolar a página suavemente para o topo
    // para garantir que o modal apareça no início da viewport sem recarregar nada.
    try {
        if (cardCriptografado) {
            const modalContentEl = modalSenhaDiv ? modalSenhaDiv.querySelector('.modalContent') : null;
            try {
                if (modalContentEl && typeof modalContentEl.scrollTo === 'function') {
                    modalContentEl.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (errInner) {
                try { window.scrollTo(0,0); } catch(_){}
            }
            console.log('[TRACE] abrirModalSenha - scrolled modalContent to top for edit modal');
        }
    } catch (e) { /* noop */ }
// Deferir preenchimento de campos e renderização de cartões para evitar bloqueio
setTimeout(() => {
    try {
        const card = cardCriptografado ? descriptografarCard(cardCriptografado, senhaDigitada) : {};
        document.getElementById("inputTitulo").value = card.titulo || "";
        document.getElementById("inputUsuario").value = card.usuario || "";
        document.getElementById("inputSenha").value = card.senha || "";
        document.getElementById("inputEmail").value = card.email || "";
        document.getElementById("inputTelefone").value = card.telefone || "";
        document.getElementById("inputNotas").value = card.notas || "";
        document.getElementById("inputLinks").value = card.links || "";
        document.getElementById("inputAbreviacao").value = card.abreviacao || "";
        document.getElementById("inputCpf").value = card.cpf || "";

        // Preenchimento dos campos de formulário (campos personalizados são carregados
        // mais adiante na rotina que gerencia a lista dinâmica `customFieldsList`).

        // Carregar cartões se existirem (renderização delegada)
        if (cardCriptografado && card) {
            const cartoesDoCard = card.cartoes || card.cartões || card.cartao || card.cartão;
            if (cartoesDoCard && typeof window.carregarCartoes === 'function') {
                try { window.carregarCartoes(cartoesDoCard); } catch(_) { console.warn('carregarCartoes falhou'); }
            }
        } else {
            // Limpar cartões ao adicionar nova senha
            if (typeof window.limparDadoscartão === 'function') {
                try { window.limparDadoscartão(); } catch(_){}
            }
        }

        // Carregar marcadores e selecionar o marcador do card
        try { atualizarSelectsMarcadores(); } catch(_){}
        if (inputMarcador) {
            try { inputMarcador.value = card.marcadorId || ""; } catch(_){}
            // Aplicar brilho se o marcador for importante
            try { aplicarBrilhoMarcadorImportante('senha', card.marcadorId); } catch(_){}
        }
        // limpar lista dinâmica e preencher campos personalizados se existirem
        try {
            const list = document.getElementById('customFieldsList');
            if (list) {
                list.innerHTML = '';
                // suportar formato antigo (card.customField) e novo (card.customFields)
                const all = [];
                if (card && card.customFields && Array.isArray(card.customFields)) all.push(...card.customFields);
                else if (card && card.customField) all.push(card.customField);
                if (all.length === 0) {
                    // adicionar um campo vazio padrão
                    list.appendChild(createCustomFieldRow());
                } else {
                    all.forEach(cf => {
                        const t = (cf && cf.type) ? cf.type : '';
                        const v = (cf && cf.value) ? cf.value : '';
                        list.appendChild(createCustomFieldRow(t, v));
                    });
                }
            }
        } catch (_){ }
    } catch (err) {
        console.warn('Preenchimento de modal adiado falhou', err);
    }
}, 0);

if (!cardCriptografado) {
    const board = boards.find(b => b.id === boardId);
    if (board) {
        atualizarServicoAutomatico(board.nome);
    }
    
    showCorrelationWarning();
}

// Preencher caixa de serviços relacionados (mesma categoria)
try { suggestionSystem.populateRelatedServices(editandoBoardId, editandoCardId); } catch(e){ console.error('[DEBUG] populateRelatedServices call failed', e); }

handleGmailHelperVisibility();
handleAbreviacaoLogic();
    // marcar como em abertura para bloquear cliques residuais no container
    try { modalSenhaDiv.dataset.opening = 'true'; } catch(_){}
    // Proteger contra cliques residuais que possam fechar o modal imediatamente.
    try {
        window.__modalClickShield = true;
        try { overlay.style.pointerEvents = 'none'; } catch(_){ }
        try { window.__lastModalOpenTime = Date.now(); } catch(_){}
        // aumentar janela do escudo temporariamente para 700ms para mitigar reentrancy
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; } catch(_){} }, 700);
    } catch(_){ }
    // lock body scroll to avoid jumps
    lockBodyScroll();
    // limpar flag de abertura após curto intervalo
    try { setTimeout(() => { try { delete modalSenhaDiv.dataset.opening; } catch(_){} }, 420); } catch(_){}
    const prevScrollY_modalSenha = window.scrollY || window.pageYOffset || 0;
    console.log('[DEBUG] abrirModalSenha: saving scrollY before open:', prevScrollY_modalSenha);
    modalSenhaDiv.style.display = "flex";
    document.body.classList.add('modal-open');
    if (!isMobileDevice()) {
        const inputTituloEl = document.getElementById("inputTitulo");
        if (inputTituloEl) {
            try {
                inputTituloEl.focus({ preventScroll: true });
                console.log('[DEBUG] abrirModalSenha: focused inputTitulo with preventScroll');
            } catch (err) {
                inputTituloEl.focus();
                console.log('[DEBUG] abrirModalSenha: focused inputTitulo fallback without preventScroll');
            }
        }
    }
    // Garantir rolagem para o topo de forma robusta: agendar múltiplas tentativas
    // para sobrepor restores de scroll de outras rotinas do app.
    try {
        const ensureTop = () => {
            try {
                const modalContentEl = modalSenhaDiv ? modalSenhaDiv.querySelector('.modalContent') : null;
                if (modalContentEl && typeof modalContentEl.scrollTo === 'function') {
                    modalContentEl.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch(_) { try { window.scrollTo(0,0); } catch(_){} }
        };
        setTimeout(ensureTop, 20);
        setTimeout(ensureTop, 120);
        setTimeout(ensureTop, 400);
        console.log('[DEBUG] abrirModalSenha: scheduled ensureTop scroll attempts (modalContent)');
    } catch(_) {}
    // Restaurar scroll ou rolar para o topo se for edição (evita pular a página inteira)
    setTimeout(() => {
        try {
            if (cardCriptografado) {
                try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch(_) { window.scrollTo(0,0); }
                console.log('[DEBUG] abrirModalSenha: scrolled to top for edit modal');
            } else {
                window.scrollTo(0, prevScrollY_modalSenha);
                console.log('[DEBUG] abrirModalSenha: restored scrollY to', prevScrollY_modalSenha);
            }
        } catch (e) {
            try {
                if (cardCriptografado) { window.scrollTo(0,0); }
                else { window.scrollTo(0, prevScrollY_modalSenha); }
            } catch(_){}
        }
    }, 0);
}

function fecharModalSenha() {
    try {
        // Bloquear fechamento imediato se o modal estiver no período de abertura
        const shield = !!window.__modalClickShield;
        const last = window.__lastModalOpenTime || 0;
        const age = Date.now() - last;
        if (shield || (last && age < 480) || (modalSenhaDiv && modalSenhaDiv.dataset && modalSenhaDiv.dataset.opening === 'true')) {
            console.log('[MODAL-SHIELD] fecharModalSenha ignored due to opening shield', { shield, age, opening: modalSenhaDiv ? modalSenhaDiv.dataset.opening : undefined });
            return;
        }
    } catch(_) {}
modalSenhaDiv.style.display = "none";
// Remover brilho do marcador importante
modalSenhaDiv.classList.remove('marcador-importante-ativo');
modalSenhaDiv.style.removeProperty('--marcador-cor-importante');
gmailHelperBtn.classList.remove('visible');
document.getElementById('clear-email').style.right = '10px';
abreviacaoContainer.style.display = 'none';
document.body.classList.remove('modal-open');
// unlock body scroll
if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
document.querySelectorAll('#modalSenha .btn-clear-field').forEach(btn => btn.style.display = 'none');
formSenha.reset();
dismissWarning(); 
correlationWarningShown = false; 
}

function salvarSenha(e) {
e.preventDefault();
const dados = {
titulo: document.getElementById("inputTitulo").value.trim(),
usuario: document.getElementById("inputUsuario").value.trim(),
senha: document.getElementById("inputSenha").value.trim(),
email: document.getElementById("inputEmail").value.trim(),
telefone: document.getElementById("inputTelefone").value.trim(),
notas: document.getElementById("inputNotas").value.trim(),
links: document.getElementById("inputLinks").value.trim(),
abreviacao: document.getElementById("inputAbreviacao").value.trim(),
cpf: document.getElementById("inputCpf").value.trim(),
marcadorId: inputMarcador?.value || null
};
// Campos personalizados (Senhas) - coletar todas as linhas da lista dinâmica
try {
    const rows = document.querySelectorAll('#customFieldsList .custom-field-row');
    const collected = [];
    if (rows && rows.length) {
        rows.forEach(r => {
            try {
                const t = (r.querySelector('.input-custom-type') || {}).value || '';
                const v = (r.querySelector('.input-custom-value') || {}).value?.trim() || '';
                if (v) collected.push({ type: t || 'personalizado', value: v });
            } catch (_r) { /* noop per row */ }
        });
    }
    if (collected.length) {
        dados.customFields = collected;
        // compatibilidade legada: manter `customField` com a primeira entrada
        if (collected.length === 1) dados.customField = collected[0];
        else delete dados.customField;
    } else {
        delete dados.customFields;
        delete dados.customField;
    }
} catch (_) {}

try {
    const cartoesCapturados = (typeof window.obterCartoes === 'function') ? window.obterCartoes() : [];
    if (Array.isArray(cartoesCapturados) && cartoesCapturados.length) {
        const cartoesSanitizados = cartoesCapturados
            .map((c) => ({
                numero: (c.numero || '').trim(),
                titular: (c.titular || '').trim(),
                validade: (c.validade || '').trim(),
                cvv: (c.cvv || '').trim(),
                bandeira: (c.bandeira || '').trim()
            }))
            .filter((c) => !!c.numero);
        if (cartoesSanitizados.length) dados.cartoes = cartoesSanitizados;
    }
} catch (_e) { /* manter silencioso para não quebrar salvamento */ }


if (!window.recentHistory) {
    window.recentHistory = {
        maxItems: 5,
        getData() {
            try {
                const data = localStorage.getItem('recentHistory');
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        },
        saveData(data) {
            try {
                localStorage.setItem('recentHistory', JSON.stringify(data));
            } catch (e) {
                /* noop */
            }
        },
        addItem(field, value) {
            if (!value || !value.trim()) return;
            const data = this.getData();
            if (!data[field]) data[field] = [];
            data[field] = data[field].filter(item => item !== value);
            data[field].unshift(value);
            data[field] = data[field].slice(0, this.maxItems);
            this.saveData(data);
        },
        getItems(field) {
            const data = this.getData();
            return data[field] || [];
        }
    };

    
    window.showRecentItems = function(input, items) {
        const existingMenu = input.parentElement.querySelector('.recent-items-menu');
        if (existingMenu) existingMenu.remove();
        if (!items.length) return;

        const menu = document.createElement('div');
        menu.className = 'recent-items-menu';
        
        items.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'recent-item';
            itemEl.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${item}
            `;
            itemEl.addEventListener('click', () => {
                input.value = item;
                menu.remove();
                input.focus();
            });
            menu.appendChild(itemEl);
        });

        input.parentElement.appendChild(menu);
        menu.classList.add('show');
    };

    
    const setupRecentHistory = function(input) {
        if (!input) return;
        
        const fieldName = input.id;
        
        input.addEventListener('focus', () => {
            const items = recentHistory.getItems(fieldName);
            if (items.length) {
                input.parentElement.classList.add('has-recent');
                showRecentItems(input, items);
            }
        });
    };

    
    ['inputUsuario', 'inputEmail', 'inputTelefone', 'inputLinks', 'inputNotas', 'inputCpf'].forEach(id => {
        const input = document.getElementById(id);
        if (input) setupRecentHistory(input);
    });

    
    document.addEventListener('click', (e) => {
        const menus = document.querySelectorAll('.recent-items-menu');
        menus.forEach(menu => {
            if (!menu.parentElement.contains(e.target)) {
                menu.remove();
            }
        });
    });
}


if (window.recentHistory) {
    Object.entries(dados).forEach(([key, value]) => {
        // Evitar armazenar objetos/arrays (ex.: cartoes) e campos sensíveis
        if (key === 'senha' || key === 'titulo') return;
        if (value == null) return;
        if (typeof value !== 'string') return;
        if (!value.trim()) return;
        recentHistory.addItem('input' + key.charAt(0).toUpperCase() + key.slice(1), value);
    });
};
if (!dados.titulo || !dados.usuario || !dados.senha) {
mostrarMensagemNoModal("Atenção", "Preencha: Serviço, Usuário e Senha.");
return;
}
const card = { id: editandoCardId || Date.now(), ...dados };
const board = boards.find(b => b.id === editandoBoardId);
const boardOriginal = boardsOriginal.find(b => b.id === editandoBoardId);
const cardCriptografado = criptografarCard(card, senhaDigitada);
if (editandoCardId) {
const idx = board.cards.findIndex(c => c.id === editandoCardId);
if (idx >= 0) board.cards[idx] = cardCriptografado;
if(boardOriginal) {
  const idxOriginal = boardOriginal.cards.findIndex(c => c.id === editandoCardId);
  if (idxOriginal >= 0) boardOriginal.cards[idxOriginal] = cardCriptografado;
}
} else {
board.cards.push(cardCriptografado);
if(boardOriginal) boardOriginal.cards.push(cardCriptografado);
}
salvarBoards('senha');
mostrarBoards('senha');
fecharModalSenha();
}

function abrirModalAnotacao(boardId, cardCriptografado = null) {
    console.log('[TRACE] abrirModalAnotacao invoked - stack trace:');
    try { console.trace(); } catch(_){}
    console.log('[TRACE] abrirModalAnotacao - scrollY at entry:', window.scrollY);
    editandoBoardId = boardId;
editandoCardId = cardCriptografado ? cardCriptografado.id : null;
document.getElementById("modalTituloAnotacao").textContent = cardCriptografado ? "Editar Anotação" : "Adicionar Anotação";
const card = cardCriptografado ? descriptografarCard(cardCriptografado, senhaDigitada) : {};
document.getElementById("inputTituloAnotacao").value = card.titulo || "";
document.getElementById("inputLinksAnotacao").value = card.links || "";
document.getElementById("inputNotasAnotacao").value = card.notas || "";
 // Preencher e exibir extras, se houver
 const extraDiv = document.getElementById('extraFieldsAnotacao');
 const btnExtra = document.getElementById('btnMaisInfoAnotacao');
 const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ""; };
 setVal('inputUsuarioAnotacao', card.usuario);
 setVal('inputEmailAnotacao', card.email);
 setVal('inputTelefoneAnotacao', card.telefone);
 setVal('inputCpfAnotacao', card.cpf);
 setVal('inputAbreviacaoAnotacao', card.abreviacao);
 // Aplicar formatação inicial como no formulário de Senhas
 const telAnotEl = document.getElementById('inputTelefoneAnotacao');
 if (telAnotEl && telAnotEl.value) formatarTelefone(telAnotEl);
 const cpfAnotEl = document.getElementById('inputCpfAnotacao');
 if (cpfAnotEl && cpfAnotEl.value) formatarCPF(cpfAnotEl);
 const hasExtras = !!(card.usuario || card.email || card.telefone || card.cpf || card.abreviacao);
 if (extraDiv && btnExtra) {
     extraDiv.style.display = hasExtras ? 'flex' : 'none';
     btnExtra.setAttribute('aria-expanded', hasExtras ? 'true' : 'false');
     btnExtra.textContent = hasExtras ? '− Menos informações' : '+ Mais informações';
 }
    // Atualizar visibilidade dos botões limpar conforme valores atuais
    updateClearButtonsFormAnotacao();

// Carregar marcadores e selecionar o marcador do card
atualizarSelectsMarcadores();
if (inputMarcadorAnotacao) {
    inputMarcadorAnotacao.value = card.marcadorId || "";
    
    // Aplicar brilho se o marcador for importante
    aplicarBrilhoMarcadorImportante('anotacao', card.marcadorId);
}

    const prevScrollY_modalAnot = window.scrollY || window.pageYOffset || 0;
    console.log('[DEBUG] abrirModalAnotacao: saving scrollY before open:', prevScrollY_modalAnot);
    // marcar como em abertura para bloquear cliques residuais no container
    try { modalAnotacaoDiv.dataset.opening = 'true'; } catch(_){}
    modalAnotacaoDiv.style.display = "flex";
    document.body.classList.add('modal-open');
    // limpar flag de abertura após curto intervalo
    try { setTimeout(() => { try { delete modalAnotacaoDiv.dataset.opening; } catch(_){} }, 420); } catch(_){}
    if (!isMobileDevice()) {
        const inputTituloAnotEl = document.getElementById("inputTituloAnotacao");
        if (inputTituloAnotEl) {
            try {
                inputTituloAnotEl.focus({ preventScroll: true });
                console.log('[DEBUG] abrirModalAnotacao: focused inputTituloAnotacao with preventScroll');
            } catch (err) {
                inputTituloAnotEl.focus();
                console.log('[DEBUG] abrirModalAnotacao: focused inputTituloAnotacao fallback without preventScroll');
            }
        }
    }
    // Proteger contra cliques residuais que possam fechar o modal imediatamente.
    try {
        window.__modalClickShield = true;
        try { overlay.style.pointerEvents = 'none'; } catch(_){ }
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; } catch(_){} }, 220);
    } catch(_){ }
    // lock body scroll using the captured prevScrollY to avoid races
    try { lockBodyScrollAt(prevScrollY_modalAnot); } catch(_) { try { lockBodyScroll(); } catch(_){} }
    setTimeout(() => {
        try {
            window.scrollTo(0, prevScrollY_modalAnot);
            console.log('[DEBUG] abrirModalAnotacao: restored scrollY to', prevScrollY_modalAnot);
        } catch (e) { try { window.scrollTo(0, prevScrollY_modalAnot); } catch(_){} }
    }, 0);
}

function fecharModalAnotacao() {
    try {
        // Log detalhado para diagnóstico de fechamento imediato
        try { console.trace(); } catch(_){}
        console.log('[FECHAR] fecharModalAnotacao entry', {
            modalOpeningFlag: modalAnotacaoDiv && modalAnotacaoDiv.dataset ? modalAnotacaoDiv.dataset.opening : undefined,
            shield: !!window.__modalClickShield,
            lastModalOpenTime: window.__lastModalOpenTime || 0,
            ageMs: (window.__lastModalOpenTime ? (Date.now() - window.__lastModalOpenTime) : null),
            bodyLock: (window.__bodyLock || {}),
        });

        // Bloquear fechamento imediato se o modal estiver no período de abertura
        const shield = !!window.__modalClickShield;
        const last = window.__lastModalOpenTime || 0;
        const age = Date.now() - last;
        if (shield || (last && age < 700) || (modalAnotacaoDiv && modalAnotacaoDiv.dataset && modalAnotacaoDiv.dataset.opening === 'true')) {
            console.log('[MODAL-SHIELD] fecharModalAnotacao ignored due to opening shield', { shield, age, opening: modalAnotacaoDiv ? modalAnotacaoDiv.dataset.opening : undefined });
            return;
        }
    } catch(e) { console.warn('[FECHAR] fecharModalAnotacao pre-check failed', e); }
modalAnotacaoDiv.style.display = "none";
// Remover brilho do marcador importante
modalAnotacaoDiv.classList.remove('marcador-importante-ativo');
modalAnotacaoDiv.style.removeProperty('--marcador-cor-importante');
document.body.classList.remove('modal-open');
formAnotacao.reset();
 // Recolher extras ao fechar
 const extraDiv = document.getElementById('extraFieldsAnotacao');
 const btnExtra = document.getElementById('btnMaisInfoAnotacao');
 if (extraDiv && btnExtra) {
     extraDiv.style.display = 'none';
     btnExtra.setAttribute('aria-expanded', 'false');
     btnExtra.textContent = '+ Mais informações';
 }
 // unlock body scroll
    if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
}

function salvarAnotacao(e) {
e.preventDefault();
const dados = {
  titulo: document.getElementById("inputTituloAnotacao").value.trim(),
  links: document.getElementById("inputLinksAnotacao").value.trim(),
  notas: document.getElementById("inputNotasAnotacao").value.trim(),
  marcadorId: inputMarcadorAnotacao?.value || null
};
if (!dados.titulo) {
  mostrarMensagemNoModal("Atenção", "O campo Nome é obrigatório.");
  return;
}
 // Extras opcionais
 const usuario = (document.getElementById('inputUsuarioAnotacao')||{}).value?.trim();
 const email = (document.getElementById('inputEmailAnotacao')||{}).value?.trim();
 const telefone = (document.getElementById('inputTelefoneAnotacao')||{}).value?.trim();
 const cpf = (document.getElementById('inputCpfAnotacao')||{}).value?.trim();
 const abreviacao = (document.getElementById('inputAbreviacaoAnotacao')||{}).value?.trim();
 if (usuario) dados.usuario = usuario;
 if (email) dados.email = email;
 if (telefone) dados.telefone = telefone;
 if (cpf) dados.cpf = cpf;
 if (abreviacao) dados.abreviacao = abreviacao;
 
const card = { id: editandoCardId || Date.now(), ...dados };
const board = anotacoesBoards.find(b => b.id === editandoBoardId);
const boardOriginal = anotacoesBoardsOriginal.find(b => b.id === editandoBoardId);
const cardCriptografado = criptografarCard(card, senhaDigitada);
if (editandoCardId) {
  const idx = board.cards.findIndex(c => c.id === editandoCardId);
  if (idx >= 0) board.cards[idx] = cardCriptografado;
  if(boardOriginal) {
      const idxOriginal = boardOriginal.cards.findIndex(c => c.id === editandoCardId);
      if (idxOriginal >= 0) boardOriginal.cards[idxOriginal] = cardCriptografado;
  }
} else {
  board.cards.push(cardCriptografado);
  if(boardOriginal) boardOriginal.cards.push(cardCriptografado);
}
salvarBoards('anotacao');
mostrarBoards('anotacao');
fecharModalAnotacao();
}

// Copiar uma anotação para o painel de Senhas: cria um item duplicado em Senhas (sem remover a anotação)
async function copiarAnotacaoParaSenha(origemBoard, anotacao, senhaObrigatoria, nomeCategoriaDestino) {
    try {
        // Garantir estrutura de senhas
        if (!Array.isArray(boards)) boards = [];
        if (!Array.isArray(boardsOriginal)) boardsOriginal = [];

        // Gerador de IDs robusto para evitar colisões quando múltiplas categorias/cartões são criados rapidamente
        const genId = () => (Date.now() + Math.floor(Math.random() * 1_000_000));

        // Definir nome da categoria de destino prioritariamente informado, senão usar nome da origem
        const nomeDestino = ((nomeCategoriaDestino || origemBoard?.nome || '').trim());
        if (!nomeDestino) throw new Error('Categoria de destino não determinada.');
        const nomeDestinoLower = nomeDestino.toLowerCase();

        // Encontrar (ou criar) categoria de destino na fonte completa (boardsOriginal)
        let destinoOriginal = boardsOriginal.find(b => (b.nome || '').toLowerCase() === nomeDestinoLower);
        if (!destinoOriginal) {
            destinoOriginal = { id: genId(), nome: nomeDestino, cards: [] };
            boardsOriginal.push(destinoOriginal);
        }
        // Tentar referenciar a mesma categoria no array de visualização atual (se existir)
        let destino = boards.find(b => b.id === destinoOriginal.id);
        if (!destino) {
            // Se a visualização atual não contém, podemos optar por inserir para refletir imediatamente
            // sem afetar filtros; se houver filtros, o item pode não aparecer, o que é aceitável.
            boards.push({ id: destinoOriginal.id, nome: destinoOriginal.nome, cards: [] });
            destino = boards.find(b => b.id === destinoOriginal.id);
        }

        // Montar novo card com dados disponíveis (senha do serviço informada obrigatória)
        const novoCard = {
            id: genId(),
            titulo: (anotacao.titulo && anotacao.titulo.trim()) ? anotacao.titulo.trim() : 'Sem título',
            usuario: anotacao.usuario || anotacao.email || '',
            senha: senhaObrigatoria || '',
            email: anotacao.email || '',
            telefone: anotacao.telefone || '',
            notas: anotacao.notas ? `[Copiado de Anotações]\n${anotacao.notas}` : '[Copiado de Anotações]',
            links: anotacao.links || '',
            abreviacao: anotacao.abreviacao || '',
            cpf: anotacao.cpf || ''
        };
        // Determinar a chave de criptografia correta para Senhas via certificado digital
        let chaveCripto = senhaDigitada;
        if (!verificarSenha(chaveCripto || '')) {
            const tokenCert = await mostrarPromptCertificado();
            if (!tokenCert) {
                mostrarMensagem('Atenção', 'Operação cancelada.');
                return;
            }
            chaveCripto = tokenCert;
        }

        const novoCardEnc = criptografarCard(novoCard, chaveCripto);
    // Persistir no dataset completo e refletir na visualização (se presente)
    destinoOriginal.cards.push(novoCardEnc);
    if (destino) destino.cards.push(novoCardEnc);

        salvarBoards('senha');
        // Reidratar sempre a partir da fonte completa e reaplicar filtros/busca se existirem,
        // garantindo que nenhuma categoria recém-criada “desapareça” visualmente
        const searchEl = document.getElementById('search-column');
        const hasSearch = !!(searchEl && searchEl.value.trim());
        const sections = (typeof getSelectedFilterSections === 'function') ? getSelectedFilterSections('senha') : [];
        const hasSectionFilter = Array.isArray(sections) && sections.length > 0;
        boards = JSON.parse(JSON.stringify(boardsOriginal));
        if (hasSearch || hasSectionFilter) {
            filtrarCategorias('senha');
        } else {
            mostrarBoards('senha');
        }
        mostrarMensagem('Sucesso', `Anotação copiada para Senhas na categoria "${destino.nome}".`);
        // Opcional: atualizar a visualização de boards de Senhas se estiver aberta
        // if (document.getElementById('app')?.style.display === 'block') mostrarBoards('senha');
    } catch (e) {
        console.error('Erro ao copiar anotação para senha:', e);
        mostrarMensagem('Erro', 'Ocorreu um erro ao copiar a anotação para Senhas.');
    }
}

function updateClearButtonsFormAnotacao() {
    const inputs = document.querySelectorAll('#formAnotacao .input-container input, #formAnotacao .input-container textarea');
    inputs.forEach(input => {
        const btn = input.parentElement.querySelector('.btn-clear-field');
        if (btn) btn.style.display = input.value ? 'block' : 'none';
    });
}

function updateClearButtonsFormSenha() {
    const inputs = document.querySelectorAll('#formSenha .input-container input, #formSenha .input-container textarea');
    inputs.forEach(input => {
        const btn = input.parentElement.querySelector('.btn-clear-field');
        if (btn) btn.style.display = input.value ? 'block' : 'none';
    });
}

function updateClearButtonsFormSenha() {
    const inputs = document.querySelectorAll('#formSenha .input-container input, #formSenha .input-container textarea');
    inputs.forEach(input => {
        const btn = input.parentElement.querySelector('.btn-clear-field');
        if (btn) btn.style.display = input.value ? 'block' : 'none';
    });
}


function filtrarCategorias(mode) {
const searchTerm = document.getElementById(mode === 'senha' ? 'search-column' : 'search-anotacao-column').value.trim().toLowerCase();
const originalData = mode === 'senha' ? boardsOriginal : anotacoesBoardsOriginal;

// Campos (seções) selecionadas para filtrar categorias
const selected = getSelectedFilterSections(mode); // array de chaves de campos (ex: ['titulo','usuario','email','marcador'])

const matchesCard = (cardEnc) => {
    const card = descriptografarCard(cardEnc, senhaDigitada) || {};
    // Obter nome do marcador (se existir) para permitir busca por nome do marcador
    let marcadorNome = '';
    try {
        if (card.marcadorId !== undefined && card.marcadorId !== null && String(card.marcadorId).trim() !== '') {
            // Caso o campo venha cifrado, descriptografarCard já tentou desserializar.
            const encontrado = marcadores.find(m => String(m.id) === String(card.marcadorId));
            if (encontrado) marcadorNome = String(encontrado.nome).toLowerCase();
            else {
                // Se não encontrou por id, tentar comparar pelo próprio valor (caso seja texto com nome)
                marcadorNome = String(card.marcadorId).toLowerCase();
            }
        }
    } catch (e) { marcadorNome = ''; }

    // montar o texto completo para busca (inclui marcador)
    const fields = ['titulo','usuario','email','telefone','cpf','links','notas','abreviacao'];
    const blobParts = fields.map(k => (card[k]||'').toString().toLowerCase());
    blobParts.push(marcadorNome);
    const blob = blobParts.join(' ');

    const termOk = searchTerm ? (blob.includes(searchTerm)) : true;
    // Se houver seleção de seções, verificar se ao menos uma das seções selecionadas possui conteúdo no card
    const sectionOk = selected.length > 0 ? selected.some(k => {
        if (k === 'marcador') return marcadorNome.trim() !== '';
        return (card[k]||'').toString().trim() !== '';
    }) : true;
    return termOk && sectionOk;
};

const filteredData = originalData.map(b => ({...b})).filter(b => {
    const nameOk = searchTerm ? b.nome.toLowerCase().includes(searchTerm) : true;
    const hasCardOk = (b.cards||[]).some(c => matchesCard(c));
    // Se houver seções selecionadas, exigir que haja algum card que atenda ao filtro
    if (selected.length > 0) {
        return hasCardOk && (searchTerm ? (nameOk || hasCardOk) : true);
    }
    return (searchTerm ? (nameOk || hasCardOk) : true);
});

if (mode === 'senha') boards = filteredData; else anotacoesBoards = filteredData;
mostrarBoards(mode);
}
function limparFiltro(mode) {
document.getElementById(mode === 'senha' ? 'search-column' : 'search-anotacao-column').value = "";
if (mode === 'senha') boards = JSON.parse(JSON.stringify(boardsOriginal));
else anotacoesBoards = JSON.parse(JSON.stringify(anotacoesBoardsOriginal));
mostrarBoards(mode);
}

function obterPacoteSenhasParaExportar(exportSenha) {
    const limparBoards = (lista) => Array.isArray(lista) ? lista.map((board) => ({
        id: board.id,
        nome: board.nome,
        cards: Array.isArray(board.cards) ? JSON.parse(JSON.stringify(board.cards)) : []
    })) : [];

    // Garantir que sempre tentamos incluir os marcadores atuais no pacote de exportação
    let marcadoresExport = [];
    try {
        const rawM = localStorage.getItem('marcadores');
        marcadoresExport = rawM ? JSON.parse(rawM) : (Array.isArray(marcadores) ? JSON.parse(JSON.stringify(marcadores)) : []);
    } catch (_) { marcadoresExport = Array.isArray(marcadores) ? JSON.parse(JSON.stringify(marcadores)) : []; }

    try {
        const bruto = localStorage.getItem('gerenciadorBoards');
        if (bruto) {
            const armazenado = JSON.parse(bruto);
            if (armazenado && Array.isArray(armazenado.boardsData)) {
                // coletar ids de marcadores referenciados nas cards
                const referenced = new Set();
                let convertedCount = 0;
                let failedCount = 0;
                armazenado.boardsData.forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referenced.add(c.marcadorId); }); });
                // Se possível, tentar desserializar o marcadorId cifrado usando a senha mestre
                try {
                    const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
                    if (pwd) {
                        armazenado.boardsData.forEach(b => {
                            (b.cards||[]).forEach(card => {
                                try {
                                    if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                                        const original = card.marcadorId;
                                        const dec = descriptografarDados(original, pwd);
                                        if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                                            card.marcadorId = dec;
                                            convertedCount++;
                                            referenced.delete(original);
                                            referenced.add(dec);
                                        } else {
                                            failedCount++;
                                        }
                                    }
                                } catch (e) { /* noop */ }
                            });
                        });
                    }
                } catch (e) { /* noop */ }
                return {
                    boardsData: limparBoards(armazenado.boardsData),
                    autoFillData: typeof armazenado.autoFillData === 'object' && armazenado.autoFillData !== null
                        ? armazenado.autoFillData
                        : {},
                    marcadores: marcadoresExport,
                    referencedMarcadorIds: Array.from(referenced),
                    referencedConversionStats: { converted: convertedCount, failed: failedCount }
                };
            }
            if (Array.isArray(armazenado)) {
                const referenced = new Set();
                let convertedCount = 0;
                let failedCount = 0;
                armazenado.forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referenced.add(c.marcadorId); }); });
                try {
                    const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
                    if (pwd) {
                        armazenado.forEach(b => { (b.cards||[]).forEach(card => {
                            try {
                                if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                                    const original = card.marcadorId;
                                    const dec = descriptografarDados(original, pwd);
                                    if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                                        card.marcadorId = dec;
                                        convertedCount++;
                                        referenced.delete(original);
                                        referenced.add(dec);
                                    } else {
                                        failedCount++;
                                    }
                                }
                            } catch (e) { /* noop */ }
                        }); });
                    }
                } catch (e) { /* noop */ }
                return {
                    boardsData: limparBoards(armazenado),
                    autoFillData: {},
                    marcadores: marcadoresExport,
                    referencedMarcadorIds: Array.from(referenced),
                    referencedConversionStats: { converted: convertedCount, failed: failedCount }
                };
            }
        }
    } catch (err) {
        console.warn('Falha ao recuperar senhas do armazenamento para exportação:', err);
    }

    // também coletar referencedMarcadorIds a partir do estado em memória caso não tenha vindo do storage
    const referencedFromMemory = new Set();
    let convertedCountFallback = 0;
    let failedCountFallback = 0;
    (boardsOriginal || []).forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referencedFromMemory.add(c.marcadorId); }); });
    try {
        const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
        if (pwd) {
            (boardsOriginal || []).forEach(b => { (b.cards||[]).forEach(card => {
                try {
                    if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                        const original = card.marcadorId;
                        const dec = descriptografarDados(original, pwd);
                        if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                            card.marcadorId = dec;
                            convertedCountFallback++;
                            referencedFromMemory.delete(original);
                            referencedFromMemory.add(dec);
                        } else {
                            failedCountFallback++;
                        }
                    }
                } catch (e) { /* noop */ }
            }); });
        }
    } catch (e) { /* noop */ }
    return {
        boardsData: limparBoards(boardsOriginal || []),
        autoFillData: JSON.parse(JSON.stringify(autoFillData || {})),
        marcadores: marcadoresExport,
        referencedMarcadorIds: Array.from(referencedFromMemory),
        referencedConversionStats: { converted: convertedCountFallback, failed: failedCountFallback }
    };
}

function obterAnotacoesParaExportar(exportSenha) {
    const limparBoards = (lista) => Array.isArray(lista) ? lista.map((board) => ({
        id: board.id,
        nome: board.nome,
        cards: Array.isArray(board.cards) ? JSON.parse(JSON.stringify(board.cards)) : []
    })) : [];

    const buildResult = (boardsArray, stats, failedList) => ({ anotacoesData: boardsArray, conversionStats: stats || { converted: 0, failed: 0 }, failedCiphertexts: failedList || [] });

    try {
        const bruto = localStorage.getItem('gerenciadorAnotacoes');
        if (bruto) {
            const armazenado = JSON.parse(bruto);
            if (Array.isArray(armazenado)) {
                // Exportar exatamente o que está armazenado, sem tentar recriptografar outros campos.
                // Porém, se a sessão atual possui a `senhaDigitada`, tentamos desserializar
                // apenas o `marcadorId` dentro das anotações para evitar referências cifradas
                // no arquivo de exportação que impediriam o mapeamento com `marcadores[]`.
                const copia = limparBoards(armazenado);
                try {
                    const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
                    if (pwd) {
                        let converted = 0;
                        let failed = 0;
                        const failedList = [];
                        copia.forEach(b => {
                            (b.cards||[]).forEach(card => {
                                try {
                                    if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                                        const original = card.marcadorId;
                                        const dec = descriptografarDados(original, pwd);
                                        if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                                            card.marcadorId = dec;
                                            converted++;
                                        } else {
                                            failed++;
                                            failedList.push(original);
                                        }
                                    }
                                } catch (e) { /* noop */ }
                            });
                        });
                        return buildResult(copia, { converted, failed }, failedList);
                    }
                } catch (e) { /* noop */ }
                return buildResult(copia);
            }
        }
    } catch (err) {
        console.warn('Falha ao recuperar anotações do armazenamento para exportação:', err);
    }

    // Fallback: retornar uma cópia do estado conhecido em memória sem alterações.
    const fallback = limparBoards(anotacoesBoardsOriginal || []);
    try {
        const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
        if (pwd) {
            let converted = 0;
            let failed = 0;
            const failedList = [];
            fallback.forEach(b => {
                (b.cards||[]).forEach(card => {
                    try {
                        if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                            const original = card.marcadorId;
                            const dec = descriptografarDados(original, pwd);
                            if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                                card.marcadorId = dec;
                                converted++;
                            } else {
                                failed++;
                                failedList.push(original);
                            }
                        }
                    } catch (e) { /* noop */ }
                });
            });
            return buildResult(fallback, { converted, failed }, failedList);
        }
    } catch (e) { /* noop */ }
    return buildResult(fallback);
}
function toggleModoLeitura(appId) {
const appElement = document.getElementById(appId);
appElement.classList.toggle("modo-leitura");
mostrarBoards(appId === 'app' ? 'senha' : 'anotacao');
const btn = document.getElementById(appId === 'app' ? 'btnModoLeitura' : 'btnModoLeituraAnotacao');
btn.textContent = appElement.classList.contains("modo-leitura") ? "Editar" : "Leitura";
}
function exportarDados(mode) {
const agora = new Date();
const timestamp = `${agora.getDate().toString().padStart(2,'0')}-${(agora.getMonth()+1).toString().padStart(2,'0')}-${agora.getFullYear().toString().slice(-2)}_${agora.getHours().toString().padStart(2,'0')}-${agora.getMinutes().toString().padStart(2,'0')}`;

// Garantir que quaisquer alterações em marcadores (incl. formulário aberto) sejam persistidas
try { flushMarcadorModalIfDirty(); salvarMarcadores(); carregarMarcadores(); } catch (e) { /* noop */ }

// Se não estivermos logados (sem `senhaDigitada`), pedir senha temporária para
// desserializar referências antes de exportar. A senha solicitada NÃO é salva.
let senhaParaExport = typeof senhaDigitada === 'string' && senhaDigitada ? senhaDigitada : null;
if (!senhaParaExport) {
    try {
        const anyAnotacoes = (function(){ try { return JSON.parse(localStorage.getItem('gerenciadorAnotacoes')||'[]'); } catch(e){ return []; } })();
        const hasEncrypted = anyAnotacoes.some(b => (b.cards||[]).some(c => c.marcadorId && typeof c.marcadorId === 'string' && c.marcadorId.startsWith('U2FsdGVk')));
        if (hasEncrypted) {
            senhaParaExport = window.prompt('Senha mestra (apenas para desserializar referências durante o export)');
        }
    } catch (e) { /* noop */ }
}

const pacoteSenhas = obterPacoteSenhasParaExportar(senhaParaExport);
const pacoteAnotacoes = obterAnotacoesParaExportar(senhaParaExport);

// Consolidar referencedMarcadorIds tanto de senhas quanto de anotações
const referencedSet = new Set((pacoteSenhas.referencedMarcadorIds || []).map(r => r));
// pacoteAnotacoes agora pode ser um objeto { anotacoesData, conversionStats, failedCiphertexts }
const anotacoesArray = Array.isArray(pacoteAnotacoes) ? pacoteAnotacoes : (pacoteAnotacoes && Array.isArray(pacoteAnotacoes.anotacoesData) ? pacoteAnotacoes.anotacoesData : []);
anotacoesArray.forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referencedSet.add(c.marcadorId); }); });
const referencedAll = Array.from(referencedSet);
// Collect conversion stats provided by the helper functions (if any)
const senhasStats = (pacoteSenhas && pacoteSenhas.referencedConversionStats) ? pacoteSenhas.referencedConversionStats : { converted: 0, failed: 0 };
const anotacoesStats = (pacoteAnotacoes && pacoteAnotacoes.conversionStats) ? pacoteAnotacoes.conversionStats : { converted: 0, failed: 0 };
const anotacoesFailed = (pacoteAnotacoes && Array.isArray(pacoteAnotacoes.failedCiphertexts)) ? pacoteAnotacoes.failedCiphertexts : [];
const exportStats = {
    senhas: senhasStats,
    anotacoes: anotacoesStats,
    anotacoesFailedCiphertexts: anotacoesFailed,
    totalReferenced: referencedAll.length
};

console.info('Exportando dados — marcadores convertidos (senhas):', senhasStats.converted, 'falhas:', senhasStats.failed, '; anotacoes converted:', anotacoesStats.converted, 'falhas:', anotacoesStats.failed, '; referenced total:', referencedAll.length);

const dataToExport = {
    boardsData: pacoteSenhas.boardsData,
    autoFillData: pacoteSenhas.autoFillData,
    anotacoesData: anotacoesArray,
    marcadores: pacoteSenhas.marcadores || [],
    referencedMarcadorIds: referencedAll,
    cartaoPadrao: (function(){ try { const raw = localStorage.getItem('cartãoPadrao'); return raw ? JSON.parse(raw) : null; } catch(_){ return null; } })(),
    aparelhosConectados: (function(){ try { return JSON.parse(localStorage.getItem('aparelhosConectados')||'[]'); } catch(e){ return []; } })(),
        // incluir aparelhos correlacionados (mi_db_v5) e mapeamento por credencial para compatibilidade
        mi_db_v5: (function(){ try { return JSON.parse(localStorage.getItem('mi_db_v5')||'[]'); } catch(e){ return []; } })(),
        mi_cred_aparelhos: (function(){ try { return JSON.parse(localStorage.getItem('mi_cred_aparelhos')||'{}'); } catch(e){ return {}; } })(),
            exportStats: exportStats
        };

// Após iniciar o download, sugerir que o usuário faça upload para acesso em tempo real
try {
    const megaUrl = 'https://mega.nz/folder/D0glSRSS#tOF-3TZHXqBALCmD_n3FOQ';
    const mensagemHtml = `Para segurança, faça o upload do arquivo exportado para acesso em tempo real.<div style="margin-top:12px;"><button id="btnUploadMega" class="primary-action" style="margin-right:10px;">Upload</button></div>`;
    mostrarMensagem('Exportação concluída', mensagemHtml);
    // Depois que o modal for inserido no DOM, anexar o listener ao botão
    setTimeout(() => {
        const btnMega = document.getElementById('btnUploadMega');
        if (btnMega) {
            btnMega.addEventListener('click', () => {
                try { window.open(megaUrl, '_blank', 'noopener'); } catch(_){ }
            });
            // Colocar o botão 'Upload' e o 'OK' do modal lado a lado
            try {
                const btnOk = document.getElementById('btnFecharMensagem');
                const parent = btnMega.parentElement || btnMega.parentNode;
                if (parent) {
                    parent.style.display = 'flex';
                    parent.style.justifyContent = 'center';
                    parent.style.gap = '10px';
                    parent.style.marginTop = '12px';
                    if (btnOk) parent.appendChild(btnOk);
                } else if (btnOk && btnOk.parentElement) {
                    // fallback: inserir btnMega antes do OK
                    btnOk.parentElement.insertBefore(btnMega, btnOk);
                }
            } catch(_){ }
        }
    }, 50);
} catch (_){ }
}

// Exporta dados localmente em JSON (uso manual / botão local)
function exportarDadosLocal() {
    try {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const dataToExport = {
            boardsData: (typeof boards !== 'undefined') ? boards : [],
            autoFillData: (typeof autoFillData !== 'undefined') ? autoFillData : {},
            anotacoesData: (typeof anotacoesBoards !== 'undefined') ? anotacoesBoards : [],
            marcadores: (typeof marcadores !== 'undefined') ? marcadores : [],
            // correção: usar a chave plural esperada pelo import e incluir aparelhos correlacionados
            aparelhosConectados: (function(){ try { return JSON.parse(localStorage.getItem('aparelhosConectados')||'[]'); } catch(e){ return []; } })(),
            // incluir também aparelhos correlacionados persistidos pelo MI manager
            mi_db_v5: (function(){ try { return JSON.parse(localStorage.getItem('mi_db_v5')||'[]'); } catch(e){ return []; } })(),
            mi_cred_aparelhos: (function(){ try { return JSON.parse(localStorage.getItem('mi_cred_aparelhos')||'{}'); } catch(e){ return {}; } })(),
            cartaoPadrao: (function(){ try { return JSON.parse(localStorage.getItem('cartaoPadrao')||'null'); } catch(e){ return null; } })()
        };

        // Log para diagnosticar exportação de aparelhos correlacionados
        try{
            console.log('exportarDadosLocal - aparelhosConectados count:', (dataToExport.aparelhosConectados||[]).length, 'mi_db_v5 count:', (dataToExport.mi_db_v5||[]).length, 'mi_cred_aparelhos keys:', Object.keys(dataToExport.mi_cred_aparelhos||{}).length);
        }catch(e){}
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `senhas_export_${timestamp}.json`;
        a.click();
        try { mostrarMensagem('Sucesso', 'Arquivo gerado para download.'); } catch(_){ }
        setTimeout(() => { try { URL.revokeObjectURL(a.href); } catch(_){ } }, 1500);
    } catch (err) {
        console.error('Erro ao exportar localmente:', err);
        try { mostrarMensagem('Erro', 'Não foi possível exportar localmente.'); } catch(_){}
    }
}

// Expor via console/externo
window.exportarDadosLocal = exportarDadosLocal;

function importarDados(event, mode) {
const file = event.target.files[0];
if (!file) return;

try {
    // Contar leitura (usuário clicou/selecionou arquivo)
    try { if (typeof window._simIncReads === 'function') window._simIncReads(1); } catch(_){ }
    // Adicionar armazenamento baseado no tamanho do arquivo (bytes)
    try { if (typeof window._simAddStorageBytes === 'function') window._simAddStorageBytes(file.size); } catch(_){ }
} catch(e){ console.error('pre-import metrics update error', e); }

const reader = new FileReader();
reader.onload = (e) => {
    try {
        const dadosImportadosBrutos = JSON.parse(e.target.result);
        processImportedData(dadosImportadosBrutos, mode);
    } catch (err) {
        mostrarMensagem("Erro", "Não foi possível importar. Verifique o arquivo.");
        console.error('importarDados parse/process error', err);
    }
};
reader.readAsText(file);
event.target.value = "";
}

// Extrai a lógica de import para poder reaproveitar a partir da nuvem
function processImportedData(dadosImportadosBrutos, mode) {
    try {
        let boardsImportados = null;
        let anotacoesImportadas = null;
        let autoFillImportado = null;
        let marcadoresImportados = null;
        let cartaoPadraoImportado = null;

        if (Array.isArray(dadosImportadosBrutos)) {
            if (mode === 'senha') {
                boardsImportados = dadosImportadosBrutos;
            } else {
                anotacoesImportadas = dadosImportadosBrutos;
            }
        } else if (dadosImportadosBrutos && typeof dadosImportadosBrutos === 'object') {
            if (Array.isArray(dadosImportadosBrutos.boardsData)) {
                boardsImportados = dadosImportadosBrutos.boardsData;
            }
            if (Array.isArray(dadosImportadosBrutos.anotacoesData)) {
                anotacoesImportadas = dadosImportadosBrutos.anotacoesData;
            }
            if (dadosImportadosBrutos.autoFillData && typeof dadosImportadosBrutos.autoFillData === 'object') {
                autoFillImportado = dadosImportadosBrutos.autoFillData;
            }
            if (Array.isArray(dadosImportadosBrutos.marcadores)) {
                marcadoresImportados = dadosImportadosBrutos.marcadores;
            }
            if (dadosImportadosBrutos.cartaoPadrao || dadosImportadosBrutos['cartãoPadrao']) {
                cartaoPadraoImportado = dadosImportadosBrutos.cartaoPadrao || dadosImportadosBrutos['cartãoPadrao'];
            }
        } else {
            throw new Error('Formato de dados não reconhecido');
        }

        let atualizouSenhas = false;
        let atualizouAnotacoes = false;
        let atualizouAutoFill = false;
        let atualizouMarcadores = false;
        let atualizouCartaoPadrao = false;
        let atualizouDevices = false;
        let precisaResetarExpansao = false;

        if (boardsImportados !== null) {
            boards = JSON.parse(JSON.stringify(boardsImportados));
            boardsOriginal = JSON.parse(JSON.stringify(boardsImportados));
            atualizouSenhas = true;
            precisaResetarExpansao = true;
            senhasCarregadas = true;
        }

        if (autoFillImportado !== null) {
            autoFillData = JSON.parse(JSON.stringify(autoFillImportado));
            atualizouAutoFill = true;
        }

        if (anotacoesImportadas !== null) {
            anotacoesBoards = JSON.parse(JSON.stringify(anotacoesImportadas));
            anotacoesBoardsOriginal = JSON.parse(JSON.stringify(anotacoesImportadas));
            atualizouAnotacoes = true;
            precisaResetarExpansao = true;
            anotacoesCarregadas = true;
        }

        if (marcadoresImportados !== null) {
            try {
                marcadores = JSON.parse(JSON.stringify(marcadoresImportados));
            } catch (e) {
                marcadores = marcadoresImportados;
            }
            salvarMarcadores();
            atualizarSelectsMarcadores();
            atualizarListaMarcadores();
            atualizouMarcadores = true;
        }

        // Se a importação foi iniciada a partir do botão 'Importar (Local)'
        // e a flag foi marcada, executar atualização silenciosa e voltar ao painel de login.
        try {
            if (window._afterLocalImportDoRefresh) {
                try { window._afterLocalImportDoRefresh = false; } catch(_){}
                try {
                    // Disparar recriptografia/atualização silenciosa (não mostra a caixa de refresh)
                    if (typeof atualizarCriptografiaSite === 'function') {
                        atualizarCriptografiaSite().then(() => {
                            try { mostrarTela('login'); } catch(_){}
                        }).catch((err) => {
                            console.warn('Erro em atualizarCriptografiaSite pós-import', err);
                            try { mostrarTela('login'); } catch(_){}
                        });
                    } else {
                        try { mostrarTela('login'); } catch(_){}
                    }
                } catch (err) {
                    console.warn('Erro pós-import automático', err);
                    try { mostrarTela('login'); } catch(_){}
                }
            }
        } catch (err) { console.warn('checagem _afterLocalImportDoRefresh falhou', err); }

        if (cartaoPadraoImportado !== null) {
            try {
                localStorage.setItem('cartãoPadrao', JSON.stringify(cartaoPadraoImportado));
                if (typeof carregarCartaoPadraoParaForm === 'function') carregarCartaoPadraoParaForm();
                atualizouCartaoPadrao = true;
            } catch (err) { console.warn('Erro ao importar cartaoPadrao', err); }
        }

        if (Array.isArray(dadosImportadosBrutos.aparelhosConectados)) {
            try {
                localStorage.setItem('aparelhosConectados', JSON.stringify(dadosImportadosBrutos.aparelhosConectados));
                if (typeof carregarAparelhos === 'function') carregarAparelhos();
                if (typeof updateCurrentDeviceChip === 'function') updateCurrentDeviceChip();
                if (typeof renderizarAparelhosIcones === 'function') renderizarAparelhosIcones();
                atualizouDevices = true;
            } catch (err) { console.warn('Erro ao importar aparelhosConectados', err); }
        }

        // restaurar aparelhos correlacionados (mi_db_v5) e mapeamento por credencial
        try{
            if (Array.isArray(dadosImportadosBrutos.mi_db_v5)){
                const src = dadosImportadosBrutos.mi_db_v5 || [];
                try{
                    const existing = JSON.parse(localStorage.getItem('mi_db_v5')||'[]');
                    const byId = new Map();
                    (existing||[]).forEach(d=>{ if(d && d.id) byId.set(String(d.id), d); });
                    (src||[]).forEach(d=>{ if(d && d.id) byId.set(String(d.id), d); });
                    const merged = Array.from(byId.values());
                    localStorage.setItem('mi_db_v5', JSON.stringify(merged));
                    console.log('processImportedData - restored mi_db_v5 count (source):', src.length, 'mergedCount:', merged.length);
                }catch(e){
                    try{ localStorage.setItem('mi_db_v5', JSON.stringify(src)); console.warn('processImportedData - mi_db_v5 merge failed, fallback to source', e); }catch(err){ console.error('processImportedData - failed to persist mi_db_v5', err); }
                }
                try{ if(typeof mi_render === 'function') mi_render(); }catch(_){ }
                atualizouDevices = true;
            }
            if (dadosImportadosBrutos.mi_cred_aparelhos && typeof dadosImportadosBrutos.mi_cred_aparelhos === 'object'){
                const srcMap = dadosImportadosBrutos.mi_cred_aparelhos || {};
                try{
                    const existingMap = JSON.parse(localStorage.getItem('mi_cred_aparelhos')||'{}');
                    const mergedMap = Object.assign({}, existingMap);
                    Object.keys(srcMap).forEach(k=>{
                        const srcArr = Array.isArray(srcMap[k]) ? srcMap[k] : [];
                        const existArr = Array.isArray(mergedMap[k]) ? mergedMap[k] : [];
                        const byId = new Map();
                        existArr.forEach(d=>{ if(d && d.id) byId.set(String(d.id), d); });
                        srcArr.forEach(d=>{ if(d && d.id) byId.set(String(d.id), d); });
                        mergedMap[k] = Array.from(byId.values());
                    });
                    localStorage.setItem('mi_cred_aparelhos', JSON.stringify(mergedMap));
                    console.log('processImportedData - restored mi_cred_aparelhos keys (source):', Object.keys(srcMap||{}).length, 'mergedKeys:', Object.keys(mergedMap||{}).length);
                }catch(e){
                    try{ localStorage.setItem('mi_cred_aparelhos', JSON.stringify(srcMap)); console.warn('processImportedData - mi_cred_aparelhos merge failed, fallback to source', e); }catch(err){ console.error('processImportedData - failed to persist mi_cred_aparelhos', err); }
                }
                try{ if(typeof analisarCredenciais === 'function') analisarCredenciais(); }catch(_){ }
                try{ if(typeof atualizarUICredenciais === 'function') atualizarUICredenciais(); }catch(_){ }
                try{ if(typeof renderizarListaPessoas === 'function') renderizarListaPessoas(); }catch(_){ }
                atualizouDevices = true;
            }
        }catch(e){ console.warn('Erro ao importar aparelhos correlacionados', e); }

        if (!marcadoresImportados && Array.isArray(dadosImportadosBrutos.referencedMarcadorIds) && dadosImportadosBrutos.referencedMarcadorIds.length > 0) {
            try {
                const refs = dadosImportadosBrutos.referencedMarcadorIds;
                const existentes = Array.isArray(marcadores) ? marcadores : [];
                if ((!existentes || existentes.length === 0) && Array.isArray(refs) && refs.length > 0) {
                    marcadores = refs.map(r => {
                        const parsedId = (typeof r === 'string' && /^\d+$/.test(r)) ? Number(r) : r;
                        return { id: parsedId || Date.now() + Math.floor(Math.random() * 1000000), nome: `Importado - marcador ${String(r)}`, cor: '#888888', importante: false };
                    });
                    salvarMarcadores();
                    atualizarSelectsMarcadores();
                    mostrarMensagem('Atenção', `Foram criados ${marcadores.length} marcador(es) temporários para preservar referências. Abra 'Gerenciar Marcadores' para ajustar nomes/cores.`);
                    atualizouMarcadores = true;
                } else {
                    mostrarMensagem('Atenção', `O arquivo importado referencia ${refs.length} marcador(es), mas não contém suas definições. Abra "Gerenciar Marcadores" e crie/os importe manualmente.`);
                }
            } catch (err) { console.warn('Erro ao criar marcadores placeholder:', err); mostrarMensagem('Atenção', `O arquivo importado referencia marcadores, mas não contém suas definições.`); }
        }

        try { normalizarMarcadorIdsEmBoards(); } catch(e) { /* noop */ }

        if (!atualizouSenhas && !atualizouAnotacoes && !atualizouAutoFill) throw new Error('Dados não contêm conteúdo válido para importação');

        if (precisaResetarExpansao) openBoardIds.clear();

        const painelSenhasAtivo = appDiv && appDiv.style.display !== 'none';
        const painelAnotacoesAtivo = anotacoesAppDiv && anotacoesAppDiv.style.display !== 'none';

        if (atualizouSenhas || atualizouAutoFill) {
            salvarBoards('senha');
            if (painelSenhasAtivo) mostrarBoards('senha');
        }

        if (atualizouAnotacoes) {
            salvarBoards('anotacao');
            if (painelAnotacoesAtivo) mostrarBoards('anotacao');
        }

        if (atualizouMarcadores) {
            if (painelSenhasAtivo) mostrarBoards('senha');
            if (painelAnotacoesAtivo) mostrarBoards('anotacao');
        }

        mostrarMensagem('Sucesso', 'Dados importados com sucesso.');
    } catch (err) {
        mostrarMensagem('Erro', 'Não foi possível importar os dados.');
        console.error('processImportedData error', err);
    }
}

// Importar diretamente da nuvem (Firestore) usando window.carregarDados
async function importFromCloud(mode) {
    try {
        if (!window.carregarDados) {
            mostrarMensagem('Atenção', 'Sincronização na nuvem não está disponível.');
            return;
        }
            mostrarMensagem('Aguarde', 'Carregando dados da nuvem...');
            const remoto = await window.carregarDados();
            try { fecharMensagem(false); } catch(_){}
            if (!remoto) {
                // Tentativa de diagnóstico quando remoto == null (possível erro de auth)
                let diag = null;
                try {
                    if (typeof window.debugFirebaseSignIn === 'function') {
                        diag = await window.debugFirebaseSignIn();
                        console.info('importFromCloud debugFirebaseSignIn:', diag);
                    }
                } catch (e) { console.error('importFromCloud debug failed', e); }
                const msg = diag && diag.body && diag.body.error && diag.body.error.message ? `Erro de autenticação: ${diag.body.error.message}` : 'Nenhum dado disponível na nuvem ou falha na autenticação.';
                mostrarMensagem('Informação', msg);
                return;
            }
            // Aceitar várias formas: string JSON, objeto com campo `dados`, ou objeto já montado
            let payload = remoto;
            try {
                if (typeof remoto === 'string') {
                    payload = JSON.parse(remoto);
                } else if (remoto && typeof remoto === 'object' && remoto.dados) {
                    // `remoto.dados` pode ser stringified JSON
                    try { payload = (typeof remoto.dados === 'string') ? JSON.parse(remoto.dados) : remoto.dados; } catch(_){ payload = remoto.dados; }
                }
            } catch (e) {
                console.error('importFromCloud parse payload failed', e, remoto);
                mostrarMensagem('Erro', 'Erro ao interpretar os dados recebidos da nuvem. Veja console para detalhes.');
                return;
            }
            // Atualizar métricas automaticamente: tamanho do payload (bytes -> MB)
            try {
                if (payload) {
                    const asStr = typeof payload === 'string' ? payload : JSON.stringify(payload);
                    const bytes = (new TextEncoder().encode(asStr)).length;
                    if (typeof window._simAddStorageBytes === 'function') window._simAddStorageBytes(bytes);
                }
                // Caso importFromCloud seja chamado diretamente, conte também como leitura
                try { if (typeof window._simIncReads === 'function') window._simIncReads(1); } catch(_){ }
            } catch (e) { console.error('metrics update after importFromCloud', e); }
            processImportedData(payload, mode);
    } catch (err) {
            console.error('importFromCloud error', err);
            // tentar coletar diagnóstico REST
            try {
                if (typeof window.debugFirebaseSignIn === 'function') {
                    const dbg = await window.debugFirebaseSignIn();
                    console.info('importFromCloud debugFirebaseSignIn result', dbg);
                    mostrarMensagem('Erro', `Falha ao carregar da nuvem. Código HTTP: ${dbg.status || 'n/a'}. Mensagem: ${dbg.body && dbg.body.error && dbg.body.error.message ? dbg.body.error.message : 'ver console'}`);
                    return;
                }
            } catch (e) { console.error('importFromCloud debug call failed', e); }
            mostrarMensagem('Erro', 'Falha ao carregar dados da nuvem. Veja o console para detalhes.');
    }
}

// Exportar / salvar para a nuvem (usa helpers já existentes para montar o pacote)
async function exportToCloud(mode) {
    try {
        // Reutilizar as funções que reúnem os pacotes
        let senhaParaExport = typeof senhaDigitada === 'string' && senhaDigitada ? senhaDigitada : null;
        if (!senhaParaExport) {
            try {
                const anyAnotacoes = (function(){ try { return JSON.parse(localStorage.getItem('gerenciadorAnotacoes')||'[]'); } catch(e){ return []; } })();
                const hasEncrypted = anyAnotacoes.some(b => (b.cards||[]).some(c => c.marcadorId && typeof c.marcadorId === 'string' && c.marcadorId.startsWith('U2FsdGVk')));
                if (hasEncrypted) senhaParaExport = window.prompt('Senha mestra (apenas para desserializar referências durante o export)');
            } catch (e) { /* noop */ }
        }

        const pacoteSenhas = obterPacoteSenhasParaExportar(senhaParaExport);
        const pacoteAnotacoes = obterAnotacoesParaExportar(senhaParaExport);

        const referencedSet = new Set((pacoteSenhas.referencedMarcadorIds || []).map(r => r));
        const anotacoesArray = Array.isArray(pacoteAnotacoes) ? pacoteAnotacoes : (pacoteAnotacoes && Array.isArray(pacoteAnotacoes.anotacoesData) ? pacoteAnotacoes.anotacoesData : []);
        anotacoesArray.forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referencedSet.add(c.marcadorId); }); });
        const referencedAll = Array.from(referencedSet);

        const dataToExport = {
            boardsData: pacoteSenhas.boardsData,
            autoFillData: pacoteSenhas.autoFillData,
            anotacoesData: anotacoesArray,
            marcadores: pacoteSenhas.marcadores || [],
            referencedMarcadorIds: referencedAll,
            cartaoPadrao: (function(){ try { const raw = localStorage.getItem('cartãoPadrao'); return raw ? JSON.parse(raw) : null; } catch(_){ return null; } })(),
            aparelhosConectados: (function(){ try { return JSON.parse(localStorage.getItem('aparelhosConectados')||'[]'); } catch(e){ return []; } })(),
            // incluir aparelhos correlacionados (mi_db_v5) e mapeamento por credencial
            mi_db_v5: (function(){ try { return JSON.parse(localStorage.getItem('mi_db_v5')||'[]'); } catch(e){ return []; } })(),
            mi_cred_aparelhos: (function(){ try { return JSON.parse(localStorage.getItem('mi_cred_aparelhos')||'{}'); } catch(e){ return {}; } })(),
            exportStats: {
                senhas: (pacoteSenhas && pacoteSenhas.referencedConversionStats) ? pacoteSenhas.referencedConversionStats : { converted: 0, failed: 0 },
                anotacoes: (pacoteAnotacoes && pacoteAnotacoes.conversionStats) ? pacoteAnotacoes.conversionStats : { converted: 0, failed: 0 }
            }
        };

        if (window.salvarDados) {
            // diagnóstico: contar aparelhos e mapeamentos antes do envio
            try{ console.log('exportToCloud - aparelhosConectados:', (dataToExport.aparelhosConectados||[]).length, 'mi_db_v5:', (dataToExport.mi_db_v5||[]).length, 'mi_cred_aparelhos keys:', Object.keys(dataToExport.mi_cred_aparelhos||{}).length); }catch(e){}
            mostrarMensagem('Aguarde', 'Enviando dados para a nuvem...');
            const res = await window.salvarDados(JSON.stringify(dataToExport));
            try { fecharMensagem(false); } catch(_){}
            if (res && res.ok) {
                // Contar gravação automática
                try { if (typeof window._simIncWrites === 'function') window._simIncWrites(1); } catch(_){ }
                mostrarMensagem('Sucesso', 'Dados sincronizados com sucesso.');
            } else {
                console.error('exportToCloud salvarDados resposta', res);
                // Mostrar detalhes do erro quando disponíveis
                const errCode = res && res.error && res.error.code ? res.error.code : 'n/a';
                const errMsg = res && res.error && res.error.message ? res.error.message : 'Ver console para detalhes';
                // Tentativa de diagnóstico REST mais detalhado
                try {
                    if (typeof window.debugFirebaseSignIn === 'function') {
                        const dbg = await window.debugFirebaseSignIn();
                        console.info('exportToCloud debugFirebaseSignIn:', dbg);
                        if (dbg && dbg.body && dbg.body.error && dbg.body.error.message) {
                            mostrarMensagem('Erro', `Falha ao sincronizar (auth): ${dbg.body.error.message}`);
                            return;
                        }
                    }
                } catch (e) { console.error('exportToCloud debug call failed', e); }
                mostrarMensagem('Erro', `Não foi possível sincronizar os dados. Código: ${errCode}. ${errMsg}`);
            }
        } else {
            mostrarMensagem('Atenção', 'Sincronização na nuvem não disponível. Efetuando download local.');
            // fallback para download local usando o exportarDados existente
            exportarDados(mode);
        }
    } catch (err) {
        console.error('exportToCloud error', err);
        try {
            if (typeof window.debugFirebaseSignIn === 'function') {
                const dbg = await window.debugFirebaseSignIn();
                console.info('exportToCloud debugFirebaseSignIn result', dbg);
                mostrarMensagem('Erro', `Falha ao preparar envio. Código HTTP: ${dbg.status || 'n/a'}. Mensagem: ${dbg.body && dbg.body.error && dbg.body.error.message ? dbg.body.error.message : 'ver console'}`);
                return;
            }
        } catch (e) { console.error('exportToCloud debug failed', e); }
        mostrarMensagem('Erro', 'Falha ao preparar envio para nuvem. Veja o console para detalhes.');
    }
}


function abrirPaginaAutoFillForm() {
document.getElementById('autofill-usuario').value = autoFillData.usuario || '';
document.getElementById('autofill-email').value = autoFillData.email || '';
document.getElementById('autofill-telefone').value = autoFillData.telefone || '';
document.getElementById('autofill-notas').value = autoFillData.notas || '';
document.getElementById('autofill-links').value = autoFillData.links || '';
document.getElementById('autofill-abreviacao').value = autoFillData.abreviacao || '';
document.getElementById('autofill-cpf').value = autoFillData.cpf || '';
mostrarTela('autoFillForm');
}

function salvarFormularioAutomatico(e) {
e.preventDefault();
autoFillData = {
   usuario: document.getElementById('autofill-usuario').value.trim(),
   email: document.getElementById('autofill-email').value.trim(),
   telefone: document.getElementById('autofill-telefone').value.trim(),
   notas: document.getElementById('autofill-notas').value.trim(),
   links: document.getElementById('autofill-links').value.trim(),
   abreviacao: document.getElementById('autofill-abreviacao').value.trim(),
   cpf: document.getElementById('autofill-cpf').value.trim()
};
salvarBoards('senha'); 
mostrarMensagem("Sucesso", "Formulário automático salvo!");
mostrarTela('autoFillSettings');
}


// Funções do cartão padrão
function limparCamposCartaoPadrao() {
    if (defaultCardNumber) defaultCardNumber.value = '';
    if (defaultCardHolder) defaultCardHolder.value = '';
    if (defaultCardExpiry) defaultCardExpiry.value = '';
    if (defaultCardCvv) defaultCardCvv.value = '';
    if (defaultCardBrand) defaultCardBrand.value = '';
    if (previewCardNumber) previewCardNumber.textContent = '0000 0000 0000 0000';
    if (previewCardHolder) previewCardHolder.textContent = 'NOME DO TITULAR';
    if (previewCardExpiry) previewCardExpiry.textContent = 'MM/AA';
}

function atualizarPreviewCartaoPadrao() {
    if (defaultCardNumber) {
        let value = (defaultCardNumber.value || '').replace(/\D/g, '').slice(0, 16);
        const formatted = value.match(/.{1,4}/g)?.join(' ') || '';
        defaultCardNumber.value = formatted;
        if (previewCardNumber) previewCardNumber.textContent = formatted || '0000 0000 0000 0000';
    }

    if (defaultCardHolder) {
        const holder = (defaultCardHolder.value || '').toUpperCase();
        defaultCardHolder.value = holder;
        if (previewCardHolder) previewCardHolder.textContent = holder || 'NOME DO TITULAR';
    }

    if (defaultCardExpiry) {
        let exp = (defaultCardExpiry.value || '').replace(/\D/g, '').slice(0, 4);
        if (exp.length >= 3) {
            exp = `${exp.slice(0, 2)}/${exp.slice(2)}`;
        }
        defaultCardExpiry.value = exp;
        if (previewCardExpiry) previewCardExpiry.textContent = exp || 'MM/AA';
    }

    if (defaultCardCvv) {
        defaultCardCvv.value = (defaultCardCvv.value || '').replace(/\D/g, '').slice(0, 4);
    }
}

function carregarCartaoPadraoParaForm() {
    try {
        const cardStr = localStorage.getItem('cartãoPadrao');
        if (cardStr) {
            const card = JSON.parse(cardStr);
            if (defaultCardNumber) defaultCardNumber.value = card.numero || '';
            if (defaultCardHolder) defaultCardHolder.value = card.titular || '';
            if (defaultCardExpiry) defaultCardExpiry.value = card.validade || '';
            if (defaultCardCvv) defaultCardCvv.value = card.cvv || '';
            if (defaultCardBrand) defaultCardBrand.value = card.bandeira || '';
        } else {
            limparCamposCartaoPadrao();
        }
    } catch (err) {
        console.warn('Erro ao carregar cartão padrão', err);
        limparCamposCartaoPadrao();
    }
    atualizarPreviewCartaoPadrao();
}

function abrirModalCartaoPadrao() {
    carregarCartaoPadraoParaForm();
    if (defaultCardModal) defaultCardModal.style.display = 'flex';
    document.body.classList.add('modal-open');
}

function fecharModalCartaoPadrao() {
    if (defaultCardModal) defaultCardModal.style.display = 'none';
    document.body.classList.remove('modal-open');
}

function salvarCartaoPadrao() {
    const numero = (defaultCardNumber?.value || '').trim();
    const titular = (defaultCardHolder?.value || '').trim();
    const validade = (defaultCardExpiry?.value || '').trim();
    const cvv = (defaultCardCvv?.value || '').trim();
    const bandeira = (defaultCardBrand?.value || '').trim();

    if (!numero || !titular || !validade || !cvv || !bandeira) {
        mostrarMensagem('Atenção', 'Preencha todos os campos do cartão.');
        return;
    }

    const cartaoPadrao = { numero, titular, validade, cvv, bandeira };
    try {
        localStorage.setItem('cartãoPadrao', JSON.stringify(cartaoPadrao));
    } catch (err) {
        console.warn('Erro ao salvar cartão padrão', err);
    }

    fecharModalCartaoPadrao();
    mostrarMensagem('Sucesso', 'Cartão padrão salvo com sucesso!');
    try { analisarCredenciais(); } catch (e) { console.error('Erro ao analisar credenciais:', e); }
}

function limparCartaoPadrao() {
    const confirmado = confirm('Deseja realmente limpar o cartão padrão?');
    if (!confirmado) return;
    try { localStorage.removeItem('cartãoPadrao'); } catch (err) { console.warn('Erro ao limpar cartão padrão', err); }
    limparCamposCartaoPadrao();
    try { analisarCredenciais(); } catch (e) { console.error('Erro ao analisar credenciais:', e); }
}

if (defaultCardNumber) defaultCardNumber.addEventListener('input', atualizarPreviewCartaoPadrao);
if (defaultCardHolder) defaultCardHolder.addEventListener('input', atualizarPreviewCartaoPadrao);
if (defaultCardExpiry) defaultCardExpiry.addEventListener('input', atualizarPreviewCartaoPadrao);
if (defaultCardCvv) defaultCardCvv.addEventListener('input', atualizarPreviewCartaoPadrao);

let correlationEnabled = localStorage.getItem('correlationEnabled') === 'true';
let correlationWarningShown = false;

function initializeCorrelation() {
    const btnCorrelationToggle = document.getElementById('btn-correlation-toggle');
    const correlationStatus = document.getElementById('correlation-status');
    const correlationCheckbox = document.getElementById('correlation-checkbox');

    
    correlationCheckbox.checked = correlationEnabled;

    btnCorrelationToggle.addEventListener('click', () => {
        correlationStatus.style.display = correlationStatus.style.display === 'none' ? 'block' : 'none';
    });

    correlationCheckbox.addEventListener('change', function() {
        correlationEnabled = this.checked;
        localStorage.setItem('correlationEnabled', correlationEnabled);
        correlationWarningShown = false; 
    });
}

function showCorrelationWarning() {
    // respeita bloqueio de 24h para evitar alertas repetidos
    const blockedUntil = localStorage.getItem('correlationWarningBlockedUntil');
    if (blockedUntil) {
        const now = Date.now();
        if (now < parseInt(blockedUntil, 10)) {
            return;
        }
        localStorage.removeItem('correlationWarningBlockedUntil');
    }

    if (!correlationEnabled && !correlationWarningShown) {
        const warningDialog = document.createElement('div');
        warningDialog.className = 'correlation-warning';
        warningDialog.innerHTML = `
            <h3>Atenção, correlação desativada!</h3>
            <div class="correlation-warning-content">
                <div class="correlation-warning-buttons">
                    <button class="warning-btn" onclick="dismissWarning()">Cancelar</button>
                    <button class="warning-btn" onclick="enableCorrelation()">Corrigir</button>
                    <button class="warning-btn" onclick="blockWarningFor24h()" title="Dsesativar Hoje">Desativar Hoje</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(warningDialog);
        correlationWarningShown = true;
        
        
        const modalContent = document.querySelector('.modalContent');
        if (modalContent) {
            modalContent.style.pointerEvents = 'none';
        }

        
        requestAnimationFrame(() => {
            warningDialog.classList.add('visible');
        });
    }
}

function dismissWarning() {
    const warning = document.querySelector('.correlation-warning');
    if (warning) {
        warning.style.animation = 'fadeIn 0.3s ease-out reverse forwards';
        
        setTimeout(() => {
            warning.remove();
            
            const modalContent = document.querySelector('.modalContent');
            if (modalContent) {
                modalContent.style.pointerEvents = 'auto';
            }
        }, 300);
    }
}

function blockWarningFor24h() {
    const now = Date.now();
    const twentyFourHours = 24 * 60 * 60 * 1000;
    localStorage.setItem('correlationWarningBlockedUntil', String(now + twentyFourHours));
    dismissWarning();
}



function enableCorrelation() {
    
    document.getElementById('correlation-checkbox').checked = true;
    correlationEnabled = true;
    localStorage.setItem('correlationEnabled', 'true');
    dismissWarning();
    
    
    const boardName = editandoBoardId ? boards.find(b => b.id === editandoBoardId)?.nome : null;
    if (boardName) {
        document.getElementById('inputTitulo').value = 'www.' + boardName.toLowerCase() + '.com';
    }

    
    setTimeout(() => {
        document.getElementById('correlation-checkbox').checked = false;
        correlationEnabled = false;
        localStorage.setItem('correlationEnabled', 'false');
        correlationWarningShown = false; 
    }, 1000);
}

function atualizarServicoAutomatico(boardName) {
    if (correlationEnabled && boardName) {
        document.getElementById('inputTitulo').value = 'www.' + boardName.toLowerCase() + '.com';
    }
}


document.addEventListener('DOMContentLoaded', function() {
    initializeCorrelation();
});

function preencherFormularioSenha() {
if (Object.values(autoFillData).every(val => !val)) {
   mostrarMensagemNoModal("Aviso", "Nenhum dado de preenchimento automático foi salvo. Vá em Configurações Adicionais para criar um.");
   return;
}
document.querySelectorAll('#modalSenha .btn-clear-field').forEach(btn => btn.style.display = 'none');
const fieldMap = {
   usuario: document.getElementById("inputUsuario"),
   email: document.getElementById("inputEmail"),
   telefone: document.getElementById("inputTelefone"),
   notas: document.getElementById("inputNotas"),
   links: document.getElementById("inputLinks"),
   abreviacao: document.getElementById("inputAbreviacao"),
   cpf: document.getElementById("inputCpf")
};
for (const key in fieldMap) {
   if (autoFillData[key]) {
       const inputElement = fieldMap[key];
       inputElement.value = autoFillData[key];
       const container = inputElement.closest('.input-container');
       if (container) {
           const clearBtn = container.querySelector('.btn-clear-field');
           if (clearBtn) { clearBtn.style.display = 'block'; }
       }
       inputElement.dispatchEvent(new Event('input', { bubbles: true }));
   }
}
}


function iniciarInstalacao(type = 'install') {
if (type === 'install') { btnInstalar.disabled = true; }
const title = type === 'install' ? 'Instalando' : 'Atualizando';
messageBox.innerHTML = `<h2>${title}</h2><div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div><div class="loader"></div><div class="status-message" id="status-message">Iniciando...</div>`;
messageBox.style.display = 'block';
overlay.style.display = 'block';
simularInstalacao(type);
}

function simularInstalacao(type) {
let progresso = 0;
const progressBar = document.getElementById("progress-bar");
const statusMessage = document.getElementById("status-message");
const interval = setInterval(() => {
    progresso += Math.random() * 15;
    if (progresso > 100) progresso = 100;
    progressBar.style.width = `${progresso}%`;
    statusMessage.textContent = progresso < 50 ? "Preparando arquivos..." : "Finalizando...";
    if (progresso >= 100) {
        clearInterval(interval);
        const successTitle = type === 'install' ? 'Concluído' : 'Atualização Concluída';
        const successMessage = type === 'install' ? 'Instalado com sucesso!' : 'Atualizado com sucesso!';
        const buttonId = 'btnDownloadFinal';
        setTimeout(() => {
            messageBox.innerHTML = `<h2>${successTitle}</h2><p>${successMessage}</p><button id="${buttonId}" class="primary-action">Baixar Arquivo</button>`;
            document.getElementById(buttonId).addEventListener('click', () => fazerDownloadArquivo(type));
        }, 800);
    }
}, 300);
}

function fazerDownloadArquivo(type = 'install') {
const isUpdate = type === 'update';
if (isUpdate) {
    const driveUrl = 'https://drive.google.com/uc?export=download&id=1xlEid3uZStrAlxW-NA_Oho3cq6bt5ysI';
    window.open(driveUrl, '_blank');
} else {
    const conteudoArquivo = `-----BEGIN CERTIFICATE-----
dW9KmV7xX9aHqZFpLYzp+OwADkMZV9nJp
1UcgtmPC5vXzFKYIPrhwE0v9lJOhmfDsS
wNAGQ4fYReB2I5VZkXRc3T6P+6Oja9H1G
mY7VLa93DnXKH1YlrDNhwQoMNldCBvWPE
JTiY6Jz8MpWZ3mG5NO7BPqEq5XcgWA6TE
CyQ4Tw27nh6j9DkWT7s9YXeA83GZioAVz
7dk6yLtGLVSRHPxWa8QOdWY5lYwTniM7R
LCVcv2BwnNQ2ZTuHcfY9i5PbJW+FlMquj
Pa7XTjR93qAonq7ZmOckMWQwUwYcgMr7p
VrU1cDeyY6LIGxfO1mEi9rsjwOYPqlLAc
IMj0eWzMB8FnaLoFepQsq7lzqRwtdNSHn
M0UWyW9BKV6MIxPIE7dFp1RRCxrwUFLvO
ZwNpt2FxwUqJz2ZYXJGOSQayqAbOZ3qtH
tK8hYZwGJwC5Sr7dsShg5T95VXPyxGDKj
tbjO8Zxy2YpAy6RO3F9vpQfXWgTmtDNOI
lZhNYoZpmBNYMg3JbU0qWbW5Ay3VdkefK
yBqZxrHbciyF7JEKcdtbTegTZ53gLfbsX
snRuJMNlW4rSqp9TayCKXN2gkTzQGvO9v
M7WxgkFXcJwhAKeKzSkBNvRPoGMWLhYeJ
m3EdtHQnvIctvEVnZxAOTnZMEPydSUtYJ
eKsjxnlHzABQ29yHDv5b96EDWRLmknvV7
L0hWEnrG3FxJKVj0dxKUykqhzepnug6A2
h5YvQTm6ILGUlsBbN4v07pgu2xEmDbZIG
K2xuvRwDy7aq3RA9b6XeQLGfwHb1NckPp
OXWkq1EUyqXzYGfPbcZTpg07b3NjzKhBM
ahM09EkBLVDZHLUULv4pb3GbACVRlZiOa
6QOYF2U96WzqlYBHPgDrbqXVJX62H9T3k
0VImP7eiy79ZhXkt8qCvzavNE7XPV2yLo
CQKTnPdWwP27EciH7WxCXfJLSK1eXMdn5
KpoYOmb1ZKLRvnsqCG4zLGs3eUwI60F0T
ON8MG+YEkf9hm5iE0gz4vKLJmj34CPcUe
gRJwE1AFZehQlFuWcmwHTqgOKYq3YzXBN
jKFVd6FlMauMZorHoYf4p5Zt2xcRUF3Mi
pNScgOvXjHZ9U6kPaXAy3nAaY9WVT8uBO
B9hV4FcRPtEiX0k6dkgGEerNILZRpTtmb
IltcX58rPYH3EbftXqAoVCYaY0r2WupKW
PyRIKHn3LP2TmraUDF7Vx3MySPByiQbtQ
PAyecOngAh97LTkXErbn6OjjsfPqklYJu
RW0u6ONh3rcnpEyZba8zU4oKtBqHzwV19
lj61XUvnUZ8eCkHJ7Cqz0UO2p1Y0bFqd5
Ikb0DgoT1vN1obv2EkBXB9NU2Jx0Zkqwl
Zxyp3gj5itJHfZK7CD4u62MmUSlw5jYoh
pIdVzntGoqKjsvHd3i6KqH3ALrmFlV7UB
VKqEtJ0VbnYpG6UpxPXMCZytdgHTnLRmX
wqIidkjfSZCZJzVaOP3Bclt7aMQxNm6En
s5nmpWypX8cwldGOk8Zt3bnKGBKUF4OBD
J94c12BqRerZI6SYbwVoU9Ap5hxZOmMpy
Jjpw0INw7dyXMTA6Eoix1BpVkLNUpHzRk
9wDKtMR4YmvW1xlKkcIjkGC14Tx8bDN4Q
yewIzJMPnX7sOAKKcz4mS9XVoJYEFcgRz
AgmbtQd9eWi9ThT5bpGnpNYsKks3ybA1V
hTlmvqO6Y6EVc2ME72T7OC5X8IYHOMwLR
-----END CERTIFICATE-----`;
    const nomeArquivo = 'certificado_digital.txt';
    const blob = new Blob([conteudoArquivo], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = nomeArquivo;
    a.click();
    URL.revokeObjectURL(a.href);
}
fecharMensagem();
if (!isUpdate) { btnInstalar.disabled = false; }
}

function abrirModalObservacoes() {
    if (!overlay) return;
    // garantir que o overlay fique abaixo das message-box (que tem z-index muito alto)
    overlay.style.setProperty('z-index','2147483650','important');
    overlay.style.display = 'block';

    if (!modalObservacoes) {
        console.warn('modalObservacoes não encontrado ao tentar abrir observações.');
        overlay.style.display = 'none';
        overlay.style.zIndex = '';
        return;
    }

    // lock body to avoid jumps
    lockBodyScroll();
    modalObservacoes.style.display = 'block';
    // garantir que o modalObservacoes fique acima do overlay e de outros widgets
    modalObservacoes.style.setProperty('z-index','2147483652','important');
    document.body.classList.add('modal-open');

    // Reaplicar periodicamente enquanto o modal estiver aberto para evitar sobrescritas por outros trechos
    const __reapplyModalObs = setInterval(()=>{
        try{
            if(!modalObservacoes || modalObservacoes.style.display === 'none') { clearInterval(__reapplyModalObs); return; }
            overlay.style.setProperty('z-index','2147483650','important');
            modalObservacoes.style.setProperty('z-index','2147483652','important');
        }catch(e){ clearInterval(__reapplyModalObs); }
    }, 150);
}
function roundRect(ctx, x, y, width, height, radius) {
if (width < 2 * radius) radius = width / 2;
if (height < 2 * radius) radius = height / 2;
ctx.beginPath();
ctx.moveTo(x + radius, y);
ctx.arcTo(x + width, y, x + width, y + height, radius);
ctx.arcTo(x + width, y + height, x, y + height, radius);
ctx.arcTo(x, y + height, x, y, radius);
ctx.arcTo(x, y, x + width, y, radius);
ctx.closePath();
return ctx;
}

function drawCanvasBackground(ctx) {
  const canvas = ctx.canvas;
  const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
  bgGradient.addColorStop(0, '#0d1b2a');
  bgGradient.addColorStop(1, '#1a1a1a');
  ctx.fillStyle = bgGradient;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = 'rgba(23, 42, 69, 0.75)';
  ctx.strokeStyle = 'rgba(173, 216, 230, 0.15)';
  ctx.lineWidth = 2;
  roundRect(ctx, 40, 40, canvas.width - 80, canvas.height - 80, 24);
  ctx.fill();
  ctx.stroke();
}

function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight) {
if (!text) return y;
const words = text.split(' ');
let line = '';
for (let n = 0; n < words.length; n++) {
  const testLine = line + words[n] + ' ';
  const metrics = ctx.measureText(testLine);
  if (metrics.width > maxWidth && n > 0) {
      ctx.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineHeight;
  } else {
      line = testLine;
  }
}
ctx.fillText(line, x, y);
return y;
}
function salvarObservacoesEBaixarImagem() {
    const texto = document.getElementById('observacoes-textarea').value;
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
canvas.width = 600; canvas.height = 450;
drawCanvasBackground(ctx);
ctx.fillStyle = '#fff';
ctx.font = 'bold 24px "Segoe UI"';
ctx.textAlign = 'left'; 
// Título
ctx.fillText('Anotações', 70, 90);
ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; 
ctx.fillRect(70, 115, canvas.width - 140, 1);
ctx.fillStyle = '#f0f0f0';
ctx.font = '16px "Segoe UI"';
// Texto das observações
const textoFimY = drawWrappedText(ctx, texto, 70, 150, canvas.width - 140, 24);

// Metadados na parte de baixo (dentro da borda)
try {
    const versaoEl = document.querySelector('#version-link .version-text');
    const timerEl = document.querySelector('#version-link .update-timer');
    const versaoTxt = versaoEl ? versaoEl.textContent.trim() : '';
    const timerTxt = timerEl ? timerEl.textContent.trim() : '';
    const servidorTxt = 'localhost://index.upload.html';
    ctx.fillStyle = 'rgba(240, 240, 240, 0.5)';
    ctx.font = '12px "Segoe UI"';
    ctx.textAlign = 'left';
    const baseX = 70;
    const metaLH = 18;
    const metaLinhas = 3;
    const bottomBaseline = canvas.height - 70; // onde a data vai
    const metaTopLimite = bottomBaseline - 10 - (metaLH * metaLinhas); // 10px de respiro acima da data
    let metaY = Math.max(textoFimY + 20, metaTopLimite);
    // Garantir que as linhas não ultrapassem a área útil
    if (metaY + metaLH * (metaLinhas - 1) > bottomBaseline - 12) {
        metaY = bottomBaseline - 12 - metaLH * (metaLinhas - 1);
    }
    if (versaoTxt) ctx.fillText(`Versão: ${versaoTxt.replace(/^Versão\s*/i, '')}`, baseX, metaY);
    metaY += metaLH;
    if (timerTxt) ctx.fillText(`Atualização ${timerTxt}`, baseX, metaY);
    metaY += metaLH;
    ctx.fillText(`Servidor: ${servidorTxt}`, baseX, metaY);
} catch(e) { /* noop */ }
const dataFormatada = new Date().toLocaleDateString('pt-BR');
ctx.fillStyle = 'rgba(240, 240, 240, 0.5)';
ctx.font = '12px "Segoe UI"'; 
ctx.textAlign = 'right';
ctx.fillText(dataFormatada, canvas.width - 70, canvas.height - 70);
    const link = document.createElement('a');
    link.download = 'anotacoes.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
    fecharMensagem();
}
function downloadCardAsImage(cardData) {
    // Gerar chave aleatória forte
    const senha = gerarSenhaAleatoria(12);
    const safeTitle = (cardData.titulo || 'dados').replace(/[^a-z0-9]/gi, '_').toLowerCase();

    // Helper para exibir a senha de forma compatível
    const mostrarSenhaSegura = () => setTimeout(() => {
        try { if (typeof mostrarSenhaCombotaoCopiar === 'function') mostrarSenhaCombotaoCopiar(senha, cardData.titulo); } catch(_){ }
        try { if (typeof mostrarSenhaCombotãoCopiar === 'function') mostrarSenhaCombotãoCopiar(senha, cardData.titulo); } catch(_){ }
    }, 450);

    // Detectar construtor do jsPDF de forma resiliente
    let jsPDFCtor = null;
    if (typeof window !== 'undefined') {
        if (window.jspdf) {
            if (typeof window.jspdf.jsPDF === 'function') jsPDFCtor = window.jspdf.jsPDF;
            else if (typeof window.jspdf === 'function') jsPDFCtor = window.jspdf;
            else if (window.jspdf.default && typeof window.jspdf.default === 'function') jsPDFCtor = window.jspdf.default;
        }
        if (!jsPDFCtor && typeof window.jsPDF === 'function') jsPDFCtor = window.jsPDF;
    }

    let lastErr = '';

    if (jsPDFCtor) {
        // Tentar gerar PDF com criptografia (se suportado)
        try {
            // Instanciar o jsPDF (tenta 'new' e, se falhar, chama sem 'new')
            let doc;
            try {
                doc = new jsPDFCtor({ orientation: 'portrait', unit: 'pt', format: 'a4', encryption: { userPassword: senha, ownerPassword: senha + '_owner_' + Date.now(), userPermissions: ['print'] } });
            } catch (ctorErr) {
                try {
                    doc = jsPDFCtor({ orientation: 'portrait', unit: 'pt', format: 'a4', encryption: { userPassword: senha, ownerPassword: senha + '_owner_' + Date.now(), userPermissions: ['print'] } });
                } catch (ctorErr2) {
                    throw ctorErr; // preserve original error
                }
            }

            const width = 595; const height = 842; let y = 70;

            doc.setFillColor(248, 249, 251);
            doc.rect(0, 0, width, 160, 'F');
            doc.setFillColor(0,0,0); doc.rect(0,0,6,160,'F');
            doc.setLineWidth(2); doc.setDrawColor(0,0,0);
            if (typeof doc.roundedRect === 'function') { doc.roundedRect(45,50,22,26,2,2,'S'); }
            if (typeof doc.circle === 'function') { doc.circle(56,63,6,'S'); }
            doc.setLineWidth(1.5); if (typeof doc.line === 'function') doc.line(51,69,61,69);
            if (typeof doc.setFontSize === 'function') { doc.setFontSize(32); doc.setTextColor(0,0,0); doc.setFont('helvetica','bold'); }
            if (typeof doc.text === 'function') doc.text(cardData.titulo || 'Documento Protegido', 80, 70);
            if (typeof doc.setFontSize === 'function') { doc.setFontSize(12); doc.setTextColor(80,80,80); doc.setFont('helvetica','normal'); }

            if (typeof doc.setDrawColor === 'function') { doc.setDrawColor(0,0,0); doc.setFillColor(255,255,255); doc.setLineWidth(1); }
            if (typeof doc.roundedRect === 'function') { doc.roundedRect(80,105,140,24,4,4,'FD'); }
            if (typeof doc.setFontSize === 'function') { doc.setFontSize(10); doc.setTextColor(0,0,0); doc.setFont('helvetica','bold'); }
            if (typeof doc.text === 'function') doc.text('PROTEGIDO POR SENHA', 95, 121);
            if (typeof doc.setLineWidth === 'function' && typeof doc.line === 'function') { doc.setLineWidth(1.5); doc.line(40,150,width-40,150); }

            y = 190;
            const criarSecao = (label, value) => {
                if (!value) return;
                if (typeof doc.setFillColor === 'function') doc.setFillColor(255,255,255);
                if (typeof doc.setDrawColor === 'function') doc.setDrawColor(230,230,230);
                if (typeof doc.setLineWidth === 'function') doc.setLineWidth(0.5);
                if (typeof doc.roundedRect === 'function') doc.roundedRect(50, y-5, 495, 45, 3, 3, 'FD');
                if (typeof doc.roundedRect === 'function') doc.roundedRect(50, y-5, 3, 45, 1.5, 1.5, 'F');
                if (typeof doc.setFontSize === 'function') doc.setFontSize(9);
                if (typeof doc.setTextColor === 'function') doc.setTextColor(100,100,100);
                if (typeof doc.setFont === 'function') doc.setFont('helvetica','bold');
                if (typeof doc.text === 'function') doc.text(label, 65, y+8);
                let valorTexto = String(value);
                if (valorTexto.length > 65) valorTexto = valorTexto.substring(0,65) + '...';
                if (typeof doc.setFontSize === 'function') doc.setFontSize(12);
                if (typeof doc.setTextColor === 'function') doc.setTextColor(0,0,0);
                if (typeof doc.setFont === 'function') doc.setFont('helvetica','normal');
                if (typeof doc.text === 'function') doc.text(valorTexto, 65, y+24, { maxWidth: 465 });
                y += 55;
            };

            if (cardData.usuario) criarSecao('USUÁRIO', cardData.usuario);
            if (cardData.senha) criarSecao('SENHA', cardData.senha);
            if (cardData.email) criarSecao('E-MAIL', cardData.email);
            if (cardData.telefone) criarSecao('TELEFONE', cardData.telefone);
            if (cardData.cpf) criarSecao('CPF', cardData.cpf);
            if (cardData.links) criarSecao('LINK', cardData.links);
            if (cardData.notas) {
                const alturaNotas = 70;
                doc.setFillColor(252,252,253); doc.setDrawColor(220,220,220); doc.setLineWidth(0.5);
                doc.roundedRect(50, y-5, 495, alturaNotas, 3,3,'FD');
                doc.setFillColor(255,180,0); doc.roundedRect(50, y-5, 3, alturaNotas, 1.5,1.5,'F');
                doc.setFontSize(9); doc.setTextColor(100,100,100); doc.setFont('helvetica','bold'); doc.text('OBSERVAÇÕES', 65, y+8);
                let notasTexto = String(cardData.notas);
                if (notasTexto.length > 220) notasTexto = notasTexto.substring(0,220) + '...';
                doc.setFontSize(10); doc.setTextColor(50,50,50); doc.setFont('helvetica','normal');
                doc.text(notasTexto, 65, y+24, { maxWidth: 465, lineHeightFactor: 1.4 });
                y += alturaNotas + 10;
            }

            const dataCompleta = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            doc.setFillColor(248,249,251); doc.rect(0, 842-80, width, 80, 'F');
            doc.setDrawColor(0,0,0); doc.setLineWidth(1); doc.line(40, 842-70, width-40, 842-70);
            doc.setFillColor(0,0,0); doc.rect(0, 842-80, 6, 80, 'F');
            doc.setFontSize(8); doc.setTextColor(120,120,120); doc.setFont('helvetica','normal'); doc.text(`Documento gerado em ${dataCompleta}`, 50, 842-50);
            doc.setFont('helvetica','bold'); doc.setTextColor(0,0,0); doc.text('KeyMaster', 50, 842-35);
            doc.setFontSize(9); doc.setTextColor(100,100,100); doc.setFont('helvetica','normal'); doc.text('Página 1', width-60, 842-40, { align: 'right' });
            doc.setFontSize(8); doc.setTextColor(0,0,0); doc.setFont('helvetica','bold'); doc.text('PROTEGIDO', width-60, 842-52, { align: 'right' });

            // Tentar salvar com criptografia
            try {
                doc.save(`dados_${safeTitle}.pdf`);
                // registrar evento de download do PDF (criptografado)
                try { savePdfDownloadEntry({ titulo: cardData.titulo || 'dados', senha, encrypted: true, timestamp: Date.now() }); } catch(_){ }
                console.info('downloadCardAsImage: PDF criptografado gerado com sucesso');
                try { delete cardData._pdfRetry; } catch(_){}
                mostrarSenhaSegura();
                return;
            } catch (saveErr) {
                lastErr = saveErr && saveErr.message ? saveErr.message : String(saveErr);
                console.warn('Erro ao salvar PDF criptografado (tentando fallback sem criptografia):', saveErr);
            }

        } catch (err) {
            lastErr = err && err.message ? err.message : String(err);
            console.warn('Erro ao tentar gerar PDF criptografado:', err);
        }

        // Tentativa secundária: gerar PDF sem criptografia
        try {
            let doc2;
            try { doc2 = new jsPDFCtor({ orientation: 'portrait', unit: 'pt', format: 'a4' }); }
            catch (ctorErr) {
                try { doc2 = jsPDFCtor({ orientation: 'portrait', unit: 'pt', format: 'a4' }); }
                catch (ctorErr2) { throw ctorErr; }
            }
            let y2 = 70;
            if (typeof doc2.setFontSize === 'function') doc2.setFontSize(22);
            if (typeof doc2.text === 'function') doc2.text(cardData.titulo || 'Documento', 60, y2);
            y2 += 36;
            if (cardData.usuario && typeof doc2.text === 'function') { doc2.text(`Usuário: ${String(cardData.usuario)}`, 60, y2); y2 += 18; }
            if (cardData.senha && typeof doc2.text === 'function') { doc2.text(`Senha: ${String(cardData.senha)}`, 60, y2); y2 += 18; }
            if (cardData.email && typeof doc2.text === 'function') { doc2.text(`E-mail: ${String(cardData.email)}`, 60, y2); y2 += 18; }
            if (typeof doc2.save === 'function') doc2.save(`dados_${safeTitle}.pdf`);
            // registrar evento de download do PDF (sem criptografia)
            try { savePdfDownloadEntry({ titulo: cardData.titulo || 'dados', senha, encrypted: false, timestamp: Date.now() }); } catch(_){ }
            console.info('downloadCardAsImage: PDF (sem criptografia) gerado com sucesso');
            try { delete cardData._pdfRetry; } catch(_){}
            mostrarSenhaSegura();
            return;
        } catch (errNoEnc) {
            lastErr = errNoEnc && errNoEnc.message ? errNoEnc.message : String(errNoEnc);
            console.warn('Erro ao gerar PDF sem criptografia:', errNoEnc);
        }
    } else {
        lastErr = 'Biblioteca jsPDF não encontrada';
        console.warn('downloadCardAsImage:', lastErr);
        // Tentar carregar jsPDF dinamicamente uma vez, antes de cair no fallback PNG
        try {
            if (!cardData._pdfRetry) {
                cardData._pdfRetry = 1;
                mostrarMensagem('Aguarde', 'Carregando gerador de PDF...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.crossOrigin = 'anonymous';
                script.onload = () => {
                    try {
                        mostrarMensagem('Aguarde', 'Gerador de PDF carregado. Iniciando geração...');
                        // Pequeno delay para o browser registrar as novas variáveis
                        setTimeout(() => { downloadCardAsImage(cardData); }, 120);
                    } catch (_) { /* noop */ }
                };
                script.onerror = () => {
                    console.error('Falha ao carregar jsPDF via CDN');
                    // Marcar como tentado para não ficar em loop e prosseguir para o fallback PNG
                    cardData._pdfRetry = 2;
                    // Reexecutar para cair no fallback PNG abaixo
                    setTimeout(() => { downloadCardAsImage(cardData); }, 80);
                };
                document.head.appendChild(script);
                return; // aguardar carregamento
            }
        } catch(_){ /* noop */ }
    }

    // Fallback final: PNG (mas avisar o usuário do motivo)
    try {
        mostrarMensagem('Atenção', `Não foi possível gerar PDF (${lastErr}). Baixando imagem como fallback.`);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600; canvas.height = 450;
        if (typeof drawCanvasBackground === 'function') drawCanvasBackground(ctx); else { ctx.fillStyle = '#0d1b2a'; ctx.fillRect(0,0,canvas.width,canvas.height); }
        ctx.fillStyle = '#fff'; ctx.font = 'bold 24px "Segoe UI"'; ctx.textAlign = 'left'; ctx.fillText(cardData.titulo || 'Dados', 70, 90);
        ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fillRect(70,115,canvas.width-140,1);
        let y = 150; const lineHeight = 28;
        const drawField = (label, value) => {
            if (!value) return;
            ctx.fillStyle = '#fff'; ctx.font = 'bold 16px "Segoe UI"'; ctx.textAlign = 'left'; ctx.fillText(label, 70, y);
            ctx.fillStyle = '#f0f0f0'; ctx.font = '16px "Segoe UI"';
            if (typeof drawWrappedText === 'function') { y = drawWrappedText(ctx, value, 200, y, canvas.width - 270, lineHeight * 0.85); } else { ctx.fillText(String(value), 200, y); y += lineHeight; }
            y += lineHeight;
        };
        if (cardData.usuario) drawField('Usuário:', cardData.usuario);
        if (cardData.senha) drawField('Senha:', cardData.senha);
        if (cardData.email) drawField('E-mail:', cardData.email);
        if (cardData.telefone) drawField('Telefone:', cardData.telefone);
        if (cardData.cpf) drawField('CPF:', cardData.cpf);
        if (cardData.links) drawField('Links:', cardData.links);
        if (cardData.notas) drawField('Notas:', cardData.notas);
        const dataFormatada = new Date().toLocaleDateString('pt-BR'); ctx.fillStyle = 'rgba(240,240,240,0.5)'; ctx.font = '12px "Segoe UI"'; ctx.textAlign = 'right'; ctx.fillText(dataFormatada, canvas.width - 70, canvas.height - 70);
        const link = document.createElement('a'); link.download = `dados_${safeTitle}.png`; link.href = canvas.toDataURL('image/png'); document.body.appendChild(link); link.click(); link.remove();
        mostrarSenhaSegura();
    } catch (err) {
        console.error('Fallback PNG falhou:', err);
        mostrarMensagem('Erro', 'Não foi possível gerar o arquivo para download.');
    }
}

function mostrarVisualizacaoCompleta(card) {
    const badgeHTML = renderizarBadgeMarcador(card.marcadorId);
    // Aplicar destaque importante na caixa de visualização (se aplicável)
    try {
        const marcador = obterMarcador(card.marcadorId);
        if (marcador && marcador.importante && marcador.cor) {
            messageBox.classList.add('marcador-importante-ativo');
            messageBox.style.setProperty('--marcador-cor-importante', marcador.cor);
        } else {
            messageBox.classList.remove('marcador-importante-ativo');
            messageBox.style.removeProperty('--marcador-cor-importante');
        }
    } catch (e) { /* noop */ }

    // preparar rótulo/HTML dos campos personalizados (apenas para visualização completa)
    let customChips = '';
    try {
        // Labels curtas para visualização completa
        const map = {
            'frase_seguranca': 'Frase',
            'codigo_seguranca': 'Código',
            'cpf_custom': 'CPF',
            'telefone': 'Tel',
            'email': 'Email',
            'nascimento': 'Nasc.',
            'senha_numerica': 'Código',
            'chave_seguranca': 'Chave',
            'dica_extra': 'Dica',
            'senha_alfanumerica': 'Senha',
            'agencia': 'Ag.',
            'conta': 'Conta',
            'personalizado': 'Personalizado'
        };
        if (card && Array.isArray(card.customFields) && card.customFields.length) {
            customChips = card.customFields.map(cf => {
                const t = String((cf && cf.type) || '').toLowerCase();
                const label = map[t] || (t ? t.replace(/_/g, ' ') : 'Personalizado');
                const val = (cf && cf.value) ? cf.value : '';
                return val ? `<div class="chip"><span class="chip-label">${label}</span><span class="chip-value">${val}</span></div>` : '';
            }).filter(Boolean).join('');
        } else if (card && card.customField && card.customField.value) {
            const t = String(card.customField.type || '').toLowerCase();
            const label = map[t] || (t ? t.replace(/_/g, ' ') : 'Personalizado');
            customChips = `<div class="chip"><span class="chip-label">${label}</span><span class="chip-value">${card.customField.value}</span></div>`;
        }
    } catch (e) { customChips = ''; }
    // preparar estrutura básica e DOM mínimo para aparecer rapidamente
    messageBox.innerHTML = `<h2>${card.titulo || 'Detalhes'}</h2><div id="visualizacao-content" class="view-content"><div id="visualizacao-badge">${badgeHTML ? `<div class="marcadores-container" style="margin-bottom: 12px;">${badgeHTML}</div>` : ''}</div><div id="visualizacao-meta" class="view-meta">${card.usuario ? `<div class="chip"><span class="chip-label">Usuário</span><span class="chip-value">${card.usuario}</span></div>` : ''}${card.senha ? `<div class="chip"><span class="chip-label">Senha</span><span class="chip-value">${card.senha}</span></div>` : ''}${card.email ? `<div class="chip"><span class="chip-label">Email</span><span class="chip-value">${card.email}</span></div>` : ''}${card.telefone ? `<div class="chip"><span class="chip-label">Tel</span><span class="chip-value">${card.telefone}</span></div>` : ''}${card.cpf ? `<div class="chip"><span class="chip-label">CPF</span><span class="chip-value">${card.cpf}</span></div>` : ''}${customChips}${card.links ? `<div class="links-chip"><a href="${card.links}" target="_blank" rel="noopener noreferrer">${card.abreviacao && card.abreviacao.trim() !== '' ? card.abreviacao : card.links}</a></div>` : ''}${card.notas ? `<div class="notes-full">${card.notas.replace(/\n/g, '<br>')}</div>` : ''}</div><div id="visualizacao-cards-placeholder"></div></div><div class="modalButtons"><button id="btnFecharMensagem">OK</button></div>`;
    // renderizar cartões pesados assincronamente para não travar a UI
    setTimeout(() => {
        try {
            const raw = card.cartoes || card.cartões || card.cartao || card.cartão;
            const cardsFromCard = (raw ? (Array.isArray(raw) ? raw : (typeof raw === 'object' ? [raw] : [])) : []).filter((c) => c && c.numero);
            const container = document.getElementById('visualizacao-cards-placeholder');
            if (!container) return;
            if (cardsFromCard.length === 0) return;
            const frag = document.createDocumentFragment();
            cardsFromCard.forEach((c, idx) => {
                try {
                    const id = `view-cartao-${Date.now()}-${idx}-${Math.floor(Math.random() * 1000)}`;
                    let numeroMascarado = c.numero;
                    if (numeroMascarado && numeroMascarado.length >= 4) {
                        const ultimos4 = numeroMascarado.slice(-4);
                        numeroMascarado = '•••• •••• •••• ' + ultimos4;
                    } else if (numeroMascarado) {
                        numeroMascarado = '••••';
                    }
                    const div = document.createElement('div');
                    div.className = 'view-card detalhe-item';
                    div.innerHTML = `
                        <button class="btn-revelar-cartao" onclick="toggleCartaoVisibilidade('${id}')" title="Mostrar/Ocultar" style="position:absolute!important;top:8px!important;right:8px!important;width:22px!important;height:22px!important;min-width:22px!important;max-width:22px!important;padding:4px!important;display:inline-flex!important;align-items:center!important;justify-content:center!important;box-sizing:border-box!important;flex:0 0 auto!important;flex-shrink:0!important;flex-grow:0!important;">` +
                        `<svg id="${id}-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px!important;height:14px!important;"></svg></button>` +
                        `<div class="detalhe-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg></div>` +
                        `<div class="detalhe-content"><div class="detalhe-label">Cartão ${c.bandeira || ''}</div><div class="detalhe-valor"><span id="${id}-numero">${numeroMascarado || ''}</span><span id="${id}-numero-completo" style="display:none;">${c.numero || ''}</span></div><div style="font-size: 0.85rem; opacity: 0.7; margin-top: 4px;"><div id="${id}-validade">${c.validade ? `Validade: ${c.validade}` : ''}</div><div id="${id}-cvv" style="display:none; margin-top: 2px;">${c.cvv ? `CVV: ${c.cvv}` : ''}</div></div></div>`;
                    frag.appendChild(div);
                } catch (err) { console.warn('Erro render-cartao assíncrono', err); }
            });
            container.appendChild(frag);
        } catch (err) { console.warn('Erro ao renderizar cartões assíncronos', err); }
    }, 0);
    // modal token to ensure only this modal can close/unlock
    const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
    window.__modalTokens = window.__modalTokens || [];
    window.__modalTokens.push(modalToken);
    try { messageBox.dataset.modalToken = modalToken; } catch(_){}
    // lock body scroll while the visualização modal is open to avoid background jumps
    lockBodyScroll();
    document.body.classList.add('modal-open');
    // briefly shield overlay clicks immediately after opening to avoid the original
    // click that opened the modal from reaching the new elements and causing an immediate close.
    window.__modalClickShield = true;
    try { window.__lastModalOpenTime = Date.now(); } catch(_){}
    // disable pointer events on overlay/messageBox while the shield is active
    try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
    setTimeout(() => {
        window.__modalClickShield = false;
        try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){ }
    }, 420);
    overlay.style.display = 'block';
    messageBox.style.display = 'block';
    // Attach safe close that defers if necessary
    attachSafeClose('btnFecharMensagem', modalToken);
}

function mostrarMensagemNoModal(titulo, mensagem) {
    messageBox.innerHTML = `<h2>${titulo}</h2><p>${mensagem}</p><button id="btnFecharMsgSimples">OK</button>`;
    const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
    window.__modalTokens = window.__modalTokens || [];
    window.__modalTokens.push(modalToken);
    try { messageBox.dataset.modalToken = modalToken; } catch(_){}
        // shield overlay clicks briefly to avoid immediate reclose by originating click
        window.__modalClickShield = true;
        try { window.__lastModalOpenTime = Date.now(); } catch(_){}
        setTimeout(() => { window.__modalClickShield = false; }, 420);
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        attachSafeClose('btnFecharMsgSimples', modalToken);
}

function mostrarMensagem(titulo, mensagem) {
    messageBox.innerHTML = `<h2>${titulo}</h2><p>${mensagem}</p><button id="btnFecharMensagem">OK</button>`;
    const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
    window.__modalTokens = window.__modalTokens || [];
    window.__modalTokens.push(modalToken);
    try { messageBox.dataset.modalToken = modalToken; } catch(_){}
    // shield overlay clicks briefly to avoid immediate reclose by originating click
    window.__modalClickShield = true;
    try { window.__lastModalOpenTime = Date.now(); } catch(_){}
    try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
    setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){} }, 420);
    // garantir z-index corretos
    overlay.style.setProperty('z-index','2147483650','important');
    messageBox.style.setProperty('z-index','2147483652','important');
    overlay.style.display = 'block'; messageBox.style.display = 'block';
    attachSafeClose('btnFecharMensagem', modalToken);
}
function mostrarConfirmacao(titulo, mensagem) {
return new Promise((resolve) => {
  overlay.removeEventListener('click', fecharMensagem);
    messageBox.innerHTML = `<h2>${titulo}</h2><p>${mensagem}</p><div style="display:flex;justify-content:center;gap:20px;margin-top:20px;"><button id="btnCancelarConfirmacao">Cancelar</button><button id="btnConfirmar" style="background-color:#e74c3c;">Confirmar</button></div>`;
    // Garantir que o diálogo de confirmação fique acima de outras caixas
    overlay.style.setProperty('z-index','2147483650','important');
    messageBox.style.setProperty('z-index','2147483652','important');
    // shield and block pointer events briefly to avoid immediate clicks
    window.__modalClickShield = true;
    try { window.__lastModalOpenTime = Date.now(); } catch(_){}
    try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
    setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){} }, 180);
    overlay.style.display = 'block'; messageBox.style.display = 'block';
  document.body.classList.add('modal-open');
        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_){}
        const close = (value) => { fecharMensagem(false, modalToken); try { overlay.removeEventListener('click', handleOverlayClick); } catch(_){}; overlay.addEventListener('click', handleOverlayClick); resolve(value); };
  document.getElementById('btnConfirmar').addEventListener('click', () => close(true), { once: true });
  document.getElementById('btnCancelarConfirmacao').addEventListener('click', () => close(false), { once: true });
    (function attachOverlayCloseOnce() {
        const handler = function (e) {
            if (window.__modalClickShield) {
                console.log('[MODAL-SHIELD] deferred one-time overlay close (confirm dialog)');
                // reattach after shield window
                overlay.removeEventListener('click', handler);
                setTimeout(() => { try { overlay.addEventListener('click', handler, { once: true }); } catch(_){} }, 160);
                return;
            }
            try { close(false); } catch (err) { console.warn('overlay close handler failed', err); }
            try { overlay.removeEventListener('click', handler); } catch(_){}
        };
        overlay.addEventListener('click', handler, { once: true });
    })();
});
}

// Prompt simples para solicitar senha do item a ser criado/copiar em Senhas
function mostrarPromptSenha(titulo, mensagem, placeholder = 'Digite a senha do serviço', showToggle = true) {
    return new Promise((resolve) => {
        overlay.removeEventListener('click', fecharMensagem);
            messageBox.innerHTML = `
            <h2>${titulo}</h2>
            <p>${mensagem}</p>
            <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;align-items:stretch;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input id="promptSenhaInput" type="password" placeholder="${placeholder}" style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.18);background: rgba(255,255,255,0.04);backdrop-filter: blur(8px) saturate(120%);color: inherit;font-size:1rem;" />
                        ${showToggle ? `<button id="toggleSenhaVis" title="Mostrar/ocultar senha" aria-label="Mostrar/ocultar senha" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.18);background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));backdrop-filter: blur(8px) saturate(120%);color: var(--primary-accent);display:flex;align-items:center;justify-content:center;">${createEyeIconSVG()}</button>` : ''}
                </div>
                <div style="display:flex;justify-content:center;gap:20px;margin-top:10px;">
                    <button id="btnCancelarPrompt">Cancelar</button>
                    <button id="btnOkPrompt" style="background-color: var(--primary-accent);">OK</button>
                </div>
            </div>
        `;
            // Se for prompt de reaplicar criptografia, forçamos layout mobile otimizado e removemos o toggle caso ainda exista
            try {
                const lowerTitle = (titulo || '').toLowerCase();
                const lowerMsg = (mensagem || '').toLowerCase();
                if (lowerTitle.includes('reaplicar') || lowerMsg.includes('recriptograf')) {
                    try { messageBox.classList.add('prompt-reaplicar'); } catch(_){}
                    // remover botão de visibilidade se presente
                    setTimeout(() => { try { const t = document.getElementById('toggleSenhaVis'); if (t) t.remove(); } catch(_){} }, 0);
                }
            } catch (_) {}
        overlay.style.setProperty('z-index','2147483650','important');
        messageBox.style.setProperty('z-index','2147483652','important');
        // shield and block pointer events briefly to avoid immediate clicks
        window.__modalClickShield = true;
        try { window.__lastModalOpenTime = Date.now(); } catch(_){}
        try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){} }, 420);
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        document.body.classList.add('modal-open');
        
        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_){}

        const input = document.getElementById('promptSenhaInput');
        const btnOk = document.getElementById('btnOkPrompt');
        const btnCancel = document.getElementById('btnCancelarPrompt');
        const btnToggle = document.getElementById('toggleSenhaVis');

        const close = (val) => { try { messageBox.classList.remove('prompt-reaplicar'); } catch(_){}; fecharMensagem(false, modalToken); try { overlay.removeEventListener('click', handleOverlayClick); } catch(_){}; overlay.addEventListener('click', handleOverlayClick); resolve(val); };
        btnOk.addEventListener('click', () => close(input.value), { once: true });
        btnCancel.addEventListener('click', () => close(null), { once: true });
        (function attachOverlayCloseOncePrompt() {
            const handler = function (e) {
                if (window.__modalClickShield) {
                    console.log('[MODAL-SHIELD] deferred one-time overlay close (prompt)');
                    overlay.removeEventListener('click', handler);
                    setTimeout(() => { try { overlay.addEventListener('click', handler, { once: true }); } catch(_){} }, 160);
                    return;
                }
                try { close(null); } catch (err) { console.warn('overlay close handler failed', err); }
                try { overlay.removeEventListener('click', handler); } catch(_){}
            };
            overlay.addEventListener('click', handler, { once: true });
        })();
        btnToggle.addEventListener('click', (e) => {
            e.preventDefault();
            input.type = input.type === 'password' ? 'text' : 'password';
        });

        setTimeout(() => { try { input.focus(); } catch(_){} }, 0);
    });
}

// Prompt genérico de texto (para nome de categoria, etc.)
function mostrarPromptTexto(titulo, mensagem, placeholder = 'Digite aqui', valorInicial = '') {
    return new Promise((resolve) => {
        overlay.removeEventListener('click', fecharMensagem);
        messageBox.innerHTML = `
            <h2>${titulo}</h2>
            <p>${mensagem}</p>
            <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;align-items:stretch;">
                <input id="promptTextoInput" type="text" placeholder="${placeholder}" value="${valorInicial.replace(/"/g,'&quot;')}" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.25);background: rgba(255,255,255,0.06);backdrop-filter: blur(8px) saturate(140%);color: inherit;" />
                <div style="display:flex;justify-content:center;gap:20px;margin-top:6px;">
                    <button id="btnCancelarPromptTexto">Cancelar</button>
                    <button id="btnOkPromptTexto" style="background-color: var(--primary-accent);">OK</button>
                </div>
            </div>
        `;
        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_){}
        overlay.style.setProperty('z-index','2147483650','important');
        messageBox.style.setProperty('z-index','2147483652','important');
        // shield and block pointer events briefly to avoid immediate clicks
        window.__modalClickShield = true;
        try { window.__lastModalOpenTime = Date.now(); } catch(_){}
        try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){} }, 180);
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        document.body.classList.add('modal-open');

        const input = document.getElementById('promptTextoInput');
        const btnOk = document.getElementById('btnOkPromptTexto');
        const btnCancel = document.getElementById('btnCancelarPromptTexto');

        const close = (val) => { fecharMensagem(false, modalToken); overlay.addEventListener('click', handleOverlayClick); resolve(val); };
        btnOk.addEventListener('click', () => close(input.value), { once: true });
        btnCancel.addEventListener('click', () => close(null), { once: true });
        (function attachOverlayCloseOncePromptText() {
            const handler = function (e) {
                if (window.__modalClickShield) {
                    console.log('[MODAL-SHIELD] deferred one-time overlay close (promptTexto)');
                    overlay.removeEventListener('click', handler);
                    setTimeout(() => { try { overlay.addEventListener('click', handler, { once: true }); } catch(_){} }, 160);
                    return;
                }
                try { close(null); } catch (err) { console.warn('overlay close handler failed', err); }
                try { overlay.removeEventListener('click', handler); } catch(_){}
            };
            overlay.addEventListener('click', handler, { once: true });
        })();
        setTimeout(() => { try { input.focus(); input.select(); } catch(_){} }, 0);
    });
}

// Prompt para certificado digital: permite selecionar arquivo ou colar conteúdo;
// extrai um token confidencial do conteúdo sem exibir o que foi encontrado.
function mostrarPromptCertificado(titulo = 'Certificado digital', mensagem = 'Digite a senha mestra ou valide o certificado digital.') {
    return new Promise((resolve) => {
        overlay.removeEventListener('click', fecharMensagem);
        messageBox.innerHTML = `
            <h2>${titulo}</h2>
            <p>${mensagem}</p>
            <div style="display:flex;flex-direction:column;gap:12px;margin-top:10px;align-items:stretch;">
                <div style="position:relative;display:flex;align-items:center;">
                    <input id="certMasterInput" type="password" placeholder="Digite a senha mestra" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.25);background: rgba(255,255,255,0.06);backdrop-filter: blur(8px) saturate(140%);color: inherit;" />
                </div>
                <div style="display:flex;align-items:center;gap:8px;opacity:0.8;justify-content:center;">
                    <span>ou</span>
                </div>
                <input id="certFileInput" type="file" accept=".pem,.crt,.cer,.txt" style="display:none;" />
                <button id="certFileBtn" class="cert-btn" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,0.28);background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.08));backdrop-filter: blur(10px) saturate(160%);color: var(--primary-accent);box-shadow: 0 10px 25px rgba(0,0,0,0.25), 0 4px 10px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.3);">
                    <span aria-hidden="true" style="display:inline-flex;"> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <circle cx="12" cy="14" r="3"/>
                            <path d="M12 11v6"/>
                        </svg>
                    </span>
                    <span>Validar certificado digital</span>
                </button>
                <div id="certProgress" style="display:none; margin-top:8px;">
                    <div class="progress-container"><div class="progress-bar" id="cert-progress-bar"></div></div>
                    <div class="status-message" id="cert-status-message" style="margin-top:6px; text-align:center; opacity:0.9;">Validando assinatura...</div>
                </div>
                <div style="display:flex;justify-content:center;gap:20px;margin-top:6px;">
                    <button id="btnCancelarCert">Cancelar</button>
                    <button id="btnOkCert" style="background-color: var(--primary-accent);">OK</button>
                </div>
            </div>
        `;
        overlay.style.setProperty('z-index','2147483650','important');
        messageBox.style.setProperty('z-index','2147483652','important');
        // modal token for certificado prompt
        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_){}
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        document.body.classList.add('modal-open');

    const inputFile = document.getElementById('certFileInput');
    const inputMaster = document.getElementById('certMasterInput');
    const fileBtn = document.getElementById('certFileBtn');
        const btnOk = document.getElementById('btnOkCert');
        const btnCancel = document.getElementById('btnCancelarCert');
        
        let tokenFromFile = null; // token extraído do arquivo

        const close = (val) => {
            try { if (inputMaster) inputMaster.value = ''; } catch(_){ }
            try { if (inputFile) inputFile.value = ''; } catch(_){ }
            fecharMensagem(false, modalToken); try { overlay.removeEventListener('click', handleOverlayClick); } catch(_){}; overlay.addEventListener('click', handleOverlayClick); resolve(val);
        };

        btnCancel.addEventListener('click', () => close(null), { once: true });
        (function attachOverlayCloseOnceCert() {
            const handler = function (e) {
                if (window.__modalClickShield) {
                    console.log('[MODAL-SHIELD] deferred one-time overlay close (cert)');
                    overlay.removeEventListener('click', handler);
                    setTimeout(() => { try { overlay.addEventListener('click', handler, { once: true }); } catch(_){} }, 160);
                    return;
                }
                try { close(null); } catch (err) { console.warn('overlay close handler failed', err); }
                try { overlay.removeEventListener('click', handler); } catch(_){}
            };
            overlay.addEventListener('click', handler, { once: true });
        })();
        btnOk.addEventListener('click', async () => {
            try {
                let token = null;
                if (tokenFromFile) {
                    token = tokenFromFile;
                } else if (inputMaster && inputMaster.value) {
                    const senha = inputMaster.value.trim();
                    if (verificarSenha(senha)) token = senha;
                }
                if (!token) {
                    mostrarMensagem('Atenção', 'Entrada inválida. Informe um certificado válido ou a senha mestra.');
                    return;
                }
                close(token);
            } catch (err) {
                console.error('Falha ao processar certificado:', err);
                mostrarMensagem('Erro', 'Não foi possível processar o certificado.');
            }
        }, { once: true });

        if (fileBtn && inputFile) {
            fileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                inputFile.click();
            });
            // Iniciar barra de progresso assim que o arquivo é escolhido
            inputFile.addEventListener('change', async () => {
                try {
                    tokenFromFile = null;
                    const file = inputFile.files && inputFile.files[0];
                    if (!file) return;
                    const progressWrap = document.getElementById('certProgress');
                    const progressBar = document.getElementById('cert-progress-bar');
                    const statusMsg = document.getElementById('cert-status-message');
                    if (progressWrap && progressBar && statusMsg) {
                        progressWrap.style.display = 'block';
                        // Desabilitar ações enquanto processa
                        btnOk.disabled = true; btnCancel.disabled = true; fileBtn.disabled = true; if (inputMaster) inputMaster.disabled = true;
                        let p = 0;
                        statusMsg.textContent = 'Validando assinatura...';
                        const timer = setInterval(() => {
                            p += Math.random() * 12;
                            if (p > 85) p = 85;
                            progressBar.style.width = `${p}%`;
                            if (p < 40) {
                                statusMsg.textContent = 'Validando assinatura...';
                            } else {
                                statusMsg.textContent = 'Verificando chave...';
                            }
                        }, 180);
                        try {
                            let conteudo = await file.text();
                            conteudo = (conteudo || '').toString();
                            tokenFromFile = extrairTokenCertificado(conteudo);
                            // Limpar conteúdo de memória
                            conteudo = '';
                        } finally {
                            clearInterval(timer);
                        }
                        if (tokenFromFile) {
                            statusMsg.textContent = 'Finalizando...';
                            progressBar.style.width = '100%';
                            await new Promise(r => setTimeout(r, 350));
                            statusMsg.textContent = 'Concluído';
                            await new Promise(r => setTimeout(r, 500));
                            progressWrap.style.display = 'none';
                            // Habilitar o OK para concluir
                            btnOk.disabled = false; btnCancel.disabled = false; fileBtn.disabled = false; if (inputMaster) inputMaster.disabled = false;
                        } else {
                            progressWrap.style.display = 'none';
                            btnOk.disabled = false; btnCancel.disabled = false; fileBtn.disabled = false; if (inputMaster) inputMaster.disabled = false;
                            mostrarMensagem('Erro de Certificado', 'Não foi possível validar o certificado. Tente outro arquivo ou digite a senha mestra.');
                        }
                    } else {
                        // Fallback sem UI de progresso
                        let conteudo = await file.text();
                        conteudo = (conteudo || '').toString();
                        tokenFromFile = extrairTokenCertificado(conteudo);
                        conteudo = '';
                    }
                } catch (err) {
                    console.error('Erro ao processar arquivo de certificado:', err);
                    mostrarMensagem('Erro', 'Falha ao ler o arquivo de certificado.');
                }
            });
        }
        

        setTimeout(() => { try { (inputMaster || inputFile)?.focus(); } catch(_){} }, 0);
    });
}

// Extrai um possível token confidencial do certificado sem revelar o conteúdo
function extrairTokenCertificado(texto) {
    if (!texto) return null;
    try {
        // Busca sequências compatíveis com base64 estendido (com + e /), tamanho mínimo 24
        const matches = texto.match(/[A-Za-z0-9+/=]{24,}/g) || [];
        if (!matches.length) return null;
        // Retorna o primeiro candidato que valide como senha mestra
        for (const m of matches) {
            if (verificarSenha(m)) return m;
        }
        return null;
    } catch {
        return null;
    }
}
function fecharMensagem(isConfirm = false, token) {
    console.log('[TRACE] fecharMensagem invoked - isConfirm:', isConfirm, 'token:', token);
    try { console.trace(); } catch(_){ }
    // Ignore accidental immediate closes right after opening a modal
    try {
        const last = window.__lastModalOpenTime || 0;
        // Use a slightly larger guard than the visual shield window to avoid
        // the gap where last-check allows closes but the pointer-shield is
        // still active. Keep conservative to reduce false-unlocks.
        if (!isConfirm && last && (Date.now() - last) < 480) {
            console.log('[MODAL-SHIELD] Ignoring fecharMensagem called too soon after open');
            return;
        }
    } catch (_) {}
    // Modal token stack: ensure only the owner modal can actually close/unlock
    var tokenPopped = false;
    try {
        window.__modalTokens = window.__modalTokens || [];
        const hadTokens = (window.__modalTokens && window.__modalTokens.length > 0);
        if (token) {
            const top = window.__modalTokens.length ? window.__modalTokens[window.__modalTokens.length - 1] : null;
            if (top !== token) {
                console.log('[MODAL-TOKEN] Ignoring fecharMensagem for non-top token', { top, token });
                return;
            }
            // pop token
            window.__modalTokens.pop();
            tokenPopped = true;
            // cleanup any dataset marker to avoid stale tokens on the DOM
            try { if (messageBox && messageBox.dataset && messageBox.dataset.modalToken === token) { try { delete messageBox.dataset.modalToken; } catch(_) { messageBox.removeAttribute('data-modal-token'); } } } catch(_) {}
        } else {
            // If no token provided and there are tokens, do not pop them — avoid accidental unlocks.
            if (hadTokens) {
                console.log('[MODAL-TOKEN] fecharMensagem called without token while tokens present — will hide UI but not pop tokens');
            }
        }
    } catch (_) {}
    if (overlay) {
        overlay.style.zIndex = '';
    }
    if (messageBox) {
        messageBox.style.zIndex = '';
        if (messageBox.classList.contains('improvements')) {
            messageBox.classList.remove('improvements');
        }
        // Remover destaque de marcador importante (se houver) para evitar estado residual
        try { messageBox.classList.remove('marcador-importante-ativo'); } catch(_) {}
        try { messageBox.style.removeProperty('--marcador-cor-importante'); } catch(_) {}
        messageBox.style.display = 'none';
        try { messageBox.classList.remove('fullscreen'); } catch(_) {}
    }

    if (modalObservacoes) {
        // Only hide and unlock if it was actually visible
        const wasVisible = modalObservacoes.style.display && modalObservacoes.style.display !== 'none';
        modalObservacoes.style.display = 'none';
        if (wasVisible) {
            if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
        }
    }
    if (modalDesenvolvimento) {
        const wasVisibleDev = modalDesenvolvimento.style.display && modalDesenvolvimento.style.display !== 'none';
        modalDesenvolvimento.style.display = 'none';
        modalDesenvolvimento.style.zIndex = '';
        if (wasVisibleDev) {
            if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
        }
    }

    const modalSenhaAberto = modalSenhaDiv && modalSenhaDiv.style.display === 'flex';
    const modalAnotacaoAberto = modalAnotacaoDiv && modalAnotacaoDiv.style.display === 'flex';

    if (!isConfirm && (!modalSenhaAberto && !modalAnotacaoAberto || tokenPopped)) {
        if (overlay) {
            overlay.style.display = 'none';
        }
        document.body.classList.remove('modal-open');
        // Only attempt to unlock if there are no outstanding modal tokens AND there are no application
        // modals open that expect the body to remain locked (e.g., modalSenha, modalAnotacao, modalMarcadores, modalDesenvolvimento, modalDevices).
        const tokensLeft = (window.__modalTokens && window.__modalTokens.length) ? window.__modalTokens.length : 0;
        const anyModalOpenNow = (modalSenhaDiv && modalSenhaDiv.style.display === 'flex') || (modalAnotacaoDiv && modalAnotacaoDiv.style.display === 'flex') || (modalMarcadores && modalMarcadores.style.display === 'flex') || (modalDesenvolvimento && modalDesenvolvimento.style.display === 'flex') || (modalDevices && modalDevices.style.display === 'flex');

        if (tokensLeft === 0 && !anyModalOpenNow) {
            // Instead of unlocking immediately, delay a short amount and re-check tokens and modal state.
            // This prevents an unlock triggered by a nearly-simultaneous event (same-click reentrancy) from restoring scroll prematurely
            // while an application modal might still be open.
            console.log('[MODAL-TOKEN] Scheduling unlock check (delayed) — tokenPopped:', tokenPopped);
            setTimeout(() => {
                try {
                    const leftNow = (window.__modalTokens && window.__modalTokens.length) ? window.__modalTokens.length : 0;
                    const anyModalOpenLater = (modalSenhaDiv && modalSenhaDiv.style.display === 'flex') || (modalAnotacaoDiv && modalAnotacaoDiv.style.display === 'flex') || (modalMarcadores && modalMarcadores.style.display === 'flex') || (modalDesenvolvimento && modalDesenvolvimento.style.display === 'flex') || (modalDevices && modalDevices.style.display === 'flex');
                    if (leftNow === 0 && !anyModalOpenLater) {
                        if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
                    } else {
                        console.log('[MODAL-TOKEN] Delayed unlock aborted, tokens remaining or modal open:', leftNow, anyModalOpenLater);
                    }
                } catch (e) { console.warn('[MODAL-TOKEN] Delayed unlock check failed', e); }
            }, 150);
        } else {
            console.log('[MODAL-TOKEN] Postpone unlock, tokens remaining or modal open:', tokensLeft, anyModalOpenNow, 'tokenPopped:', tokenPopped);
        }
    }

    if (isConfirm) {
        if (overlay) {
            overlay.style.display = 'none';
        }
        document.body.classList.remove('modal-open');
        if (modalSenhaAberto) fecharModalSenha();
        if (modalAnotacaoAberto) fecharModalAnotacao();
    }

    // Safety fallback: if after closing there are no visible modals/overlays
    // but body remains locked (possible token mismatch), force-unlock to
    // restore scrolling. This prevents the UI from becoming permanently
    // unscrollable in edge cases.
    setTimeout(() => {
        try {
            const overlayHidden = !overlay || overlay.style.display === 'none' || overlay.style.display === '';
            const anyModalVisible = (modalObservacoes && modalObservacoes.style.display && modalObservacoes.style.display !== 'none')
                || (modalDesenvolvimento && modalDesenvolvimento.style.display && modalDesenvolvimento.style.display !== 'none')
                || (modalSenhaDiv && modalSenhaDiv.style.display && modalSenhaDiv.style.display !== 'none')
                || (modalAnotacaoDiv && modalAnotacaoDiv.style.display && modalAnotacaoDiv.style.display !== 'none')
                || (messageBox && messageBox.style.display && messageBox.style.display !== 'none');
            if (overlayHidden && !anyModalVisible) {
                try {
                    while (window.__bodyLock && window.__bodyLock.count > 0) {
                        console.warn('[BODY-LOCK-FALLBACK] forcing unlock, remaining:', window.__bodyLock.count);
                        unlockBodyScroll();
                    }
                } catch (e) { console.warn('[BODY-LOCK-FALLBACK] unlock failed', e); }
                try { document.body.classList.remove('modal-open'); } catch(_){}
            }
        } catch (e) { console.warn('fecharMensagem fallback check failed', e); }
    }, 300);
}
</script>

<script>
// Handler para redefinir o tempo de atualização
async function handleRedefinirTempo(event) {
    try {
        console.log('handleRedefinirTempo invoked', { event });
        const btn = document.getElementById('btnRedefinirTempo');
        if (btn) {
            try {
                const rect = btn.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const elAtCenter = document.elementFromPoint(centerX, centerY);
                console.log('element at button center:', elAtCenter);
                console.log('overlay computed style:', {
                    display: getComputedStyle(overlay).display,
                    pointerEvents: getComputedStyle(overlay).pointerEvents,
                    zIndex: getComputedStyle(overlay).zIndex
                });
                if (elAtCenter && elAtCenter !== btn && !btn.contains(elAtCenter)) {
                    console.warn('POSSÍVEL BLOQUEIO: outro elemento está sobre o botão (pode ser overlay/modal).');
                }
            } catch (innerErr) {
                console.warn('Não foi possível determinar elemento sobre o botão:', innerErr);
            }
        } else {
            console.warn('btnRedefinirTempo não encontrado no DOM no momento do clique.');
        }

        const confirmado = await mostrarConfirmacao(
            'Redefinir tempo de Atualização',
            'Deseja redefinir o timer de atualização para 30 dias?'
        );
        if (confirmado) {
            localStorage.setItem('lastUpdateCheck', Date.now());
            // Atualiza o contador e esconde o diálogo de update
            checkUpdateTimer();
            setUpdateNoticeVisibility(false);
            mostrarMensagem('Sucesso', 'Tempo de atualização redefinido para 30 dias.');
        }
    } catch (err) {
        console.error('Erro em handleRedefinirTempo:', err);
    }
}
</script>

<script>
// Função reutilizável que executa a redefinição do timer (usada pelo popover e pelo modal)
function doRedefinirTempo() {
    try {
        localStorage.setItem('lastUpdateCheck', Date.now());
        checkUpdateTimer();
        setUpdateNoticeVisibility(false);
        mostrarMensagem('Sucesso', 'Tempo de atualização redefinido para 30 dias.');
    } catch (e) {
        console.error('Erro ao executar doRedefinirTempo:', e);
    } finally {
        hidePopoverRedefinir();
    }
}

function showPopoverRedefinir(button) {
    const pop = document.getElementById('popoverRedefinir');
    try { console.debug('[POPOVER] show called', { popExists: !!pop, parent: pop && pop.parentNode ? pop.parentNode.tagName : null, visible: pop ? pop.dataset.visible : null }); } catch(_){}
    if (!pop) { console.warn('[POPOVER] show aborted: pop element not found'); return; }

    // garantir que o popover esteja no final do body para ficar sobreposto a overlays/modais
    try { if (pop.parentNode !== document.body) document.body.appendChild(pop); } catch(_){ }

    pop.dataset.visible = 'true';
    pop.dataset._showStart = String(Date.now());
    // temporariamente ignorar cliques fora para evitar fechamento imediato por race conditions
    try { pop.dataset._ignoreOutside = '1'; setTimeout(() => { try { delete pop.dataset._ignoreOutside; } catch(_){} }, 400); } catch(_){ }
    pop.setAttribute('aria-hidden', 'false');
    pop.classList.remove('popover-hidden');
    pop.style.display = 'block';
    // remover classe de oculto e limpar clone debug se existir
    try { pop.classList.remove('popover-hidden'); } catch(_){ }
    try { const dbg = document.getElementById('popoverRedefinir_debug_clone'); if (dbg) dbg.remove(); } catch(_){ }
    // forçar display/visibilidade com alta prioridade
    try { pop.style.setProperty('display', 'block', 'important'); pop.style.setProperty('visibility', 'visible', 'important'); pop.style.setProperty('opacity', '1', 'important'); } catch(_){ }
    try { console.debug('[POPOVER] show continuing', { popParent: pop.parentNode && pop.parentNode.tagName, timestamp: pop.dataset._showStart }); } catch(_){}


    // Estratégia agressiva de stacking: aplicar z-index altíssimo ao popover e reduzir temporariamente overlay/message-box
    try {
        const HIGH_Z = '9999999999'; // claro alto para garantir visibilidade
        const overlayEl = document.getElementById('overlay');
        const msgBox = document.getElementById('message-box') || document.getElementById('modalObservacoes');

        // armazenar z-index originais e diminuir levemente z do overlay/message-box para garantir que pop fique acima
        try {
            if (overlayEl) {
                try { pop.dataset._overlayZOriginal = window.getComputedStyle(overlayEl).zIndex || ''; } catch(e) { pop.dataset._overlayZOriginal = ''; }
                overlayEl.style.setProperty('z-index', '2147483600', 'important');
                try { pop.dataset._overlayPointerOriginal = overlayEl.style.pointerEvents || ''; } catch(e){ pop.dataset._overlayPointerOriginal = ''; }
                try { overlayEl.style.setProperty('pointer-events', 'none', 'important'); } catch(e){}
            }
            if (msgBox) {
                try { pop.dataset._msgZOriginal = window.getComputedStyle(msgBox).zIndex || ''; } catch(e) { pop.dataset._msgZOriginal = ''; }
                msgBox.style.setProperty('z-index', '2147483600', 'important');
                try { pop.dataset._msgPointerOriginal = msgBox.style.pointerEvents || ''; } catch(e){ pop.dataset._msgPointerOriginal = ''; }
                try { msgBox.style.setProperty('pointer-events', 'none', 'important'); } catch(e){}
            }
        } catch (e) { console.warn('Erro ao ajustar overlay/message z-index e pointer-events', e); }

        // aplicar z-index muito alto no popover várias vezes para vencer concorrentes
        try { pop.style.setProperty('z-index', HIGH_Z, 'important'); } catch(_){}
        setTimeout(() => { try { pop.style.setProperty('z-index', HIGH_Z, 'important'); } catch(_){} }, 40);
        setTimeout(() => { try { pop.style.setProperty('z-index', HIGH_Z, 'important'); } catch(_){} }, 160);

        // garantir pointer events
        pop.style.pointerEvents = 'auto';

        console.debug('[POPOVER] applied HIGH_Z and lowered overlay/message z');
    } catch (e) { console.warn('Erro aplicando zIndex no popover', e); }

    try {
        const rect = button && button.getBoundingClientRect ? button.getBoundingClientRect() : null;
        const vw = window.innerWidth || document.documentElement.clientWidth;
        // se existir um overlay visível (modal), preferir centralizar o popover
        const overlayElForPos = document.getElementById('overlay');
        const overlayVisible = overlayElForPos && window.getComputedStyle(overlayElForPos).display !== 'none';
        // Position near button on wider screens and quando NÃO há overlay, center-on-modal
        if (rect && vw > 480 && !overlayVisible) {
            // place below the button, horizontally centered to the button
            pop.style.left = Math.max(12, Math.min(vw - (pop.offsetWidth || 300) - 12, Math.round(rect.left + rect.width / 2 - ((pop.offsetWidth || 300) / 2)))) + 'px';
            pop.style.top = (rect.bottom + 8) + 'px';
            pop.style.transform = 'translateY(0)';
        } else {
            pop.style.left = '50%';
            pop.style.top = '50%';
            pop.style.transform = 'translate(-50%,-50%)';
        }
    } catch (e) { console.warn('Erro ao posicionar popoverRedefinir', e); }

    // log do z-index atual após pequenos reflows (para debug)
    setTimeout(() => {
        try {
            console.debug('[POPOVER] computed z', { pop: window.getComputedStyle(pop).zIndex, overlay: (document.getElementById('overlay')? window.getComputedStyle(document.getElementById('overlay')).zIndex : null), msg: (document.getElementById('message-box') || document.getElementById('modalObservacoes')) ? window.getComputedStyle(document.getElementById('message-box') || document.getElementById('modalObservacoes')).zIndex : null });
        } catch(_){}
    }, 220);

    setTimeout(() => {
        try {
            const cs = window.getComputedStyle(pop);
            if (pop.offsetWidth === 0 || pop.offsetHeight === 0 || cs.display === 'none' || cs.visibility === 'hidden') {
                try { pop.style.setProperty('display', 'block', 'important'); } catch(_){}
                try { pop.style.setProperty('visibility', 'visible', 'important'); } catch(_){}
                try { pop.style.setProperty('opacity', '1', 'important'); } catch(_){}
                // centralizar
                try { pop.style.left = '50%'; pop.style.top = '50%'; pop.style.transform = 'translate(-50%,-50%)'; } catch(_){}
                try { pop.style.pointerEvents = 'auto'; } catch(_){}
                console.warn('[POPOVER] forced visible + centered (fallback)');
                try {
                    // tentar tornar visíveis descendentes que estejam com display:none ou tamanho zero
                    const modified = [];
                    try {
                        const all = pop.querySelectorAll('*');
                        for (const el of all) {
                            try {
                                const cs = window.getComputedStyle(el);
                                if (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0' || (el.offsetWidth === 0 && el.offsetHeight === 0 && el.children.length===0)) {
                                    el.style.setProperty('display', 'block', 'important');
                                    el.style.setProperty('visibility', 'visible', 'important');
                                    el.style.setProperty('opacity', '1', 'important');
                                    el.dataset._popvis = '1';
                                    modified.push(el);
                                }
                            } catch(_){}
                        }
                    } catch(_){}
                    if (modified.length) console.debug('[POPOVER] made', modified.length, 'descendants visible as fallback');
                } catch(_){}
            }
        } catch(_){}
    }, 260);

    // last-resort fallback: se ainda estiver com tamanho 0, criar um clone sanitizado do popover e mostrá-lo
    setTimeout(() => {
        try {
            if (pop.offsetWidth === 0 || pop.offsetHeight === 0 || pop.getBoundingClientRect().width === 0) {
                try {
                    const clone = createSanitizedPopoverClone(pop);
                    if (clone) {
                        pop.dataset._sanitCloneId = clone.id;
                        console.warn('[POPOVER] using sanitized clone fallback', clone.id);
                    }
                } catch(e) { console.warn('[POPOVER] sanitized clone failed', e); }
            }
        } catch(_){}
    }, 360);

    // iniciar o enforcer (safe) que aplica e reafirma z-index e posicionamento do popover
    try { startPopoverEnforcerSafe(pop); } catch (_) {}
}
// Export to global to ensure handlers in other scopes can call it
try { window.showPopoverRedefinir = showPopoverRedefinir; } catch(_){}


function hidePopoverRedefinir() {
    const pop = document.getElementById('popoverRedefinir');
    if (!pop) return;
    pop.dataset.visible = 'false';
    try { delete pop.dataset._ignoreOutside; } catch(_){}
    pop.setAttribute('aria-hidden', 'true');
    pop.classList.add('popover-hidden');
    pop.style.display = '';
    // restaurar overlay e message-box z-index se alterados
    try {
        const overlayEl = document.getElementById('overlay');
        const msgBox = document.getElementById('message-box') || document.getElementById('modalObservacoes');

        if (overlayEl) {
            if (pop.dataset._overlayZOriginal !== undefined) {
                const orig = pop.dataset._overlayZOriginal;
                if (orig !== '') overlayEl.style.setProperty('z-index', orig, 'important');
                else overlayEl.style.removeProperty('z-index');
                delete pop.dataset._overlayZOriginal;
            } else {
                // se não havia original armazenado, remover nossa alteração
                overlayEl.style.removeProperty('z-index');
            }
        }

        if (msgBox) {
            if (pop.dataset._msgZOriginal !== undefined) {
                const origm = pop.dataset._msgZOriginal;
                if (origm !== '') msgBox.style.setProperty('z-index', origm, 'important');
                else msgBox.style.removeProperty('z-index');
                delete pop.dataset._msgZOriginal;
            } else {
                msgBox.style.removeProperty('z-index');
            }
        }

        // restaurar pointer-events caso tenhamos alterado
        try {
            if (overlayEl) {
                if (pop.dataset._overlayPointerOriginal !== undefined) {
                    const origp = pop.dataset._overlayPointerOriginal;
                    if (origp !== '') overlayEl.style.setProperty('pointer-events', origp, 'important');
                    else overlayEl.style.removeProperty('pointer-events');
                    delete pop.dataset._overlayPointerOriginal;
                } else {
                    overlayEl.style.removeProperty('pointer-events');
                }
            }
            if (msgBox) {
                if (pop.dataset._msgPointerOriginal !== undefined) {
                    const origm = pop.dataset._msgPointerOriginal;
                    if (origm !== '') msgBox.style.setProperty('pointer-events', origm, 'important');
                    else msgBox.style.removeProperty('pointer-events');
                    delete pop.dataset._msgPointerOriginal;
                } else {
                    msgBox.style.removeProperty('pointer-events');
                }
            }
        } catch(e) { console.warn('[POPOVER] error restoring pointer-events on hide', e); }
        // restaurar display do overlay caso tenhamos ocultado como fallback
        try {
            if (pop && pop.dataset._overlayHiddenForPopover !== undefined) {
                const overlayEl = document.getElementById('overlay');
                if (overlayEl) {
                    const orig = overlayEl.dataset._hiddenForPopover !== undefined ? overlayEl.dataset._hiddenForPopover : '';
                    if (orig !== '') overlayEl.style.setProperty('display', orig, 'important');
                    else overlayEl.style.removeProperty('display');
                    try { delete overlayEl.dataset._hiddenForPopover; } catch(_){}
                }
                try { delete pop.dataset._overlayHiddenForPopover; } catch(_){}
                console.debug('[POPOVER] restored overlay display after fallback');
            }
            // Restaurar se usamos o novo fallback de overlay.dataset._fallbackDisplay
            try {
                // reverter alterações que fizemos nos descendentes (dataset _popvis)
                const popvisEls = pop ? pop.querySelectorAll('[data-_popvis]') : [];
                if (popvisEls && popvisEls.length) {
                    for (const el of popvisEls) {
                        try { el.style.removeProperty('display'); el.style.removeProperty('visibility'); el.style.removeProperty('opacity'); delete el.dataset._popvis; } catch(_){}
                    }
                    console.debug('[POPOVER] restored', popvisEls.length, 'descendants styles');
                }
            } catch(_){}
            // Restaurar se usamos o novo fallback de overlay.dataset._fallbackDisplay
            const _overlay = document.getElementById('overlay');
            if (_overlay && pop && pop.dataset._overlayFallbackHidden !== undefined) {
                try {
                    const orig2 = _overlay.dataset._fallbackDisplay !== undefined ? _overlay.dataset._fallbackDisplay : '';
                    if (orig2 !== '') _overlay.style.setProperty('display', orig2, 'important');
                    else _overlay.style.removeProperty('display');
                    try { delete _overlay.dataset._fallbackDisplay; } catch(_){}
                } catch(_){}
                try { delete pop.dataset._overlayFallbackHidden; } catch(_){}
                console.debug('[POPOVER] restored overlay display after fallback (new)');
            }
            // remover clone sanitizado se criado
            try { removeSanitizedPopoverClone(pop); } catch(_){}
        } catch(e) { console.warn('[POPOVER] failed restoring overlay display on hide', e); }
        console.debug('[POPOVER] restored overlay/message z-index on hide');
        try { stopPopoverEnforcer(pop); } catch (_) {}
    } catch (e) { console.warn('Erro restaurando overlay/message z-index', e); }
}
// Export hide to global scope
try { window.hidePopoverRedefinir = hidePopoverRedefinir; } catch(_){}


// Enforcer: garante que o popover fique visualmente à frente mesmo que outros scripts reajam ao overlay
function startPopoverEnforcer(pop) {
    if (!pop) return;
    // limpar se já houver
    stopPopoverEnforcer(pop);
    const overlayEl = document.getElementById('overlay');
    const msgBox = document.getElementById('message-box') || document.getElementById('modalObservacoes');

    function enforce() {
        try {
            // usar o valor máximo viável para o popover e um valor levemente menor para overlay/msg
            const POP_Z = '2147483647';
            const LOW_OVERLAY_Z = '2147483600';
            try { pop.style.setProperty('z-index', POP_Z, 'important'); } catch(_){}
            if (overlayEl) try { overlayEl.style.setProperty('z-index', LOW_OVERLAY_Z, 'important'); } catch(_){}
            if (msgBox) try { msgBox.style.setProperty('z-index', LOW_OVERLAY_Z, 'important'); } catch(_){}
        } catch (e) { console.warn('[POPOVER] enforce error', e); }
    }

    // primeira aplicação imediata
    enforce();

    // intervalo para reafirmar caso outro código sobrescreva o z-index
    const interval = setInterval(() => {
        enforce();
        try { console.debug('[POPOVER] enforce tick', { pop: window.getComputedStyle(pop).zIndex, overlay: overlayEl ? window.getComputedStyle(overlayEl).zIndex : null }); } catch(_){}
    }, 80);

    // observar alterações no overlay (atributos/styles) e também childList do body (reordenaçoes)
    const obs = new MutationObserver(() => { enforce(); });
    if (overlayEl) obs.observe(overlayEl, { attributes: true, attributeFilter: ['style', 'class'] });
    const bodyObs = new MutationObserver(() => { enforce(); });
    bodyObs.observe(document.body, { childList: true });

    window.__popoverEnforcers = window.__popoverEnforcers || {};
    // watchdog: stop enforcer after 10s to avoid locking acidentalmente a UI
    const watchdog = setTimeout(() => {
        try { console.warn('[POPOVER] watchdog triggered — stopping enforcer to avoid freeze'); stopPopoverEnforcer(pop); } catch(_){}
    }, 10000);
    window.__popoverEnforcers['popoverRedefinir'] = { interval, obs, bodyObs, watchdog };
    try { if (overlayEl) overlayEl.style.setProperty('pointer-events', 'none', 'important'); } catch(_){}
    try { if (msgBox) msgBox.style.setProperty('pointer-events', 'none', 'important'); } catch(_){}
    console.debug('[POPOVER] enforcer started');
}

function stopPopoverEnforcer(pop) {
    // always attempt to stop the safe enforcer first (it may be the only one running)
    try { if (typeof stopPopoverEnforcerSafe === 'function') stopPopoverEnforcerSafe(pop); } catch(_){ }
    if (!window.__popoverEnforcers) return;
    const rec = window.__popoverEnforcers['popoverRedefinir'];
    if (!rec) return;
    try { clearInterval(rec.interval); } catch(_){}
    try { rec.obs.disconnect(); } catch(_){}
    try { rec.bodyObs.disconnect(); } catch(_){}
    delete window.__popoverEnforcers['popoverRedefinir'];
    try { if (rec && rec.watchdog) clearTimeout(rec.watchdog); } catch(_){}
    // tentar restaurar pointer-events caso tenham sido alterados
    try {
        const p = document.getElementById('popoverRedefinir');
        const overlayEl = document.getElementById('overlay');
        const msgBox = document.getElementById('message-box') || document.getElementById('modalObservacoes');
        if (p && overlayEl) {
            try { if (p.dataset._overlayPointerOriginal !== undefined) { const orig = p.dataset._overlayPointerOriginal; if (orig !== '') overlayEl.style.setProperty('pointer-events', orig, 'important'); else overlayEl.style.removeProperty('pointer-events'); delete p.dataset._overlayPointerOriginal; } else { overlayEl.style.removeProperty('pointer-events'); } } catch(_){}
        }
        if (p && msgBox) {
            try { if (p.dataset._msgPointerOriginal !== undefined) { const origm = p.dataset._msgPointerOriginal; if (origm !== '') msgBox.style.setProperty('pointer-events', origm, 'important'); else msgBox.style.removeProperty('pointer-events'); delete p.dataset._msgPointerOriginal; } else { msgBox.style.removeProperty('pointer-events'); } } catch(_){}
        }
    } catch (e) { console.warn('[POPOVER] error restoring pointer-events on stop', e); }
    console.debug('[POPOVER] enforcer stopped');
    try { if (typeof stopPopoverEnforcerSafe === 'function') stopPopoverEnforcerSafe(pop); } catch(_){}
}

// Safe enforcer: menos agressivo, debounced e com rAF para evitar timeouts
function startPopoverEnforcerSafe(pop) {
    if (!pop) return;
    // stop existing safe enforcer
    try { if (typeof stopPopoverEnforcerSafe === 'function') stopPopoverEnforcerSafe(pop); } catch(_){}

    const overlayEl = document.getElementById('overlay');
    const msgBox = document.getElementById('message-box') || document.getElementById('modalObservacoes');

    // initial light application
    try {
        const POP_Z = '2147483647';
        const LOW_Z = '2147483600';
        try { if (window.getComputedStyle(pop).zIndex !== POP_Z) pop.style.setProperty('z-index', POP_Z, 'important'); } catch(_){}
        if (overlayEl) { try { if (window.getComputedStyle(overlayEl).zIndex !== LOW_Z) overlayEl.style.setProperty('z-index', LOW_Z, 'important'); } catch(_){} try { overlayEl.style.setProperty('pointer-events','none','important'); } catch(_){} }
        if (msgBox) { try { if (window.getComputedStyle(msgBox).zIndex !== LOW_Z) msgBox.style.setProperty('z-index', LOW_Z, 'important'); } catch(_){} try { msgBox.style.setProperty('pointer-events','none','important'); } catch(_){} }

        // Fallback muito direto: ocultar overlay temporariamente para garantir que o popover fique à frente
        try {
            if (overlayEl && overlayEl.style.display !== 'none') {
                try { overlayEl.dataset._fallbackDisplay = overlayEl.style.display || ''; } catch(_){}
                try { overlayEl.style.setProperty('display', 'none', 'important'); } catch(e){ }
                try { pop.dataset._overlayFallbackHidden = '1'; } catch(_){}
                console.warn('[POPOVER] overlay hidden (fallback)');
            }
        } catch(e) { /* non-critical */ }
    } catch(e){ console.warn('[POPOVER_SAFE] initial apply failed', e); }
    // Se detectarmos que overlay e pop têm o mesmo z-index, ocultar o overlay temporariamente como fallback
    try {
        const csOverlay = overlayEl ? window.getComputedStyle(overlayEl).zIndex : null;
        const csPop = window.getComputedStyle(pop).zIndex;
        if (overlayEl && csOverlay && csPop && csOverlay === csPop) {
            try { overlayEl.dataset._hiddenForPopover = overlayEl.style.display || ''; } catch(_){}
            try { overlayEl.style.setProperty('display', 'none', 'important'); } catch(_){}
            try { pop.dataset._overlayHiddenForPopover = '1'; } catch(_){}
            console.warn('[POPOVER_SAFE] overlay hidden due to z-index conflict');
        }
    } catch(e) { /* non-critical */ }

    function safeEnforce() {
        try {
            if (!pop || pop.dataset.visible !== 'true') return;
            requestAnimationFrame(() => {
                try {
                    const POP_Z = '2147483647';
                    const LOW_Z = '2147483600';
                    try { if (window.getComputedStyle(pop).zIndex !== POP_Z) pop.style.setProperty('z-index', POP_Z, 'important'); } catch(_){}
                    if (overlayEl) { try { if (window.getComputedStyle(overlayEl).zIndex !== LOW_Z) overlayEl.style.setProperty('z-index', LOW_Z, 'important'); } catch(_){} try { if (overlayEl.style.pointerEvents !== 'none') overlayEl.style.setProperty('pointer-events','none','important'); } catch(_){} }
                    if (msgBox) { try { if (window.getComputedStyle(msgBox).zIndex !== LOW_Z) msgBox.style.setProperty('z-index', LOW_Z, 'important'); } catch(_){} try { if (msgBox.style.pointerEvents !== 'none') msgBox.style.setProperty('pointer-events','none','important'); } catch(_){} }
                } catch(e) { console.warn('[POPOVER_SAFE] enforce error', e); }
            });
        } catch(e) { console.warn('[POPOVER_SAFE] safeEnforce outer', e); }
    }

    const interval = setInterval(() => { try { safeEnforce(); console.debug('[POPOVER_SAFE] tick', { pop: window.getComputedStyle(pop).zIndex, overlay: overlayEl ? window.getComputedStyle(overlayEl).zIndex : null }); } catch(_){} }, 300);

    let pending = null;
    const obs = new MutationObserver(() => { try { if (pending) clearTimeout(pending); pending = setTimeout(() => { try { safeEnforce(); pending = null; } catch(_){} }, 120); } catch(e){ console.warn('[POPOVER_SAFE] obs cb', e); } });
    if (overlayEl) obs.observe(overlayEl, { attributes: true, attributeFilter: ['style','class'] });
    const bodyObs = new MutationObserver(() => { try { if (pending) clearTimeout(pending); pending = setTimeout(() => { try { safeEnforce(); pending = null; } catch(_){} }, 200); } catch(e){ console.warn('[POPOVER_SAFE] body obs cb', e); } });
    bodyObs.observe(document.body, { childList: true });

    const watchdog = setTimeout(() => { console.warn('[POPOVER_SAFE] watchdog triggered'); try { stopPopoverEnforcerSafe(pop); } catch(_){} }, 10000);

    window.__popoverEnforcers = window.__popoverEnforcers || {};
    window.__popoverEnforcers['popoverRedefinir_safe'] = { interval, obs, bodyObs, watchdog, pending };
    console.debug('[POPOVER_SAFE] enforcer started');
}

function stopPopoverEnforcerSafe(pop) {
    if (!window.__popoverEnforcers) return;
    const rec = window.__popoverEnforcers['popoverRedefinir_safe'];
    if (!rec) return;
    try { clearInterval(rec.interval); } catch(_){}
    try { rec.obs.disconnect(); } catch(_){}
    try { rec.bodyObs.disconnect(); } catch(_){}
    try { clearTimeout(rec.watchdog); } catch(_){}
    try { if (rec.pending) clearTimeout(rec.pending); } catch(_){}
    delete window.__popoverEnforcers['popoverRedefinir_safe'];
    // tentar restaurar pointer-events caso tenhamos alterado
    try {
        const p = pop || document.getElementById('popoverRedefinir');
        const overlayEl = document.getElementById('overlay');
        const msgBox = document.getElementById('message-box') || document.getElementById('modalObservacoes');
        if (p) {
            if (overlayEl) {
                try { if (p.dataset._overlayPointerOriginal !== undefined) { const orig = p.dataset._overlayPointerOriginal; if (orig !== '') overlayEl.style.setProperty('pointer-events', orig, 'important'); else overlayEl.style.removeProperty('pointer-events'); delete p.dataset._overlayPointerOriginal; } else { overlayEl.style.removeProperty('pointer-events'); } } catch(_){}
            }
            if (msgBox) {
                try { if (p.dataset._msgPointerOriginal !== undefined) { const origm = p.dataset._msgPointerOriginal; if (origm !== '') msgBox.style.setProperty('pointer-events', origm, 'important'); else msgBox.style.removeProperty('pointer-events'); delete p.dataset._msgPointerOriginal; } else { msgBox.style.removeProperty('pointer-events'); } } catch(_){}
            }
        }
    } catch(e) { console.warn('[POPOVER_SAFE] stop error', e); }
    // restaurar display do overlay se nós o ocultamos como fallback
    try {
        const p = pop || document.getElementById('popoverRedefinir');
        const overlayEl = document.getElementById('overlay');
        if (p && overlayEl && p.dataset._overlayHiddenForPopover !== undefined) {
            try {
                const orig = overlayEl.dataset._hiddenForPopover !== undefined ? overlayEl.dataset._hiddenForPopover : '';
                if (orig !== '') overlayEl.style.setProperty('display', orig, 'important');
                else overlayEl.style.removeProperty('display');
            } catch(_){}
            try { delete overlayEl.dataset._hiddenForPopover; } catch(_){}
            try { delete p.dataset._overlayHiddenForPopover; } catch(_){}
            console.debug('[POPOVER_SAFE] restored overlay display after fallback');
        }
    } catch(e) { console.warn('[POPOVER_SAFE] restore display failed', e); }

    console.debug('[POPOVER_SAFE] enforcer stopped');

// Criar um clone sanitizado do popover (remove classes que escondem e força visibilidade)
function createSanitizedPopoverClone(origPop) {
    if (!origPop) return null;
    try {
        // remover clone pré-existente
        const existing = document.getElementById('popoverRedefinir_sanitized');
        if (existing) try { existing.remove(); } catch(_){}

        const clone = origPop.cloneNode(true);
        clone.id = 'popoverRedefinir_sanitized';
        // limpar classes/atributos que possam esconder
        try { clone.classList.remove('popover-hidden'); } catch(_){}
        try { clone.removeAttribute('data-hidden'); } catch(_){}
        // remover quaisquer nós script ou handlers inline (simplesmente não executar scripts)
        clone.querySelectorAll('script').forEach(s => s.remove());
        // garantir estilos de posicionamento e visibilidade
        clone.style.setProperty('position', 'fixed', 'important');
        clone.style.setProperty('left', '50%', 'important');
        clone.style.setProperty('top', '50%', 'important');
        clone.style.setProperty('transform', 'translate(-50%,-50%)', 'important');
        clone.style.setProperty('display', 'block', 'important');
        clone.style.setProperty('visibility', 'visible', 'important');
        clone.style.setProperty('opacity', '1', 'important');
        clone.style.setProperty('z-index', '2147483647', 'important');
        // tornar visíveis todos os descendentes
        try {
            const elems = clone.querySelectorAll('*');
            for (const el of elems) {
                try { el.style.setProperty('display', 'block', 'important'); el.style.setProperty('visibility', 'visible', 'important'); el.style.setProperty('opacity', '1', 'important'); } catch(_){}
            }
        } catch(_){}
        document.body.appendChild(clone);
        return clone;
    } catch (e) {
        console.warn('[POPOVER] createSanitizedPopoverClone error', e);
        return null;
    }
}

function removeSanitizedPopoverClone(origPop) {
    try {
        const id = origPop && origPop.dataset && origPop.dataset._sanitCloneId;
        if (!id) return;
        const clone = document.getElementById(id);
        if (clone) clone.remove();
        delete origPop.dataset._sanitCloneId;
    } catch (e) { console.warn('[POPOVER] removeSanitizedPopoverClone error', e); }
}
}

// Mostrar modal para escolher data de início do período de 30 dias
function mostrarSeletorDataInicio() {
    return new Promise((resolve) => {
        console.debug('[MODAL] mostrarSeletorDataInicio called');
        try {
            overlay.removeEventListener('click', fecharMensagem);
        } catch (_) {}
        const hojeISO = new Date().toISOString().slice(0,10);
        messageBox.innerHTML = `
            <h2>Escolher data de início</h2>
            <p>Selecione a data de início para o cronograma de 30 dias.</p>
            <div style="display:flex;flex-direction:column;gap:10px;margin-top:8px;">
                <input id="startDateInput" type="date" value="${hojeISO}" style="padding:8px;border-radius:8px;border:1px solid var(--border-color);background:var(--input-bg);color:inherit;" />
                <div class="modalButtons" style="display:flex;justify-content:center;align-items:center;gap:12px;margin-top:10px;flex-wrap:nowrap;">
                    <button id="btnCancelarDataInicio" style="min-width:110px;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:transparent;display:inline-flex;align-items:center;justify-content:center;width:auto;margin:0 !important;">Cancelar</button>
                    <button id="btnConfirmarDataInicio" class="btn-primary" style="min-width:110px;padding:10px 12px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;width:auto;margin:0 !important;">Confirmar</button>
                </div>
            </div>
        `;
        overlay.style.setProperty('z-index','2147483650','important');
        messageBox.style.setProperty('z-index','2147483652','important');
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        document.body.classList.add('modal-open');

        console.debug('[MODAL] overlay/messageBox display set to block');

        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_) {}

        const cancelar = document.getElementById('btnCancelarDataInicio');
        const confirmar = document.getElementById('btnConfirmarDataInicio');

        if (cancelar) cancelar.addEventListener('click', (e) => {
            e && e.preventDefault && e.preventDefault();
            e && e.stopPropagation && e.stopPropagation();
            try {
                const input = document.getElementById('startDateInput');
                if (input) {
                    try { input.blur(); } catch(_){}
                    // Force close on stubborn native pickers by toggling type briefly
                    try {
                        const prev = input.type;
                        input.type = 'text';
                        setTimeout(() => { try { input.type = prev; } catch(_){} }, 30);
                    } catch(_){}
                    // Also briefly disable then re-enable to interrupt any picker
                    try { input.disabled = true; setTimeout(() => { try { input.disabled = false; } catch(_){} }, 40); } catch(_){}
                }
                // Extra fallback: blur active element to ensure native pickers close
                try { if (document.activeElement && document.activeElement !== document.body) (document.activeElement).blur(); } catch(_) {}
            } catch(_) {}
            // Pass the modal token so fecharMensagem can properly pop it from the stack
            try { fecharMensagem(false, modalToken); } catch(_) { fecharMensagem(false); }
            resolve(null);
        }, { once: true });
        if (confirmar) confirmar.addEventListener('click', (e) => { e && e.preventDefault && e.preventDefault(); e && e.stopPropagation && e.stopPropagation();
            const input = document.getElementById('startDateInput');
            let val = input && input.value ? input.value : null;
            if (!val) { mostrarMensagem('Atenção', 'Selecione uma data válida.'); resolve(null); return; }
            // Normalize to midnight of chosen date
            const parts = val.split('-').map(p => parseInt(p,10));
            let chosen = new Date(parts[0], parts[1]-1, parts[2], 0,0,0,0);
            // If chosen date is in the future (after now), interpret as previous month
            const now = new Date();
            if (chosen.getTime() > now.getTime()) {
                // move one month back
                chosen = new Date(parts[0], parts[1]-2, parts[2], 0,0,0,0);
            }
            // Try to ensure datepicker is closed (in some browsers it persists after confirm)
            try {
                if (input) {
                    try { input.blur(); } catch(_){}
                    try {
                        const prev = input.type;
                        input.type = 'text';
                        setTimeout(() => { try { input.type = prev; } catch(_){} }, 30);
                    } catch(_){}
                }
                try { if (document.activeElement && document.activeElement !== document.body) (document.activeElement).blur(); } catch(_) {}
            } catch(_) {}
            // Ensure we pop the modal token too
            try { fecharMensagem(false, modalToken); } catch(_) { fecharMensagem(false); }
            resolve(chosen.getTime());
        }, { once: true });

        // small safeguard: if the modal DOM did not appear visibly, warn and allow fallback
        setTimeout(() => {
            try {
                const csOverlay = window.getComputedStyle(overlay);
                const csMsg = window.getComputedStyle(messageBox);
                console.debug('[MODAL] post-init styles', { overlay: { display: csOverlay.display, opacity: csOverlay.opacity }, msg: { display: csMsg.display, opacity: csMsg.opacity } });
                if (csOverlay.display === 'none' || csMsg.display === 'none') {
                    console.warn('[MODAL] modal elements still hidden after init');
                }
            } catch(_){}
        }, 120);
    });
}

// Delegação de clicks para os botões do popover
document.addEventListener('click', async function (e) {
    if (e.target && e.target.id === 'popoverConfirmRedefinir') {
        e.stopPropagation();
        hidePopoverRedefinir();
        try {
            const chosenTs = await mostrarSeletorDataInicio();
            if (!chosenTs) return; // cancelado
            // definir lastUpdateCheck para a data escolhida
            localStorage.setItem('lastUpdateCheck', chosenTs);
            checkUpdateTimer();
            setUpdateNoticeVisibility(false);
            mostrarMensagem('Sucesso', 'Tempo de atualização redefinido com base na data selecionada.');
        } catch (err) {
            console.error('Erro ao redefinir com data escolhida:', err);
            mostrarMensagem('Erro', 'Não foi possível redefinir o tempo de atualização.');
        }
    } else if (e.target && e.target.id === 'popoverCancelRedefinir') {
        e.stopPropagation();
        hidePopoverRedefinir();
    } else {
        // Se clicar fora do popover e do botão, fecha o popover
        const pop = document.getElementById('popoverRedefinir');
        const btn = document.getElementById('btnRedefinirTempo');
        if (pop && pop.dataset.visible === 'true') {
            // se estivermos no período inicial de abertura, ignorar o clique fora
            if (pop.dataset._ignoreOutside === '1') {
                console.debug('[POPOVER] ignoring outside click due to recent open');
            } else if (!pop.contains(e.target) && !(btn && btn.contains(e.target))) {
                hidePopoverRedefinir();
            }
        }
    }
});
</script>

<script>
// Fallback handlers para os botões do popover (garante funcionamento em alguns dispositivos móveis)
document.addEventListener('DOMContentLoaded', () => {
    try {
        const popConfirm = document.getElementById('popoverConfirmRedefinir');
        const popCancel = document.getElementById('popoverCancelRedefinir');
        if (popConfirm) popConfirm.addEventListener('click', async (e) => {
            e.stopPropagation();
            hidePopoverRedefinir();
            try {
                const chosenTs = await mostrarSeletorDataInicio();
                if (!chosenTs) return;
                localStorage.setItem('lastUpdateCheck', chosenTs);
                checkUpdateTimer();
                setUpdateNoticeVisibility(false);
                mostrarMensagem('Sucesso', 'Tempo de atualização redefinido com base na data selecionada.');
            } catch (err) {
                console.error('Erro ao redefinir com data (fallback):', err);
                mostrarMensagem('Erro', 'Não foi possível redefinir o tempo de atualização.');
            }
        });
        if (popCancel) popCancel.addEventListener('click', (e) => { e.stopPropagation(); hidePopoverRedefinir(); });
    } catch (e) { console.warn('Popover fallback handlers attach failed', e); }

    // Delegated fallback: garantir que o botão '#btnRedefinirTempo' funcione mesmo em ambientes onde o listener original não foi anexado
    try {
        document.addEventListener('click', function (e) {
            try {
                const clicked = e.target.closest && e.target.closest('#btnRedefinirTempo');
                if (!clicked) return;
                e.stopPropagation();
                // Toggle popover
                const pop = document.getElementById('popoverRedefinir');
                if (!pop) return;
                // abrir seletor de data diretamente
                try { openDateSelectorFromBtn(clicked); } catch (err) { console.warn('Delegated openDateSelectorFromBtn failed', err); }
            } catch (err) {
                console.warn('Delegated btnRedefinirTempo handler error', err);
            }
        });
        // Attach pointerup/click directly to the button as well (one-time attach guard)
        try {
            const btnRT = document.getElementById('btnRedefinirTempo');
            if (btnRT && !btnRT.dataset.redefAttached) {
                const handler = (e) => {
                    try {
                        e.preventDefault(); e.stopPropagation();
                        const pop = document.getElementById('popoverRedefinir');
                        if (!pop) return;
                        // abrir seletor de data diretamente (fallback funcional)
                        try { openDateSelectorFromBtn(btnRT); } catch (err) { console.warn('Direct openDateSelectorFromBtn failed', err); }
                    } catch (err) { console.warn('btnRedefinirTempo handler error', err); }
                };
                btnRT.addEventListener('click', handler, { passive: false });
                btnRT.addEventListener('pointerup', handler, { passive: false });
                btnRT.dataset.redefAttached = '1';
            }
        } catch (err) { console.warn('Direct attach to btnRedefinirTempo failed', err); }
    } catch (err) { console.warn('Delegated click attach failed', err); }
});
</script>

<script>
(function(){
    // handler attach idempotente e chamado imediatamente

    // Função utilitária: abrir seletor de data e aplicar escolha (fallback funcional quando popover falha)
    async function openDateSelectorFromBtn(btn) {
        console.debug('[FALLBACK] openDateSelectorFromBtn called');
        try {
            // garantir que qualquer modal/overlay ativo seja fechado antes de abrir o seletor
            try {
                if (typeof fecharMensagem === 'function') {
                    // Ensure all outstanding modal tokens are popped before opening the selector.
                    // Some modals may not set messageBox.dataset.modalToken (different modal elements),
                    // so remove tokens from the global stack until empty to avoid leftover tokens.
                    try {
                        while (window.__modalTokens && window.__modalTokens.length) {
                            const tok = window.__modalTokens[window.__modalTokens.length - 1];
                            try { fecharMensagem(false, tok); }
                            catch (_) {
                                // Fallback: try calling without token (hides UI but may not pop), then continue
                                try { fecharMensagem(false); } catch(_){}
                            }
                        }
                    } catch (inner) { console.warn('[FALLBACK] pop-all-modal-tokens failed', inner); }
                    await new Promise((r) => setTimeout(r, 120));
                    console.debug('[FALLBACK] closed existing modal(s) before opening selector');
                }
            } catch (e) { console.warn('[FALLBACK] failed to close existing modal', e); }

            // abrir modal/selector
            const chosenTs = await mostrarSeletorDataInicio();
            console.debug('[FALLBACK] mostrarSeletorDataInicio resolved', { chosen: !!chosenTs });
            if (!chosenTs) {
                // fallback: pedir data via prompt
                try {
                    const p = prompt('Digite a data de início (YYYY-MM-DD):', new Date().toISOString().slice(0,10));
                    if (!p) { console.debug('[FALLBACK] prompt cancelled'); return; }
                    // validar formato simples
                    const m = p.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                    if (!m) { mostrarMensagem('Atenção', 'Formato inválido. Use YYYY-MM-DD.'); return; }
                    const chosen = new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10),0,0,0,0);
                    if (chosen.getTime() > Date.now()) chosen.setMonth(chosen.getMonth()-1);
                    localStorage.setItem('lastUpdateCheck', chosen.getTime());
                    try { checkUpdateTimer(); } catch(_){}
                    try { setUpdateNoticeVisibility(false); } catch(_){}
                    try { mostrarMensagem('Sucesso', 'Tempo de atualização redefinido com base na data informada.'); } catch(_){}
                    return;
                } catch (e) { console.warn('[FALLBACK] prompt fallback failed', e); return; }
            }
            localStorage.setItem('lastUpdateCheck', chosenTs);
            try { checkUpdateTimer(); } catch(_){}
            try { setUpdateNoticeVisibility(false); } catch(_){}
            try { mostrarMensagem('Sucesso', 'Tempo de atualização redefinido com base na data selecionada.'); } catch(_){}
        } catch (err) {
            console.error('Erro ao redefinir com data via selector:', err);
            try { mostrarMensagem('Erro', 'Não foi possível redefinir o tempo de atualização.'); } catch(_){}
        }
    }
    function attachBtnRedefinirHandler() {
        try {
            const btn = document.getElementById('btnRedefinirTempo');
            if (!btn || btn.dataset.redefHandlerAttached) return;
            const handler = (e) => {
                try {
                    console.debug('[TIME] btnRedefinir clicked', { target: e.target && e.target.id });
                    try { console.debug('[TIME] handler about to toggle popover', { popVisible: (document.getElementById('popoverRedefinir') || {}).dataset && (document.getElementById('popoverRedefinir') || {}).dataset.visible }); } catch (_){}
                    e.preventDefault(); e.stopPropagation();
                    // toggle: se já visível, hide, senão show
                    const pop = document.getElementById('popoverRedefinir');
                    // abrir o seletor de data diretamente como fallback funcional
                    try { console.debug('[TIME] handler calling openDateSelectorFromBtn'); openDateSelectorFromBtn(btn); } catch (err) { console.warn('openDateSelectorFromBtn error', err); }
                } catch (err) { console.warn('btnRedefinir handler error', err); }
            };
            try { btn.addEventListener('click', handler, { passive: false, capture: true }); } catch(e){ btn.addEventListener('click', handler); }
            try { btn.addEventListener('pointerup', handler, { passive: false, capture: true }); } catch(e){}
            try { btn.addEventListener('touchend', handler, { passive: false, capture: true }); } catch(e){}
            btn.dataset.redefHandlerAttached = '1';
            console.debug('[TIME] attachBtnRedefinirHandler: attached');
        } catch (e) { console.warn('attachBtnRedefinirHandler error', e); }
    }

    // call now (handles case where DOMContentLoaded already fired)
    try { attachBtnRedefinirHandler(); } catch(_){}
    // also try on DOMContentLoaded as fallback
    try { document.addEventListener('DOMContentLoaded', attachBtnRedefinirHandler); } catch(_){}

    // Observar mudanças no modalObservacoes para reaplicar o handler caso o conteúdo seja re-renderizado
    try {
        const mob = document.getElementById('modalObservacoes');
        if (mob) {
            const mo = new MutationObserver((mut) => { attachBtnRedefinirHandler(); });
            mo.observe(mob, { attributes: true, attributeFilter: ['style','class','data-open'] });
        }
    } catch (e) { console.warn('observer attach failed', e); }
})();

if (window.innerWidth <= 768) {
document.body.style.height = window.innerHeight + 'px';
}
</script>

<script>

const savedItemsManager = {
    init() {
        this.modal = document.getElementById('modalSavedItems');
        this.form = document.getElementById('formSavedItem');
        this.list = document.getElementById('savedItemsList');
        this.container = document.querySelector('.saved-items-container');
        this.setupEventListeners();
        this.loadSavedItems();
    },

    setupEventListeners() {
        
        const manageSavedItemsBtn = document.getElementById('btn-manage-saved-items');
        if (manageSavedItemsBtn) {
            manageSavedItemsBtn.addEventListener('click', () => {
                this.openModal();
            });
        }

        
        const closeBtn = document.querySelector('.close-saved-items');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.closeModal();
            });
        }

        
        const viewBtn = document.querySelector('.view-saved-btn');
        if (viewBtn) {
            viewBtn.addEventListener('click', () => {
                this.toggleView('list');
            });
        }

        
        const backBtn = document.querySelector('.back-to-form-btn');
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                this.toggleView('form');
            });
        }

        
        if (this.form) {
            this.form.addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveItem();
            });
        }

        
        if (this.form) {
            const inputs = this.form.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    this.suggestAutoComplete(input);
                });
            });
        }
    },

    openModal() {
        this.modal.style.display = 'block';
        this.toggleView('form');
    },

    closeModal() {
        this.modal.style.display = 'none';
        this.form.reset();
    },

    toggleView(view) {
        if (view === 'list') {
            this.form.style.display = 'none';
            this.list.style.display = 'block';
            this.loadSavedItems(); 
        } else {
            this.form.style.display = 'block';
            this.list.style.display = 'none';
        }
    },

    saveItem() {
        const item = {
            id: Date.now(),
            titulo: document.getElementById('saved-item-titulo').value,
            usuario: document.getElementById('saved-item-usuario').value,
            email: document.getElementById('saved-item-email').value,
            telefone: document.getElementById('saved-item-telefone').value,
            links: document.getElementById('saved-item-links').value,
            cpf: document.getElementById('saved-item-cpf').value,
            notas: document.getElementById('saved-item-notas').value,
            timestamp: new Date().toISOString()
        };

        let savedItems = this.getSavedItems();
        savedItems.push(item);
        localStorage.setItem('savedItems', JSON.stringify(savedItems));

        this.form.reset();
        this.showNotification('Item salvo com sucesso!');
    },

    getSavedItems() {
        const items = localStorage.getItem('savedItems');
        return items ? JSON.parse(items) : [];
    },

    loadSavedItems() {
        const items = this.getSavedItems();
        this.container.innerHTML = '';

        items.forEach(item => {
            const itemElement = this.createItemElement(item);
            this.container.appendChild(itemElement);
        });
    },

    createItemElement(item) {
        const div = document.createElement('div');
        div.className = 'saved-item';
        div.innerHTML = `
            <div class="saved-item-info">
                <div class="saved-item-title">${item.titulo}</div>
                <div class="saved-item-details">
                    ${item.usuario ? `<div>Usuário: ${item.usuario}</div>` : ''}
                    ${item.email ? `<div>Email: ${item.email}</div>` : ''}
                    ${item.telefone ? `<div>Telefone: ${item.telefone}</div>` : ''}
                </div>
            </div>
            <div class="saved-item-actions">
                <button class="liquid-btn" onclick="savedItemsManager.useItem('${item.id}')" title="Usar item">
                    <span class="check-icon"></span>
                </button>
                <button class="liquid-btn" onclick="savedItemsManager.deleteItem('${item.id}')" title="Excluir item">
                    <span style="color: var(--error-color);">×</span>
                </button>
            </div>
        `;
        return div;
    },

    useItem(id) {
        const items = this.getSavedItems();
        const item = items.find(i => i.id === parseInt(id));
        if (item) {
            
            this.fillMainForm(item);
            this.closeModal();
            this.showNotification('Dados preenchidos com sucesso!');
        }
    },

    deleteItem(id) {
        if (confirm('Tem certeza que deseja excluir este item?')) {
            let items = this.getSavedItems();
            items = items.filter(i => i.id !== parseInt(id));
            localStorage.setItem('savedItems', JSON.stringify(items));
            this.loadSavedItems();
            this.showNotification('Item excluído com sucesso!');
        }
    },

    fillMainForm(item) {
        
        const mappings = {
            'inputTitulo': item.titulo,
            'inputUsuario': item.usuario,
            'inputEmail': item.email,
            'inputSenha': item.usuario, 
            'inputTelefone': item.telefone,
            'inputLinks': item.links,
            'inputCpf': item.cpf
        };

        
        this.closeModal();

        
        const autoFillSettings = document.getElementById('autoFillSettings');
        if (autoFillSettings && autoFillSettings.style.display !== 'none') {
            document.getElementById('btn-autofill-back-to-app').click();
        }

        
        const firstBoard = document.querySelector('.board');
        const boardId = firstBoard ? firstBoard.getAttribute('data-id') : '1';

        
        abrirModalSenha(boardId);

        
        setTimeout(() => {
            Object.entries(mappings).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field && value) {
                    field.value = value;
                    
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            
            this.showNotification('Campos preenchidos com sucesso!');
        }, 100);
        if (autoFillSettings && autoFillSettings.style.display !== 'none') {
            document.getElementById('btn-autofill-back-to-app').click();
        }

        
        const modalSenha = document.getElementById('modalSenha');
        if (!modalSenha || modalSenha.style.display !== 'block') {
            
            const addButton = document.querySelector('.add-button, .board-add-button');
            if (addButton) {
                addButton.click();
            }
        }

        
        setTimeout(() => {
            
            Object.entries(mappings).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field && value) {
                    field.value = value;
                    
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            
            this.showNotification('Campos preenchidos com sucesso!');
        }, 100);
    },

    suggestAutoComplete(input) {
        const items = this.getSavedItems();
        const value = input.value.toLowerCase();
        if (!value) return;

        
        const oldSuggestions = document.querySelector('.suggestions');
        if (oldSuggestions) {
            oldSuggestions.remove();
        }

        
        const matches = new Set();
        items.forEach(item => {
            Object.values(item).forEach(fieldValue => {
                if (typeof fieldValue === 'string' && 
                    fieldValue.toLowerCase().includes(value) && 
                    fieldValue.toLowerCase() !== value) {
                    matches.add(fieldValue);
                }
            });
        });

        if (matches.size > 0) {
            const suggestionsList = document.createElement('div');
            suggestionsList.className = 'suggestions';
            
            matches.forEach(match => {
                const suggestion = document.createElement('div');
                suggestion.className = 'suggestion-item';
                suggestion.textContent = match;
                suggestion.addEventListener('click', () => {
                    input.value = match;
                    suggestionsList.remove();
                    input.focus();
                });
                suggestionsList.appendChild(suggestion);
            });

            input.parentNode.insertBefore(suggestionsList, input.nextSibling);

            
            if (!document.querySelector('#suggestions-style')) {
                const style = document.createElement('style');
                style.id = 'suggestions-style';
                style.textContent = `
                    .suggestions {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: var(--background-color);
                        border: 1px solid rgba(173, 216, 230, 0.2);
                        border-radius: 8px;
                        margin-top: 5px;
                        max-height: 200px;
                        overflow-y: auto;
                        z-index: 1000;
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                    }
                    .suggestion-item {
                        padding: 8px 12px;
                        cursor: pointer;
                        transition: background-color 0.2s;
                    }
                    .suggestion-item:hover {
                        background: rgba(173, 216, 230, 0.1);
                    }
                `;
                document.head.appendChild(style);
            }
        }
    },

    showNotification(message) {
        
        let notification = document.querySelector('.notification');
        if (notification) {
            notification.remove();
        }

        
        notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        
        if (!document.querySelector('#notification-style')) {
            const style = document.createElement('style');
            style.id = 'notification-style';
            style.textContent = `
                .notification {
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--background-color);
                    color: var(--text-color);
                    padding: 12px 24px;
                    border-radius: 8px;
                    border: 1px solid rgba(173, 216, 230, 0.2);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                    z-index: 1000;
                    animation: notificationFadeIn 0.3s ease forwards;
                }
                @keyframes notificationFadeIn {
                    from {
                        opacity: 0;
                        transform: translate(-50%, 20px);
                    }
                    to {
                        opacity: 1;
                        transform: translate(-50%, 0);
                    }
                }
            `;
            document.head.appendChild(style);
        }

        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translate(-50%, 20px)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
};


document.addEventListener('DOMContentLoaded', () => {
    savedItemsManager.init();
});
</script>


<style>

.suggestions-container {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    margin-top: 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item:hover {
    background: rgba(173, 216, 230, 0.1);
}

.suggestion-item .suggestion-text {
    flex: 1;
}

.suggestion-item .suggestion-info {
    font-size: 0.8em;
    opacity: 0.7;
    margin-left: 10px;
}

.suggestion-item.selected {
    background: rgba(173, 216, 230, 0.2);
}


@media screen and (max-width: 768px) {
    
    .modal {
        padding: 0; 
        align-items: flex-start; 
        overflow-y: auto; 
    }
    
    .modalContent {
        max-width: 100%;
        width: 100%; 
        min-height: 100vh; 
        margin: 0; 
        padding: 16px; 
        border-radius: 0; 
        box-sizing: border-box; 
    }

    
    .input-container {
        margin-bottom: 16px;
        width: 100%;
    }

    
    input[type="text"], 
    input[type="password"], 
    input[type="tel"], 
    textarea {
        width: 100%;
        padding: 12px 14px;
        font-size: 16px;
    }

    
    .modalButtons {
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
        width: 100%;
    }

    .modalButtons button {
        width: 100%;
        padding: 14px 0;
        margin: 0;
    }

    
    .search-wrapper {
        width: 100%;
        margin-bottom: 16px;
    }

    
    .search-btn.liquid-btn {
        width: 42px;
        height: 42px;
    }

    
    #formSenha .input-container {
        margin-bottom: 16px;
    }

    
    #inputTitulo,
    #inputUsuario,
    #inputEmail,
    #inputSenha,
    #inputTelefone,
    #inputLinks,
    #inputCpf {
        margin-bottom: 0;
    }

    
    .modal .modalContent {
        min-height: calc(100vh - 32px);
        width: calc(100% - 32px);
        display: flex;
        flex-direction: column;
    }

    /* Override mais específico para permitir rolagem no modal de Anotação no mobile */
    #modalAnotacao .modalContent {
        max-height: 100vh;
        min-height: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    
    .form-grid {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
        margin-bottom: 16px; 
    }

    
    body.modal-open {
        position: fixed; 
        width: 100%;
        height: 100%;
    }

    
    .input-container {
        position: relative;
        width: 100%;
        box-sizing: border-box;
    }

    
    .modalContent > * {
        width: 100%;
        box-sizing: border-box;
    }

    
    .modal {
        -webkit-overflow-scrolling: touch; 
    }

    
    .modalButtons {
        position: relative;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px 0;
        background: var(--background-color);
        z-index: 2;
    }
}


.search-wrapper {
    position: relative;
    width: 100%;
}

.search-btn.liquid-btn {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(173, 216, 230, 0.1);
    border: 1px solid rgba(173, 216, 230, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    color: var(--text-color);
}

.search-btn.liquid-btn:hover {
    background: rgba(173, 216, 230, 0.2);
    transform: translateY(-50%) scale(1.05);
    box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.2),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
}

.search-btn.liquid-btn svg {
    width: 18px;
    height: 18px;
    filter: drop-shadow(0 0 2px rgba(173, 216, 230, 0.3));
}


.search-results-modal {
    max-width: 800px !important;
}

.search-results-container {
    max-height: 60vh;
    overflow-y: auto;
    margin: 20px 0;
}

.search-result-item {
    background: rgba(173, 216, 230, 0.1);
    border: 1px solid rgba(173, 216, 230, 0.15);
    border-radius: 16px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    transition: all 0.3s ease;
    cursor: pointer;
}

.search-result-item:hover {
    background: rgba(173, 216, 230, 0.2);
    transform: translateY(-2px);
}

.search-result-title {
    font-weight: 600;
    margin-bottom: 5px;
}

.search-result-info {
    font-size: 0.9em;
    opacity: 0.8;
}


.input-with-suggestions {
    border-color: var(--primary-accent) !important;
    box-shadow: 0 0 0 2px rgba(var(--primary-accent-rgb), 0.1);
}
</style>

<script>

console.error('Script principal carregado');

const suggestionSystem = {
    // usado para evitar abrir repetidamente o Google para a mesma query
    lastAutoOpenedQuery: null,
    lastAutoOpenedAt: 0,

    init() {
        
        const form = document.getElementById('formSenha');
        if (form) {
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = {};
                form.querySelectorAll('input').forEach(input => {
                    formData[input.id] = input.value;
                });
                this.saveToHistory(formData);
            });

            
            const inputs = form.querySelectorAll('input[type="text"]');
            inputs.forEach(input => {
                input.addEventListener('input', (e) => this.handleInput(e));
                input.addEventListener('focus', (e) => this.handleInput(e));
                input.addEventListener('keydown', (e) => this.handleKeydown(e));

                
                if (!input.parentElement.querySelector('.btn-clear-field')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.className = 'btn-clear-field';
                    clearBtn.innerHTML = '×';
                    clearBtn.style.display = 'none';
                    clearBtn.addEventListener('click', () => {
                        input.value = '';
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        clearBtn.style.display = 'none';
                    });
                    input.parentElement.appendChild(clearBtn);

                    
                    input.addEventListener('input', () => {
                        clearBtn.style.display = input.value ? 'block' : 'none';
                    });
                }
            });

            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.input-container')) {
                    this.removeAllSuggestions();
                }
            });

            
            form.addEventListener('submit', (e) => {
                const formData = {};
                inputs.forEach(input => {
                    formData[input.id] = input.value;
                });
                this.saveToHistory(formData);
            });

            
            // Suporte para input existente `inputTitulo` e botão já presente `#search-service-btn`
            const serviceInput = document.getElementById('service') || document.getElementById('inputTitulo');
            let searchBtn = document.getElementById('search-service-btn');

            if (serviceInput) {
                console.error('[DEBUG] suggestionSystem.init: found serviceInput with id', serviceInput.id);
                // Garantir wrapper .search-wrapper
                let serviceWrapper = serviceInput.parentElement;
                if (!serviceWrapper || !serviceWrapper.classList.contains('search-wrapper')) {
                    serviceWrapper = document.createElement('div');
                    serviceWrapper.className = 'search-wrapper';
                    serviceInput.parentNode.insertBefore(serviceWrapper, serviceInput);
                    serviceWrapper.appendChild(serviceInput);
                }

                // Se botão não existir, cria; caso exista, garante que esteja dentro do wrapper
                if (!searchBtn) {
                    console.error('[DEBUG] suggestionSystem.init: no existing search button found, creating one');
                    searchBtn = document.createElement('button');
                    searchBtn.type = 'button';
                    searchBtn.id = 'search-service-btn';
                    searchBtn.className = 'search-btn liquid-btn';
                    searchBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    `;
                    serviceWrapper.appendChild(searchBtn);
                } else if (searchBtn.parentElement !== serviceWrapper) {
                    console.error('[DEBUG] suggestionSystem.init: moving existing search button into wrapper');
                    serviceWrapper.appendChild(searchBtn);
                } else {
                    console.error('[DEBUG] suggestionSystem.init: using existing search button');
                }

                const handleSearch = () => {
                    const query = serviceInput.value.trim();
                    console.error('[DEBUG] handleSearch triggered with query:', query);
                    if (query) this.performSearch(query);
                };

                searchBtn.addEventListener('click', handleSearch);

                serviceInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleSearch();
                    }
                });
            }
        }
    },

    
    performSearch(query) {
        console.error('[DEBUG] performSearch called with query:', query);
        const results = this.findAllMatches(query);
        console.error('[DEBUG] performSearch found results:', Array.isArray(results) ? results.length : 'no-array');

        if (!Array.isArray(results) || results.length === 0) {
            const q = (query || '').trim();
            const now = Date.now();
            const same = this.lastAutoOpenedQuery === q;
            const elapsed = now - (this.lastAutoOpenedAt || 0);

            // abrir apenas uma vez por query dentro de um intervalo para evitar múltiplos popups
            if (q && (!same || elapsed > 30000)) {
                try {
                    console.error('[DEBUG] No local results — opening web search for query:', q);
                    window.open('https://www.google.com/search?q=' + encodeURIComponent(q), '_blank');
                    this.lastAutoOpenedQuery = q;
                    this.lastAutoOpenedAt = now;
                } catch (e) {
                    console.error('[ERROR] failed to open web search:', e);
                }
            } else {
                console.error('[DEBUG] Skipping auto-open (recent or empty query) q=', q, 'same=', same, 'elapsed=', elapsed);
            }

            // Não abrir o modal quando não houver resultados locais — comportamento: apenas abrir o Google
            return;
        }

        const searchResultsModal = document.getElementById('searchResultsModal') || this.createSearchResultsModal();
        // Passar a query para o display para permitir ações adicionais
        this.displaySearchResults(results, searchResultsModal, query);
        this.showModal(searchResultsModal);
    },

    
    createSearchResultsModal() {
        const modal = document.createElement('div');
        modal.id = 'searchResultsModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modalContent search-results-modal">
                <h2>Resultados da Busca</h2>
                <div class="search-results-container"></div>
                <div class="modalButtons">
                    <button type="button" class="close-search">Fechar</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        
        modal.querySelector('.close-search').addEventListener('click', () => {
            this.hideModal(modal);
        });

        return modal;
    },

    
    findAllMatches(query) {
        const history = this.getFormHistory();
        const results = [];
        const queryLower = query.toLowerCase();

        history.forEach(entry => {
            let matchScore = 0;
            let matchDetails = [];

            
            Object.entries(entry).forEach(([key, value]) => {
                if (typeof value === 'string' && value.toLowerCase().includes(queryLower)) {
                    matchScore += key === 'titulo' ? 2 : 1; 
                    matchDetails.push({ field: key, value });
                }
            });

            if (matchScore > 0) {
                results.push({
                    ...entry,
                    matchScore,
                    matchDetails
                });
            }
        });

        
        return results.sort((a, b) => b.matchScore - a.matchScore);
    },

    
    displaySearchResults(results, modal, query = '') {
        const container = modal.querySelector('.search-results-container');
        container.innerHTML = '';

        console.error('[DEBUG] displaySearchResults called with results:', Array.isArray(results) ? results.length : 'no-array', 'query:', query);

        if (results.length === 0) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <p>Nenhum resultado encontrado.</p>
                    <div style="margin-top:12px;">
                        <button type="button" class="btn-search-web">🔎 Buscar na web</button>
                    </div>
                </div>
            `;

            const btn = container.querySelector('.btn-search-web');
            if (btn) {
                btn.addEventListener('click', () => {
                    const url = 'https://www.google.com/search?q=' + encodeURIComponent(query || '');
                    window.open(url, '_blank');
                });
            }

            return;
        }

        results.forEach(result => {
            const resultElement = document.createElement('div');
            resultElement.className = 'search-result-item';
            resultElement.innerHTML = `
                <div>
                    <div class="search-result-title">${result.titulo || 'Sem título'}</div>
                    <div class="search-result-info">
                        ${result.matchDetails.map(match => `<span>${match.field}: ${match.value}</span>`).join(' • ')}
                    </div>
                </div>
            `;

            resultElement.addEventListener('click', () => {
                this.applySearchResult(result);
                this.hideModal(modal);
            });

            container.appendChild(resultElement);
        });
    },

    
    applySearchResult(result) {
        Object.entries(result).forEach(([key, value]) => {
            const field = document.getElementById(key);
            if (field && typeof value === 'string') {
                field.value = value;
                field.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
    },

    
    showModal(modal) {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
    },

    
    hideModal(modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    },

    handleInput(e) {
        const input = e.target;
        const value = input.value.toLowerCase();
        
        
        this.removeSuggestions(input);
        
        if (!value) return;

        
        const suggestions = this.findSuggestions(input.id, value);
        if (suggestions.length > 0) {
            this.showSuggestions(input, suggestions);
        }
    },

    handleKeydown(e) {
        const container = e.target.parentElement.querySelector('.suggestions-container');
        if (!container) return;

        const items = container.querySelectorAll('.suggestion-item');
        const current = container.querySelector('.suggestion-item.selected');
        
        switch (e.key) {
            case 'ArrowDown':
            case 'ArrowUp':
                e.preventDefault();
                this.navigateSuggestions(items, current, e.key === 'ArrowDown');
                break;
            case 'Enter':
                e.preventDefault();
                if (current) {
                    this.applySuggestion(e.target, current.dataset.value, current.dataset.context);
                }
                break;
            case 'Escape':
                this.removeSuggestions(e.target);
                break;
        }
    },

    findSuggestions(fieldId, value) {
        const suggestions = [];
        const history = this.getFormHistory();
        
        
        const relatedFields = {
            'inputTitulo': ['titulo', 'servico', 'site'],
            'inputUsuario': ['usuario', 'nome'],
            'inputEmail': ['email'],
            'inputSenha': ['senha'],
            'inputTelefone': ['telefone', 'contato', 'celular'],
            'inputLinks': ['link', 'url', 'site', 'website'],
            'inputCpf': ['cpf', 'documento']
        };

        history.forEach(entry => {
            Object.entries(entry).forEach(([key, entryValue]) => {
                if (typeof entryValue === 'string' && 
                    entryValue.toLowerCase().includes(value)) {
                    
                    
                    const related = relatedFields[fieldId] || [];
                    const isRelated = related.length > 0 && related.some(field => 
                        key.toLowerCase().includes(field)
                    );

                    if (isRelated) {
                        suggestions.push({
                            value: entryValue,
                            context: entry,
                            confidence: this.calculateConfidence(value, entryValue.toLowerCase())
                        });
                    }
                }
            });
        });

        
        return Array.from(new Set(suggestions.map(s => s.value)))
            .map(value => suggestions.find(s => s.value === value))
            .sort((a, b) => b.confidence - a.confidence)
            .slice(0, 5); 
    },

    calculateConfidence(input, target) {
        if (target === input) return 1;
        if (target.startsWith(input)) return 0.8;
        if (target.includes(input)) return 0.6;
        return 0.4;
    },

    showSuggestions(input, suggestions) {
        const container = document.createElement('div');
        container.className = 'suggestions-container';
        
        suggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            if (index === 0) item.classList.add('selected');
            
            item.innerHTML = `
                <span class="suggestion-text">${this.highlightMatch(suggestion.value, input.value)}</span>
                <span class="suggestion-info">${this.getContextInfo(suggestion.context)}</span>
            `;
            
            item.dataset.value = suggestion.value;
            item.dataset.context = JSON.stringify(suggestion.context);
            
            item.addEventListener('click', () => {
                this.applySuggestion(input, suggestion.value, JSON.stringify(suggestion.context));
            });
            
            container.appendChild(item);
        });
        
        input.parentElement.appendChild(container);
        input.classList.add('input-with-suggestions');
    },

    highlightMatch(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    },

    getContextInfo(context) {
        
        return '';
    },

    timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        const intervals = {
            ano: 31536000,
            mês: 2592000,
            semana: 604800,
            dia: 86400,
            hora: 3600,
            minuto: 60
        };

        for (let [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = Math.floor(seconds / secondsInUnit);
            if (interval >= 1) {
                return `há ${interval} ${unit}${interval > 1 ? (unit === 'mês' ? 'es' : 's') : ''}`;
            }
        }
        return 'há instantes';
    },

    applySuggestion(input, value, contextJSON) {
        input.value = value;
        input.dispatchEvent(new Event('input', { bubbles: true }));
        this.removeSuggestions(input);

        
        try {
            const context = JSON.parse(contextJSON);
            this.fillRelatedFields(input.id, context);
        } catch (e) {
            console.error('Erro ao processar contexto:', e);
        }
    },

    fillRelatedFields(sourceId, context) {
        const mappings = {
            'inputTitulo': ['titulo', 'servico', 'site'],
            'inputUsuario': ['usuario', 'nome'],
            'inputEmail': ['email'],
            'inputSenha': ['senha'],
            'inputTelefone': ['telefone'],
            'inputLinks': ['links', 'url', 'website'],
            'inputCpf': ['cpf']
        };

        Object.entries(mappings).forEach(([fieldId, keys]) => {
            if (fieldId !== sourceId) {
                const field = document.getElementById(fieldId);
                if (field && !field.value) {
                    for (let key of keys) {
                        const value = this.findValueInContext(context, key);
                        if (value) {
                            field.value = value;
                            field.dispatchEvent(new Event('input', { bubbles: true }));
                            break;
                        }
                    }
                }
            }
        });
    },

    findValueInContext(context, key) {
        for (let contextKey in context) {
            if (contextKey.toLowerCase().includes(key) && context[contextKey]) {
                return context[contextKey];
            }
        }
        return null;
    },

    getFormHistory() {
        try {
            const raw = localStorage.getItem('formHistory');
            console.error('[DEBUG] getFormHistory raw length:', raw ? raw.length : 0, 'raw exists:', !!raw);
            const parsed = JSON.parse(raw || '[]');
            console.error('[DEBUG] getFormHistory parsed length:', Array.isArray(parsed) ? parsed.length : 'not-array', 'sample:', parsed && parsed[0]);
            return parsed;
        } catch (e) {
            console.error('Erro ao ler histórico:', e);
            return [];
        }
    },

    saveToHistory(formData) {
        try {
            const history = this.getFormHistory();
            formData.timestamp = new Date().toISOString();
            
            
            history.unshift(formData);
            
            
            while (history.length > 100) history.pop();
            
            localStorage.setItem('formHistory', JSON.stringify(history));
        } catch (e) {
            console.error('Erro ao salvar no histórico:', e);
        }
    },

    navigateSuggestions(items, current, isDown) {
        if (!items.length) return;
        
        const firstItem = items[0];
        const lastItem = items[items.length - 1];
        
        if (!current) {
            firstItem.classList.add('selected');
            return;
        }
        
        current.classList.remove('selected');
        
        if (isDown) {
            const next = current.nextElementSibling;
            (next || firstItem).classList.add('selected');
        } else {
            const prev = current.previousElementSibling;
            (prev || lastItem).classList.add('selected');
        }
    },

    removeSuggestions(input) {
        const container = input.parentElement.querySelector('.suggestions-container');
        if (container) {
            container.remove();
            input.classList.remove('input-with-suggestions');
        }
    },

    removeAllSuggestions() {
        document.querySelectorAll('.suggestions-container').forEach(container => {
            container.remove();
        });
        document.querySelectorAll('.input-with-suggestions').forEach(input => {
            input.classList.remove('input-with-suggestions');
        });
    },

    // Popula a caixa de seleção `#relatedServicesSelect` com serviços do mesmo board
    populateRelatedServices(boardId, excludeCardId = null, attempts = 0) {
        try {
            // Tentar usar a variável local `boards` (declarada no escopo do app). Se não existir, tentar window.boards
            let sourceBoards = [];
            if (typeof boards !== 'undefined' && Array.isArray(boards)) sourceBoards = boards;
            else if (window && Array.isArray(window.boards)) sourceBoards = window.boards;
            else if (window && window.boards && Array.isArray(window.boards.boardsData)) sourceBoards = window.boards.boardsData;

            const boardsLen = sourceBoards ? sourceBoards.length : 0;
            console.error('[DEBUG] populateRelatedServices called', { boardId, boardsLength: boardsLen, attempts, sourceType: typeof sourceBoards });
            const select = document.getElementById('relatedServicesSelect');
            if (!select) { console.error('[DEBUG] relatedServicesSelect not found'); return; }
            select.innerHTML = '<option value="">Serviços nesta categoria...</option>';
            if (!boardId) { select.style.display = 'none'; console.error('[DEBUG] no boardId supplied'); return; }

            // Se boards ainda não estiverem carregados, tentar novamente até 5 tentativas
            if (boardsLen === 0 && attempts < 5) {
                console.error('[DEBUG] boards empty, retrying populateRelatedServices in 200ms (attempt', attempts + 1, ')');
                setTimeout(() => this.populateRelatedServices(boardId, excludeCardId, attempts + 1), 200);
                return;
            }

            const board = (sourceBoards || []).find(b => b.id === boardId);
            console.error('[DEBUG] found board:', !!board, 'cardsLength:', board && Array.isArray(board.cards) ? board.cards.length : 0);
            if (!board || !Array.isArray(board.cards) || board.cards.length === 0) { select.style.display = 'none'; return; }

            // Construir mapa de serviços -> [cardIds] e tentar descriptografar quando possível
            const serviceMap = new Map();
            const master = (typeof senhaDigitada !== 'undefined') ? senhaDigitada : (window && window.senhaDigitada ? window.senhaDigitada : null);

            board.cards.forEach(c => {
                try {
                    if (excludeCardId && c.id === excludeCardId) return;
                    let candidate = String(c.titulo || c.servico || c.links || '').trim();

                    // Se o campo parecer cifrado e tivermos a senha mestre, tentar descriptografar o card inteiro
                    if (candidate && typeof candidate === 'string' && candidate.startsWith('U2FsdGVk') && master) {
                        try {
                            const decCard = (typeof descriptografarCard === 'function') ? descriptografarCard(c, master) : null;
                            if (decCard && decCard.titulo) {
                                candidate = String(decCard.titulo || candidate);
                                console.error('[DEBUG] decrypted card title for card.id', c.id, '->', candidate);
                            } else {
                                // tentar descriptografar apenas o campo
                                try {
                                    const maybe = (typeof descriptografarDados === 'function') ? descriptografarDados(candidate, master) : null;
                                    if (maybe) candidate = String(maybe);
                                } catch (e) { console.error('[DEBUG] decrypt field fallback failed for', c.id, e); }
                            }
                        } catch (e) {
                            console.error('[DEBUG] decrypt candidate failed for card.id', c.id, e);
                        }
                    }

                    candidate = candidate.trim();
                    if (candidate) {
                        const key = candidate;
                        if (!serviceMap.has(key)) serviceMap.set(key, []);
                        serviceMap.get(key).push(c.id);
                    }
                } catch (err) {
                    console.error('[DEBUG] error processing card for related services', err);
                }
            });

            const unique = Array.from(serviceMap.keys()).slice(0, 50);
            console.error('[DEBUG] unique services count:', unique.length, unique.slice(0,5));
            if (!unique.length) { select.style.display = 'none'; return; }

            unique.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = `${s} (${serviceMap.get(s).length})`;
                opt.dataset.ids = serviceMap.get(s).join(',');
                select.appendChild(opt);
            });

            select.style.display = 'block';
            select.onchange = function(e) {
                if (e.target && e.target.value) {
                    const input = document.getElementById('inputTitulo');
                    if (input) {
                        input.value = e.target.value;
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            };
        } catch (err) {
            console.error('[DEBUG] populateRelatedServices error', err);
        }
    }
};


const searchSystem = {
    init() {
        
        const serviceInput = document.getElementById('inputTitulo');
        if (serviceInput && !serviceInput.parentElement.querySelector('.search-btn')) {
            
            let wrapper = serviceInput.parentElement;
            if (!wrapper.classList.contains('search-wrapper')) {
                wrapper = document.createElement('div');
                wrapper.className = 'search-wrapper';
                serviceInput.parentNode.insertBefore(wrapper, serviceInput);
                wrapper.appendChild(serviceInput);
            }

            
            const searchBtn = document.createElement('button');
            searchBtn.className = 'search-btn liquid-btn';
            searchBtn.type = 'button'; 
            searchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            `;
            wrapper.appendChild(searchBtn);

            
            searchBtn.addEventListener('click', (e) => {
                e.preventDefault(); 
                this.handleSearch(serviceInput);
            });
            
            
            serviceInput.closest('form').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target === serviceInput) {
                    e.preventDefault();
                    this.handleSearch(serviceInput);
                }
            });
        }
    },

    handleSearch(input) {
        const query = input.value.trim();
        if (!query) return;
        
        
        const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        const newWindow = window.open(searchUrl, '_blank');
        if (newWindow) {
            newWindow.focus(); 
        } else {
            
            window.location.href = searchUrl;
        }
    },

    findMatches(query) {
        
        const boardsData = JSON.parse(localStorage.getItem('gerenciadorBoards') || '[]');
        const allServices = [];
        
        
        if (Array.isArray(boardsData)) {
            boardsData.forEach(board => {
                board.cards.forEach(card => {
                    allServices.push({
                        name: card.titulo || '',
                        description: card.notas || '',
                        category: board.nome || ''
                    });
                });
            });
        }
        
        else if (boardsData.boardsData) {
            boardsData.boardsData.forEach(board => {
                board.cards.forEach(card => {
                    const decryptedCard = descriptografarCard(card, senhaDigitada);
                    if (decryptedCard) {
                        allServices.push({
                            name: decryptedCard.titulo || '',
                            description: decryptedCard.notas || '',
                            category: board.nome || ''
                        });
                    }
                });
            });
        }
        const queryLower = query.toLowerCase();

        return allServices.filter(service => {
            return service.name.toLowerCase().includes(queryLower) ||
                   (service.description && service.description.toLowerCase().includes(queryLower)) ||
                   (service.category && service.category.toLowerCase().includes(queryLower));
        }).sort((a, b) => {
            
            const aInName = a.name.toLowerCase().includes(queryLower);
            const bInName = b.name.toLowerCase().includes(queryLower);
            if (aInName && !bInName) return -1;
            if (!aInName && bInName) return 1;
            return 0;
        });
    },

    showResults(results) {
        const modal = document.getElementById('searchResultsModal');
        const container = modal.querySelector('.search-results-container');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <p>Nenhum resultado encontrado.</p>
                </div>
            `;
        } else {
            results.forEach(result => {
                const resultElement = document.createElement('div');
                resultElement.className = 'search-result-item';
                resultElement.innerHTML = `
                    <div>
                        <div class="search-result-title">${result.name}</div>
                        <div class="search-result-info">
                            ${result.category || ''} ${result.description ? `• ${result.description}` : ''}
                        </div>
                    </div>
                `;

                resultElement.addEventListener('click', () => {
                    document.getElementById('service').value = result.name;
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                });

                container.appendChild(resultElement);
            });
        }

        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }
};

document.addEventListener('DOMContentLoaded', () => {
    console.error('DOMContentLoaded executado');
    
    // Garantir label/teor correto do botão PLUG-IN OFFLINE (sincroniza com aria-label)
    try {
        const off = document.getElementById('pluginOfflineBox');
        if (off) {
            const correct = (off.getAttribute('aria-label') || 'PLUG-IN OFFLINE').trim();
            if (off.textContent.trim() !== correct) {
                off.textContent = correct;
                console.error('[FIX] pluginOfflineBox text normalized to aria-label:', correct);
            }
        }
    } catch (e) { console.error('[FIX] normalize pluginOfflineBox failed', e); }

    // ... existing code ...

    // Aparelhos correlacionados removidos

    const inputTitulo = document.getElementById('inputTitulo');
    if (inputTitulo) {
        inputTitulo.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = inputTitulo.value.trim();
                if (query) {
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                }
            }
        });
    }

    
    // Instalar handlers globais de erro para capturar falhas silenciosas
    try {
        window.addEventListener('error', (ev) => {
            console.error('[GLOBAL ERROR]', ev && ev.message, ev && ev.filename, ev && ev.lineno, ev && ev.colno, ev && ev.error);
        });
        window.addEventListener('unhandledrejection', (ev) => {
            console.error('[UNHANDLED REJECTION]', ev && ev.reason);
        });
    } catch(e){ console.error('[DEBUG] não conseguiu ligar handlers globais:', e); }

    suggestionSystem.init();
    console.error('suggestionSystem.init() executado');

    // Conexão adicional para o botão existente `#search-service-btn` e o campo `#inputTitulo`
    const existingInputTitulo = document.getElementById('inputTitulo');
    const existingSearchBtn = document.getElementById('search-service-btn');

    console.error('[DEBUG] DOMContentLoaded: existingInputTitulo=', existingInputTitulo ? existingInputTitulo.id : null, ' existingSearchBtn=', existingSearchBtn ? existingSearchBtn.id : null);

    if (existingSearchBtn && existingInputTitulo) {
        existingSearchBtn.addEventListener('click', () => {
            console.error('[DEBUG] existingSearchBtn clicked');
            const q = existingInputTitulo.value.trim();
            if (q) suggestionSystem.performSearch(q);
        });
        existingInputTitulo.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                console.error('[DEBUG] inputTitulo Enter pressed');
                e.preventDefault();
                const q = existingInputTitulo.value.trim();
                if (q) suggestionSystem.performSearch(q);
            }
        });
    }

    // Handler de fechamento do modal — tolerante a diferentes classes e à ausência de botões
    const searchModal = document.getElementById('searchResultsModal');
    if (searchModal) {
        const closeBtns = document.querySelectorAll('.close-search, .close-search-results');
        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                searchModal.style.display = 'none';
                document.body.classList.remove('modal-open');
            });
        });
        searchModal.addEventListener('click', (e) => {
            if (e.target === searchModal) {
                searchModal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        });
    }

    // Event listeners para aparelhos correlacionados removidos
});
</script>
<script>

function checkUpdateTimer() {
    const lastCheck = localStorage.getItem('lastUpdateCheck');
    const now = new Date().getTime();
    const updateDialog = document.getElementById('update-dialog');
    const timerElement = document.querySelector('#version-link .update-timer');
    
    if (!lastCheck) {
        localStorage.setItem('lastUpdateCheck', now);
        if (timerElement) timerElement.textContent = '30 dias';
        return;
    }
    
    const daysPassed = Math.floor((now - lastCheck) / (1000 * 60 * 60 * 24));
    const daysRemaining = Math.max(30 - daysPassed, 0);
    
    if (timerElement) {
        timerElement.textContent = daysRemaining === 1 ? '1 dia' : `${daysRemaining} dias`;
    }
    
    if (daysPassed >= 30 && updateDialog) {
        updateDialog.style.display = 'block';
        localStorage.setItem('lastUpdateCheck', now);
    }
}


document.addEventListener('DOMContentLoaded', checkUpdateTimer);


setInterval(checkUpdateTimer, 1000 * 60 * 60);

// Função para revisar senhas/anotações aleatórias
function abrirRevisaoAleatoria(tipo) {
    const currentBoards = tipo === 'senha' ? boards : anotacoesBoards;
    
    // Coletar apenas cards (criptografados) com marcador importante
    const cardsImportantes = [];
    currentBoards.forEach(board => {
        board.cards.forEach(cardCriptografado => {
            const card = descriptografarCard(cardCriptografado, senhaDigitada);
            if (card && card.marcadorId) {
                const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                if (marcador && marcador.importante) {
                    // armazenamos o objeto criptografado para abrir o modal em modo de edição
                    cardsImportantes.push({ cardCriptografado, board });
                }
            }
        });
    });
    
    if (cardsImportantes.length === 0) {
        mostrarMensagem('Aviso', `Não há ${tipo === 'senha' ? 'senhas' : 'anotações'} com marcadores importantes para revisar.`);
        return;
    }
    
    // Selecionar um card aleatório
    const randomIndex = Math.floor(Math.random() * cardsImportantes.length);
    const { cardCriptografado, board } = cardsImportantes[randomIndex];
    
    // Abrir o modal apropriado em modo de edição (passando o objeto criptografado)
    if (tipo === 'senha') {
        abrirModalSenha(board.id, cardCriptografado);
    } else {
        abrirModalAnotacao(board.id, cardCriptografado);
    }
}

document.getElementById('btnRevisarSenha')?.addEventListener('click', () => {
    abrirRevisaoAleatoria('senha');
});

document.getElementById('btnRevisarAnotacao')?.addEventListener('click', () => {
    abrirRevisaoAleatoria('anotacao');
});

// Mostrar alertas de revisão aleatoriamente (30% de chance ao carregar)
function verificarMostrarAlerta() {
    const snoozeSenha = Number(localStorage.getItem('alertaRevisaoSenhaSnooze') || 0);
    const snoozeAnotacao = Number(localStorage.getItem('alertaRevisaoAnotacaoSnooze') || 0);
    const agora = Date.now();
    const prazoSnooze = 1000 * 60 * 60 * 24; // 24h

    // Verificar se há senhas com marcador importante
    let temSenhaImportante = false;
    for (const board of boards) {
        for (const cardCriptografado of board.cards) {
            const card = descriptografarCard(cardCriptografado, senhaDigitada);
            if (card && card.marcadorId) {
                const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                if (marcador && marcador.importante) {
                    temSenhaImportante = true;
                    break;
                }
            }
        }
        if (temSenhaImportante) break;
    }
    
    if (temSenhaImportante && Math.random() < 0.3 && (agora - snoozeSenha > prazoSnooze)) {
        const alertaSenha = document.getElementById('alerta-revisao-senha');
        if (alertaSenha) {
            alertaSenha.style.display = 'flex';
        }
    }
    
    // Verificar se há anotações com marcador importante
    let temAnotacaoImportante = false;
    for (const board of anotacoesBoards) {
        for (const cardCriptografado of board.cards) {
            const card = descriptografarCard(cardCriptografado, senhaDigitada);
            if (card && card.marcadorId) {
                const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                if (marcador && marcador.importante) {
                    temAnotacaoImportante = true;
                    break;
                }
            }
        }
        if (temAnotacaoImportante) break;
    }
    
    if (temAnotacaoImportante && Math.random() < 0.3 && (agora - snoozeAnotacao > prazoSnooze)) {
        const alertaAnotacao = document.getElementById('alerta-revisao-anotacao');
        if (alertaAnotacao) {
            alertaAnotacao.style.display = 'flex';
        }
    }
}

function adiarAlertaRevisao(tipo) {
    const agora = Date.now();
    const isAnotacao = tipo === 'anotacao';
    const key = isAnotacao ? 'alertaRevisaoAnotacaoSnooze' : 'alertaRevisaoSenhaSnooze';
    localStorage.setItem(key, String(agora));
    const alerta = document.getElementById(isAnotacao ? 'alerta-revisao-anotacao' : 'alerta-revisao-senha');
    if (alerta) alerta.style.display = 'none';
}

// ====== UTILITÁRIOS DE SENHA GERADA ======
function gerarSenhaAleatoria(tamanho = 12) {
    const caracteresMinusculas = 'abcdefghijklmnopqrstuvwxyz';
    const caracteresMaiusculas = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const caracteresNumeros = '0123456789';
    const caracteresEspeciais = '!@#$%&*-_=+';
    const todosCaracteres = caracteresMinusculas + caracteresMaiusculas + caracteresNumeros + caracteresEspeciais;

    let senha = '';
    senha += caracteresMinusculas[Math.floor(Math.random() * caracteresMinusculas.length)];
    senha += caracteresMaiusculas[Math.floor(Math.random() * caracteresMaiusculas.length)];
    senha += caracteresNumeros[Math.floor(Math.random() * caracteresNumeros.length)];
    senha += caracteresEspeciais[Math.floor(Math.random() * caracteresEspeciais.length)];

    for (let i = senha.length; i < tamanho; i += 1) {
        senha += todosCaracteres[Math.floor(Math.random() * todosCaracteres.length)];
    }

    return senha.split('').sort(() => Math.random() - 0.5).join('');
}

function mostrarSenhaCombotaoCopiar(senha, titulo) {
    const tituloDoc = titulo || 'Documento';

    if (!window.messageBox) return;

    window.messageBox.innerHTML = `
        <div style="text-align: center; max-height: 70vh; overflow: auto; padding-right: 12px; -webkit-overflow-scrolling: touch;">
            <div style="margin-bottom: 30px;">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="var(--text-color)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 16px; display: block; opacity: 0.8;">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11v a5 5 0 0 1 10 0v "></path>
                </svg>
                <h2 style="margin: 0 0 8px 0; color: var(--text-color); font-size: 22px; font-weight: 600;">PDF Gerado com Sucesso</h2>
                <p style="color: var(--text-color); opacity: 0.7; margin: 0; font-size: 14px;">Use a senha abaixo para abrir o documento</p>
            </div>
            
            <div style="background: var(--input-bg); backdrop-filter: blur(10px); border-radius: var(--border-radius-inner); padding: 24px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <p style="font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-color); opacity: 0.5; margin-bottom: 12px; font-weight: 500;">Senha do PDF</p>
                <div style="background: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 18px; margin-bottom: 18px;">
                    <code id="senhaParaCopiar" style="font-size: 18px; font-weight: 600; color: var(--text-color); letter-spacing: 1.5px; word-break: break-all; font-family: 'Courier New', monospace; display: block;">${senha}</code>
                </div>
                <button id="btnCopiarSenha" style="width: 100%; padding: 14px; background: var(--button-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2v a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v "></path>
                    </svg>
                    <span id="textoBotaoCopiar">Copiar Senha</span>
                </button>
                <button id="btnSalvarSenhaImagem" style="width: 100%; margin-top:10px; padding: 12px; background: transparent; color: var(--text-color); border: 1px dashed var(--border-color); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                    Salvar como imagem
                </button>
            </div>
            
            <div style="background: var(--input-bg); border-left: 3px solid var(--text-color); padding: 14px 16px; border-radius: 6px; text-align: left; margin-bottom: 24px; opacity: 0.8;">
                <p style="margin: 0; font-size: 13px; color: var(--text-color); line-height: 1.5;">
                    <strong style="font-weight: 600;">Importante:</strong> Guarde esta senha em local seguro. Ela é necessária para abrir o PDF de ${tituloDoc}.
                </p>
            </div>
            
            <button id="btnFecharSenha" style="display: block; margin: 0 auto; padding: 12px 32px; background: var(--button-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                Fechar
            </button>
        </div>
    `;

    // garantir que o overlay e o messageBox fiquem visíveis como nos outros modais
    try {
        if (overlay) overlay.style.display = 'block';
        if (overlay) overlay.style.setProperty('z-index','2147483650','important');
        window.messageBox.style.setProperty('z-index','2147483652','important');
        window.messageBox.style.display = 'block';
    } catch (err) {
        console.warn('Erro ao exibir modal de senha:', err);
    }

    const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
    window.messageBox.dataset.modalToken = modalToken;

    const copyBtn = document.getElementById('btnCopiarSenha');
    const fecharBtn = document.getElementById('btnFecharSenha');

    if (copyBtn) {
        copyBtn.addEventListener('click', () => {
            const textSpan = document.getElementById('textoBotaoCopiar');
            navigator.clipboard.writeText(senha).then(() => {
                if (textSpan) textSpan.textContent = 'Copiado!';
                copyBtn.disabled = true;
                setTimeout(() => {
                    if (textSpan) textSpan.textContent = 'Copiar Senha';
                    copyBtn.disabled = false;
                }, 1200);
            }).catch(() => {
                if (textSpan) textSpan.textContent = 'Erro ao copiar';
            });
        }, { once: true });
    }

    const saveImgBtn = document.getElementById('btnSalvarSenhaImagem');
    if (saveImgBtn) {
        saveImgBtn.addEventListener('click', () => {
            try {
                const tituloTextSafe = (tituloDoc || 'senha').replace(/[^a-z0-9\- _]/gi, '').trim() || 'senha';
                const text = senha || '';
                const padding = 36;
                const fontSize = 36;
                const fontFamily = "Courier New, monospace";

                // medir largura do texto usando canvas temporário
                const tmp = document.createElement('canvas');
                const tmpCtx = tmp.getContext('2d');
                tmpCtx.font = `${fontSize}px ${fontFamily}`;
                const measured = Math.ceil(tmpCtx.measureText(text).width) + padding * 2;
                const width = Math.min(2000, Math.max(420, measured));
                const height = 160;

                const canvas = document.createElement('canvas');
                const ratio = Math.max(1, window.devicePixelRatio || 1);
                const finalWidth = Math.min(1200, Math.max(480, width));
                const finalHeight = 360;
                canvas.width = finalWidth * ratio;
                canvas.height = finalHeight * ratio;
                canvas.style.width = finalWidth + 'px';
                canvas.style.height = finalHeight + 'px';
                const ctx = canvas.getContext('2d');
                ctx.scale(ratio, ratio);

                // elegante gradiente de fundo
                const g = ctx.createLinearGradient(0, 0, finalWidth, finalHeight);
                g.addColorStop(0, '#6a11cb');
                g.addColorStop(1, '#2575fc');
                ctx.fillStyle = g;
                ctx.fillRect(0, 0, finalWidth, finalHeight);

                // cartão central com sombra
                const cardPadding = 40;
                const cardX = cardPadding;
                const cardY = 30;
                const cardW = finalWidth - cardPadding * 2;
                const cardH = finalHeight - 60;
                const radius = 18;

                ctx.shadowColor = 'rgba(0,0,0,0.18)';
                ctx.shadowBlur = 28;
                ctx.shadowOffsetY = 8;

                // desenhar cartão arredondado
                ctx.beginPath();
                ctx.moveTo(cardX + radius, cardY);
                ctx.arcTo(cardX + cardW, cardY, cardX + cardW, cardY + cardH, radius);
                ctx.arcTo(cardX + cardW, cardY + cardH, cardX, cardY + cardH, radius);
                ctx.arcTo(cardX, cardY + cardH, cardX, cardY, radius);
                ctx.arcTo(cardX, cardY, cardX + cardW, cardY, radius);
                ctx.closePath();
                ctx.fillStyle = 'rgba(255,255,255,0.96)';
                ctx.fill();

                // reset sombra para texto
                ctx.shadowColor = 'transparent';

                // título do cartão
                ctx.fillStyle = '#2d2d2d';
                ctx.font = '600 14px Inter, system-ui, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`Senha do PDF — ${tituloDoc}`, cardX + 28, cardY + 34);

                // bloco da senha (caixa)
                const boxX = cardX + 28;
                const boxY = cardY + 56;
                const boxW = cardW - 56;
                const boxH = 140;
                const boxRadius = 12;

                // fundo interno do box
                ctx.fillStyle = '#f6f8fb';
                ctx.beginPath();
                ctx.moveTo(boxX + boxRadius, boxY);
                ctx.arcTo(boxX + boxW, boxY, boxX + boxW, boxY + boxH, boxRadius);
                ctx.arcTo(boxX + boxW, boxY + boxH, boxX, boxY + boxH, boxRadius);
                ctx.arcTo(boxX, boxY + boxH, boxX, boxY, boxRadius);
                ctx.arcTo(boxX, boxY, boxX + boxW, boxY, boxRadius);
                ctx.closePath();
                ctx.fill();

                // borda suave
                ctx.strokeStyle = 'rgba(45,55,72,0.06)';
                ctx.lineWidth = 1;
                ctx.stroke();

                // senha em destaque, centralizada verticalmente no box
                ctx.fillStyle = '#111827';
                ctx.textAlign = 'center';
                // ajustar tamanho da fonte para caber na caixa
                let passFontSize = 48;
                ctx.font = `700 ${passFontSize}px "Courier New", monospace`;
                while (ctx.measureText(text).width > boxW - 40 && passFontSize > 18) {
                    passFontSize -= 2;
                    ctx.font = `700 ${passFontSize}px "Courier New", monospace`;
                }
                const passX = boxX + boxW / 2;
                const passY = boxY + boxH / 2 + passFontSize / 3;
                ctx.fillText(text, passX, passY);

                // instrução abaixo
                ctx.textAlign = 'left';
                ctx.fillStyle = 'rgba(17,24,39,0.6)';
                ctx.font = '13px Inter, system-ui, sans-serif';
                ctx.fillText('Guarde em um lugar seguro.', boxX + 8, boxY + boxH + 28);

                canvas.toBlob((blob) => {
                    if (!blob) return;
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `${tituloTextSafe}-senha-${Date.now()}.png`;
                    a.click();
                    URL.revokeObjectURL(a.href);
                });
            } catch (err) {
                console.error('Erro ao gerar imagem da senha:', err);
            }
        }, { once: true });
    }

    if (fecharBtn) {
        fecharBtn.addEventListener('click', () => fecharMensagem(false), { once: true });
    }
}
// Compatibilidade com nome acentuado usado no arquivo corrompido
window.mostrarSenhaCombotãoCopiar = mostrarSenhaCombotaoCopiar;

// ====== CREDENCIAIS ANALISADAS ======
let credenciaisAnalisadas = [];
let pessoasOcultas = [];

// ====== APARELHOS CORRELACIONADOS (removidos) ======
// Variáveis relacionadas a aparelhos correlacionados foram removidas.

function carregarPessoasOcultas() {
    try {
        const data = localStorage.getItem('pessoasOcultas');
        pessoasOcultas = data ? JSON.parse(data) : [];
    } catch (_err) {
        pessoasOcultas = [];
    }
}

function salvarPessoasOcultas() {
    try {
        localStorage.setItem('pessoasOcultas', JSON.stringify(pessoasOcultas));
    } catch (err) {
        console.error('Erro ao salvar pessoas ocultas:', err);
    }
}

function normalizarNome(nome) {
    if (!nome || typeof nome !== 'string') return '';
    return nome.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
}

function obterIniciais(nome) {
    if (!nome || typeof nome !== 'string') return '?';
    const palavras = nome.trim().split(/\s+/).filter((p) => p.length > 0);
    if (palavras.length === 0) return '?';
    if (palavras.length === 1) return palavras[0][0].toUpperCase();
    return (palavras[0][0] + palavras[palavras.length - 1][0]).toUpperCase();
}

function gerarCorAvatar(nome) {
    if (!nome) return '#007aff';
    const cores = ['#007aff', '#5856d6', '#af52de', '#ff2d55', '#ff3b30', '#ff9500', '#ffcc00', '#34c759', '#00c7be', '#30b0c7', '#32ade6'];
    let hash = 0;
    for (let i = 0; i < nome.length; i += 1) {
        hash = nome.charCodeAt(i) + ((hash << 5) - hash);
    }
    return cores[Math.abs(hash) % cores.length];
}

function analisarCredenciais() {
    const pessoas = new Map();

    const processCardList = (listaBoards) => {
        listaBoards.forEach((board) => {
            board.cards.forEach((cardCriptografado) => {
                const card = descriptografarCard(cardCriptografado, senhaDigitada);
                if (!card) return;

                const info = {
                    titulo: card.titulo || '',
                    usuario: card.usuario || '',
                    email: card.email || '',
                    telefone: card.telefone || '',
                    cpf: card.cpf || '',
                    links: card.links || '',
                    notas: card.notas || ''
                };

                let nomeIdentificado = null;

                if (info.usuario) {
                    const palavras = info.usuario.trim().split(/\s+/);
                    if (palavras.length >= 2 && !info.usuario.includes('@') && !info.usuario.match(/^\d+$/)) {
                        nomeIdentificado = info.usuario;
                    }
                }

                if (!nomeIdentificado && info.titulo) {
                    const palavras = info.titulo.trim().split(/\s+/);
                    if (palavras.length >= 2 && !info.titulo.includes('@') && !info.titulo.match(/^\d+$/)) {
                        nomeIdentificado = info.titulo;
                    }
                }

                if (!nomeIdentificado && info.notas) {
                    const regexNome = /(?:nome|pessoa|usuario|titular|proprietario|dono):\s*([A-Za-zÀ-ÿ][A-Za-zÀ-ÿ]+(?:\s+[A-Za-zÀ-ÿ][A-Za-zÀ-ÿ]+)+)/i;
                    const match = info.notas.match(regexNome);
                    if (match) nomeIdentificado = match[1];
                }

                if (nomeIdentificado) {
                    const nomeNormalizado = normalizarNome(nomeIdentificado);

                    if (!pessoas.has(nomeNormalizado)) {
                        pessoas.set(nomeNormalizado, {
                            nome: nomeIdentificado,
                            emails: new Set(),
                            telefones: new Set(),
                            cpfs: new Set(),
                            links: new Set(),
                            cartoes: []
                        });
                    }

                    const pessoa = pessoas.get(nomeNormalizado);
                    if (info.email) pessoa.emails.add(info.email);
                    if (info.telefone) pessoa.telefones.add(info.telefone);
                    if (info.cpf) pessoa.cpfs.add(info.cpf);
                    if (info.links) pessoa.links.add(info.links);
                }
            });
        });
    };

    processCardList(boards || []);
    processCardList(anotacoesBoards || []);

    const todosCartoes = [];

    try {
        const cartaoPadraoStr = localStorage.getItem('cartãoPadrao');
        if (cartaoPadraoStr) {
            const cartaoPadrao = JSON.parse(cartaoPadraoStr);
            if (cartaoPadrao && cartaoPadrao.titular && cartaoPadrao.numero) {
                todosCartoes.push(cartaoPadrao);
            }
        }
    } catch (err) {
        console.error('[CREDENCIAIS] Erro ao processar cartão padrão:', err);
    }

    const extrairCartoes = (listaBoards) => {
        listaBoards.forEach((board) => {
            board.cards.forEach((cardCriptografado) => {
                const card = descriptografarCard(cardCriptografado, senhaDigitada);
                if (!card) return;

                const cartões = card.cartoes || card.cartões || card.cartao || card.cartão;
                if (!cartões) return;

                if (Array.isArray(cartões)) {
                    cartões.forEach((cartao) => {
                        if (cartao && cartao.titular && cartao.numero) todosCartoes.push(cartao);
                    });
                } else if (typeof cartões === 'object' && cartões.titular && cartões.numero) {
                    todosCartoes.push(cartões);
                }
            });
        });
    };

    extrairCartoes(boards || []);
    extrairCartoes(anotacoesBoards || []);

    todosCartoes.forEach((cartao) => {
        try {
            const nomeBase = (cartao.titular && cartao.titular.trim()) ? cartao.titular.trim() : 'Cartão salvo';
            const titularNormalizado = normalizarNome(nomeBase) || `cartao-${cartao.numero || Math.random()}`;

            if (!pessoas.has(titularNormalizado)) {
                pessoas.set(titularNormalizado, {
                    nome: nomeBase,
                    emails: new Set(),
                    telefones: new Set(),
                    cpfs: new Set(),
                    links: new Set(),
                    cartoes: []
                });
            }
            const pessoa = pessoas.get(titularNormalizado);
            const existe = pessoa.cartoes.some((c) => c.numero === cartao.numero && c.validade === cartao.validade);
            if (!existe) pessoa.cartoes.push(cartao);
        } catch (err) {
            console.error('[CREDENCIAIS] Erro ao processar cartão:', err);
        }
    });

    credenciaisAnalisadas = Array.from(pessoas.values()).map((pessoa) => ({
        nome: pessoa.nome,
        emails: Array.from(pessoa.emails),
        telefones: Array.from(pessoa.telefones),
        cpfs: Array.from(pessoa.cpfs),
        links: Array.from(pessoa.links),
        cartoes: pessoa.cartoes
    }));

    // mesclar aparelhos persistidos por credencial (se existirem)
    try{
        const map = JSON.parse(localStorage.getItem('mi_cred_aparelhos')||'{}');
        if(map && Object.keys(map).length){
            console.log('analisarCredenciais: aplicando aparelhos persistidos por credencial', Object.keys(map));
            credenciaisAnalisadas.forEach(p=>{
                const key = normalizarNome(p.nome || p.id || p.email || '');
                if(map[key] && map[key].length){
                    p.aparelhos = (p.aparelhos||[]).concat(map[key]);
                    console.log('analisarCredenciais: anexei', map[key].length, 'aparelhos a', p.nome, 'key', key);
                }
            });
        }
    }catch(e){ console.warn('analisarCredenciais: erro ao mesclar aparelhos', e); }

    atualizarUICredenciais();
}

function atualizarUICredenciais() {
    const box = document.getElementById('credenciais-analisadas-box');
    const boxAnotacao = document.getElementById('credenciais-analisadas-box-anotacao');
    const countSenha = document.getElementById('credenciais-analisadas-count');
    const countAnotacao = document.getElementById('credenciais-analisadas-count-anotacao');

    if (countSenha) countSenha.textContent = credenciaisAnalisadas.length;
    if (countAnotacao) countAnotacao.textContent = credenciaisAnalisadas.length;

    if (credenciaisAnalisadas.length > 0) {
        if (box) box.style.display = 'flex';
        if (boxAnotacao) boxAnotacao.style.display = 'flex';
    } else {
        if (box) box.style.display = 'none';
        if (boxAnotacao) boxAnotacao.style.display = 'none';
    }

    // notificar listeners para atualizar selects/visões dependentes
    try{ document.dispatchEvent(new Event('credenciaisUpdated')); }catch(e){}
}

function renderizarListaPessoas() {
    const container = document.getElementById('pessoas-lista-container');
    if (!container) return;

    carregarPessoasOcultas();
    container.innerHTML = '';

    const pessoasVisiveis = credenciaisAnalisadas.filter((pessoa) => !pessoasOcultas.includes(normalizarNome(pessoa.nome)));
    const pessoasOcultasData = credenciaisAnalisadas.filter((pessoa) => pessoasOcultas.includes(normalizarNome(pessoa.nome)));

    if (credenciaisAnalisadas.length === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 40px;">Nenhuma credencial analisada encontrada.</p>';
        return;
    }

    if (pessoasVisiveis.length === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">Todas as credenciais estão ocultas.</p>';
    } else {
        // anexar aparelhos persistidos (por credencial) antes de renderizar
        try{
            const _map = JSON.parse(localStorage.getItem('mi_cred_aparelhos')||'{}');
            console.log('renderizarListaPessoas: mi_cred_aparelhos map keys:', Object.keys(_map));
            pessoasVisiveis.forEach(p => { const key = normalizarNome(p.nome||''); const stored = _map[key] || []; if(stored && stored.length){ p.aparelhos = (p.aparelhos||[]).concat(stored); console.log('renderizarListaPessoas: carreguei aparelhos de storage para', p.nome, stored.length, 'key', key); } });
        }catch(e){ console.warn('Erro ao carregar aparelhos persistidos', e); }

        // DEBUG: mostrar quantos aparelhos cada pessoa tem agora
        try{ pessoasVisiveis.forEach(p=>{ console.log('renderizarListaPessoas: pessoa', p.nome, 'aparelhosCount', (p.aparelhos||[]).length); }); }catch(e){}

        pessoasVisiveis.forEach((pessoa) => {
            const indexOriginal = credenciaisAnalisadas.indexOf(pessoa);
            const card = document.createElement('div');
            card.className = 'pessoa-card';
            card.style.position = 'relative';

            const iniciais = obterIniciais(pessoa.nome);
            const cor = gerarCorAvatar(pessoa.nome);

            const detalhesCount = pessoa.emails.length + pessoa.telefones.length + pessoa.cpfs.length + pessoa.links.length + pessoa.cartoes.length;

            card.innerHTML = `
                <button class="btn-ocultar-pessoa" onclick="event.stopPropagation(); ocultarPessoa('${normalizarNome(pessoa.nome)}');" title="Ocultar credencial">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
                <div class="pessoa-avatar" style="background-color: ${cor};">${iniciais}</div>
                <div class="pessoa-info">
                    <div class="pessoa-nome">${pessoa.nome}</div>
                    <div class="pessoa-detalhes-count">${detalhesCount} informação${detalhesCount !== 1 ? 's' : ''}</div>
                </div>
            `;

            // Remover atalhos/atalhos de aparelhos indesejados dentro do card (defensivo)
            try{
                const onclickElems = card.querySelectorAll('[onclick]');
                onclickElems.forEach(el=>{
                    const attr = (el.getAttribute('onclick')||'').toString();
                    if(attr.includes('abrirModalMiManager') || attr.includes('abrirModalCredenciais') || attr.includes('modal-aparelho') || attr.includes('mi_showDeviceDetailsById')){
                        el.remove();
                    }
                });
            }catch(e){}




            card.onclick = (e) => {
                if (!e.target.closest('.btn-ocultar-pessoa')) {
                    mostrarDetalhesPessoa(indexOriginal);
                }
            };

            container.appendChild(card);
        });
    }

    if (pessoasOcultasData.length > 0) {
        const ocultasSection = document.createElement('div');
        ocultasSection.className = 'credenciais-ocultas-section';

        ocultasSection.innerHTML = `
            <div class="credenciais-ocultas-header" onclick="toggleCredenciaisOcultas()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
                <h3>Credenciais ocultas (${pessoasOcultasData.length})</h3>
            </div>
            <div class="credenciais-ocultas-lista" id="credenciais-ocultas-lista"></div>
        `;

        container.appendChild(ocultasSection);

        const listaOcultas = document.getElementById('credenciais-ocultas-lista');
        pessoasOcultasData.forEach((pessoa) => {
            const indexOriginal = credenciaisAnalisadas.indexOf(pessoa);
            const card = document.createElement('div');
            card.className = 'pessoa-card pessoa-card-oculta';
            card.style.position = 'relative';

            const iniciais = obterIniciais(pessoa.nome);
            const cor = gerarCorAvatar(pessoa.nome);

            const detalhesCount = pessoa.emails.length + pessoa.telefones.length + pessoa.cpfs.length + pessoa.links.length + pessoa.cartoes.length;

            card.innerHTML = `
                <button class="btn-reexibir-pessoa" onclick="event.stopPropagation(); reexibirPessoa('${normalizarNome(pessoa.nome)}');" title="Reexibir credencial">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <div class="pessoa-avatar" style="background-color: ${cor};">${iniciais}</div>
                <div class="pessoa-info">
                    <div class="pessoa-nome">${pessoa.nome}</div>
                    <div class="pessoa-detalhes-count">${detalhesCount} informação${detalhesCount !== 1 ? 's' : ''}</div>
                </div>
            `;

            card.onclick = (e) => {
                if (!e.target.closest('.btn-reexibir-pessoa')) {
                    mostrarDetalhesPessoa(indexOriginal);
                }
            };

            if (listaOcultas) listaOcultas.appendChild(card);
        });
    }
}

function mostrarDetalhesPessoa(index) {
    const pessoa = credenciaisAnalisadas[index];
    const listaContainer = document.getElementById('pessoas-lista-container');
    const detalhesContainer = document.getElementById('pessoa-detalhes-container');
    const modalContent = document.querySelector('.modal-credenciais-content');
    if (!pessoa || !listaContainer || !detalhesContainer) return;

    listaContainer.style.display = 'none';
    detalhesContainer.style.display = 'block';

    const iniciais = obterIniciais(pessoa.nome);
    const cor = gerarCorAvatar(pessoa.nome);

    let detalhesHTML = `
        <button class="btn-voltar-lista" onclick="voltarListaPessoas()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Voltar
        </button>
        <div class="pessoa-detalhes-header">
            <div class="pessoa-avatar" style="background-color: ${cor};">${iniciais}</div>
            <div class="pessoa-detalhes-info">
                <div class="pessoa-detalhes-nome">${pessoa.nome}</div>
            </div>
        </div>
        <div class="pessoa-detalhes-body">
    `;

    pessoa.emails.forEach((email) => {
        detalhesHTML += `
            <div class="detalhe-item">
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"></path>
                        <polyline points="22 6 12 13 2 6"></polyline>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">E-mail</div>
                    <div class="detalhe-valor">${email}</div>
                </div>
            </div>
        `;
    });

    pessoa.telefones.forEach((telefone) => {
        detalhesHTML += `
            <div class="detalhe-item">
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 16.92a1.93 1.93 0 0 1-2.12 1.92 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A1.93 1.93 0 0 1 4.12 2h3a2 2 0 0 1 2 1.72 12.86 12.86 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.86 12.86 0 0 0 2.81.7A2 2 0 0 1 22 16.92Z"></path>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">Telefone</div>
                    <div class="detalhe-valor">${telefone}</div>
                </div>
            </div>
        `;
    });

    pessoa.cpfs.forEach((cpf) => {
        detalhesHTML += `
            <div class="detalhe-item">
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">CPF</div>
                    <div class="detalhe-valor">${cpf}</div>
                </div>
            </div>
        `;
    });

    pessoa.links.forEach((link) => {
        let linkAbreviado = link;
        try {
            const url = new URL(link);
            linkAbreviado = url.hostname.replace('www.', '');
        } catch (_err) {
            linkAbreviado = link.length > 30 ? `${link.substring(0, 30)}...` : link;
        }

        detalhesHTML += `
            <div class="detalhe-item">
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">Link</div>
                    <div class="detalhe-valor"><a href="${link}" target="_blank" rel="noopener noreferrer">${linkAbreviado}</a></div>
                </div>
            </div>
        `;
    });

    pessoa.cartoes.forEach((cartao, idx) => {
        let numeroMascarado = cartao.numero;
        if (numeroMascarado && numeroMascarado.length >= 4) {
            const ultimos4 = numeroMascarado.slice(-4);
            numeroMascarado = '•••• •••• •••• ' + ultimos4;
        } else if (numeroMascarado) {
            numeroMascarado = '••••';
        }

        const cartaoId = `cartao-${idx}`;

        detalhesHTML += `
            <div class="detalhe-item">
                <button class="btn-revelar-cartao" onclick="toggleCartaoVisibilidade('${cartaoId}')" title="Mostrar/Ocultar">
                    <svg id="${cartaoId}-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">Cartão ${cartao.bandeira || ''}</div>
                    <div class="detalhe-valor">
                        <span id="${cartaoId}-numero">${numeroMascarado}</span>
                        <span id="${cartaoId}-numero-completo" style="display: none;">${cartao.numero}</span>
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 4px;">
                        <div id="${cartaoId}-validade">${cartao.validade ? `Validade: ${cartao.validade}` : ''}</div>
                        <div id="${cartaoId}-cvv" style="display: none; margin-top: 2px;">${cartao.cvv ? `CVV: ${cartao.cvv}` : ''}</div>
                    </div>
                </div>
            </div>
        `;
    });

    // inserir seção de aparelhos vinculados (como cartões, dentro do painel de detalhes)
    detalhesHTML += `<div class="aparelhos-section"><h4 style="margin-top:12px">Aparelhos vinculados</h4>`;
    try{
        const seen = new Set();
        if(pessoa.aparelhos && pessoa.aparelhos.length){
            detalhesHTML += '<div class="pessoa-aparelhos-grid">';
            pessoa.aparelhos.forEach((d)=>{
                if(!d) return;
                if(d.id && seen.has(d.id)) return;
                if(d.id) seen.add(d.id);
                const t = (d.deviceType||'').toLowerCase();
                let iconSvg = '';
                if(t.includes('celular')||t.includes('phone')||t.includes('mobile')){
                    iconSvg = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="18" rx="2"></rect><circle cx="12" cy="18" r="0.7"></circle></svg>';
                } else if(t.includes('tablet')){
                    iconSvg = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="3" width="14" height="18" rx="2"></rect></svg>';
                } else {
                    iconSvg = '<svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="12" rx="2"></rect></svg>';
                }
                detalhesHTML += `
                    <div class="aparelho-card" tabindex="0" onclick="window.mi_showDeviceDetailsById && window.mi_showDeviceDetailsById('${d.id}')">
                        <div class="aparelho-icon" aria-hidden="true">${iconSvg}</div>
                        <div class="aparelho-info">
                            <div class="aparelho-nome">${d.name || d.deviceType || 'Aparelho'}</div>
                            <div class="aparelho-detalhes">${d.deviceType?d.deviceType:''} ${d.imei?(' • '+d.imei):''}</div>
                        </div>
                    </div>
                `;
            });
            detalhesHTML += '</div>';
        } else {
            detalhesHTML += '<div class="pessoa-aparelhos-grid"><div class="aparelho-empty" style="opacity:.7;padding:12px">Nenhum aparelho vinculado</div></div>';
        }
    }catch(e){ console.warn('Erro ao renderizar aparelhos da pessoa', e); detalhesHTML += '<div class="pessoa-aparelhos-grid"><div class="aparelho-empty" style="opacity:.7;padding:12px">Erro ao carregar aparelhos</div></div>'; }
    detalhesHTML += '</div>';

    detalhesHTML += '</div>';
    detalhesContainer.innerHTML = detalhesHTML;

    if (modalContent) modalContent.scrollTop = 0;
}

function voltarListaPessoas() {
    const listaContainer = document.getElementById('pessoas-lista-container');
    const detalhesContainer = document.getElementById('pessoa-detalhes-container');
    const modalContent = document.querySelector('.modal-credenciais-content');
    if (!listaContainer || !detalhesContainer) return;

    listaContainer.style.display = 'grid';
    detalhesContainer.style.display = 'none';
    if (modalContent) modalContent.scrollTop = 0;
}

function ocultarPessoa(nomeNormalizado) {
    if (!pessoasOcultas.includes(nomeNormalizado)) {
        pessoasOcultas.push(nomeNormalizado);
        salvarPessoasOcultas();
        renderizarListaPessoas();
    }
}

function reexibirPessoa(nomeNormalizado) {
    pessoasOcultas = pessoasOcultas.filter((nome) => nome !== nomeNormalizado);
    salvarPessoasOcultas();
    renderizarListaPessoas();
}

function toggleCredenciaisOcultas() {
    const header = document.querySelector('.credenciais-ocultas-header');
    const lista = document.getElementById('credenciais-ocultas-lista');
    if (header) header.classList.toggle('expandido');
    if (lista) lista.classList.toggle('expandido');
}

function toggleCartaoVisibilidade(cartaoId) {
    const numeroMascarado = document.getElementById(`${cartaoId}-numero`);
    const numeroCompleto = document.getElementById(`${cartaoId}-numero-completo`);
    const cvv = document.getElementById(`${cartaoId}-cvv`);
    const icon = document.getElementById(`${cartaoId}-icon`);
    if (!numeroMascarado || !numeroCompleto || !icon) return;

    const mostrandoCompleto = numeroCompleto.style.display !== 'none';
    if (!mostrandoCompleto) {
        numeroMascarado.style.display = 'none';
        numeroCompleto.style.display = 'inline';
        if (cvv) cvv.style.display = 'block';
        icon.innerHTML = `
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
    } else {
        numeroMascarado.style.display = 'inline';
        numeroCompleto.style.display = 'none';
        if (cvv) cvv.style.display = 'none';
        icon.innerHTML = `
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        `;
    }
}

function carregarAparelhosOcultos() { /* removido: aparelhos correlacionados */ }

function salvarAparelhosOcultos() { /* removido: aparelhos correlacionados */ }

function renderizarListaAparelhos() {
    // removido: lista de aparelhos correlacionados desativada
    try {
        const container = document.getElementById('aparelhos-lista-container');
        if (container) container.innerHTML = '<p style="text-align:center; opacity:0.7; padding:20px;">Funcionalidade de aparelhos removida.</p>';
    } catch (_) {}
}

function voltarListaAparelhos() { /* Aparelhos correlacionados removidos */ }

function ocultarAparelho(id) { /* Aparelhos correlacionados removidos */ }

function reexibirAparelho(id) { /* Aparelhos correlacionados removidos */ }

function toggleAparelhosOcultos() { /* Aparelhos correlacionados removidos */ }

function getAparelhoIcon(tipo) {
    const icons = {
        'celular': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',
        'pc': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>',
        'tablet': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>',
        'outros': '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>'
    };
    return icons[tipo] || icons['outros'];
}

function mostrarDetalhesAparelho(id) {
    // removido: detalhes de aparelhos correlacionados desativados
}
 

function toggleAparelhoSenha(id) {
    const senhaMascarada = document.getElementById(`aparelho-${id}-senha`);
    const senhaCompleta = document.getElementById(`aparelho-${id}-senha-completa`);
    const icon = document.getElementById(`aparelho-${id}-toggle-senha`).querySelector('svg');
    if (!senhaMascarada || !senhaCompleta || !icon) return;

    const mostrandoCompleto = senhaCompleta.style.display !== 'none';
    if (!mostrandoCompleto) {
        senhaMascarada.style.display = 'none';
        senhaCompleta.style.display = 'inline';
        icon.innerHTML = `
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
    } else {
        senhaMascarada.style.display = 'inline';
        senhaCompleta.style.display = 'none';
        icon.innerHTML = `
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        `;
    }
}

function toggleAparelhoAppSenha(id) {
    const senhaMascarada = document.getElementById(`aparelho-${id}-app-senha`);
    const senhaCompleta = document.getElementById(`aparelho-${id}-app-senha-completa`);
    const icon = document.getElementById(`aparelho-${id}-toggle-app-senha`).querySelector('svg');
    if (!senhaMascarada || !senhaCompleta || !icon) return;

    const mostrandoCompleto = senhaCompleta.style.display !== 'none';
    if (!mostrandoCompleto) {
        senhaMascarada.style.display = 'none';
        senhaCompleta.style.display = 'inline';
        icon.innerHTML = `
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
    } else {
        senhaMascarada.style.display = 'inline';
        senhaCompleta.style.display = 'none';
        icon.innerHTML = `
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        `;
    }
}

function handleTipoSenhaChange(id) {
    try {
        const select = document.getElementById(`aparelho-${id}-tipo-senha`);
        const stepsContainer = document.getElementById(`aparelho-${id}-senha-steps`);
        const senhaCompletaEl = document.getElementById(`aparelho-${id}-senha-completa`);
        const senhaMascaradaEl = document.getElementById(`aparelho-${id}-senha`);
        if (!select || !stepsContainer || !senhaCompletaEl || !senhaMascaradaEl) return;

        const tipo = select.value;
        const full = senhaCompletaEl.textContent || '';

        // Reset
        stepsContainer.innerHTML = '';
        stepsContainer.style.display = 'none';
        senhaMascaradaEl.style.display = 'inline';
        senhaCompletaEl.style.display = 'none';

        if (tipo === 'traco') {
            // Mostrar caixa Xiaomi
            const box = document.createElement('div');
            box.className = 'xiaomi-steps-box';

            const header = document.createElement('div');
            header.className = 'xiaomi-steps-header';
            header.textContent = 'Passo a passo';
            box.appendChild(header);

            const list = document.createElement('div');
            list.className = 'xiaomi-steps-list';

            // Verificar se há passos salvos no editor ou traços na senha
            const savedSteps = getCurrentSteps() || [];
            if (savedSteps && savedSteps.length) {
                savedSteps.forEach((part, i) => {
                    const step = document.createElement('div');
                    step.className = 'xiaomi-step';

                    const num = document.createElement('div');
                    num.className = 'xiaomi-step-number';
                    num.textContent = (i + 1).toString();

                    const desc = document.createElement('div');
                    desc.className = 'xiaomi-step-desc';
                    desc.textContent = part;

                    step.appendChild(num);
                    step.appendChild(desc);
                    list.appendChild(step);
                });
            } else if (full.includes('-')) {
                const parts = full.split('-').map(p => p.trim()).filter(Boolean);
                parts.forEach((part, i) => {
                    const step = document.createElement('div');
                    step.className = 'xiaomi-step';

                    const num = document.createElement('div');
                    num.className = 'xiaomi-step-number';
                    num.textContent = (i + 1).toString();

                    const desc = document.createElement('div');
                    desc.className = 'xiaomi-step-desc';
                    desc.textContent = part;

                    step.appendChild(num);
                    step.appendChild(desc);
                    list.appendChild(step);
                });
            } else {
                const noSteps = document.createElement('div');
                noSteps.className = 'xiaomi-step';
                noSteps.innerHTML = '<div class="xiaomi-step-desc" style="text-align:center; color:#666;">Nenhum passo definido. Use traços (-) na senha ou edite passos.</div>';
                list.appendChild(noSteps);
            }

            box.appendChild(list);
            stepsContainer.appendChild(box);
            stepsContainer.style.display = 'block';

            // esconder spans de senha quando mostrando passos
            senhaMascaradaEl.style.display = 'none';
        } else if (tipo === 'pin') {
            // mostrar completa quando for PIN curto
            senhaMascaradaEl.style.display = 'none';
            senhaCompletaEl.style.display = 'inline';
        }
    } catch (e) {
        console.error('Erro em handleTipoSenhaChange:', e);
    }
}

function abrirModalCredenciais() {
    const modal = document.getElementById('modal-credenciais');
    const modalContent = modal ? modal.querySelector('.modal-credenciais-content') : null;
    if (!modal) return;

    // garantir que o modal esteja como último filho do body e forçar prioridade de stacking
    if (modal.parentNode !== document.body) document.body.appendChild(modal);
    modal.style.setProperty('position','fixed','important');
    modal.style.setProperty('z-index','2147483647','important');
    modal.style.setProperty('pointer-events','auto','important');
    if (modalContent) {
        modalContent.style.setProperty('z-index','2147483648','important');
        modalContent.style.setProperty('position','relative','important');
        modalContent.style.setProperty('pointer-events','auto','important');
    }

    renderizarListaPessoas();
    modal.style.display = 'block';
    modal.style.pointerEvents = 'auto';
    document.body.classList.add('modal-open');
    // reforço: reaplicar append e z-index após pequenos delays para vencer alterações de outros scripts/styles
    setTimeout(()=>{ if(modal.parentNode !== document.body) document.body.appendChild(modal); modal.style.setProperty('z-index','2147483647','important'); if(modalContent) modalContent.style.setProperty('z-index','2147483648','important'); },50);
    requestAnimationFrame(()=>{ if(modal.parentNode !== document.body) document.body.appendChild(modal); });
    setTimeout(() => { if (modalContent) modalContent.scrollTop = 0; }, 0);
}

function fecharModalCredenciais() {
    const modal = document.getElementById('modal-credenciais');
    const modalContent = modal ? modal.querySelector('.modal-credenciais-content') : null;
    if (!modal) return;
    modal.style.display = 'none';
    modal.style.pointerEvents = '';
    modal.style.zIndex = '';
    if (modalContent) { modalContent.style.zIndex = ''; modalContent.style.pointerEvents = ''; }
    document.body.classList.remove('modal-open');
    voltarListaPessoas();
}

function abrirModalAparelhos() {
    // removido: funcionalidade de aparelhos correlacionados desativada
}

function fecharModalAparelhos() {
    // removido: funcionalidade de aparelhos correlacionados desativada
}

const credenciaisBox = document.getElementById('credenciais-analisadas-box');
const credenciaisBoxAnotacao = document.getElementById('credenciais-analisadas-box-anotacao');
const fecharCredenciaisBtn = document.getElementById('fechar-credenciais');
const modalCredenciais = document.getElementById('modal-credenciais');

if (credenciaisBox) credenciaisBox.addEventListener('click', abrirModalCredenciais);
if (credenciaisBoxAnotacao) credenciaisBoxAnotacao.addEventListener('click', abrirModalCredenciais);
if (fecharCredenciaisBtn) fecharCredenciaisBtn.addEventListener('click', fecharModalCredenciais);
if (modalCredenciais) {
    modalCredenciais.addEventListener('click', (e) => {
        if (e.target === modalCredenciais) fecharModalCredenciais();
    });
}

// Garantir que alterações externas não escondam o modal-credenciais
(function(){
    const modal = document.getElementById('modal-credenciais');
    if(!modal) return;
    const modalContent = modal.querySelector('.modal-credenciais-content');
    function enforceVisible(){
        try{
            modal.style.setProperty('position','fixed','important');
            modal.style.setProperty('z-index','2147483647','important');
            // não forçar abertura quando qualquer modal adicionar a classe `modal-open` no body
            modal.style.setProperty('display', modal.style.display || 'none','important');
            if(modalContent) {
                modalContent.style.setProperty('z-index','2147483648','important');
                modalContent.style.setProperty('position','relative','important');
                modalContent.style.setProperty('display','grid','important');
                modalContent.style.setProperty('visibility','visible','important');
                modalContent.style.setProperty('opacity','1','important');
            }
        }catch(e){console.error('enforceVisible error',e)}
    }

    // aplicar imediatamente
    enforceVisible();

    // observar mudanças de atributos no modal e no body
    const mo = new MutationObserver((records)=>{
        enforceVisible();
    });
    mo.observe(modal, { attributes: true, attributeFilter: ['style','class'] });
    mo.observe(document.body, { attributes: true, attributeFilter: ['class','style'] });
})();

const btnAdicionarAparelho = document.getElementById('btn-adicionar-aparelho');
if (btnAdicionarAparelho) btnAdicionarAparelho.addEventListener('click', abrirFormularioAdicionarAparelho);

function abrirFormularioAdicionarAparelho() {
    // removido: funcionalidade de aparelhos correlacionados desativada
}

function fecharFormularioAdicionarAparelho() {
    // removido: funcionalidade de aparelhos correlacionados desativada
}

const fecharAdicionarAparelhoBtn = document.getElementById('fechar-adicionar-aparelho');
const btnCancelarAdicionarAparelho = document.getElementById('btn-cancelar-adicionar-aparelho');
const modalAdicionarAparelho = document.getElementById('modal-adicionar-aparelho');
const formAdicionarAparelho = document.getElementById('form-adicionar-aparelho');

if (fecharAdicionarAparelhoBtn) fecharAdicionarAparelhoBtn.addEventListener('click', fecharFormularioAdicionarAparelho);
if (btnCancelarAdicionarAparelho) btnCancelarAdicionarAparelho.addEventListener('click', fecharFormularioAdicionarAparelho);
if (modalAdicionarAparelho) {
    modalAdicionarAparelho.addEventListener('click', (e) => {
        if (e.target === modalAdicionarAparelho) fecharFormularioAdicionarAparelho();
    });
}
if (formAdicionarAparelho) {
    formAdicionarAparelho.addEventListener('submit', (e) => {
        e.preventDefault();
        adicionarAparelho();
    });
}

function adicionarAparelho() {
    // removido: funcionalidade de aparelhos correlacionados desativada
}

function salvarAparelhosCorrelacionados() {
    // removido: funcionalidade de aparelhos correlacionados desativada
}

function carregarAparelhosCorrelacionados() {
    // removido: funcionalidade de aparelhos correlacionados desativada
}

function atualizarContadorAparelhos() {
    // removido: funcionalidade de aparelhos correlacionados desativada
}

// Editor de passos para campo de senha por traço
function initAparelhoSenhaEditor() {
    const select = document.getElementById('aparelho-senha-tipo');
    const btnOpen = document.getElementById('btn-open-xiaomi-editor');

    if (select) {
        select.addEventListener('change', (e) => {
            const editor = document.getElementById('aparelho-senha-steps-editor');
            if (!editor) return;
            if (e.target.value === 'traco') {
                editor.style.display = 'block';
                updatePreviewSteps();
            } else {
                editor.style.display = 'none';
            }
        });
        // set initial visibility based on current value
        try { const editor = document.getElementById('aparelho-senha-steps-editor'); if (editor && select.value === 'traco') editor.style.display='block'; } catch(_){}
    }

    if (btnOpen) btnOpen.addEventListener('click', (e) => { e.preventDefault(); openXiaomiEditor(); });
}

function updatePreviewSteps() {
    const preview = document.getElementById('aparelho-senha-steps-preview');
    if (!preview) return;
    const steps = getCurrentSteps() || [];
    preview.innerHTML = '';
    if (!steps.length) {
        preview.innerHTML = '<p style="color:#666;">Nenhum passo adicionado ainda.</p>';
        return;
    }
    const list = document.createElement('div');
    list.className = 'xiaomi-steps-list';
    steps.forEach((part, i) => {
        const step = document.createElement('div');
        step.className = 'xiaomi-step';
        const num = document.createElement('div');
        num.className = 'xiaomi-step-number';
        num.textContent = (i + 1).toString();
        const desc = document.createElement('div');
        desc.className = 'xiaomi-step-desc';
        desc.textContent = part;
        step.appendChild(num);
        step.appendChild(desc);
        list.appendChild(step);
    });
    preview.appendChild(list);
}

function getCurrentSteps() {
    return Array.isArray(window.currentAparelhoSteps) ? window.currentAparelhoSteps.slice() : [];
}

function setCurrentSteps(steps) {
    if (!Array.isArray(steps)) return;
    window.currentAparelhoSteps = steps.slice();
    try { updatePreviewSteps(); } catch(_){}
}

document.addEventListener('DOMContentLoaded', () => {
    try { initAparelhoSenhaEditor(); } catch (e) { /* ignore */ }
});

// Caixa flutuante de simulação Xiaomi - abre passos um a um
function openXiaomiSteps(aparelhoId) {
    try {
        // Aparelhos correlacionados removidos: usar passos atualmente definidos no editor
        let steps = getCurrentSteps() || [];
        // Se recebeu um parâmetro que contém passos no formato '1-2-3', tentar usá-lo
        if ((!steps || !steps.length) && aparelhoId && String(aparelhoId).match(/^[0-9]+(-[0-9]+)+$/)) {
            steps = String(aparelhoId).split('-').map(s => s.trim()).filter(Boolean);
        }
        if (!steps || !steps.length) {
            // criar overlay/box mínimos pois não há passos
            closeXiaomiSteps();
            const overlay = document.createElement('div');
            overlay.id = 'xiaomi-floating-overlay';
            overlay.tabIndex = -1;
            const box = document.createElement('div');
            box.className = 'xiaomi-floating-box';
            const title = document.createElement('div');
            title.className = 'xiaomi-floating-title';
            title.textContent = 'Simulação Xiaomi — Siga cada traço';
            box.appendChild(title);

            // mostrar mensagem na caixa
            const stepHolder = document.createElement('div');
            stepHolder.className = 'xiaomi-floating-step-holder';
            stepHolder.innerHTML = '<p style="text-align:center; color:#666;">Nenhum passo definido para este aparelho. Edite os passos no formulário de adição.</p>';
            box.appendChild(stepHolder);

            const controls = document.createElement('div');
            controls.className = 'xiaomi-floating-controls';
            const btnClose = document.createElement('button'); btnClose.type='button'; btnClose.className='xiaomi-btn primary'; btnClose.textContent='Fechar';
            controls.appendChild(btnClose);
            box.appendChild(controls);

            overlay.appendChild(box);
            document.body.appendChild(overlay);

            btnClose.addEventListener('click', () => closeXiaomiSteps());
            overlay.addEventListener('click', (e) => { if (e.target === overlay) closeXiaomiSteps(); });
            return;
        }

        // criar overlay
        closeXiaomiSteps();
        const overlay = document.createElement('div');
        overlay.id = 'xiaomi-floating-overlay';
        overlay.tabIndex = -1;

        const box = document.createElement('div');
        box.className = 'xiaomi-floating-box';

        const title = document.createElement('div');
        title.className = 'xiaomi-floating-title';
        title.textContent = 'Simulação Xiaomi — Siga cada traço';
        box.appendChild(title);

        const progress = document.createElement('div');
        progress.className = 'xiaomi-floating-progress';
        box.appendChild(progress);

        const gridContainer = document.createElement('div');
        gridContainer.className = 'xiaomi-grid-container';
        box.appendChild(gridContainer);

        // Criar grade de 9 pontos
        const grid = document.createElement('div');
        grid.className = 'xiaomi-grid';
        for (let i = 0; i < 9; i++) {
            const point = document.createElement('div');
            point.className = 'xiaomi-point';
            grid.appendChild(point);
        }
        gridContainer.appendChild(grid);

        const canvas = document.createElement('canvas');
        canvas.className = 'xiaomi-canvas';
        canvas.width = 300;
        canvas.height = 300;
        gridContainer.appendChild(canvas);
        const ctx = canvas.getContext('2d');

        function getPointPos(index) {
            const row = Math.floor(index / 3);
            const col = index % 3;
            return { x: 12 + col * 128, y: 12 + row * 128 };
        }

        function drawPath(pathStr) {
            const points = pathStr.split('-').map(Number);
            ctx.strokeStyle = '#ff3b30';
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.shadowColor = 'rgba(255, 59, 48, 0.5)';
            ctx.shadowBlur = 4;
            for (let i = 1; i < points.length; i++) {
                const p1 = getPointPos(points[i-1]);
                const p2 = getPointPos(points[i]);
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();
            }
        }

        const stepHolder = document.createElement('div');
        stepHolder.className = 'xiaomi-floating-step-holder';
        box.appendChild(stepHolder);

        const controls = document.createElement('div');
        controls.className = 'xiaomi-floating-controls';

        const btnPrev = document.createElement('button'); btnPrev.type='button'; btnPrev.className='xiaomi-btn'; btnPrev.textContent='Anterior';
        const btnNext = document.createElement('button'); btnNext.type='button'; btnNext.className='xiaomi-btn primary'; btnNext.textContent='Próximo';
        const btnClose = document.createElement('button'); btnClose.type='button'; btnClose.className='xiaomi-btn ghost'; btnClose.textContent='Fechar';

        controls.appendChild(btnPrev); controls.appendChild(btnNext); controls.appendChild(btnClose);
        box.appendChild(controls);

        overlay.appendChild(box);
        document.body.appendChild(overlay);

        let idx = 0;
        const completed = new Array(steps.length).fill(false);

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (steps[idx]) {
                drawPath(steps[idx]);
            }
            progress.innerHTML = `${idx+1} / ${steps.length}`;
            stepHolder.innerHTML = '';
            const stepCard = document.createElement('div');
            stepCard.className = 'xiaomi-step-card';

            const num = document.createElement('div'); num.className='xiaomi-step-card-num'; num.textContent = String(idx+1);
            const txt = document.createElement('div'); txt.className='xiaomi-step-card-txt'; txt.textContent = `Pontos: ${steps[idx]}`;
            const mark = document.createElement('button'); mark.type='button'; mark.className='xiaomi-mark-btn'; mark.textContent = completed[idx] ? 'Concluído' : 'Marcar como concluído';

            mark.addEventListener('click', () => { completed[idx] = !completed[idx]; render(); });

            stepCard.appendChild(num); stepCard.appendChild(txt); stepCard.appendChild(mark);
            stepHolder.appendChild(stepCard);

            // atualizar botões
            btnPrev.disabled = idx === 0;
            btnNext.textContent = (idx === steps.length -1) ? 'Finalizar' : 'Próximo';
            if (completed.every(Boolean)) btnNext.classList.add('completed'); else btnNext.classList.remove('completed');
        }

        btnPrev.addEventListener('click', () => { if (idx>0) { idx--; render(); } });
        btnNext.addEventListener('click', () => { if (idx < steps.length-1) { idx++; render(); } else { closeXiaomiSteps(); alert('Simulação concluída.'); } });
        btnClose.addEventListener('click', () => { closeXiaomiSteps(); });

        overlay.addEventListener('click', (e) => { if (e.target === overlay) closeXiaomiSteps(); });

        // teclas
        function onKey(e) {
            if (!document.getElementById('xiaomi-floating-overlay')) return;
            if (e.key === 'ArrowRight') btnNext.click();
            if (e.key === 'ArrowLeft') btnPrev.click();
            if (e.key === 'Escape') closeXiaomiSteps();
        }
        document.addEventListener('keydown', onKey);

        // referência para remoção
        overlay.__xiaomiCleanup = () => { document.removeEventListener('keydown', onKey); };

        render();
    } catch (e) { console.error('Erro ao abrir simulação Xiaomi:', e); }
}

function closeXiaomiSteps() {
    const existing = document.getElementById('xiaomi-floating-overlay');
    if (existing) {
        try { if (existing.__xiaomiCleanup) existing.__xiaomiCleanup(); } catch (_){ }
        existing.remove();
    }
}

// Caixa flutuante para edição de passos Xiaomi com grade de 9 pontos
function openXiaomiEditor() {
    closeXiaomiSteps();
    const overlay = document.createElement('div');
    overlay.id = 'xiaomi-floating-overlay';
    overlay.tabIndex = -1;

    const box = document.createElement('div');
    box.className = 'xiaomi-floating-box';

    const title = document.createElement('div');
    title.className = 'xiaomi-floating-title';
    title.textContent = 'Editar senha por traço Xiaomi';
    box.appendChild(title);

    const gridContainer = document.createElement('div');
    gridContainer.className = 'xiaomi-grid-container';
    box.appendChild(gridContainer);

    const stepHolder = document.createElement('div');
    stepHolder.className = 'xiaomi-floating-step-holder';
    box.appendChild(stepHolder);

    const controls = document.createElement('div');
    controls.className = 'xiaomi-floating-controls';

    const btnAdd = document.createElement('button'); btnAdd.type='button'; btnAdd.className='xiaomi-btn'; btnAdd.textContent='Novo passo';
    const btnSave = document.createElement('button'); btnSave.type='button'; btnSave.className='xiaomi-btn primary'; btnSave.textContent='Salvar';
    const btnClose = document.createElement('button'); btnClose.type='button'; btnClose.className='xiaomi-btn ghost'; btnClose.textContent='Cancelar';

    controls.appendChild(btnAdd); controls.appendChild(btnSave); controls.appendChild(btnClose);
    box.appendChild(controls);

    overlay.appendChild(box);
    document.body.appendChild(overlay);

    let steps = getCurrentSteps().slice(); // cópia
    let currentPath = []; // pontos atuais do passo
    let isDrawing = false;

    // Criar grade de 9 pontos
    const grid = document.createElement('div');
    grid.className = 'xiaomi-grid';
    for (let i = 0; i < 9; i++) {
        const point = document.createElement('div');
        point.className = 'xiaomi-point';
        point.dataset.index = i;
        point.addEventListener('mousedown', startDraw);
        point.addEventListener('mouseenter', continueDraw);
        grid.appendChild(point);
    }
    gridContainer.appendChild(grid);

    const canvas = document.createElement('canvas');
    canvas.className = 'xiaomi-canvas';
    gridContainer.appendChild(canvas);
    const ctx = canvas.getContext('2d');

    // Ajusta o tamanho do canvas dinamicamente e calcula posições de pontos
    function setupCanvasSize() {
        const maxSize = 300;
        const padding = 12;
        const available = Math.min(maxSize, Math.floor(gridContainer.clientWidth) - 20);
        const size = Math.max(220, available);
        canvas.width = size;
        canvas.height = size;
        canvas.style.width = size + 'px';
        canvas.style.height = size + 'px';
    }

    function getPointPos(index) {
        const row = Math.floor(index / 3);
        const col = index % 3;
        const padding = 12;
        const spacing = (canvas.width - padding * 2) / 2; // 2 intervals between 3 columns
        return { x: Math.round(padding + col * spacing), y: Math.round(padding + row * spacing) };
    }

    function drawLine(from, to) {
        const p1 = getPointPos(from);
        const p2 = getPointPos(to);
        ctx.strokeStyle = '#ff3b30';
        ctx.lineWidth = Math.max(5, Math.round(canvas.width * 0.02));
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.shadowColor = 'rgba(255, 59, 48, 0.12)';
        ctx.shadowBlur = 2;
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.lineTo(p2.x, p2.y);
        ctx.stroke();
    }

    // inicializar tamanho
    setupCanvasSize();
    // atualizar em resize
    const roEditor = new ResizeObserver(() => { setupCanvasSize(); clearCanvas(); });
    roEditor.observe(gridContainer);

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function startDraw(e) {
        const index = parseInt(e.target.dataset.index);
        if (!isDrawing) {
            isDrawing = true;
            currentPath = [index];
            clearCanvas();
        } else {
            if (!currentPath.includes(index)) {
                currentPath.push(index);
                if (currentPath.length > 1) {
                    drawLine(currentPath[currentPath.length - 2], index);
                }
            }
        }
        if (e && e.preventDefault) e.preventDefault();
    }

    function continueDraw(e) {
        if (!isDrawing) return;
        const index = parseInt(e.target.dataset.index);
        if (!currentPath.includes(index)) {
            currentPath.push(index);
            if (currentPath.length > 1) {
                drawLine(currentPath[currentPath.length - 2], index);
            }
        }
    }

    document.addEventListener('mouseup', () => {
        if (isDrawing) {
            isDrawing = false;
            if (currentPath.length > 1) {
                steps.push(currentPath.join('-'));
                renderSteps();
                currentPath = [];
                clearCanvas();
            }
        }
    });

    // Suporte a toque: detectar pontos via elementFromPoint durante o movimento
    gridContainer.addEventListener('touchstart', function (ev) {
        ev.preventDefault();
        const t = ev.touches[0];
        const el = document.elementFromPoint(t.clientX, t.clientY);
        if (el && el.classList.contains('xiaomi-point')) startDraw({ target: el, preventDefault: () => {} });
    }, { passive: false });

    gridContainer.addEventListener('touchmove', function (ev) {
        ev.preventDefault();
        const t = ev.touches[0];
        const el = document.elementFromPoint(t.clientX, t.clientY);
        if (el && el.classList.contains('xiaomi-point')) continueDraw({ target: el });
    }, { passive: false });

    document.addEventListener('touchend', () => {
        if (isDrawing) {
            isDrawing = false;
            if (currentPath.length > 1) {
                steps.push(currentPath.join('-'));
                renderSteps();
                currentPath = [];
                clearCanvas();
            }
        }
    });

    function renderSteps() {
        stepHolder.innerHTML = '';
        if (steps.length === 0) {
            stepHolder.innerHTML = '<p style="text-align:center; color:#666;">Nenhum passo adicionado. Desenhe na grade acima.</p>';
            return;
        }
        const list = document.createElement('div');
        list.className = 'xiaomi-steps-list';
        steps.forEach((step, i) => {
            const stepEl = document.createElement('div');
            stepEl.className = 'xiaomi-step';

            const num = document.createElement('div');
            num.className = 'xiaomi-step-number';
            num.textContent = (i + 1).toString();

            const desc = document.createElement('div');
            desc.className = 'xiaomi-step-desc';
            desc.textContent = `Pontos: ${step}`;

            const btnRemove = document.createElement('button');
            btnRemove.type = 'button';
            btnRemove.textContent = 'X';
            btnRemove.style.marginLeft = '8px';
            btnRemove.style.padding = '4px 8px';
            btnRemove.style.borderRadius = '50%';
            btnRemove.style.background = '#ff3b30';
            btnRemove.style.color = '#fff';
            btnRemove.style.border = 'none';
            btnRemove.addEventListener('click', () => {
                steps.splice(i, 1);
                renderSteps();
            });

            stepEl.appendChild(num);
            stepEl.appendChild(desc);
            stepEl.appendChild(btnRemove);
            list.appendChild(stepEl);
        });
        stepHolder.appendChild(list);
    }

    btnAdd.addEventListener('click', () => {
        currentPath = [];
        clearCanvas();
    });

    btnSave.addEventListener('click', () => {
        setCurrentSteps(steps);
        closeXiaomiSteps();
    });

    btnClose.addEventListener('click', () => closeXiaomiSteps());

    overlay.addEventListener('click', (e) => { if (e.target === overlay) closeXiaomiSteps(); });

    // cleanup when overlay is removed
    try { overlay.__xiaomiCleanup = () => { try { roEditor.disconnect(); } catch(_){} }; } catch(_) {}

    renderSteps();
}

</script>

<style>

.notas-box {
    padding: 14px;
    margin: 12px auto;
    display: block;
    width: calc(100% - 32px);
    max-width: 600px;
    border-radius: var(--border-radius-inner);
    text-align: center; 
}

#modalDesenvolvimento .modalContent {
    width: calc(100% - 40px);
    max-width: 600px; 
    margin: 0 auto;
    padding: 22px;
    border-radius: var(--border-radius-main);
    box-shadow: 0 8px 32px 0 var(--shadow-color);
    background: var(--background-color);
    border: 1px solid var(--border-color);
}

#modalDesenvolvimento .modalButtons {
    margin-top: 20px;
}


#modalObservacoes {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    z-index: 1102 !important;
    display: none; 
    max-width: 600px !important;
}

#modalDesenvolvimento {
    z-index: 1100 !important;
}


.message-box.mobile-friendly,
#modalDesenvolvimento .modalContent {
    width: calc(100% - 40px) !important; 
    max-width: 600px !important; 
    margin: 0 auto !important;
    padding: 22px !important;
    border-radius: var(--border-radius-main) !important;
    box-sizing: border-box !important;
    text-align: left !important;
}


#modalDesenvolvimento .modalContent {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
}


@media (max-width: 768px) {
    .message-box {
        padding: 20px !important;
        width: calc(100% - 40px) !important;
        max-width: none !important;
        overflow-y: auto !important;
        max-height: 90vh !important;
        border-radius: calc(var(--border-radius-main) * 0.75) !important;
    }
    .message-box button {
        width: 100% !important;
        margin-top: 15px !important;
        min-height: 44px !important; 
        padding: 12px 0 !important;
        font-size: 1rem !important;
    }
    .message-box h2 {
        font-size: 1.2rem !important;
        margin-bottom: 15px !important;
    }
    .changelog {
        max-height: 40vh !important;
        font-size: 0.9rem !important;
        padding-right: 10px !important;
    }
    .message-box .modalButtons {
        flex-direction: column !important;
        gap: 10px !important;
        margin-top: 15px !important;
    }
    
    .changelog::-webkit-scrollbar {
        width: 6px !important;
    }
    .changelog::-webkit-scrollbar-track {
        background: var(--input-bg) !important;
        border-radius: 3px !important;
    }
    .changelog::-webkit-scrollbar-thumb {
        background: var(--border-color) !important;
        border-radius: 3px !important;
    }
}
</style>
<style>
/* Centralizar botões dentro de modais/caixas (não afeta botões da tela principal) */
/* Aplica-se apenas a botões dentro de .modal, .modalContent e .message-box */
.modal .modalButtons,
.modalContent .modalButtons,
.message-box .modalButtons,
.message-box .modal-footer,
.message-box footer,
.modal .modal-footer,
.modalContent .modal-footer {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 12px !important;
    flex-wrap: wrap !important;
}

/* Caso o botão seja único dentro do container, garantir que ele fique centralizado */
.message-box > button,
.modal .modalContent > button,
.modal > .modalContent > .modalButtons > button,
.message-box .btn-primary,
.message-box .btn-secondary {
    margin: 0 auto !important;
}

/* Não tocar botões da interface principal: escopo limitado aos modais e message-box */
</style>
<style>
/* Forçar tamanho mais amigável do modal de Desenvolvimento em telas pequenas */
@media (max-width: 480px) {
    /* Centraliza o modal e limita sua altura para evitar tela cheia estranha */
    #modalDesenvolvimento {
        align-items: center !important;
        justify-content: center !important;
        padding: 0 !important;
    }

    #modalDesenvolvimento .modalContent {
        width: calc(100% - 40px) !important;
        max-width: 360px !important; /* largura confortável em celular */
        margin: 0 auto !important;
        padding: 16px !important;
        box-shadow: 0 14px 40px rgba(0,0,0,0.45) !important;
        border-radius: 16px !important;
        max-height: 80vh !important; /* evita ocupar toda a viewport */
        overflow-y: auto !important;
        align-self: center !important;
    }

    /* Evita que regras globais de .modalContent para mobile (min-height:100vh) causem full-screen */
    .modal .modalContent {
        min-height: auto !important;
    }

    /* Ajustes internos: reduzir gaps que podem empurrar o conteúdo para fora */
    #modalDesenvolvimento .action-grid {
        gap: 8px !important;
    }
}
</style>
<style>
/* Manter os botões Salvar/Time/Updates SEMPRE lado a lado (mobile inclusive) */
@media (max-width: 480px) {
    #modalObservacoes .action-buttons {
        display: flex !important;
        flex-direction: row !important;
        justify-content: center !important;
        align-items: center !important;
        gap: 8px !important;
        flex-wrap: nowrap !important;
    }
    /* Tamanhos icon-only já ajustados acima; aqui apenas reforço se necessário */
    #modalObservacoes .action-buttons > button {
        height: 40px !important;
        padding: 0 8px !important;
        min-width: 0 !important;
        white-space: nowrap !important;
        flex: 1 1 0 !important; /* dividir igualmente a largura, sem scroll */
        width: auto !important; /* neutraliza qualquer width:100% herdado */
    }

    /* Remover animações específicas dos botões Salvar, Time e Info dentro de Observações */
    #modalObservacoes .action-buttons > button#btnSalvarObservacoes,
    #modalObservacoes .action-buttons > button#btnRedefinirTempo,
    #modalObservacoes .action-buttons > button#btnUpdates,
    #modalObservacoes .action-buttons > button#btnMaisInfoAnotacao {
        transition: none !important;
        animation: none !important;
        transform: none !important;
        box-shadow: none !important;
    }
    /* Também remover transições nos ícones SVG dentro desses botões */
    #modalObservacoes .action-buttons > button#btnSalvarObservacoes svg,
    #modalObservacoes .action-buttons > button#btnRedefinirTempo svg,
    #modalObservacoes .action-buttons > button#btnUpdates svg,
    #modalObservacoes .action-buttons > button#btnMaisInfoAnotacao svg {
        transition: none !important;
        transform: none !important;
    }
}
</style>
<style>
/* Garantir que os botões 'Leitura' e 'Sair' nas top-bars de app e anotacoes fiquem lado-a-lado */
#app .top-bar > div,
#anotacoesApp .top-bar > div {
    display: flex !important;
    flex-direction: row !important;
    gap: 8px !important;
    align-items: center !important;
    justify-content: flex-end !important; /* mantém à direita, ao lado do título */
    flex-wrap: nowrap !important; /* força ficar em linha */
}

#app .top-bar > div button,
#anotacoesApp .top-bar > div button {
    min-width: 0 !important;
}

/* Em telas extremamente estreitas permitimos overflow horizontal dentro da top-bar */
@media (max-width: 320px) {
    #app .top-bar > div,
    #anotacoesApp .top-bar > div {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }
}
</style>
<style>
/* Centralizar botões específicos solicitados pelo usuário */
/* Botão Voltar na caixa de senha numérica */
#anotacoesLogin #btnVoltarLoginAnotacoes {
    display: block !important;
    margin: 16px auto !important;
}

/* Botões na caixa de certificado: Iniciar Instalação */
#certificado #btnInstalar {
    display: block !important;
    margin: 6px auto !important;
}

/* Em telas muito pequenas, reduzir largura para evitar botões gigantes */
@media (max-width: 480px) {
    #anotacoesLogin #btnVoltarLoginAnotacoes {
        min-width: 0 !important;
        max-width: 140px !important;
        padding: 8px 12px !important;
        display: inline-block !important;
        margin: 4px !important;
    }

    /* Aumentar largura mínima do botão de instalação para caber 'INSTALAÇÃO' */
    #certificado #btnInstalar {
        min-width: 160px !important;
        max-width: 220px !important;
        padding: 8px 14px !important;
        display: inline-block !important;
        margin: 4px !important;
    }
}
    /* Tornar o texto apenas do botão de instalação em MAIÚSCULAS; o botão Voltar terá o estilo secundário */
    #certificado #btnInstalar {
        text-transform: uppercase !important;
        min-width: 96px;
        padding: 6px 10px;
        letter-spacing: 0.6px !important;
    }


</style>
    <style>
    /* 1) Colocar os botões INICIAR INSTALAÇÃO e VOLTAR lado a lado no certificado */
    #certificado {
        text-align: center !important; /* centraliza conteúdos inline como botões */
    }
    /* Novo container para os botões do certificado */
    #certificado .cert-buttons {
        display: flex !important;
        gap: 16px !important;
        justify-content: center !important;
        align-items: center !important;
        margin-top: 36px !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important; /* permitir scroll horizontal se necessário */
        -webkit-overflow-scrolling: touch !important;
}
@media (max-width: 480px) {
    #certificado .cert-buttons {
        /* Manter sempre lado a lado; permitir scroll horizontal quando necessário */
        flex-wrap: nowrap !important;
        gap: 8px !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }
    #certificado .cert-buttons button {
        flex: 0 0 auto !important;
        min-width: 96px !important;
        margin: 4px 6px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
}
        -webkit-overflow-scrolling: touch !important;
    }
    #certificado .cert-buttons button {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 6px 6px !important;
        padding: 10px 14px !important;
        flex: 0 1 auto !important;
        min-width: 96px !important;
        max-width: 320px !important;
        font-size: 0.95rem !important;
        border-radius: 10px !important;
        box-sizing: border-box !important;
    }
    /* Tornar exatamente igual ao .btn-secondary para o botão Voltar */
    #certificado .cert-buttons button.btn-secondary {
        border-radius: 8px !important;
        text-transform: none !important;
        background: var(--button-bg) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--button-text-color) !important;
    }
    /* Forçar os botões ocuparem metade da largura em telas pequenas, mantendo lado a lado */
    @media (max-width: 480px) {
        #certificado .cert-buttons button {
            flex: 0 1 calc(50% - 12px) !important;
            max-width: calc(50% - 12px) !important;
            min-width: 0 !important;
        }
    }

    /* 2) Mais espaçamento para o botão Preencher Automaticamente no modal de senha */
    #btn-autofill-trigger {
        margin-bottom: 28px !important; /* maior espaçamento abaixo */
        padding: 12px 18px !important; /* mais confortável para toque */
    }

    /* 3) Formulário Automático: botões lado a lado */
    #autoFillForm .modalButtons {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: wrap !important;
        gap: 12px !important;
        align-items: center !important;
        justify-content: center !important;
    }
    #autoFillForm .modalButtons button {
        width: auto !important;
        min-width: 130px !important;
        padding: 10px 14px !important;
        flex: 0 0 auto !important;
    }
    #autoFillForm .modalButtons #btn-autofill-form-back {
        margin: 0 !important;
        display: inline-flex !important;
    }

    @media (max-width: 540px) {
        #autoFillForm .modalButtons {
            justify-content: center !important;
        }
        #autoFillForm .modalButtons button {
            flex: 1 1 48% !important;
            min-width: 0 !important;
        }
    }

    /* Em telas muito pequenas, garantir toque confortável - reduzir largura dos botões do certificado */
    @media (max-width: 360px) {
        #anotacoesLogin #btnVoltarLoginAnotacoes,
        #certificado .cert-buttons button {
            width: calc(100% - 40px) !important;
            min-width: 140px !important;
        }
    }
    
    /* Espaçamento extra entre textos e botões de upload/download */
    #btnRealizarUpload {
        margin-top: 40px !important;
    }
    .message-box p {
        margin-bottom: 26px !important;
    }
    /* Reduzir espaçamento especificamente entre CERTIFICADO DIGITAL e PLUG-IN DIGITAL */
    #certificado #certTitulo {
        margin-bottom: 8px !important;
    }
    #pluginDigitalBox {
        margin-left: 0 !important;
        margin-right: 0 !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        border-left: none !important;
        border-right: none !important;
        margin-top: 8px !important;
        margin-bottom: 8px !important;
    }
    #pluginOfflineBox {
        margin: 0px !important; /* mesmo estilo: sem espaçamentos */
    }
    #relatorioBugsBox {
        margin-top: 8px !important;
        margin-bottom: 20px !important;
        text-transform: uppercase !important;
    }
        </style>
        <style>
        /* Ajustes de visualização dos formulários no celular */
        @media (max-width: 768px) {
            /* Usar largura quase total da viewport com margens laterais seguras */
            #login, #certificado, #anotacoesLogin, #acessoEspecial, #recuperarPin,
            #app, #anotacoesApp, #autoFillSettings, #autoFillForm,
            .modalContent {
                max-width: none !important;
                width: calc(100vw - 24px) !important; /* 12px de margem em cada lado */
                margin: 16px auto !important; /* espaço superior e inferior */
                border-radius: var(--border-radius-main) !important; /* garantir cantos arredondados */
                overflow: hidden !important; /* clipe do conteúdo para exibir o arredondamento */
            }

            /* Mais respiro vertical interno nos formulários e modais */
            #login, #certificado, #anotacoesLogin, #acessoEspecial, #recuperarPin,
            #app, #anotacoesApp, #autoFillSettings, #autoFillForm,
            .modalContent {
                padding-top: 24px !important;
                padding-bottom: 24px !important;
            }
        }
        </style>
            <style>
            /* Botões com estilo Liquid Glass consistente com o tema do site */
                .modalButtons {
                background: transparent !important;
                padding: 0 !important;
                }
                .modalButtons button {
                background: var(--button-bg) !important;
                border: none !important;
                color: var(--button-text-color) !important;
                border-radius: var(--border-radius-inner) !important;
                transition: all 0.3s ease !important;
                box-sizing: border-box !important;
                -webkit-appearance: none !important;
                appearance: none !important;
                box-shadow: none !important;
                outline: none !important;
                -webkit-tap-highlight-color: transparent !important;
                text-decoration: none !important;
                position: relative !important;
                z-index: 1 !important;
            }
            .modalButtons button:hover {
                background: var(--button-hover-bg) !important;
                transform: translateY(-2px) !important;
                box-shadow: none !important;
                outline: none !important;
            }
            .modalButtons button.primary-action,
            .modalButtons button[type="submit"],
            #btn-autofill-save {
                background: var(--primary-accent) !important;
                border: none !important;
                color: #fff !important;
                box-shadow: none !important;
                outline: none !important;
            }
            .modalButtons button.primary-action:hover,
            .modalButtons button[type="submit"]:hover,
            #btn-autofill-save:hover {
                background: var(--primary-accent-hover) !important;
                transform: translateY(-2px) !important;
                box-shadow: none !important;
                outline: none !important;
            }
            .modalButtons button:focus,
            .modalButtons button:active,
            #btn-autofill-save:focus,
            #btn-autofill-save:active {
                outline: none !important;
                box-shadow: none !important;
                border: none !important;
            }
            </style>
                <style>
                /* Formulário Automático: padronizar largura do botão Voltar */
                #autoFillSettings #btn-autofill-back-to-app {
                    width: 100% !important;
                    padding: 14px 0 !important;
                    font-size: 1rem !important;
                    border-radius: var(--border-radius-inner) !important;
                    display: block !important;
                }
                </style>
                    <style>
                    /* Estilo para botões apenas com ícone nas cartas */
                            .card-buttons button.icon-only {
                            width: 38px !important;
                            height: 38px !important;
                            min-width: 38px !important;
                            padding: 6px !important;
                            display: inline-flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                                border-radius: 10px !important; /* quadrado com cantos arredondados */
                            background: var(--button-bg) !important;
                            border: 1px solid var(--border-color) !important;
                            color: var(--button-text-color) !important;
                            transition: transform .15s ease, box-shadow .2s ease, background-color .2s ease, color .2s ease !important;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.12) !important;
                            backdrop-filter: blur(4px);
                            -webkit-backdrop-filter: blur(4px);
                        }
                        .card-buttons button.icon-only:hover {
                            background: var(--button-hover-bg) !important;
                            transform: translateY(-1px) scale(1.03);
                            box-shadow: 0 6px 18px rgba(0,0,0,0.18) !important;
                        }
                        .card-buttons button.icon-only:active {
                            transform: translateY(0) scale(0.98);
                            box-shadow: 0 2px 8px rgba(0,0,0,0.12) !important;
                        }
                        .card-buttons button.icon-only svg {
                            width: 20px;
                            height: 20px;
                            display: block;
                        }

                        /* Variantes por ação */
                        .card-buttons button.icon-only.view:hover,
                        .card-buttons button.icon-only.download:hover,
                        .card-buttons button.icon-only.edit:hover {
                            color: var(--primary-accent) !important;
                        }

                        /* Excluir com visual de perigo sutil */
                        .card-buttons button.icon-only.excluir,
                        .card-buttons button.icon-only.delete {
                            background-color: rgba(255, 59, 48, 0.08) !important; /* danger-accent com leve transparência */
                            border-color: rgba(255, 59, 48, 0.35) !important;
                            color: var(--danger-accent) !important;
                        }
                        .card-buttons button.icon-only.excluir:hover,
                        .card-buttons button.icon-only.delete:hover {
                            background-color: rgba(255, 59, 48, 0.15) !important;
                            box-shadow: 0 6px 18px rgba(255, 59, 48, 0.25) !important;
                            transform: translateY(-1px) scale(1.03);
                        }
                        .card-buttons button.icon-only.excluir:active,
                        .card-buttons button.icon-only.delete:active {
                            transform: translateY(0) scale(0.98);
                        }

                        /* Remover efeito de brilho (box-shadow/filters/transform) especificamente para botão Excluir */
                        .card-buttons button.excluir,
                        .card-buttons button.icon-only.excluir,
                        .card-buttons button.icon-only.delete {
                            box-shadow: none !important;
                            filter: none !important;
                            background-color: var(--button-bg) !important;
                            color: var(--button-text-color) !important;
                            border-color: var(--border-color) !important;
                            transition: none !important;
                            transform: none !important;
                        }
                        .card-buttons button.excluir:hover,
                        .card-buttons button.icon-only.excluir:hover,
                        .card-buttons button.icon-only.delete:hover,
                        .card-buttons button.excluir:focus,
                        .card-buttons button.icon-only.excluir:focus,
                        .card-buttons button.icon-only.delete:focus {
                            box-shadow: none !important;
                            filter: none !important;
                            background-color: var(--button-bg) !important;
                            color: var(--button-text-color) !important;
                            transform: none !important;
                        }

                        /* Caixa de seleção para serviços relacionados (mesma categoria/board) */
                        .related-services-select {
                            width: 100%;
                            margin-top: 8px;
                            padding: 10px 12px;
                            border-radius: 12px;
                            background: var(--input-bg);
                            color: var(--text-color);
                            border: 1px solid var(--border-color);
                            font-size: 0.95rem;
                            box-sizing: border-box;
                        }
                        .related-services-select:focus {
                            outline: none;
                            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.12);
                        }

                        /* Remover efeitos para botões icon-only */
                        .card-buttons button.icon-only {
                            transition: none !important;
                            transform: none !important;
                            box-shadow: none !important;
                            background: var(--button-bg) !important;
                            color: var(--button-text-color) !important;
                        }
                        .card-buttons button.icon-only:hover,
                        .card-buttons button.icon-only:focus,
                        .card-buttons button.icon-only:active {
                            transform: none !important;
                            box-shadow: none !important;
                            background: var(--button-bg) !important;
                            color: var(--button-text-color) !important;
                        }
                        .card-buttons button.icon-only.view:hover,
                        .card-buttons button.icon-only.download:hover,
                        .card-buttons button.icon-only.edit:hover {
                            color: var(--button-text-color) !important;
                        }
                    </style>
                        <style>
                        /* Mais espaço entre o título da categoria e o conteúdo */
                        .board-column h3 {
                            margin-bottom: 14px !important;
                        }
                        </style>
                        <style>
                        /* Visualização completa com o mesmo estilo das caixinhas */
                        #visualizacao-content.view-content {
                            text-align: left;
                            margin-top: 10px;
                            padding: 12px; /* espaço interno para separar do modal */
                        }
                        #visualizacao-content .view-meta {
                            display: flex;
                            flex-direction: column;
                            gap: 12px;
                            margin-top: 12px;
                        }
                        #visualizacao-content .chip {
                            display: flex;
                            align-items: flex-start; /* alinhar ao topo quando o valor quebrar em múltiplas linhas */
                            justify-content: flex-start;
                            gap: 10px;
                            width: 100%;
                            min-height: 42px;
                            padding: 10px 12px;
                            border: 1px solid var(--border-color);
                            background: var(--input-bg);
                            border-radius: var(--border-radius-inner);
                            font-size: 0.95rem;
                        }
                        #visualizacao-content .chip-label {
                            opacity: 0.7;
                        }
                        #visualizacao-content .chip-label::after {
                            content: ":";
                            margin: 0 4px 0 2px;
                            opacity: 0.6;
                        }
                        #visualizacao-content .chip-value {
                            font-weight: 600;
                            flex: 1 1 auto;
                            min-width: 0;
                            /* permitir quebra de linha em valores longos na visualização completa */
                            overflow: visible;
                            white-space: normal;
                            word-break: break-word;
                            overflow-wrap: anywhere;
                            line-height: 1.3;
                        }
                        #visualizacao-content .links-chip a {
                            display: block;
                            width: 100%;
                            padding: 10px 12px;
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius-inner);
                            background: var(--input-bg);
                            color: var(--primary-accent);
                            text-decoration: none;
                            font-size: 0.95rem;
                            /* permitir quebra de linha em links longos na visualização */
                            overflow-wrap: anywhere;
                            white-space: normal;
                            word-break: break-word;
                        }
                        #visualizacao-content .links-chip a:hover {
                            text-decoration: underline;
                        }
                        #visualizacao-content .notes-full {
                            padding: 10px 12px;
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius-inner);
                            background: var(--input-bg);
                            font-size: 0.95rem;
                            line-height: 1.5;
                            color: var(--text-color);
                            word-wrap: break-word;
                        }
                        #visualizacao-content .view-cards {
                            display: flex;
                            flex-direction: column;
                            gap: 12px;
                            align-items: stretch;
                            width: 100%;
                        }
                        #visualizacao-content .view-card {
                            box-shadow: 0 4px 14px rgba(0,0,0,0.18);
                            margin: 10px 0; /* espaço entre cartões e outros elementos */
                            padding: 12px 14px; /* espaço interno para evitar cortes */
                            border-radius: 10px;
                            background: var(--input-bg); /* manter coerência visual */
                        }
                        #visualizacao-content .btn-revelar-cartao {
                            position: absolute !important;
                            top: 8px !important;
                            right: 8px !important;
                            width: 22px !important;
                            height: 22px !important;
                            padding: 4px !important;
                            display: inline-flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            flex: 0 0 auto !important;
                            box-sizing: border-box !important;
                        }
                        #visualizacao-content .view-card .card-icon {
                            width: 24px;
                            height: 24px;
                            flex-shrink: 0;
                            color: var(--primary-accent);
                        }
                        #visualizacao-content .view-card .card-icon svg {
                            width: 100%;
                            height: 100%;
                        }
                        #visualizacao-content .view-card .card-body {
                            flex: 1;
                            min-width: 0;
                        }
                        #visualizacao-content .view-card .card-title {
                            font-weight: 600;
                            opacity: 0.9;
                            margin-bottom: 6px;
                        }
                        #visualizacao-content .view-card .card-number {
                            font-weight: 700;
                            letter-spacing: 1.4px;
                            color: var(--text-color);
                        }
                        #visualizacao-content .view-card .card-meta {
                            display: flex;
                            gap: 12px;
                            flex-wrap: wrap;
                            font-size: 0.9rem;
                            opacity: 0.8;
                            margin-top: 6px;
                        }
                        
                        .board-column[data-marcador-importante="true"] {
                            border: 3px solid var(--marcador-cor-importante) !important;
                        }

                        /* Destacar a caixa de mensagem/visualização quando o item for marcado como importante */
                        #message-box.marcador-importante-ativo {
                            border: 3px solid var(--marcador-cor-importante) !important;
                            box-shadow: 0 0 20px var(--marcador-cor-importante), 0 8px 32px 0 var(--shadow-color);
                        } 
                        
                        .alerta-revisao {
                            background: rgba(255, 159, 0, 0.15);
                            border: 2px solid rgba(255, 159, 0, 0.5);
                            border-radius: var(--border-radius-inner);
                            padding: 12px 16px;
                            margin: 16px 0;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            color: var(--text-color);
                        }
                        
                        .alerta-revisao svg {
                            flex-shrink: 0;
                            stroke: #FF9500;
                        }
                        
                        .alerta-revisao span {
                            flex: 1;
                            font-size: 0.95rem;
                        }
                        
                        .alerta-revisao button {
                            background: rgba(255, 159, 0, 0.3);
                            border: 1px solid rgba(255, 159, 0, 0.6);
                            color: var(--text-color);
                            padding: 8px 16px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.3s ease;
                            white-space: nowrap;
                        }
                        
                        .alerta-revisao button:hover {
                            background: rgba(255, 159, 0, 0.5);
                            border-color: #FF9500;
                        }
                        </style>

    <!-- Override de z-index para garantir que mensagens fiquem sempre acima de widgets como #mi_summary -->
    <style>
        /* colocar as mensagens acima de quaisquer modais/elementos com z altos (ex.: 2147483647) */
        .message-box { z-index: 2147483652 !important; }
        .overlay { z-index: 2147483651 !important; }
    </style>

    <script>
    (function(){
      const input = document.getElementById('inputSenha');
      if(!input) return;
      const container = input.closest('.input-container');
      const fill = container.querySelector('.strength-fill');
      const label = container.querySelector('.strength-label');

      function updateStrength(){
        const pw = input.value || '';
        let raw = 0;
        if (pw.length >= 8) raw++;
        if (pw.length >= 12) raw++;
        if (/[a-z]/.test(pw) && /[A-Z]/.test(pw)) raw++;
        if (/\d/.test(pw)) raw++;
        if (/[^A-Za-z0-9]/.test(pw)) raw++;

        const percent = Math.min(100, Math.round((raw / 5) * 100));
        if(fill) fill.style.width = percent + '%';

        let text = 'Fácil';
        let color = '#FF4D4F';
        if(raw <= 1){
           text = 'Fácil';
           color = '#FF4D4F';
        } else if(raw <= 3){
           text = 'Médio';
           color = '#FFB020';
        } else {
           text = 'Difícil';
           color = '#34C759';
        }
        if(fill) fill.style.background = color;
        if(label) label.textContent = text;

        const bar = container.querySelector('.strength-bar');
        if(bar) bar.setAttribute('aria-valuenow', percent);
      }

      input.addEventListener('input', updateStrength, { passive: true });
      // rodar uma vez no carregamento
      updateStrength();
    })();
    </script>

    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').then(() => console.info('Service Worker registrado')).catch(err => console.warn('SW registro falhou', err));
    }
    </script>

<script>
/* Bridge: expose the APIs used by the app and keep backward compatibility */
(function(){
  // initializeApp -> firebase.initializeApp
  window.initializeApp = function(cfg){ return (window.firebase && window.firebase.initializeApp) ? window.firebase.initializeApp(cfg) : undefined; };
  // getAuth/getFirestore wrappers accept optional app
  window.getAuth = function(app){ return (window.firebase && window.firebase.auth) ? window.firebase.auth(app) : null; };
  window.getFirestore = function(app){ return (window.firebase && window.firebase.firestore) ? window.firebase.firestore(app) : null; };
  // signInWithEmailAndPassword (keeps compat signature)
  window.signInWithEmailAndPassword = function(authInstance, email, pass){ if (authInstance && typeof authInstance.signInWithEmailAndPassword==='function') return authInstance.signInWithEmailAndPassword(email, pass); if (window.firebase && window.firebase.auth) return window.firebase.auth().signInWithEmailAndPassword(email, pass); return Promise.reject(new Error('Auth not initialized')); };
  // doc/getDoc/setDoc compatible wrappers for code that expects simple helpers
  window.doc = function(db, collection, id){ try { return (db && typeof db.collection==='function') ? db.collection(collection).doc(id) : (window.firebase && window.firebase.firestore? window.firebase.firestore().collection(collection).doc(id) : null); } catch(e){return null;} };
  window.getDoc = async function(ref){ if (!ref) return { exists: ()=>false, data: ()=>null }; try { const s = await ref.get(); return { exists: ()=>!!(s && s.exists), data: ()=> (s && typeof s.data==='function'? s.data() : s && s.data) }; } catch(e){ return { exists: ()=>false, data: ()=>null }; } };
  window.setDoc = function(ref, data){ if (!ref) return Promise.reject(new Error('Invalid ref')); return ref.set ? ref.set(data) : Promise.reject(new Error('set not available on ref')); };
  // token helper
  window._firebase_getIdToken = async function(){ try { const u = window.firebase && window.firebase.auth && window.firebase.auth().currentUser; return u ? await u.getIdToken() : null; } catch(e){ return null; } };
})();
</script><!-- REMOVED_TRUNCATED_FIREBASE_COMPAT START -->
<!--const r=[];let n=0;for(let a=0;a<t.length;a++){let e=t.charCodeAt(a);e<128?r[n++]=e:(e<2048?r[n++]=e>>6|192:(55296==(64512&e)&&a+1<t.length&&56320==(64512&t.charCodeAt(a+1))?(e=65536+((1023&e)<<10)+(1023&t.charCodeAt(++a)),r[n++]=e>>18|240,r[n++]=e>>12&63|128):r[n++]=e>>12|224,r[n++]=e>>6&63|128),r[n++]=63&e|128)}return r},n={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const a=[];for(let h=0;h<r.length;h+=3){var i=r[h],s=h+1<r.length,o=s?r[h+1]:0,c=h+2<r.length,l=c?r[h+2]:0;let e=(15&o)<<2|l>>6,t=63&l;c||(t=64,s||(e=64)),a.push(n[i>>2],n[(3&i)<<4|o>>4],n[e],n[t])}return a.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(r(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var a,i,s=e[n++];s<128?t[r++]=String.fromCharCode(s):191<s&&s<224?(i=e[n++],t[r++]=String.fromCharCode((31&s)<<6|63&i)):239<s&&s<365?(i=((7&s)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(i>>10)),t[r++]=String.fromCharCode(56320+(1023&i))):(i=e[n++],s=e[n++],t[r++]=String.fromCharCode((15&s)<<12|(63&i)<<6|63*s))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var r=t?this.charToByteMapWebSafe_:this.charToByteMap_;const n=[];for(let c=0;c<e.length;){var a=r[e.charAt(c++)],i=c<e.length?r[e.charAt(c)]:0;++c;var s=c<e.length?r[e.charAt(c)]:64;++c;var o=c<e.length?r[e.charAt(c)]:64;if(++c,null==a||null==i||null==s||null==o)throw new l}return n},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}};class l extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}};const a=function(e){return e=e,t=r(e),n.encodeByteArray(t,!0).replace(/\./g,"")};function c(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:const r=t;return new Date(r.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return t}for(const n in t)t.hasOwnProperty(n)&&"__proto__"!==n&&(e[n]=c(e[n],t[n]));return e}const e=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,t=()=>{if("undefined"!=typeof document){let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var t=e&&function(e){try{return n.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(e[1]);return t&&JSON.parse(t)}},i=()=>{try{return e()||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||t()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},h=()=>{var e;return null===(e=i())||void 0===e?void 0:e.config};class s{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(r){return(e,t)=>{e?this.reject(e):this.resolve(t),"function"==typeof r&&(this.promise.catch(()=>{}),1===r.length?r(e):r(e,t))}}}class o extends Error{constructor(e,t,r){super(t),this.code=e,this.customData=r,this.name="FirebaseError",Object.setPrototypeOf(this,o.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,d.prototype.create)}}class d{constructor(e,t,r){this.service=e,this.serviceName=t,this.errors=r}create(e,...t){var n,r=t[0]||{},i=`${this.service}/${e}`,s=this.errors[e],s=s?(r=n,s.replace(u,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",s=`${this.serviceName}: ${s} (${i}).`;return new o(a,i,r)}}const u=/\{\$([^}]+)}/g;function p(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function f(e,t){if(e===t)return 1;const r=Object.keys(e),n=Object.keys(t);for(const s of r){if(!n.includes(s))return;var a=e[s],i=t[s];if(g(a)&&g(i)){if(!f(a,i))return}else if(a!==i)return}for(const o of n)if(!r.includes(o))return;return 1}function g(e){return null!==e&&"object"==typeof e}function b(e,t){const r=new m(e,t);return r.subscribe.bind(r)}class m{constructor(e,t){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then(()=>{e(this)}).catch(e=>{this.error(e)})}next(t){this.forEachObserver(e=>{e.next(t)})}error(t){this.forEachObserver(e=>{e.error(t)}),this.close(t)}complete(){this.forEachObserver(e=>{e.complete()}),this.close()}subscribe(e,t,r){let n;if(void 0===e&&void 0===t&&void 0===r)throw new Error("Missing Observer.");n=function(e,t){if("object"!=typeof e||null===e)return!1;for(const r of t)if(r in e&&"function"==typeof e[r])return!0;return!1}(e,["next","error","complete"])?e:{next:e,error:t,complete:r},void 0===n.next&&(n.next=v),void 0===n.error&&(n.error=v),void 0===n.complete&&(n.complete=v);var a=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then(()=>{try{this.finalError?n.error(this.finalError):n.complete()}catch(e){}),this.observers.push(n),a}unsubscribeOne(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],--this.observerCount,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))}forEachObserver(t){if(!this.finalized)for(let e=0;e<this.observers.length;e++)this.sendOne(e,t)}sendOne(e,t){this.task.then(()=>{if(void 0!==this.observers&&void 0!==this.observers[e])try{t(this.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}})}close(e){this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then(()=>{this.observers=void 0,this.onNoObservers=void 0}))}}function v(){}class /* many internal lines omitted for brevity */{};var Se=Object.freeze({__proto_:null,SDK_VERSION:le,_DEFAULT_ENTRY_NAME:Q,_addComponent:ne,_addOrOverwriteComponent:ae,_apps:te,_clearComponents:function(){re.clear()},_components:re,_getProvider:se,_registerComponent:ie,_removeServiceInstance:function(e,t,r=Q){se(e,t).clearInstance(r)},deleteApp:de,getApp:function(e=Q){var t=te.get(e);if(!t&&e===Q&&h())return he();if(!t)throw oe.create("no-app",{appName:e});return t},getApps:function(){return Array.from(te.values())},initializeApp:he,onLog:pe,registerVersion:ue,setLogLevel:fe,FirebaseError:o});class Oe{constructor(e,t){this._delegate=e,this.firebase=t,ne(e,new _("app-compat",()=>this,"PUBLIC")),this.container=e.container}get automaticDataCollectionEnabled(){return this._delegate.automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this._delegate.automaticDataCollectionEnabled=e}get name(){return this._delegate.name}get options(){return this._delegate.options}delete(){return new Promise(e=>{this._delegate.checkDestroyed(),e()}).then(()=>{this.firebase.INTERNAL.removeApp(this.name),de(this._delegate)})}_getService(e,t=Q){var r;this._delegate.checkDestroyed();const n=this._delegate.container.getProvider(e);return n.isInitialized()||"EXPLICIT"!==(null===(r=n.getComponent())||void 0===r?void 0:r.instantiationMode)||n.initialize(),n.getImmediate({identifier:t})}_removeServiceInstance(e,t=Q){this._delegate.container.getProvider(e).clearInstance(t)}_addComponent(e){ne(this._delegate,e)}_addOrOverwriteComponent(e){ae(this._delegate,e)}toJSON(){return{name:this.name,automaticDataCollectionEnabled:this.automaticDataCollectionEnabled,options:this.options}}}const Ae=new d("app-compat","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call FirebaseApp.initializeApp() first","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance."});function Le(a){const i={},s={__esModule:!0,initializeApp:function(e,t={}){var r=he(e,t);if(p(i,r.name))return i[r.name];var n=new a(r,s);return i[r.name]=n},app:o,registerVersion:ue,setLogLevel:fe,onLog:pe,apps:null,SDK_VERSION:le,INTERNAL:{registerComponent:function(r){const n=r.name,t=n.replace("-compat","");{var e;ie(r)&&"PUBLIC"===r.type&&(e=(e=o())=>{if("function"!=typeof e[t])throw Ae.create("invalid-app-argument",{appName:n});return e[t]()},void 0!==r.serviceProps&&c(e,r.serviceProps),s[t]=e,a.prototype[t]=function(...e){const t=this._getService.bind(this,n);return t.apply(this,r.multipleInstances?e:[])})}return"PUBLIC"===r.type?s[t]:null},removeApp:function(e){delete i[e]},useAsService:function(e,t){if("serverAuth"===t)return null;var r=t;return r},modularAPIs:Se}};function o(e){if(e=e||Q,!p(i,e))throw Ae.create("no-app",{appName:e});return i[e]}return s.default=s,Object.defineProperty(s,"apps",{get:function(){return Object.keys(i).map(e=>i[e])}}),o.App=a,s}var Ne=function e(){const t=Le(Oe);return t.INTERNAL=Object.assign(Object.assign({},t.INTERNAL),{createFirebaseNamespace:e,extendNamespace:function(e){c(t,e)},createSubscribe:b,ErrorFactory:d,deepExtend:c}),t}();const Be=new B("@firebase/app-compat");if("object"==typeof self&&self.self===self&&void 0!==self.firebase){Be.warn(`\n    Warning: Firebase is already defined in the\nglobal scope. Please make sure\n    Firebase library is only loaded once.\n \n`);const Pe=self.firebase.SDK_VERSION;Pe&&0<=Pe.indexOf("LITE")&&Be.warn(`\n   \nWarning: You are trying to load Firebase while using Firebase Performance standalone\nscript.\n    You should load Firebase Performance with this instance of Firebase\n    to avoid loading duplicate code.\n    `)}const Te=Ne;ue("@firebase/app-compat","0.2.25",void 0);return Te.registerVersion("firebase","10.7.1","app-compat-cdn"),Te});
-->

                        <!-- Firebase compat SDKs (app, auth, firestore) via CDN (adicionados para garantir que initializeApp, getAuth e getFirestore funcionem) -->
                        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
                        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
                        <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

                        <script>
                            // 2. Configuração (conforme fornecido)
                            const firebaseConfig = {
                                apiKey: "AIzaSyB-6mBVrBTO16ViCBRQMnJvs6M7ywyRH3M",
                                authDomain: "keymaster-e027d.firebaseapp.com",
                                projectId: "keymaster-e027d",
                                storageBucket: "keymaster-e027d.firebasestorage.app",
                                messagingSenderId: "260041974700",
                                appId: "1:260041974700:web:3e72ded3262566cee0d009"
                            };

                            // 3. Inicializamos a conexão
                            const app = initializeApp(firebaseConfig);
                            const db = getFirestore(app);
                            const auth = getAuth(app);

                            // Helper: credenciais (injetadas conforme pedido)
                            const SYNC_EMAIL = "guilhermejesussantos28@gmail.com";
                            const SYNC_PASS = "hTlmvqO6Y6EVc2ME72T7OC5X8IYHOMwLR";

                            // 4. Função para SALVAR na nuvem com logs e fallback local
                            async function salvarDados(jsonCriptografado) {
                                try {
                                    await signInWithEmailAndPassword(auth, SYNC_EMAIL, SYNC_PASS);

                                    // Se for um JSON parcial (objeto), tentar mesclar com o documento existente
                                    let finalDados = jsonCriptografado;
                                    try {
                                        const parsed = (typeof jsonCriptografado === 'string') ? JSON.parse(jsonCriptografado) : jsonCriptografado;
                                        if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {
                                            try {
                                                const existingSnap = await getDoc(doc(db, "sistema", "meu_json"));
                                                let existingObj = {};
                                                if (existingSnap && existingSnap.exists && existingSnap.exists()) {
                                                    const existingDados = existingSnap.data() && existingSnap.data().dados;
                                                    try {
                                                        existingObj = (typeof existingDados === 'string') ? JSON.parse(existingDados) : (existingDados || {});
                                                    } catch (_) { existingObj = existingDados || {}; }
                                                }
                                                // Mesclar de forma rasa: campos do parsed sobrescrevem existingObj
                                                const merged = Object.assign({}, existingObj, parsed);
                                                finalDados = JSON.stringify(merged);
                                            } catch (e) {
                                                // Se falhar ao ler/mesclar do Firestore, usar o payload original
                                                finalDados = JSON.stringify(parsed);
                                            }
                                        }
                                    } catch (e) {
                                        // não é JSON — manter a string recebida
                                        finalDados = jsonCriptografado;
                                    }

                                    await setDoc(doc(db, "sistema", "meu_json"), {
                                        dados: finalDados,
                                        atualizadoEm: new Date().toISOString()
                                    });
                                    console.info('salvarDados: sucesso');
                                    return { ok: true };
                                } catch (error) {
                                    // Log detalhado para diagnóstico (err.code e err.message)
                                    console.error('salvarDados error', error && error.code, error && error.message, error);
                                    try {
                                        localStorage.setItem('gerenciadorBoards_backup', jsonCriptografado);
                                        console.warn('salvarDados: backup salvo em localStorage key=gerenciadorBoards_backup');
                                    } catch (e) {
                                        console.error('salvarDados: erro ao salvar backup local', e);
                                    }
                                    return { ok: false, error: { code: error && error.code, message: error && error.message } };
                                }
                            }

                            // 5. Função para CARREGAR da nuvem com logs e fallback local
                            // Timeout helper to avoid hanging requests
                            function promiseWithTimeout(promise, ms, label) {
                                let timer;
                                return Promise.race([
                                    promise,
                                    new Promise((_, reject) => timer = setTimeout(() => reject(new Error(`Timeout after ${ms}ms${label?': '+label:''}`)), ms))
                                ]).finally(() => clearTimeout(timer));
                            }

                            async function doSignInWithTimeout() {
                                console.info('doSignInWithTimeout: iniciando signInWithEmailAndPassword');
                                try {
                                    const p = signInWithEmailAndPassword(auth, SYNC_EMAIL, SYNC_PASS);
                                    const res = await promiseWithTimeout(p, 12000, 'signInWithEmailAndPassword');
                                    console.info('doSignInWithTimeout: sign-in concluído', res && res.user && res.user.uid);
                                    return res;
                                } catch (e) {
                                    console.error('doSignInWithTimeout error', e && e.code, e && e.message, e);
                                    throw e;
                                }
                            }

                            async function carregarDados() {
                                console.info('carregarDados: início');
                                try {
                                    // Se já houver usuário autenticado, tente reutilizar o token
                                    if (auth && auth.currentUser) {
                                        try {
                                            console.info('carregarDados: usuário já autenticado, tentando renovar token');
                                            await promiseWithTimeout(auth.currentUser.getIdToken(true), 8000, 'getIdToken');
                                            console.info('carregarDados: token renovado com sucesso');
                                        } catch (tErr) {
                                            console.warn('carregarDados: falha ao renovar token, fará novo sign-in', tErr);
                                            await doSignInWithTimeout();
                                        }
                                    } else {
                                        // Realizar sign-in com timeout para evitar pendências
                                        await doSignInWithTimeout();
                                    }

                                    // Buscar documento com timeout via SDK
                                    try {
                                        const docPromise = getDoc(doc(db, "sistema", "meu_json"));
                                        const docSnap = await promiseWithTimeout(docPromise, 10000, 'getDoc(sistema/meu_json)');
                                        if (docSnap && docSnap.exists && docSnap.exists()) {
                                            console.info('carregarDados: obtido do Firestore (SDK)');
                                            return docSnap.data().dados;
                                        }
                                        console.info('carregarDados: documento não existe (SDK)');
                                    } catch (sdkErr) {
                                        console.error('carregarDados: erro/timeout ao obter doc via SDK', sdkErr);
                                        // SDK leitura falhou/timeout — tentaremos fallback REST abaixo
                                    }

                                    // Fallback: usar o endpoint REST do Firestore (isola problema SDK/CORS)
                                    try {
                                        console.info('carregarDados: tentando fallback REST Firestore');
                                        // Tentar obter idToken: prefira SDK currentUser, senão usar debugFirebaseSignIn
                                        let idToken = null;
                                        try {
                                            if (auth && auth.currentUser) {
                                                idToken = await promiseWithTimeout(auth.currentUser.getIdToken(true), 8000, 'getIdToken(fallback)');
                                                console.info('carregarDados: obteve idToken via SDK currentUser');
                                            }
                                        } catch (tErr2) {
                                            console.warn('carregarDados: não conseguiu idToken via SDK, tentarei REST signIn', tErr2);
                                        }

                                        if (!idToken && typeof debugFirebaseSignIn === 'function') {
                                            const dbg = await promiseWithTimeout(debugFirebaseSignIn(), 10000, 'debugFirebaseSignIn');
                                            console.info('carregarDados: resultado debugFirebaseSignIn', dbg && dbg.status);
                                            if (dbg && dbg.ok && dbg.body && dbg.body.idToken) {
                                                idToken = dbg.body.idToken;
                                            }
                                        }

                                        if (idToken) {
                                            const projectId = firebaseConfig && firebaseConfig.projectId;
                                            if (projectId) {
                                                const url = `https://firestore.googleapis.com/v1/projects/${encodeURIComponent(projectId)}/databases/(default)/documents/sistema/meu_json`;
                                                const res = await promiseWithTimeout(fetch(url, { headers: { Authorization: 'Bearer ' + idToken } }), 10000, 'fetch_firestore_rest');
                                                const text = await res.text();
                                                let body;
                                                try { body = JSON.parse(text); } catch (e) { body = text; }
                                                console.info('carregarDados: resposta REST Firestore', res.status, body);
                                                if (res.ok && body && body.fields && body.fields.dados) {
                                                    const f = body.fields.dados;
                                                    // Suporta stringValue e mapValue/stringified
                                                    if (f.stringValue !== undefined) return f.stringValue;
                                                    if (f.mapValue && f.mapValue.fields) return f.mapValue;
                                                    // Se for outro formato, retorne o objeto bruto
                                                    return f;
                                                }
                                            } else {
                                                console.warn('carregarDados: firebaseConfig.projectId ausente, não é possível chamar REST Firestore');
                                            }
                                        } else {
                                            console.warn('carregarDados: não obteve idToken para fallback REST');
                                        }
                                    } catch (restErr) {
                                        console.error('carregarDados: fallback REST falhou', restErr);
                                    }

                                    // Estratégia de fallback final: procurar backups locais conhecidos
                                    const fallbackKeys = ['gerenciadorBoards', 'gerenciadorBoards_backup', 'gerenciadorAnotacoes', 'marcadores'];
                                    for (const k of fallbackKeys) {
                                        try {
                                            const v = localStorage.getItem(k);
                                            if (v) {
                                                console.warn('carregarDados: usando fallback local key=', k);
                                                return v;
                                            }
                                        } catch (e) {
                                            console.error('carregarDados: erro ao ler localStorage', k, e);
                                        }
                                    }

                                    return null;
                                } catch (error) {
                                    console.error('carregarDados error (outer)', error && error.code, error && error.message, error);
                                    return null;
                                }
                            }

                            // Função de diagnóstico: chama diretamente o endpoint REST para expor o corpo da resposta
                            async function debugFirebaseSignIn() {
                                try {
                                    const url = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${firebaseConfig.apiKey}`;
                                    const payload = { email: SYNC_EMAIL, password: SYNC_PASS, returnSecureToken: true };
                                    const res = await fetch(url, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(payload)
                                    });
                                    const text = await res.text();
                                    let body;
                                    try { body = JSON.parse(text); } catch (e) { body = text; }
                                    return { status: res.status, ok: res.ok, body };
                                } catch (e) {
                                    console.error('debugFirebaseSignIn error', e);
                                    return { error: String(e) };
                                }
                            }

                            window.debugFirebaseSignIn = debugFirebaseSignIn;

                            // Deixa as funções disponíveis para o seu site
                            window.salvarDados = salvarDados;

                            // Guard: evita que a classe .popover-hidden seja readicionada enquanto o popover estiver visível
                            (function(){
                                function guardOnce() {
                                    try {
                                        const pop = document.getElementById('popoverRedefinir');
                                        if (!pop) return;
                                        if (pop.dataset && pop.dataset.visible === 'true') {
                                            let checks = 0;
                                            const id = setInterval(() => {
                                                try {
                                                    if (!pop) { clearInterval(id); return; }
                                                    if (pop.classList && pop.classList.contains('popover-hidden')) {
                                                        try { pop.classList.remove('popover-hidden'); pop.style.setProperty('display','block','important'); console.debug('[POPOVER-GUARD] removed popover-hidden'); } catch(_){ }
                                                    }
                                                    checks++;
                                                    if (checks > 25) clearInterval(id); // ~2.5s
                                                } catch(_) { clearInterval(id); }
                                            }, 100);
                                        }
                                    } catch(_){ }
                                }
                                // hook to run when popover visible is toggled
                                try { document.addEventListener('click', () => { try { guardOnce(); } catch(_){} }); } catch(_){ }
                                try { window.addEventListener('resize', guardOnce); } catch(_){ }
                                // expose for debug
                                try { window.__guardOnce_popover = guardOnce; } catch(_){ }
                            })();
                            window.carregarDados = carregarDados;

                            window.debugFirebaseSignIn = debugFirebaseSignIn;

                            // Deixa as funções disponíveis para o seu site
                            window.salvarDados = salvarDados;

                            // Guard: evita que a classe .popover-hidden seja readicionada enquanto o popover estiver visível
                            (function(){
                                function guardOnce() {
                                    try {
                                        const pop = document.getElementById('popoverRedefinir');
                                        if (!pop) return;
                                        if (pop.dataset && pop.dataset.visible === 'true') {
                                            let checks = 0;
                                            const id = setInterval(() => {
                                                try {
                                                    if (!pop) { clearInterval(id); return; }
                                                    if (pop.classList && pop.classList.contains('popover-hidden')) {
                                                        try { pop.classList.remove('popover-hidden'); pop.style.setProperty('display','block','important'); console.debug('[POPOVER-GUARD] removed popover-hidden'); } catch(_){}
                                                    }
                                                    checks++;
                                                    if (checks > 25) clearInterval(id); // ~2.5s
                                                } catch(_) { clearInterval(id); }
                                            }, 100);
                                        }
                                    } catch(_){}
                                }
                                // hook to run when popover visible is toggled
                                try { document.addEventListener('click', () => { try { guardOnce(); } catch(_){} }); } catch(_){}
                                try { window.addEventListener('resize', guardOnce); } catch(_){}
                                // expose for debug
                                try { window.__guardOnce_popover = guardOnce; } catch(_){}
                            })();
                            window.carregarDados = carregarDados;

                        // Final override para garantir que abrir os painéis não dispare downloads indesejados
                        (function finalOverride(){
                            try {
                                document.addEventListener('DOMContentLoaded', function(){
                                    try {
                                        const mapping = {
                                            pluginDigitalBox: 'modalPlugins',
                                            relatorioBugsBox: 'modalRelatorioBugs'
                                        };
                                        Object.keys(mapping).forEach(id => {
                                            try {
                                                const el = document.getElementById(id);
                                                if (!el || !el.parentNode) return;
                                                const clone = el.cloneNode(true);
                                                el.parentNode.replaceChild(clone, el);
                                                const n = document.getElementById(id);
                                                if (!n) return;
                                                n.addEventListener('click', (e)=>{
                                                    try { e.stopImmediatePropagation(); e.preventDefault(); } catch(_){ }
                                                    const modalId = mapping[id];
                                                    const modal = document.getElementById(modalId);
                                                    if (modal) {
                                                        modal.style.display = 'flex';
                                                        modal.dataset.open = 'true';
                                                        try { document.body.classList.add('modal-open'); } catch(_){ }
                                                    }
                                                });
                                            } catch(_){ }
                                        });
                                    } catch (err) { console.error('finalOverride click binding error', err); }
                                });
                            } catch (e) { console.error('finalOverride init error', e); }
                        })();

                        </script>
</body>
</html>
