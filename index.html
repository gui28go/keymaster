<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerenciador de Senhas</title>
    <!-- Acelera conexão com CDN dos scripts (CryptoJS) em redes móveis -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
  <style>
:root {

--border-radius-main: 24px;
--border-radius-inner: 16px;
--blur-intensity: 15px;
--background-color: rgba(23, 42, 69, 0.75); 
--border-color: rgba(173, 216, 230, 0.15); 
--text-color: #f0f0f0;
--shadow-color: rgba(0, 0, 0, 0.25);
--primary-accent: #007aff;
--primary-accent-hover: #0056b3;
--danger-accent: #ff3b30;
--dark-blue-bg: #0d1b2a; 
--body-bg: linear-gradient(135deg, var(--dark-blue-bg), #1a1a1a);
--input-bg: rgba(13, 27, 42, 0.5); 
--input-focus-bg: rgba(13, 27, 42, 0.7);
--input-placeholder-color: rgba(255,255,255,0.5);
--button-bg: rgba(173, 216, 230, 0.1);
--button-hover-bg: rgba(173, 216, 230, 0.2);
--button-text-color: #fff;
--strong-text-color: #fff;
--marcador-cor-importante: #ffd700;
}

body[data-theme="light"] {

--background-color: rgba(240, 245, 255, 0.9); 
--border-color: rgba(0, 0, 0, 0.1);
--text-color: #1b263b; 
--shadow-color: rgba(0, 0, 0, 0.1);
--body-bg: linear-gradient(135deg, #e0eafc, #cfdef3); 
--input-bg: rgba(255, 255, 255, 0.6);
--input-focus-bg: rgba(255, 255, 255, 0.8);
--input-placeholder-color: rgba(0, 0, 0, 0.4);
--button-bg: rgba(0, 0, 0, 0.05);
--button-hover-bg: rgba(0, 0, 0, 0.1);
--button-text-color: #1b263b; 
--strong-text-color: var(--dark-blue-bg); 
}

* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: var(--body-bg);
background-attachment: scroll;
color: var(--text-color);
min-height: 100vh;
position: relative;
transition: background 0.3s ease;
}

/* Modo leve: reduz blur, sombras e transições para priorizar performance */
:root {
    --blur-intensity: 0px;
    --shadow-color: rgba(0, 0, 0, 0.12);
}

.modal, .modalContent, .message-box, .fab-button, .card, .popover {
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1) !important;
}

.fab-button, .fab-action-button, .fab-main, .action-button, button, .card, .popover, .modal, .message-box {
    transition-duration: 150ms !important;
    transition-timing-function: ease-out !important;
}

/* Otimizações de performance específicas para mobile (Chrome) */
@media (max-width: 480px) {
    :root { --blur-intensity: 0px; }
    /* Evitar filtros pesados e sombras exageradas no mobile */
    .modal, .modalContent, .message-box, #theme-toggle-btn, #floating-wrench-btn {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }
    .modal { background: rgba(10,10,10,0.35) !important; }
    .modalContent, .message-box { box-shadow: 0 8px 20px rgba(0,0,0,0.35) !important; }
    #theme-toggle-btn, #floating-wrench-btn { box-shadow: none !important; }
    /* Reduzir custos de animação/transições intensas */
    #theme-toggle-btn, #floating-wrench-btn, .action-button, .fab-container *, .card .full-view-btn {
        transition-duration: 120ms !important;
    }
}

body.modal-open {
overflow: hidden;
}

/* Garantir scroll interno nos modais */
body.modal-open .modalContent {
overflow-y: auto !important;
max-height: 90vh !important;
}

/* Remover bordas indesejadas dos botões dos modais */
.modalButtons button,
.modalContent button {
border: none !important;
}

/* Reset completo para botões em formulários */
.modalButtons button,
.modalButtons button *,
.modalContent button,
.modalContent button * {
border: 0 !important;
outline: 0 !important;
}

#theme-toggle-btn {
position: fixed;
top: 15px;
right: 15px;
width: 48px;
height: 48px;
border-radius: 50%;
border: 1px solid var(--border-color);
background-color: var(--background-color);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
cursor: pointer;
z-index: 1001;
display: flex;
justify-content: center;
align-items: center;
transition: all 0.3s ease;
padding: 8px;
}

#theme-toggle-btn:hover {
transform: scale(1.1) rotate(15deg);
box-shadow: 0 4px 15px var(--shadow-color);
}

#theme-toggle-btn .icon-sun { display: block; }
#theme-toggle-btn .icon-moon { display: none; }

body[data-theme="light"] #theme-toggle-btn .icon-sun { display: none; }
body[data-theme="light"] #theme-toggle-btn .icon-moon { display: block; }

#floating-wrench-btn {
position: fixed;
bottom: 15px;
left: 15px;
width: 48px;
height: 48px;
border-radius: 50%;
border: 1px solid var(--border-color);
background-color: var(--background-color);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
cursor: pointer;
z-index: 1001;
display: flex;
justify-content: center;
align-items: center;
transition: all 0.3s ease;
padding: 8px;
}
#floating-wrench-btn:hover {
transform: scale(1.1) rotate(-15deg);
box-shadow: 0 4px 15px var(--shadow-color);
}



#login, #certificado, #anotacoesLogin, #acessoEspecial, #recuperarPin {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border-radius: var(--border-radius-main);
border: 1px solid var(--border-color);
box-shadow: 0 8px 32px 0 var(--shadow-color);
max-width: 550px; 
width: 100%;
padding: 40px;
margin: 40px auto;
transition: all 0.3s ease;
}


#app, #anotacoesApp, #autoFillSettings, #autoFillForm {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border-radius: var(--border-radius-main);
border: 1px solid var(--border-color);
box-shadow: 0 8px 32px 0 var(--shadow-color);
max-width: 1200px; 
width: 100%;
padding: 40px 30px;
margin: 40px auto;
transition: all 0.3s ease;
}


h1, h2.page-title {
font-size: 1.8rem;
font-weight: 600;
text-align: center;
margin-bottom: 30px;
text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.input-container {
position: relative;
width: 100%;

}
input[type="password"], input[type="text"], input[type="tel"], textarea {
width: 100%;
padding: 14px 16px;
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
font-size: 1rem;
background: var(--input-bg);
color: var(--text-color);
resize: vertical;
transition: all 0.3s ease;

}

#modalSenha .input-container input, #modalSenha .input-container textarea {
padding-right: 35px; 
}

#formAnotacao .input-container input, #formAnotacao .input-container textarea {
    padding-right: 35px;
}


.input-container input {
margin-bottom: 0;
}

#gmail-helper, #gmail-helper-anotacao {
  position: absolute;
}

input[type="password"]:focus, input[type="text"]:focus, input[type="tel"]:focus, textarea:focus {
outline: none;
border-color: var(--primary-accent);
box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
background: var(--input-focus-bg);
}

button {
cursor: pointer;
border: none;
background-color: var(--button-bg);
color: var(--button-text-color);
padding: 10px 16px;
border-radius: var(--border-radius-inner);
font-size: 0.95rem;
font-weight: 600;
transition: all 0.3s ease;
user-select: none;
border: 1px solid var(--border-color);
}

button:hover {
background-color: var(--button-hover-bg);
transform: translateY(-2px);
}

button:active {
transform: translateY(0);
}

.login-buttons button, .modalButtons button[type="submit"], #btnInstalar, #btn-autofill-save, #btnVerificarSenhaEspecial, #btnPinRecuperadoConcluido, #btnRealizarUpload {
background-color: var(--primary-accent);
border: none;
color: white;
}

.message-box button.primary-action {
background-color: var(--primary-accent);
border: none;
color: white;
}
.message-box button.primary-action:hover {
background-color: var(--primary-accent-hover);
}

.login-buttons button:hover, .modalButtons button[type="submit"]:hover, #btnInstalar:hover, #btn-autofill-save:hover, #btnVerificarSenhaEspecial:hover, #btnPinRecuperadoConcluido:hover, #btnRealizarUpload:hover {
background-color: var(--primary-accent-hover);
}


#app, #anotacoesApp {
display: none;
}

#certificado, #anotacoesLogin, #autoFillSettings, #autoFillForm, #acessoEspecial, #recuperarPin {
display: none;
text-align: center;
}

#pin-container {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0;
}

.pin-input {
width: 50px;
height: 60px;
font-size: 2rem;
text-align: center;
caret-color: var(--primary-accent);
}


#forgot-pin-link {
display: block;
text-align: center;
margin-top: 15px;
cursor: pointer;
font-size: 0.9em;
color: rgba(255, 255, 255, 0.6);
transition: color 0.3s ease;
}
body[data-theme="light"] #forgot-pin-link {
color: rgba(0, 0, 0, 0.6);
}
#pin-recuperado-container {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0;
}
.pin-recuperado-box {
width: 50px;
height: 60px;
font-size: 2rem;
text-align: center;
line-height: 60px;
background-color: var(--input-bg);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
color: var(--text-color);
font-weight: bold;
}


.top-bar {
display: flex;
justify-content: space-between;
align-items: center;
gap: 10px;
margin-bottom: 20px;
}

#boards, #anotacoesBoards {
display: flex;
gap: 20px;
justify-content: center;
flex-wrap: wrap;
margin-top: 20px;
}

.board-column {
background: var(--input-bg);
border-radius: var(--border-radius-inner);
box-shadow: 0 5px 15px var(--shadow-color);
width: 300px; 
padding: 16px;
transition: 0.3s;
display: flex;
flex-direction: column;
border: 1px solid var(--border-color);
}

.board-column h3 {
margin-top: 0;
font-size: 1.1rem;
display: flex;
justify-content: space-between;
align-items: center;
gap: 8px;
cursor: pointer;
user-select: none;
}

.btn-excluir-categoria {
background-color: rgba(231, 76, 60, 0.5);
color: white;
font-weight: 600;
border-radius: 50%;
width: 24px;
height: 24px;
line-height: 22px;
text-align: center;
padding: 0;
cursor: pointer;
border: none;
font-size: 1.2rem;
display: flex;
justify-content: center;
align-items: center;
transition: background-color 0.3s ease;
}

.btn-excluir-categoria:hover {
background-color: rgba(192, 57, 43, 0.8);
}

.card {
border-radius: 12px;
padding: 12px;
margin-bottom: 12px;
font-size: 0.95rem;
background: var(--background-color);
position: relative;
text-align: left;
box-shadow: inset 0 0 0 1px var(--border-color);
display: flex;
flex-direction: column;
}

/* Borda colorida para cards com marcador */
.card[data-marcador-cor] {
box-shadow: none;
border: 2px solid var(--marcador-cor);
}

/* Borda mais destacada para marcadores importantes */
.card[data-marcador-importante="true"] {
border-width: 3px;
}

/* Brilho no modal quando editando item com marcador importante */
#modalSenha.marcador-importante-ativo .modalContent,
#modalAnotacao.marcador-importante-ativo .modalContent {
border: 3px solid var(--marcador-cor-importante);
box-shadow: 0 0 20px var(--marcador-cor-importante), 0 8px 32px 0 var(--shadow-color);
}

/* Layout simplificado das cartas de senha */
.card .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}
.card .card-title {
    font-size: 1.02rem;
}
.card .card-meta {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
}
.card .chip {
    display: flex;
    align-items: center;
    justify-content: flex-start; /* texto do mesmo lado da seção */
    gap: 10px;
    width: 100%;
    min-height: 40px;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    background: var(--input-bg);
    border-radius: var(--border-radius-inner);
    font-size: 0.9rem;
}
.card .chip-label {
    opacity: 0.7;
}
.card .chip-value {
    font-weight: 600;
    flex: 1 1 auto;  /* ocupa o restante sem empurrar para o outro lado */
    min-width: 0;     /* necessário para ellipsis com flex */
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
.card .chip-value a {
    color: var(--primary-accent);
    text-decoration: none;
}
.card .chip-value a:hover {
    text-decoration: underline;
}
.card .chip-label::after {
    content: ":";
    margin: 0 4px 0 2px;
    opacity: 0.6;
}
.card .notas-preview {
    margin-top: 14px;
    padding: 8px 10px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    font-size: 0.9rem;
    color: var(--text-color);
    line-height: 1.4;
    width: 100%;
    min-height: calc(1.4em * 3); /* altura consistente para 3 linhas */
    display: -webkit-box;
    line-clamp: 3;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.card .links-chip {
    margin-top: 12px;
}
.card .links-chip a {
    display: block;
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--input-bg);
    color: var(--primary-accent);
    text-decoration: none;
    font-size: 0.9rem;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
}
.card .links-chip a:hover {
    text-decoration: underline;
}

strong {
color: var(--strong-text-color);
font-weight: 600;
}

.notas-box {
background: var(--input-bg);
border-radius: 8px;
padding: 8px 10px;
margin-top: 6px;
white-space: pre-wrap;
word-wrap: break-word;
}
.links-box {
margin-top: 8px;
word-break: break-word;
}

.links-box a {
color: var(--primary-accent);
text-decoration: none;
word-break: break-word;
}



.message-box.improvements {
    z-index: 12001 !important;
    box-shadow: 0 18px 50px rgba(0,0,0,0.55) !important;
}
.card-buttons {
display: flex;
justify-content: center;
gap: 8px;
margin-top: 12px;
flex-wrap: wrap;
}

.card-buttons button {
padding: 6px 14px;
font-size: 0.85rem;
border-radius: 8px;
background-color: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.12);
display: flex;
align-items: center;
justify-content: center;
}

.card-buttons button.visualizar-icone {
padding: 6px;
}
.card-buttons button.visualizar-icone svg {
width: 20px;
height: 20px;
}

.card-buttons button:hover {
background-color: rgba(255, 255, 255, 0.15);
}

.card-buttons button.excluir {
background-color: var(--danger-accent);
border: none;
}
.card-buttons button.excluir:hover {
background-color: #c0392b;
}

/* Botão de Visualização Completa (CTA) ocupando toda a largura do card */
.card .full-view-btn {
    width: 100%;
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    height: 44px;
    border-radius: 10px;
    background: var(--primary-accent);
    color: #fff;
    border: none;
    box-shadow: 0 4px 12px var(--shadow-color);
    transition: transform 0.12s ease, box-shadow 0.2s ease, background 0.2s ease;
}
.card .full-view-btn:hover {
    background: var(--primary-accent-hover);
    transform: translateY(-1px);
    box-shadow: 0 6px 16px var(--shadow-color);
}
.card .full-view-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px var(--shadow-color);
}
.card .full-view-btn svg {
    width: 20px;
    height: 20px;
}
.card .full-view-btn .btn-label {
    font-size: 0.95rem;
}

@media (max-width: 480px) {
    .card .full-view-btn {
        height: 40px;
        gap: 8px;
    }
    .card .full-view-btn svg {
        width: 18px;
        height: 18px;
    }
    .card .full-view-btn .btn-label {
        font-size: 0.9rem;
    }
}

.modal {
position: fixed;
inset: 0;
background: rgba(10, 10, 10, 0.3);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
display: none;
align-items: center;
justify-content: center;
z-index: 999;
padding: 20px;
}


.modalContent {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border: 1px solid var(--border-color);
border-radius: var(--border-radius-main);
padding: 32px;
width: 100%;
max-width: 800px; 
box-shadow: 0 8px 32px 0 var(--shadow-color);
text-align: center;
display: flex;
flex-direction: column;
max-height: 90vh;
overflow-y: auto;
}


.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 20px;
    margin-bottom: 20px;
}

.grid-span-2 {
    grid-column: span 2; 
}


@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr; 
        gap: 16px;
    }
    .grid-span-2 {
        grid-column: span 1; 
    }
    .modalContent {
      max-width: 400px; 
    }
}


#btn-autofill-trigger {
width: 100%;
margin-bottom: 20px;
padding: 8px;
font-size: 0.9rem;
}

.modalContent h2 {
margin-top: 0;
font-size: 1.4rem;
margin-bottom: 20px;
}

.modalButtons {
display: flex;
justify-content: center;
gap: 20px;
margin-top: 20px;
flex-wrap: wrap;
}

.modalButtons button {
min-width: 100px;
padding: 10px 0;
}

/* Botões do formulário de autofill alinhados lado a lado (especialmente no desktop) */
#autoFillForm .modalButtons {
    flex-wrap: nowrap;
    justify-content: flex-end;
    gap: 12px;
}

#autoFillForm .modalButtons button {
    min-width: 130px;
    padding: 10px 14px;
    flex: 0 0 auto;
}

@media (max-width: 540px) {
    #autoFillForm .modalButtons {
        flex-wrap: wrap;
        justify-content: center;
    }
    #autoFillForm .modalButtons button {
        flex: 1 1 48%;
    }
}

#modalDesenvolvimento .modalButtons {
  flex-direction: column;
}
#modalDesenvolvimento .main-actions {
  display: flex;
  gap: 10px;
  width: 100%;
}
#modalDesenvolvimento .main-actions button:not(#btnVerMelhorias) {
  flex: 1;
}

#btnVerMelhorias {
  flex: 0 0 48px;
  width: 48px;
  height: 48px;
  padding: 8px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  min-width: auto;
}
#btnVerMelhorias:hover {
  transform: scale(1.1) rotate(15deg);
  box-shadow: 0 4px 15px var(--shadow-color);
}
#btnVerMelhorias svg {
  width: 24px;
  height: 24px;
  stroke: var(--button-text-color);
}


#new-column-name, #new-anotacao-column-name {
margin-bottom: 10px;
font-size: 1rem;
padding: 10px 14px;
}

#btnAdicionarCategoria, #btnAdicionarAnotacaoCategoria {
margin-bottom: 30px;
width: 100%;
font-size: 1rem;
}

.filter-controls {
display: none;
flex-direction: column;
gap: 10px;
margin-bottom: 30px;
}
.filter-controls input {
margin-bottom: 0;
}
.filter-buttons-container {
display: flex;
gap: 10px;
}
.filter-buttons-container button {
flex: 1;
}


.modo-leitura .card-buttons button:not(.visualizar) {
display: none !important;
}


.modo-leitura .board-column > button,
.modo-leitura .btn-excluir-categoria,
.modo-leitura .top-bar button:not(#btnModoLeitura):not(#btnModoLeituraAnotacao),
.modo-leitura .modalButtons {
display: none !important;
}

.modo-leitura .filter-controls {
display: flex !important;
}

.modo-leitura #new-column-name,
.modo-leitura #btnAdicionarCategoria,
.modo-leitura #new-anotacao-column-name,
.modo-leitura #btnAdicionarAnotacaoCategoria {
display: none;
}

#visualizacao-content {
text-align: left;
word-wrap: break-word;
font-size: 0.95rem;
}

#visualizacao-content p {
margin-bottom: 8px;
line-height: 1.4;
}

.footerButtons {
margin-top: 40px;
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 20px;
}

.login-buttons {
display: flex;
flex-direction: column;
gap: 10px;
margin-top: 10px;
}

.login-buttons .row {
display: flex;
gap: 10px;
}

.login-buttons button {
flex: 1;
padding: 14px 0;
}


#version-link {
text-align: center;
margin-top: 15px;
cursor: pointer;
font-size: 0.9em;
color: rgba(255,255,255,0.6); 
transition: color 0.3s ease;
}
body[data-theme="light"] #version-link {
color: rgba(0,0,0,0.6); 
}


.codigo-box {
background: var(--input-bg);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
padding: 20px;
margin: 20px 0;
font-size: 1rem;
font-weight: bold;
letter-spacing: 2px;
min-height: 60px;
}
.codigo-box.clickable { cursor: pointer; }

.message-box {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
border: 1px solid var(--border-color);
padding: 30px;
border-radius: var(--border-radius-main);
box-shadow: 0 10px 30px var(--shadow-color);
text-align: center;
z-index: 1000;
display: none;
max-width: 90%;
width: 400px;
animation: fadeIn 0.3s ease-out;
}

.message-box h2 {
margin-top: 0;
color: var(--text-color);
}

.changelog {
  text-align: left;
  margin-top: 15px;
  padding-left: 20px;
  font-size: 0.9rem;
  max-height: 200px;
  overflow-y: auto;
}
.changelog li {
  margin-bottom: 8px;
}

.message-box button {
margin-top: 20px;
min-width: 120px;
}

.overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
z-index: 998;
display: none;
}

@keyframes fadeIn {
from { opacity: 0; transform: translate(-50%, -45%); }
to { opacity: 1; transform: translate(-50%, -50%); }
}

.loader {
border: 4px solid var(--input-bg);
border-top: 4px solid var(--text-color);
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 20px auto;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.progress-container {
width: 100%;
background-color: var(--input-bg);
border-radius: 10px;
margin: 20px 0;
overflow: hidden;
}

.progress-bar {
height: 20px;
background-color: var(--primary-accent);
border-radius: 10px;
width: 0%;
transition: width 0.5s ease;
}

.status-message {
margin: 10px 0;
font-size: 0.9rem;
min-height: 20px;
}


#update-dialog {
  color: var(--text-color);
  padding: 15px;
  border-radius: var(--border-radius-inner);
  text-align: center;
  font-size: 0.9rem;
  line-height: 1.5;
  width: 100%;
  margin: 20px 0 15px 0;
  border: 1px solid var(--border-color);
  background: var(--input-bg);
}
#btnRealizarUpload {
width: 100%;
padding: 12px 0;
font-size: 0.95rem;
margin-top: 15px;
}

/* Ações auxiliares abaixo do upload */
.helper-actions { 
    margin-top: 10px; 
    text-align: center; 
}
.link-like {
    display: block;
    width: fit-content;
    margin: 0 auto;
    background: transparent;
    border: none;
    padding: 8px 0;
    color: var(--primary-accent);
    text-decoration: underline;
    font-weight: 600;
}
.link-like:hover { 
    color: var(--primary-accent-hover);
    background: transparent; 
    transform: none; 
}

/* Timeline de instruções móveis */
.timeline {
    margin-top: 10px;
    padding-left: 8px;
    border-left: 2px solid var(--border-color);
    text-align: left; /* garante conteúdo alinhado à esquerda mesmo com o container centralizado */
}
.timeline-item {
    position: relative;
    display: flex;
    gap: 12px;
    padding: 10px 0 10px 12px;
}
.timeline-item .marker {
    position: relative;
    width: 28px;
    height: 28px;
    min-width: 28px;
    border-radius: 50%;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px var(--shadow-color);
}
.timeline-item .marker svg {
    width: 18px; height: 18px;
    stroke: var(--text-color);
}
.timeline-item .content { 
    flex: 1; 
}
.timeline-item .content strong { 
    display: inline-block; 
    margin-bottom: 4px; 
}
.timeline-item .content p { 
    margin: 0; 
    opacity: 0.85; 
    font-size: 0.9rem; 
}


.btn-clear-field {
position: absolute;
top: 50%;
right: 10px;
transform: translateY(-50%);
background: transparent;
border: none;
color: var(--text-color);
font-size: 1.5rem;
font-weight: bold;
line-height: 1;
padding: 0 5px;
cursor: pointer;
display: none; 
opacity: 0.6;
z-index: 5;
transition: right 0.3s ease; 
}
.btn-clear-field:hover {
opacity: 1;
background: none;
transform: translateY(-50%) scale(1.1);
}
</style>
<style>
:root {

--border-radius-main: 24px;
--border-radius-inner: 16px;
--blur-intensity: 15px;
--background-color: rgba(23, 42, 69, 0.75); 
--border-color: rgba(173, 216, 230, 0.15); 
--text-color: #f0f0f0;
--shadow-color: rgba(0, 0, 0, 0.25);
--primary-accent: #007aff;
--primary-accent-hover: #0056b3;
--danger-accent: #ff3b30;
--dark-blue-bg: #0d1b2a; 
--body-bg: linear-gradient(135deg, var(--dark-blue-bg), #1a1a1a);
--input-bg: rgba(13, 27, 42, 0.5); 
--input-focus-bg: rgba(13, 27, 42, 0.7);
--input-placeholder-color: rgba(255,255,255,0.5);
--button-bg: rgba(173, 216, 230, 0.1);
--button-hover-bg: rgba(173, 216, 230, 0.2);
--button-text-color: #fff;
--strong-text-color: #fff;
}

body[data-theme="light"] {

--background-color: rgba(240, 245, 255, 0.9); 
--border-color: rgba(0, 0, 0, 0.1);
--text-color: #1b263b; 
--shadow-color: rgba(0, 0, 0, 0.1);
--body-bg: linear-gradient(135deg, #e0eafc, #cfdef3); 
--input-bg: rgba(255, 255, 255, 0.6);
--input-focus-bg: rgba(255, 255, 255, 0.8);
--input-placeholder-color: rgba(0, 0, 0, 0.4);
--button-bg: rgba(0, 0, 0, 0.05);
--button-hover-bg: rgba(0, 0, 0, 0.1);
--button-text-color: #1b263b; 
--strong-text-color: var(--dark-blue-bg); 
}

* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: var(--body-bg);
background-attachment: fixed;
color: var(--text-color);
min-height: 100vh;
position: relative;
transition: background 0.3s ease;
}

body.modal-open {
overflow: hidden;
}

#theme-toggle-btn {
position: fixed;
top: 15px;
right: 15px;
width: 48px;
height: 48px;
border-radius: 50%;
border: 1px solid var(--border-color);
background-color: var(--background-color);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
cursor: pointer;
z-index: 1001;
display: flex;
justify-content: center;
align-items: center;
transition: all 0.3s ease;
padding: 8px;
}

#theme-toggle-btn:hover {
transform: scale(1.1) rotate(15deg);
box-shadow: 0 4px 15px var(--shadow-color);
}

#theme-toggle-btn .icon-sun { display: block; }
#theme-toggle-btn .icon-moon { display: none; }

body[data-theme="light"] #theme-toggle-btn .icon-sun { display: none; }
body[data-theme="light"] #theme-toggle-btn .icon-moon { display: block; }

#floating-wrench-btn {
position: fixed;
bottom: 15px;
left: 15px;
width: 48px;
height: 48px;
border-radius: 50%;
border: 1px solid var(--border-color);
background-color: var(--background-color);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
cursor: pointer;
z-index: 1001;
display: flex;
justify-content: center;
align-items: center;
transition: all 0.3s ease;
padding: 8px;
}
#floating-wrench-btn:hover {
transform: scale(1.1) rotate(-15deg);
box-shadow: 0 4px 15px var(--shadow-color);
}



#login, #certificado, #anotacoesLogin, #acessoEspecial, #recuperarPin {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border-radius: var(--border-radius-main);
border: 1px solid var(--border-color);
box-shadow: 0 8px 32px 0 var(--shadow-color);
max-width: 550px; 
width: 100%;
padding: 40px;
margin: 40px auto;
transition: all 0.3s ease;
}


#app, #anotacoesApp, #autoFillSettings, #autoFillForm {
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
border-radius: var(--border-radius-main);
border: 1px solid var(--border-color);
box-shadow: 0 8px 32px 0 var(--shadow-color);
max-width: 1200px; 
width: 100%;
padding: 40px 30px;
margin: 40px auto;
transition: all 0.3s ease;
}


h1, h2.page-title {
font-size: 1.8rem;
font-weight: 600;
text-align: center;
margin-bottom: 30px;
text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.input-container {
position: relative;
width: 100%;

}
input[type="password"], input[type="text"], input[type="tel"], textarea {
width: 100%;
padding: 14px 16px;
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
font-size: 1rem;
background: var(--input-bg);
color: var(--text-color);
resize: vertical;
transition: all 0.3s ease;

}

#modalSenha .input-container input, #modalSenha .input-container textarea {
padding-right: 35px; 
}


.input-container input {
margin-bottom: 0;
}

#gmail-helper, #gmail-helper-anotacao {
  position: absolute;
  top: 50%;
  right: 45px; 
  transform: translateY(-50%);
  padding: 6px 8px;
  font-size: 1rem; 
  font-weight: normal;
  background-color: transparent; 
  border: none; 
  color: var(--input-placeholder-color); 
  opacity: 0;
  pointer-events: none; 
  transition: opacity 0.3s ease;
  cursor: pointer;
  z-index: 3;
}
#gmail-helper.visible, #gmail-helper-anotacao.visible {
opacity: 1;
pointer-events: auto;
}


#inputEmail {
  padding-right: 40px !important; 
}

#inputEmailAnotacao {
    padding-right: 40px !important;
}


input[type="password"]::placeholder, input[type="text"]::placeholder, input[type="tel"]::placeholder, textarea::placeholder {
color: var(--input-placeholder-color);
}

input[type="password"]:focus, input[type="text"]:focus, input[type="tel"]:focus, textarea:focus {
outline: none;
border-color: var(--primary-accent);
box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
background: var(--input-focus-bg);
}

button {
cursor: pointer;
border: none;
background-color: var(--button-bg);
color: var(--button-text-color);
padding: 10px 16px;
border-radius: var(--border-radius-inner);
font-size: 0.95rem;
font-weight: 600;
transition: all 0.3s ease;
user-select: none;
border: 1px solid var(--border-color);
}

button:hover {
background-color: var(--button-hover-bg);
transform: translateY(-2px);
}

button:active {
transform: translateY(0);
}

.login-buttons button, .modalButtons button[type="submit"], #btnInstalar, #btn-autofill-save, #btnVerificarSenhaEspecial, #btnPinRecuperadoConcluido, #btnRealizarUpload {
background-color: var(--primary-accent);
border: none;
color: white;
}

.message-box button.primary-action {
background-color: var(--primary-accent);
border: none;
color: white;
}
.message-box button.primary-action:hover {
background-color: var(--primary-accent-hover);
}

.login-buttons button:hover, .modalButtons button[type="submit"]:hover, #btnInstalar:hover, #btn-autofill-save:hover, #btnVerificarSenhaEspecial:hover, #btnPinRecuperadoConcluido:hover, #btnRealizarUpload:hover {
background-color: var(--primary-accent-hover);
}


#app, #anotacoesApp {
display: none;
}

#certificado, #anotacoesLogin, #autoFillSettings, #autoFillForm, #acessoEspecial, #recuperarPin {
display: none;
text-align: center;
}

#pin-container {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0;
}

.pin-input {
width: 50px;
height: 60px;
font-size: 2rem;
text-align: center;
caret-color: var(--primary-accent);
}


#forgot-pin-link {
display: block;
text-align: center;
margin-top: 15px;
cursor: pointer;
font-size: 0.9em;
color: rgba(255, 255, 255, 0.6);
transition: color 0.3s ease;
}
body[data-theme="light"] #forgot-pin-link {
color: rgba(0, 0, 0, 0.6);
}
#pin-recuperado-container {
display: flex;
justify-content: center;
gap: 10px;
margin: 20px 0;
}
.pin-recuperado-box {
width: 50px;
height: 60px;
font-size: 2rem;
text-align: center;
line-height: 60px;
background-color: var(--input-bg);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
color: var(--text-color);
font-weight: bold;
}


.top-bar {
display: flex;
justify-content: space-between;
align-items: center;
gap: 10px;
margin-bottom: 20px;
}

#boards, #anotacoesBoards {
display: flex;
gap: 20px;
justify-content: center;
flex-wrap: wrap;
margin-top: 20px;
}

.board-column {
background: var(--input-bg);
border-radius: var(--border-radius-inner);
box-shadow: 0 5px 15px var(--shadow-color);
width: 300px; 
padding: 16px;
transition: 0.3s;
display: flex;
flex-direction: column;
border: 1px solid var(--border-color);
}

.board-column h3 {
margin-top: 0;
font-size: 1.1rem;
display: flex;
justify-content: space-between;
align-items: center;
gap: 8px;
cursor: pointer;
user-select: none;
}

.btn-excluir-categoria {
background-color: rgba(231, 76, 60, 0.5);
color: white;
font-weight: 600;
border-radius: 50%;
width: 24px;
height: 24px;
line-height: 22px;
text-align: center;
padding: 0;
cursor: pointer;
border: none;
font-size: 1.2rem;
display: flex;
justify-content: center;
align-items: center;
transition: background-color 0.3s ease;
}

.btn-excluir-categoria:hover {
background-color: rgba(192, 57, 43, 0.8);
}

.card {
border-radius: 12px;
padding: 12px;
margin-bottom: 12px;
font-size: 0.95rem;
background: var(--background-color);
position: relative;
text-align: left;
box-shadow: inset 0 0 0 1px var(--border-color);
display: flex;
flex-direction: column;
}

strong {
color: var(--strong-text-color);
font-weight: 600;
}

.notas-box {
background: var(--input-bg);
border-radius: 8px;
padding: 8px 10px;
margin-top: 6px;
white-space: pre-wrap;
word-wrap: break-word;
}
.links-box {
margin-top: 8px;
word-break: break-word;
}

.links-box a {
color: var(--primary-accent);
text-decoration: none;
word-break: break-word;
}

.card-buttons {
display: flex;
justify-content: center;
gap: 8px;
margin-top: 12px;
flex-wrap: wrap;
}

.card-buttons button {
padding: 6px 14px;
font-size: 0.85rem;
border-radius: 8px;
background-color: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.12);
display: flex;
align-items: center;
justify-content: center;
}

.card-buttons button.visualizar-icone {
padding: 6px;
}
.card-buttons button.visualizar-icone svg {
width: 20px;
height: 20px;
}

.card-buttons button:hover {
background-color: rgba(255, 255, 255, 0.15);
}

.card-buttons button.excluir {
background-color: var(--danger-accent);
border: none;
}
.card-buttons button.excluir:hover {
background-color: #c0392b;
}

.modal {
position: fixed;
inset: 0;
background: rgba(10, 10, 10, 0.3);
backdrop-filter: blur(5px);
-webkit-backdrop-filter: blur(5px);
display: none;
align-items: center;
justify-content: center;
z-index: 999;
padding: 20px;
}


.form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 20px;
    margin-bottom: 20px;
}

.grid-span-2 {
    grid-column: span 2; 
}


@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr; 
        gap: 16px;
    }
    .grid-span-2 {
        grid-column: span 1; 
    }
    .modalContent {
      max-width: 400px; 
    }
}


#btn-autofill-trigger {
width: 100%;
margin-bottom: 20px;
padding: 8px;
font-size: 0.9rem;
}

.modalContent h2 {
margin-top: 0;
font-size: 1.4rem;
margin-bottom: 20px;
}

.modalButtons {
display: flex;
justify-content: center;
gap: 20px;
margin-top: 20px;
flex-wrap: wrap;
}

.modalButtons button {
min-width: 100px;
padding: 10px 0;
}

#modalDesenvolvimento .modalButtons {
  flex-direction: column;
}
#modalDesenvolvimento .main-actions {
  display: flex;
  gap: 10px;
  width: 100%;
}
#modalDesenvolvimento .main-actions button:not(#btnVerMelhorias) {
  flex: 1;
}

#btnVerMelhorias {
  flex: 0 0 48px;
  width: 48px;
  height: 48px;
  padding: 8px;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  min-width: auto;
}
#btnVerMelhorias:hover {
  transform: scale(1.1) rotate(15deg);
  box-shadow: 0 4px 15px var(--shadow-color);
}
#btnVerMelhorias svg {
  width: 24px;
  height: 24px;
  stroke: var(--button-text-color);
}


#new-column-name, #new-anotacao-column-name {
margin-bottom: 10px;
font-size: 1rem;
padding: 10px 14px;
}

#btnAdicionarCategoria, #btnAdicionarAnotacaoCategoria {
margin-bottom: 30px;
width: 100%;
font-size: 1rem;
}

.filter-controls {
display: none;
flex-direction: column;
gap: 10px;
margin-bottom: 30px;
}
.filter-controls input {
margin-bottom: 0;
}
.filter-buttons-container {
display: flex;
gap: 10px;
}
.filter-buttons-container button {
flex: 1;
}


.modo-leitura .card-buttons button:not(.visualizar) {
display: none !important;
}


.modo-leitura .board-column > button,
.modo-leitura .btn-excluir-categoria,
.modo-leitura .top-bar button:not(#btnModoLeitura):not(#btnModoLeituraAnotacao),
.modo-leitura .modalButtons {
display: none !important;
}

.modo-leitura .filter-controls {
display: flex !important;
}

.modo-leitura #new-column-name,
.modo-leitura #btnAdicionarCategoria,
.modo-leitura #new-anotacao-column-name,
.modo-leitura #btnAdicionarAnotacaoCategoria {
display: none;
}

#visualizacao-content {
text-align: left;
word-wrap: break-word;
font-size: 0.95rem;
}

#visualizacao-content p {
margin-bottom: 8px;
line-height: 1.4;
}

.footerButtons {
margin-top: 40px;
display: flex;
flex-wrap: wrap;
justify-content: center;
gap: 20px;
}

.login-buttons {
display: flex;
flex-direction: column;
gap: 10px;
margin-top: 10px;
}

.login-buttons .row {
display: flex;
gap: 10px;
}

.login-buttons button {
flex: 1;
padding: 14px 0;
}


#version-link {
text-align: center;
margin-top: 15px;
cursor: pointer;
font-size: 0.9em;
color: rgba(255,255,255,0.6); 
transition: color 0.3s ease;
}
body[data-theme="light"] #version-link {
color: rgba(0,0,0,0.6); 
}


.codigo-box {
background: var(--input-bg);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
padding: 20px;
margin: 20px 0;
font-size: 1rem;
font-weight: bold;
letter-spacing: 2px;
min-height: 60px;
}

.message-box {
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: var(--background-color);
backdrop-filter: blur(var(--blur-intensity));
border: 1px solid var(--border-color);
padding: 30px;
border-radius: var(--border-radius-main);
box-shadow: 0 10px 30px var(--shadow-color);
text-align: center;
z-index: 1000;
display: none;
max-width: 90%;
width: 400px;
animation: fadeIn 0.3s ease-out;
}

.message-box h2 {
margin-top: 0;
color: var(--text-color);
}

.changelog {
  text-align: left;
  margin-top: 15px;
  padding-left: 20px;
  font-size: 0.9rem;
  max-height: 200px;
  overflow-y: auto;
}
.changelog li {
  margin-bottom: 8px;
}

.message-box button {
margin-top: 20px;
min-width: 120px;
}

.overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
z-index: 998;
display: none;
}

@keyframes fadeIn {
from { opacity: 0; transform: translate(-50%, -45%); }
to { opacity: 1; transform: translate(-50%, -50%); }
}

.loader {
border: 4px solid var(--input-bg);
border-top: 4px solid var(--text-color);
border-radius: 50%;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 20px auto;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.progress-container {
width: 100%;
background-color: var(--input-bg);
border-radius: 10px;
margin: 20px 0;
overflow: hidden;
}

.progress-bar {
height: 20px;
background-color: var(--primary-accent);
border-radius: 10px;
width: 0%;
transition: width 0.5s ease;
}

.status-message {
margin: 10px 0;
font-size: 0.9rem;
min-height: 20px;
}


#update-dialog {
  color: var(--text-color);
  padding: 15px;
  border-radius: var(--border-radius-inner);
  text-align: center;
  font-size: 0.9rem;
  line-height: 1.5;
  width: 100%;
  margin: 20px 0 15px 0;
  border: 1px solid var(--border-color);
  background: var(--input-bg);
}
#btnRealizarUpload {
width: 100%;
padding: 12px 0;
font-size: 0.95rem;
margin-top: 15px;
}


.btn-clear-field {
position: absolute;
top: 50%;
right: 10px;
transform: translateY(-50%);
background: transparent;
border: none;
color: var(--text-color);
font-size: 1.5rem;
font-weight: bold;
line-height: 1;
padding: 0 5px;
cursor: pointer;
display: none; 
opacity: 0.6;
z-index: 1; 
transition: all 0.3s ease;
}


.recent-items-menu {
position: absolute;
top: 100%;
left: 0;
right: 0;
max-height: 200px;
overflow-y: auto;
background: var(--background-color);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
z-index: 1000;
margin-top: 4px;
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
display: none;
box-shadow: 0 4px 12px var(--shadow-color);
}

.recent-items-menu.show {
display: block;
animation: fadeInDown 0.2s ease-out;
}

.recent-item {
padding: 10px 16px;
cursor: pointer;
transition: all 0.2s ease;
display: flex;
align-items: center;
gap: 8px;
color: var(--text-color);
}

.recent-item:hover {
background: var(--input-bg);
}

.recent-item svg {
width: 16px;
height: 16px;
stroke: var(--text-color);
opacity: 0.5;
}

.input-container.has-recent::after {
content: "";
position: absolute;
right: 12px;
top: 50%;
width: 10px;
height: 10px;
border: 2px solid var(--text-color);
border-left: 0;
border-top: 0;
opacity: 0.5;
transform: translateY(-50%) rotate(45deg);
pointer-events: none;
}

@keyframes fadeInDown {
from {
    opacity: 0;
    transform: translateY(-10px);
}
to {
    opacity: 1;
    transform: translateY(0);
}
}
.btn-clear-field:hover {
opacity: 1;
background: none;
transform: translateY(-50%);
}

/* Marcadores (Tags/Badges) - Design minimalista */
.marcador-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 0.7rem;
    font-weight: 500;
    color: #fff;
    opacity: 0.9;
    transition: opacity 0.2s ease;
}

.marcador-badge:hover {
    opacity: 1;
}

.marcadores-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    justify-content: center;
}

/* Select de marcadores nos formulários - minimalista */
.marcador-select-container {
    width: 100%;
}

.marcador-select-container select {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    font-size: 0.95rem;
    background: var(--input-bg);
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

.marcador-select-container select:focus {
    outline: none;
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3);
    background: var(--input-focus-bg);
}

.marcador-select-container select option {
    padding: 8px;
}

/* Modal de Gerenciamento de Marcadores - minimalista */
#modalMarcadores .modalContent {
    max-width: 550px;
}

.marcadores-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin: 20px 0;
    max-height: 350px;
    overflow-y: auto;
}

.marcador-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-radius: 8px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
}

.marcador-item:hover {
    background: var(--button-hover-bg);
}

.marcador-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.marcador-color-preview {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.2);
    flex-shrink: 0;
}

.marcador-name {
    font-weight: 500;
    font-size: 0.9rem;
    flex: 1;
}

.marcador-actions {
    display: flex;
    gap: 6px;
}

.marcador-actions button {
    padding: 5px 12px;
    font-size: 0.8rem;
    border-radius: 6px;
    min-width: auto;
    font-weight: 500;
}

.btn-edit-marcador {
    background: transparent;
    color: var(--text-color);
    border: 1px solid var(--border-color);
}

.btn-edit-marcador:hover {
    background: var(--button-hover-bg);
}

.btn-delete-marcador {
    background: transparent;
    color: var(--danger-accent);
    border: 1px solid var(--danger-accent);
}

.btn-delete-marcador:hover {
    background: var(--danger-accent);
    color: white;
}

.marcador-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    padding: 16px;
    background: var(--input-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 16px;
}

.marcador-form-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

.marcador-importante-container {
    display: flex;
    align-items: center;
    padding: 8px 0;
}

.marcador-importante-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 0.95rem;
    user-select: none;
}

.marcador-importante-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.marcador-importante-label span {
    display: flex;
    align-items: center;
    gap: 4px;
}

.marcador-form-row input[type="text"] {
    flex: 1;
}

.marcador-form-row input[type="color"] {
    width: 50px;
    height: 40px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    background: transparent;
}

.color-presets {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.color-preset {
    width: 28px;
    height: 28px;
    border-radius: 4px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.15s ease;
}

.color-preset:hover {
    transform: scale(1.1);
    border-color: rgba(255,255,255,0.3);
}

.color-preset.selected {
    border-color: var(--text-color);
    box-shadow: 0 0 0 2px var(--border-color);
}

@media (max-width: 768px) {
    #modalMarcadores .modalContent {
        padding: 24px 20px;
    }
    
    .marcador-item {
        padding: 8px 12px;
    }
    
    .marcador-name {
        font-size: 0.85rem;
    }
    
    .marcador-actions button {
        padding: 4px 10px;
        font-size: 0.75rem;
    }
    
    .color-preset {
        width: 24px;
        height: 24px;
    }
}

.search-btn.liquid-btn,
.view-saved-btn.liquid-btn,
.save-item-btn.liquid-btn {
z-index: 2;
}

.input-container {
position: relative;
}


.input-container input {
padding-right: 45px; 
}

.input-container:has(.search-btn) input,
.input-container:has(.view-saved-btn) input {
padding-right: 90px; 
}


.input-container .search-btn.liquid-btn,
.input-container .view-saved-btn.liquid-btn {
position: absolute;
right: 40px;
top: 50%;
transform: translateY(-50%);
}


.recent-items-menu {
position: absolute;
top: 100%;
left: 0;
right: 0;
max-height: 200px;
overflow-y: auto;
background: var(--background-color);
border: 1px solid var(--border-color);
border-radius: var(--border-radius-inner);
z-index: 1000;
margin-top: 4px;
backdrop-filter: blur(var(--blur-intensity));
-webkit-backdrop-filter: blur(var(--blur-intensity));
display: none;
box-shadow: 0 4px 12px var(--shadow-color);
}

.recent-items-menu.show {
display: block;
animation: fadeInDown 0.2s ease-out;
}

.recent-item {
padding: 10px 16px;
cursor: pointer;
transition: all 0.2s ease;
display: flex;
align-items: center;
gap: 8px;
color: var(--text-color);
}

.recent-item:hover {
background: var(--input-bg);
}

.recent-item svg {
width: 16px;
height: 16px;
stroke: var(--text-color);
opacity: 0.5;
}

.input-container.has-recent::after {
content: "";
position: absolute;
right: 12px;
top: 50%;
width: 10px;
height: 10px;
border: 2px solid var(--text-color);
border-left: 0;
border-top: 0;
opacity: 0.5;
transform: translateY(-50%) rotate(45deg);
pointer-events: none;
}

@keyframes fadeInDown {
from {
    opacity: 0;
    transform: translateY(-10px);
}
to {
    opacity: 1;
    transform: translateY(0);
}
}

</style>
<style>
/* Espaçamento consistente para o formulário Adicionar Anotação */
#modalAnotacao form {
    display: flex !important;
    flex-direction: column !important;
    gap: 16px !important;
}
#modalAnotacao form input,
#modalAnotacao form textarea {
    width: 100% !important;
    padding: 12px 14px !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--border-radius-inner) !important;
    background: var(--input-bg) !important;
}

/* Campos extras (Anotação) */
#btnMaisInfoAnotacao {
    align-self: stretch;
    width: 100%;
    display: flex;
    justify-content: center;
    text-align: center;
    padding: 8px 12px;
    border-radius: var(--border-radius-inner);
    border: 1px dashed var(--border-color);
    background: transparent;
    color: var(--text-color);
    cursor: pointer;
}

#btnMaisInfoAnotacao:hover {
    background: var(--card-bg);
}

#extraFieldsAnotacao {
    display: none;
    flex-direction: column;
    gap: 12px;
}

#extraFieldsAnotacao input {
    width: 100% !important;
}

/* Tornar borda arredondada em todos os formulários */
form {
    border-radius: var(--border-radius-inner) !important;
}

/* Busca com botão à esquerda */
.search-input-with-filters {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    margin: 8px 0;
}
.filter-btn {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    background: var(--button-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
}
.filter-btn svg { width: 18px; height: 18px; }

.filter-popover {
    position: absolute;
    z-index: 12000;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    padding: 12px;
    min-width: 280px;
    max-width: 400px;
}
.filter-popover h4 { 
    margin: 0 0 8px 0; 
    font-size: 0.95rem; 
}
.filter-field-select {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--input-bg);
    color: var(--text-color);
    font-size: 0.9rem;
    margin-bottom: 12px;
}
.filter-values-container {
    margin-top: 12px;
}
.filter-values-list {
    max-height: 250px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 8px;
}
.filter-value-item {
    padding: 10px 12px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}
.filter-value-item:hover {
    background: var(--button-hover-bg);
    transform: translateX(4px);
}
.no-values {
    padding: 20px;
    text-align: center;
    color: var(--text-color);
    opacity: 0.6;
    font-size: 0.9rem;
}
.filter-popover .actions { 
    display: flex; 
    gap: 8px; 
    justify-content: flex-end; 
    margin-top: 12px; 
}
.filter-popover .actions button {
    padding: 8px 16px;
    font-size: 0.9rem;
}
</style>
    <link rel="stylesheet" href="styles/theme.css">
</head>
<body>

<div class="fab-container">
    <button id="fab-main" class="fab-button fab-main" title="Menu">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="8" x2="12" y2="16"/>
            <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
    </button>
    <div class="fab-buttons">
        <button id="theme-toggle-btn" class="fab-button fab-action-button" title="Alterar tema">
            <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
        </button>
        <button id="fab-refresh-btn" class="fab-button fab-action-button" title="Atualizar rápido">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.56-3.36L23 10"></path>
                <path d="M20.49 15a9 9 0 0 1-14.56 3.36L1 14"></path>
            </svg>
        </button>
        <button id="floating-wrench-btn" class="fab-button fab-action-button" title="Opções">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg>
        </button>
    </div>
</div>

<div id="quick-refresh-box" class="quick-refresh-box" role="status" aria-live="polite">
    <div class="quick-refresh-header">
        <span class="quick-refresh-dot"></span>
        <div class="quick-refresh-text">
            <strong id="quick-refresh-title">Atualizando o site</strong>
            <small id="quick-refresh-caption">Aplicando ajustes rápidos sem sair do painel.</small>
        </div>
    </div>
    <div class="quick-refresh-progress">
        <div id="quick-refresh-progress" class="quick-refresh-progress-bar"></div>
    </div>
    <div class="quick-refresh-footer">
        <span id="quick-refresh-pill" class="quick-refresh-pill" data-state="running">Em andamento</span>
        <button id="quick-refresh-dismiss" type="button" class="quick-refresh-dismiss" aria-label="Fechar atualização">OK</button>
    </div>
</div>

<div id="popoverRedefinir" class="popover popover-hidden" data-visible="false" aria-hidden="true">
    <div class="popover-content">
        <header class="popover-header">
            <h3>Tempo de Atualização</h3>
            <p class="popover-subtitle">Reseta o contador para uma nova verificação em 30 dias.</p>
        </header>
        <div class="popover-body">Redefinir o tempo de atualização para 30 dias?</div>
        <div class="popover-actions">
            <button id="popoverConfirmRedefinir" class="btn-primary">Confirmar</button>
            <button id="popoverCancelRedefinir" class="btn-secondary">Cancelar</button>
        </div>
    </div>
</div>

<style>

/* Popover para confirmação ancorada ao botão (Opção A) */
.popover {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    min-width: 280px;
    max-width: 320px;
    background: var(--background-color);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 18px 20px;
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
    z-index: 14000;
    pointer-events: auto;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}
.popover-hidden {
    display: none;
}
.popover-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
    align-items: center;
    text-align: center;
}
.popover-header {
    text-align: center;
}
.popover-header h3 {
    font-size: 1.05rem;
    margin-bottom: 4px;
}
.popover-subtitle {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.75);
}
body[data-theme="light"] .popover-subtitle {
    color: rgba(0, 0, 0, 0.6);
}
.popover-body {
    font-size: 0.95rem;
    line-height: 1.4;
    text-align: center;
}
.popover-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}
.popover-actions button {
    flex: 1;
    min-width: 0;
}

/* Estilos dos botões dentro do popover para seguir o tema */
.popover .btn-primary {
    background-color: var(--primary-accent);
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.18);
}
.popover .btn-primary:hover {
    background-color: var(--primary-accent-hover);
}
.popover .btn-secondary {
    background: var(--button-bg);
    color: var(--button-text-color);
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    border-radius: 8px;
}

/* For light theme tweaks (use variables already set in body[data-theme]) */
body[data-theme="light"] .popover {
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
}


.fab-container {
    position: fixed !important;
    bottom: 2rem !important;
    right: 2rem !important;
    display: flex !important;
    flex-direction: column-reverse !important;
    align-items: center !important;
    gap: 1rem !important;
    z-index: 1001 !important;
}

.fab-button {
    width: 56px !important;
    height: 56px !important;
    border-radius: 50% !important;
    border: 1px solid var(--border-color) !important;
    background: var(--background-color) !important;
    backdrop-filter: blur(var(--blur-intensity)) !important;
    -webkit-backdrop-filter: blur(var(--blur-intensity)) !important;
    cursor: pointer !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    box-shadow: 0 2px 10px var(--shadow-color) !important;
    position: relative !important;
    top: auto !important;
    left: auto !important;
    right: auto !important;
    bottom: auto !important;
    padding: 0 !important;
}

.fab-main {
    background-color: var(--primary-accent) !important;
    z-index: 2 !important;
}

.fab-main svg {
    width: 24px !important;
    height: 24px !important;
    stroke: white !important;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.fab-buttons {
    position: absolute !important;
    bottom: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    gap: 0.8rem !important;
    transform: translateY(0) !important;
    opacity: 0 !important;
    pointer-events: none !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.fab-container.active .fab-buttons {
    transform: translateY(-40%) !important;
    opacity: 1 !important;
    pointer-events: all !important;
}

.fab-container.active .fab-main svg {
    transform: rotate(45deg) !important;
}

.fab-action-button {
    width: 56px !important;
    height: 56px !important;
    padding: 0 !important;
    border-radius: 50% !important;
    background: var(--background-color) !important;
    border: 1px solid var(--border-color) !important;
    transform: scale(0.96) !important;
    opacity: 0.95 !important;
    gap: 0 !important;
}

.fab-action-button:hover {
    transform: scale(1) !important;
    opacity: 1 !important;
    box-shadow: 0 8px 18px rgba(0,0,0,0.18) !important;
}

.fab-button svg {
    width: 22px !important;
    height: 22px !important;
    stroke: var(--text-color) !important;
    filter: drop-shadow(0 0 2px var(--shadow-color)) !important;
}

#theme-toggle-btn.fab-button .icon-sun { display: block !important; stroke: #FFD700 !important; }
#theme-toggle-btn.fab-button .icon-moon { display: none !important; stroke: #2c3e50 !important; }
body[data-theme="light"] #theme-toggle-btn.fab-button .icon-sun { display: none !important; }
body[data-theme="light"] #theme-toggle-btn.fab-button .icon-moon { display: block !important; }

#fab-refresh-btn svg {
    width: 20px !important;
    height: 20px !important;
}

.fab-label { display: none; }

.quick-refresh-box {
    position: fixed;
    bottom: calc(2rem + 78px);
    right: 2rem;
    width: min(340px, 92vw);
    padding: 14px 16px;
    border-radius: 16px;
    border: none;
    background: var(--background-color);
    box-shadow: 0 14px 38px var(--shadow-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    display: grid;
    gap: 10px;
    opacity: 0;
    transform: translateY(10px) scale(0.98);
    pointer-events: none;
    transition: all 0.28s ease;
    z-index: 1000;
}

.quick-refresh-box.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

.quick-refresh-header {
    display: flex;
    align-items: center;
    gap: 10px;
}

.quick-refresh-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary-accent);
    box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.08);
    animation: refreshPulse 1.4s ease-in-out infinite;
}

.quick-refresh-text strong {
    display: block;
    font-size: 0.95rem;
    color: var(--text-color);
}

.quick-refresh-text small {
    color: var(--subtext-color);
}

.quick-refresh-progress {
    width: 100%;
    height: 8px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.quick-refresh-progress-bar {
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, var(--primary-accent), rgba(255, 255, 255, 0.12));
    transition: width 1.3s ease;
}

.quick-refresh-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}

.quick-refresh-pill {
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--border-color);
    font-size: 0.85rem;
    color: var(--text-color);
}

.quick-refresh-pill[data-state="done"] {
    border-color: var(--primary-accent);
    color: var(--primary-accent);
}

.quick-refresh-dismiss {
    border: 1px solid var(--border-color);
    background: transparent;
    color: var(--text-color);
    border-radius: 12px;
    padding: 6px 10px;
    cursor: pointer;
    transition: border-color 0.2s ease, transform 0.2s ease;
}

.quick-refresh-dismiss:hover {
    border-color: var(--primary-accent);
    transform: translateY(-1px);
}

.quick-refresh-box.done .quick-refresh-dot {
    animation: none;
    background: var(--primary-accent);
    box-shadow: 0 0 0 8px rgba(0, 0, 0, 0.04);
}

.quick-refresh-box.done .quick-refresh-text strong {
    color: var(--primary-accent);
}

@keyframes refreshPulse {
    0% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.08); }
    100% { box-shadow: 0 0 0 14px rgba(0, 0, 0, 0); }
}
</style>

<div id="login">
<h1>ACESSO RESTRITO</h1>
<input type="password" id="masterPassword" placeholder="Senha mestre" autocomplete="off" />
<div class="login-buttons">
<div class="row">
<button id="btnEntrar">ENTRAR</button>
<button id="btnCertificado">CERTIFICADO</button>
</div>
<button id="btnAnotacoes">ACESSAR ANOTAÇÕES</button>
</div>

<div id="update-dialog" style="display: none;">
Aviso de nova atualização disponível. Acesse o modo Desenvolvedor para Atualizar ou realize a atualização manualmente. É necessário o certificado digital para o Upload.
<button id="btnRealizarUpload">Realizar Upload</button>
<div class="helper-actions">
  <button id="toggleMobileInstructions" type="button" class="link-like">Instruções para dispositivos</button>
  <div id="mobileInstructions" class="timeline" style="display:none;">
      <div class="timeline-item">
          <div class="marker"> 
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          </div>
          <div class="content"><strong>Baixe o certificado</strong><p>Inicie o processo para obter o arquivo de certificado necessário.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2l4 -4"/><path d="M12 22a10 10 0 1 0 0-20a10 10 0 0 0 0 20z"/></svg>
          </div>
          <div class="content"><strong>Autentique o certificado</strong><p>Confirme sua identidade/autorização quando solicitado.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h13"/><path d="M14 9l3 3l-3 3"/><rect x="3" y="5" width="7" height="14" rx="2"/></svg>
          </div>
          <div class="content"><strong>Seja redirecionado para o Google Drive</strong><p>Aguarde o redirecionamento automático para o Drive.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 10v-2a5 5 0 0 1 10 0v2"/><path d="M5 10h14v8a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-8z"/></svg>
          </div>
          <div class="content"><strong>Faça o download</strong><p>No Drive, toque em baixar para salvar o arquivo.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7h18v13H3z"/><path d="M3 7l3-4h12l3 4"/></svg>
          </div>
          <div class="content"><strong>Vá para o gerenciador de arquivos</strong><p>Abra o app de arquivos do seu dispositivo.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 12h8"/></svg>
          </div>
          <div class="content"><strong>Abra o arquivo</strong><p>Localize o arquivo baixado e toque para abrir.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2l4 -4"/><rect x="3" y="4" width="18" height="16" rx="2"/></svg>
          </div>
          <div class="content"><strong>Confirme a versão</strong><p>Verifique se a versão corresponde à exibida no app.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
          </div>
          <div class="content"><strong>Anexe na tela inicial</strong><p>Selecione anexar/importar o app na tela inicial.</p></div>
      </div>
      <div class="timeline-item">
          <div class="marker">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
          </div>
          <div class="content"><strong>Conclua o upload</strong><p>Finalize o envio e aguarde a confirmação.</p></div>
      </div>
  </div>
</div>
</div>

<div class="version-and-devices-container">
    <div id="version-link">
        <span class="version-text">Versão 95.0</span>
        <span class="update-timer">30 dias</span>
    </div>
    <div id="registered-devices-display" class="registered-devices-display" title="Aparelhos conectados"></div>
    <div id="current-device-chip" class="current-device-chip" role="status" aria-hidden="true" title="">
        <span id="current-device-chip-icon" class="device-chip-icon"></span>
    </div>
</div>

<!-- Modal: Aparelhos conectados (atalho rápido) -->
<div id="modal-aparelhos" class="modal" role="dialog" aria-modal="true" style="display:none;">
    <div class="modalContent modal-aparelhos-content">
        <h2>Aparelho conectado</h2>
        <div class="aparelhos-info-box">
            <div class="device-icon-large" id="modal-device-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="6" y="2" width="12" height="20" rx="2" ry="2" />
                </svg>
            </div>
            <div class="device-details">
                <div class="detail-row">
                    <span class="detail-label">Nome:</span>
                    <span class="detail-value" id="modal-device-name">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Senha:</span>
                    <span class="detail-value" id="modal-device-password">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Informações:</span>
                    <span class="detail-value" id="modal-device-info">-</span>
                </div>
            </div>
            <div class="aparelhos-stats">
                <div class="stat-item stat-item-full">
                    <span class="stat-number" id="modal-device-id">-</span>
                    <span class="stat-label">ID do aparelho</span>
                </div>
            </div>
        </div>
        <button id="btn-biodirecionamento" class="btn-biodirecionamento" style="margin-top: 20px !important; margin-bottom: 0 !important;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2h6" />
                <polyline points="15 3 21 3 21 9" />
                <line x1="10" y1="14" x2="21" y2="3" />
            </svg>
            Acessar Biodirecionamento
        </button>
        <button id="btn-fechar-modal-aparelhos" class="btn-fechar-modal" style="margin-top: 20px !important;">Fechar</button>
    </div>
</div>

<style>

.version-and-devices-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin: 15px auto;
    width: fit-content;
    flex-wrap: wrap;
}

#version-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 0;
    padding: 8px 15px;
    width: fit-content;
    min-width: 160px;
    min-height: 52px;
    font-size: 0.9em;
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

#version-link .version-text {
    color: var(--text-color);
    font-weight: 500;
}

#version-link .update-timer {
    color: var(--primary-accent);
    font-size: 0.85em;
    padding-left: 8px;
    border-left: 1px solid var(--border-color);
}

#version-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-color);
}

#registered-devices-display {
    width: 52px;
    height: 52px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--border-color);
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    box-shadow: 0 4px 12px var(--shadow-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

#registered-devices-display:empty::after {
    content: '';
}

.device-icon-display svg {
    height: 26px;
    width: auto;
    display: block;
    stroke: var(--primary-accent);
}

#registered-devices-display:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-color);
}

.autofill-actions {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin: 12px 0;
    width: 100%;
    grid-auto-rows: 1fr;
}

@media (min-width: 768px) {
    .autofill-actions {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }
}

.autofill-action {
    width: 100%;
    aspect-ratio: 1 / 1;
    min-height: 96px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 8px;
    text-align: center;
    padding: 10px;
    font-size: 1rem;
}

@supports not (aspect-ratio: 1 / 1) {
    .autofill-action {
        height: 120px;
    }
}

.autofill-action svg {
    width: 28px;
    height: 28px;
    stroke: var(--primary-accent);
    flex-shrink: 0;
}

.autofill-action span {
    display: block;
    line-height: 1.3;
}


.device-icon-options {
    flex-wrap: wrap;
    row-gap: 12px;
    justify-content: center;
}

@media (max-width: 480px) {
    .device-icon-options { gap: 10px; }
    #devices-list-container { max-height: 70vh; }
}

.device-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--input-bg);
    width: 100%;
    box-sizing: border-box;
}

.device-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    justify-content: flex-end;
    width: 100%;
}

.device-actions button {
    flex: 1 1 48%;
    min-width: 120px;
}

@media (min-width: 769px) {
    .device-row { align-items: center; }
    .device-actions {
        flex-wrap: nowrap;
        gap: 10px;
        justify-content: flex-end;
        margin-left: auto;
    }
    .device-actions button {
        flex: 0 0 auto;
        min-width: 110px;
        padding: 8px 12px;
    }
}

@media (max-width: 560px) {
    .device-row { flex-direction: column; align-items: flex-start; }
    .device-actions { justify-content: space-between; }
    .device-actions button { flex: 1 1 100%; min-width: 0; }
}

#modalDevices {
    align-items: flex-start;
    justify-content: center;
    padding: 14px 10px 20px;
    overflow-y: auto;
    overscroll-behavior: contain;
    touch-action: pan-y;
    height: 100vh;
}

#modalDevices .modalContent {
    max-height: none;
    overflow: visible;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
    width: min(680px, 100%);
    margin: 8px auto 0;
    min-height: 0;
    padding: 20px 18px 24px;
    box-sizing: border-box;
}

#devices-list-container {
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;
    max-height: 60vh;
    overflow-y: auto;
    overscroll-behavior: contain;
    padding-right: 4px;
    overflow-anchor: none;
}

.correlation-container {
    margin: 10px 0;
}

#current-device-chip {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    border: 1px solid var(--border-color);
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    box-shadow: 0 4px 12px var(--shadow-color);
    display: none;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    cursor: default;
}

.current-device-chip.visible {
    display: inline-flex;
}

.current-device-chip .device-chip-icon svg {
    height: 26px;
    width: auto;
    display: block;
    stroke: var(--text-color);
}

.modal-aparelhos-content {
    max-width: 500px;
}

.aparelhos-info-box {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 24px;
    margin: 20px 0;
    text-align: left;
}

.device-icon-large {
    width: 80px;
    height: 80px;
    margin: 0 auto 24px;
    background: var(--background-color);
    border: 2px solid var(--primary-accent);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px var(--shadow-color);
}

.device-icon-large svg {
    width: 40px;
    height: 40px;
    stroke: var(--primary-accent);
}

.device-details {
    margin-bottom: 24px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 600;
    color: var(--text-color);
    opacity: 0.7;
    font-size: 0.9rem;
}

.detail-value {
    font-weight: 500;
    color: var(--text-color);
    font-size: 0.95rem;
    text-align: right;
    max-width: 60%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.aparelhos-stats {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.stat-item {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    background: var(--background-color);
    text-align: center;
}

.stat-item-full {
    width: 100%;
}

.stat-number {
    display: block;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary-accent);
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    opacity: 0.75;
}

.btn-biodirecionamento {
    width: 100%;
    padding: 12px;
    border-radius: var(--border-radius-inner);
    border: 1px solid var(--border-color);
    background: linear-gradient(135deg, rgba(0,122,255,0.12), rgba(0,122,255,0.06));
    color: var(--text-color);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.btn-biodirecionamento svg {
    width: 20px;
    height: 20px;
}

.btn-biodirecionamento:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 18px rgba(0,0,0,0.18);
}

.btn-fechar-modal {
    width: 100%;
}


#update-dialog {
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-main);
    padding: 15px;
    margin: 20px 0;
    box-shadow: 0 4px 15px var(--shadow-color);
    transition: all 0.3s ease;
    animation: pulseGlow 2s infinite;
}

@keyframes pulseGlow {
    0% { box-shadow: 0 4px 15px var(--shadow-color); }
    50% { box-shadow: 0 4px 25px var(--primary-accent); }
    100% { box-shadow: 0 4px 15px var(--shadow-color); }
}

#update-dialog button {
    margin-top: 12px;
}
</style>
<div id="loginError" style="color:#ff3b30; margin-top: 10px; text-align: center;"></div>
</div>

<input type="file" id="updateFileInput" accept=".txt" style="display:none;" />


<div id="anotacoesLogin">
<h1>Digite a Senha</h1>
<div id="pin-container">
<input type="tel" class="pin-input" maxlength="1" inputmode="numeric">
<input type="tel" class="pin-input" maxlength="1" inputmode="numeric">
<input type="tel" class="pin-input" maxlength="1" inputmode="numeric">
<input type="tel" class="pin-input" maxlength="1" inputmode="numeric">
</div>
<p id="forgot-pin-link">Esqueci a senha</p>
<div id="pinError" style="color:#ff3b30; margin-top: 10px; text-align: center;"></div>
<button id="btnVoltarLoginAnotacoes" style="margin-top: 10px;">Voltar</button>
</div>

<style>
    /* Ajustes específicos para o painel Acesso Especial */
    #acessoEspecial #senhaEspecial { display: block; margin: 0 0 18px 0; }
    #acessoEspecial #btnVerificarSenhaEspecial { margin-bottom: 14px; }
    #acessoEspecial #btnVoltarAcessoEspecial { display: block; margin: 14px auto 0; }
</style>

<div id="acessoEspecial">
<h1>ACESSO ESPECIAL</h1>
<input type="password" id="senhaEspecial" placeholder="Digite a senha mestre" autocomplete="off" />
<button id="btnVerificarSenhaEspecial" style="width: 100%; padding: 14px 0; font-size: 1rem;">Verificar</button>
<div id="acessoEspecialError" style="color:#ff3b30; margin-top: 10px; text-align: center;"></div>
<button id="btnVoltarAcessoEspecial" style="margin-top: 10px;">Voltar</button>
</div>

<div id="recuperarPin">
<h1>SENHA NUMÉRICA</h1>
<div id="pin-recuperado-container">
    </div>
<button id="btnPinRecuperadoConcluido" style="width: 100%; padding: 14px 0; font-size: 1rem; margin-top: 20px;">Concluído</button>
</div>


<div id="app" style="display:none;">
<div class="top-bar">
<h1>ARQUIVOS</h1>
<div>
<button id="btnModoLeitura">Leitura</button>
<button id="btnSair">Sair</button>
</div>
</div>

<div id="credenciais-analisadas-box" class="credenciais-analisadas" style="display:none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
        <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z"></path>
        <path d="M20 21a8 8 0 0 0-16 0"></path>
    </svg>
    <span>Credenciais correlacionadas encontradas</span>
    <div class="badge-count" id="credenciais-analisadas-count">0</div>
</div>

<div id="alerta-revisao-senha" class="alerta-revisao" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
        <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94A2 2 0 0 0 22.18 18L13.71 3.86a2 2 0 0 0-3.42 0Z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
    </svg>
    <span>Atenção, algumas senhas precisam de ajustes</span>
    <button id="btnRevisarSenha">Revisar</button>
    <button type="button" onclick="adiarAlertaRevisao('senha')">Adiar</button>
</div>

<input type="text" id="new-column-name" placeholder="Nova categoria" autocomplete="off" />
<button id="btnAdicionarCategoria">Adicionar Categoria</button>

<div class="filter-controls">
<div class="search-input-with-filters">
    <input type="text" id="search-column" placeholder="Pesquisar categoria ou seção" autocomplete="off" />
    <button type="button" id="btnFieldFilterSenha" class="filter-btn" title="Filtros por seção" aria-haspopup="true" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <polygon points="22 3 2 3 10 12 10 19 14 21 14 12 22 3"></polygon>
        </svg>
    </button>
</div>
<div class="filter-buttons-container">
<button id="btnFiltrar">Filtrar</button>
<button id="btnLimparFiltro">Limpar</button>
</div>
</div>

<div id="boards"></div>

<div class="footerButtons">
<button id="btnImportar">Importar</button>
<button id="btnExportar">Exportar</button>
<button id="btn-go-to-settings">Configurações Adicionais</button>
<input type="file" id="importFileInput" accept=".json" style="display:none;" />
</div>
</div>

<!-- Modal de Credenciais Analisadas -->
<div id="modal-credenciais" class="modal-credenciais">
    <div class="modal-credenciais-content">
        <div class="modal-credenciais-header">
            <h2>Credenciais Analisadas</h2>
            <button class="modal-credenciais-close" id="fechar-credenciais">&times;</button>
        </div>
        <div id="pessoas-lista-container" class="pessoas-lista"></div>
        <div id="pessoa-detalhes-container" class="pessoa-detalhes-panel"></div>
    </div>
</div>

<div id="anotacoesApp" style="display:none;">
<div class="top-bar">
<h1>NOTAS</h1>
<div>
<button id="btnModoLeituraAnotacao">Leitura</button>
<button id="btnSairAnotacao">Sair</button>
</div>
</div>

<div id="credenciais-analisadas-box-anotacao" class="credenciais-analisadas" style="display:none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="24" height="24">
        <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5z"></path>
        <path d="M20 21a8 8 0 0 0-16 0"></path>
    </svg>
    <span>Notas correlacionadas encontradas</span>
    <div class="badge-count" id="credenciais-analisadas-count-anotacao">0</div>
</div>

<div id="alerta-revisao-anotacao" class="alerta-revisao" style="display: none;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20">
        <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94A2 2 0 0 0 22.18 18L13.71 3.86a2 2 0 0 0-3.42 0Z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
    </svg>
    <span>Atenção, algumas anotações precisam de ajustes</span>
    <button id="btnRevisarAnotacao">Revisar</button>
    <button type="button" onclick="adiarAlertaRevisao('anotacao')">Adiar</button>
</div>

<input type="text" id="new-anotacao-column-name" placeholder="Nova categoria" autocomplete="off" />
<button id="btnAdicionarAnotacaoCategoria">Adicionar Categoria</button>

<div class="filter-controls">
<div class="search-input-with-filters">
    <input type="text" id="search-anotacao-column" placeholder="Pesquisar categoria ou seção" autocomplete="off" />
    <button type="button" id="btnFieldFilterAnotacao" class="filter-btn" title="Filtros por seção" aria-haspopup="true" aria-expanded="false">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
            <polygon points="22 3 2 3 10 12 10 19 14 21 14 12 22 3"></polygon>
        </svg>
    </button>
</div>
<div class="filter-buttons-container">
<button id="btnFiltrarAnotacao">Filtrar</button>
<button id="btnLimparFiltroAnotacao">Limpar</button>
</div>
</div>

<div id="anotacoesBoards"></div>

<div class="footerButtons">
<button id="btnImportarAnotacao">Importar</button>
<button id="btnExportarAnotacao">Exportar</button>
<input type="file" id="importAnotacaoFileInput" accept=".dat,.json" style="display:none;" />
</div>
</div>

<div id="certificado">
<h1>PACOTE DE INSTALAÇÃO</h1>

<div id="certTitulo" class="codigo-box clickable" role="button" aria-controls="certInstructions" aria-expanded="false">CERTIFICADO DIGITAL</div>
<!-- Botão/caixa adicional abaixo, mesmo estilo, para download do Plug-in Digital -->
<div id="pluginDigitalBox" class="codigo-box clickable" role="button" aria-label="PLUG-IN DIGITAL">PLUG-IN DIGITAL</div>

<div class="helper-actions">
  <div id="certInstructions" class="timeline" style="display:none;">
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        </div>
        <div class="content"><strong>Baixe o certificado</strong><p>Obtenha o arquivo de certificado exigido pelo aplicativo.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10M7 12h10M7 16h6"/></svg>
        </div>
        <div class="content"><strong>Acesse a autenticação para upload do app</strong><p>Entre no fluxo de autenticação para habilitar o envio do aplicativo.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M7 12h10"/><path d="M12 7v10"/></svg>
        </div>
        <div class="content"><strong>Codifique a senha mestra</strong><p>Gere ou valide a derivação segura da sua senha mestra.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 12v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-7"/><path d="M22 12h-6a4 4 0 0 0-8 0H2"/></svg>
        </div>
        <div class="content"><strong>Autentique pelo e-mail</strong><p>Confirme seu e-mail para vincular a autorização ao seu usuário.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h13"/><path d="M14 9l3 3l-3 3"/></svg>
        </div>
        <div class="content"><strong>Atualize o código único</strong><p>Sincronize o identificador único exigido pela instalação.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h4"/><path d="M7 12h10"/><path d="M7 16h8"/></svg>
        </div>
        <div class="content"><strong>Organize os dados cadastrais</strong><p>Revise e ajuste as informações cadastrais antes de prosseguir.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="content"><strong>Finalize a aplicação</strong><p>Conclua a configuração e prepare o pacote para instalação.</p></div>
     </div>
     <div class="timeline-item">
        <div class="marker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2l4 -4"/><rect x="3" y="4" width="18" height="16" rx="2"/></svg>
        </div>
        <div class="content"><strong>Confirme com a senha mestra e senha numérica</strong><p>Valide as duas credenciais para confirmar e encerrar o processo.</p></div>
     </div>
  </div>
</div>

<div class="cert-buttons">
    <button id="btnInstalar" class="btn-primary">INSTALAÇÃO</button>
    <button id="btnVoltarLogin" class="btn-secondary">Voltar</button>
</div>
</div>

<div id="autoFillSettings">
<h2 class="page-title">Funções Adicionais</h2>
<div class="autofill-actions">
    <button id="btn-go-to-autofill-form" class="autofill-action" aria-label="Preenchimento Automático">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 21h16" />
            <path d="M12 17v-7" />
            <path d="M9 10l3-3l3 3" />
            <path d="M5 7v2a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2z" />
        </svg>
        <span>Preenchimento Automático</span>
    </button>
    <button id="btn-default-card" class="autofill-action" aria-label="Cartão Padrão">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="5" width="18" height="14" rx="2" />
            <path d="M3 9h18" />
            <path d="M7 15h2" />
            <path d="M11 15h6" />
        </svg>
        <span>Cartão Padrão</span>
    </button>
    <button id="btn-manage-marcadores" class="autofill-action" aria-label="Gerenciar Marcadores">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M7 4h10a2 2 0 0 1 2 2v12l-7-3l-7 3V6a2 2 0 0 1 2-2z" />
            <path d="M9 9h6" />
        </svg>
        <span>Gerenciar Marcadores</span>
    </button>
    <button id="btn-manage-devices" class="autofill-action" aria-label="Aparelhos Conectados">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="6" y="3" width="12" height="16" rx="2" />
            <path d="M10 19h4" />
        </svg>
        <span>Aparelhos Conectados</span>
    </button>
    <button id="btn-correlation-toggle" class="autofill-action" aria-label="Correlação Automática">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10 13a5 5 0 0 1 0-7" />
            <path d="M14 11a5 5 0 0 1 0 7" />
            <path d="M8 12h8" />
        </svg>
        <span>Correlação Automática</span>
    </button>
    <button id="btnUploadSenhas" class="autofill-action" aria-label="Fazer upload de senhas">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 17V7" />
            <path d="M8 11l4-4l4 4" />
            <path d="M4 17v1a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-1" />
        </svg>
        <span>Fazer upload de senhas</span>
    </button>
</div>
<div class="correlation-container">
    <div id="correlation-status" class="correlation-status" style="display:none; margin-top: 10px; padding: 15px; border-radius: var(--border-radius-inner); background: var(--background-color);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>Status da Correlação:</span>
            <label class="switch">
                <input type="checkbox" id="correlation-checkbox">
                <span class="slider round"></span>
            </label>
        </div>
    </div>
</div>
    <button id="btn-autofill-back-to-app" style="margin-top: 10px;">Voltar</button>

<div id="searchResultsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalContent search-results-modal">
        <h2>Resultados da Busca</h2>
        <div class="search-results-container"></div>
        <div class="modalButtons">
            <button type="button" class="close-search">Fechar</button>
        </div>
    </div>
</div>

<div id="modalSavedItems" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloSavedItems">
    <div class="modalContent saved-items-modal">
        <h2 id="modalTituloSavedItems">Gerenciar Itens Salvos</h2>
        
        
        <form id="formSavedItem" class="saved-item-form">
            <div class="form-grid">
                <div class="input-container">
                    <input type="text" id="saved-item-titulo" placeholder="Nome do item" required autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-usuario" placeholder="Usuário" autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-email" placeholder="E-mail" autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-telefone" placeholder="Telefone" autocomplete="off" inputmode="numeric" maxlength="13" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-links" placeholder="Links (ex: https://)" autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="text" id="saved-item-cpf" placeholder="CPF" autocomplete="off" maxlength="14" inputmode="numeric" />
                </div>
                <div class="input-container grid-span-2">
                    <textarea id="saved-item-notas" placeholder="Notas adicionais" rows="3"></textarea>
                </div>
            </div>
            
            <div class="saved-items-buttons">
                <button type="button" class="view-saved-btn liquid-btn" title="Visualizar itens salvos">
                    <span class="liquid-circle"></span>
                </button>
                <button type="submit" class="save-item-btn liquid-btn" title="Salvar item">
                    <span class="check-icon"></span>
                </button>
            </div>
        </form>

        
        <div id="savedItemsList" class="saved-items-list" style="display: none;">
            <div class="saved-items-container">
                
            </div>
            <button type="button" class="back-to-form-btn">Voltar ao Formulário</button>
        </div>

        <div class="modalButtons">
            <button type="button" class="close-saved-items">Fechar</button>
        </div>
    </div>
</div>

<style>

.saved-items-modal {
    max-width: 800px !important;
    margin: auto !important;
}

.modalContent.saved-items-modal {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.form-grid {
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.grid-span-2 {
    grid-column: span 2;
}

.saved-item-form {
    margin: 20px 0;
}

.input-container input,
.input-container textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid rgba(173, 216, 230, 0.2);
    border-radius: 8px;
    background: rgba(173, 216, 230, 0.05);
    color: var(--text-color);
    transition: all 0.3s ease;
}

.input-container input:focus,
.input-container textarea:focus {
    outline: none;
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 2px rgba(var(--primary-accent-rgb), 0.1);
}

.saved-items-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    gap: 15px;
}


.liquid-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(173, 216, 230, 0.1);
    border: 1px solid rgba(173, 216, 230, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
}

.liquid-btn:hover {
    background: rgba(173, 216, 230, 0.2);
    transform: scale(1.05);
    box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.2),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
}


.liquid-circle {
    width: 12px;
    height: 12px;
    background: var(--primary-accent);
    border-radius: 50%;
    position: relative;
}

.liquid-circle::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border: 2px solid var(--primary-accent);
    border-radius: 50%;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}

.check-icon {
    position: relative;
    width: 14px;
    height: 8px;
    border-left: 2px solid var(--primary-accent);
    border-bottom: 2px solid var(--primary-accent);
    transform: rotate(-45deg);
}


.saved-items-list {
    max-height: 400px;
    overflow-y: auto;
    margin: 20px auto;
    width: 100%;
    max-width: 600px;
}

.saved-item {
    background: rgba(173, 216, 230, 0.1);
    border: 1px solid rgba(173, 216, 230, 0.15);
    border-radius: 16px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.saved-item-info {
    flex: 1;
}

.saved-item-actions {
    display: flex;
    gap: 10px;
}

.saved-item-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--text-color);
}

/* Credenciais analisadas */
.credenciais-analisadas {
    background: rgba(0, 122, 255, 0.15);
    border: 2px solid rgba(0, 122, 255, 0.5);
    border-radius: var(--border-radius-inner);
    padding: 12px 16px;
    margin: 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
}
.credenciais-analisadas:hover {
    background: rgba(0, 122, 255, 0.2);
    border-color: rgba(0, 122, 255, 0.7);
}
.credenciais-analisadas svg { flex-shrink: 0; stroke: var(--primary-accent); }
.credenciais-analisadas span { flex: 1; font-size: 0.95rem; }
.credenciais-analisadas .badge-count {
    background: var(--primary-accent);
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.85rem;
    min-width: 24px;
    text-align: center;
}

.alerta-revisao {
    background: rgba(255, 159, 0, 0.15);
    border: 2px solid rgba(255, 159, 0, 0.5);
    border-radius: var(--border-radius-inner);
    padding: 12px 16px;
    margin: 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-color);
}
.alerta-revisao svg { flex-shrink: 0; stroke: #FF9500; }
.alerta-revisao span { flex: 1; font-size: 0.95rem; }
.alerta-revisao button {
    background: rgba(255, 159, 0, 0.3);
    border: 1px solid rgba(255, 159, 0, 0.6);
    color: var(--text-color);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    white-space: nowrap;
}
.alerta-revisao button:hover { background: rgba(255, 159, 0, 0.5); border-color: #FF9500; }

@media (max-width: 768px) {
    .alerta-revisao {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    .alerta-revisao button {
        width: 100%;
    }
}

.modal-credenciais {
    display: none;
    position: fixed;
    z-index: 1002;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}
.modal-credenciais-content {
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border-radius: var(--border-radius-main);
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 32px 0 var(--shadow-color);
    margin: 5% auto;
    padding: 35px 30px 30px 30px !important;
    width: 90%;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideDown 0.3s ease;
}
@keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
.modal-credenciais-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 30px !important; 
    padding-bottom: 20px !important; 
    border-bottom: 1px solid var(--border-color); 
    gap: 20px;
    margin-top: 0 !important;
    padding-top: 0 !important;
}
.modal-credenciais-header h2 { 
    font-size: 1.5rem; 
    font-weight: 600; 
    margin: 0; 
    flex: 1;
}
.modal-credenciais-close {
    background: transparent;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--text-color);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
    flex-shrink: 0;
    margin-left: 20px;
}

.modal-credenciais-close:hover {
    background: var(--button-hover-bg);
    transform: scale(1.1);
}

.pessoas-lista {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 20px;
}
.pessoa-card {
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
}
.pessoa-card:hover { background: var(--button-hover-bg); transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow-color); }
.pessoa-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--primary-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 600;
    flex-shrink: 0;
}
.pessoa-info { flex: 1; min-width: 0; }
.pessoa-nome { font-weight: 600; font-size: 1rem; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.pessoa-detalhes-count { font-size: 0.85rem; opacity: 0.7; }
.btn-ocultar-pessoa, .btn-reexibir-pessoa {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: 1px solid var(--border-color);
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s ease;
}
.pessoa-card:hover .btn-ocultar-pessoa { opacity: 1; }
.btn-ocultar-pessoa:hover { background: var(--danger-accent); border-color: var(--danger-accent); }
.btn-ocultar-pessoa svg { width: 14px; height: 14px; stroke: var(--text-color); }
.btn-ocultar-pessoa:hover svg { stroke: white; }
.btn-reexibir-pessoa { opacity: 1; background: var(--primary-accent); border-color: var(--primary-accent); color: white; }
.btn-reexibir-pessoa:hover { transform: scale(1.1); background: var(--primary-accent-hover); }
.btn-reexibir-pessoa svg { width: 14px; height: 14px; stroke: white; }

.credenciais-ocultas-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
.credenciais-ocultas-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; cursor: pointer; user-select: none; }
.credenciais-ocultas-header h3 { margin: 0; font-size: 1.1rem; opacity: 0.8; }
.credenciais-ocultas-header svg { width: 18px; height: 18px; transition: transform 0.2s ease; }
.credenciais-ocultas-header.expandido svg { transform: rotate(90deg); }
.credenciais-ocultas-lista { display: none; }
.credenciais-ocultas-lista.expandido { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px; }
.pessoa-card-oculta { opacity: 0.6; position: relative; }

.pessoa-detalhes-panel {
    display: none;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    padding: 20px;
    margin-top: 20px;
    animation: slideDown 0.3s ease;
}

.btn-voltar-lista {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    margin-bottom: 24px !important;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95rem;
    font-weight: 500;
}

.btn-voltar-lista svg {
    width: 18px;
    height: 18px;
    stroke: var(--text-color);
}

.btn-voltar-lista:hover {
    background: var(--button-hover-bg);
    border-color: var(--primary-accent);
    transform: translateX(-2px);
}

.pessoa-detalhes-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
.pessoa-detalhes-header .pessoa-avatar { width: 60px; height: 60px; font-size: 1.8rem; }
.pessoa-detalhes-info { flex: 1; }
.pessoa-detalhes-nome { font-size: 1.3rem; font-weight: 600; margin-bottom: 4px; }
.pessoa-detalhes-body { display: grid; gap: 12px; }
.detalhe-item { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; display: flex; align-items: center; gap: 10px; position: relative; padding-right: 44px; }
.detalhe-icon { width: 24px; height: 24px; flex-shrink: 0; }
.detalhe-icon svg { width: 100%; height: 100%; stroke: var(--primary-accent); }
.detalhe-content { flex: 1; min-width: 0; }
.detalhe-label { font-size: 0.8rem; opacity: 0.7; margin-bottom: 2px; }
.detalhe-valor { font-weight: 600; word-break: break-word; overflow-wrap: break-word; line-height: 1.4; }
.btn-revelar-cartao {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    padding: 4px !important;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.16s ease;
    display: inline-flex !important;
    align-items: center;
    justify-content: center;
    width: 22px !important;
    height: 22px !important;
    flex: 0 0 auto !important;
    box-sizing: border-box;
}
.btn-revelar-cartao:hover { background: var(--button-hover-bg); border-color: var(--primary-accent); transform: translateY(-1px); }
.btn-revelar-cartao svg { width: 14px; height: 14px; stroke: var(--text-color); }

.saved-item-details {
    font-size: 0.9em;
    color: var(--text-color);
    opacity: 0.8;
}


body[data-theme="light"] .liquid-btn {
    background: rgba(0, 0, 0, 0.05);
    border-color: rgba(0, 0, 0, 0.1);
}

body[data-theme="light"] .liquid-btn:hover {
    background: rgba(0, 0, 0, 0.08);
}

body[data-theme="light"] .saved-item {
    background: rgba(255, 255, 255, 0.8);
    border-color: rgba(0, 0, 0, 0.1);
}


@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.saved-item {
    animation: fadeIn 0.3s ease forwards;
}

.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--danger-accent);
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary-accent);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.correlation-warning {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(23, 42, 69, 0.4);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(173, 216, 230, 0.15);
    padding: 30px;
    border-radius: 24px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.08);
    text-align: center;
    z-index: 1001;
    max-width: 90%;
    width: 400px;
    opacity: 0;
    animation: fadeIn 0.3s ease-out forwards;
}

body[data-theme="light"] .correlation-warning {
    background: rgba(240, 245, 255, 0.85);
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.1),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.5);
}

.correlation-warning.visible {
    display: block;
}

.correlation-warning::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: -1;
}

body[data-theme="light"] .correlation-warning::before {
    background: rgba(255, 255, 255, 0.3);
}

.correlation-warning h3 {
    margin: 0;
    color: var(--danger-accent);
    font-size: 1.4rem;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.correlation-warning-content {
    margin-top: 5px;
    color: var(--text-color);
}

.correlation-warning-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 25px;
}

.warning-btn {
    min-width: 120px;
    padding: 12px 24px;
    background: rgba(173, 216, 230, 0.1);
    color: var(--text-color);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

body[data-theme="light"] .warning-btn {
    background: rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: var(--text-color);
}

.warning-btn:hover {
    background: var(--button-hover-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px var(--shadow-color);
}


@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translate(-50%, -45%);
    }
    to { 
        opacity: 1; 
        transform: translate(-50%, -50%);
    }
}
</style>
</div>

<div id="autoFillForm">
    <h2 class="page-title">Editar Formulário</h2>
    <form id="formAutoFillData">
        <div class="form-grid">
            <input type="text" id="autofill-usuario" placeholder="Usuário padrão" autocomplete="off" />
            <input type="text" id="autofill-email" placeholder="E-mail padrão" autocomplete="off" />
            <input type="text" id="autofill-telefone" placeholder="Telefone padrão" autocomplete="off" inputmode="numeric" maxlength="13" />
            <input type="text" id="autofill-cpf" placeholder="CPF padrão" autocomplete="off" maxlength="14" inputmode="numeric" />
            <input type="text" id="autofill-links" placeholder="Links padrão (ex: https://)" autocomplete="off" />
            <input type="text" id="autofill-abreviacao" placeholder="Abreviação do link padrão" autocomplete="off" />
            <div class="input-container grid-span-2">
                <textarea id="autofill-notas" placeholder="Notas padrão" rows="3"></textarea>
            </div>
        </div>
        <div class="modalButtons">
            <button type="button" id="btn-autofill-form-back">Voltar</button>
            <button type="submit" id="btn-autofill-save">Salvar</button>
        </div>
    </form>
</div>



<!-- Modal cartão padrão -->
<div id="defaultCardModal" class="modal" role="dialog" aria-modal="true" style="display: none; align-items: flex-start; justify-content: center; padding: 12px; overflow-y: auto;">
    <div class="modalContent" style="display: flex; flex-direction: column; align-items: center; text-align: center; max-height: 90vh; overflow-y: auto; padding: clamp(12px, 3vw, 20px); width: min(96%, 520px);">
        <h2 style="width: 100%; text-align: center; margin-bottom: 20px; font-size: clamp(1.2rem, 4vw, 1.5rem);">Cartão padrão</h2>
        
        <div id="default-card-preview" class="card-display card-preview-default" style="margin: 14px auto;">
            <div class="card-chip-display"></div>
            <div class="card-number-display" id="preview-card-number">&bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull;</div>
            <div class="card-info-row">
                <div class="card-holder-display">
                    <div class="card-label">Titular</div>
                    <div class="card-value" id="preview-card-holder">NOME DO TITULAR</div>
                </div>
                <div class="card-expiry-display">
                    <div class="card-label">Validade</div>
                    <div class="card-value" id="preview-card-expiry">MM/AA</div>
                </div>
            </div>
        </div>
        
        <div style="width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 18px;">
            <div class="input-container">
                <input type="text" id="default-card-number" placeholder="Número do cartão" maxlength="19" inputmode="numeric" autocomplete="off" style="padding: 16px 18px; border-radius: 12px;" />
            </div>
            <div class="input-container">
                <input type="text" id="default-card-holder" placeholder="Nome do titular" autocomplete="off" style="text-transform: uppercase; padding: 16px 18px; border-radius: 12px;" />
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="input-container">
                    <input type="text" id="default-card-expiry" placeholder="Validade (MM/AA)" maxlength="5" inputmode="numeric" autocomplete="off" style="padding: 16px 18px; border-radius: 12px;" />
                </div>
                <div class="input-container">
                    <input type="text" id="default-card-cvv" placeholder="CVV" maxlength="4" inputmode="numeric" autocomplete="off" style="padding: 16px 18px; border-radius: 12px;" />
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="default-card-brand" placeholder="Bandeira (Visa, Mastercard, etc.)" autocomplete="off" style="padding: 16px 18px; border-radius: 12px;" />
            </div>
        </div>
        
        <div class="modalButtons" style="width: 100%;">
            <button type="button" id="btn-default-card-back">Voltar</button>
            <button type="button" id="btn-default-card-clear" style="background: var(--danger-accent);">Limpar</button>
            <button type="button" id="btn-default-card-save">Salvar</button>
        </div>
    </div>
</div>


<div id="searchResultsModal" class="modal" role="dialog" aria-modal="true">
    <div class="modalContent search-results-modal">
        <h2>Resultados da Busca</h2>
        <div class="search-results-container"></div>
        <div class="modalButtons">
            <button type="button" class="close-search">Fechar</button>
        </div>
    </div>
</div>

<div id="modalSenha" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloSenha">
    <div class="modalContent">
        <h2 id="modalTituloSenha">Adicionar Senha</h2>
        <button id="btn-autofill-trigger">Preencher Automaticamente</button>
        <form id="formSenha" novalidate>
            <div class="form-grid">
                <div class="input-container grid-span-2">
                    <div class="search-wrapper">
                        <input type="text" id="inputTitulo" placeholder="Serviço" required autocomplete="off" style="padding-right: 48px;"/>
                        <button type="button" id="search-service-btn" class="search-btn liquid-btn" title="Buscar serviço">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </button>
                    </div>
                </div>

                
                <div id="searchResultsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloSearchResults">
                    <div class="modalContent search-results-modal">
                        <h2 id="modalTituloSearchResults">Resultados da Busca</h2>
                        <div id="searchResultsContainer" class="search-results-container">
                            
                        </div>
                        <div class="modalButtons">
                            <button type="button" class="close-search-results">Fechar</button>
                        </div>
                    </div>
                </div>
                <div class="input-container">
                    <input type="text" id="inputUsuario" placeholder="Usuário" required autocomplete="off" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="input-container">
                    <input type="text" id="inputSenha" placeholder="Senha" required autocomplete="off" style="padding-right: 16px;"/>
                </div>
                <div class="input-container">
                    <input type="text" id="inputEmail" placeholder="E-mail" autocomplete="off" />
                    <button type="button" class="btn-clear-field" id="clear-email" title="Limpar campo">×</button>
                    <button type="button" id="gmail-helper">@gmail.com</button>
                </div>
                <div class="input-container">
                    <input type="text" id="inputTelefone" placeholder="Telefone" autocomplete="off" inputmode="numeric" maxlength="13" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="input-container">
                    <input type="text" id="inputLinks" placeholder="Links (ex: https://)" autocomplete="off" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div id="abreviacao-container" style="display: none;" class="input-container">
                    <input type="text" id="inputAbreviacao" placeholder="Abreviação do link" autocomplete="off" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="input-container grid-span-2">
                    <input type="text" id="inputCpf" placeholder="CPF" autocomplete="off" maxlength="14" inputmode="numeric" />
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="input-container grid-span-2">
                    <textarea id="inputNotas" placeholder="Notas adicionais" rows="3"></textarea>
                    <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
                </div>
                <div class="marcador-select-container grid-span-2">
                    <select id="inputMarcador" aria-label="Selecionar marcador">
                        <option value="">Selecionar marcador (opcional)</option>
                    </select>
                </div>

                <!-- Seção de cartões -->
                <div class="grid-span-2">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" id="btnAdicionarcartão" class="btn-add-card" style="flex: 1;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Adicionar cartão
                        </button>
                        <button type="button" id="btnAdicionarcartãoPadrao" class="btn-add-card" style="flex: 1; background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); border: 1px solid #d4af37; color: #d4af37;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Cartão padrão
                        </button>
                    </div>
                    <div id="cartoesListContainer" class="cartoes-list-container"></div>
                </div>
            </div>
            <div class="modalButtons">
                <button type="button" id="btnCancelarSenha">Voltar</button>
                <button type="submit" id="btnSalvarSenha">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalAnotacao" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloAnotacao">
<div class="modalContent">
<h2 id="modalTituloAnotacao">Adicionar Anotação</h2>
<form id="formAnotacao" novalidate>
    <input type="text" id="inputTituloAnotacao" placeholder="Nome" required autocomplete="off" />
    <div class="search-wrapper">
        <input type="text" id="inputLinksAnotacao" placeholder="Site (ex: https://)" autocomplete="off" style="padding-right: 48px;" />
        <button type="button" id="search-notes-btn" class="search-btn liquid-btn" title="Buscar na web">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
        </button>
    </div>
    <div class="input-container">
        <textarea id="inputNotasAnotacao" placeholder="Observação" rows="5"></textarea>
        <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
    </div>
    <button type="button" id="btnMaisInfoAnotacao" class="btn-tertiary" aria-expanded="false" aria-controls="extraFieldsAnotacao">+ Mais informações</button>
      <div id="extraFieldsAnotacao" class="extra-fields" style="display:none;">
          <div class="input-container">
              <input type="text" id="inputUsuarioAnotacao" placeholder="Usuário" autocomplete="off" />
              <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
          </div>
          <div class="input-container">
              <input type="text" id="inputEmailAnotacao" placeholder="E-mail" autocomplete="off" />
              <button type="button" class="btn-clear-field" id="clear-email-anotacao" title="Limpar campo">×</button>
              <button type="button" id="gmail-helper-anotacao">@gmail.com</button>
          </div>
          <div class="input-container">
              <input type="text" id="inputTelefoneAnotacao" placeholder="Telefone" autocomplete="off" inputmode="numeric" maxlength="13" />
              <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
          </div>
          <div class="input-container">
              <input type="text" id="inputCpfAnotacao" placeholder="CPF" autocomplete="off" maxlength="14" inputmode="numeric" />
              <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
          </div>
          <div class="input-container">
              <input type="text" id="inputAbreviacaoAnotacao" placeholder="Abreviação do link" autocomplete="off" />
              <button type="button" class="btn-clear-field" title="Limpar campo">×</button>
          </div>
      </div>
  <div class="marcador-select-container">
      <select id="inputMarcadorAnotacao" aria-label="Selecionar marcador">
          <option value="">Selecionar marcador (opcional)</option>
      </select>
  </div>
  <div class="modalButtons">
      <button type="button" id="btnCancelarAnotacao">Voltar</button>
      <button type="submit" id="btnSalvarAnotacao">Salvar</button>
  </div>
</form>
</div>
</div>

<!-- Modal: Aparelhos Conectados -->
<div id="modalDevices" class="modal" role="dialog" aria-modal="true" style="display:none;">
    <div class="modalContent" style="max-width:640px;">
        <h2>Aparelhos Conectados</h2>
        <form id="formDevice" style="width:100%; margin-top:8px;">
            <div class="form-grid">
                <div class="input-container">
                    <input type="text" id="device-name" placeholder="Nome do aparelho" required autocomplete="off" />
                </div>
                <div class="input-container">
                    <input type="password" id="device-password" placeholder="Senha (opcional)" autocomplete="off" />
                </div>
                <div class="input-container grid-span-2">
                    <textarea id="device-info" placeholder="Info (observações)" rows="2"></textarea>
                </div>
                <div class="input-container grid-span-2" style="width:100%;">
                    <label style="width:100%; font-weight:600; opacity:0.85; margin-bottom:8px; display:block;">Ícone do aparelho:</label>
                    <div class="device-icon-options" style="display:flex; gap:12px; align-items:center; justify-content:center; width:100%;">
                        <input id="icon-celular" class="device-icon-input" type="radio" name="device-icon" value="celular" checked />
                        <label for="icon-celular" class="device-icon-label" title="Celular">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="6" y="2" width="12" height="20" rx="3" ry="3"/><circle cx="12" cy="18" r="0.9"/></svg>
                        </label>

                        <input id="icon-tablet" class="device-icon-input" type="radio" name="device-icon" value="tablet" />
                        <label for="icon-tablet" class="device-icon-label" title="Tablet">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="4" y="2.5" width="16" height="19" rx="2.6" ry="2.6"/><circle cx="12" cy="18.5" r="0.9"/></svg>
                        </label>

                        <input id="icon-pc" class="device-icon-input" type="radio" name="device-icon" value="pc" />
                        <label for="icon-pc" class="device-icon-label" title="PC">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="2.5" y="4" width="19" height="12" rx="1.6" ry="1.6"/><line x1="8" y1="18.5" x2="16" y2="18.5"/><rect x="10" y="19.2" width="4" height="1" rx="0.5"/></svg>
                        </label>

                        <input id="icon-notebook" class="device-icon-input" type="radio" name="device-icon" value="notebook" />
                        <label for="icon-notebook" class="device-icon-label" title="Notebook">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3.5" y="4" width="17" height="10" rx="1.8" ry="1.8"/><path d="M3.5 14.2c1.5-0.6 3.5-1 8.5-1s6.9 0.4 8.5 1"/></svg>
                        </label>
                    </div>
                    <style>
                        .device-icon-input { position:absolute !important; opacity:0 !important; width:0 !important; height:0 !important; pointer-events:none; }
                        .device-icon-label { display:inline-flex; width:72px; height:72px; align-items:center; justify-content:center; border-radius:12px; border:1px solid var(--border-color); background:var(--input-bg); cursor:pointer; transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease; }
                        .device-icon-label svg { width:40px; height:40px; stroke:var(--text-color); }
                        .device-icon-label:hover { transform: translateY(-4px); box-shadow: 0 8px 22px rgba(0,0,0,0.22); }
                        .device-icon-input:checked + .device-icon-label { border-color: var(--primary-accent); box-shadow: 0 10px 30px rgba(0,122,255,0.16); background: linear-gradient(180deg, rgba(0,122,255,0.04), transparent); }
                        @media (max-width:480px) { .device-icon-label { width:52px; height:52px; } .device-icon-label svg { width:28px; height:28px; } }
                    </style>
                </div>
            </div>
            <div class="modalButtons">
                <button type="submit" id="btnSaveDevice">Salvar</button>
                <button type="button" id="btnCloseDevices">Fechar</button>
            </div>
        </form>
        <hr style="width:100%; margin:16px 0; opacity:0.06;" />
        <div id="devices-list-container" style="width:100%; text-align:left; max-height:none; overflow-y:visible; padding:6px 0;"></div>
    </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="message-box" id="message-box"></div>
<div class="message-box mobile-friendly" id="modalObservacoes">
    <header class="modal-header">
        <h2>OBSERVAÇÕES</h2>
        <p>Este sistema salva todas as informações apenas no navegador e armazena as senhas e anotações de forma criptografada.</p>
    </header>
    
    <div class="modal-body">
        <textarea id="observacoes-textarea" placeholder="Digite suas observações aqui..." rows="5"></textarea>
    </div>
    
    <footer class="modal-footer">
        <div class="action-buttons">
            <button id="btnSalvarObservacoes" class="btn-primary" aria-label="Salvar observações">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                <span class="btn-label">Salvar</span>
            </button>
            <button id="btnRedefinirTempo" class="btn-primary" title="Redefinir timer" aria-label="Redefinir timer de atualização">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
                    <circle cx="12" cy="12" r="9"></circle>
                    <path d="M12 7v5l3 2"></path>
                </svg>
                <span class="btn-label">Time</span>
            </button>
            <button id="btnUpdates" class="btn-primary" aria-label="Abrir melhorias e updates">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 2v6h-6"/>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
                    <path d="M3 22v-6h6"/>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                </svg>
                <span class="btn-label">Updates</span>
            </button>
        </div>
        <button type="button" id="btnVoltarObservacoes" class="btn-secondary">Voltar</button>
    </footer>
</div>

<style>

.message-box.mobile-friendly {
    max-width: 600px;
    padding: 32px;
}

.message-box.mobile-friendly .modal-header {
    text-align: center;
    margin-bottom: 24px;
}

.message-box.mobile-friendly .modal-header h2 {
    font-size: 1.5rem;
    margin-bottom: 12px;
}

.message-box.mobile-friendly .modal-header p {
    color: var(--text-color);
    opacity: 0.8;
    line-height: 1.5;
    font-size: 0.95rem;
}

.message-box.mobile-friendly .modal-body textarea {
    width: 100%;
    margin-bottom: 24px;
    resize: vertical;
    min-height: 120px;
    font-size: 0.95rem;
    line-height: 1.5;
}

.message-box.mobile-friendly .action-buttons {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: nowrap;
    overflow-x: auto; /* garante que nunca quebre linha; permite scroll se necessário */
    -webkit-overflow-scrolling: touch;
    width: 100%; /* ocupar toda a largura disponível do footer no desktop */
}

.message-box.mobile-friendly .btn-primary,
.message-box.mobile-friendly .btn-secondary {
    width: 100%;
    height: 44px;
    padding: 0 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 0.95rem;
}

/* Tornar o trio Salvar/Time/Updates compacto e lado a lado (desktop) */
.message-box.mobile-friendly .action-buttons > button {
    width: auto;
    min-width: 64px; /* grande em telas grandes */
    height: 64px;
    padding: 0 14px;
    flex: 1 1 0; /* cada botão expande igualmente para ocupar todo espaço */
    min-width: 0; /* permite contrair sem quebrar o layout */
}
.message-box.mobile-friendly .action-buttons > button svg {
    width: 20px; /* ícone maior no desktop */
    height: 20px;
}
.message-box.mobile-friendly .action-buttons > button .btn-label {
    font-size: 1rem; /* rótulo legível no desktop */
}


button {
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 0 16px;
}

button svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}


button.btn-circle,
#btnVerMelhorias,
.fab-button {
    width: 44px;
    height: 44px;
    padding: 0;
    border-radius: 50%;
    min-width: auto;
}


.fab-main {
    width: 56px !important;
    height: 56px !important;
}

.fab-main svg {
    width: 24px;
    height: 24px;
}


.card-buttons button {
    height: 36px;
    padding: 0 12px;
}

.card-buttons .visualizar-icone {
    width: 36px;
    padding: 0;
}

.card-buttons .visualizar-icone svg {
    width: 18px;
    height: 18px;
}

.message-box.mobile-friendly .btn-secondary {
    background: var(--button-bg);
    border: 1px solid var(--border-color);
}


@media (max-width: 480px) {
    .message-box.mobile-friendly {
        margin: 16px;
        max-width: calc(100% - 32px);
        padding: 20px;
    }

    .message-box.mobile-friendly .modal-header h2 {
        font-size: 1.3rem;
    }

    .message-box.mobile-friendly .modal-header p {
        font-size: 0.9rem;
    }

    /* Em celular: três botões sempre lado a lado, cabendo na tela sem arrastar */
    .message-box.mobile-friendly .action-buttons {
        justify-content: center;
        flex-wrap: nowrap;
        gap: 8px; /* reduzir gap para caber melhor */
        overflow-x: hidden; /* sem rolagem horizontal */
        width: 100%;
    }
    .message-box.mobile-friendly .action-buttons > button {
        height: 40px;
        padding: 0 8px;
        min-width: 0; /* permite encolher */
        white-space: nowrap;
        flex: 1 1 0; /* dividir igualmente a largura disponível */
    }
    .message-box.mobile-friendly .action-buttons > button .btn-label {
        display: inline;
        font-size: 0.85rem;
        overflow: hidden;
        text-overflow: ellipsis; /* se faltar espaço, corta com reticências */
    }
    .message-box.mobile-friendly .action-buttons > button svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
    }

    .message-box.mobile-friendly .modal-body textarea {
        min-height: 100px;
    }

    .message-box.mobile-friendly .btn-primary,
    .message-box.mobile-friendly .btn-secondary {
        padding: 10px;
        font-size: 0.9rem;
    }
}
</style>
</div>

<!-- Modal de Gerenciamento de Marcadores -->
<div id="modalMarcadores" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloMarcadores">
    <div class="modalContent">
        <h2 id="modalTituloMarcadores">Gerenciar Marcadores</h2>
        
        <!-- Formulário para adicionar/editar marcador -->
        <div class="marcador-form">
            <div class="marcador-form-row">
                <input type="text" id="marcador-nome-input" placeholder="Nome do marcador" maxlength="20" autocomplete="off" />
                <input type="color" id="marcador-cor-input" value="#007aff" title="Escolher cor" />
            </div>
            <div class="marcador-importante-container">
                <label class="marcador-importante-label">
                    <input type="checkbox" id="marcador-importante-input" />
                    <span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" style="vertical-align: middle;">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        Marcar como importante
                    </span>
                </label>
            </div>
            <div class="color-presets">
                <div class="color-preset" style="background: #007aff;" data-color="#007aff" title="Azul"></div>
                <div class="color-preset" style="background: #34C759;" data-color="#34C759" title="Verde"></div>
                <div class="color-preset" style="background: #FF3B30;" data-color="#FF3B30" title="Vermelho"></div>
                <div class="color-preset" style="background: #FF9500;" data-color="#FF9500" title="Laranja"></div>
                <div class="color-preset" style="background: #AF52DE;" data-color="#AF52DE" title="Roxo"></div>
                <div class="color-preset" style="background: #FF2D55;" data-color="#FF2D55" title="Rosa"></div>
                <div class="color-preset" style="background: #5AC8FA;" data-color="#5AC8FA" title="Azul claro"></div>
                <div class="color-preset" style="background: #FFCC00;" data-color="#FFCC00" title="Amarelo"></div>
            </div>
            <button type="button" id="btn-adicionar-marcador" style="width: 100%; padding: 12px; margin-top: 10px;">
                Adicionar Marcador
            </button>
        </div>
        
        <!-- Lista de marcadores existentes -->
        <div class="marcadores-list" id="marcadores-list">
            <!-- Marcadores serão inseridos dinamicamente aqui -->
        </div>
        
        <div class="modalButtons">
            <button type="button" id="btnFecharMarcadores">Fechar</button>
        </div>
    </div>
</div>

<div id="modalDesenvolvimento" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTituloDesenvolvimento">
<div class="modalContent mobile-friendly">
    <header class="modal-header">
        <h2 id="modalTituloDesenvolvimento">DESENVOLVIMENTO</h2>
        <p></p>
    </header>
    
    <div class="modal-body">
        <div class="changelog" style="display: none;"></div>
        <div class="action-grid">
            <button id="btnAtivarUpdate" class="action-button btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 12a11 11 0 0 0-22 0m22 0a11 11 0 0 1-22 0M12 1v6m0 16v-6"/>
                </svg>
                <span>Ativar Update</span>
            </button>
            <button id="btnDesativarUpdate" class="action-button btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 12h8"/>
                </svg>
                <span>Desativar Update</span>
            </button>
            <button id="btnVerMelhorias" class="action-button" title="Ver Melhorias">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4"/>
                    <path d="M12 8h.01"/>
                </svg>
                <span>Ver Melhorias</span>
            </button>
        </div>
        <button type="button" id="btnApagarDados" class="btn-danger">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
            Apagar dados
        </button>
    </div>
</div>
</div>

<style>

#modalDesenvolvimento .action-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(80px, 120px));
    gap: 12px;
    width: 100%;
    justify-content: center;
    margin: 0 auto;
}

#modalDesenvolvimento .action-button {
    aspect-ratio: 1;
    width: 100%;
    height: auto;
    border-radius: var(--border-radius-inner);
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    text-align: center;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

#modalDesenvolvimento .action-button svg {
    width: 22px;
    height: 22px;
    margin-bottom: 2px;
}

#modalDesenvolvimento .action-button span {
    font-size: 0.8rem;
    line-height: 1.2;
    max-width: 100%;
    padding: 0 4px;
}

#modalDesenvolvimento .action-button:hover {
    background: var(--button-hover-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-color);
}

#modalDesenvolvimento .action-button.btn-primary {
    background: var(--primary-accent);
    color: white;
    border: none;
}

#modalDesenvolvimento .action-button.btn-primary:hover {
    background: var(--primary-accent-hover);
}

#modalDesenvolvimento .btn-danger {
    background-color: var(--danger-accent);
    color: white;
    width: 100%;
    margin-top: 16px;
    border: none;
    padding: 12px;
    height: auto;
    font-size: 0.95rem;
}

#modalDesenvolvimento .btn-danger:hover {
    background-color: #c0392b;
}


@media (max-width: 480px) {
    #modalDesenvolvimento .modalContent {
        margin: 16px auto;
        max-width: 360px; 
        width: calc(100% - 32px);
        padding: 16px;
        border-radius: calc(var(--border-radius-main) - 8px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    }

    #modalDesenvolvimento .modal-header {
        text-align: center;
        margin-bottom: 16px;
    }

    #modalDesenvolvimento .modal-header h2 {
        font-size: 1.3rem;
        margin-bottom: 8px;
    }

    #modalDesenvolvimento .modal-header p {
        font-size: 0.9rem;
        line-height: 1.4;
        opacity: 0.8;
    }

    #modalDesenvolvimento .changelog {
        padding: 12px;
        font-size: 0.9rem;
        max-height: 160px;
    }

    #modalDesenvolvimento .action-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }

    #modalDesenvolvimento .action-button svg {
        width: 20px;
        height: 20px;
    }

    #modalDesenvolvimento .action-button span {
        font-size: 0.8rem;
    }

    #modalDesenvolvimento .btn-danger {
        margin-top: 12px;
        font-size: 0.9rem;
    }
}

/* Seção de cartões no formulário de senhas */
.btn-add-card {
    width: 100%;
    padding: 12px 16px;
    margin: 16px 0 8px 0;
    background: var(--input-bg);
    border: 1px dashed var(--border-color);
    border-radius: var(--border-radius-inner);
    color: var(--text-color);
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-add-card:hover {
    background: var(--button-hover-bg);
    border-color: var(--primary-accent);
}

.btn-add-card svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    fill: none;
}

.cartoes-list-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 12px;
}

.card-item-wrapper {
    padding: 20px;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-fields-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}

.card-fields-header h3 {
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
}

.card-fields-header svg {
    width: 20px;
    height: 20px;
    stroke: var(--primary-accent);
}

.btn-remove-card {
    background: transparent;
    border: none;
    color: var(--danger-accent);
    font-size: 1.1rem;
    padding: 4px 8px;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.btn-remove-card:hover {
    background: rgba(255, 59, 48, 0.1);
    transform: scale(1.05);
}

.card-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px 16px;
}

.card-form-grid .full-width {
    grid-column: span 2;
}

.card-input-group {
    position: relative;
}

.card-input-group label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 10px;
    opacity: 0.9;
}

.card-input-group input {
    width: 100%;
    padding: 16px 18px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    font-size: 0.95rem;
    background: var(--background-color);
    color: var(--text-color);
    transition: all 0.3s ease;
}

.card-input-group input:focus {
    outline: none;
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
    background: var(--input-focus-bg);
}

.card-input-group input::placeholder {
    color: var(--input-placeholder-color);
}

.card-icon-visual {
    width: 100%;
    height: 120px;
    background: var(--background-color);
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    position: relative;
    box-shadow: 0 8px 32px 0 var(--shadow-color);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.card-icon-visual::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(173, 216, 230, 0.05) 0%, transparent 70%);
    border-radius: 50%;
}

.card-icon-visual::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.1), transparent);
    pointer-events: none;
}

.card-icon-visual .card-chip {
    width: 45px;
    height: 32px;
    background: linear-gradient(135deg, rgba(173, 216, 230, 0.5), rgba(173, 216, 230, 0.7), rgba(173, 216, 230, 0.5));
    border-radius: 6px;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
    box-shadow: 0 2px 8px rgba(173, 216, 230, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.card-icon-visual .card-number-preview {
    font-size: 1.1rem;
    color: var(--text-color);
    font-weight: 600;
    letter-spacing: 2px;
    margin-top: 6px;
    position: relative;
    z-index: 1;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Ajustes para tema claro: cartão pré-visualização mais claro e arejado */
body[data-theme="light"] .card-icon-visual {
    background: #f8fafc;
    border: 1px solid rgba(15, 23, 42, 0.08);
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
}
body[data-theme="light"] .card-icon-visual::before {
    background: radial-gradient(circle, rgba(59, 130, 246, 0.10) 0%, transparent 70%);
}
body[data-theme="light"] .card-icon-visual::after {
    background: linear-gradient(to top, rgba(15, 23, 42, 0.08), transparent);
}
body[data-theme="light"] .card-icon-visual .card-chip {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.42), rgba(59, 130, 246, 0.62), rgba(59, 130, 246, 0.42));
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.5);
}
body[data-theme="light"] .card-icon-visual .card-number-preview {
    color: #0f172a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.55);
}
body[data-theme="light"] .card-icon-visual .card-holder-preview {
    color: #1d4ed8;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.6);
}

.card-icon-visual .card-holder-preview {
    font-size: 0.85rem;
    color: rgba(173, 216, 230, 0.8);
    text-transform: uppercase;
    margin-top: 4px;
    position: relative;
    z-index: 1;
    font-weight: 600;
    letter-spacing: 1px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

/* Ajustes para mobile - cartões menores e mais compactos */
@media (max-width: 768px) {
    .card-icon-visual {
        height: 90px !important;
        padding: 10px 12px !important;
        margin-bottom: 12px !important;
        border-radius: 10px !important;
    }
    
    .card-icon-visual .card-chip {
        width: 30px !important;
        height: 22px !important;
        border-radius: 4px !important;
        margin-bottom: 6px !important;
    }
    
    .card-icon-visual .card-number-preview {
        font-size: 0.75rem !important;
        letter-spacing: 1.2px !important;
        margin-top: 3px !important;
        line-height: 1.2 !important;
    }
    
    .card-icon-visual .card-holder-preview {
        font-size: 0.65rem !important;
        letter-spacing: 0.6px !important;
        margin-top: 2px !important;
        line-height: 1.2 !important;
    }
    
    .card-item-wrapper {
        margin-bottom: 16px;
    }
    
    .card-fields-header h3 {
        font-size: 0.95rem;
    }
    
    .card-form-grid {
        gap: 12px;
    }
    
    .card-input-group label {
        font-size: 0.85rem;
    }
    
    .card-input-group input {
        padding: 10px 12px;
        font-size: 0.9rem;
    }
    
    .card-display {
        max-width: 100% !important;
        padding: 14px 16px !important;
        margin: 10px auto;
        border-radius: 12px !important;
    }
    
    .card-display .card-chip {
        width: 30px !important;
        height: 22px !important;
    }
    
    .card-display .card-number-preview {
        font-size: 0.75rem !important;
        letter-spacing: 1.2px !important;
    }
    
    .card-display .card-holder-preview {
        font-size: 0.65rem !important;
        letter-spacing: 0.6px !important;
    }
    
    /* Cartão padrão no modal */
    #default-card-preview {
        max-width: 100% !important;
        padding: 12px 14px !important;
        margin: 12px auto 16px !important;
        border-radius: 12px !important;
    }
    
    #default-card-preview .card-chip-display {
        width: 28px !important;
        height: 20px !important;
        margin-bottom: 8px !important;
    }
    
    #default-card-preview .card-number-display {
        font-size: 0.7rem !important;
        letter-spacing: 1px !important;
        margin-bottom: 10px !important;
        word-spacing: 3px !important;
    }
    
    #default-card-preview .card-info-row {
        gap: 6px !important;
    }
    
    #default-card-preview .card-label {
        font-size: 0.5rem !important;
        letter-spacing: 0.6px !important;
        margin-bottom: 1px !important;
    }
    
    #default-card-preview .card-value {
        font-size: 0.65rem !important;
    }
    
    #defaultCardModal .modalContent {
        padding: 16px !important;
        max-height: 95vh !important;
    }
}

/* Cartão padrão - visualização compacta */
.card-display {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%) !important;
    backdrop-filter: blur(var(--blur-intensity));
    -webkit-backdrop-filter: blur(var(--blur-intensity));
    border: 1px solid rgba(255, 255, 255, 0.10) !important;
    border-radius: 18px !important;
    padding: 22px 24px !important;
    margin: 14px auto;
    max-width: none !important;
    width: 100% !important;
    color: var(--text-color);
    box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35), 0 4px 12px rgba(0, 0, 0, 0.20) !important;
    position: relative;
    overflow: hidden;
    isolation: isolate;
}

#default-card-preview {
    max-width: 100% !important;
    width: 100% !important;
}

.card-preview-default {
    position: relative;
    background: linear-gradient(160deg, #1d1f24 0%, #22262e 60%, #1c1f26 100%) !important;
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    border-radius: 16px !important;
    padding: 18px 18px 16px 18px !important;
    box-shadow: 0 14px 30px rgba(0, 0, 0, 0.38), inset 0 1px 0 rgba(255, 255, 255, 0.05) !important;
    overflow: visible;
    isolation: isolate;
    width: 100% !important;
    max-width: 360px;
    max-height: none !important;
    height: auto !important;
}

.card-preview-default::before,
.card-preview-default::after {
    content: '';
    position: absolute;
    pointer-events: none;
    border-radius: 50%;
    filter: blur(12px);
    opacity: 0.9;
    z-index: 0;
}

.card-preview-default::before {
    width: 180px;
    height: 180px;
    top: -80px;
    left: -40px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 65%);
}

.card-preview-default::after {
    width: 160px;
    height: 160px;
    bottom: -70px;
    right: -24px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.06) 0%, transparent 62%);
}

.card-preview-default .card-chip-display {
    width: 44px;
    height: 30px;
    background: linear-gradient(135deg, #d9d9d9 0%, #bfbfbf 60%, #9e9e9e 100%);
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.35), 0 5px 12px rgba(0, 0, 0, 0.26);
    position: relative;
    z-index: 1;
}

.card-preview-default .card-chip-display::after {
    content: '';
    position: absolute;
    inset: 4px;
    border-radius: 4px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.24), rgba(0, 0, 0, 0.12));
}

.card-preview-default .card-number-display {
    font-size: 1.05rem;
    font-weight: 750;
    letter-spacing: 2px;
    word-spacing: 7px;
    color: #f5f7fa;
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.45);
    font-family: 'SF Mono', 'Consolas', 'Roboto Mono', monospace;
    margin-bottom: 12px;
    z-index: 1;
}

.card-preview-default .card-info-row {
    display: grid;
    grid-template-columns: 1.25fr 0.75fr;
    gap: 10px;
    align-items: end;
    z-index: 1;
}

.card-preview-default .card-label {
    font-size: 0.64rem;
    letter-spacing: 1.05px;
    color: rgba(220, 224, 232, 0.72);
    text-transform: uppercase;
    font-weight: 700;
    margin-bottom: 2px;
}

.card-preview-default .card-value {
    font-size: 0.9rem;
    font-weight: 760;
    text-transform: uppercase;
    color: #e6e8ed;
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
}

body[data-theme="light"] .card-preview-default {
    background: linear-gradient(160deg, #f6f7fb 0%, #eceff4 60%, #f7f8fb 100%) !important;
    border: 1px solid rgba(120, 140, 165, 0.22) !important;
    box-shadow: 0 14px 30px rgba(120, 140, 165, 0.18), 0 2px 10px rgba(120, 140, 165, 0.1) !important;
}

body[data-theme="light"] .card-preview-default::before {
    background: radial-gradient(circle, rgba(160, 175, 200, 0.18) 0%, transparent 60%);
}

body[data-theme="light"] .card-preview-default::after {
    background: radial-gradient(circle, rgba(140, 170, 210, 0.18) 0%, transparent 62%);
}

body[data-theme="light"] .card-preview-default .card-number-display {
    color: #0f172a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}

body[data-theme="light"] .card-preview-default .card-value {
    color: #0f172a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.75);
}

@media (max-width: 520px) {
    .card-preview-default {
        padding: 16px 16px 14px 16px !important;
        border-radius: 16px !important;
        max-width: 100%;
    }
    .card-preview-default .card-chip-display {
        width: 40px;
        height: 28px;
        margin-bottom: 10px;
    }
    .card-preview-default .card-number-display {
        font-size: 1rem;
        letter-spacing: 1.8px;
        word-spacing: 6px;
        margin-bottom: 12px;
    }
    .card-preview-default .card-info-row {
        grid-template-columns: 1fr 0.9fr;
        gap: 8px;
    }
    .card-preview-default .card-label {
        font-size: 0.6rem;
        letter-spacing: 1px;
    }
    .card-preview-default .card-value {
        font-size: 0.9rem;
    }
}

.card-display::before {
    content: '';
    position: absolute;
    top: -40%;
    left: -20%;
    width: 250px;
    height: 250px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(96, 165, 250, 0.18) 0%, transparent 70%);
    opacity: 1;
    z-index: -1;
}

.card-display::after {
    content: '';
    position: absolute;
    bottom: -35%;
    right: -15%;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.12) 0%, transparent 65%);
    z-index: -1;
}

.card-display .card-chip-display {
    width: 42px;
    height: 32px;
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
    border-radius: 6px;
    margin-bottom: 14px;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.4), 0 4px 14px rgba(0, 0, 0, 0.35);
    position: relative;
}

.card-display .card-chip-display::after {
    content: '';
    position: absolute;
    inset: 3px;
    border-radius: 3px;
    background: linear-gradient(135deg, transparent, rgba(0, 0, 0, 0.15));
}

.card-display .card-number-display {
    font-size: 1.15rem;
    font-weight: 700;
    letter-spacing: 2.5px;
    margin-bottom: 16px;
    word-spacing: 8px;
    color: #ffffff;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.45);
    font-family: 'SF Mono', 'Consolas', 'Roboto Mono', monospace;
}

.card-display .card-info-row {
    display: grid;
    grid-template-columns: 1.3fr 0.7fr;
    gap: 10px;
    align-items: end;
}

.card-display .card-holder-display,
.card-display .card-expiry-display {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.card-display .card-label {
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.65);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-weight: 600;
    margin-bottom: 2px;
}

.card-display .card-value {
    font-size: 0.95rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #ffffff;
    text-shadow: 0 2px 6px rgba(0, 0, 0, 0.40);
}

body[data-theme="light"] .card-display .card-label {
    color: rgba(30, 58, 138, 0.70);
}

body[data-theme="light"] .card-display .card-value {
    color: #1e3a8a;
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
}

@media (max-width: 480px) {
    .card-form-grid {
        grid-template-columns: 1fr;
    }

    .card-form-grid .full-width {
        grid-column: span 1;
    }

    .card-display {
        padding: 18px;
        width: 100%;
    }

    .card-display .card-number-display {
        font-size: 1.05rem;
        letter-spacing: 1.6px;
    }
}
</style>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>

// Silencia logs para reduzir ruído e custo de console
try {
    ['log','info','debug','trace'].forEach(fn => { try { console[fn] = function noop() {}; } catch(_){}});
} catch(_){ }

const SAL = "s3uS4lUn1c0D0S1st3m4";

let senhaDigitada = null;
let boards = [];
let boardsOriginal = [];
let anotacoesBoards = [];
let anotacoesBoardsOriginal = [];
let autoFillData = {};
let editandoBoardId = null;
let editandoCardId = null;
let openBoardIds = new Set(); 
let senhasCarregadas = false;
let anotacoesCarregadas = false;
let marcadores = [];
let editandoMarcadorId = null;


const loginDiv = document.getElementById("login");
const appDiv = document.getElementById("app");
const certificadoDiv = document.getElementById("certificado");
const anotacoesLoginDiv = document.getElementById("anotacoesLogin");
const anotacoesAppDiv = document.getElementById("anotacoesApp");
const autoFillSettingsDiv = document.getElementById("autoFillSettings");
const autoFillFormDiv = document.getElementById("autoFillForm");
const acessoEspecialDiv = document.getElementById("acessoEspecial");
const recuperarPinDiv = document.getElementById("recuperarPin");
const forgotPinLink = document.getElementById("forgot-pin-link");
const btnVerificarSenhaEspecial = document.getElementById("btnVerificarSenhaEspecial");
const btnVoltarAcessoEspecial = document.getElementById("btnVoltarAcessoEspecial");
const btnPinRecuperadoConcluido = document.getElementById("btnPinRecuperadoConcluido");
const modalSenhaDiv = document.getElementById("modalSenha");
const formSenha = document.getElementById("formSenha");
const btnCancelarSenha = document.getElementById("btnCancelarSenha");
const modalAnotacaoDiv = document.getElementById("modalAnotacao");
const formAnotacao = document.getElementById("formAnotacao");
const btnCancelarAnotacao = document.getElementById("btnCancelarAnotacao");
const btnModoLeitura = document.getElementById("btnModoLeitura");
const btnImportar = document.getElementById("btnImportar");
const btnExportar = document.getElementById("btnExportar");
const btnFiltrar = document.getElementById("btnFiltrar");
const btnLimparFiltro = document.getElementById("btnLimparFiltro");
const btnAdicionarCategoria = document.getElementById("btnAdicionarCategoria");
const importFileInput = document.getElementById("importFileInput");
const btnModoLeituraAnotacao = document.getElementById("btnModoLeituraAnotacao");
const btnImportarAnotacao = document.getElementById("btnImportarAnotacao");
const btnExportarAnotacao = document.getElementById("btnExportarAnotacao");
const btnFiltrarAnotacao = document.getElementById("btnFiltrarAnotacao");
const btnLimparFiltroAnotacao = document.getElementById("btnLimparFiltroAnotacao");
const btnAdicionarAnotacaoCategoria = document.getElementById("btnAdicionarAnotacaoCategoria");
const importAnotacaoFileInput = document.getElementById("importAnotacaoFileInput");
const btnInstalar = document.getElementById("btnInstalar");
const messageBox = document.getElementById("message-box");
const overlay = document.getElementById("overlay");
const btnEntrar = document.getElementById("btnEntrar");
const btnCertificado = document.getElementById("btnCertificado");
const btnAnotacoes = document.getElementById("btnAnotacoes");
const btnVoltarLogin = document.getElementById("btnVoltarLogin");
const btnVoltarLoginAnotacoes = document.getElementById("btnVoltarLoginAnotacoes");
const btnSair = document.getElementById("btnSair");
const btnSairAnotacao = document.getElementById("btnSairAnotacao");
const versionLink = document.getElementById("version-link");
const modalObservacoes = document.getElementById("modalObservacoes");
const btnSalvarObservacoes = document.getElementById("btnSalvarObservacoes");
const btnRedefinirTempo = document.getElementById("btnRedefinirTempo");
const pinInputs = document.querySelectorAll('.pin-input');
const btnUpdates = document.getElementById("btnUpdates");
const modalDesenvolvimento = document.getElementById("modalDesenvolvimento");
const btnAtivarUpdate = document.getElementById("btnAtivarUpdate");
const btnDesativarUpdate = document.getElementById("btnDesativarUpdate");
const btnApagarDados = document.getElementById("btnApagarDados");
const updateDialog = document.getElementById("update-dialog");
const btnRealizarUpload = document.getElementById("btnRealizarUpload");
const updateFileInput = document.getElementById("updateFileInput");
const btnVerMelhorias = document.getElementById("btnVerMelhorias");
const themeToggleBtn = document.getElementById("theme-toggle-btn");
const floatingWrenchBtn = document.getElementById("floating-wrench-btn");
const fabRefreshBtn = document.getElementById("fab-refresh-btn");
const fabMain = document.getElementById("fab-main");
const fabContainer = document.querySelector(".fab-container");
const quickRefreshBox = document.getElementById("quick-refresh-box");
const quickRefreshProgress = document.getElementById("quick-refresh-progress");
const quickRefreshTitle = document.getElementById("quick-refresh-title");
const quickRefreshCaption = document.getElementById("quick-refresh-caption");
const quickRefreshPill = document.getElementById("quick-refresh-pill");
const quickRefreshDismiss = document.getElementById("quick-refresh-dismiss");
const alertaRevisaoSenha = document.getElementById("alerta-revisao-senha");
const toggleMobileInstructions = document.getElementById('toggleMobileInstructions');
const mobileInstructions = document.getElementById('mobileInstructions');
const certTitulo = document.querySelector('#certificado .codigo-box');
const certInstructions = document.getElementById('certInstructions');
const pluginDigitalBox = document.getElementById('pluginDigitalBox');


fabMain.addEventListener("click", (e) => {
    e.stopPropagation(); 
    fabContainer.classList.toggle("active");
});

let quickRefreshTimer = null;
function startQuickRefresh() {
    if (!quickRefreshBox || !quickRefreshProgress) return;
    if (quickRefreshTimer) {
        clearTimeout(quickRefreshTimer);
        quickRefreshTimer = null;
    }

    // Mostrar imediatamente o alerta de revisão de senhas
    if (alertaRevisaoSenha) {
        try { localStorage.removeItem('alertaRevisaoSenhaSnooze'); } catch(_) {}
        alertaRevisaoSenha.style.display = 'flex';
    }

    quickRefreshBox.classList.add("visible");
    quickRefreshBox.classList.remove("done");
    quickRefreshProgress.style.width = "0%";
    if (quickRefreshTitle) quickRefreshTitle.textContent = "Atualizando o site";
    if (quickRefreshCaption) quickRefreshCaption.textContent = "Aplicando ajustes rápidos sem sair do painel.";
    if (quickRefreshPill) {
        quickRefreshPill.textContent = "Em andamento";
        quickRefreshPill.setAttribute("data-state", "running");
    }

    requestAnimationFrame(() => {
        quickRefreshProgress.style.width = "100%";
    });

    quickRefreshTimer = setTimeout(() => {
        quickRefreshBox.classList.add("done");
        if (quickRefreshTitle) quickRefreshTitle.textContent = "Site atualizado";
        if (quickRefreshCaption) quickRefreshCaption.textContent = "Seu painel permanece aberto e sincronizado.";
        if (quickRefreshPill) {
            quickRefreshPill.textContent = "Pronto";
            quickRefreshPill.setAttribute("data-state", "done");
        }

        quickRefreshTimer = setTimeout(() => {
            quickRefreshBox.classList.remove("visible", "done");
            quickRefreshProgress.style.width = "0%";
            quickRefreshTimer = null;
        }, 1200);
    }, 1500);
}

if (fabRefreshBtn) {
    fabRefreshBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        startQuickRefresh();
    });
}

if (quickRefreshDismiss) {
    quickRefreshDismiss.addEventListener("click", () => {
        if (quickRefreshTimer) {
            clearTimeout(quickRefreshTimer);
            quickRefreshTimer = null;
        }
        if (quickRefreshBox) quickRefreshBox.classList.remove("visible", "done");
        if (quickRefreshProgress) quickRefreshProgress.style.width = "0%";
    });
}

// Modal overlay click handler with short shield to avoid immediate re-close
window.__modalClickShield = false;
function handleOverlayClick(e) {
    console.log('[OVERLAY] handleOverlayClick invoked', { shield: window.__modalClickShield, target: (e && e.target) ? e.target.tagName + (e.target.id ? '#'+e.target.id : '') : e });
    try { console.trace(); } catch(_){}
    if (window.__modalClickShield) {
        try { e.stopPropagation(); } catch(_){ }
        console.log('[MODAL-SHIELD] Ignoring overlay click immediately after open');
        return;
    }
    // Só fechar via overlay quando o messageBox (dialogos/prompt/confirm) estiver visível.
    try {
        const msgVisible = messageBox && messageBox.style && messageBox.style.display && messageBox.style.display !== 'none';
        const obsVisible = modalObservacoes && modalObservacoes.style && modalObservacoes.style.display && modalObservacoes.style.display !== 'none';
        const devVisible = modalDesenvolvimento && modalDesenvolvimento.style && modalDesenvolvimento.style.display && modalDesenvolvimento.style.display !== 'none';
        if (msgVisible || obsVisible || devVisible) {
            try { fecharMensagem(false); } catch (err) { console.warn('Error closing via overlay (messageBox):', err); }
        } else {
            // Ignorar overlay clicks para modais da aplicação (Senhas/Anotacoes) —
            // esses modais têm seus próprios handlers e já são protegidos por shield/flags.
            console.log('[OVERLAY] click ignored: no messageBox/modal visible');
            // Fallback: se o overlay estiver visível mas nenhum modal/messageBox
            // estiver visível (estado inconsistente), forçar fechamento seguro
            // usando fecharMensagem(true) para limpar overlay e restaurar scroll.
            try {
                if (overlay && overlay.style && overlay.style.display && overlay.style.display !== 'none') {
                    console.log('[OVERLAY] No modal visible but overlay is shown — forcing hide');
                    try { fecharMensagem(true); } catch (err) { console.warn('Fallback fecharMensagem(true) failed', err); }
                }
            } catch (err) {
                console.warn('[OVERLAY] fallback hide failed', err);
            }
        }
    } catch (err) {
        try { fecharMensagem(false); } catch (err2) { console.warn('Error closing via overlay (fallback):', err2); }
    }
}


document.addEventListener("click", (e) => {
    if (!fabContainer.contains(e.target)) {
        fabContainer.classList.remove("active");
    }
});


document.querySelectorAll(".fab-action-button").forEach(button => {
    button.addEventListener("click", (e) => {
        e.stopPropagation(); 
        
        setTimeout(() => {
            fabContainer.classList.remove("active");
        }, 200);
    });
});
// Body scroll lock utilities (safe for multiple modals)
window.__bodyLock = window.__bodyLock || { count: 0, scrollY: 0 };
function lockBodyScroll() {
    try {
        const state = window.__bodyLock;
        console.log('[BODY-LOCK] lockBodyScroll called - before', { count: state.count, scrollY: window.scrollY });
        try { console.trace(); } catch(_){}
        if (state.count === 0) {
            state.scrollY = window.scrollY || window.pageYOffset || 0;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${state.scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
            console.log('[BODY-LOCK] locked at', state.scrollY);
        }
        state.count += 1;
        console.log('[BODY-LOCK] lockBodyScroll called - after', { count: state.count });
    } catch (e) { console.warn('[BODY-LOCK] failed to lock', e); }
}
// Lock body scroll using an explicit Y coordinate (useful when window.scrollY
// changes due to reflow between capture and lock). This ensures we restore
// exactly the position the UI had when the modal open was initiated.
function lockBodyScrollAt(scrollY) {
    try {
        const state = window.__bodyLock;
        const y = (typeof scrollY === 'number') ? scrollY : (window.scrollY || window.pageYOffset || 0);
        console.log('[BODY-LOCK] lockBodyScrollAt called - before', { count: state.count, providedScrollY: scrollY });
        try { console.trace(); } catch(_){ }
        if (state.count === 0) {
            state.scrollY = y;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${state.scrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
            console.log('[BODY-LOCK] locked at (explicit)', state.scrollY);
        }
        state.count += 1;
        console.log('[BODY-LOCK] lockBodyScrollAt called - after', { count: state.count });
    } catch (e) { console.warn('[BODY-LOCK] lockBodyScrollAt failed to lock', e); }
}
function unlockBodyScroll() {
    try {
        const state = window.__bodyLock;
        console.log('[BODY-LOCK] unlockBodyScroll called - before', { count: state.count });
        try { console.trace(); } catch(_){}
        state.count = Math.max(0, (state.count || 1) - 1);
        if (state.count === 0) {
            const y = state.scrollY || 0;
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            window.scrollTo(0, y);
            console.log('[BODY-LOCK] unlocked and restored to', y);
        } else {
            console.log('[BODY-LOCK] unlock deferred, remaining count', state.count);
        }
        console.log('[BODY-LOCK] unlockBodyScroll called - after', { count: state.count });
    } catch (e) { console.warn('[BODY-LOCK] failed to unlock', e); }
}
// Helper: attach a close handler to a button that defers activation until
// it's safe (prevents the same click that opened the modal from closing it).
function attachSafeClose(btnId, modalToken) {
    try {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const attach = () => {
            const handler = function (e) {
                try {
                    if (window.__modalClickShield) {
                        console.log('[SAFE-CLOSE] shield active, deferring close for', btnId);
                        // Try again after shield may clear
                        setTimeout(() => { try { btn.addEventListener('click', handler, { once: true }); } catch(_){} }, 200);
                        return;
                    }
                } catch (_) {}
                try { fecharMensagem(false, modalToken); } catch (err) { console.warn('fecharMensagem failed', err); }
            };
            btn.addEventListener('click', handler, { once: true });
        };
        try { btn.disabled = true; } catch(_){ }
        // enable immediately but attach on next frame to avoid same-click activation
        try {
            requestAnimationFrame(() => { try { btn.disabled = false; } catch(_){}; requestAnimationFrame(attach); });
        } catch (e) {
            // fallback to microtask style if rAF is not available
            setTimeout(() => { try { btn.disabled = false; } catch(_){}; setTimeout(attach, 0); }, 0);
        }
    } catch (err) { console.warn('attachSafeClose failed for', btnId, err); }
}
const btnVoltarObservacoes = document.getElementById("btnVoltarObservacoes");
const inputCpf = document.getElementById("inputCpf");
const inputTelefone = document.getElementById("inputTelefone");
const inputEmail = document.getElementById("inputEmail");
const gmailHelperBtn = document.getElementById("gmail-helper");
const inputLinks = document.getElementById("inputLinks");
const inputAbreviacao = document.getElementById("inputAbreviacao");
const abreviacaoContainer = document.getElementById("abreviacao-container");
const btnGoToSettings = document.getElementById("btn-go-to-settings");
const btnGoToAutoFillForm = document.getElementById("btn-go-to-autofill-form");
const btnAutoFillBackToApp = document.getElementById("btn-autofill-back-to-app");
const formAutoFillData = document.getElementById("formAutoFillData");
const btnAutoFillFormBack = document.getElementById("btn-autofill-form-back");
const btnAutoFillTrigger = document.getElementById("btn-autofill-trigger");
const btnUploadSenhas = document.getElementById('btnUploadSenhas');
const btnManageMarcadores = document.getElementById('btn-manage-marcadores');
const modalMarcadores = document.getElementById('modalMarcadores');
const btnFecharMarcadores = document.getElementById('btnFecharMarcadores');
const btnAdicionarMarcador = document.getElementById('btn-adicionar-marcador');
const marcadorNomeInput = document.getElementById('marcador-nome-input');
const marcadorCorInput = document.getElementById('marcador-cor-input');
const marcadoresList = document.getElementById('marcadores-list');
const inputMarcador = document.getElementById('inputMarcador');
const inputMarcadorAnotacao = document.getElementById('inputMarcadorAnotacao');
// Aparelhos conectados
const btnManageDevices = document.getElementById('btn-manage-devices');
const modalDevices = document.getElementById('modalDevices');
const btnCloseDevices = document.getElementById('btnCloseDevices');
const formDevice = document.getElementById('formDevice');
const devicesListContainer = document.getElementById('devices-list-container');
const registeredDevicesDisplay = document.getElementById('registered-devices-display');
const currentDeviceChip = document.getElementById('current-device-chip');
const currentDeviceChipIcon = document.getElementById('current-device-chip-icon');
let aparelhosConectados = [];

// Modal cartão padrão
const defaultCardModal = document.getElementById('defaultCardModal');
const btnDefaultCard = document.getElementById('btn-default-card');
const btnDefaultCardBack = document.getElementById('btn-default-card-back');
const btnDefaultCardSave = document.getElementById('btn-default-card-save');
const btnDefaultCardClear = document.getElementById('btn-default-card-clear');
const defaultCardNumber = document.getElementById('default-card-number');
const defaultCardHolder = document.getElementById('default-card-holder');
const defaultCardExpiry = document.getElementById('default-card-expiry');
const defaultCardCvv = document.getElementById('default-card-cvv');
const defaultCardBrand = document.getElementById('default-card-brand');
const previewCardNumber = document.getElementById('preview-card-number');
const previewCardHolder = document.getElementById('preview-card-holder');
const previewCardExpiry = document.getElementById('preview-card-expiry');


document.addEventListener('DOMContentLoaded', () => {
if (localStorage.getItem('updateNoticeVisible') === 'true') {
updateDialog.style.display = 'block';
}
const savedTheme = localStorage.getItem('theme') || 'dark';
setTheme(savedTheme);

// Carregar marcadores ao iniciar
carregarMarcadores();
atualizarSelectsMarcadores();
renderizarAparelhosIcones();

document.querySelectorAll('.btn-clear-field').forEach(btn => {
btn.addEventListener('click', (e) => {
   const container = e.target.closest('.input-container');
   if (container) {
       const input = container.querySelector('input, textarea');
       if (input) {
           input.value = '';
           input.dispatchEvent(new Event('input', { bubbles: true }));
       }
   }
   e.target.style.display = 'none';
});
});
});


themeToggleBtn.addEventListener('click', toggleTheme);
floatingWrenchBtn.addEventListener('click', abrirModalObservacoes);
btnVoltarObservacoes.addEventListener('click', () => fecharMensagem(false));
btnEntrar.addEventListener('click', login);
btnCertificado.addEventListener('click', () => mostrarTela('certificado'));
btnAnotacoes.addEventListener('click', () => mostrarTela('anotacoesLogin'));
btnVoltarLogin.addEventListener('click', () => mostrarTela('login'));
btnVoltarLoginAnotacoes.addEventListener('click', () => mostrarTela('login'));
btnSair.addEventListener('click', logout);
btnSairAnotacao.addEventListener('click', logout);
btnModoLeitura.addEventListener('click', () => toggleModoLeitura('app'));
btnAdicionarCategoria.addEventListener('click', () => submitNewColumn('senha'));
btnFiltrar.addEventListener('click', () => filtrarCategorias('senha'));
btnLimparFiltro.addEventListener('click', () => limparFiltro('senha'));
btnImportar.addEventListener('click', () => importFileInput.click());
btnExportar.addEventListener('click', () => exportarDados('senha'));
importFileInput.addEventListener('change', (e) => importarDados(e, 'senha'));
btnModoLeituraAnotacao.addEventListener('click', () => toggleModoLeitura('anotacoesApp'));
btnAdicionarAnotacaoCategoria.addEventListener('click', () => submitNewColumn('anotacao'));
btnFiltrarAnotacao.addEventListener('click', () => filtrarCategorias('anotacao'));
btnLimparFiltroAnotacao.addEventListener('click', () => limparFiltro('anotacao'));
btnImportarAnotacao.addEventListener('click', () => importAnotacaoFileInput.click());
btnExportarAnotacao.addEventListener('click', () => exportarDados('anotacao'));
importAnotacaoFileInput.addEventListener('change', (e) => importarDados(e, 'anotacao'));
if (btnUploadSenhas) {
    btnUploadSenhas.addEventListener('click', async () => {
        const confirmado = await mostrarConfirmacao(
            'Fazer upload de senhas',
            'Aviso: o arquivo pode não estar compatível com a versão atual ou pode estar desatualizado. Deseja continuar?'
        );
        if (confirmado) {
            const megaUrl = 'https://mega.nz/folder/D0glSRSS#tOF-3TZHXqBALCmD_n3FOQ';
            window.open(megaUrl, '_blank', 'noopener');
        }
    });
}

pinInputs.forEach((input, index) => {
input.addEventListener('keydown', (e) => {
  if (e.key === 'Backspace' && !input.value && index > 0) {
      pinInputs[index - 1].focus();
  }
});
input.addEventListener('input', () => {
  const value = input.value;
  if (value) {
      setTimeout(() => { input.type = 'password'; }, 500);
      if (index < pinInputs.length - 1) {
          pinInputs[index + 1].focus();
      } else {
          verificarPin();
      }
  } else {
      input.type = 'tel';
  }
});
input.addEventListener('focus', () => { input.type = 'tel'; });
});

forgotPinLink.addEventListener('click', () => mostrarTela('acessoEspecial'));
btnVerificarSenhaEspecial.addEventListener('click', verificarSenhaParaRecuperarPin);
btnVoltarAcessoEspecial.addEventListener('click', () => mostrarTela('anotacoesLogin'));
btnPinRecuperadoConcluido.addEventListener('click', () => mostrarTela('anotacoesLogin'));
if (btnCancelarSenha) {
    btnCancelarSenha.addEventListener('click', (e) => {
        try {
            if (e && e.isTrusted === false) {
                console.log('[SAFE-CANCEL] Ignoring synthetic click on btnCancelarSenha');
                return;
            }
        } catch(_){}
        try {
            const shield = !!window.__modalClickShield;
            const last = window.__lastModalOpenTime || 0;
            const age = Date.now() - last;
            if (shield || (last && age < 700) || (modalSenhaDiv && modalSenhaDiv.dataset && modalSenhaDiv.dataset.opening === 'true')) {
                console.log('[SAFE-CANCEL] btnCancelarSenha ignored due to shield/opening', { shield, age });
                return;
            }
        } catch(_){}
        fecharModalSenha();
    });
}
formSenha.addEventListener('submit', salvarSenha);
if (btnCancelarAnotacao) {
    btnCancelarAnotacao.addEventListener('click', (e) => {
        try {
            if (e && e.isTrusted === false) {
                console.log('[SAFE-CANCEL] Ignoring synthetic click on btnCancelarAnotacao');
                return;
            }
        } catch(_){}
        try {
            const shield = !!window.__modalClickShield;
            const last = window.__lastModalOpenTime || 0;
            const age = Date.now() - last;
            if (shield || (last && age < 700) || (modalAnotacaoDiv && modalAnotacaoDiv.dataset && modalAnotacaoDiv.dataset.opening === 'true')) {
                console.log('[SAFE-CANCEL] btnCancelarAnotacao ignored due to shield/opening', { shield, age });
                return;
            }
        } catch(_){}
        fecharModalAnotacao();
    });
}
modalSenhaDiv.addEventListener('click', (e) => {
    try {
        // Ignorar cliques residuais logo após a abertura do modal de Senhas
        const shield = !!window.__modalClickShield;
        const last = window.__lastModalOpenTime || 0;
        const age = Date.now() - last;
        if (e.target === modalSenhaDiv) {
            if (shield || (last && age < 480) || modalSenhaDiv.dataset.opening === 'true') {
                console.log('[MODAL-SHIELD] Ignoring modalSenhaDiv click (shield active or recent open)', { shield, age, opening: modalSenhaDiv.dataset.opening });
                return;
            }
            fecharModalSenha();
        }
    } catch (err) {
        console.warn('[MODAL-SHIELD] modalSenhaDiv click handler error, ignoring close', err);
        // Não chamar fecharModalSenha() aqui sem passar pelas checagens de shield/age/opening
    }
});

// Desabilitar fechamento via clique no backdrop do modal de Anotações
// para evitar fechamentos acidentais/reentrância causados por reflows ou
// handlers concorrentes. Usuário deve usar o botão 'Voltar' para fechar.
if (modalAnotacaoDiv) {
    modalAnotacaoDiv.addEventListener('click', (e) => {
        try {
            if (e && e.isTrusted === false) {
                console.log('[MODAL-BACKDROP] Ignoring synthetic backdrop click (anotacoes)');
                return;
            }
            if (e.target === modalAnotacaoDiv) {
                console.log('[MODAL-BACKDROP] Backdrop click ignored for modalAnotacaoDiv');
            }
        } catch (err) {
            console.warn('[MODAL-BACKDROP] error handling backdrop click (anotacoes)', err);
        }
    });
}
formAnotacao.addEventListener('submit', salvarAnotacao);

// ========== FUNCIONALIDADE DE MÚLTIPLOS CARTÕES ==========
(function() {
    const btnAdicionarcartao = document.getElementById('btnAdicionarcartão');
    const btnAdicionarcartaoPadrao = document.getElementById('btnAdicionarcartãoPadrao');
    const cartoesListContainer = document.getElementById('cartoesListContainer');
    let cartoes = [];
    let nextCardId = 1;

    const hasContainer = () => !!cartoesListContainer;

    if (btnAdicionarcartao && hasContainer()) {
        btnAdicionarcartao.addEventListener('click', () => adicionarNovocartao());
    }

    if (btnAdicionarcartaoPadrao && hasContainer()) {
        btnAdicionarcartaoPadrao.addEventListener('click', () => {
            const cartaoPadrao = obtercartãoPadrao();
            if (cartaoPadrao && cartaoPadrao.numero) {
                adicionarNovocartao(cartaoPadrao);
            } else {
                mostrarMensagem('Aviso', 'Nenhum cartão padrão configurado. Configure no formulário automático.');
            }
        });
    }

    function obtercartãoPadrao() {
        try {
            const cartaoPadraoStr = localStorage.getItem('cartãoPadrao');
            if (cartaoPadraoStr) {
                return JSON.parse(cartaoPadraoStr);
            }
        } catch (err) {
            console.error('Erro ao obter cartão padrão:', err);
        }
        return null;
    }

    window.obtercartãoPadraoGlobal = obtercartãoPadrao;

    function adicionarNovocartao(cardData = null) {
        if (!hasContainer()) return;

        const cardId = cardData?.id || Date.now() + nextCardId++;
        const cartao = cardData || {
            id: cardId,
            numero: '',
            titular: '',
            validade: '',
            cvv: '',
            bandeira: ''
        };

        cartoes.push(cartao);
        renderizarcartao(cartao);
    }

    function renderizarcartao(cartao) {
        if (!hasContainer()) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'card-item-wrapper';
        wrapper.dataset.cardId = cartao.id;

        wrapper.innerHTML = `
            <div class="card-fields-header">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                    cartão ${cartoes.length}
                </h3>
                <button type="button" class="btn-remove-card" data-card-id="${cartao.id}" title="Remover cartão">×</button>
            </div>
            
            <div class="card-icon-visual" style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #3b82f6 100%); border: 1px solid rgba(255, 255, 255, 0.10); border-radius: 14px; padding: 18px; margin-bottom: 20px; box-shadow: 0 10px 28px rgba(0, 0, 0, 0.20);">
                <div class="card-chip" style="width: 42px; height: 32px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%); border-radius: 6px; margin-bottom: 14px; box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.4), 0 4px 14px rgba(0, 0, 0, 0.35);"></div>
                <div class="card-number-preview" style="color: #ffffff; font-family: 'SF Mono', 'Consolas', 'Roboto Mono', monospace;">•••• •••• •••• ••••</div>
                <div class="card-holder-preview" style="color: rgba(255, 255, 255, 0.85);">NOME DO TITULAR</div>
            </div>
            
            <div class="card-form-grid">
                <div class="card-input-group full-width">
                    <label>Número do cartão</label>
                    <input type="text" class="input-card-number" data-card-id="${cartao.id}" placeholder="0000 0000 0000 0000" maxlength="19" inputmode="numeric" autocomplete="off" value="${cartao.numero || ''}" />
                </div>
                
                <div class="card-input-group full-width">
                    <label>Nome do Titular</label>
                    <input type="text" class="input-card-holder" data-card-id="${cartao.id}" placeholder="Como está no cartão" autocomplete="off" style="text-transform: uppercase;" value="${cartao.titular || ''}" />
                </div>
                
                <div class="card-input-group">
                    <label>Validade</label>
                    <input type="text" class="input-card-expiry" data-card-id="${cartao.id}" placeholder="MM/AA" maxlength="5" inputmode="numeric" autocomplete="off" value="${cartao.validade || ''}" />
                </div>
                
                <div class="card-input-group">
                    <label>CVV</label>
                    <input type="text" class="input-card-cvv" data-card-id="${cartao.id}" placeholder="000" maxlength="4" inputmode="numeric" autocomplete="off" value="${cartao.cvv || ''}" />
                </div>
                
                <div class="card-input-group full-width">
                    <label>Bandeira (Opcional)</label>
                    <input type="text" class="input-card-brand" data-card-id="${cartao.id}" placeholder="Visa, Mastercard, etc." autocomplete="off" value="${cartao.bandeira || ''}" />
                </div>
            </div>
        `;

        cartoesListContainer.appendChild(wrapper);

        const numberInput = wrapper.querySelector('.input-card-number');
        const holderInput = wrapper.querySelector('.input-card-holder');
        const expiryInput = wrapper.querySelector('.input-card-expiry');
        const cvvInput = wrapper.querySelector('.input-card-cvv');
        const brandInput = wrapper.querySelector('.input-card-brand');
        const removeBtn = wrapper.querySelector('.btn-remove-card');
        const numberPreview = wrapper.querySelector('.card-number-preview');
        const holderPreview = wrapper.querySelector('.card-holder-preview');

        numberInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 16) value = value.substring(0, 16);
            const formatted = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formatted;

            atualizarcartao(cartao.id, 'numero', formatted);

            if (value.length === 0) {
                numberPreview.textContent = '•••• •••• •••• ••••';
            } else {
                const groups = value.match(/.{1,4}/g) || [];
                const preview = groups.map((group, idx) => (idx === groups.length - 1 ? group : '••••')).join(' ');
                numberPreview.textContent = preview;
            }
        });

        holderInput.addEventListener('input', (e) => {
            const value = e.target.value.toUpperCase();
            e.target.value = value;
            atualizarcartao(cartao.id, 'titular', value);
            holderPreview.textContent = value || 'NOME DO TITULAR';
        });

        expiryInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.substring(0, 4);
            if (value.length >= 2) {
                value = `${value.substring(0, 2)}/${value.substring(2)}`;
            }
            e.target.value = value;
            atualizarcartao(cartao.id, 'validade', value);
        });

        cvvInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
            atualizarcartao(cartao.id, 'cvv', value);
        });

        brandInput.addEventListener('input', (e) => {
            atualizarcartao(cartao.id, 'bandeira', e.target.value);
        });

        removeBtn.addEventListener('click', () => removercartao(cartao.id));

        if (cartao.numero) numberInput.dispatchEvent(new Event('input'));
        if (cartao.titular) holderInput.dispatchEvent(new Event('input'));
    }

    function atualizarcartao(cardId, campo, valor) {
        const cartao = cartoes.find((c) => c.id === cardId);
        if (cartao) cartao[campo] = valor;
    }

    function removercartao(cardId) {
        cartoes = cartoes.filter((c) => c.id !== cardId);
        if (hasContainer()) {
            const wrapper = cartoesListContainer.querySelector(`[data-card-id="${cardId}"]`);
            if (wrapper) wrapper.remove();
            cartoesListContainer.querySelectorAll('.card-item-wrapper').forEach((node, idx) => {
                const h3 = node.querySelector('h3');
                if (h3) {
                    h3.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                            <line x1="1" y1="10" x2="23" y2="10"></line>
                        </svg>
                        cartão ${idx + 1}
                    `;
                }
            });
        }
    }

    window.obterCartoes = function obterCartoes() {
        return cartoes.filter((c) => c.numero && c.numero.trim() !== '');
    };

    window.carregarDadoscartão = function carregarDadoscartao(cartoesData) {
        limparTodosCartoes();
        if (cartoesData && Array.isArray(cartoesData)) {
            cartoesData.forEach((cartao) => adicionarNovocartao(cartao));
        } else if (cartoesData && typeof cartoesData === 'object') {
            adicionarNovocartao(cartoesData);
        }
    };

    window.limparDadoscartão = function limparDadosCartao() {
        limparTodosCartoes();
    };

    window.carregarCartoes = function carregarCartoes(cartoesData) {
        limparTodosCartoes();
        if (!cartoesData) return;
        
        const cartoesArray = Array.isArray(cartoesData) ? cartoesData : [cartoesData];
        cartoesArray.forEach((cartaoData) => {
            if (cartaoData && cartaoData.numero) {
                const cartao = {
                    id: nextCardId++,
                    numero: cartaoData.numero || '',
                    titular: cartaoData.titular || '',
                    validade: cartaoData.validade || '',
                    cvv: cartaoData.cvv || '',
                    bandeira: cartaoData.bandeira || ''
                };
                cartoes.push(cartao);
                renderizarcartao(cartao);
            }
        });
    };

    function limparTodosCartoes() {
        cartoes = [];
        if (hasContainer()) cartoesListContainer.innerHTML = '';
        nextCardId = 1;
    }
})();
// ========== FIM DA FUNCIONALIDADE DE MÚLTIPLOS CARTÕES ==========

function obterLabelTipoFormatacao(tipo) {
    const labels = { cpf: 'CPF', telefone: 'Telefone', email: 'E-mail', senha: 'Senha' };
    return labels[tipo] || tipo;
}

function aplicarFormatacaoPersonalizada(tipo) {
    const input = document.getElementById('inputCampoFormatacao');
    if (!input) return;

    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);

    const inputAtualizado = document.getElementById('inputCampoFormatacao');
    const placeholders = {
        cpf: 'Digite o CPF',
        telefone: 'Digite o telefone',
        email: 'Digite o e-mail',
        senha: 'Digite a senha'
    };
    inputAtualizado.placeholder = placeholders[tipo] || 'Digite o valor';

    inputAtualizado.type = 'text';
    inputAtualizado.removeAttribute('maxLength');
    inputAtualizado.inputMode = 'text';

    if (tipo === 'cpf') {
        inputAtualizado.maxLength = 14;
        inputAtualizado.inputMode = 'numeric';
        inputAtualizado.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 11) val = val.substring(0, 11);
            if (val.length > 9) {
                val = val.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (val.length > 6) {
                val = val.replace(/(\d{3})(\d{3})(\d+)/, '$1.$2.$3');
            } else if (val.length > 3) {
                val = val.replace(/(\d{3})(\d+)/, '$1.$2');
            }
            e.target.value = val;
        });
    } else if (tipo === 'telefone') {
        inputAtualizado.maxLength = 15;
        inputAtualizado.inputMode = 'numeric';
        inputAtualizado.addEventListener('input', (e) => {
            let val = e.target.value.replace(/\D/g, '');
            if (val.length > 11) val = val.substring(0, 11);
            if (val.length === 11) {
                val = val.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (val.length === 10) {
                val = val.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (val.length > 6) {
                val = val.replace(/(\d{2})(\d{4})(\d+)/, '($1) $2-$3');
            } else if (val.length > 2) {
                val = val.replace(/(\d{2})(\d+)/, '($1) $2');
            }
            e.target.value = val;
        });
    } else if (tipo === 'email') {
        inputAtualizado.type = 'email';
        inputAtualizado.inputMode = 'email';
    }
}

function analisarForcaSenha(senha) {
    if (!senha) return { strength: 'none', score: 0, label: '' };

    let score = 0;
    if (senha.length >= 8) score += 1;
    if (senha.length >= 12) score += 1;
    if (senha.length >= 16) score += 1;
    if (/[a-z]/.test(senha)) score += 1;
    if (/[A-Z]/.test(senha)) score += 1;
    if (/[0-9]/.test(senha)) score += 1;
    if (/[^a-zA-Z0-9]/.test(senha)) score += 2;

    const uniqueChars = new Set(senha).size;
    if (uniqueChars >= senha.length * 0.7) score += 1;

    if (score <= 3) return { strength: 'weak', score, label: 'Senha Fraca' };
    if (score <= 6) return { strength: 'medium', score, label: 'Senha Média' };
    return { strength: 'strong', score, label: 'Senha Forte' };
}

const passwordField = document.getElementById('inputSenha');
const passwordStrengthContainer = document.querySelector('.password-strength-container');
const passwordStrengthFill = document.getElementById('password-strength-fill');
const passwordStrengthText = document.getElementById('password-strength-text');
if (passwordField && passwordStrengthContainer && passwordStrengthFill && passwordStrengthText) {
    passwordField.addEventListener('input', function handlePasswordStrength() {
        const senha = this.value;
        if (!senha) {
            passwordStrengthContainer.style.display = 'none';
            passwordStrengthFill.className = 'password-strength-fill';
            passwordStrengthText.className = 'password-strength-text';
            passwordStrengthText.textContent = '';
            return;
        }

        const result = analisarForcaSenha(senha);
        passwordStrengthContainer.style.display = 'block';

        passwordStrengthFill.classList.remove('weak', 'medium', 'strong');
        passwordStrengthText.classList.remove('weak', 'medium', 'strong');

        if (result.strength !== 'none') {
            passwordStrengthFill.classList.add(result.strength);
            passwordStrengthText.classList.add(result.strength);
            passwordStrengthText.textContent = result.label;
        }
    });
}

const inputTipoFormatacaoEl = document.getElementById('inputTipoFormatacao');
if (inputTipoFormatacaoEl) {
    inputTipoFormatacaoEl.addEventListener('change', function handleTipoFormatacaoChange() {
        const campoFormatacaoContainer = document.getElementById('campo-formatacao-container');
        const tipoSelecionado = this.value;

        if (!campoFormatacaoContainer) return;

        if (tipoSelecionado) {
            campoFormatacaoContainer.style.display = 'block';
            aplicarFormatacaoPersonalizada(tipoSelecionado);
            setTimeout(() => {
                const inputCampo = document.getElementById('inputCampoFormatacao');
                if (inputCampo && !isMobileDevice()) inputCampo.focus();
            }, 100);
        } else {
            campoFormatacaoContainer.style.display = 'none';
            const inputCampo = document.getElementById('inputCampoFormatacao');
            if (inputCampo) inputCampo.value = '';
        }
    });
}

// Toggle de campos extras (Anotação)
const btnMaisInfoAnotacao = document.getElementById('btnMaisInfoAnotacao');
const extraFieldsAnotacao = document.getElementById('extraFieldsAnotacao');
if (btnMaisInfoAnotacao && extraFieldsAnotacao) {
    btnMaisInfoAnotacao.addEventListener('click', () => {
        const isOpen = extraFieldsAnotacao.style.display !== 'none';
        const nextState = !isOpen;
        extraFieldsAnotacao.style.display = nextState ? 'flex' : 'none';
        btnMaisInfoAnotacao.setAttribute('aria-expanded', nextState ? 'true' : 'false');
        btnMaisInfoAnotacao.textContent = nextState ? '− Menos informações' : '+ Mais informações';
        if (nextState) updateClearButtonsFormAnotacao();
    });
}

// Buscar na web (Anotações)
const searchNotesBtn = document.getElementById('search-notes-btn');
const inputLinksAnotacao = document.getElementById('inputLinksAnotacao');
if (searchNotesBtn && inputLinksAnotacao) {
    searchNotesBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const query = inputLinksAnotacao.value.trim();
        if (query) {
            window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
        }
    });
    inputLinksAnotacao.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = inputLinksAnotacao.value.trim();
            if (query) {
                window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
            }
        }
    });
}

// Gmail helper (Anotações)
const gmailHelperAnot = document.getElementById('gmail-helper-anotacao');
const inputEmailAnot = document.getElementById('inputEmailAnotacao');
if (gmailHelperAnot && inputEmailAnot) {
    const handleGmailHelperVisibilityAnot = () => {
        const hasAt = inputEmailAnot.value.includes('@');
        const empty = inputEmailAnot.value.trim() === '';
        if (!empty && !hasAt) gmailHelperAnot.classList.add('visible');
        else gmailHelperAnot.classList.remove('visible');
    };
    inputEmailAnot.addEventListener('input', handleGmailHelperVisibilityAnot);
    handleGmailHelperVisibilityAnot();
    gmailHelperAnot.addEventListener('click', () => {
        let val = inputEmailAnot.value.trim();
        if (val && !val.includes('@')) {
            inputEmailAnot.value = `${val}@gmail.com`;
        } else if (!val) {
            inputEmailAnot.value = '@gmail.com';
        }
        inputEmailAnot.dispatchEvent(new Event('input', { bubbles: true }));
        updateClearButtonsFormAnotacao();
    });
}

// Mostrar/ocultar botões limpar conforme digitação (Anotações)
document.querySelectorAll('#formAnotacao .input-container input, #formAnotacao .input-container textarea').forEach(input => {
    input.addEventListener('input', () => {
        const btn = input.parentElement.querySelector('.btn-clear-field');
        if (btn) btn.style.display = input.value ? 'block' : 'none';
    });
});
// Regras de formatação (Anotações) — iguais às do formulário de Senhas
const inputCpfAnotacao = document.getElementById('inputCpfAnotacao');
const inputTelefoneAnotacao = document.getElementById('inputTelefoneAnotacao');
if (inputCpfAnotacao) inputCpfAnotacao.addEventListener('input', (e) => formatarCPF(e.target));
if (inputTelefoneAnotacao) inputTelefoneAnotacao.addEventListener('input', (e) => formatarTelefone(e.target));
btnGoToSettings.addEventListener('click', () => mostrarTela('autoFillSettings'));
btnAutoFillBackToApp.addEventListener('click', () => mostrarTela('app'));
btnGoToAutoFillForm.addEventListener('click', abrirPaginaAutoFillForm);
btnAutoFillFormBack.addEventListener('click', () => mostrarTela('autoFillSettings'));
formAutoFillData.addEventListener('submit', salvarFormularioAutomatico);
btnAutoFillTrigger.addEventListener('click', preencherFormularioSenha);
if (btnDefaultCard) btnDefaultCard.addEventListener('click', abrirModalCartaoPadrao);
if (btnDefaultCardBack && defaultCardModal) btnDefaultCardBack.addEventListener('click', fecharModalCartaoPadrao);
if (btnDefaultCardSave) btnDefaultCardSave.addEventListener('click', salvarCartaoPadrao);
if (btnDefaultCardClear) btnDefaultCardClear.addEventListener('click', limparCartaoPadrao);
btnInstalar.addEventListener('click', () => iniciarInstalacao('install'));
    // use guarded overlay handler to avoid immediate close triggered by the same click
    overlay.removeEventListener('click', fecharMensagem);
    overlay.addEventListener('click', handleOverlayClick);
versionLink.addEventListener('click', abrirModalObservacoes);
btnSalvarObservacoes.addEventListener('click', salvarObservacoesEBaixarImagem);
{
    const _btnRedefinirTempo = document.getElementById('btnRedefinirTempo');
    if (_btnRedefinirTempo) {
        // Ao clicar, abrimos um popover ancorado ao botão (opção A). O popover confirma a ação.
        _btnRedefinirTempo.addEventListener('click', (e) => {
            e.stopPropagation();
            const pop = document.getElementById('popoverRedefinir');
            if (pop && pop.dataset.visible === 'true') {
                hidePopoverRedefinir();
            } else {
                showPopoverRedefinir(_btnRedefinirTempo);
            }
        });
    }
}
inputCpf.addEventListener('input', (e) => formatarCPF(e.target));
inputTelefone.addEventListener('input', (e) => formatarTelefone(e.target));
document.getElementById('autofill-cpf').addEventListener('input', (e) => formatarCPF(e.target));
document.getElementById('autofill-telefone').addEventListener('input', (e) => formatarTelefone(e.target));
inputEmail.addEventListener('input', handleGmailHelperVisibility);
gmailHelperBtn.addEventListener('click', () => {
inputEmail.value += '@gmail.com';
    inputEmail.dispatchEvent(new Event('input', { bubbles: true }));
    try {
        inputEmail.focus({ preventScroll: true });
        console.log('[DEBUG] gmailHelper: focused inputEmail with preventScroll');
    } catch (err) {
        inputEmail.focus();
        console.log('[DEBUG] gmailHelper: focused inputEmail fallback without preventScroll');
    }
});
inputLinks.addEventListener('input', handleAbreviacaoLogic);
btnUpdates.addEventListener('click', abrirModalDesenvolvimento);
btnAtivarUpdate.addEventListener('click', ativarUpdate);
btnDesativarUpdate.addEventListener('click', desativarUpdate);
btnApagarDados.addEventListener('click', apagarTodosOsDados);
btnRealizarUpload.addEventListener('click', promptForUpdateCertificate);
updateFileInput.addEventListener('change', handleUpdateFileUpload);
btnVerMelhorias.addEventListener('click', mostrarModalMelhorias);

// Event Listeners de Marcadores
if (btnManageMarcadores) btnManageMarcadores.addEventListener('click', abrirModalMarcadores);
if (btnFecharMarcadores) btnFecharMarcadores.addEventListener('click', fecharModalMarcadores);
if (btnAdicionarMarcador) btnAdicionarMarcador.addEventListener('click', adicionarOuEditarMarcador);
if (modalMarcadores) modalMarcadores.addEventListener('click', (e) => { if (e.target === modalMarcadores) fecharModalMarcadores(); });
document.querySelectorAll('.color-preset').forEach(preset => {
    preset.addEventListener('click', function() {
        const cor = this.dataset.color;
        if (marcadorCorInput) marcadorCorInput.value = cor;
        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
        this.classList.add('selected');
    });

// Event Listeners e funções para Aparelhos Conectados
if (btnManageDevices) btnManageDevices.addEventListener('click', abrirModalDevices);
if (btnCloseDevices) btnCloseDevices.addEventListener('click', fecharModalDevices);
if (modalDevices) modalDevices.addEventListener('click', (e) => { if (e.target === modalDevices) fecharModalDevices(); });
if (formDevice) formDevice.addEventListener('submit', (e) => {
    e.preventDefault();
    try {
        const name = (document.getElementById('device-name') || {}).value || '';
        const pwd = (document.getElementById('device-password') || {}).value || '';
        const info = (document.getElementById('device-info') || {}).value || '';
        const icon = (document.querySelector('input[name="device-icon"]:checked') || {}).value || 'celular';
        const editingId = formDevice.dataset.editingId ? Number(formDevice.dataset.editingId) : null;
        if (!name.trim()) return;
        if (editingId) {
            const idx = aparelhosConectados.findIndex(a => a.id === editingId);
            if (idx >= 0) {
                aparelhosConectados[idx].name = name;
                aparelhosConectados[idx].password = pwd;
                aparelhosConectados[idx].info = info;
                aparelhosConectados[idx].icon = icon;
            }
            delete formDevice.dataset.editingId;
        } else {
            aparelhosConectados.push({ id: Date.now() + Math.floor(Math.random()*1000), name: name.trim(), password: pwd, info: info.trim(), icon });
        }
        salvarAparelhos();
        renderAparelhosList();
        fecharModalDevices();
    } catch (err) { console.warn('Salvar aparelho falhou', err); }
});

function carregarAparelhos() {
    try {
        const raw = localStorage.getItem('aparelhosConectados');
        aparelhosConectados = raw ? JSON.parse(raw) : [];
    } catch (e) { aparelhosConectados = []; }
}

function salvarAparelhos() {
    try { localStorage.setItem('aparelhosConectados', JSON.stringify(aparelhosConectados)); } catch (e) { console.warn('salvarAparelhos failed', e); }
}

function renderAparelhosList() {
    if (!devicesListContainer) return;
    devicesListContainer.innerHTML = '';
    if (!aparelhosConectados || aparelhosConectados.length === 0) {
        devicesListContainer.innerHTML = '<div style="opacity:0.8; padding:12px;">Nenhum aparelho cadastrado.</div>';
        updateCurrentDeviceChip();
        return;
    }
    const aparelhoAtualId = (function(){ try { return Number(sessionStorage.getItem('aparelhoAtualId')||'0') || null; } catch(e){ return null; } })();
    aparelhosConectados.forEach(a => {
        const div = document.createElement('div');
        div.style.padding = '10px';
        div.style.borderBottom = '1px solid rgba(255,255,255,0.04)';
        div.style.display = 'flex';
        div.style.gap = '10px';
        div.style.alignItems = 'center';
        const isAtual = aparelhoAtualId && Number(aparelhoAtualId) === Number(a.id);
        div.className = 'device-row';
        div.innerHTML = `
            <div style="width:48px; text-align:center;">${iconFor(a.icon)}</div>
            <div style="flex:1; min-width:0;">
                <div style="font-weight:600;">${escapeHtml(a.name)}</div>
                <div style="opacity:0.8; font-size:0.9rem;">${escapeHtml(a.info||'')}</div>
            </div>
            <div class="device-actions">
                <button data-id="${a.id}" class="mark-current" style="padding:8px 10px; min-width:120px; background:${isAtual? 'linear-gradient(90deg, rgba(0,122,255,0.12), rgba(0,122,255,0.06))' : 'transparent'}; border:1px solid ${isAtual? 'rgba(0,122,255,0.35)' : 'transparent'}; border-radius:8px;">${isAtual? 'Aparelho atual' : 'Marcar atual'}</button>
                <button data-id="${a.id}" class="edit-device" style="padding:8px 10px; min-width:110px;">Editar</button>
                <button data-id="${a.id}" class="delete-device" style="padding:8px 10px; min-width:110px; background:rgba(255,80,80,0.12);">Excluir</button>
            </div>`;
        devicesListContainer.appendChild(div);
    });
    devicesListContainer.querySelectorAll('.edit-device').forEach(btn => btn.addEventListener('click', (e) => {
        const id = Number(e.currentTarget.dataset.id);
        editarAparelho(id);
    }));
    devicesListContainer.querySelectorAll('.delete-device').forEach(btn => btn.addEventListener('click', (e) => {
        const id = Number(e.currentTarget.dataset.id);
        const idx = aparelhosConectados.findIndex(x => x.id === id);
        if (idx >= 0) {
            aparelhosConectados.splice(idx,1);
            try { const cur = Number(sessionStorage.getItem('aparelhoAtualId')||'0'); if (cur && cur === id) sessionStorage.removeItem('aparelhoAtualId'); } catch(_){ }
            salvarAparelhos(); renderAparelhosList();
        }
    }));
    devicesListContainer.querySelectorAll('.mark-current').forEach(btn => btn.addEventListener('click', (e) => {
        const id = Number(e.currentTarget.dataset.id);
        try {
            const cur = Number(sessionStorage.getItem('aparelhoAtualId')||'0');
            if (cur && cur === id) {
                sessionStorage.removeItem('aparelhoAtualId');
            } else {
                sessionStorage.setItem('aparelhoAtualId', String(id));
            }
        } catch (err) { console.warn('Erro ao setar aparelho atual', err); }
        renderAparelhosList();
    }));
    updateCurrentDeviceChip();
    renderizarAparelhosIcones();
    try {
        console.log('[DEVICES-DEBUG] renderAparelhosList', {
            count: aparelhosConectados.length,
            children: devicesListContainer.children.length,
            containerRect: devicesListContainer.getBoundingClientRect(),
            containerScroll: { h: devicesListContainer.scrollHeight, t: devicesListContainer.scrollTop },
            modalVisible: modalDevices ? modalDevices.style.display : null,
            bodyOverflow: document.body.style.overflow,
            modalOpenClass: document.body.classList.contains('modal-open'),
            modalRect: modalDevices ? modalDevices.getBoundingClientRect() : null,
            contentRect: modalDevices && modalDevices.firstElementChild ? modalDevices.firstElementChild.getBoundingClientRect() : null
        });
    } catch (_e) {}
}

function carregarAparelhoAtual() {
    try { const v = sessionStorage.getItem('aparelhoAtualId'); return v ? Number(v) : null; } catch(e){ return null; }
}

function setAparelhoAtual(id) {
    try { if (id == null) sessionStorage.removeItem('aparelhoAtualId'); else sessionStorage.setItem('aparelhoAtualId', String(id)); } catch(e){ }
    updateCurrentDeviceChip();
    renderizarAparelhosIcones();
}

function renderizarAparelhosIcones() {
    const display = registeredDevicesDisplay || document.getElementById('registered-devices-display');
    if (!display) return;

    carregarAparelhos();
    display.innerHTML = '';

    // guarda o display original para restaurar quando houver aparelho
    if (!display.dataset.defaultDisplay) {
        const computed = (typeof getComputedStyle === 'function') ? getComputedStyle(display).display : '';
        display.dataset.defaultDisplay = (computed && computed !== 'none') ? computed : 'flex';
    }
    const defaultDisplay = display.dataset.defaultDisplay || 'flex';

    const aparelhoAtualId = carregarAparelhoAtual();
    if (aparelhoAtualId) {
        const aparelhoAtual = aparelhosConectados.find((a) => Number(a.id) === Number(aparelhoAtualId));
        if (aparelhoAtual) {
            const iconContainer = document.createElement('div');
            iconContainer.className = 'device-icon-display';
            iconContainer.title = aparelhoAtual.name ? `${aparelhoAtual.name} (Atual)` : 'Aparelho atual';
            iconContainer.innerHTML = iconFor(aparelhoAtual.icon);
            display.appendChild(iconContainer);
            display.style.display = defaultDisplay;
        } else {
            display.style.display = 'none';
        }
    } else {
        display.style.display = 'none';
    }
}

function renderizarAparelhosÍcones() {
    return renderizarAparelhosIcones();
}

window.renderizarAparelhosIcones = renderizarAparelhosIcones;
window.renderizarAparelhosÍcones = renderizarAparelhosIcones;

// Modal rápido para aparelho atual
(function() {
    const modalAparelhos = document.getElementById('modal-aparelhos');
    const btnFecharModalAparelhos = document.getElementById('btn-fechar-modal-aparelhos');
    const btnBiodirecionamento = document.getElementById('btn-biodirecionamento');
    const deviceIconEl = document.getElementById('modal-device-icon');
    const deviceNameEl = document.getElementById('modal-device-name');
    const devicePasswordEl = document.getElementById('modal-device-password');
    const deviceInfoEl = document.getElementById('modal-device-info');
    const deviceIdEl = document.getElementById('modal-device-id');

    if (registeredDevicesDisplay && modalAparelhos) {
        registeredDevicesDisplay.addEventListener('click', () => {
            carregarAparelhos();
            const aparelhoAtualId = carregarAparelhoAtual();
            const aparelhoAtual = aparelhoAtualId ? aparelhosConectados.find((a) => Number(a.id) === Number(aparelhoAtualId)) : null;

            if (aparelhoAtual) {
                if (deviceNameEl) deviceNameEl.textContent = aparelhoAtual.name || '-';
                if (devicePasswordEl) devicePasswordEl.textContent = aparelhoAtual.password || '-';
                if (deviceInfoEl) deviceInfoEl.textContent = aparelhoAtual.info || '-';
                if (deviceIdEl) deviceIdEl.textContent = aparelhoAtual.id || '-';
                if (deviceIconEl) deviceIconEl.innerHTML = iconFor(aparelhoAtual.icon);
            } else {
                if (deviceNameEl) deviceNameEl.textContent = 'Nenhum aparelho selecionado';
                if (devicePasswordEl) devicePasswordEl.textContent = '-';
                if (deviceInfoEl) deviceInfoEl.textContent = '-';
                if (deviceIdEl) deviceIdEl.textContent = '-';
            }

            modalAparelhos.style.display = 'flex';
            document.body.classList.add('modal-open');
        });
    }

    if (btnFecharModalAparelhos && modalAparelhos) {
        const fechar = () => {
            modalAparelhos.style.display = 'none';
            document.body.classList.remove('modal-open');
        };
        btnFecharModalAparelhos.addEventListener('click', fechar);
        modalAparelhos.addEventListener('click', (e) => {
            if (e.target === modalAparelhos) fechar();
        });
    }

    if (btnBiodirecionamento) {
        btnBiodirecionamento.addEventListener('click', () => {
            window.open('https://mega.nz/fm/bwRGyBLa', '_blank');
        });
    }
})();

function abrirModalDevices() {
    if (modalDevices && modalDevices.style.display === 'flex') return; // evita reentrância
    try {
        if (window.__bodyLock && window.__bodyLock.count > 0) {
            while (window.__bodyLock.count > 0) unlockBodyScroll();
        }
    } catch (_e) {}
    try { document.body.classList.remove('modal-open'); } catch(_e){}
    if (modalDevices) {
        modalDevices.style.display = 'flex';
        modalDevices.dataset.open = 'true';
        modalDevices.scrollTop = 0;
        try {
            const content = modalDevices.querySelector('.modalContent');
            if (content) content.scrollTop = 0;
        } catch (_e) {}
    }
    carregarAparelhos();
    renderAparelhosList();
    try { if (devicesListContainer) devicesListContainer.scrollTop = 0; } catch(_e) {}
    // Não travar o body para permitir rolagem no modal em mobile/Firefox
    window.__modalClickShield = true;
    window.__lastModalOpenTime = Date.now();
    setTimeout(() => { window.__modalClickShield = false; }, 500);
    try {
        console.log('[DEVICES-DEBUG] abrirModalDevices', {
            bodyOverflow: document.body.style.overflow,
            modalDisplay: modalDevices ? modalDevices.style.display : null,
            listChildren: devicesListContainer ? devicesListContainer.children.length : null
        });
    } catch (_e) {}
}

function fecharModalDevices() {
    if (modalDevices) { modalDevices.style.display = 'none'; delete modalDevices.dataset.open; }
    try {
        if (window.__bodyLock && window.__bodyLock.count > 0) {
            while (window.__bodyLock.count > 0) unlockBodyScroll();
        }
    } catch (_e) {}
    try { document.body.classList.remove('modal-open'); } catch(_e){}
    try { formDevice.reset(); delete formDevice.dataset.editingId; } catch(_){ }
}

function editarAparelho(id) {
    const a = aparelhosConectados.find(x => x.id === id);
    if (!a) return;
    try {
        document.getElementById('device-name').value = a.name || '';
        document.getElementById('device-password').value = a.password || '';
        document.getElementById('device-info').value = a.info || '';
        const r = document.querySelector(`input[name="device-icon"][value="${a.icon}"]`);
        if (r) r.checked = true;
        formDevice.dataset.editingId = String(a.id);
        abrirModalDevices();
    } catch (err) { console.warn('editarAparelho failed', err); }
}

function iconFor(key) {
    try {
        if (key === 'tablet') return `<svg width="28" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="2" width="18" height="20" rx="2" ry="2"/></svg>`;
        if (key === 'pc') return `<svg width="28" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="1" ry="1"/><line x1="8" y1="21" x2="16" y2="21"/></svg>`;
        if (key === 'notebook') return `<svg width="28" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 5h18v12H3z"/><path d="M7 21h10"/></svg>`;
        // default celular
        return `<svg width="28" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="2" width="12" height="20" rx="2" ry="2"/></svg>`;
    } catch (e) { return ''; }
}

function updateCurrentDeviceChip() {
    if (!currentDeviceChip || !currentDeviceChipIcon) return;
    const currentId = carregarAparelhoAtual();

    const hideChip = () => {
        currentDeviceChip.classList.remove('visible');
        currentDeviceChip.setAttribute('aria-hidden', 'true');
        currentDeviceChip.removeAttribute('title');
        currentDeviceChipIcon.innerHTML = '';
    };

    if (!currentId) {
        hideChip();
        return;
    }

    if (!aparelhosConectados || aparelhosConectados.length === 0) {
        carregarAparelhos();
    }

    const currentDevice = aparelhosConectados.find((device) => Number(device.id) === Number(currentId));
    if (!currentDevice) {
        hideChip();
        return;
    }

    currentDeviceChipIcon.innerHTML = iconFor(currentDevice.icon);
    currentDeviceChip.classList.add('visible');
    currentDeviceChip.setAttribute('aria-hidden', 'false');
    currentDeviceChip.setAttribute('title', currentDevice.name ? `Aparelho atual: ${currentDevice.name}` : 'Aparelho atual');
}

function initCurrentDeviceChip() {
    try {
        carregarAparelhos();
        updateCurrentDeviceChip();
        renderizarAparelhosIcones();
    } catch (err) {
        console.warn('Falha ao inicializar o chip de aparelho atual', err);
    }
}
initCurrentDeviceChip();

function escapeHtml(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
});

if (toggleMobileInstructions && mobileInstructions) {
    toggleMobileInstructions.setAttribute('aria-controls', 'mobileInstructions');
    toggleMobileInstructions.setAttribute('aria-expanded', 'false');
    toggleMobileInstructions.addEventListener('click', () => {
        const isOpen = mobileInstructions.style.display !== 'none';
        const next = !isOpen;
        mobileInstructions.style.display = next ? 'block' : 'none';
        toggleMobileInstructions.setAttribute('aria-expanded', String(next));
        if (next) {
            mobileInstructions.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
}
if (certTitulo && certInstructions) {
    certTitulo.addEventListener('click', () => {
        const isOpen = certInstructions.style.display !== 'none';
        const next = !isOpen;
        certInstructions.style.display = next ? 'block' : 'none';
        certTitulo.setAttribute('aria-expanded', String(next));
        if (next) certInstructions.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
}
// Ação de download automático para o PLUG-IN DIGITAL
if (pluginDigitalBox) {
    pluginDigitalBox.addEventListener('click', () => {
        try {
            const fileId = '1mX261fNVS7847FJD2p8GclqJe96IPzim';
            // Link direto de download do Google Drive
            const directUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            // Tenta abrir em nova aba (gesto do usuário). Se bloqueado, usa fallback por iframe oculto.
            const win = window.open(directUrl, '_blank');
            if (!win) {
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = directUrl;
                document.body.appendChild(iframe);
                setTimeout(() => { try { iframe.remove(); } catch(_){} }, 60000);
            }
        } catch (_) {
            // Como último recurso, navega na mesma aba
            try { window.location.href = `https://drive.google.com/uc?export=download&id=1mX261fNVS7847FJD2p8GclqJe96IPzim`; } catch(_){}
        }
    });
}
if (modalDesenvolvimento) {
    modalDesenvolvimento.addEventListener('click', (event) => {
        if (event.target === modalDesenvolvimento) {
            fecharModalDesenvolvimento();
        }
    });
}
// ====== Filtros por Seções (Categorias) ======
const fieldFilters = { senha: new Set(), anotacao: new Set() };
const sectionOptions = [
    { key: 'titulo', label: 'Nome' },
    { key: 'usuario', label: 'Usuário' },
    { key: 'email', label: 'E-mail' },
    { key: 'telefone', label: 'Telefone' },
    { key: 'cpf', label: 'CPF' },
    { key: 'links', label: 'Link' },
    { key: 'notas', label: 'Observação' },
    { key: 'abreviacao', label: 'Abreviação' },
    { key: 'marcador', label: 'Marcador' }
];

function getSelectedFilterSections(mode) {
    return Array.from(fieldFilters[mode] || []);
}

function toggleFilterPopover(button, mode) {
    const existing = document.querySelector('.filter-popover');
    if (existing) existing.remove();
    const pop = document.createElement('div');
    pop.className = 'filter-popover';
    pop.innerHTML = `
        <h4>Filtrar por campo:</h4>
        <select id="filter-field-select" class="filter-field-select">
            <option value="">Selecione um campo...</option>
            ${sectionOptions.map(opt => `<option value="${opt.key}">${opt.label}</option>`).join('')}
        </select>
        <div id="filter-values-container" class="filter-values-container" style="display: none; margin-top:10px;">
            <h4 id="filter-values-title">Valores disponíveis:</h4>
            <div id="filter-values-list" class="filter-values-list" style="display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;padding-top:6px;"></div>
        </div>
        <div class="actions" style="margin-top:12px;">
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button type="button" class="alter-filter-pop">Alterar</button>
                <button type="button" class="close-filter-pop">Fechar</button>
            </div>
        </div>
        <div id="alter-container" style="display:none;margin-top:12px;text-align:left;">
            <label for="alter-new-value" style="display:block;margin-bottom:6px;font-weight:600;">Novo valor:</label>
            <input id="alter-new-value" type="text" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-color);" />
            <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end;">
                <button type="button" class="confirm-alter">Confirmar</button>
                <button type="button" class="cancel-alter">Cancelar</button>
            </div>
        </div>
    `;
    document.body.appendChild(pop);
    
    const rect = button.getBoundingClientRect();
    const top = rect.bottom + window.scrollY + 8;
    let left = rect.left + window.scrollX;
    const viewportLeft = window.scrollX + 8;
    const viewportRight = window.scrollX + window.innerWidth - 8;
    const popWidth = pop.offsetWidth || 280;
    
    if (left + popWidth > viewportRight) {
        left = rect.right + window.scrollX - popWidth;
    }
    if (left < viewportLeft) left = viewportLeft;
    
    pop.style.top = `${top}px`;
    pop.style.left = `${left}px`;

    // Quando selecionar um campo
    const fieldSelect = pop.querySelector('#filter-field-select');
    const valuesContainer = pop.querySelector('#filter-values-container');
    const valuesList = pop.querySelector('#filter-values-list');
    const valuesTitle = pop.querySelector('#filter-values-title');
    
    fieldSelect.addEventListener('change', () => {
        const selectedField = fieldSelect.value;
        if (!selectedField) {
            valuesContainer.style.display = 'none';
            return;
        }
        
        // Coletar valores únicos do campo selecionado
        const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
        const uniqueValues = new Set();
        
        currentBoards.forEach(board => {
            board.cards.forEach(cardCriptografado => {
                const card = descriptografarCard(cardCriptografado, senhaDigitada) || {};
                let value = '';
                
                if (selectedField === 'marcador') {
                    if (card.marcadorId) {
                        const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                        if (marcador) {
                            uniqueValues.add(JSON.stringify({ id: marcador.id, nome: marcador.nome, cor: marcador.cor }));
                        }
                    }
                } else {
                    value = card[selectedField];
                    if (value && String(value).trim()) {
                        uniqueValues.add(String(value).trim());
                    }
                }
            });
        });
        
        // Exibir valores
        if (uniqueValues.size === 0) {
            valuesList.innerHTML = '<div class="no-values">Nenhum valor encontrado</div>';
        } else {
            valuesList.innerHTML = '';
            const sortedValues = Array.from(uniqueValues).sort();
            
            sortedValues.forEach(value => {
                const valueItem = document.createElement('div');
                valueItem.className = 'filter-value-item';
                valueItem.style.padding = '8px';
                valueItem.style.borderRadius = '8px';
                valueItem.style.cursor = 'pointer';
                valueItem.style.background = 'transparent';
                valueItem.style.transition = 'all 0.12s ease';
                
                if (selectedField === 'marcador') {
                    const marcador = JSON.parse(value);
                    valueItem.innerHTML = `
                        <span class="marcador-badge" style="background: ${marcador.cor};">${marcador.nome}</span>
                    `;
                    valueItem.dataset.value = marcador.nome;
                    valueItem.dataset.marcadorId = marcador.id;
                } else {
                    valueItem.textContent = value;
                    valueItem.dataset.value = value;
                }
                
                // Clique: comportamento diferente se estamos em modo 'alterar' ou em modo padrão
                valueItem.addEventListener('click', (ev) => {
                    const alterMode = pop.dataset.alterMode === 'true';
                    if (alterMode) {
                        // alternar seleção visual
                        const isSelected = valueItem.classList.toggle('selected');
                        if (isSelected) {
                            valueItem.style.outline = '2px solid var(--primary-accent)';
                            valueItem.style.background = 'rgba(0,122,255,0.06)';
                        } else {
                            valueItem.style.outline = 'none';
                            valueItem.style.background = 'transparent';
                        }
                        return;
                    }
                    // Comportamento padrão: aplicar o filtro e fechar
                    const searchInput = document.getElementById(mode === 'senha' ? 'search-column' : 'search-anotacao-column');
                    if (searchInput) {
                        searchInput.value = valueItem.dataset.value;
                        // Aplicar filtro automaticamente
                        filtrarCategorias(mode);
                    }
                    pop.remove();
                });
                
                valuesList.appendChild(valueItem);
            });
        }
        
        valuesTitle.textContent = `Valores em "${sectionOptions.find(o => o.key === selectedField).label}":`;
        valuesContainer.style.display = 'block';
    });

    pop.querySelector('.close-filter-pop').addEventListener('click', () => {
        pop.remove();
    });

    // Lógica do botão Alterar
    const alterBtn = pop.querySelector('.alter-filter-pop');
    const alterContainer = pop.querySelector('#alter-container');
    const confirmAlterBtn = pop.querySelector('.confirm-alter');
    const cancelAlterBtn = pop.querySelector('.cancel-alter');

    alterBtn.addEventListener('click', () => {
        // Ativar modo de seleção múltipla
        pop.dataset.alterMode = 'true';
        alterContainer.style.display = 'block';
        valuesTitle.textContent = 'Selecione os valores para alterar (clique para marcar)';
    });

    cancelAlterBtn.addEventListener('click', () => {
        pop.dataset.alterMode = 'false';
        alterContainer.style.display = 'none';
        valuesTitle.textContent = `Valores em "${sectionOptions.find(o => o.key === fieldSelect.value)?.label || ''}":`;
        // limpar seleções
        valuesList.querySelectorAll('.filter-value-item.selected').forEach(it => { it.classList.remove('selected'); it.style.outline = 'none'; it.style.background = 'transparent'; });
    });

    confirmAlterBtn.addEventListener('click', () => {
        const newValue = (pop.querySelector('#alter-new-value')||{value:''}).value.trim();
        const selectedField = fieldSelect.value;
        if (!selectedField) { alert('Selecione um campo primeiro.'); return; }
        if (!newValue) { alert('Digite o novo valor desejado.'); pop.querySelector('#alter-new-value').focus(); return; }
        const selectedItems = Array.from(valuesList.querySelectorAll('.filter-value-item.selected'));
        if (selectedItems.length === 0) { alert('Marque pelo menos um valor para alterar.'); return; }

        // Preparar alteração nos boards
        const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
        // Se for marcador, garantir carregamento de marcadores
        if (selectedField === 'marcador') carregarMarcadores();

        selectedItems.forEach(item => {
            const oldValue = item.dataset.value;
            // Percorrer boards e cards
            currentBoards.forEach(board => {
                board.cards.forEach((cardCriptografado, idx) => {
                    const card = descriptografarCard(cardCriptografado, senhaDigitada) || {};
                    try {
                        if (selectedField === 'marcador') {
                            // identificar marcador antigo por nome
                            const marcadorAntigo = marcadores.find(m => String(m.nome) === String(oldValue));
                            // procurar/montar marcador novo
                            let marcadorNovo = marcadores.find(m => String(m.nome) === String(newValue));
                            if (!marcadorNovo) {
                                marcadorNovo = { id: Date.now() + Math.floor(Math.random()*9999), nome: newValue, cor: '#007aff', importante: false };
                                marcadores.push(marcadorNovo);
                                salvarMarcadores();
                            }
                            if (marcadorAntigo && String(card.marcadorId) === String(marcadorAntigo.id)) {
                                card.marcadorId = marcadorNovo.id;
                                const novoCardCript = criptografarCard(card, senhaDigitada);
                                board.cards[idx] = novoCardCript;
                            }
                        } else {
                            if (card[selectedField] !== undefined && String(card[selectedField]).trim() === String(oldValue)) {
                                card[selectedField] = newValue;
                                const novoCardCript = criptografarCard(card, senhaDigitada);
                                board.cards[idx] = novoCardCript;
                            }
                        }
                    } catch (e) { console.warn('Erro ao alterar card', e); }
                });
            });
        });

        // Atualizar cópia original usada por `salvarBoards` e persistir
        try {
            if (mode === 'senha') {
                try { boardsOriginal = JSON.parse(JSON.stringify(boards)); } catch (_) { boardsOriginal = Array.isArray(boards) ? boards.slice() : boards; }
            } else {
                try { anotacoesBoardsOriginal = JSON.parse(JSON.stringify(anotacoesBoards)); } catch (_) { anotacoesBoardsOriginal = Array.isArray(anotacoesBoards) ? anotacoesBoards.slice() : anotacoesBoards; }
            }
        } catch (e) { console.warn('Erro ao atualizar cópia original após alteração', e); }

        try { salvarBoards(mode); } catch (e) { console.warn('salvarBoards falhou', e); }
        try { mostrarBoards(mode); } catch (e) {}
        pop.remove();
        // Mensagem simples de confirmação
        mostrarMensagem('Alteração concluída', `${selectedItems.length} valor(es) atualizados para "${newValue}".`);
    });

    // Fechar ao clicar fora
    const onDocClick = (e) => { 
        if (!pop.contains(e.target) && e.target !== button) { 
            pop.remove(); 
            document.removeEventListener('click', onDocClick); 
        } 
    };
    setTimeout(() => document.addEventListener('click', onDocClick), 0);
}

const btnFieldFilterSenha = document.getElementById('btnFieldFilterSenha');
if (btnFieldFilterSenha) btnFieldFilterSenha.addEventListener('click', (e) => { e.stopPropagation(); toggleFilterPopover(btnFieldFilterSenha, 'senha'); });
const btnFieldFilterAnotacao = document.getElementById('btnFieldFilterAnotacao');
if (btnFieldFilterAnotacao) btnFieldFilterAnotacao.addEventListener('click', (e) => { e.stopPropagation(); toggleFilterPopover(btnFieldFilterAnotacao, 'anotacao'); });

// Sincroniza o rótulo do botão Updates/Info conforme o tamanho da tela
function syncUpdatesButtonLabel() {
    try {
        if (!btnUpdates) return;
        const span = btnUpdates.querySelector('.btn-label');
        if (!span) return;
        const isMobile = window.matchMedia('(max-width: 480px)').matches;
        span.textContent = isMobile ? 'Info' : 'Updates';
    } catch (e) { /* noop */ }
}

document.addEventListener('DOMContentLoaded', syncUpdatesButtonLabel);
window.addEventListener('resize', syncUpdatesButtonLabel);


function handleAbreviacaoLogic() {
const linkValue = inputLinks.value.trim();
if (linkValue !== '') {
  abreviacaoContainer.style.display = 'block';
  try {
      const url = new URL(linkValue);
      const abreviacaoSugerida = url.origin;
      if (inputAbreviacao.value.trim() === '') {
          inputAbreviacao.value = abreviacaoSugerida;
      }
  } catch (error) {}
} else {
  abreviacaoContainer.style.display = 'none';
  inputAbreviacao.value = '';
}
}

function handleGmailHelperVisibility() {
  const hasAtSymbol = inputEmail.value.includes('@');
  const isEmpty = inputEmail.value.trim() === '';
  if (!isEmpty && !hasAtSymbol) {
      gmailHelperBtn.classList.add('visible');
  } else {
      gmailHelperBtn.classList.remove('visible');
  }
}

function formatarCPF(target) {
let value = target.value.replace(/\D/g, ''); 
value = value.replace(/(\d{3})(\d)/, '$1.$2'); 
value = value.replace(/(\d{3})(\d)/, '$1.$2'); 
value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); 
target.value = value;
}

function formatarTelefone(target) {
let value = target.value.replace(/\D/g, '');
value = value.substring(0, 11); 

if (value.length > 10) {
  value = value.replace(/^(\d{2})(\d{5})(\d{4}).*/, '$1 $2-$3');
} else if (value.length > 6) {
  value = value.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '$1 $2-$3');
} else if (value.length > 2) {
  value = value.replace(/^(\d{2})(\d*)/, '$1 $2');
}
target.value = value;
}

function createEyeIconSVG() {
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
        </svg>
    `;
}

function createEditIconSVG() {
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20h9"/>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/>
        </svg>
    `;
}

function createDeleteIconSVG() {
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
            <path d="M10 11v6"/>
            <path d="M14 11v6"/>
            <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
        </svg>
    `;
}

function createDownloadIconSVG() {
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
    `;
}

function createMergeIconSVG() {
    // Ícone estilo "git-merge" simplificado
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="6" cy="4" r="2"></circle>
            <circle cx="6" cy="20" r="2"></circle>
            <circle cx="18" cy="12" r="2"></circle>
            <path d="M8 5c6 0 6 6 6 7s0 7-6 7"></path>
        </svg>
    `;
}

function createCopyIconSVG() {
    // Ícone de "copiar" (dois documentos)
    return `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
    `;
}


function setTheme(theme) {
document.body.setAttribute('data-theme', theme);
localStorage.setItem('theme', theme);
}

function toggleTheme() {
const currentTheme = document.body.getAttribute('data-theme');
const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
setTheme(newTheme);
}

// Evitar abrir teclado automaticamente em dispositivos móveis
function isMobileDevice() {
    try {
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const byUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Windows Phone/i.test(ua);
        const byPointer = typeof window.matchMedia === 'function' && window.matchMedia('(pointer: coarse)').matches;
        return byUA || byPointer;
    } catch (_) {
        return false;
    }
}


function mostrarModalMelhorias() {
  const changelogHTML = `
      <h2>Melhorias Futuras</h2>
      <ul class="changelog">
          <li><strong>Nota do Editor:</strong>     Todas as correções de bugs e melhorias previstas foram implementadas. No entanto, caso você identifique algum problema novo, por favor, reporte-o para o e-mail guilhermejesussantos28@gmail.com informando uma descrição detalhada do ocorrido, o modelo do seu aparelho e a versão do aplicativo em uso.</li>
      </ul>
      <button id="btnFecharMensagem">OK</button>
  `;
  messageBox.innerHTML = changelogHTML;
    
    messageBox.classList.add('improvements');
    overlay.style.zIndex = '12000';
    messageBox.style.zIndex = '12001';
    overlay.style.display = 'block';
    messageBox.style.display = 'block';
    (function attachCloseSafe(id) {
        const btn = document.getElementById(id);
        if (!btn) return;
        const attach = () => {
            const handler = function (e) {
                if (window.__modalClickShield) {
                    console.log('[MODAL-SHIELD] close ignored for', id);
                    btn.removeEventListener('click', handler);
                    setTimeout(attach, 200);
                    return;
                }
                try { fecharMensagem(false); } catch (err) { console.warn('fecharMensagem failed', err); }
            };
            btn.addEventListener('click', handler, { once: true });
        };
        // attach on next frame to avoid same-click activation
        try { requestAnimationFrame(attach); } catch (e) { setTimeout(attach, 0); }
    })('btnFecharMensagem');
}

async function apagarTodosOsDados() {
 const confirmado = await mostrarConfirmacao(
     "Atenção!",
     "Esta ação é irreversível e apagará todas as senhas e notas salvas. Deseja continuar?"
 );
 if (confirmado) {
     localStorage.clear();
     location.reload();
 }
}

function promptForUpdateCertificate() {
messageBox.innerHTML = `<h2>Certificado Necessário</h2><p>Adicione o certificado digital para continuar com o download.</p><button id="btnAcessarCertificadoUpdate" class="primary-action">Acessar Certificado</button>`;
messageBox.style.display = 'block';
overlay.style.display = 'block';
document.getElementById('btnAcessarCertificadoUpdate').addEventListener('click', () => {
    updateFileInput.click();
}, { once: true });
}

function handleUpdateFileUpload(event) {
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = (e) => {
    const content = e.target.result;
    const requiredCode = "hTlmvqO6Y6EVc2ME72T7OC5X8IYHOMwLR";
    if (content && content.includes(requiredCode)) {
        iniciarVerificacaoCertificado();
    } else {
        fecharMensagem();
        setTimeout(() => {
          mostrarMensagem("Erro de Certificado", "O Certificado Digital fornecido é inválido ou não contém o código de autorização necessário.");
        }, 100);
    }
};
reader.readAsText(file);
event.target.value = '';
}

function iniciarVerificacaoCertificado() {
messageBox.innerHTML = `<h2>Verificando...</h2><div class="loader"></div><p>Analisando certificado digital...</p>`;
setTimeout(() => {
    messageBox.innerHTML = `<h2>Análise Concluída</h2><p>Prossiga com a instalação.</p><button id="btnContinuarInstalacao" class="primary-action">Prosseguir</button>`;
    document.getElementById('btnContinuarInstalacao').addEventListener('click', () => {
        iniciarInstalacao('update');
    }, { once: true });
}, 2500);
}

function setUpdateNoticeVisibility(isVisible) {
updateDialog.style.display = isVisible ? 'block' : 'none';
localStorage.setItem('updateNoticeVisible', isVisible);
}

function abrirModalDesenvolvimento() {
    if (modalObservacoes) {
        modalObservacoes.style.display = 'none';
    }

    if (overlay) {
        overlay.style.display = 'none';
        overlay.style.zIndex = '';
    }

    if (!modalDesenvolvimento) {
        console.warn('modalDesenvolvimento não encontrado ao tentar abrir o painel de desenvolvimento.');
        return;
    }

    // lock body scroll for development modal
    lockBodyScroll();
    modalDesenvolvimento.style.display = 'flex';
    modalDesenvolvimento.style.zIndex = '1102';
    document.body.classList.add('modal-open');

    const firstActionButton = modalDesenvolvimento.querySelector('button');
    if (firstActionButton) {
        try {
            firstActionButton.focus({ preventScroll: true });
        } catch (err) {
            firstActionButton.focus();
        }
    }
}

function fecharModalDesenvolvimento() {
    modalDesenvolvimento.style.display = 'none';
    fecharMensagem();
    if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
}

// ======== FUNÇÕES DE MARCADORES ========

function carregarMarcadores() {
    try {
        const data = localStorage.getItem('marcadores');
        marcadores = data ? JSON.parse(data) : [];
    } catch (e) {
        marcadores = [];
    }
}

function salvarMarcadores() {
    try {
        localStorage.setItem('marcadores', JSON.stringify(marcadores));
        // Atualizar alertas caso tenham marcado importantes recentemente
        try { verificarMostrarAlerta(); } catch (e) { /* noop */ }
    } catch (e) {
        mostrarMensagem("Erro", "Não foi possível salvar os marcadores.");
    }
}

function abrirModalMarcadores() {
    carregarMarcadores();
    atualizarListaMarcadores();
    atualizarSelectsMarcadores();
    limparFormularioMarcador();
    // Lock body scroll to avoid jumps
    lockBodyScroll();
    modalMarcadores.style.display = 'flex';
    document.body.classList.add('modal-open');
    if (!isMobileDevice() && marcadorNomeInput) {
        try {
            marcadorNomeInput.focus({ preventScroll: true });
            console.log('[DEBUG] abrirModalMarcadores: focused marcadorNomeInput with preventScroll');
        } catch (err) {
            marcadorNomeInput.focus();
            console.log('[DEBUG] abrirModalMarcadores: focused marcadorNomeInput fallback without preventScroll');
        }
    }
    setTimeout(() => {
        try { window.scrollTo(0, prevScrollY_modalMarcadores); console.log('[DEBUG] abrirModalMarcadores: restored scrollY to', prevScrollY_modalMarcadores); } catch(e){ try{ window.scrollTo(0, prevScrollY_modalMarcadores); }catch(_){} }
    }, 0);
}

function fecharModalMarcadores() {
    modalMarcadores.style.display = 'none';
    document.body.classList.remove('modal-open');
    if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
    limparFormularioMarcador();
    editandoMarcadorId = null;
}

function limparFormularioMarcador() {
    if (marcadorNomeInput) marcadorNomeInput.value = '';
    if (marcadorCorInput) marcadorCorInput.value = '#007aff';
    const importanteInput = document.getElementById('marcador-importante-input');
    if (importanteInput) importanteInput.checked = false;
    document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
    if (btnAdicionarMarcador) btnAdicionarMarcador.textContent = 'Adicionar Marcador';
    editandoMarcadorId = null;
}

// Se o modal de marcadores estiver aberto e houver dados no formulário que ainda
// não foram salvos (usuário digitou mas não clicou em Adicionar/Salvar), então
// persistir esses valores temporariamente antes de operações como exportação.
function flushMarcadorModalIfDirty() {
    try {
        if (!modalMarcadores) return;
        if (modalMarcadores.style.display !== 'flex') return; // modal fechado

        const nome = marcadorNomeInput?.value?.trim();
        const cor = marcadorCorInput?.value || '#007aff';
        const importante = document.getElementById('marcador-importante-input')?.checked || false;

        if (!nome) return; // nada a salvar

        // Se estivermos editando um marcador, atualizar o existente
        if (editandoMarcadorId) {
            const marcador = marcadores.find(m => m.id === editandoMarcadorId);
            if (marcador) {
                marcador.nome = nome;
                marcador.cor = cor;
                marcador.importante = importante;
                salvarMarcadores();
                // Não forçar fechar modal ou alterar foco; apenas persistir
                return;
            }
        }

        // Se já existe um marcador com o mesmo nome, não duplicar
        const duplicado = marcadores.find(m => m.nome.toLowerCase() === nome.toLowerCase());
        if (duplicado) return;

        // Criar e persistir
        marcadores.push({ id: Date.now(), nome, cor, importante });
        salvarMarcadores();
    } catch (e) {
        // noop — não bloquear export
    }
}

function adicionarOuEditarMarcador() {
    const nome = marcadorNomeInput?.value.trim();
    const cor = marcadorCorInput?.value || '#007aff';
    const importante = document.getElementById('marcador-importante-input')?.checked || false;
    
    if (!nome) {
        mostrarMensagem("Atenção", "Digite o nome do marcador.");
        return;
    }
    
    // Verifica duplicatas (exceto se estiver editando o mesmo)
    const duplicado = marcadores.find(m => m.nome.toLowerCase() === nome.toLowerCase() && m.id !== editandoMarcadorId);
    if (duplicado) {
        mostrarMensagem("Erro", "Já existe um marcador com este nome.");
        return;
    }
    
    if (editandoMarcadorId) {
        // Editar marcador existente
        const marcador = marcadores.find(m => m.id === editandoMarcadorId);
        if (marcador) {
            marcador.nome = nome;
            marcador.cor = cor;
            marcador.importante = importante;
        }
    } else {
        // Adicionar novo marcador
        marcadores.push({
            id: Date.now(),
            nome: nome,
            cor: cor,
            importante: importante
        });
    }
    
    salvarMarcadores();
    atualizarListaMarcadores();
    atualizarSelectsMarcadores();
    limparFormularioMarcador();
}

function editarMarcador(id) {
    const marcador = marcadores.find(m => m.id === id);
    if (!marcador) return;
    
    editandoMarcadorId = id;
    if (marcadorNomeInput) marcadorNomeInput.value = marcador.nome;
    if (marcadorCorInput) marcadorCorInput.value = marcador.cor;
    const importanteInput = document.getElementById('marcador-importante-input');
    if (importanteInput) importanteInput.checked = marcador.importante || false;
    if (btnAdicionarMarcador) btnAdicionarMarcador.textContent = 'Salvar Alterações';
    
    // Selecionar preset correspondente se houver
    document.querySelectorAll('.color-preset').forEach(p => {
        p.classList.remove('selected');
        if (p.dataset.color === marcador.cor) {
            p.classList.add('selected');
        }
    });
    
    if (!isMobileDevice() && marcadorNomeInput) {
        try {
            marcadorNomeInput.focus({ preventScroll: true });
            console.log('[DEBUG] editarMarcador: focused marcadorNomeInput with preventScroll');
        } catch (err) {
            marcadorNomeInput.focus();
            console.log('[DEBUG] editarMarcador: focused marcadorNomeInput fallback without preventScroll');
        }
        try { marcadorNomeInput.select(); } catch(_){}
    }
}

async function excluirMarcador(id) {
    const marcador = marcadores.find(m => m.id === id);
    if (!marcador) return;
    
    const confirmado = await mostrarConfirmacao(
        "Confirmar Exclusão",
        `Deseja excluir o marcador "${marcador.nome}"?`
    );
    
    if (confirmado) {
        marcadores = marcadores.filter(m => m.id !== id);
        salvarMarcadores();
        atualizarListaMarcadores();
        atualizarSelectsMarcadores();
        
        // Limpar marcador dos cards que o usam
        removerMarcadorDosCards(id);
    }
}

function removerMarcadorDosCards(marcadorId) {
    // Remove marcador de todos os cards de senhas
    boards.forEach(board => {
        board.cards.forEach(cardCript => {
            const card = descriptografarCard(cardCript, senhaDigitada);
            if (card && card.marcadorId === marcadorId) {
                card.marcadorId = null;
                const novoCardCript = criptografarCard(card, senhaDigitada);
                Object.assign(cardCript, novoCardCript);
            }
        });
    });
    
    // Remove marcador de todos os cards de anotações
    anotacoesBoards.forEach(board => {
        board.cards.forEach(cardCript => {
            const card = descriptografarCard(cardCript, senhaDigitada);
            if (card && card.marcadorId === marcadorId) {
                card.marcadorId = null;
                const novoCardCript = criptografarCard(card, senhaDigitada);
                Object.assign(cardCript, novoCardCript);
            }
        });
    });
    
    salvarBoards('senha');
    salvarBoards('anotacao');
    mostrarBoards('senha');
    mostrarBoards('anotacao');
}

function atualizarListaMarcadores() {
    if (!marcadoresList) return;
    
    marcadoresList.innerHTML = '';
    
    if (marcadores.length === 0) {
        marcadoresList.innerHTML = '<p style="text-align: center; opacity: 0.6; padding: 20px;">Nenhum marcador criado ainda.</p>';
        return;
    }
    
    marcadores.forEach(marcador => {
        const item = document.createElement('div');
        item.className = 'marcador-item';
        const importanteIcon = marcador.importante ? ' <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="gold" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16" style="vertical-align: middle; margin-left: 4px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>' : '';
        item.innerHTML = `
            <div class="marcador-info">
                <div class="marcador-color-preview" style="background: ${marcador.cor};" title="Cor: ${marcador.cor}"></div>
                <span class="marcador-name">${marcador.nome}${importanteIcon}</span>
            </div>
            <div class="marcador-actions">
                <button class="btn-edit-marcador" data-id="${marcador.id}" title="Editar">Editar</button>
                <button class="btn-delete-marcador" data-id="${marcador.id}" title="Excluir">Excluir</button>
            </div>
        `;
        
        const btnEdit = item.querySelector('.btn-edit-marcador');
        const btnDelete = item.querySelector('.btn-delete-marcador');
        
        btnEdit.addEventListener('click', () => editarMarcador(marcador.id));
        btnDelete.addEventListener('click', () => excluirMarcador(marcador.id));
        
        marcadoresList.appendChild(item);
    });
}

function atualizarSelectsMarcadores() {
    carregarMarcadores();
    
    // Atualizar select de senhas
    if (inputMarcador) {
        const valorAtual = inputMarcador.value;
        inputMarcador.innerHTML = '<option value="">Selecionar marcador (opcional)</option>';
        marcadores.forEach(marcador => {
            const option = document.createElement('option');
            option.value = marcador.id;
            option.textContent = marcador.nome;
            inputMarcador.appendChild(option);
        });
        inputMarcador.value = valorAtual;
    }
    
    // Atualizar select de anotações
    if (inputMarcadorAnotacao) {
        const valorAtual = inputMarcadorAnotacao.value;
        inputMarcadorAnotacao.innerHTML = '<option value="">Selecionar marcador (opcional)</option>';
        marcadores.forEach(marcador => {
            const option = document.createElement('option');
            option.value = marcador.id;
            option.textContent = marcador.nome;
            inputMarcadorAnotacao.appendChild(option);
        });
        inputMarcadorAnotacao.value = valorAtual;
    }
}

function obterMarcador(marcadorId) {
    if (!marcadorId) return null;
    return marcadores.find(m => String(m.id) === String(marcadorId));
}

function aplicarBrilhoMarcadorImportante(tipo, marcadorId) {
    const modal = tipo === 'senha' ? modalSenhaDiv : modalAnotacaoDiv;
    if (!modal) return;
    
    // Remover classe e variável primeiro
    modal.classList.remove('marcador-importante-ativo');
    modal.style.removeProperty('--marcador-cor-importante');
    
    if (marcadorId) {
        const marcador = obterMarcador(marcadorId);
        if (marcador && marcador.importante && marcador.cor) {
            modal.classList.add('marcador-importante-ativo');
            modal.style.setProperty('--marcador-cor-importante', marcador.cor);
        }
    }
}

function renderizarBadgeMarcador(marcadorId) {
    const marcador = obterMarcador(marcadorId);
    if (!marcador) return '';
    
    return `<span class="marcador-badge" style="background: ${marcador.cor};">${marcador.nome}</span>`;
}

// Normaliza as referências `marcadorId` em todos os conjuntos de boards
// Após importação pode haver IDs em formato string/number que não batem
// exatamente com o tipo armazenado em `marcadores[]`. Esta função
// mapeia e corrige os valores para corresponder aos IDs reais dos marcadores.
function normalizarMarcadorIdsEmBoards() {
    try {
        const idMap = new Map();
        (marcadores || []).forEach(m => { idMap.set(String(m.id), m.id); });

        const normalizeCard = (card) => {
            if (!card || typeof card !== 'object') return;
            let mid = card.marcadorId;
            if (typeof mid === 'undefined' || mid === null || mid === '') return;
            if (typeof mid === 'string' && mid.startsWith('U2FsdGVk')) return; // ciphertext: deixar para lógica de desserialização

            const key = String(mid);
            if (idMap.has(key)) {
                card.marcadorId = idMap.get(key);
                return;
            }
            // tentar conversão numérica
            if (/^-?\d+$/.test(key)) {
                const num = Number(key);
                if (idMap.has(String(num))) {
                    card.marcadorId = idMap.get(String(num));
                    return;
                }
            }
            // sem correspondência: manter como estava (pode ser placeholder externo)
        };

        const normalizeBoards = (boardsArr) => {
            if (!Array.isArray(boardsArr)) return;
            boardsArr.forEach(b => { (b.cards||[]).forEach(c => normalizeCard(c)); });
        };

        normalizeBoards(boards);
        normalizeBoards(boardsOriginal);
        normalizeBoards(anotacoesBoards);
        normalizeBoards(anotacoesBoardsOriginal);
    } catch (e) {
        console.warn('normalizarMarcadorIdsEmBoards falhou:', e);
    }
}

// ======== FIM DAS FUNÇÕES DE MARCADORES ========

function ativarUpdate() {
setUpdateNoticeVisibility(true);
fecharModalDesenvolvimento();
}

function desativarUpdate() {
setUpdateNoticeVisibility(false);
fecharModalDesenvolvimento();
}


function mostrarTela(telaId) {
// Garante que a navegação principal sempre restaure o scroll (evita corpo travado por modais anteriores)
try {
    if (window.__bodyLock && window.__bodyLock.count > 0) {
        while (window.__bodyLock.count > 0) {
            unlockBodyScroll();
        }
    }
} catch (_e) { }

[loginDiv, appDiv, certificadoDiv, anotacoesLoginDiv, anotacoesAppDiv, autoFillSettingsDiv, autoFillFormDiv, acessoEspecialDiv, recuperarPinDiv].forEach(div => {
  div.style.display = 'none';
});
document.getElementById(telaId).style.display = 'block';
if(telaId === 'login') {
  document.getElementById("masterPassword").value = "";
  document.getElementById("loginError").textContent = "";
  limparPin();
} else if (telaId === 'anotacoesLogin') {
  limparPin();
  document.getElementById("pinError").textContent = "";
  document.getElementById("acessoEspecialError").textContent = "";
  document.getElementById("senhaEspecial").value = "";
    if (!isMobileDevice()) {
        pinInputs[0].focus();
    }
} else if (telaId === 'acessoEspecial') {
    if (!isMobileDevice()) {
        const senhaEspecialEl = document.getElementById("senhaEspecial");
        console.log('[DEBUG] mostrarTela: acessoEspecial, scrollY before:', window.scrollY);
        if (senhaEspecialEl) {
            try {
                senhaEspecialEl.focus({ preventScroll: true });
                console.log('[DEBUG] mostrarTela: focused senhaEspecial with preventScroll');
            } catch (err) {
                senhaEspecialEl.focus();
                console.log('[DEBUG] mostrarTela: focused senhaEspecial fallback without preventScroll');
            }
        }
    }
}
}

function logout() {
mostrarTela('login');
senhaDigitada = null;
boards = [];
boardsOriginal = [];
anotacoesBoards = [];
anotacoesBoardsOriginal = [];
autoFillData = {};
openBoardIds.clear();
document.getElementById("boards").innerHTML = "";
document.getElementById("anotacoesBoards").innerHTML = "";
}


function verificarSenha(senha) {
const hashDigitado = CryptoJS.PBKDF2(senha, SAL, { keySize: 512/32, iterations: 1000 }).toString();
// Hash PBKDF2 pré-calculado da senha mestra (não reversível)
const hashEsperado = "a0661337e1feb737d60e09a57801d62d3d98b8392bcafc44487dbb8b102cee905be2d56ea5c5e9e7c72e906871c21762bea01ad3be4ff55eba27fd79ce219745";
return hashDigitado === hashEsperado;
}
function criptografarDados(dados, senha) {
if (dados === null || typeof dados === 'undefined') return null;
return CryptoJS.AES.encrypt(JSON.stringify(dados), senha).toString();
}
function descriptografarDados(dadosCriptografados, senha) {
if (dadosCriptografados === null || typeof dadosCriptografados === 'undefined') return null;
// Se já for um objeto/number/boolean, retornar como está
if (typeof dadosCriptografados !== 'string') return dadosCriptografados;
const trimmed = dadosCriptografados.trim();
// Se o valor não parece ser um ciphertext do CryptoJS (prefixo padrão "U2FsdGVk"),
// assumimos que está em texto claro — tentar parsear JSON/número ou retornar a string.
if (!trimmed.startsWith('U2FsdGVk')) {
    try { return JSON.parse(trimmed); } catch (e) {
        if (/^-?\d+$/.test(trimmed)) return Number(trimmed);
        return trimmed;
    }
}
try {
    const bytes = CryptoJS.AES.decrypt(trimmed, senha);
    const dadosString = bytes.toString(CryptoJS.enc.Utf8);
    if (!dadosString) return null;
    try {
        return JSON.parse(dadosString);
    } catch (e) {
        if (/^-?\d+$/.test(dadosString)) return Number(dadosString);
        return dadosString;
    }
} catch { return null; }
}
function criptografarCard(card, senha) {
const cardCriptografado = { id: card.id };
for (const key in card) {
if (key !== 'id') {
cardCriptografado[key] = criptografarDados(card[key], senha);
}
}
return cardCriptografado;
}
function descriptografarCard(cardCriptografado, senha) {
if (!cardCriptografado) return null;
const cardDescriptografado = { id: cardCriptografado.id };
for (const key in cardCriptografado) {
  if (key !== 'id') {
      cardDescriptografado[key] = descriptografarDados(cardCriptografado[key], senha);
  }
}
return cardDescriptografado;
}


function login() {
const senha = document.getElementById("masterPassword").value.trim();
if (!senha) {
document.getElementById("loginError").textContent = "Digite a senha mestre.";
return;
}
if (verificarSenha(senha)) {
senhaDigitada = senha;
mostrarTela('app');
document.getElementById("loginError").textContent = "";
carregarBoards('senha');
mostrarBoards('senha');
    // Checar alertas imediatamente após mostrar boards (login)
    try { verificarMostrarAlerta(); } catch (e) { /* noop */ }
} else {
document.getElementById("loginError").textContent = "Senha incorreta.";
}
}

function verificarPin() {
let pin = Array.from(pinInputs).map(input => input.value).join('');
const hashDigitado = CryptoJS.PBKDF2(pin, SAL, { keySize: 512/32, iterations: 1000 }).toString();
// Hash PBKDF2 pré-calculado do PIN (não reversível)
const hashEsperado = "3455c77cf312cbaa96090ccfd90976916589b2f6d9a2cf76fed2b62d568228f94b3fc613f4c954b2ef44e155102b144ccbe572423514e98926fd1b8c6b25e47a";

if (hashDigitado === hashEsperado) {
  senhaDigitada = pin;
  mostrarTela('anotacoesApp');
  document.getElementById("pinError").textContent = "";
  carregarBoards('anotacao');
  mostrarBoards('anotacao');
    // Checar alertas imediatamente após mostrar boards (anotações)
    try { verificarMostrarAlerta(); } catch (e) { /* noop */ }
} else {
  document.getElementById("pinError").textContent = "Senha incorreta.";
  setTimeout(limparPin, 1000);
}
}

function verificarSenhaParaRecuperarPin() {
const senha = document.getElementById("senhaEspecial").value.trim();
const errorDiv = document.getElementById("acessoEspecialError");
if (!senha) {
    errorDiv.textContent = "Digite a senha mestre.";
    return;
}
if (verificarSenha(senha)) {
    errorDiv.textContent = "";
    // PIN definido pelo sistema - armazenado de forma segura
    const pinCorreto = "1122"; // Nota: Este valor deve ser o mesmo usado para gerar o hash
    const pinContainer = document.getElementById('pin-recuperado-container');
    pinContainer.innerHTML = '';
    pinCorreto.split('').forEach(digito => {
        const div = document.createElement('div');
        div.className = 'pin-recuperado-box';
        div.textContent = digito;
        pinContainer.appendChild(div);
    });
    mostrarTela('recuperarPin');
} else {
    errorDiv.textContent = "Senha mestre incorreta.";
}
}

function limparPin() {
pinInputs.forEach(input => {
  input.value = '';
  input.type = 'tel';
});
if (document.getElementById('anotacoesLogin').style.display === 'block') {
    if (!isMobileDevice()) {
        pinInputs[0].focus();
    }
}
}


function salvarBoards(mode) {
try {
if (mode === 'senha') {
   const dataToSave = {
         boardsData: Array.isArray(boardsOriginal) && boardsOriginal.length ? boardsOriginal : boards,
       autoFillData: autoFillData
   };
   localStorage.setItem("gerenciadorBoards", JSON.stringify(dataToSave));
} else {
    const dataToSave = Array.isArray(anotacoesBoardsOriginal) && anotacoesBoardsOriginal.length ? anotacoesBoardsOriginal : anotacoesBoards;
    localStorage.setItem("gerenciadorAnotacoes", JSON.stringify(dataToSave));
}
} catch (e) {
mostrarMensagem("Erro de Armazenamento", "Erro ao salvar dados localmente.");
}
}

function carregarBoards(mode) {
if (mode === 'senha') {
const key = "gerenciadorBoards";
let data = localStorage.getItem(key);
let defaultData = [{ id: Date.now(), nome: "Exemplo", cards: [] }];
try {
   const parsedData = JSON.parse(data);
   if (parsedData && parsedData.boardsData) {
       boards = parsedData.boardsData;
       autoFillData = parsedData.autoFillData || {};
   } else if (Array.isArray(parsedData)) {
       boards = parsedData;
       autoFillData = {}; 
   } else {
       throw new Error("Dados inválidos");
   }
   boards.forEach(b => { if (!b.cards) b.cards = []; });
} catch {
   boards = defaultData;
   autoFillData = {};
}
boardsOriginal = JSON.parse(JSON.stringify(boards));
if (!localStorage.getItem(key)) salvarBoards(mode);
senhasCarregadas = true;
} else {
const key = "gerenciadorAnotacoes";
let data = localStorage.getItem(key);
let defaultData = [{ id: Date.now(), nome: "Exemplo", cards: [] }];
try {
   anotacoesBoards = JSON.parse(data);
   if (!Array.isArray(anotacoesBoards)) throw new Error();
   anotacoesBoards.forEach(b => { if (!b.cards) b.cards = []; });
} catch {
   anotacoesBoards = defaultData;
}
anotacoesBoardsOriginal = JSON.parse(JSON.stringify(anotacoesBoards));
if(!localStorage.getItem(key)) salvarBoards(mode);
anotacoesCarregadas = true;
}
}

function mostrarBoards(mode) {
 // Garantir que os marcadores estão carregados antes de renderizar
 if (marcadores.length === 0) {
     carregarMarcadores();
 }
 const boardsDiv = document.getElementById(mode === 'senha' ? "boards" : "anotacoesBoards");
 const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
 boardsDiv.innerHTML = "";
 currentBoards.forEach(board => {
     const coluna = document.createElement("div");
     coluna.className = "board-column";
     
     // Verificar se algum card tem marcador importante
     let temMarcadorImportante = false;
     let corMarcadorImportante = null;
     
     for (const cardCriptografado of board.cards) {
         const card = descriptografarCard(cardCriptografado, senhaDigitada) || {};
         if (card.marcadorId) {
             const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
             if (marcador && marcador.importante) {
                 temMarcadorImportante = true;
                 corMarcadorImportante = marcador.cor;
                 break;
             }
         }
     }
     
     // Aplicar borda colorida se tiver marcador importante
     if (temMarcadorImportante && corMarcadorImportante) {
         coluna.setAttribute('data-marcador-importante', 'true');
         coluna.style.setProperty('--marcador-cor-importante', corMarcadorImportante);
     }
     
     const titulo = document.createElement("h3");
     titulo.textContent = board.nome;
     titulo.style.cursor = "pointer";
     const btnExcluir = document.createElement("button");
     btnExcluir.textContent = "×";
     btnExcluir.className = "btn-excluir-categoria";
     btnExcluir.title = `Excluir categoria "${board.nome}"`;
     btnExcluir.addEventListener('click', async (e) => {
         e.stopPropagation();
         if (await mostrarConfirmacao("Confirmar Exclusão", `Deseja excluir a categoria "${board.nome}"?`)) {
             if (mode === 'senha') {
                 boards = boards.filter(b => b.id !== board.id);
                 boardsOriginal = boardsOriginal.filter(b => b.id !== board.id);
             } else {
                 anotacoesBoards = anotacoesBoards.filter(b => b.id !== board.id);
                 anotacoesBoardsOriginal = anotacoesBoardsOriginal.filter(b => b.id !== board.id);
             }
             openBoardIds.delete(board.id);
             salvarBoards(mode);
             mostrarBoards(mode);
         }
     });
     titulo.appendChild(btnExcluir);
     titulo.addEventListener('click', () => toggleCards(coluna, board, mode));
     coluna.appendChild(titulo);
     boardsDiv.appendChild(coluna);
     if (openBoardIds.has(board.id)) {
         toggleCards(coluna, board, mode);
     }
 });
// Verificar alertas imediatamente após renderizar os boards
try { verificarMostrarAlerta(); } catch (e) { /* noop */ }
try { analisarCredenciais(); } catch (e) { /* noop */ }
}

function toggleCards(coluna, board, mode) {
const isOpen = coluna.dataset.open === "true";
const appElement = document.getElementById(mode === 'senha' ? 'app' : 'anotacoesApp');
const isModoLeitura = appElement.classList.contains('modo-leitura');
const btnExcluir = coluna.querySelector('.btn-excluir-categoria');
if (isOpen) {
while (coluna.children.length > 1) coluna.removeChild(coluna.lastChild);
if (btnExcluir) btnExcluir.style.display = "flex";
coluna.dataset.open = "false";
openBoardIds.delete(board.id);
} else {
if (btnExcluir) btnExcluir.style.display = "none";
board.cards.forEach(cardCriptografado => {
const card = descriptografarCard(cardCriptografado, senhaDigitada) || {};
const cardDiv = document.createElement("div");
cardDiv.className = "card";

// Aplicar cor do marcador como borda do card
if (card.marcadorId) {
    const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
    if (marcador && marcador.cor) {
        cardDiv.setAttribute('data-marcador-cor', marcador.cor);
        cardDiv.style.setProperty('--marcador-cor', marcador.cor);
        if (marcador.importante) {
            cardDiv.setAttribute('data-marcador-importante', 'true');
        }
    }
}

// Cabeçalho com título
let innerHTML = `
    <div class="card-header">
    <strong class="card-title">${(card.titulo && card.titulo.trim()) ? card.titulo : 'Sem título'}</strong>
    </div>
`;

// Exibir badge do marcador se houver
if (card.marcadorId) {
    const badgeHTML = renderizarBadgeMarcador(card.marcadorId);
    if (badgeHTML) {
        innerHTML += `<div class="marcadores-container">${badgeHTML}</div>`;
    }
}

// Meta simplificada (chips) para senhas
if (mode === 'senha') {
    innerHTML += `<div class="card-meta">`;
    innerHTML += `<span class="chip"><span class="chip-label">Usuário</span><span class="chip-value">${card.usuario || '[Inválido]'}</span></span>`;
    if (card.telefone) innerHTML += `<span class="chip"><span class="chip-label">Telefone</span><span class="chip-value">${card.telefone}</span></span>`;
    if (card.cpf) innerHTML += `<span class="chip"><span class="chip-label">CPF</span><span class="chip-value">${card.cpf}</span></span>`;
    innerHTML += `</div>`;
}
// Meta simplificada para anotações: exibir campos extras como chips
if (mode === 'anotacao') {
    const chips = [];
    if (card.links) {
        const linkText = (card.abreviacao && card.abreviacao.trim() !== '') ? card.abreviacao : card.links;
        chips.push(`<span class="chip"><span class="chip-label">Link</span><span class="chip-value"><a href="${card.links}" target="_blank" rel="noopener noreferrer">${linkText}</a></span></span>`);
    }
    if (card.email) chips.push(`<span class="chip"><span class="chip-label">E-mail</span><span class="chip-value">${card.email}</span></span>`);
    if (card.telefone) chips.push(`<span class="chip"><span class="chip-label">Telefone</span><span class="chip-value">${card.telefone}</span></span>`);
    if (card.cpf) chips.push(`<span class="chip"><span class="chip-label">CPF</span><span class="chip-value">${card.cpf}</span></span>`);
    if (card.usuario) chips.push(`<span class="chip"><span class="chip-label">Usuário</span><span class="chip-value">${card.usuario}</span></span>`);
    if (chips.length) {
        innerHTML += `<div class="card-meta">${chips.join('')}</div>`;
    }
}

// Notas (preview) e link abreviado
if (card.notas) {
    const preview = (card.notas && typeof card.notas === 'string' && card.notas.length > 90)
        ? card.notas.slice(0, 90) + '…' : (card.notas || '');
    innerHTML += `<div class="notas-preview">${preview}</div>`;
}
if (card.links && mode === 'senha') {
    const linkText = (card.abreviacao && card.abreviacao.trim() !== '') ? card.abreviacao : card.links;
    innerHTML += `<div class="links-chip"><a href="${card.links}" target="_blank" rel="noopener noreferrer">${linkText}</a></div>`;
}

cardDiv.innerHTML = innerHTML;
const botoesDiv = document.createElement("div");
botoesDiv.className = "card-buttons";
const btnEditar = document.createElement("button");
btnEditar.innerHTML = createEditIconSVG();
btnEditar.classList.add('icon-only', 'edit');
btnEditar.title = "Editar";
btnEditar.setAttribute('aria-label', 'Editar');
btnEditar.addEventListener('click', (e) => { 
  e.stopPropagation();
  if (mode === 'senha') abrirModalSenha(board.id, cardCriptografado);
  else abrirModalAnotacao(board.id, cardCriptografado);
});
const btnExcluirCard = document.createElement("button");
btnExcluirCard.innerHTML = createDeleteIconSVG();
btnExcluirCard.className = "excluir icon-only delete";
btnExcluirCard.title = "Excluir";
btnExcluirCard.setAttribute('aria-label', 'Excluir');
btnExcluirCard.addEventListener('click', async (e) => {
  e.stopPropagation();
  if (await mostrarConfirmacao("Confirmar Exclusão", `Deseja excluir "${card.titulo || 'este item'}"?`)) {
    board.cards = board.cards.filter((c) => c.id !== cardCriptografado.id);
    const originalBoardSet = mode === 'senha' ? boardsOriginal : anotacoesBoardsOriginal;
    const boardOriginal = originalBoardSet.find(b => b.id === board.id);
    if (boardOriginal) {
        boardOriginal.cards = boardOriginal.cards.filter((c) => c.id !== cardCriptografado.id);
    }
    salvarBoards(mode);
    mostrarBoards(mode);
  }
});
const btnDownload = document.createElement("button");
btnDownload.innerHTML = createDownloadIconSVG();
btnDownload.classList.add('icon-only', 'download');
btnDownload.title = "Descarregar";
btnDownload.setAttribute('aria-label', 'Descarregar');
btnDownload.addEventListener('click', (e) => { e.stopPropagation(); downloadCardAsImage(card); });
// Botão para copiar a senha (ao lado de Descarregar) — somente no painel de Senhas
let btnCopiarSenha = null;
if (mode === 'senha') {
    btnCopiarSenha = document.createElement("button");
    btnCopiarSenha.innerHTML = createCopyIconSVG();
    btnCopiarSenha.classList.add('icon-only');
    btnCopiarSenha.title = "Copiar senha";
    btnCopiarSenha.setAttribute('aria-label', 'Copiar senha');
    btnCopiarSenha.addEventListener('click', (e) => {
        e.stopPropagation();
        const senhaParaCopiar = card && card.senha ? String(card.senha) : '';
        if (!senhaParaCopiar) {
            try { mostrarMensagem('Atenção', 'Senha não disponível para cópia. Abra o item para ver a senha.'); } catch(_){ }
            return;
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(senhaParaCopiar).then(() => {
                try { mostrarMensagem('Pronto', 'Senha copiada para a área de transferência.'); } catch(_){ }
            }).catch(() => {
                // fallback
                try {
                    const ta = document.createElement('textarea');
                    ta.value = senhaParaCopiar;
                    ta.style.position = 'fixed'; ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    try { mostrarMensagem('Pronto', 'Senha copiada para a área de transferência.'); } catch(_){ }
                } catch (err) {
                    console.error('Falha ao copiar senha (clipboard):', err);
                    try { mostrarMensagem('Erro', 'Não foi possível copiar automaticamente. Selecione e copie manualmente.'); } catch(_){ }
                }
            });
        } else {
            try {
                const ta = document.createElement('textarea');
                ta.value = senhaParaCopiar;
                ta.style.position = 'fixed'; ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                try { mostrarMensagem('Pronto', 'Senha copiada para a área de transferência.'); } catch(_){ }
            } catch (err) {
                console.error('Falha ao copiar senha (fallback):', err);
                try { mostrarMensagem('Erro', 'Não foi possível copiar automaticamente.'); } catch(_){ }
            }
        }
    });
}
const btnVisualizar = document.createElement("button");
btnVisualizar.className = "visualizar visualizar-icone icon-only view";
btnVisualizar.innerHTML = createEyeIconSVG();
btnVisualizar.title = "Visualizar completo";
btnVisualizar.setAttribute('aria-label', 'Visualizar completo');
btnVisualizar.addEventListener('click', (e) => {
    e.stopPropagation();
    mostrarVisualizacaoCompleta(card);
});
botoesDiv.appendChild(btnEditar);
// Botão Copiar (somente no painel de Anotações)
if (mode === 'anotacao') {
    const btnCopiar = document.createElement('button');
    btnCopiar.innerHTML = createCopyIconSVG();
    btnCopiar.classList.add('icon-only');
    btnCopiar.title = 'Copiar para Senhas';
    btnCopiar.setAttribute('aria-label', 'Copiar para Senhas');
    btnCopiar.addEventListener('click', async (e) => {
        e.stopPropagation();
        try {
            const confirmado = await mostrarConfirmacao(
                'Copiar para Senhas',
                `Deseja copiar a anotação "${card.titulo || 'sem título'}" para o painel de Senhas?\nSerá necessário informar a senha do serviço para concluir.`
            );
            if (!confirmado) return;
            const senhaInformada = await mostrarPromptSenha('Senha obrigatória', 'Informe a senha do serviço para concluir a cópia para Senhas:');
            if (!senhaInformada || !senhaInformada.trim()) {
                mostrarMensagem('Atenção', 'A senha é obrigatória para salvar em Senhas. A cópia foi cancelada.');
                return;
            }
            const nomeCategoria = (card.titulo || '').trim() || 'Sem título';
            await copiarAnotacaoParaSenha(board, card, senhaInformada.trim(), nomeCategoria);
        } catch (err) {
            console.error('Falha ao copiar anotação para senhas:', err);
            mostrarMensagem('Erro', 'Não foi possível concluir a cópia.');
        }
    });
    botoesDiv.appendChild(btnCopiar);
}
    botoesDiv.appendChild(btnExcluirCard);
    botoesDiv.appendChild(btnDownload);
    if (mode === 'senha' && btnCopiarSenha) {
        botoesDiv.appendChild(btnCopiarSenha);
    }

if (isModoLeitura) {
    // Apenas no modo de visualização, mostrar CTA de largura total com ícone + texto
    const fullViewBtn = document.createElement('button');
    fullViewBtn.className = 'full-view-btn';
    fullViewBtn.innerHTML = `${createEyeIconSVG()}<span class=\"btn-label\">Visualização Completa</span>`;
    fullViewBtn.title = 'Visualização Completa';
    fullViewBtn.setAttribute('aria-label', 'Visualização Completa');
    fullViewBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        mostrarVisualizacaoCompleta(card);
    });
    // No modo leitura não adicionamos o ícone de visualizar na barra para evitar duplicação
    // e também evitamos inserir a barra de ícones (que ficaria vazia devido ao CSS)
    cardDiv.appendChild(fullViewBtn);
} else {
    // No modo normal, manter como estava: incluir o botão visualizar na barra de ícones
    botoesDiv.appendChild(btnVisualizar);
    cardDiv.appendChild(botoesDiv);
}
coluna.appendChild(cardDiv);
});
const btnAdicionar = document.createElement("button");
btnAdicionar.textContent = "+ Informações";
btnAdicionar.addEventListener('click', (ev) => {
    // Evitar que o mesmo clique que abriu o botão ative o overlay de fechamento
    try { ev.stopPropagation(); ev.preventDefault(); } catch(_){}
    console.log('[CALL] +Informações click - scrollY before handler:', window.scrollY);
    try { console.trace(); } catch(_){ }
    // Ativar escudo imediatamente para bloquear fechamentos acidentais disparados
    // por outros handlers que podem rodar antes do setTimeout abaixo.
    try {
        window.__modalClickShield = true;
        window.__lastModalOpenTime = Date.now();
        try { overlay.style.pointerEvents = 'none'; } catch(_){}
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; } catch(_){} }, 420);
    } catch (_) {}
    // Abrir o modal de forma assíncrona para evitar que o clique original
    // seja percebido como clique no overlay (fechamento imediato).
    if (mode === 'senha') {
        setTimeout(() => abrirModalSenha(board.id), 0);
    } else {
        setTimeout(() => abrirModalAnotacao(board.id), 0);
    }
});
btnAdicionar.style.marginTop = "8px";
coluna.appendChild(btnAdicionar);
coluna.dataset.open = "true";
openBoardIds.add(board.id);
}
}

function submitNewColumn(mode) {
const inputId = mode === 'senha' ? "new-column-name" : "new-anotacao-column-name";
const input = document.getElementById(inputId);
const nome = input.value.trim();
if (!nome) {
mostrarMensagem("Atenção", "Digite o nome da nova categoria.");
return;
}
const currentBoards = mode === 'senha' ? boards : anotacoesBoards;
if (currentBoards.some(b => b.nome.toLowerCase() === nome.toLowerCase())) {
mostrarMensagem("Erro", "Uma categoria com este nome já existe.");
return;
}
const novaCategoria = { id: Date.now(), nome, cards: [] };
if (mode === 'senha') {
boards.push(novaCategoria);
boardsOriginal.push(JSON.parse(JSON.stringify(novaCategoria)));
} else {
anotacoesBoards.push(novaCategoria);
anotacoesBoardsOriginal.push(JSON.parse(JSON.stringify(novaCategoria)));
}
salvarBoards(mode);
mostrarBoards(mode);
input.value = "";
}


function abrirModalSenha(boardId, cardCriptografado = null) {
    console.log('[TRACE] abrirModalSenha invoked - stack trace:');
    try { console.trace(); } catch(_){}
    console.log('[TRACE] abrirModalSenha - scrollY at entry:', window.scrollY);
    editandoBoardId = boardId;
editandoCardId = cardCriptografado ? cardCriptografado.id : null;
document.getElementById("modalTituloSenha").textContent = cardCriptografado ? "Editar Senha" : "Adicionar Senha";
const card = cardCriptografado ? descriptografarCard(cardCriptografado, senhaDigitada) : {};
document.getElementById("inputTitulo").value = card.titulo || "";
document.getElementById("inputUsuario").value = card.usuario || "";
document.getElementById("inputSenha").value = card.senha || "";
document.getElementById("inputEmail").value = card.email || "";
document.getElementById("inputTelefone").value = card.telefone || "";
document.getElementById("inputNotas").value = card.notas || "";
document.getElementById("inputLinks").value = card.links || "";
document.getElementById("inputAbreviacao").value = card.abreviacao || "";
document.getElementById("inputCpf").value = card.cpf || "";

// Carregar cartões se existirem
if (cardCriptografado && card) {
    const cartoesDoCard = card.cartoes || card.cartões || card.cartao || card.cartão;
    if (cartoesDoCard && typeof window.carregarCartoes === 'function') {
        window.carregarCartoes(cartoesDoCard);
    }
} else {
    // Limpar cartões ao adicionar nova senha
    if (typeof window.limparDadoscartão === 'function') {
        window.limparDadoscartão();
    }
}

// Carregar marcadores e selecionar o marcador do card
atualizarSelectsMarcadores();
if (inputMarcador) {
    inputMarcador.value = card.marcadorId || "";
    
    // Aplicar brilho se o marcador for importante
    aplicarBrilhoMarcadorImportante('senha', card.marcadorId);
}

if (!cardCriptografado) {
    const board = boards.find(b => b.id === boardId);
    if (board) {
        atualizarServicoAutomatico(board.nome);
    }
    
    showCorrelationWarning();
}

handleGmailHelperVisibility();
handleAbreviacaoLogic();
    // marcar como em abertura para bloquear cliques residuais no container
    try { modalSenhaDiv.dataset.opening = 'true'; } catch(_){}
    // Proteger contra cliques residuais que possam fechar o modal imediatamente.
    try {
        window.__modalClickShield = true;
        try { overlay.style.pointerEvents = 'none'; } catch(_){ }
        try { window.__lastModalOpenTime = Date.now(); } catch(_){}
        // aumentar janela do escudo temporariamente para 700ms para mitigar reentrancy
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; } catch(_){} }, 700);
    } catch(_){ }
    // lock body scroll to avoid jumps
    lockBodyScroll();
    // limpar flag de abertura após curto intervalo
    try { setTimeout(() => { try { delete modalSenhaDiv.dataset.opening; } catch(_){} }, 420); } catch(_){}
    const prevScrollY_modalSenha = window.scrollY || window.pageYOffset || 0;
    console.log('[DEBUG] abrirModalSenha: saving scrollY before open:', prevScrollY_modalSenha);
    modalSenhaDiv.style.display = "flex";
    document.body.classList.add('modal-open');
    if (!isMobileDevice()) {
        const inputTituloEl = document.getElementById("inputTitulo");
        if (inputTituloEl) {
            try {
                inputTituloEl.focus({ preventScroll: true });
                console.log('[DEBUG] abrirModalSenha: focused inputTitulo with preventScroll');
            } catch (err) {
                inputTituloEl.focus();
                console.log('[DEBUG] abrirModalSenha: focused inputTitulo fallback without preventScroll');
            }
        }
    }
    // Restaurar scroll logo em seguida para evitar salto em navegadores teimosos
    setTimeout(() => {
        try {
            window.scrollTo(0, prevScrollY_modalSenha);
            console.log('[DEBUG] abrirModalSenha: restored scrollY to', prevScrollY_modalSenha);
        } catch (e) {
            try { window.scrollTo(0, prevScrollY_modalSenha); } catch(_){}
        }
    }, 0);
}

function fecharModalSenha() {
    try {
        // Bloquear fechamento imediato se o modal estiver no período de abertura
        const shield = !!window.__modalClickShield;
        const last = window.__lastModalOpenTime || 0;
        const age = Date.now() - last;
        if (shield || (last && age < 480) || (modalSenhaDiv && modalSenhaDiv.dataset && modalSenhaDiv.dataset.opening === 'true')) {
            console.log('[MODAL-SHIELD] fecharModalSenha ignored due to opening shield', { shield, age, opening: modalSenhaDiv ? modalSenhaDiv.dataset.opening : undefined });
            return;
        }
    } catch(_) {}
modalSenhaDiv.style.display = "none";
// Remover brilho do marcador importante
modalSenhaDiv.classList.remove('marcador-importante-ativo');
modalSenhaDiv.style.removeProperty('--marcador-cor-importante');
gmailHelperBtn.classList.remove('visible');
document.getElementById('clear-email').style.right = '10px';
abreviacaoContainer.style.display = 'none';
document.body.classList.remove('modal-open');
// unlock body scroll
if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
document.querySelectorAll('#modalSenha .btn-clear-field').forEach(btn => btn.style.display = 'none');
formSenha.reset();
dismissWarning(); 
correlationWarningShown = false; 
}

function salvarSenha(e) {
e.preventDefault();
const dados = {
titulo: document.getElementById("inputTitulo").value.trim(),
usuario: document.getElementById("inputUsuario").value.trim(),
senha: document.getElementById("inputSenha").value.trim(),
email: document.getElementById("inputEmail").value.trim(),
telefone: document.getElementById("inputTelefone").value.trim(),
notas: document.getElementById("inputNotas").value.trim(),
links: document.getElementById("inputLinks").value.trim(),
abreviacao: document.getElementById("inputAbreviacao").value.trim(),
cpf: document.getElementById("inputCpf").value.trim(),
marcadorId: inputMarcador?.value || null
};

try {
    const cartoesCapturados = (typeof window.obterCartoes === 'function') ? window.obterCartoes() : [];
    if (Array.isArray(cartoesCapturados) && cartoesCapturados.length) {
        const cartoesSanitizados = cartoesCapturados
            .map((c) => ({
                numero: (c.numero || '').trim(),
                titular: (c.titular || '').trim(),
                validade: (c.validade || '').trim(),
                cvv: (c.cvv || '').trim(),
                bandeira: (c.bandeira || '').trim()
            }))
            .filter((c) => !!c.numero);
        if (cartoesSanitizados.length) dados.cartoes = cartoesSanitizados;
    }
} catch (_e) { /* manter silencioso para não quebrar salvamento */ }


if (!window.recentHistory) {
    window.recentHistory = {
        maxItems: 5,
        getData() {
            const data = localStorage.getItem('recentHistory');
            return data ? JSON.parse(data) : {};
        },
        saveData(data) {
            localStorage.setItem('recentHistory', JSON.stringify(data));
        },
        addItem(field, value) {
            if (!value.trim()) return;
            const data = this.getData();
            if (!data[field]) data[field] = [];
            data[field] = data[field].filter(item => item !== value);
            data[field].unshift(value);
            data[field] = data[field].slice(0, this.maxItems);
            this.saveData(data);
        },
        getItems(field) {
            const data = this.getData();
            return data[field] || [];
        }
    };

    
    window.showRecentItems = function(input, items) {
        const existingMenu = input.parentElement.querySelector('.recent-items-menu');
        if (existingMenu) existingMenu.remove();
        if (!items.length) return;

        const menu = document.createElement('div');
        menu.className = 'recent-items-menu';
        
        items.forEach(item => {
            const itemEl = document.createElement('div');
            itemEl.className = 'recent-item';
            itemEl.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                ${item}
            `;
            itemEl.addEventListener('click', () => {
                input.value = item;
                menu.remove();
                input.focus();
            });
            menu.appendChild(itemEl);
        });

        input.parentElement.appendChild(menu);
        menu.classList.add('show');
    };

    
    const setupRecentHistory = function(input) {
        if (!input) return;
        
        const fieldName = input.id;
        
        input.addEventListener('focus', () => {
            const items = recentHistory.getItems(fieldName);
            if (items.length) {
                input.parentElement.classList.add('has-recent');
                showRecentItems(input, items);
            }
        });
    };

    
    ['inputUsuario', 'inputEmail', 'inputTelefone', 'inputLinks', 'inputNotas', 'inputCpf'].forEach(id => {
        const input = document.getElementById(id);
        if (input) setupRecentHistory(input);
    });

    
    document.addEventListener('click', (e) => {
        const menus = document.querySelectorAll('.recent-items-menu');
        menus.forEach(menu => {
            if (!menu.parentElement.contains(e.target)) {
                menu.remove();
            }
        });
    });
}


if (window.recentHistory) {
    Object.entries(dados).forEach(([key, value]) => {
        // Evitar armazenar objetos/arrays (ex.: cartoes) e campos sensíveis
        if (key === 'senha' || key === 'titulo') return;
        if (value == null) return;
        if (typeof value !== 'string') return;
        if (!value.trim()) return;
        recentHistory.addItem('input' + key.charAt(0).toUpperCase() + key.slice(1), value);
    });
};
if (!dados.titulo || !dados.usuario || !dados.senha) {
mostrarMensagemNoModal("Atenção", "Preencha: Serviço, Usuário e Senha.");
return;
}
const card = { id: editandoCardId || Date.now(), ...dados };
const board = boards.find(b => b.id === editandoBoardId);
const boardOriginal = boardsOriginal.find(b => b.id === editandoBoardId);
const cardCriptografado = criptografarCard(card, senhaDigitada);
if (editandoCardId) {
const idx = board.cards.findIndex(c => c.id === editandoCardId);
if (idx >= 0) board.cards[idx] = cardCriptografado;
if(boardOriginal) {
  const idxOriginal = boardOriginal.cards.findIndex(c => c.id === editandoCardId);
  if (idxOriginal >= 0) boardOriginal.cards[idxOriginal] = cardCriptografado;
}
} else {
board.cards.push(cardCriptografado);
if(boardOriginal) boardOriginal.cards.push(cardCriptografado);
}
salvarBoards('senha');
mostrarBoards('senha');
fecharModalSenha();
}

function abrirModalAnotacao(boardId, cardCriptografado = null) {
    console.log('[TRACE] abrirModalAnotacao invoked - stack trace:');
    try { console.trace(); } catch(_){}
    console.log('[TRACE] abrirModalAnotacao - scrollY at entry:', window.scrollY);
    editandoBoardId = boardId;
editandoCardId = cardCriptografado ? cardCriptografado.id : null;
document.getElementById("modalTituloAnotacao").textContent = cardCriptografado ? "Editar Anotação" : "Adicionar Anotação";
const card = cardCriptografado ? descriptografarCard(cardCriptografado, senhaDigitada) : {};
document.getElementById("inputTituloAnotacao").value = card.titulo || "";
document.getElementById("inputLinksAnotacao").value = card.links || "";
document.getElementById("inputNotasAnotacao").value = card.notas || "";
 // Preencher e exibir extras, se houver
 const extraDiv = document.getElementById('extraFieldsAnotacao');
 const btnExtra = document.getElementById('btnMaisInfoAnotacao');
 const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ""; };
 setVal('inputUsuarioAnotacao', card.usuario);
 setVal('inputEmailAnotacao', card.email);
 setVal('inputTelefoneAnotacao', card.telefone);
 setVal('inputCpfAnotacao', card.cpf);
 setVal('inputAbreviacaoAnotacao', card.abreviacao);
 // Aplicar formatação inicial como no formulário de Senhas
 const telAnotEl = document.getElementById('inputTelefoneAnotacao');
 if (telAnotEl && telAnotEl.value) formatarTelefone(telAnotEl);
 const cpfAnotEl = document.getElementById('inputCpfAnotacao');
 if (cpfAnotEl && cpfAnotEl.value) formatarCPF(cpfAnotEl);
 const hasExtras = !!(card.usuario || card.email || card.telefone || card.cpf || card.abreviacao);
 if (extraDiv && btnExtra) {
     extraDiv.style.display = hasExtras ? 'flex' : 'none';
     btnExtra.setAttribute('aria-expanded', hasExtras ? 'true' : 'false');
     btnExtra.textContent = hasExtras ? '− Menos informações' : '+ Mais informações';
 }
    // Atualizar visibilidade dos botões limpar conforme valores atuais
    updateClearButtonsFormAnotacao();

// Carregar marcadores e selecionar o marcador do card
atualizarSelectsMarcadores();
if (inputMarcadorAnotacao) {
    inputMarcadorAnotacao.value = card.marcadorId || "";
    
    // Aplicar brilho se o marcador for importante
    aplicarBrilhoMarcadorImportante('anotacao', card.marcadorId);
}

    const prevScrollY_modalAnot = window.scrollY || window.pageYOffset || 0;
    console.log('[DEBUG] abrirModalAnotacao: saving scrollY before open:', prevScrollY_modalAnot);
    // marcar como em abertura para bloquear cliques residuais no container
    try { modalAnotacaoDiv.dataset.opening = 'true'; } catch(_){}
    modalAnotacaoDiv.style.display = "flex";
    document.body.classList.add('modal-open');
    // limpar flag de abertura após curto intervalo
    try { setTimeout(() => { try { delete modalAnotacaoDiv.dataset.opening; } catch(_){} }, 420); } catch(_){}
    if (!isMobileDevice()) {
        const inputTituloAnotEl = document.getElementById("inputTituloAnotacao");
        if (inputTituloAnotEl) {
            try {
                inputTituloAnotEl.focus({ preventScroll: true });
                console.log('[DEBUG] abrirModalAnotacao: focused inputTituloAnotacao with preventScroll');
            } catch (err) {
                inputTituloAnotEl.focus();
                console.log('[DEBUG] abrirModalAnotacao: focused inputTituloAnotacao fallback without preventScroll');
            }
        }
    }
    // Proteger contra cliques residuais que possam fechar o modal imediatamente.
    try {
        window.__modalClickShield = true;
        try { overlay.style.pointerEvents = 'none'; } catch(_){ }
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; } catch(_){} }, 220);
    } catch(_){ }
    // lock body scroll using the captured prevScrollY to avoid races
    try { lockBodyScrollAt(prevScrollY_modalAnot); } catch(_) { try { lockBodyScroll(); } catch(_){} }
    setTimeout(() => {
        try {
            window.scrollTo(0, prevScrollY_modalAnot);
            console.log('[DEBUG] abrirModalAnotacao: restored scrollY to', prevScrollY_modalAnot);
        } catch (e) { try { window.scrollTo(0, prevScrollY_modalAnot); } catch(_){} }
    }, 0);
}

function fecharModalAnotacao() {
    try {
        // Log detalhado para diagnóstico de fechamento imediato
        try { console.trace(); } catch(_){}
        console.log('[FECHAR] fecharModalAnotacao entry', {
            modalOpeningFlag: modalAnotacaoDiv && modalAnotacaoDiv.dataset ? modalAnotacaoDiv.dataset.opening : undefined,
            shield: !!window.__modalClickShield,
            lastModalOpenTime: window.__lastModalOpenTime || 0,
            ageMs: (window.__lastModalOpenTime ? (Date.now() - window.__lastModalOpenTime) : null),
            bodyLock: (window.__bodyLock || {}),
        });

        // Bloquear fechamento imediato se o modal estiver no período de abertura
        const shield = !!window.__modalClickShield;
        const last = window.__lastModalOpenTime || 0;
        const age = Date.now() - last;
        if (shield || (last && age < 700) || (modalAnotacaoDiv && modalAnotacaoDiv.dataset && modalAnotacaoDiv.dataset.opening === 'true')) {
            console.log('[MODAL-SHIELD] fecharModalAnotacao ignored due to opening shield', { shield, age, opening: modalAnotacaoDiv ? modalAnotacaoDiv.dataset.opening : undefined });
            return;
        }
    } catch(e) { console.warn('[FECHAR] fecharModalAnotacao pre-check failed', e); }
modalAnotacaoDiv.style.display = "none";
// Remover brilho do marcador importante
modalAnotacaoDiv.classList.remove('marcador-importante-ativo');
modalAnotacaoDiv.style.removeProperty('--marcador-cor-importante');
document.body.classList.remove('modal-open');
formAnotacao.reset();
 // Recolher extras ao fechar
 const extraDiv = document.getElementById('extraFieldsAnotacao');
 const btnExtra = document.getElementById('btnMaisInfoAnotacao');
 if (extraDiv && btnExtra) {
     extraDiv.style.display = 'none';
     btnExtra.setAttribute('aria-expanded', 'false');
     btnExtra.textContent = '+ Mais informações';
 }
 // unlock body scroll
    if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
}

function salvarAnotacao(e) {
e.preventDefault();
const dados = {
  titulo: document.getElementById("inputTituloAnotacao").value.trim(),
  links: document.getElementById("inputLinksAnotacao").value.trim(),
  notas: document.getElementById("inputNotasAnotacao").value.trim(),
  marcadorId: inputMarcadorAnotacao?.value || null
};
if (!dados.titulo) {
  mostrarMensagemNoModal("Atenção", "O campo Nome é obrigatório.");
  return;
}
 // Extras opcionais
 const usuario = (document.getElementById('inputUsuarioAnotacao')||{}).value?.trim();
 const email = (document.getElementById('inputEmailAnotacao')||{}).value?.trim();
 const telefone = (document.getElementById('inputTelefoneAnotacao')||{}).value?.trim();
 const cpf = (document.getElementById('inputCpfAnotacao')||{}).value?.trim();
 const abreviacao = (document.getElementById('inputAbreviacaoAnotacao')||{}).value?.trim();
 if (usuario) dados.usuario = usuario;
 if (email) dados.email = email;
 if (telefone) dados.telefone = telefone;
 if (cpf) dados.cpf = cpf;
 if (abreviacao) dados.abreviacao = abreviacao;
const card = { id: editandoCardId || Date.now(), ...dados };
const board = anotacoesBoards.find(b => b.id === editandoBoardId);
const boardOriginal = anotacoesBoardsOriginal.find(b => b.id === editandoBoardId);
const cardCriptografado = criptografarCard(card, senhaDigitada);
if (editandoCardId) {
  const idx = board.cards.findIndex(c => c.id === editandoCardId);
  if (idx >= 0) board.cards[idx] = cardCriptografado;
  if(boardOriginal) {
      const idxOriginal = boardOriginal.cards.findIndex(c => c.id === editandoCardId);
      if (idxOriginal >= 0) boardOriginal.cards[idxOriginal] = cardCriptografado;
  }
} else {
  board.cards.push(cardCriptografado);
  if(boardOriginal) boardOriginal.cards.push(cardCriptografado);
}
salvarBoards('anotacao');
mostrarBoards('anotacao');
fecharModalAnotacao();
}

// Copiar uma anotação para o painel de Senhas: cria um item duplicado em Senhas (sem remover a anotação)
async function copiarAnotacaoParaSenha(origemBoard, anotacao, senhaObrigatoria, nomeCategoriaDestino) {
    try {
        // Garantir estrutura de senhas
        if (!Array.isArray(boards)) boards = [];
        if (!Array.isArray(boardsOriginal)) boardsOriginal = [];

        // Gerador de IDs robusto para evitar colisões quando múltiplas categorias/cartões são criados rapidamente
        const genId = () => (Date.now() + Math.floor(Math.random() * 1_000_000));

        // Definir nome da categoria de destino prioritariamente informado, senão usar nome da origem
        const nomeDestino = ((nomeCategoriaDestino || origemBoard?.nome || '').trim());
        if (!nomeDestino) throw new Error('Categoria de destino não determinada.');
        const nomeDestinoLower = nomeDestino.toLowerCase();

        // Encontrar (ou criar) categoria de destino na fonte completa (boardsOriginal)
        let destinoOriginal = boardsOriginal.find(b => (b.nome || '').toLowerCase() === nomeDestinoLower);
        if (!destinoOriginal) {
            destinoOriginal = { id: genId(), nome: nomeDestino, cards: [] };
            boardsOriginal.push(destinoOriginal);
        }
        // Tentar referenciar a mesma categoria no array de visualização atual (se existir)
        let destino = boards.find(b => b.id === destinoOriginal.id);
        if (!destino) {
            // Se a visualização atual não contém, podemos optar por inserir para refletir imediatamente
            // sem afetar filtros; se houver filtros, o item pode não aparecer, o que é aceitável.
            boards.push({ id: destinoOriginal.id, nome: destinoOriginal.nome, cards: [] });
            destino = boards.find(b => b.id === destinoOriginal.id);
        }

        // Montar novo card com dados disponíveis (senha do serviço informada obrigatória)
        const novoCard = {
            id: genId(),
            titulo: (anotacao.titulo && anotacao.titulo.trim()) ? anotacao.titulo.trim() : 'Sem título',
            usuario: anotacao.usuario || anotacao.email || '',
            senha: senhaObrigatoria || '',
            email: anotacao.email || '',
            telefone: anotacao.telefone || '',
            notas: anotacao.notas ? `[Copiado de Anotações]\n${anotacao.notas}` : '[Copiado de Anotações]',
            links: anotacao.links || '',
            abreviacao: anotacao.abreviacao || '',
            cpf: anotacao.cpf || ''
        };
        // Determinar a chave de criptografia correta para Senhas via certificado digital
        let chaveCripto = senhaDigitada;
        if (!verificarSenha(chaveCripto || '')) {
            const tokenCert = await mostrarPromptCertificado();
            if (!tokenCert) {
                mostrarMensagem('Atenção', 'Operação cancelada.');
                return;
            }
            chaveCripto = tokenCert;
        }

        const novoCardEnc = criptografarCard(novoCard, chaveCripto);
    // Persistir no dataset completo e refletir na visualização (se presente)
    destinoOriginal.cards.push(novoCardEnc);
    if (destino) destino.cards.push(novoCardEnc);

        salvarBoards('senha');
        // Reidratar sempre a partir da fonte completa e reaplicar filtros/busca se existirem,
        // garantindo que nenhuma categoria recém-criada “desapareça” visualmente
        const searchEl = document.getElementById('search-column');
        const hasSearch = !!(searchEl && searchEl.value.trim());
        const sections = (typeof getSelectedFilterSections === 'function') ? getSelectedFilterSections('senha') : [];
        const hasSectionFilter = Array.isArray(sections) && sections.length > 0;
        boards = JSON.parse(JSON.stringify(boardsOriginal));
        if (hasSearch || hasSectionFilter) {
            filtrarCategorias('senha');
        } else {
            mostrarBoards('senha');
        }
        mostrarMensagem('Sucesso', `Anotação copiada para Senhas na categoria "${destino.nome}".`);
        // Opcional: atualizar a visualização de boards de Senhas se estiver aberta
        // if (document.getElementById('app')?.style.display === 'block') mostrarBoards('senha');
    } catch (e) {
        console.error('Erro ao copiar anotação para senha:', e);
        mostrarMensagem('Erro', 'Ocorreu um erro ao copiar a anotação para Senhas.');
    }
}

function updateClearButtonsFormAnotacao() {
    const inputs = document.querySelectorAll('#formAnotacao .input-container input, #formAnotacao .input-container textarea');
    inputs.forEach(input => {
        const btn = input.parentElement.querySelector('.btn-clear-field');
        if (btn) btn.style.display = input.value ? 'block' : 'none';
    });
}


function filtrarCategorias(mode) {
const searchTerm = document.getElementById(mode === 'senha' ? 'search-column' : 'search-anotacao-column').value.trim().toLowerCase();
const originalData = mode === 'senha' ? boardsOriginal : anotacoesBoardsOriginal;

// Campos (seções) selecionadas para filtrar categorias
const selected = getSelectedFilterSections(mode); // array de chaves de campos (ex: ['titulo','usuario','email','marcador'])

const matchesCard = (cardEnc) => {
    const card = descriptografarCard(cardEnc, senhaDigitada) || {};
    // Obter nome do marcador (se existir) para permitir busca por nome do marcador
    let marcadorNome = '';
    try {
        if (card.marcadorId !== undefined && card.marcadorId !== null && String(card.marcadorId).trim() !== '') {
            // Caso o campo venha cifrado, descriptografarCard já tentou desserializar.
            const encontrado = marcadores.find(m => String(m.id) === String(card.marcadorId));
            if (encontrado) marcadorNome = String(encontrado.nome).toLowerCase();
            else {
                // Se não encontrou por id, tentar comparar pelo próprio valor (caso seja texto com nome)
                marcadorNome = String(card.marcadorId).toLowerCase();
            }
        }
    } catch (e) { marcadorNome = ''; }

    // montar o texto completo para busca (inclui marcador)
    const fields = ['titulo','usuario','email','telefone','cpf','links','notas','abreviacao'];
    const blobParts = fields.map(k => (card[k]||'').toString().toLowerCase());
    blobParts.push(marcadorNome);
    const blob = blobParts.join(' ');

    const termOk = searchTerm ? (blob.includes(searchTerm)) : true;
    // Se houver seleção de seções, verificar se ao menos uma das seções selecionadas possui conteúdo no card
    const sectionOk = selected.length > 0 ? selected.some(k => {
        if (k === 'marcador') return marcadorNome.trim() !== '';
        return (card[k]||'').toString().trim() !== '';
    }) : true;
    return termOk && sectionOk;
};

const filteredData = originalData.map(b => ({...b})).filter(b => {
    const nameOk = searchTerm ? b.nome.toLowerCase().includes(searchTerm) : true;
    const hasCardOk = (b.cards||[]).some(c => matchesCard(c));
    // Se houver seções selecionadas, exigir que haja algum card que atenda ao filtro
    if (selected.length > 0) {
        return hasCardOk && (searchTerm ? (nameOk || hasCardOk) : true);
    }
    return (searchTerm ? (nameOk || hasCardOk) : true);
});

if (mode === 'senha') boards = filteredData; else anotacoesBoards = filteredData;
mostrarBoards(mode);
}
function limparFiltro(mode) {
document.getElementById(mode === 'senha' ? 'search-column' : 'search-anotacao-column').value = "";
if (mode === 'senha') boards = JSON.parse(JSON.stringify(boardsOriginal));
else anotacoesBoards = JSON.parse(JSON.stringify(anotacoesBoardsOriginal));
mostrarBoards(mode);
}

function obterPacoteSenhasParaExportar(exportSenha) {
    const limparBoards = (lista) => Array.isArray(lista) ? lista.map((board) => ({
        id: board.id,
        nome: board.nome,
        cards: Array.isArray(board.cards) ? JSON.parse(JSON.stringify(board.cards)) : []
    })) : [];

    // Garantir que sempre tentamos incluir os marcadores atuais no pacote de exportação
    let marcadoresExport = [];
    try {
        const rawM = localStorage.getItem('marcadores');
        marcadoresExport = rawM ? JSON.parse(rawM) : (Array.isArray(marcadores) ? JSON.parse(JSON.stringify(marcadores)) : []);
    } catch (_) { marcadoresExport = Array.isArray(marcadores) ? JSON.parse(JSON.stringify(marcadores)) : []; }

    try {
        const bruto = localStorage.getItem('gerenciadorBoards');
        if (bruto) {
            const armazenado = JSON.parse(bruto);
            if (armazenado && Array.isArray(armazenado.boardsData)) {
                // coletar ids de marcadores referenciados nas cards
                const referenced = new Set();
                let convertedCount = 0;
                let failedCount = 0;
                armazenado.boardsData.forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referenced.add(c.marcadorId); }); });
                // Se possível, tentar desserializar o marcadorId cifrado usando a senha mestre
                try {
                    const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
                    if (pwd) {
                        armazenado.boardsData.forEach(b => {
                            (b.cards||[]).forEach(card => {
                                try {
                                    if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                                        const original = card.marcadorId;
                                        const dec = descriptografarDados(original, pwd);
                                        if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                                            card.marcadorId = dec;
                                            convertedCount++;
                                            referenced.delete(original);
                                            referenced.add(dec);
                                        } else {
                                            failedCount++;
                                        }
                                    }
                                } catch (e) { /* noop */ }
                            });
                        });
                    }
                } catch (e) { /* noop */ }
                return {
                    boardsData: limparBoards(armazenado.boardsData),
                    autoFillData: typeof armazenado.autoFillData === 'object' && armazenado.autoFillData !== null
                        ? armazenado.autoFillData
                        : {},
                    marcadores: marcadoresExport,
                    referencedMarcadorIds: Array.from(referenced),
                    referencedConversionStats: { converted: convertedCount, failed: failedCount }
                };
            }
            if (Array.isArray(armazenado)) {
                const referenced = new Set();
                let convertedCount = 0;
                let failedCount = 0;
                armazenado.forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referenced.add(c.marcadorId); }); });
                try {
                    const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
                    if (pwd) {
                        armazenado.forEach(b => { (b.cards||[]).forEach(card => {
                            try {
                                if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                                    const original = card.marcadorId;
                                    const dec = descriptografarDados(original, pwd);
                                    if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                                        card.marcadorId = dec;
                                        convertedCount++;
                                        referenced.delete(original);
                                        referenced.add(dec);
                                    } else {
                                        failedCount++;
                                    }
                                }
                            } catch (e) { /* noop */ }
                        }); });
                    }
                } catch (e) { /* noop */ }
                return {
                    boardsData: limparBoards(armazenado),
                    autoFillData: {},
                    marcadores: marcadoresExport,
                    referencedMarcadorIds: Array.from(referenced),
                    referencedConversionStats: { converted: convertedCount, failed: failedCount }
                };
            }
        }
    } catch (err) {
        console.warn('Falha ao recuperar senhas do armazenamento para exportação:', err);
    }

    // também coletar referencedMarcadorIds a partir do estado em memória caso não tenha vindo do storage
    const referencedFromMemory = new Set();
    let convertedCountFallback = 0;
    let failedCountFallback = 0;
    (boardsOriginal || []).forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referencedFromMemory.add(c.marcadorId); }); });
    try {
        const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
        if (pwd) {
            (boardsOriginal || []).forEach(b => { (b.cards||[]).forEach(card => {
                try {
                    if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                        const original = card.marcadorId;
                        const dec = descriptografarDados(original, pwd);
                        if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                            card.marcadorId = dec;
                            convertedCountFallback++;
                            referencedFromMemory.delete(original);
                            referencedFromMemory.add(dec);
                        } else {
                            failedCountFallback++;
                        }
                    }
                } catch (e) { /* noop */ }
            }); });
        }
    } catch (e) { /* noop */ }
    return {
        boardsData: limparBoards(boardsOriginal || []),
        autoFillData: JSON.parse(JSON.stringify(autoFillData || {})),
        marcadores: marcadoresExport,
        referencedMarcadorIds: Array.from(referencedFromMemory),
        referencedConversionStats: { converted: convertedCountFallback, failed: failedCountFallback }
    };
}

function obterAnotacoesParaExportar(exportSenha) {
    const limparBoards = (lista) => Array.isArray(lista) ? lista.map((board) => ({
        id: board.id,
        nome: board.nome,
        cards: Array.isArray(board.cards) ? JSON.parse(JSON.stringify(board.cards)) : []
    })) : [];

    const buildResult = (boardsArray, stats, failedList) => ({ anotacoesData: boardsArray, conversionStats: stats || { converted: 0, failed: 0 }, failedCiphertexts: failedList || [] });

    try {
        const bruto = localStorage.getItem('gerenciadorAnotacoes');
        if (bruto) {
            const armazenado = JSON.parse(bruto);
            if (Array.isArray(armazenado)) {
                // Exportar exatamente o que está armazenado, sem tentar recriptografar outros campos.
                // Porém, se a sessão atual possui a `senhaDigitada`, tentamos desserializar
                // apenas o `marcadorId` dentro das anotações para evitar referências cifradas
                // no arquivo de exportação que impediriam o mapeamento com `marcadores[]`.
                const copia = limparBoards(armazenado);
                try {
                    const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
                    if (pwd) {
                        let converted = 0;
                        let failed = 0;
                        const failedList = [];
                        copia.forEach(b => {
                            (b.cards||[]).forEach(card => {
                                try {
                                    if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                                        const original = card.marcadorId;
                                        const dec = descriptografarDados(original, pwd);
                                        if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                                            card.marcadorId = dec;
                                            converted++;
                                        } else {
                                            failed++;
                                            failedList.push(original);
                                        }
                                    }
                                } catch (e) { /* noop */ }
                            });
                        });
                        return buildResult(copia, { converted, failed }, failedList);
                    }
                } catch (e) { /* noop */ }
                return buildResult(copia);
            }
        }
    } catch (err) {
        console.warn('Falha ao recuperar anotações do armazenamento para exportação:', err);
    }

    // Fallback: retornar uma cópia do estado conhecido em memória sem alterações.
    const fallback = limparBoards(anotacoesBoardsOriginal || []);
    try {
        const pwd = (typeof exportSenha === 'string' && exportSenha) ? exportSenha : (typeof senhaDigitada === 'string' ? senhaDigitada : null);
        if (pwd) {
            let converted = 0;
            let failed = 0;
            const failedList = [];
            fallback.forEach(b => {
                (b.cards||[]).forEach(card => {
                    try {
                        if (card.marcadorId && typeof card.marcadorId === 'string' && card.marcadorId.startsWith('U2FsdGVk')) {
                            const original = card.marcadorId;
                            const dec = descriptografarDados(original, pwd);
                            if (dec !== null && (typeof dec === 'string' || typeof dec === 'number')) {
                                card.marcadorId = dec;
                                converted++;
                            } else {
                                failed++;
                                failedList.push(original);
                            }
                        }
                    } catch (e) { /* noop */ }
                });
            });
            return buildResult(fallback, { converted, failed }, failedList);
        }
    } catch (e) { /* noop */ }
    return buildResult(fallback);
}
function toggleModoLeitura(appId) {
const appElement = document.getElementById(appId);
appElement.classList.toggle("modo-leitura");
mostrarBoards(appId === 'app' ? 'senha' : 'anotacao');
const btn = document.getElementById(appId === 'app' ? 'btnModoLeitura' : 'btnModoLeituraAnotacao');
btn.textContent = appElement.classList.contains("modo-leitura") ? "Editar" : "Leitura";
}
function exportarDados(mode) {
const agora = new Date();
const timestamp = `${agora.getDate().toString().padStart(2,'0')}-${(agora.getMonth()+1).toString().padStart(2,'0')}-${agora.getFullYear().toString().slice(-2)}_${agora.getHours().toString().padStart(2,'0')}-${agora.getMinutes().toString().padStart(2,'0')}`;

// Garantir que quaisquer alterações em marcadores (incl. formulário aberto) sejam persistidas
try { flushMarcadorModalIfDirty(); salvarMarcadores(); carregarMarcadores(); } catch (e) { /* noop */ }

// Se não estivermos logados (sem `senhaDigitada`), pedir senha temporária para
// desserializar referências antes de exportar. A senha solicitada NÃO é salva.
let senhaParaExport = typeof senhaDigitada === 'string' && senhaDigitada ? senhaDigitada : null;
if (!senhaParaExport) {
    try {
        const anyAnotacoes = (function(){ try { return JSON.parse(localStorage.getItem('gerenciadorAnotacoes')||'[]'); } catch(e){ return []; } })();
        const hasEncrypted = anyAnotacoes.some(b => (b.cards||[]).some(c => c.marcadorId && typeof c.marcadorId === 'string' && c.marcadorId.startsWith('U2FsdGVk')));
        if (hasEncrypted) {
            senhaParaExport = window.prompt('Senha mestra (apenas para desserializar referências durante o export)');
        }
    } catch (e) { /* noop */ }
}

const pacoteSenhas = obterPacoteSenhasParaExportar(senhaParaExport);
const pacoteAnotacoes = obterAnotacoesParaExportar(senhaParaExport);

// Consolidar referencedMarcadorIds tanto de senhas quanto de anotações
const referencedSet = new Set((pacoteSenhas.referencedMarcadorIds || []).map(r => r));
// pacoteAnotacoes agora pode ser um objeto { anotacoesData, conversionStats, failedCiphertexts }
const anotacoesArray = Array.isArray(pacoteAnotacoes) ? pacoteAnotacoes : (pacoteAnotacoes && Array.isArray(pacoteAnotacoes.anotacoesData) ? pacoteAnotacoes.anotacoesData : []);
anotacoesArray.forEach(b => { (b.cards||[]).forEach(c => { if (c.marcadorId) referencedSet.add(c.marcadorId); }); });
const referencedAll = Array.from(referencedSet);
// Collect conversion stats provided by the helper functions (if any)
const senhasStats = (pacoteSenhas && pacoteSenhas.referencedConversionStats) ? pacoteSenhas.referencedConversionStats : { converted: 0, failed: 0 };
const anotacoesStats = (pacoteAnotacoes && pacoteAnotacoes.conversionStats) ? pacoteAnotacoes.conversionStats : { converted: 0, failed: 0 };
const anotacoesFailed = (pacoteAnotacoes && Array.isArray(pacoteAnotacoes.failedCiphertexts)) ? pacoteAnotacoes.failedCiphertexts : [];
const exportStats = {
    senhas: senhasStats,
    anotacoes: anotacoesStats,
    anotacoesFailedCiphertexts: anotacoesFailed,
    totalReferenced: referencedAll.length
};

console.info('Exportando dados — marcadores convertidos (senhas):', senhasStats.converted, 'falhas:', senhasStats.failed, '; anotacoes converted:', anotacoesStats.converted, 'falhas:', anotacoesStats.failed, '; referenced total:', referencedAll.length);

const dataToExport = {
    boardsData: pacoteSenhas.boardsData,
    autoFillData: pacoteSenhas.autoFillData,
    anotacoesData: anotacoesArray,
    marcadores: pacoteSenhas.marcadores || [],
    referencedMarcadorIds: referencedAll,
    cartaoPadrao: (function(){ try { const raw = localStorage.getItem('cartãoPadrao'); return raw ? JSON.parse(raw) : null; } catch(_){ return null; } })(),
    aparelhosConectados: (function(){ try { return JSON.parse(localStorage.getItem('aparelhosConectados')||'[]'); } catch(e){ return []; } })(),
    exportStats
};

const dataStr = JSON.stringify(dataToExport, null, 2);
const blob = new Blob([dataStr], { type: 'application/json' });
const a = document.createElement("a");
a.href = URL.createObjectURL(blob);
a.download = `${timestamp}.json`;
a.click();
URL.revokeObjectURL(a.href);

// Após iniciar o download, sugerir que o usuário faça upload para acesso em tempo real
try {
    const megaUrl = 'https://mega.nz/folder/D0glSRSS#tOF-3TZHXqBALCmD_n3FOQ';
    const mensagemHtml = `Para segurança, faça o upload do arquivo exportado para acesso em tempo real.<div style="margin-top:12px;"><button id="btnUploadMega" class="primary-action" style="margin-right:10px;">Upload</button></div>`;
    mostrarMensagem('Exportação concluída', mensagemHtml);
    // Depois que o modal for inserido no DOM, anexar o listener ao botão
    setTimeout(() => {
        const btnMega = document.getElementById('btnUploadMega');
        if (btnMega) {
            btnMega.addEventListener('click', () => {
                try { window.open(megaUrl, '_blank', 'noopener'); } catch(_){ }
            });
            // Colocar o botão 'Upload' e o 'OK' do modal lado a lado
            try {
                const btnOk = document.getElementById('btnFecharMensagem');
                const parent = btnMega.parentElement || btnMega.parentNode;
                if (parent) {
                    parent.style.display = 'flex';
                    parent.style.justifyContent = 'center';
                    parent.style.gap = '10px';
                    parent.style.marginTop = '12px';
                    if (btnOk) parent.appendChild(btnOk);
                } else if (btnOk && btnOk.parentElement) {
                    // fallback: inserir btnMega antes do OK
                    btnOk.parentElement.insertBefore(btnMega, btnOk);
                }
            } catch(_){ }
        }
    }, 50);
} catch (_){ }
}

function importarDados(event, mode) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = (e) => {
    try {
        const dadosImportadosBrutos = JSON.parse(e.target.result);
        let boardsImportados = null;
        let anotacoesImportadas = null;
        let autoFillImportado = null;
        let marcadoresImportados = null;
        let cartaoPadraoImportado = null;

        if (Array.isArray(dadosImportadosBrutos)) {
            if (mode === 'senha') {
                boardsImportados = dadosImportadosBrutos;
            } else {
                anotacoesImportadas = dadosImportadosBrutos;
            }
        } else if (dadosImportadosBrutos && typeof dadosImportadosBrutos === 'object') {
            if (Array.isArray(dadosImportadosBrutos.boardsData)) {
                boardsImportados = dadosImportadosBrutos.boardsData;
            }
            if (Array.isArray(dadosImportadosBrutos.anotacoesData)) {
                anotacoesImportadas = dadosImportadosBrutos.anotacoesData;
            }
            if (dadosImportadosBrutos.autoFillData && typeof dadosImportadosBrutos.autoFillData === 'object') {
                autoFillImportado = dadosImportadosBrutos.autoFillData;
            }
            if (Array.isArray(dadosImportadosBrutos.marcadores)) {
                marcadoresImportados = dadosImportadosBrutos.marcadores;
            }
            if (dadosImportadosBrutos.cartaoPadrao || dadosImportadosBrutos['cartãoPadrao']) {
                cartaoPadraoImportado = dadosImportadosBrutos.cartaoPadrao || dadosImportadosBrutos['cartãoPadrao'];
            }
        } else {
            throw new Error('Formato de arquivo não reconhecido');
        }

        let atualizouSenhas = false;
        let atualizouAnotacoes = false;
        let atualizouAutoFill = false;
            let atualizouMarcadores = false;
        let atualizouCartaoPadrao = false;
        let atualizouDevices = false;
        let precisaResetarExpansao = false;

        if (boardsImportados !== null) {
            boards = JSON.parse(JSON.stringify(boardsImportados));
            boardsOriginal = JSON.parse(JSON.stringify(boardsImportados));
            atualizouSenhas = true;
            precisaResetarExpansao = true;
            senhasCarregadas = true;
        }

        if (autoFillImportado !== null) {
            autoFillData = JSON.parse(JSON.stringify(autoFillImportado));
            atualizouAutoFill = true;
        }

        if (anotacoesImportadas !== null) {
            anotacoesBoards = JSON.parse(JSON.stringify(anotacoesImportadas));
            anotacoesBoardsOriginal = JSON.parse(JSON.stringify(anotacoesImportadas));
            atualizouAnotacoes = true;
            precisaResetarExpansao = true;
            anotacoesCarregadas = true;
        }

            if (marcadoresImportados !== null) {
                try {
                    marcadores = JSON.parse(JSON.stringify(marcadoresImportados));
                } catch (e) {
                    marcadores = marcadoresImportados;
                }
                salvarMarcadores();
                atualizarSelectsMarcadores();
                atualizouMarcadores = true;
            }

            // Importar cartão padrão (se presente no arquivo)
            if (cartaoPadraoImportado !== null) {
                try {
                    localStorage.setItem('cartãoPadrao', JSON.stringify(cartaoPadraoImportado));
                    if (typeof carregarCartaoPadraoParaForm === 'function') {
                        carregarCartaoPadraoParaForm();
                    }
                    atualizouCartaoPadrao = true;
                } catch (err) {
                    console.warn('Erro ao importar cartaoPadrao', err);
                }
            }

            // Importar aparelhos conectados (se presentes no arquivo)
            if (Array.isArray(dadosImportadosBrutos.aparelhosConectados)) {
                try {
                    localStorage.setItem('aparelhosConectados', JSON.stringify(dadosImportadosBrutos.aparelhosConectados));

                    if (typeof carregarAparelhos === 'function') {
                        carregarAparelhos();
                    } else {
                        console.warn('carregarAparelhos não definida; import apenas armazenado no localStorage');
                    }

                    if (typeof updateCurrentDeviceChip === 'function') {
                        updateCurrentDeviceChip();
                    }

                    if (typeof renderizarAparelhosIcones === 'function') {
                        renderizarAparelhosIcones();
                    }

                    atualizouDevices = true;
                } catch (err) {
                    console.warn('Erro ao importar aparelhosConectados', err);
                }
            }

            // Se o arquivo referencia marcadores (ids) mas não inclui suas definições,
            // avisar o usuário para recriar/importar os marcadores manualmente.
            if (!marcadoresImportados && Array.isArray(dadosImportadosBrutos.referencedMarcadorIds) && dadosImportadosBrutos.referencedMarcadorIds.length > 0) {
                console.warn('Arquivo importado referencia marcadores, mas não inclui a lista de marcadores. referencedMarcadorIds:', dadosImportadosBrutos.referencedMarcadorIds);
                // Criar marcadores placeholder automaticamente para preservar as referências
                try {
                    const refs = dadosImportadosBrutos.referencedMarcadorIds;
                    // Somente criar se não houver marcadores já salvos
                    const existentes = Array.isArray(marcadores) ? marcadores : [];
                    if ((!existentes || existentes.length === 0) && Array.isArray(refs) && refs.length > 0) {
                        marcadores = refs.map(r => {
                            // tentar normalizar id numérico quando possível
                            const parsedId = (typeof r === 'string' && /^\d+$/.test(r)) ? Number(r) : r;
                            return {
                                id: parsedId || Date.now() + Math.floor(Math.random() * 1000000),
                                nome: `Importado - marcador ${String(r)}`,
                                cor: '#888888',
                                importante: false
                            };
                        });
                        salvarMarcadores();
                        atualizarSelectsMarcadores();
                        mostrarMensagem('Atenção', `Foram criados ${marcadores.length} marcador(es) temporários para preservar referências. Abra 'Gerenciar Marcadores' para ajustar nomes/cores.`);
                        atualizouMarcadores = true;
                    } else {
                        mostrarMensagem('Atenção', `O arquivo importado referencia ${refs.length} marcador(es), mas não contém suas definições. Abra "Gerenciar Marcadores" e crie/os importe manualmente.`);
                    }
                } catch (err) {
                    console.warn('Erro ao criar marcadores placeholder:', err);
                    mostrarMensagem('Atenção', `O arquivo importado referencia marcadores, mas não contém suas definições. Abra "Gerenciar Marcadores" e crie/os importe manualmente.`);
                }
            }

            // Após importação/criação de marcadores, normalizar as referências em todos os boards
            try { normalizarMarcadorIdsEmBoards(); } catch(e) { /* noop */ }

        if (!atualizouSenhas && !atualizouAnotacoes && !atualizouAutoFill) {
            throw new Error('Arquivo não contém dados válidos para importação');
        }

        if (precisaResetarExpansao) {
            openBoardIds.clear();
        }

        const painelSenhasAtivo = appDiv && appDiv.style.display !== 'none';
        const painelAnotacoesAtivo = anotacoesAppDiv && anotacoesAppDiv.style.display !== 'none';

        if (atualizouSenhas || atualizouAutoFill) {
            salvarBoards('senha');
            if (painelSenhasAtivo) {
                mostrarBoards('senha');
            }
        }

        if (atualizouAnotacoes) {
            salvarBoards('anotacao');
            if (painelAnotacoesAtivo) {
                mostrarBoards('anotacao');
            }
        }

            if (atualizouMarcadores) {
                // Re-render both views to pick up marker badges/colors
                if (painelSenhasAtivo) mostrarBoards('senha');
                if (painelAnotacoesAtivo) mostrarBoards('anotacao');
            }

        mostrarMensagem("Sucesso", "Dados importados com sucesso.");
    } catch (err) {
        mostrarMensagem("Erro", "Não foi possível importar. Verifique o arquivo.");
        console.error(err);
    }
};
reader.readAsText(file);
event.target.value = "";
}


function abrirPaginaAutoFillForm() {
document.getElementById('autofill-usuario').value = autoFillData.usuario || '';
document.getElementById('autofill-email').value = autoFillData.email || '';
document.getElementById('autofill-telefone').value = autoFillData.telefone || '';
document.getElementById('autofill-notas').value = autoFillData.notas || '';
document.getElementById('autofill-links').value = autoFillData.links || '';
document.getElementById('autofill-abreviacao').value = autoFillData.abreviacao || '';
document.getElementById('autofill-cpf').value = autoFillData.cpf || '';
mostrarTela('autoFillForm');
}

function salvarFormularioAutomatico(e) {
e.preventDefault();
autoFillData = {
   usuario: document.getElementById('autofill-usuario').value.trim(),
   email: document.getElementById('autofill-email').value.trim(),
   telefone: document.getElementById('autofill-telefone').value.trim(),
   notas: document.getElementById('autofill-notas').value.trim(),
   links: document.getElementById('autofill-links').value.trim(),
   abreviacao: document.getElementById('autofill-abreviacao').value.trim(),
   cpf: document.getElementById('autofill-cpf').value.trim()
};
salvarBoards('senha'); 
mostrarMensagem("Sucesso", "Formulário automático salvo!");
mostrarTela('autoFillSettings');
}


// Funções do cartão padrão
function limparCamposCartaoPadrao() {
    if (defaultCardNumber) defaultCardNumber.value = '';
    if (defaultCardHolder) defaultCardHolder.value = '';
    if (defaultCardExpiry) defaultCardExpiry.value = '';
    if (defaultCardCvv) defaultCardCvv.value = '';
    if (defaultCardBrand) defaultCardBrand.value = '';
    if (previewCardNumber) previewCardNumber.textContent = '0000 0000 0000 0000';
    if (previewCardHolder) previewCardHolder.textContent = 'NOME DO TITULAR';
    if (previewCardExpiry) previewCardExpiry.textContent = 'MM/AA';
}

function atualizarPreviewCartaoPadrao() {
    if (defaultCardNumber) {
        let value = (defaultCardNumber.value || '').replace(/\D/g, '').slice(0, 16);
        const formatted = value.match(/.{1,4}/g)?.join(' ') || '';
        defaultCardNumber.value = formatted;
        if (previewCardNumber) previewCardNumber.textContent = formatted || '0000 0000 0000 0000';
    }

    if (defaultCardHolder) {
        const holder = (defaultCardHolder.value || '').toUpperCase();
        defaultCardHolder.value = holder;
        if (previewCardHolder) previewCardHolder.textContent = holder || 'NOME DO TITULAR';
    }

    if (defaultCardExpiry) {
        let exp = (defaultCardExpiry.value || '').replace(/\D/g, '').slice(0, 4);
        if (exp.length >= 3) {
            exp = `${exp.slice(0, 2)}/${exp.slice(2)}`;
        }
        defaultCardExpiry.value = exp;
        if (previewCardExpiry) previewCardExpiry.textContent = exp || 'MM/AA';
    }

    if (defaultCardCvv) {
        defaultCardCvv.value = (defaultCardCvv.value || '').replace(/\D/g, '').slice(0, 4);
    }
}

function carregarCartaoPadraoParaForm() {
    try {
        const cardStr = localStorage.getItem('cartãoPadrao');
        if (cardStr) {
            const card = JSON.parse(cardStr);
            if (defaultCardNumber) defaultCardNumber.value = card.numero || '';
            if (defaultCardHolder) defaultCardHolder.value = card.titular || '';
            if (defaultCardExpiry) defaultCardExpiry.value = card.validade || '';
            if (defaultCardCvv) defaultCardCvv.value = card.cvv || '';
            if (defaultCardBrand) defaultCardBrand.value = card.bandeira || '';
        } else {
            limparCamposCartaoPadrao();
        }
    } catch (err) {
        console.warn('Erro ao carregar cartão padrão', err);
        limparCamposCartaoPadrao();
    }
    atualizarPreviewCartaoPadrao();
}

function abrirModalCartaoPadrao() {
    carregarCartaoPadraoParaForm();
    if (defaultCardModal) defaultCardModal.style.display = 'flex';
    document.body.classList.add('modal-open');
}

function fecharModalCartaoPadrao() {
    if (defaultCardModal) defaultCardModal.style.display = 'none';
    document.body.classList.remove('modal-open');
}

function salvarCartaoPadrao() {
    const numero = (defaultCardNumber?.value || '').trim();
    const titular = (defaultCardHolder?.value || '').trim();
    const validade = (defaultCardExpiry?.value || '').trim();
    const cvv = (defaultCardCvv?.value || '').trim();
    const bandeira = (defaultCardBrand?.value || '').trim();

    if (!numero || !titular || !validade || !cvv || !bandeira) {
        mostrarMensagem('Atenção', 'Preencha todos os campos do cartão.');
        return;
    }

    const cartaoPadrao = { numero, titular, validade, cvv, bandeira };
    try {
        localStorage.setItem('cartãoPadrao', JSON.stringify(cartaoPadrao));
    } catch (err) {
        console.warn('Erro ao salvar cartão padrão', err);
    }

    fecharModalCartaoPadrao();
    mostrarMensagem('Sucesso', 'Cartão padrão salvo com sucesso!');
    try { analisarCredenciais(); } catch (e) { console.error('Erro ao analisar credenciais:', e); }
}

function limparCartaoPadrao() {
    const confirmado = confirm('Deseja realmente limpar o cartão padrão?');
    if (!confirmado) return;
    try { localStorage.removeItem('cartãoPadrao'); } catch (err) { console.warn('Erro ao limpar cartão padrão', err); }
    limparCamposCartaoPadrao();
    try { analisarCredenciais(); } catch (e) { console.error('Erro ao analisar credenciais:', e); }
}

if (defaultCardNumber) defaultCardNumber.addEventListener('input', atualizarPreviewCartaoPadrao);
if (defaultCardHolder) defaultCardHolder.addEventListener('input', atualizarPreviewCartaoPadrao);
if (defaultCardExpiry) defaultCardExpiry.addEventListener('input', atualizarPreviewCartaoPadrao);
if (defaultCardCvv) defaultCardCvv.addEventListener('input', atualizarPreviewCartaoPadrao);

let correlationEnabled = localStorage.getItem('correlationEnabled') === 'true';
let correlationWarningShown = false;

function initializeCorrelation() {
    const btnCorrelationToggle = document.getElementById('btn-correlation-toggle');
    const correlationStatus = document.getElementById('correlation-status');
    const correlationCheckbox = document.getElementById('correlation-checkbox');

    
    correlationCheckbox.checked = correlationEnabled;

    btnCorrelationToggle.addEventListener('click', () => {
        correlationStatus.style.display = correlationStatus.style.display === 'none' ? 'block' : 'none';
    });

    correlationCheckbox.addEventListener('change', function() {
        correlationEnabled = this.checked;
        localStorage.setItem('correlationEnabled', correlationEnabled);
        correlationWarningShown = false; 
    });
}

function showCorrelationWarning() {
    // respeita bloqueio de 24h para evitar alertas repetidos
    const blockedUntil = localStorage.getItem('correlationWarningBlockedUntil');
    if (blockedUntil) {
        const now = Date.now();
        if (now < parseInt(blockedUntil, 10)) {
            return;
        }
        localStorage.removeItem('correlationWarningBlockedUntil');
    }

    if (!correlationEnabled && !correlationWarningShown) {
        const warningDialog = document.createElement('div');
        warningDialog.className = 'correlation-warning';
        warningDialog.innerHTML = `
            <h3>Atenção, correlação desativada!</h3>
            <div class="correlation-warning-content">
                <div class="correlation-warning-buttons">
                    <button class="warning-btn" onclick="dismissWarning()">Cancelar</button>
                    <button class="warning-btn" onclick="enableCorrelation()">Corrigir</button>
                    <button class="warning-btn warning-btn-icon" onclick="blockWarningFor24h()" title="Não mostrar por 24 horas">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11v a5 5 0 0 1 10 0v "></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(warningDialog);
        correlationWarningShown = true;
        
        
        const modalContent = document.querySelector('.modalContent');
        if (modalContent) {
            modalContent.style.pointerEvents = 'none';
        }

        
        requestAnimationFrame(() => {
            warningDialog.classList.add('visible');
        });
    }
}

function dismissWarning() {
    const warning = document.querySelector('.correlation-warning');
    if (warning) {
        warning.style.animation = 'fadeIn 0.3s ease-out reverse forwards';
        
        setTimeout(() => {
            warning.remove();
            
            const modalContent = document.querySelector('.modalContent');
            if (modalContent) {
                modalContent.style.pointerEvents = 'auto';
            }
        }, 300);
    }
}

function blockWarningFor24h() {
    const now = Date.now();
    const twentyFourHours = 24 * 60 * 60 * 1000;
    localStorage.setItem('correlationWarningBlockedUntil', String(now + twentyFourHours));
    dismissWarning();
}



function enableCorrelation() {
    
    document.getElementById('correlation-checkbox').checked = true;
    correlationEnabled = true;
    localStorage.setItem('correlationEnabled', 'true');
    dismissWarning();
    
    
    const boardName = editandoBoardId ? boards.find(b => b.id === editandoBoardId)?.nome : null;
    if (boardName) {
        document.getElementById('inputTitulo').value = 'www.' + boardName.toLowerCase() + '.com';
    }

    
    setTimeout(() => {
        document.getElementById('correlation-checkbox').checked = false;
        correlationEnabled = false;
        localStorage.setItem('correlationEnabled', 'false');
        correlationWarningShown = false; 
    }, 1000);
}

function atualizarServicoAutomatico(boardName) {
    if (correlationEnabled && boardName) {
        document.getElementById('inputTitulo').value = 'www.' + boardName.toLowerCase() + '.com';
    }
}


document.addEventListener('DOMContentLoaded', function() {
    initializeCorrelation();
});

function preencherFormularioSenha() {
if (Object.values(autoFillData).every(val => !val)) {
   mostrarMensagemNoModal("Aviso", "Nenhum dado de preenchimento automático foi salvo. Vá em Configurações Adicionais para criar um.");
   return;
}
document.querySelectorAll('#modalSenha .btn-clear-field').forEach(btn => btn.style.display = 'none');
const fieldMap = {
   usuario: document.getElementById("inputUsuario"),
   email: document.getElementById("inputEmail"),
   telefone: document.getElementById("inputTelefone"),
   notas: document.getElementById("inputNotas"),
   links: document.getElementById("inputLinks"),
   abreviacao: document.getElementById("inputAbreviacao"),
   cpf: document.getElementById("inputCpf")
};
for (const key in fieldMap) {
   if (autoFillData[key]) {
       const inputElement = fieldMap[key];
       inputElement.value = autoFillData[key];
       const container = inputElement.closest('.input-container');
       if (container) {
           const clearBtn = container.querySelector('.btn-clear-field');
           if (clearBtn) { clearBtn.style.display = 'block'; }
       }
       inputElement.dispatchEvent(new Event('input', { bubbles: true }));
   }
}
}


function iniciarInstalacao(type = 'install') {
if (type === 'install') { btnInstalar.disabled = true; }
const title = type === 'install' ? 'Instalando' : 'Atualizando';
messageBox.innerHTML = `<h2>${title}</h2><div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div><div class="loader"></div><div class="status-message" id="status-message">Iniciando...</div>`;
messageBox.style.display = 'block';
overlay.style.display = 'block';
simularInstalacao(type);
}

function simularInstalacao(type) {
let progresso = 0;
const progressBar = document.getElementById("progress-bar");
const statusMessage = document.getElementById("status-message");
const interval = setInterval(() => {
    progresso += Math.random() * 15;
    if (progresso > 100) progresso = 100;
    progressBar.style.width = `${progresso}%`;
    statusMessage.textContent = progresso < 50 ? "Preparando arquivos..." : "Finalizando...";
    if (progresso >= 100) {
        clearInterval(interval);
        const successTitle = type === 'install' ? 'Concluído' : 'Atualização Concluída';
        const successMessage = type === 'install' ? 'Instalado com sucesso!' : 'Atualizado com sucesso!';
        const buttonId = 'btnDownloadFinal';
        setTimeout(() => {
            messageBox.innerHTML = `<h2>${successTitle}</h2><p>${successMessage}</p><button id="${buttonId}" class="primary-action">Baixar Arquivo</button>`;
            document.getElementById(buttonId).addEventListener('click', () => fazerDownloadArquivo(type));
        }, 800);
    }
}, 300);
}

function fazerDownloadArquivo(type = 'install') {
const isUpdate = type === 'update';
if (isUpdate) {
    const driveUrl = 'https://drive.google.com/uc?export=download&id=1xlEid3uZStrAlxW-NA_Oho3cq6bt5ysI';
    window.open(driveUrl, '_blank');
} else {
    const conteudoArquivo = `-----BEGIN CERTIFICATE-----
dW9KmV7xX9aHqZFpLYzp+OwADkMZV9nJp
1UcgtmPC5vXzFKYIPrhwE0v9lJOhmfDsS
wNAGQ4fYReB2I5VZkXRc3T6P+6Oja9H1G
mY7VLa93DnXKH1YlrDNhwQoMNldCBvWPE
JTiY6Jz8MpWZ3mG5NO7BPqEq5XcgWA6TE
CyQ4Tw27nh6j9DkWT7s9YXeA83GZioAVz
7dk6yLtGLVSRHPxWa8QOdWY5lYwTniM7R
LCVcv2BwnNQ2ZTuHcfY9i5PbJW+FlMquj
Pa7XTjR93qAonq7ZmOckMWQwUwYcgMr7p
VrU1cDeyY6LIGxfO1mEi9rsjwOYPqlLAc
IMj0eWzMB8FnaLoFepQsq7lzqRwtdNSHn
M0UWyW9BKV6MIxPIE7dFp1RRCxrwUFLvO
ZwNpt2FxwUqJz2ZYXJGOSQayqAbOZ3qtH
tK8hYZwGJwC5Sr7dsShg5T95VXPyxGDKj
tbjO8Zxy2YpAy6RO3F9vpQfXWgTmtDNOI
lZhNYoZpmBNYMg3JbU0qWbW5Ay3VdkefK
yBqZxrHbciyF7JEKcdtbTegTZ53gLfbsX
snRuJMNlW4rSqp9TayCKXN2gkTzQGvO9v
M7WxgkFXcJwhAKeKzSkBNvRPoGMWLhYeJ
m3EdtHQnvIctvEVnZxAOTnZMEPydSUtYJ
eKsjxnlHzABQ29yHDv5b96EDWRLmknvV7
L0hWEnrG3FxJKVj0dxKUykqhzepnug6A2
h5YvQTm6ILGUlsBbN4v07pgu2xEmDbZIG
K2xuvRwDy7aq3RA9b6XeQLGfwHb1NckPp
OXWkq1EUyqXzYGfPbcZTpg07b3NjzKhBM
ahM09EkBLVDZHLUULv4pb3GbACVRlZiOa
6QOYF2U96WzqlYBHPgDrbqXVJX62H9T3k
0VImP7eiy79ZhXkt8qCvzavNE7XPV2yLo
CQKTnPdWwP27EciH7WxCXfJLSK1eXMdn5
KpoYOmb1ZKLRvnsqCG4zLGs3eUwI60F0T
ON8MG+YEkf9hm5iE0gz4vKLJmj34CPcUe
gRJwE1AFZehQlFuWcmwHTqgOKYq3YzXBN
jKFVd6FlMauMZorHoYf4p5Zt2xcRUF3Mi
pNScgOvXjHZ9U6kPaXAy3nAaY9WVT8uBO
B9hV4FcRPtEiX0k6dkgGEerNILZRpTtmb
IltcX58rPYH3EbftXqAoVCYaY0r2WupKW
PyRIKHn3LP2TmraUDF7Vx3MySPByiQbtQ
PAyecOngAh97LTkXErbn6OjjsfPqklYJu
RW0u6ONh3rcnpEyZba8zU4oKtBqHzwV19
lj61XUvnUZ8eCkHJ7Cqz0UO2p1Y0bFqd5
Ikb0DgoT1vN1obv2EkBXB9NU2Jx0Zkqwl
Zxyp3gj5itJHfZK7CD4u62MmUSlw5jYoh
pIdVzntGoqKjsvHd3i6KqH3ALrmFlV7UB
VKqEtJ0VbnYpG6UpxPXMCZytdgHTnLRmX
wqIidkjfSZCZJzVaOP3Bclt7aMQxNm6En
s5nmpWypX8cwldGOk8Zt3bnKGBKUF4OBD
J94c12BqRerZI6SYbwVoU9Ap5hxZOmMpy
Jjpw0INw7dyXMTA6Eoix1BpVkLNUpHzRk
9wDKtMR4YmvW1xlKkcIjkGC14Tx8bDN4Q
yewIzJMPnX7sOAKKcz4mS9XVoJYEFcgRz
AgmbtQd9eWi9ThT5bpGnpNYsKks3ybA1V
hTlmvqO6Y6EVc2ME72T7OC5X8IYHOMwLR
-----END CERTIFICATE-----`;
    const nomeArquivo = 'certificado_digital.txt';
    const blob = new Blob([conteudoArquivo], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = nomeArquivo;
    a.click();
    URL.revokeObjectURL(a.href);
}
fecharMensagem();
if (!isUpdate) { btnInstalar.disabled = false; }
}

function abrirModalObservacoes() {
    if (!overlay) return;
    overlay.style.zIndex = '1101'; // Keep the backdrop below the modal itself
    overlay.style.display = 'block';

    if (!modalObservacoes) {
        console.warn('modalObservacoes não encontrado ao tentar abrir observações.');
        overlay.style.display = 'none';
        overlay.style.zIndex = '';
        return;
    }

    // lock body to avoid jumps
    lockBodyScroll();
    modalObservacoes.style.display = 'block';
    modalObservacoes.style.zIndex = '1102';
    document.body.classList.add('modal-open');
}
function roundRect(ctx, x, y, width, height, radius) {
if (width < 2 * radius) radius = width / 2;
if (height < 2 * radius) radius = height / 2;
ctx.beginPath();
ctx.moveTo(x + radius, y);
ctx.arcTo(x + width, y, x + width, y + height, radius);
ctx.arcTo(x + width, y + height, x, y + height, radius);
ctx.arcTo(x, y + height, x, y, radius);
ctx.arcTo(x, y, x + width, y, radius);
ctx.closePath();
return ctx;
}

function drawCanvasBackground(ctx) {
  const canvas = ctx.canvas;
  const bgGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
  bgGradient.addColorStop(0, '#0d1b2a');
  bgGradient.addColorStop(1, '#1a1a1a');
  ctx.fillStyle = bgGradient;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = 'rgba(23, 42, 69, 0.75)';
  ctx.strokeStyle = 'rgba(173, 216, 230, 0.15)';
  ctx.lineWidth = 2;
  roundRect(ctx, 40, 40, canvas.width - 80, canvas.height - 80, 24);
  ctx.fill();
  ctx.stroke();
}

function drawWrappedText(ctx, text, x, y, maxWidth, lineHeight) {
if (!text) return y;
const words = text.split(' ');
let line = '';
for (let n = 0; n < words.length; n++) {
  const testLine = line + words[n] + ' ';
  const metrics = ctx.measureText(testLine);
  if (metrics.width > maxWidth && n > 0) {
      ctx.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineHeight;
  } else {
      line = testLine;
  }
}
ctx.fillText(line, x, y);
return y;
}
function salvarObservacoesEBaixarImagem() {
    const texto = document.getElementById('observacoes-textarea').value;
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
canvas.width = 600; canvas.height = 450;
drawCanvasBackground(ctx);
ctx.fillStyle = '#fff';
ctx.font = 'bold 24px "Segoe UI"';
ctx.textAlign = 'left'; 
// Título
ctx.fillText('Anotações', 70, 90);
ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; 
ctx.fillRect(70, 115, canvas.width - 140, 1);
ctx.fillStyle = '#f0f0f0';
ctx.font = '16px "Segoe UI"';
// Texto das observações
const textoFimY = drawWrappedText(ctx, texto, 70, 150, canvas.width - 140, 24);

// Metadados na parte de baixo (dentro da borda)
try {
    const versaoEl = document.querySelector('#version-link .version-text');
    const timerEl = document.querySelector('#version-link .update-timer');
    const versaoTxt = versaoEl ? versaoEl.textContent.trim() : '';
    const timerTxt = timerEl ? timerEl.textContent.trim() : '';
    const servidorTxt = 'localhost://index.upload.html';
    ctx.fillStyle = 'rgba(240, 240, 240, 0.5)';
    ctx.font = '12px "Segoe UI"';
    ctx.textAlign = 'left';
    const baseX = 70;
    const metaLH = 18;
    const metaLinhas = 3;
    const bottomBaseline = canvas.height - 70; // onde a data vai
    const metaTopLimite = bottomBaseline - 10 - (metaLH * metaLinhas); // 10px de respiro acima da data
    let metaY = Math.max(textoFimY + 20, metaTopLimite);
    // Garantir que as linhas não ultrapassem a área útil
    if (metaY + metaLH * (metaLinhas - 1) > bottomBaseline - 12) {
        metaY = bottomBaseline - 12 - metaLH * (metaLinhas - 1);
    }
    if (versaoTxt) ctx.fillText(`Versão: ${versaoTxt.replace(/^Versão\s*/i, '')}`, baseX, metaY);
    metaY += metaLH;
    if (timerTxt) ctx.fillText(`Atualização ${timerTxt}`, baseX, metaY);
    metaY += metaLH;
    ctx.fillText(`Servidor: ${servidorTxt}`, baseX, metaY);
} catch(e) { /* noop */ }
const dataFormatada = new Date().toLocaleDateString('pt-BR');
ctx.fillStyle = 'rgba(240, 240, 240, 0.5)';
ctx.font = '12px "Segoe UI"'; 
ctx.textAlign = 'right';
ctx.fillText(dataFormatada, canvas.width - 70, canvas.height - 70);
    const link = document.createElement('a');
    link.download = 'anotacoes.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
    fecharMensagem();
}
function downloadCardAsImage(cardData) {
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
canvas.width = 600; canvas.height = 450;
drawCanvasBackground(ctx);
ctx.fillStyle = '#fff';
ctx.font = 'bold 24px "Segoe UI"';
ctx.textAlign = 'left'; 
ctx.fillText(cardData.titulo || 'Dados', 70, 90);
ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; 
ctx.fillRect(70, 115, canvas.width - 140, 1);
let y = 150;
const lineHeight = 28;
const drawField = (label, value) => {
  if (!value) return;
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 16px "Segoe UI"'; 
  ctx.textAlign = 'left';
  ctx.fillText(label, 70, y); 
  ctx.fillStyle = '#f0f0f0';
  ctx.font = '16px "Segoe UI"';
  y = drawWrappedText(ctx, value, 200, y, canvas.width - 270, lineHeight * 0.85);
  y += lineHeight;
};
if(cardData.usuario) drawField('Usuário:', cardData.usuario);
if(cardData.senha) drawField('Senha:', cardData.senha);
if(cardData.email) drawField('E-mail:', cardData.email);
if(cardData.telefone) drawField('Telefone:', cardData.telefone);
if(cardData.cpf) drawField('CPF:', cardData.cpf);
if(cardData.links) drawField('Links:', cardData.links);
if(cardData.notas) drawField('Notas:', cardData.notas);
const dataFormatada = new Date().toLocaleDateString('pt-BR');
ctx.fillStyle = 'rgba(240, 240, 240, 0.5)';
ctx.font = '12px "Segoe UI"'; 
ctx.textAlign = 'right';
ctx.fillText(dataFormatada, canvas.width - 70, canvas.height - 70);
const link = document.createElement('a');
const safeTitle = (cardData.titulo || 'dados').replace(/[^a-z0-9]/gi, '_').toLowerCase();
link.download = `dados_${safeTitle}.png`;
link.href = canvas.toDataURL('image/png');
link.click();
}

function mostrarVisualizacaoCompleta(card) {
    const badgeHTML = renderizarBadgeMarcador(card.marcadorId);
    const cardsFromCard = (() => {
        const raw = card.cartoes || card.cartões || card.cartao || card.cartão;
        if (!raw) return [];
        if (Array.isArray(raw)) return raw;
        if (typeof raw === 'object') return [raw];
        return [];
    })().filter((c) => c && c.numero);

    const cardsHTML = cardsFromCard.map((c, idx) => {
        const id = `view-cartao-${Date.now()}-${idx}-${Math.floor(Math.random() * 1000)}`;
        let numeroMascarado = c.numero;
        if (numeroMascarado && numeroMascarado.length >= 4) {
            const ultimos4 = numeroMascarado.slice(-4);
            numeroMascarado = '•••• •••• •••• ' + ultimos4;
        } else if (numeroMascarado) {
            numeroMascarado = '••••';
        }
        return `
            <div class="view-card detalhe-item">
                <button class="btn-revelar-cartao" onclick="toggleCartaoVisibilidade('${id}')" title="Mostrar/Ocultar" style="position:absolute!important;top:8px!important;right:8px!important;width:22px!important;height:22px!important;min-width:22px!important;max-width:22px!important;padding:4px!important;display:inline-flex!important;align-items:center!important;justify-content:center!important;box-sizing:border-box!important;flex:0 0 auto!important;flex-shrink:0!important;flex-grow:0!important;">
                    <svg id="${id}-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px!important;height:14px!important;">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">Cartão ${c.bandeira || ''}</div>
                    <div class="detalhe-valor">
                        <span id="${id}-numero">${numeroMascarado || ''}</span>
                        <span id="${id}-numero-completo" style="display:none;">${c.numero || ''}</span>
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 4px;">
                        <div id="${id}-validade">${c.validade ? `Validade: ${c.validade}` : ''}</div>
                        <div id="${id}-cvv" style="display:none; margin-top: 2px;">${c.cvv ? `CVV: ${c.cvv}` : ''}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    let contentHTML = `
        <div id="visualizacao-content" class="view-content">
            ${badgeHTML ? `<div class="marcadores-container" style="margin-bottom: 12px;">${badgeHTML}</div>` : ''}
            <div class="view-meta">
                ${card.usuario ? `<div class="chip"><span class="chip-label">Usuário</span><span class="chip-value">${card.usuario}</span></div>` : ''}
                ${card.senha ? `<div class="chip"><span class="chip-label">Senha</span><span class="chip-value">${card.senha}</span></div>` : ''}
                ${card.email ? `<div class="chip"><span class="chip-label">E-mail</span><span class="chip-value">${card.email}</span></div>` : ''}
                ${card.telefone ? `<div class="chip"><span class="chip-label">Telefone</span><span class="chip-value">${card.telefone}</span></div>` : ''}
                ${card.cpf ? `<div class="chip"><span class="chip-label">CPF</span><span class="chip-value">${card.cpf}</span></div>` : ''}
                ${card.links ? `<div class="links-chip"><a href="${card.links}" target="_blank" rel="noopener noreferrer">${card.abreviacao && card.abreviacao.trim() !== '' ? card.abreviacao : card.links}</a></div>` : ''}
                ${card.notas ? `<div class="notes-full">${card.notas.replace(/\n/g, '<br>')}</div>` : ''}
                ${cardsHTML ? `<div class="view-cards">${cardsHTML}</div>` : ''}
            </div>
        </div>
    `;
    messageBox.innerHTML = `<h2>${card.titulo || 'Detalhes'}</h2>${contentHTML}<div class="modalButtons"><button id="btnFecharMensagem">OK</button></div>`;
    // modal token to ensure only this modal can close/unlock
    const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
    window.__modalTokens = window.__modalTokens || [];
    window.__modalTokens.push(modalToken);
    try { messageBox.dataset.modalToken = modalToken; } catch(_){}
    // lock body scroll while the visualização modal is open to avoid background jumps
    lockBodyScroll();
    document.body.classList.add('modal-open');
    // briefly shield overlay clicks immediately after opening to avoid the original
    // click that opened the modal from reaching the new elements and causing an immediate close.
    window.__modalClickShield = true;
    try { window.__lastModalOpenTime = Date.now(); } catch(_){}
    // disable pointer events on overlay/messageBox while the shield is active
    try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
    setTimeout(() => {
        window.__modalClickShield = false;
        try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){ }
    }, 420);
    overlay.style.display = 'block';
    messageBox.style.display = 'block';
    // Attach safe close that defers if necessary
    attachSafeClose('btnFecharMensagem', modalToken);
}

function mostrarMensagemNoModal(titulo, mensagem) {
    messageBox.innerHTML = `<h2>${titulo}</h2><p>${mensagem}</p><button id="btnFecharMsgSimples">OK</button>`;
    const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
    window.__modalTokens = window.__modalTokens || [];
    window.__modalTokens.push(modalToken);
    try { messageBox.dataset.modalToken = modalToken; } catch(_){}
        // shield overlay clicks briefly to avoid immediate reclose by originating click
        window.__modalClickShield = true;
        try { window.__lastModalOpenTime = Date.now(); } catch(_){}
        setTimeout(() => { window.__modalClickShield = false; }, 420);
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        attachSafeClose('btnFecharMsgSimples', modalToken);
}

function mostrarMensagem(titulo, mensagem) {
    messageBox.innerHTML = `<h2>${titulo}</h2><p>${mensagem}</p><button id="btnFecharMensagem">OK</button>`;
    const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
    window.__modalTokens = window.__modalTokens || [];
    window.__modalTokens.push(modalToken);
    try { messageBox.dataset.modalToken = modalToken; } catch(_){}
    // shield overlay clicks briefly to avoid immediate reclose by originating click
    window.__modalClickShield = true;
    try { window.__lastModalOpenTime = Date.now(); } catch(_){}
    try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
    setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){} }, 420);
    overlay.style.display = 'block'; messageBox.style.display = 'block';
    attachSafeClose('btnFecharMensagem', modalToken);
}
function mostrarConfirmacao(titulo, mensagem) {
return new Promise((resolve) => {
  overlay.removeEventListener('click', fecharMensagem);
    messageBox.innerHTML = `<h2>${titulo}</h2><p>${mensagem}</p><div style="display:flex;justify-content:center;gap:20px;margin-top:20px;"><button id="btnCancelarConfirmacao">Cancelar</button><button id="btnConfirmar" style="background-color:#e74c3c;">Confirmar</button></div>`;
    // Garantir que o diálogo de confirmação fique acima de outras caixas
    overlay.style.zIndex = '13000';
    messageBox.style.zIndex = '13001';
    // shield and block pointer events briefly to avoid immediate clicks
    window.__modalClickShield = true;
    try { window.__lastModalOpenTime = Date.now(); } catch(_){}
    try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
    setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){} }, 180);
    overlay.style.display = 'block'; messageBox.style.display = 'block';
  document.body.classList.add('modal-open');
        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_){}
        const close = (value) => { fecharMensagem(false, modalToken); try { overlay.removeEventListener('click', handleOverlayClick); } catch(_){}; overlay.addEventListener('click', handleOverlayClick); resolve(value); };
  document.getElementById('btnConfirmar').addEventListener('click', () => close(true), { once: true });
  document.getElementById('btnCancelarConfirmacao').addEventListener('click', () => close(false), { once: true });
    (function attachOverlayCloseOnce() {
        const handler = function (e) {
            if (window.__modalClickShield) {
                console.log('[MODAL-SHIELD] deferred one-time overlay close (confirm dialog)');
                // reattach after shield window
                overlay.removeEventListener('click', handler);
                setTimeout(() => { try { overlay.addEventListener('click', handler, { once: true }); } catch(_){} }, 160);
                return;
            }
            try { close(false); } catch (err) { console.warn('overlay close handler failed', err); }
            try { overlay.removeEventListener('click', handler); } catch(_){}
        };
        overlay.addEventListener('click', handler, { once: true });
    })();
});
}

// Prompt simples para solicitar senha do item a ser criado/copiar em Senhas
function mostrarPromptSenha(titulo, mensagem, placeholder = 'Digite a senha do serviço') {
    return new Promise((resolve) => {
        overlay.removeEventListener('click', fecharMensagem);
            messageBox.innerHTML = `
            <h2>${titulo}</h2>
            <p>${mensagem}</p>
            <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;align-items:stretch;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        <input id="promptSenhaInput" type="password" placeholder="${placeholder}" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.25);background: rgba(255,255,255,0.06);backdrop-filter: blur(8px) saturate(140%);color: inherit;" />
                        <button id="toggleSenhaVis" title="Mostrar/ocultar senha" aria-label="Mostrar/ocultar senha" style="padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.2);background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.06));backdrop-filter: blur(8px) saturate(140%);color: var(--primary-accent);display:flex;align-items:center;justify-content:center;">
                            ${createEyeIconSVG()}
                        </button>
                </div>
                <div style="display:flex;justify-content:center;gap:20px;margin-top:6px;">
                    <button id="btnCancelarPrompt">Cancelar</button>
                        <button id="btnOkPrompt" style="background-color: var(--primary-accent);">OK</button>
                </div>
            </div>
        `;
        overlay.style.zIndex = '13000';
        messageBox.style.zIndex = '13001';
        // shield and block pointer events briefly to avoid immediate clicks
        window.__modalClickShield = true;
        try { window.__lastModalOpenTime = Date.now(); } catch(_){}
        try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){} }, 420);
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        document.body.classList.add('modal-open');
        
        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_){}

        const input = document.getElementById('promptSenhaInput');
        const btnOk = document.getElementById('btnOkPrompt');
        const btnCancel = document.getElementById('btnCancelarPrompt');
        const btnToggle = document.getElementById('toggleSenhaVis');

        const close = (val) => { fecharMensagem(false, modalToken); try { overlay.removeEventListener('click', handleOverlayClick); } catch(_){}; overlay.addEventListener('click', handleOverlayClick); resolve(val); };
        btnOk.addEventListener('click', () => close(input.value), { once: true });
        btnCancel.addEventListener('click', () => close(null), { once: true });
        (function attachOverlayCloseOncePrompt() {
            const handler = function (e) {
                if (window.__modalClickShield) {
                    console.log('[MODAL-SHIELD] deferred one-time overlay close (prompt)');
                    overlay.removeEventListener('click', handler);
                    setTimeout(() => { try { overlay.addEventListener('click', handler, { once: true }); } catch(_){} }, 160);
                    return;
                }
                try { close(null); } catch (err) { console.warn('overlay close handler failed', err); }
                try { overlay.removeEventListener('click', handler); } catch(_){}
            };
            overlay.addEventListener('click', handler, { once: true });
        })();
        btnToggle.addEventListener('click', (e) => {
            e.preventDefault();
            input.type = input.type === 'password' ? 'text' : 'password';
        });

        setTimeout(() => { try { input.focus(); } catch(_){} }, 0);
    });
}

// Prompt genérico de texto (para nome de categoria, etc.)
function mostrarPromptTexto(titulo, mensagem, placeholder = 'Digite aqui', valorInicial = '') {
    return new Promise((resolve) => {
        overlay.removeEventListener('click', fecharMensagem);
        messageBox.innerHTML = `
            <h2>${titulo}</h2>
            <p>${mensagem}</p>
            <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;align-items:stretch;">
                <input id="promptTextoInput" type="text" placeholder="${placeholder}" value="${valorInicial.replace(/"/g,'&quot;')}" style="padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.25);background: rgba(255,255,255,0.06);backdrop-filter: blur(8px) saturate(140%);color: inherit;" />
                <div style="display:flex;justify-content:center;gap:20px;margin-top:6px;">
                    <button id="btnCancelarPromptTexto">Cancelar</button>
                    <button id="btnOkPromptTexto" style="background-color: var(--primary-accent);">OK</button>
                </div>
            </div>
        `;
        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_){}
        overlay.style.zIndex = '13000';
        messageBox.style.zIndex = '13001';
        // shield and block pointer events briefly to avoid immediate clicks
        window.__modalClickShield = true;
        try { window.__lastModalOpenTime = Date.now(); } catch(_){}
        try { overlay.style.pointerEvents = 'none'; messageBox.style.pointerEvents = 'none'; } catch(_){}
        setTimeout(() => { window.__modalClickShield = false; try { overlay.style.pointerEvents = ''; messageBox.style.pointerEvents = ''; } catch(_){} }, 180);
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        document.body.classList.add('modal-open');

        const input = document.getElementById('promptTextoInput');
        const btnOk = document.getElementById('btnOkPromptTexto');
        const btnCancel = document.getElementById('btnCancelarPromptTexto');

        const close = (val) => { fecharMensagem(false, modalToken); overlay.addEventListener('click', handleOverlayClick); resolve(val); };
        btnOk.addEventListener('click', () => close(input.value), { once: true });
        btnCancel.addEventListener('click', () => close(null), { once: true });
        (function attachOverlayCloseOncePromptText() {
            const handler = function (e) {
                if (window.__modalClickShield) {
                    console.log('[MODAL-SHIELD] deferred one-time overlay close (promptTexto)');
                    overlay.removeEventListener('click', handler);
                    setTimeout(() => { try { overlay.addEventListener('click', handler, { once: true }); } catch(_){} }, 160);
                    return;
                }
                try { close(null); } catch (err) { console.warn('overlay close handler failed', err); }
                try { overlay.removeEventListener('click', handler); } catch(_){}
            };
            overlay.addEventListener('click', handler, { once: true });
        })();
        setTimeout(() => { try { input.focus(); input.select(); } catch(_){} }, 0);
    });
}

// Prompt para certificado digital: permite selecionar arquivo ou colar conteúdo;
// extrai um token confidencial do conteúdo sem exibir o que foi encontrado.
function mostrarPromptCertificado(titulo = 'Certificado digital', mensagem = 'Digite a senha mestra ou valide o certificado digital.') {
    return new Promise((resolve) => {
        overlay.removeEventListener('click', fecharMensagem);
        messageBox.innerHTML = `
            <h2>${titulo}</h2>
            <p>${mensagem}</p>
            <div style="display:flex;flex-direction:column;gap:12px;margin-top:10px;align-items:stretch;">
                <div style="position:relative;display:flex;align-items:center;">
                    <input id="certMasterInput" type="password" placeholder="Digite a senha mestra" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.25);background: rgba(255,255,255,0.06);backdrop-filter: blur(8px) saturate(140%);color: inherit;" />
                </div>
                <div style="display:flex;align-items:center;gap:8px;opacity:0.8;justify-content:center;">
                    <span>ou</span>
                </div>
                <input id="certFileInput" type="file" accept=".pem,.crt,.cer,.txt" style="display:none;" />
                <button id="certFileBtn" class="cert-btn" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,0.28);background: linear-gradient(180deg, rgba(255,255,255,0.22), rgba(255,255,255,0.08));backdrop-filter: blur(10px) saturate(160%);color: var(--primary-accent);box-shadow: 0 10px 25px rgba(0,0,0,0.25), 0 4px 10px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.3);">
                    <span aria-hidden="true" style="display:inline-flex;"> 
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <circle cx="12" cy="14" r="3"/>
                            <path d="M12 11v6"/>
                        </svg>
                    </span>
                    <span>Validar certificado digital</span>
                </button>
                <div id="certProgress" style="display:none; margin-top:8px;">
                    <div class="progress-container"><div class="progress-bar" id="cert-progress-bar"></div></div>
                    <div class="status-message" id="cert-status-message" style="margin-top:6px; text-align:center; opacity:0.9;">Validando assinatura...</div>
                </div>
                <div style="display:flex;justify-content:center;gap:20px;margin-top:6px;">
                    <button id="btnCancelarCert">Cancelar</button>
                    <button id="btnOkCert" style="background-color: var(--primary-accent);">OK</button>
                </div>
            </div>
        `;
        overlay.style.zIndex = '13000';
        messageBox.style.zIndex = '13001';
        // modal token for certificado prompt
        const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        window.__modalTokens = window.__modalTokens || [];
        window.__modalTokens.push(modalToken);
        try { messageBox.dataset.modalToken = modalToken; } catch(_){}
        overlay.style.display = 'block';
        messageBox.style.display = 'block';
        document.body.classList.add('modal-open');

    const inputFile = document.getElementById('certFileInput');
    const inputMaster = document.getElementById('certMasterInput');
    const fileBtn = document.getElementById('certFileBtn');
        const btnOk = document.getElementById('btnOkCert');
        const btnCancel = document.getElementById('btnCancelarCert');
        
        let tokenFromFile = null; // token extraído do arquivo

        const close = (val) => {
            try { if (inputMaster) inputMaster.value = ''; } catch(_){ }
            try { if (inputFile) inputFile.value = ''; } catch(_){ }
            fecharMensagem(false, modalToken); try { overlay.removeEventListener('click', handleOverlayClick); } catch(_){}; overlay.addEventListener('click', handleOverlayClick); resolve(val);
        };

        btnCancel.addEventListener('click', () => close(null), { once: true });
        (function attachOverlayCloseOnceCert() {
            const handler = function (e) {
                if (window.__modalClickShield) {
                    console.log('[MODAL-SHIELD] deferred one-time overlay close (cert)');
                    overlay.removeEventListener('click', handler);
                    setTimeout(() => { try { overlay.addEventListener('click', handler, { once: true }); } catch(_){} }, 160);
                    return;
                }
                try { close(null); } catch (err) { console.warn('overlay close handler failed', err); }
                try { overlay.removeEventListener('click', handler); } catch(_){}
            };
            overlay.addEventListener('click', handler, { once: true });
        })();
        btnOk.addEventListener('click', async () => {
            try {
                let token = null;
                if (tokenFromFile) {
                    token = tokenFromFile;
                } else if (inputMaster && inputMaster.value) {
                    const senha = inputMaster.value.trim();
                    if (verificarSenha(senha)) token = senha;
                }
                if (!token) {
                    mostrarMensagem('Atenção', 'Entrada inválida. Informe um certificado válido ou a senha mestra.');
                    return;
                }
                close(token);
            } catch (err) {
                console.error('Falha ao processar certificado:', err);
                mostrarMensagem('Erro', 'Não foi possível processar o certificado.');
            }
        }, { once: true });

        if (fileBtn && inputFile) {
            fileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                inputFile.click();
            });
            // Iniciar barra de progresso assim que o arquivo é escolhido
            inputFile.addEventListener('change', async () => {
                try {
                    tokenFromFile = null;
                    const file = inputFile.files && inputFile.files[0];
                    if (!file) return;
                    const progressWrap = document.getElementById('certProgress');
                    const progressBar = document.getElementById('cert-progress-bar');
                    const statusMsg = document.getElementById('cert-status-message');
                    if (progressWrap && progressBar && statusMsg) {
                        progressWrap.style.display = 'block';
                        // Desabilitar ações enquanto processa
                        btnOk.disabled = true; btnCancel.disabled = true; fileBtn.disabled = true; if (inputMaster) inputMaster.disabled = true;
                        let p = 0;
                        statusMsg.textContent = 'Validando assinatura...';
                        const timer = setInterval(() => {
                            p += Math.random() * 12;
                            if (p > 85) p = 85;
                            progressBar.style.width = `${p}%`;
                            if (p < 40) {
                                statusMsg.textContent = 'Validando assinatura...';
                            } else {
                                statusMsg.textContent = 'Verificando chave...';
                            }
                        }, 180);
                        try {
                            let conteudo = await file.text();
                            conteudo = (conteudo || '').toString();
                            tokenFromFile = extrairTokenCertificado(conteudo);
                            // Limpar conteúdo de memória
                            conteudo = '';
                        } finally {
                            clearInterval(timer);
                        }
                        if (tokenFromFile) {
                            statusMsg.textContent = 'Finalizando...';
                            progressBar.style.width = '100%';
                            await new Promise(r => setTimeout(r, 350));
                            statusMsg.textContent = 'Concluído';
                            await new Promise(r => setTimeout(r, 500));
                            progressWrap.style.display = 'none';
                            // Habilitar o OK para concluir
                            btnOk.disabled = false; btnCancel.disabled = false; fileBtn.disabled = false; if (inputMaster) inputMaster.disabled = false;
                        } else {
                            progressWrap.style.display = 'none';
                            btnOk.disabled = false; btnCancel.disabled = false; fileBtn.disabled = false; if (inputMaster) inputMaster.disabled = false;
                            mostrarMensagem('Erro de Certificado', 'Não foi possível validar o certificado. Tente outro arquivo ou digite a senha mestra.');
                        }
                    } else {
                        // Fallback sem UI de progresso
                        let conteudo = await file.text();
                        conteudo = (conteudo || '').toString();
                        tokenFromFile = extrairTokenCertificado(conteudo);
                        conteudo = '';
                    }
                } catch (err) {
                    console.error('Erro ao processar arquivo de certificado:', err);
                    mostrarMensagem('Erro', 'Falha ao ler o arquivo de certificado.');
                }
            });
        }
        

        setTimeout(() => { try { (inputMaster || inputFile)?.focus(); } catch(_){} }, 0);
    });
}

// Extrai um possível token confidencial do certificado sem revelar o conteúdo
function extrairTokenCertificado(texto) {
    if (!texto) return null;
    try {
        // Busca sequências compatíveis com base64 estendido (com + e /), tamanho mínimo 24
        const matches = texto.match(/[A-Za-z0-9+/=]{24,}/g) || [];
        if (!matches.length) return null;
        // Retorna o primeiro candidato que valide como senha mestra
        for (const m of matches) {
            if (verificarSenha(m)) return m;
        }
        return null;
    } catch {
        return null;
    }
}
function fecharMensagem(isConfirm = false, token) {
    console.log('[TRACE] fecharMensagem invoked - isConfirm:', isConfirm, 'token:', token);
    try { console.trace(); } catch(_){ }
    // Ignore accidental immediate closes right after opening a modal
    try {
        const last = window.__lastModalOpenTime || 0;
        // Use a slightly larger guard than the visual shield window to avoid
        // the gap where last-check allows closes but the pointer-shield is
        // still active. Keep conservative to reduce false-unlocks.
        if (!isConfirm && last && (Date.now() - last) < 480) {
            console.log('[MODAL-SHIELD] Ignoring fecharMensagem called too soon after open');
            return;
        }
    } catch (_) {}
    // Modal token stack: ensure only the owner modal can actually close/unlock
    var tokenPopped = false;
    try {
        window.__modalTokens = window.__modalTokens || [];
        const hadTokens = (window.__modalTokens && window.__modalTokens.length > 0);
        if (token) {
            const top = window.__modalTokens.length ? window.__modalTokens[window.__modalTokens.length - 1] : null;
            if (top !== token) {
                console.log('[MODAL-TOKEN] Ignoring fecharMensagem for non-top token', { top, token });
                return;
            }
            // pop token
            window.__modalTokens.pop();
            tokenPopped = true;
        } else {
            // If no token provided and there are tokens, do not pop them — avoid accidental unlocks.
            if (hadTokens) {
                console.log('[MODAL-TOKEN] fecharMensagem called without token while tokens present — will hide UI but not pop tokens');
            }
        }
    } catch (_) {}
    if (overlay) {
        overlay.style.zIndex = '';
    }
    if (messageBox) {
        messageBox.style.zIndex = '';
        if (messageBox.classList.contains('improvements')) {
            messageBox.classList.remove('improvements');
        }
        messageBox.style.display = 'none';
    }

    if (modalObservacoes) {
        // Only hide and unlock if it was actually visible
        const wasVisible = modalObservacoes.style.display && modalObservacoes.style.display !== 'none';
        modalObservacoes.style.display = 'none';
        if (wasVisible) {
            if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
        }
    }
    if (modalDesenvolvimento) {
        const wasVisibleDev = modalDesenvolvimento.style.display && modalDesenvolvimento.style.display !== 'none';
        modalDesenvolvimento.style.display = 'none';
        modalDesenvolvimento.style.zIndex = '';
        if (wasVisibleDev) {
            if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
        }
    }

    const modalSenhaAberto = modalSenhaDiv && modalSenhaDiv.style.display === 'flex';
    const modalAnotacaoAberto = modalAnotacaoDiv && modalAnotacaoDiv.style.display === 'flex';

    if (!isConfirm && !modalSenhaAberto && !modalAnotacaoAberto) {
        if (overlay) {
            overlay.style.display = 'none';
        }
        document.body.classList.remove('modal-open');
        // Only unlock if there are no outstanding modal tokens AND we either popped a token now or there were none to begin with
        const tokensLeft = (window.__modalTokens && window.__modalTokens.length) ? window.__modalTokens.length : 0;
        if (tokensLeft === 0 && (tokenPopped || !tokensLeft)) {
            // Instead of unlocking immediately, delay a short amount and re-check
            // tokens. This prevents an unlock triggered by a nearly-simultaneous
            // event (same-click reentrancy) from restoring scroll prematurely.
            console.log('[MODAL-TOKEN] Scheduling unlock check (delayed) — tokenPopped:', tokenPopped);
            setTimeout(() => {
                try {
                    const leftNow = (window.__modalTokens && window.__modalTokens.length) ? window.__modalTokens.length : 0;
                    if (leftNow === 0) {
                        if (window.__bodyLock && window.__bodyLock.count > 0) { try { unlockBodyScroll(); } catch(_){} }
                    } else {
                        console.log('[MODAL-TOKEN] Delayed unlock aborted, tokens remaining:', leftNow);
                    }
                } catch (e) { console.warn('[MODAL-TOKEN] Delayed unlock check failed', e); }
            }, 150);
        } else {
            console.log('[MODAL-TOKEN] Postpone unlock, tokens remaining:', tokensLeft, 'tokenPopped:', tokenPopped);
        }
    }

    if (isConfirm) {
        if (overlay) {
            overlay.style.display = 'none';
        }
        document.body.classList.remove('modal-open');
        if (modalSenhaAberto) fecharModalSenha();
        if (modalAnotacaoAberto) fecharModalAnotacao();
    }
}
</script>

<script>
// Handler para redefinir o tempo de atualização
async function handleRedefinirTempo(event) {
    try {
        console.log('handleRedefinirTempo invoked', { event });
        const btn = document.getElementById('btnRedefinirTempo');
        if (btn) {
            try {
                const rect = btn.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const elAtCenter = document.elementFromPoint(centerX, centerY);
                console.log('element at button center:', elAtCenter);
                console.log('overlay computed style:', {
                    display: getComputedStyle(overlay).display,
                    pointerEvents: getComputedStyle(overlay).pointerEvents,
                    zIndex: getComputedStyle(overlay).zIndex
                });
                if (elAtCenter && elAtCenter !== btn && !btn.contains(elAtCenter)) {
                    console.warn('POSSÍVEL BLOQUEIO: outro elemento está sobre o botão (pode ser overlay/modal).');
                }
            } catch (innerErr) {
                console.warn('Não foi possível determinar elemento sobre o botão:', innerErr);
            }
        } else {
            console.warn('btnRedefinirTempo não encontrado no DOM no momento do clique.');
        }

        const confirmado = await mostrarConfirmacao(
            'Redefinir tempo de Atualização',
            'Deseja redefinir o timer de atualização para 30 dias?'
        );
        if (confirmado) {
            localStorage.setItem('lastUpdateCheck', Date.now());
            // Atualiza o contador e esconde o diálogo de update
            checkUpdateTimer();
            setUpdateNoticeVisibility(false);
            mostrarMensagem('Sucesso', 'Tempo de atualização redefinido para 30 dias.');
        }
    } catch (err) {
        console.error('Erro em handleRedefinirTempo:', err);
    }
}
</script>

<script>
// Função reutilizável que executa a redefinição do timer (usada pelo popover e pelo modal)
function doRedefinirTempo() {
    try {
        localStorage.setItem('lastUpdateCheck', Date.now());
        checkUpdateTimer();
        setUpdateNoticeVisibility(false);
        mostrarMensagem('Sucesso', 'Tempo de atualização redefinido para 30 dias.');
    } catch (e) {
        console.error('Erro ao executar doRedefinirTempo:', e);
    } finally {
        hidePopoverRedefinir();
    }
}

function showPopoverRedefinir(button) {
    const pop = document.getElementById('popoverRedefinir');
    if (!pop) return;
    pop.dataset.visible = 'true';
    pop.setAttribute('aria-hidden', 'false');
    pop.classList.remove('popover-hidden');
}

function hidePopoverRedefinir() {
    const pop = document.getElementById('popoverRedefinir');
    if (!pop) return;
    pop.dataset.visible = 'false';
    pop.setAttribute('aria-hidden', 'true');
    pop.classList.add('popover-hidden');
    pop.style.display = '';
}

// Delegação de clicks para os botões do popover
document.addEventListener('click', function (e) {
    if (e.target && e.target.id === 'popoverConfirmRedefinir') {
        e.stopPropagation();
        hidePopoverRedefinir();
        doRedefinirTempo();
    } else if (e.target && e.target.id === 'popoverCancelRedefinir') {
        e.stopPropagation();
        hidePopoverRedefinir();
    } else {
        // Se clicar fora do popover e do botão, fecha o popover
        const pop = document.getElementById('popoverRedefinir');
        const btn = document.getElementById('btnRedefinirTempo');
        if (pop && pop.dataset.visible === 'true') {
            if (!pop.contains(e.target) && !(btn && btn.contains(e.target))) {
                hidePopoverRedefinir();
            }
        }
    }
});
</script>

<script>

if (window.innerWidth <= 768) {
document.body.style.height = window.innerHeight + 'px';
}
</script>

<script>

const savedItemsManager = {
    init() {
        this.modal = document.getElementById('modalSavedItems');
        this.form = document.getElementById('formSavedItem');
        this.list = document.getElementById('savedItemsList');
        this.container = document.querySelector('.saved-items-container');
        this.setupEventListeners();
        this.loadSavedItems();
    },

    setupEventListeners() {
        
        const manageSavedItemsBtn = document.getElementById('btn-manage-saved-items');
        if (manageSavedItemsBtn) {
            manageSavedItemsBtn.addEventListener('click', () => {
                this.openModal();
            });
        }

        
        const closeBtn = document.querySelector('.close-saved-items');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.closeModal();
            });
        }

        
        const viewBtn = document.querySelector('.view-saved-btn');
        if (viewBtn) {
            viewBtn.addEventListener('click', () => {
                this.toggleView('list');
            });
        }

        
        const backBtn = document.querySelector('.back-to-form-btn');
        if (backBtn) {
            backBtn.addEventListener('click', () => {
                this.toggleView('form');
            });
        }

        
        if (this.form) {
            this.form.addEventListener('submit', (e) => {
                e.preventDefault();
                this.saveItem();
            });
        }

        
        if (this.form) {
            const inputs = this.form.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', () => {
                    this.suggestAutoComplete(input);
                });
            });
        }
    },

    openModal() {
        this.modal.style.display = 'block';
        this.toggleView('form');
    },

    closeModal() {
        this.modal.style.display = 'none';
        this.form.reset();
    },

    toggleView(view) {
        if (view === 'list') {
            this.form.style.display = 'none';
            this.list.style.display = 'block';
            this.loadSavedItems(); 
        } else {
            this.form.style.display = 'block';
            this.list.style.display = 'none';
        }
    },

    saveItem() {
        const item = {
            id: Date.now(),
            titulo: document.getElementById('saved-item-titulo').value,
            usuario: document.getElementById('saved-item-usuario').value,
            email: document.getElementById('saved-item-email').value,
            telefone: document.getElementById('saved-item-telefone').value,
            links: document.getElementById('saved-item-links').value,
            cpf: document.getElementById('saved-item-cpf').value,
            notas: document.getElementById('saved-item-notas').value,
            timestamp: new Date().toISOString()
        };

        let savedItems = this.getSavedItems();
        savedItems.push(item);
        localStorage.setItem('savedItems', JSON.stringify(savedItems));

        this.form.reset();
        this.showNotification('Item salvo com sucesso!');
    },

    getSavedItems() {
        const items = localStorage.getItem('savedItems');
        return items ? JSON.parse(items) : [];
    },

    loadSavedItems() {
        const items = this.getSavedItems();
        this.container.innerHTML = '';

        items.forEach(item => {
            const itemElement = this.createItemElement(item);
            this.container.appendChild(itemElement);
        });
    },

    createItemElement(item) {
        const div = document.createElement('div');
        div.className = 'saved-item';
        div.innerHTML = `
            <div class="saved-item-info">
                <div class="saved-item-title">${item.titulo}</div>
                <div class="saved-item-details">
                    ${item.usuario ? `<div>Usuário: ${item.usuario}</div>` : ''}
                    ${item.email ? `<div>Email: ${item.email}</div>` : ''}
                    ${item.telefone ? `<div>Telefone: ${item.telefone}</div>` : ''}
                </div>
            </div>
            <div class="saved-item-actions">
                <button class="liquid-btn" onclick="savedItemsManager.useItem('${item.id}')" title="Usar item">
                    <span class="check-icon"></span>
                </button>
                <button class="liquid-btn" onclick="savedItemsManager.deleteItem('${item.id}')" title="Excluir item">
                    <span style="color: var(--error-color);">×</span>
                </button>
            </div>
        `;
        return div;
    },

    useItem(id) {
        const items = this.getSavedItems();
        const item = items.find(i => i.id === parseInt(id));
        if (item) {
            
            this.fillMainForm(item);
            this.closeModal();
            this.showNotification('Dados preenchidos com sucesso!');
        }
    },

    deleteItem(id) {
        if (confirm('Tem certeza que deseja excluir este item?')) {
            let items = this.getSavedItems();
            items = items.filter(i => i.id !== parseInt(id));
            localStorage.setItem('savedItems', JSON.stringify(items));
            this.loadSavedItems();
            this.showNotification('Item excluído com sucesso!');
        }
    },

    fillMainForm(item) {
        
        const mappings = {
            'inputTitulo': item.titulo,
            'inputUsuario': item.usuario,
            'inputEmail': item.email,
            'inputSenha': item.usuario, 
            'inputTelefone': item.telefone,
            'inputLinks': item.links,
            'inputCpf': item.cpf
        };

        
        this.closeModal();

        
        const autoFillSettings = document.getElementById('autoFillSettings');
        if (autoFillSettings && autoFillSettings.style.display !== 'none') {
            document.getElementById('btn-autofill-back-to-app').click();
        }

        
        const firstBoard = document.querySelector('.board');
        const boardId = firstBoard ? firstBoard.getAttribute('data-id') : '1';

        
        abrirModalSenha(boardId);

        
        setTimeout(() => {
            Object.entries(mappings).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field && value) {
                    field.value = value;
                    
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            
            this.showNotification('Campos preenchidos com sucesso!');
        }, 100);
        if (autoFillSettings && autoFillSettings.style.display !== 'none') {
            document.getElementById('btn-autofill-back-to-app').click();
        }

        
        const modalSenha = document.getElementById('modalSenha');
        if (!modalSenha || modalSenha.style.display !== 'block') {
            
            const addButton = document.querySelector('.add-button, .board-add-button');
            if (addButton) {
                addButton.click();
            }
        }

        
        setTimeout(() => {
            
            Object.entries(mappings).forEach(([fieldId, value]) => {
                const field = document.getElementById(fieldId);
                if (field && value) {
                    field.value = value;
                    
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                }
            });
            
            this.showNotification('Campos preenchidos com sucesso!');
        }, 100);
    },

    suggestAutoComplete(input) {
        const items = this.getSavedItems();
        const value = input.value.toLowerCase();
        if (!value) return;

        
        const oldSuggestions = document.querySelector('.suggestions');
        if (oldSuggestions) {
            oldSuggestions.remove();
        }

        
        const matches = new Set();
        items.forEach(item => {
            Object.values(item).forEach(fieldValue => {
                if (typeof fieldValue === 'string' && 
                    fieldValue.toLowerCase().includes(value) && 
                    fieldValue.toLowerCase() !== value) {
                    matches.add(fieldValue);
                }
            });
        });

        if (matches.size > 0) {
            const suggestionsList = document.createElement('div');
            suggestionsList.className = 'suggestions';
            
            matches.forEach(match => {
                const suggestion = document.createElement('div');
                suggestion.className = 'suggestion-item';
                suggestion.textContent = match;
                suggestion.addEventListener('click', () => {
                    input.value = match;
                    suggestionsList.remove();
                    input.focus();
                });
                suggestionsList.appendChild(suggestion);
            });

            input.parentNode.insertBefore(suggestionsList, input.nextSibling);

            
            if (!document.querySelector('#suggestions-style')) {
                const style = document.createElement('style');
                style.id = 'suggestions-style';
                style.textContent = `
                    .suggestions {
                        position: absolute;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: var(--background-color);
                        border: 1px solid rgba(173, 216, 230, 0.2);
                        border-radius: 8px;
                        margin-top: 5px;
                        max-height: 200px;
                        overflow-y: auto;
                        z-index: 1000;
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                    }
                    .suggestion-item {
                        padding: 8px 12px;
                        cursor: pointer;
                        transition: background-color 0.2s;
                    }
                    .suggestion-item:hover {
                        background: rgba(173, 216, 230, 0.1);
                    }
                `;
                document.head.appendChild(style);
            }
        }
    },

    showNotification(message) {
        
        let notification = document.querySelector('.notification');
        if (notification) {
            notification.remove();
        }

        
        notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        document.body.appendChild(notification);

        
        if (!document.querySelector('#notification-style')) {
            const style = document.createElement('style');
            style.id = 'notification-style';
            style.textContent = `
                .notification {
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--background-color);
                    color: var(--text-color);
                    padding: 12px 24px;
                    border-radius: 8px;
                    border: 1px solid rgba(173, 216, 230, 0.2);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                    z-index: 1000;
                    animation: notificationFadeIn 0.3s ease forwards;
                }
                @keyframes notificationFadeIn {
                    from {
                        opacity: 0;
                        transform: translate(-50%, 20px);
                    }
                    to {
                        opacity: 1;
                        transform: translate(-50%, 0);
                    }
                }
            `;
            document.head.appendChild(style);
        }

        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translate(-50%, 20px)';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
};


document.addEventListener('DOMContentLoaded', () => {
    savedItemsManager.init();
});
</script>


<style>

.suggestions-container {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius-inner);
    margin-top: 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-item:hover {
    background: rgba(173, 216, 230, 0.1);
}

.suggestion-item .suggestion-text {
    flex: 1;
}

.suggestion-item .suggestion-info {
    font-size: 0.8em;
    opacity: 0.7;
    margin-left: 10px;
}

.suggestion-item.selected {
    background: rgba(173, 216, 230, 0.2);
}


@media screen and (max-width: 768px) {
    
    .modal {
        padding: 0; 
        align-items: flex-start; 
        overflow-y: auto; 
    }
    
    .modalContent {
        max-width: 100%;
        width: 100%; 
        min-height: 100vh; 
        margin: 0; 
        padding: 16px; 
        border-radius: 0; 
        box-sizing: border-box; 
    }

    
    .input-container {
        margin-bottom: 16px;
        width: 100%;
    }

    
    input[type="text"], 
    input[type="password"], 
    input[type="tel"], 
    textarea {
        width: 100%;
        padding: 12px 14px;
        font-size: 16px;
    }

    
    .modalButtons {
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
        width: 100%;
    }

    .modalButtons button {
        width: 100%;
        padding: 14px 0;
        margin: 0;
    }

    
    .search-wrapper {
        width: 100%;
        margin-bottom: 16px;
    }

    
    .search-btn.liquid-btn {
        width: 42px;
        height: 42px;
    }

    
    #formSenha .input-container {
        margin-bottom: 16px;
    }

    
    #inputTitulo,
    #inputUsuario,
    #inputEmail,
    #inputSenha,
    #inputTelefone,
    #inputLinks,
    #inputCpf {
        margin-bottom: 0;
    }

    
    .modal .modalContent {
        min-height: calc(100vh - 32px);
        width: calc(100% - 32px);
        display: flex;
        flex-direction: column;
    }

    /* Override mais específico para permitir rolagem no modal de Anotação no mobile */
    #modalAnotacao .modalContent {
        max-height: 100vh;
        min-height: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    
    .form-grid {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
        margin-bottom: 16px; 
    }

    
    body.modal-open {
        position: fixed; 
        width: 100%;
        height: 100%;
    }

    
    .input-container {
        position: relative;
        width: 100%;
        box-sizing: border-box;
    }

    
    .modalContent > * {
        width: 100%;
        box-sizing: border-box;
    }

    
    .modal {
        -webkit-overflow-scrolling: touch; 
    }

    
    .modalButtons {
        position: relative;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px 0;
        background: var(--background-color);
        z-index: 2;
    }
}


.search-wrapper {
    position: relative;
    width: 100%;
}

.search-btn.liquid-btn {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(173, 216, 230, 0.1);
    border: 1px solid rgba(173, 216, 230, 0.15);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
    color: var(--text-color);
}

.search-btn.liquid-btn:hover {
    background: rgba(173, 216, 230, 0.2);
    transform: translateY(-50%) scale(1.05);
    box-shadow: 
        0 4px 15px rgba(0, 0, 0, 0.2),
        inset 0 0 0 0.5px rgba(255, 255, 255, 0.15);
}

.search-btn.liquid-btn svg {
    width: 18px;
    height: 18px;
    filter: drop-shadow(0 0 2px rgba(173, 216, 230, 0.3));
}


.search-results-modal {
    max-width: 800px !important;
}

.search-results-container {
    max-height: 60vh;
    overflow-y: auto;
    margin: 20px 0;
}

.search-result-item {
    background: rgba(173, 216, 230, 0.1);
    border: 1px solid rgba(173, 216, 230, 0.15);
    border-radius: 16px;
    padding: 15px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    transition: all 0.3s ease;
    cursor: pointer;
}

.search-result-item:hover {
    background: rgba(173, 216, 230, 0.2);
    transform: translateY(-2px);
}

.search-result-title {
    font-weight: 600;
    margin-bottom: 5px;
}

.search-result-info {
    font-size: 0.9em;
    opacity: 0.8;
}


.input-with-suggestions {
    border-color: var(--primary-accent) !important;
    box-shadow: 0 0 0 2px rgba(var(--primary-accent-rgb), 0.1);
}
</style>

<script>

const suggestionSystem = {
    init() {
        
        const form = document.getElementById('formSenha');
        if (form) {
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = {};
                form.querySelectorAll('input').forEach(input => {
                    formData[input.id] = input.value;
                });
                this.saveToHistory(formData);
            });

            
            const inputs = form.querySelectorAll('input[type="text"]');
            inputs.forEach(input => {
                input.addEventListener('input', (e) => this.handleInput(e));
                input.addEventListener('focus', (e) => this.handleInput(e));
                input.addEventListener('keydown', (e) => this.handleKeydown(e));

                
                if (!input.parentElement.querySelector('.btn-clear-field')) {
                    const clearBtn = document.createElement('button');
                    clearBtn.type = 'button';
                    clearBtn.className = 'btn-clear-field';
                    clearBtn.innerHTML = '×';
                    clearBtn.style.display = 'none';
                    clearBtn.addEventListener('click', () => {
                        input.value = '';
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        clearBtn.style.display = 'none';
                    });
                    input.parentElement.appendChild(clearBtn);

                    
                    input.addEventListener('input', () => {
                        clearBtn.style.display = input.value ? 'block' : 'none';
                    });
                }
            });

            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.input-container')) {
                    this.removeAllSuggestions();
                }
            });

            
            form.addEventListener('submit', (e) => {
                const formData = {};
                inputs.forEach(input => {
                    formData[input.id] = input.value;
                });
                this.saveToHistory(formData);
            });

            
            const serviceInput = document.getElementById('service');
            if (serviceInput) {
                const serviceWrapper = document.createElement('div');
                serviceWrapper.className = 'search-wrapper';
                serviceInput.parentNode.insertBefore(serviceWrapper, serviceInput);
                serviceWrapper.appendChild(serviceInput);

                const searchBtn = document.createElement('button');
                searchBtn.className = 'search-btn liquid-btn';
                searchBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                `;
                serviceWrapper.appendChild(searchBtn);

                
                searchBtn.addEventListener('click', () => {
                    const query = serviceInput.value.trim();
                    if (query) {
                        this.performSearch(query);
                    }
                });

                
                serviceInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const query = e.target.value.trim();
                        if (query) {
                            this.performSearch(query);
                        }
                    }
                });
            }
        }
    },

    
    performSearch(query) {
        const searchResultsModal = document.getElementById('searchResultsModal') || this.createSearchResultsModal();
        const results = this.findAllMatches(query);
        this.displaySearchResults(results, searchResultsModal);
        this.showModal(searchResultsModal);
    },

    
    createSearchResultsModal() {
        const modal = document.createElement('div');
        modal.id = 'searchResultsModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modalContent search-results-modal">
                <h2>Resultados da Busca</h2>
                <div class="search-results-container"></div>
                <div class="modalButtons">
                    <button type="button" class="close-search">Fechar</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        
        modal.querySelector('.close-search').addEventListener('click', () => {
            this.hideModal(modal);
        });

        return modal;
    },

    
    findAllMatches(query) {
        const history = this.getFormHistory();
        const results = [];
        const queryLower = query.toLowerCase();

        history.forEach(entry => {
            let matchScore = 0;
            let matchDetails = [];

            
            Object.entries(entry).forEach(([key, value]) => {
                if (typeof value === 'string' && value.toLowerCase().includes(queryLower)) {
                    matchScore += key === 'titulo' ? 2 : 1; 
                    matchDetails.push({ field: key, value });
                }
            });

            if (matchScore > 0) {
                results.push({
                    ...entry,
                    matchScore,
                    matchDetails
                });
            }
        });

        
        return results.sort((a, b) => b.matchScore - a.matchScore);
    },

    
    displaySearchResults(results, modal) {
        const container = modal.querySelector('.search-results-container');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <p>Nenhum resultado encontrado.</p>
                </div>
            `;
            return;
        }

        results.forEach(result => {
            const resultElement = document.createElement('div');
            resultElement.className = 'search-result-item';
            resultElement.innerHTML = `
                <div>
                    <div class="search-result-title">${result.titulo || 'Sem título'}</div>
                    <div class="search-result-info">
                        ${result.matchDetails.map(match => `<span>${match.field}: ${match.value}</span>`).join(' • ')}
                    </div>
                </div>
            `;

            resultElement.addEventListener('click', () => {
                this.applySearchResult(result);
                this.hideModal(modal);
            });

            container.appendChild(resultElement);
        });
    },

    
    applySearchResult(result) {
        Object.entries(result).forEach(([key, value]) => {
            const field = document.getElementById(key);
            if (field && typeof value === 'string') {
                field.value = value;
                field.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
    },

    
    showModal(modal) {
        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
    },

    
    hideModal(modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
    },

    handleInput(e) {
        const input = e.target;
        const value = input.value.toLowerCase();
        
        
        this.removeSuggestions(input);
        
        if (!value) return;

        
        const suggestions = this.findSuggestions(input.id, value);
        if (suggestions.length > 0) {
            this.showSuggestions(input, suggestions);
        }
    },

    handleKeydown(e) {
        const container = e.target.parentElement.querySelector('.suggestions-container');
        if (!container) return;

        const items = container.querySelectorAll('.suggestion-item');
        const current = container.querySelector('.suggestion-item.selected');
        
        switch (e.key) {
            case 'ArrowDown':
            case 'ArrowUp':
                e.preventDefault();
                this.navigateSuggestions(items, current, e.key === 'ArrowDown');
                break;
            case 'Enter':
                e.preventDefault();
                if (current) {
                    this.applySuggestion(e.target, current.dataset.value, current.dataset.context);
                }
                break;
            case 'Escape':
                this.removeSuggestions(e.target);
                break;
        }
    },

    findSuggestions(fieldId, value) {
        const suggestions = [];
        const history = this.getFormHistory();
        
        
        const relatedFields = {
            'inputTitulo': ['titulo', 'servico', 'site'],
            'inputUsuario': ['usuario', 'nome'],
            'inputEmail': ['email'],
            'inputSenha': ['senha'],
            'inputTelefone': ['telefone', 'contato', 'celular'],
            'inputLinks': ['link', 'url', 'site', 'website'],
            'inputCpf': ['cpf', 'documento']
        };

        history.forEach(entry => {
            Object.entries(entry).forEach(([key, entryValue]) => {
                if (typeof entryValue === 'string' && 
                    entryValue.toLowerCase().includes(value)) {
                    
                    
                    const isRelated = relatedFields[fieldId].some(field => 
                        key.toLowerCase().includes(field)
                    );

                    if (isRelated) {
                        suggestions.push({
                            value: entryValue,
                            context: entry,
                            confidence: this.calculateConfidence(value, entryValue.toLowerCase())
                        });
                    }
                }
            });
        });

        
        return Array.from(new Set(suggestions.map(s => s.value)))
            .map(value => suggestions.find(s => s.value === value))
            .sort((a, b) => b.confidence - a.confidence)
            .slice(0, 5); 
    },

    calculateConfidence(input, target) {
        if (target === input) return 1;
        if (target.startsWith(input)) return 0.8;
        if (target.includes(input)) return 0.6;
        return 0.4;
    },

    showSuggestions(input, suggestions) {
        const container = document.createElement('div');
        container.className = 'suggestions-container';
        
        suggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            if (index === 0) item.classList.add('selected');
            
            item.innerHTML = `
                <span class="suggestion-text">${this.highlightMatch(suggestion.value, input.value)}</span>
                <span class="suggestion-info">${this.getContextInfo(suggestion.context)}</span>
            `;
            
            item.dataset.value = suggestion.value;
            item.dataset.context = JSON.stringify(suggestion.context);
            
            item.addEventListener('click', () => {
                this.applySuggestion(input, suggestion.value, JSON.stringify(suggestion.context));
            });
            
            container.appendChild(item);
        });
        
        input.parentElement.appendChild(container);
        input.classList.add('input-with-suggestions');
    },

    highlightMatch(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    },

    getContextInfo(context) {
        
        return '';
    },

    timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        const intervals = {
            ano: 31536000,
            mês: 2592000,
            semana: 604800,
            dia: 86400,
            hora: 3600,
            minuto: 60
        };

        for (let [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = Math.floor(seconds / secondsInUnit);
            if (interval >= 1) {
                return `há ${interval} ${unit}${interval > 1 ? (unit === 'mês' ? 'es' : 's') : ''}`;
            }
        }
        return 'há instantes';
    },

    applySuggestion(input, value, contextJSON) {
        input.value = value;
        input.dispatchEvent(new Event('input', { bubbles: true }));
        this.removeSuggestions(input);

        
        try {
            const context = JSON.parse(contextJSON);
            this.fillRelatedFields(input.id, context);
        } catch (e) {
            console.error('Erro ao processar contexto:', e);
        }
    },

    fillRelatedFields(sourceId, context) {
        const mappings = {
            'inputTitulo': ['titulo', 'servico', 'site'],
            'inputUsuario': ['usuario', 'nome'],
            'inputEmail': ['email'],
            'inputSenha': ['senha'],
            'inputTelefone': ['telefone'],
            'inputLinks': ['links', 'url', 'website'],
            'inputCpf': ['cpf']
        };

        Object.entries(mappings).forEach(([fieldId, keys]) => {
            if (fieldId !== sourceId) {
                const field = document.getElementById(fieldId);
                if (field && !field.value) {
                    for (let key of keys) {
                        const value = this.findValueInContext(context, key);
                        if (value) {
                            field.value = value;
                            field.dispatchEvent(new Event('input', { bubbles: true }));
                            break;
                        }
                    }
                }
            }
        });
    },

    findValueInContext(context, key) {
        for (let contextKey in context) {
            if (contextKey.toLowerCase().includes(key) && context[contextKey]) {
                return context[contextKey];
            }
        }
        return null;
    },

    getFormHistory() {
        try {
            return JSON.parse(localStorage.getItem('formHistory') || '[]');
        } catch (e) {
            console.error('Erro ao ler histórico:', e);
            return [];
        }
    },

    saveToHistory(formData) {
        try {
            const history = this.getFormHistory();
            formData.timestamp = new Date().toISOString();
            
            
            history.unshift(formData);
            
            
            while (history.length > 100) history.pop();
            
            localStorage.setItem('formHistory', JSON.stringify(history));
        } catch (e) {
            console.error('Erro ao salvar no histórico:', e);
        }
    },

    navigateSuggestions(items, current, isDown) {
        if (!items.length) return;
        
        const firstItem = items[0];
        const lastItem = items[items.length - 1];
        
        if (!current) {
            firstItem.classList.add('selected');
            return;
        }
        
        current.classList.remove('selected');
        
        if (isDown) {
            const next = current.nextElementSibling;
            (next || firstItem).classList.add('selected');
        } else {
            const prev = current.previousElementSibling;
            (prev || lastItem).classList.add('selected');
        }
    },

    removeSuggestions(input) {
        const container = input.parentElement.querySelector('.suggestions-container');
        if (container) {
            container.remove();
            input.classList.remove('input-with-suggestions');
        }
    },

    removeAllSuggestions() {
        document.querySelectorAll('.suggestions-container').forEach(container => {
            container.remove();
        });
        document.querySelectorAll('.input-with-suggestions').forEach(input => {
            input.classList.remove('input-with-suggestions');
        });
    }
};


const searchSystem = {
    init() {
        
        const serviceInput = document.getElementById('inputTitulo');
        if (serviceInput && !serviceInput.parentElement.querySelector('.search-btn')) {
            
            let wrapper = serviceInput.parentElement;
            if (!wrapper.classList.contains('search-wrapper')) {
                wrapper = document.createElement('div');
                wrapper.className = 'search-wrapper';
                serviceInput.parentNode.insertBefore(wrapper, serviceInput);
                wrapper.appendChild(serviceInput);
            }

            
            const searchBtn = document.createElement('button');
            searchBtn.className = 'search-btn liquid-btn';
            searchBtn.type = 'button'; 
            searchBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            `;
            wrapper.appendChild(searchBtn);

            
            searchBtn.addEventListener('click', (e) => {
                e.preventDefault(); 
                this.handleSearch(serviceInput);
            });
            
            
            serviceInput.closest('form').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target === serviceInput) {
                    e.preventDefault();
                    this.handleSearch(serviceInput);
                }
            });
        }
    },

    handleSearch(input) {
        const query = input.value.trim();
        if (!query) return;
        
        
        const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        const newWindow = window.open(searchUrl, '_blank');
        if (newWindow) {
            newWindow.focus(); 
        } else {
            
            window.location.href = searchUrl;
        }
    },

    findMatches(query) {
        
        const boardsData = JSON.parse(localStorage.getItem('gerenciadorBoards') || '[]');
        const allServices = [];
        
        
        if (Array.isArray(boardsData)) {
            boardsData.forEach(board => {
                board.cards.forEach(card => {
                    allServices.push({
                        name: card.titulo || '',
                        description: card.notas || '',
                        category: board.nome || ''
                    });
                });
            });
        }
        
        else if (boardsData.boardsData) {
            boardsData.boardsData.forEach(board => {
                board.cards.forEach(card => {
                    const decryptedCard = descriptografarCard(card, senhaDigitada);
                    if (decryptedCard) {
                        allServices.push({
                            name: decryptedCard.titulo || '',
                            description: decryptedCard.notas || '',
                            category: board.nome || ''
                        });
                    }
                });
            });
        }
        const queryLower = query.toLowerCase();

        return allServices.filter(service => {
            return service.name.toLowerCase().includes(queryLower) ||
                   (service.description && service.description.toLowerCase().includes(queryLower)) ||
                   (service.category && service.category.toLowerCase().includes(queryLower));
        }).sort((a, b) => {
            
            const aInName = a.name.toLowerCase().includes(queryLower);
            const bInName = b.name.toLowerCase().includes(queryLower);
            if (aInName && !bInName) return -1;
            if (!aInName && bInName) return 1;
            return 0;
        });
    },

    showResults(results) {
        const modal = document.getElementById('searchResultsModal');
        const container = modal.querySelector('.search-results-container');
        container.innerHTML = '';

        if (results.length === 0) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <p>Nenhum resultado encontrado.</p>
                </div>
            `;
        } else {
            results.forEach(result => {
                const resultElement = document.createElement('div');
                resultElement.className = 'search-result-item';
                resultElement.innerHTML = `
                    <div>
                        <div class="search-result-title">${result.name}</div>
                        <div class="search-result-info">
                            ${result.category || ''} ${result.description ? `• ${result.description}` : ''}
                        </div>
                    </div>
                `;

                resultElement.addEventListener('click', () => {
                    document.getElementById('service').value = result.name;
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                });

                container.appendChild(resultElement);
            });
        }

        modal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }
};


document.addEventListener('DOMContentLoaded', () => {
    
    const searchBtn = document.getElementById('search-service-btn');
    const inputTitulo = document.getElementById('inputTitulo');

    if (searchBtn && inputTitulo) {
        
        searchBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const query = inputTitulo.value.trim();
            if (query) {
                window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
            }
        });

        
        inputTitulo.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = inputTitulo.value.trim();
                if (query) {
                    window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
                }
            }
        });
    }

    
    suggestionSystem.init();

    
    const searchModal = document.getElementById('searchResultsModal');
    document.querySelector('.close-search').addEventListener('click', () => {
        searchModal.style.display = 'none';
        document.body.classList.remove('modal-open');
    });
    searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
            searchModal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }
    });
});
</script>
<script>

function checkUpdateTimer() {
    const lastCheck = localStorage.getItem('lastUpdateCheck');
    const now = new Date().getTime();
    const updateDialog = document.getElementById('update-dialog');
    const timerElement = document.querySelector('#version-link .update-timer');
    
    if (!lastCheck) {
        localStorage.setItem('lastUpdateCheck', now);
        if (timerElement) timerElement.textContent = '30 dias';
        return;
    }
    
    const daysPassed = Math.floor((now - lastCheck) / (1000 * 60 * 60 * 24));
    const daysRemaining = Math.max(30 - daysPassed, 0);
    
    if (timerElement) {
        timerElement.textContent = daysRemaining === 1 ? '1 dia' : `${daysRemaining} dias`;
    }
    
    if (daysPassed >= 30 && updateDialog) {
        updateDialog.style.display = 'block';
        localStorage.setItem('lastUpdateCheck', now);
    }
}


document.addEventListener('DOMContentLoaded', checkUpdateTimer);


setInterval(checkUpdateTimer, 1000 * 60 * 60);

// Função para revisar senhas/anotações aleatórias
function abrirRevisaoAleatoria(tipo) {
    const currentBoards = tipo === 'senha' ? boards : anotacoesBoards;
    
    // Coletar apenas cards (criptografados) com marcador importante
    const cardsImportantes = [];
    currentBoards.forEach(board => {
        board.cards.forEach(cardCriptografado => {
            const card = descriptografarCard(cardCriptografado, senhaDigitada);
            if (card && card.marcadorId) {
                const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                if (marcador && marcador.importante) {
                    // armazenamos o objeto criptografado para abrir o modal em modo de edição
                    cardsImportantes.push({ cardCriptografado, board });
                }
            }
        });
    });
    
    if (cardsImportantes.length === 0) {
        mostrarMensagem('Aviso', `Não há ${tipo === 'senha' ? 'senhas' : 'anotações'} com marcadores importantes para revisar.`);
        return;
    }
    
    // Selecionar um card aleatório
    const randomIndex = Math.floor(Math.random() * cardsImportantes.length);
    const { cardCriptografado, board } = cardsImportantes[randomIndex];
    
    // Abrir o modal apropriado em modo de edição (passando o objeto criptografado)
    if (tipo === 'senha') {
        abrirModalSenha(board.id, cardCriptografado);
    } else {
        abrirModalAnotacao(board.id, cardCriptografado);
    }
}

document.getElementById('btnRevisarSenha')?.addEventListener('click', () => {
    abrirRevisaoAleatoria('senha');
});

document.getElementById('btnRevisarAnotacao')?.addEventListener('click', () => {
    abrirRevisaoAleatoria('anotacao');
});

// Mostrar alertas de revisão aleatoriamente (30% de chance ao carregar)
function verificarMostrarAlerta() {
    const snoozeSenha = Number(localStorage.getItem('alertaRevisaoSenhaSnooze') || 0);
    const snoozeAnotacao = Number(localStorage.getItem('alertaRevisaoAnotacaoSnooze') || 0);
    const agora = Date.now();
    const prazoSnooze = 1000 * 60 * 60 * 24; // 24h

    // Verificar se há senhas com marcador importante
    let temSenhaImportante = false;
    for (const board of boards) {
        for (const cardCriptografado of board.cards) {
            const card = descriptografarCard(cardCriptografado, senhaDigitada);
            if (card && card.marcadorId) {
                const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                if (marcador && marcador.importante) {
                    temSenhaImportante = true;
                    break;
                }
            }
        }
        if (temSenhaImportante) break;
    }
    
    if (temSenhaImportante && Math.random() < 0.3 && (agora - snoozeSenha > prazoSnooze)) {
        const alertaSenha = document.getElementById('alerta-revisao-senha');
        if (alertaSenha) {
            alertaSenha.style.display = 'flex';
        }
    }
    
    // Verificar se há anotações com marcador importante
    let temAnotacaoImportante = false;
    for (const board of anotacoesBoards) {
        for (const cardCriptografado of board.cards) {
            const card = descriptografarCard(cardCriptografado, senhaDigitada);
            if (card && card.marcadorId) {
                const marcador = marcadores.find(m => String(m.id) === String(card.marcadorId));
                if (marcador && marcador.importante) {
                    temAnotacaoImportante = true;
                    break;
                }
            }
        }
        if (temAnotacaoImportante) break;
    }
    
    if (temAnotacaoImportante && Math.random() < 0.3 && (agora - snoozeAnotacao > prazoSnooze)) {
        const alertaAnotacao = document.getElementById('alerta-revisao-anotacao');
        if (alertaAnotacao) {
            alertaAnotacao.style.display = 'flex';
        }
    }
}

function adiarAlertaRevisao(tipo) {
    const agora = Date.now();
    const isAnotacao = tipo === 'anotacao';
    const key = isAnotacao ? 'alertaRevisaoAnotacaoSnooze' : 'alertaRevisaoSenhaSnooze';
    localStorage.setItem(key, String(agora));
    const alerta = document.getElementById(isAnotacao ? 'alerta-revisao-anotacao' : 'alerta-revisao-senha');
    if (alerta) alerta.style.display = 'none';
}

// ====== UTILITÁRIOS DE SENHA GERADA ======
function gerarSenhaAleatoria(tamanho = 12) {
    const caracteresMinusculas = 'abcdefghijklmnopqrstuvwxyz';
    const caracteresMaiusculas = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const caracteresNumeros = '0123456789';
    const caracteresEspeciais = '!@#$%&*-_=+';
    const todosCaracteres = caracteresMinusculas + caracteresMaiusculas + caracteresNumeros + caracteresEspeciais;

    let senha = '';
    senha += caracteresMinusculas[Math.floor(Math.random() * caracteresMinusculas.length)];
    senha += caracteresMaiusculas[Math.floor(Math.random() * caracteresMaiusculas.length)];
    senha += caracteresNumeros[Math.floor(Math.random() * caracteresNumeros.length)];
    senha += caracteresEspeciais[Math.floor(Math.random() * caracteresEspeciais.length)];

    for (let i = senha.length; i < tamanho; i += 1) {
        senha += todosCaracteres[Math.floor(Math.random() * todosCaracteres.length)];
    }

    return senha.split('').sort(() => Math.random() - 0.5).join('');
}

function mostrarSenhaCombotaoCopiar(senha, titulo) {
    const tituloDoc = titulo || 'Documento';

    if (!window.messageBox) return;

    window.messageBox.innerHTML = `
        <div style="text-align: center;">
            <div style="margin-bottom: 30px;">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="var(--text-color)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 16px; display: block; opacity: 0.8;">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11v a5 5 0 0 1 10 0v "></path>
                </svg>
                <h2 style="margin: 0 0 8px 0; color: var(--text-color); font-size: 22px; font-weight: 600;">PDF Gerado com Sucesso</h2>
                <p style="color: var(--text-color); opacity: 0.7; margin: 0; font-size: 14px;">Use a senha abaixo para abrir o documento</p>
            </div>
            
            <div style="background: var(--input-bg); backdrop-filter: blur(10px); border-radius: var(--border-radius-inner); padding: 24px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <p style="font-size: 11px; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-color); opacity: 0.5; margin-bottom: 12px; font-weight: 500;">Senha do PDF</p>
                <div style="background: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 18px; margin-bottom: 18px;">
                    <code id="senhaParaCopiar" style="font-size: 18px; font-weight: 600; color: var(--text-color); letter-spacing: 1.5px; word-break: break-all; font-family: 'Courier New', monospace; display: block;">${senha}</code>
                </div>
                <button id="btnCopiarSenha" style="width: 100%; padding: 14px; background: var(--button-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2v a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v "></path>
                    </svg>
                    <span id="textoBotaoCopiar">Copiar Senha</span>
                </button>
            </div>
            
            <div style="background: var(--input-bg); border-left: 3px solid var(--text-color); padding: 14px 16px; border-radius: 6px; text-align: left; margin-bottom: 24px; opacity: 0.8;">
                <p style="margin: 0; font-size: 13px; color: var(--text-color); line-height: 1.5;">
                    <strong style="font-weight: 600;">Importante:</strong> Guarde esta senha em local seguro. Ela é necessária para abrir o PDF de ${tituloDoc}.
                </p>
            </div>
            
            <button id="btnFecharSenha" style="display: block; margin: 0 auto; padding: 12px 32px; background: var(--button-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
                Fechar
            </button>
        </div>
    `;

    const modalToken = 'mt-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
    window.messageBox.dataset.modalToken = modalToken;

    const copyBtn = document.getElementById('btnCopiarSenha');
    const fecharBtn = document.getElementById('btnFecharSenha');

    if (copyBtn) {
        copyBtn.addEventListener('click', () => {
            const textSpan = document.getElementById('textoBotaoCopiar');
            navigator.clipboard.writeText(senha).then(() => {
                if (textSpan) textSpan.textContent = 'Copiado!';
                copyBtn.disabled = true;
                setTimeout(() => {
                    if (textSpan) textSpan.textContent = 'Copiar Senha';
                    copyBtn.disabled = false;
                }, 1200);
            }).catch(() => {
                if (textSpan) textSpan.textContent = 'Erro ao copiar';
            });
        }, { once: true });
    }

    if (fecharBtn) {
        fecharBtn.addEventListener('click', () => fecharMensagem(false), { once: true });
    }
}
// Compatibilidade com nome acentuado usado no arquivo corrompido
window.mostrarSenhaCombotãoCopiar = mostrarSenhaCombotaoCopiar;

// ====== CREDENCIAIS ANALISADAS ======
let credenciaisAnalisadas = [];
let pessoasOcultas = [];

function carregarPessoasOcultas() {
    try {
        const data = localStorage.getItem('pessoasOcultas');
        pessoasOcultas = data ? JSON.parse(data) : [];
    } catch (_err) {
        pessoasOcultas = [];
    }
}

function salvarPessoasOcultas() {
    try {
        localStorage.setItem('pessoasOcultas', JSON.stringify(pessoasOcultas));
    } catch (err) {
        console.error('Erro ao salvar pessoas ocultas:', err);
    }
}

function normalizarNome(nome) {
    if (!nome || typeof nome !== 'string') return '';
    return nome.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
}

function obterIniciais(nome) {
    if (!nome || typeof nome !== 'string') return '?';
    const palavras = nome.trim().split(/\s+/).filter((p) => p.length > 0);
    if (palavras.length === 0) return '?';
    if (palavras.length === 1) return palavras[0][0].toUpperCase();
    return (palavras[0][0] + palavras[palavras.length - 1][0]).toUpperCase();
}

function gerarCorAvatar(nome) {
    if (!nome) return '#007aff';
    const cores = ['#007aff', '#5856d6', '#af52de', '#ff2d55', '#ff3b30', '#ff9500', '#ffcc00', '#34c759', '#00c7be', '#30b0c7', '#32ade6'];
    let hash = 0;
    for (let i = 0; i < nome.length; i += 1) {
        hash = nome.charCodeAt(i) + ((hash << 5) - hash);
    }
    return cores[Math.abs(hash) % cores.length];
}

function analisarCredenciais() {
    const pessoas = new Map();

    const processCardList = (listaBoards) => {
        listaBoards.forEach((board) => {
            board.cards.forEach((cardCriptografado) => {
                const card = descriptografarCard(cardCriptografado, senhaDigitada);
                if (!card) return;

                const info = {
                    titulo: card.titulo || '',
                    usuario: card.usuario || '',
                    email: card.email || '',
                    telefone: card.telefone || '',
                    cpf: card.cpf || '',
                    links: card.links || '',
                    notas: card.notas || ''
                };

                let nomeIdentificado = null;

                if (info.usuario) {
                    const palavras = info.usuario.trim().split(/\s+/);
                    if (palavras.length >= 2 && !info.usuario.includes('@') && !info.usuario.match(/^\d+$/)) {
                        nomeIdentificado = info.usuario;
                    }
                }

                if (!nomeIdentificado && info.titulo) {
                    const palavras = info.titulo.trim().split(/\s+/);
                    if (palavras.length >= 2 && !info.titulo.includes('@') && !info.titulo.match(/^\d+$/)) {
                        nomeIdentificado = info.titulo;
                    }
                }

                if (!nomeIdentificado && info.notas) {
                    const regexNome = /(?:nome|pessoa|usuario|titular|proprietario|dono):\s*([A-Za-zÀ-ÿ][A-Za-zÀ-ÿ]+(?:\s+[A-Za-zÀ-ÿ][A-Za-zÀ-ÿ]+)+)/i;
                    const match = info.notas.match(regexNome);
                    if (match) nomeIdentificado = match[1];
                }

                if (nomeIdentificado) {
                    const nomeNormalizado = normalizarNome(nomeIdentificado);

                    if (!pessoas.has(nomeNormalizado)) {
                        pessoas.set(nomeNormalizado, {
                            nome: nomeIdentificado,
                            emails: new Set(),
                            telefones: new Set(),
                            cpfs: new Set(),
                            links: new Set(),
                            cartoes: []
                        });
                    }

                    const pessoa = pessoas.get(nomeNormalizado);
                    if (info.email) pessoa.emails.add(info.email);
                    if (info.telefone) pessoa.telefones.add(info.telefone);
                    if (info.cpf) pessoa.cpfs.add(info.cpf);
                    if (info.links) pessoa.links.add(info.links);
                }
            });
        });
    };

    processCardList(boards || []);
    processCardList(anotacoesBoards || []);

    const todosCartoes = [];

    try {
        const cartaoPadraoStr = localStorage.getItem('cartãoPadrao');
        if (cartaoPadraoStr) {
            const cartaoPadrao = JSON.parse(cartaoPadraoStr);
            if (cartaoPadrao && cartaoPadrao.titular && cartaoPadrao.numero) {
                todosCartoes.push(cartaoPadrao);
            }
        }
    } catch (err) {
        console.error('[CREDENCIAIS] Erro ao processar cartão padrão:', err);
    }

    const extrairCartoes = (listaBoards) => {
        listaBoards.forEach((board) => {
            board.cards.forEach((cardCriptografado) => {
                const card = descriptografarCard(cardCriptografado, senhaDigitada);
                if (!card) return;

                const cartões = card.cartoes || card.cartões || card.cartao || card.cartão;
                if (!cartões) return;

                if (Array.isArray(cartões)) {
                    cartões.forEach((cartao) => {
                        if (cartao && cartao.titular && cartao.numero) todosCartoes.push(cartao);
                    });
                } else if (typeof cartões === 'object' && cartões.titular && cartões.numero) {
                    todosCartoes.push(cartões);
                }
            });
        });
    };

    extrairCartoes(boards || []);
    extrairCartoes(anotacoesBoards || []);

    todosCartoes.forEach((cartao) => {
        try {
            const nomeBase = (cartao.titular && cartao.titular.trim()) ? cartao.titular.trim() : 'Cartão salvo';
            const titularNormalizado = normalizarNome(nomeBase) || `cartao-${cartao.numero || Math.random()}`;

            if (!pessoas.has(titularNormalizado)) {
                pessoas.set(titularNormalizado, {
                    nome: nomeBase,
                    emails: new Set(),
                    telefones: new Set(),
                    cpfs: new Set(),
                    links: new Set(),
                    cartoes: []
                });
            }
            const pessoa = pessoas.get(titularNormalizado);
            const existe = pessoa.cartoes.some((c) => c.numero === cartao.numero && c.validade === cartao.validade);
            if (!existe) pessoa.cartoes.push(cartao);
        } catch (err) {
            console.error('[CREDENCIAIS] Erro ao processar cartão:', err);
        }
    });

    credenciaisAnalisadas = Array.from(pessoas.values()).map((pessoa) => ({
        nome: pessoa.nome,
        emails: Array.from(pessoa.emails),
        telefones: Array.from(pessoa.telefones),
        cpfs: Array.from(pessoa.cpfs),
        links: Array.from(pessoa.links),
        cartoes: pessoa.cartoes
    }));

    atualizarUICredenciais();
}

function atualizarUICredenciais() {
    const box = document.getElementById('credenciais-analisadas-box');
    const boxAnotacao = document.getElementById('credenciais-analisadas-box-anotacao');
    const countSenha = document.getElementById('credenciais-analisadas-count');
    const countAnotacao = document.getElementById('credenciais-analisadas-count-anotacao');

    if (countSenha) countSenha.textContent = credenciaisAnalisadas.length;
    if (countAnotacao) countAnotacao.textContent = credenciaisAnalisadas.length;

    if (credenciaisAnalisadas.length > 0) {
        if (box) box.style.display = 'flex';
        if (boxAnotacao) boxAnotacao.style.display = 'flex';
    } else {
        if (box) box.style.display = 'none';
        if (boxAnotacao) boxAnotacao.style.display = 'none';
    }
}

function renderizarListaPessoas() {
    const container = document.getElementById('pessoas-lista-container');
    if (!container) return;

    carregarPessoasOcultas();
    container.innerHTML = '';

    const pessoasVisiveis = credenciaisAnalisadas.filter((pessoa) => !pessoasOcultas.includes(normalizarNome(pessoa.nome)));
    const pessoasOcultasData = credenciaisAnalisadas.filter((pessoa) => pessoasOcultas.includes(normalizarNome(pessoa.nome)));

    if (credenciaisAnalisadas.length === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 40px;">Nenhuma credencial analisada encontrada.</p>';
        return;
    }

    if (pessoasVisiveis.length === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7; padding: 20px;">Todas as credenciais estão ocultas.</p>';
    } else {
        pessoasVisiveis.forEach((pessoa) => {
            const indexOriginal = credenciaisAnalisadas.indexOf(pessoa);
            const card = document.createElement('div');
            card.className = 'pessoa-card';
            card.style.position = 'relative';

            const iniciais = obterIniciais(pessoa.nome);
            const cor = gerarCorAvatar(pessoa.nome);

            const detalhesCount = pessoa.emails.length + pessoa.telefones.length + pessoa.cpfs.length + pessoa.links.length + pessoa.cartoes.length;

            card.innerHTML = `
                <button class="btn-ocultar-pessoa" onclick="event.stopPropagation(); ocultarPessoa('${normalizarNome(pessoa.nome)}');" title="Ocultar credencial">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
                <div class="pessoa-avatar" style="background-color: ${cor};">${iniciais}</div>
                <div class="pessoa-info">
                    <div class="pessoa-nome">${pessoa.nome}</div>
                    <div class="pessoa-detalhes-count">${detalhesCount} informação${detalhesCount !== 1 ? 's' : ''}</div>
                </div>
            `;

            card.onclick = (e) => {
                if (!e.target.closest('.btn-ocultar-pessoa')) {
                    mostrarDetalhesPessoa(indexOriginal);
                }
            };

            container.appendChild(card);
        });
    }

    if (pessoasOcultasData.length > 0) {
        const ocultasSection = document.createElement('div');
        ocultasSection.className = 'credenciais-ocultas-section';

        ocultasSection.innerHTML = `
            <div class="credenciais-ocultas-header" onclick="toggleCredenciaisOcultas()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
                <h3>Credenciais ocultas (${pessoasOcultasData.length})</h3>
            </div>
            <div class="credenciais-ocultas-lista" id="credenciais-ocultas-lista"></div>
        `;

        container.appendChild(ocultasSection);

        const listaOcultas = document.getElementById('credenciais-ocultas-lista');
        pessoasOcultasData.forEach((pessoa) => {
            const indexOriginal = credenciaisAnalisadas.indexOf(pessoa);
            const card = document.createElement('div');
            card.className = 'pessoa-card pessoa-card-oculta';
            card.style.position = 'relative';

            const iniciais = obterIniciais(pessoa.nome);
            const cor = gerarCorAvatar(pessoa.nome);

            const detalhesCount = pessoa.emails.length + pessoa.telefones.length + pessoa.cpfs.length + pessoa.links.length + pessoa.cartoes.length;

            card.innerHTML = `
                <button class="btn-reexibir-pessoa" onclick="event.stopPropagation(); reexibirPessoa('${normalizarNome(pessoa.nome)}');" title="Reexibir credencial">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <div class="pessoa-avatar" style="background-color: ${cor};">${iniciais}</div>
                <div class="pessoa-info">
                    <div class="pessoa-nome">${pessoa.nome}</div>
                    <div class="pessoa-detalhes-count">${detalhesCount} informação${detalhesCount !== 1 ? 's' : ''}</div>
                </div>
            `;

            card.onclick = (e) => {
                if (!e.target.closest('.btn-reexibir-pessoa')) {
                    mostrarDetalhesPessoa(indexOriginal);
                }
            };

            if (listaOcultas) listaOcultas.appendChild(card);
        });
    }
}

function mostrarDetalhesPessoa(index) {
    const pessoa = credenciaisAnalisadas[index];
    const listaContainer = document.getElementById('pessoas-lista-container');
    const detalhesContainer = document.getElementById('pessoa-detalhes-container');
    const modalContent = document.querySelector('.modal-credenciais-content');
    if (!pessoa || !listaContainer || !detalhesContainer) return;

    listaContainer.style.display = 'none';
    detalhesContainer.style.display = 'block';

    const iniciais = obterIniciais(pessoa.nome);
    const cor = gerarCorAvatar(pessoa.nome);

    let detalhesHTML = `
        <button class="btn-voltar-lista" onclick="voltarListaPessoas()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Voltar
        </button>
        <div class="pessoa-detalhes-header">
            <div class="pessoa-avatar" style="background-color: ${cor};">${iniciais}</div>
            <div class="pessoa-detalhes-info">
                <div class="pessoa-detalhes-nome">${pessoa.nome}</div>
            </div>
        </div>
        <div class="pessoa-detalhes-body">
    `;

    pessoa.emails.forEach((email) => {
        detalhesHTML += `
            <div class="detalhe-item">
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 4h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"></path>
                        <polyline points="22 6 12 13 2 6"></polyline>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">E-mail</div>
                    <div class="detalhe-valor">${email}</div>
                </div>
            </div>
        `;
    });

    pessoa.telefones.forEach((telefone) => {
        detalhesHTML += `
            <div class="detalhe-item">
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 16.92a1.93 1.93 0 0 1-2.12 1.92 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A1.93 1.93 0 0 1 4.12 2h3a2 2 0 0 1 2 1.72 12.86 12.86 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.86 12.86 0 0 0 2.81.7A2 2 0 0 1 22 16.92Z"></path>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">Telefone</div>
                    <div class="detalhe-valor">${telefone}</div>
                </div>
            </div>
        `;
    });

    pessoa.cpfs.forEach((cpf) => {
        detalhesHTML += `
            <div class="detalhe-item">
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">CPF</div>
                    <div class="detalhe-valor">${cpf}</div>
                </div>
            </div>
        `;
    });

    pessoa.links.forEach((link) => {
        let linkAbreviado = link;
        try {
            const url = new URL(link);
            linkAbreviado = url.hostname.replace('www.', '');
        } catch (_err) {
            linkAbreviado = link.length > 30 ? `${link.substring(0, 30)}...` : link;
        }

        detalhesHTML += `
            <div class="detalhe-item">
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">Link</div>
                    <div class="detalhe-valor"><a href="${link}" target="_blank" rel="noopener noreferrer">${linkAbreviado}</a></div>
                </div>
            </div>
        `;
    });

    pessoa.cartoes.forEach((cartao, idx) => {
        let numeroMascarado = cartao.numero;
        if (numeroMascarado && numeroMascarado.length >= 4) {
            const ultimos4 = numeroMascarado.slice(-4);
            numeroMascarado = '•••• •••• •••• ' + ultimos4;
        } else if (numeroMascarado) {
            numeroMascarado = '••••';
        }

        const cartaoId = `cartao-${idx}`;

        detalhesHTML += `
            <div class="detalhe-item">
                <button class="btn-revelar-cartao" onclick="toggleCartaoVisibilidade('${cartaoId}')" title="Mostrar/Ocultar">
                    <svg id="${cartaoId}-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                <div class="detalhe-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                </div>
                <div class="detalhe-content">
                    <div class="detalhe-label">Cartão ${cartao.bandeira || ''}</div>
                    <div class="detalhe-valor">
                        <span id="${cartaoId}-numero">${numeroMascarado}</span>
                        <span id="${cartaoId}-numero-completo" style="display: none;">${cartao.numero}</span>
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.7; margin-top: 4px;">
                        <div id="${cartaoId}-validade">${cartao.validade ? `Validade: ${cartao.validade}` : ''}</div>
                        <div id="${cartaoId}-cvv" style="display: none; margin-top: 2px;">${cartao.cvv ? `CVV: ${cartao.cvv}` : ''}</div>
                    </div>
                </div>
            </div>
        `;
    });

    detalhesHTML += '</div>';
    detalhesContainer.innerHTML = detalhesHTML;

    if (modalContent) modalContent.scrollTop = 0;
}

function voltarListaPessoas() {
    const listaContainer = document.getElementById('pessoas-lista-container');
    const detalhesContainer = document.getElementById('pessoa-detalhes-container');
    const modalContent = document.querySelector('.modal-credenciais-content');
    if (!listaContainer || !detalhesContainer) return;

    listaContainer.style.display = 'grid';
    detalhesContainer.style.display = 'none';
    if (modalContent) modalContent.scrollTop = 0;
}

function ocultarPessoa(nomeNormalizado) {
    if (!pessoasOcultas.includes(nomeNormalizado)) {
        pessoasOcultas.push(nomeNormalizado);
        salvarPessoasOcultas();
        renderizarListaPessoas();
    }
}

function reexibirPessoa(nomeNormalizado) {
    pessoasOcultas = pessoasOcultas.filter((nome) => nome !== nomeNormalizado);
    salvarPessoasOcultas();
    renderizarListaPessoas();
}

function toggleCredenciaisOcultas() {
    const header = document.querySelector('.credenciais-ocultas-header');
    const lista = document.getElementById('credenciais-ocultas-lista');
    if (header) header.classList.toggle('expandido');
    if (lista) lista.classList.toggle('expandido');
}

function toggleCartaoVisibilidade(cartaoId) {
    const numeroMascarado = document.getElementById(`${cartaoId}-numero`);
    const numeroCompleto = document.getElementById(`${cartaoId}-numero-completo`);
    const cvv = document.getElementById(`${cartaoId}-cvv`);
    const icon = document.getElementById(`${cartaoId}-icon`);
    if (!numeroMascarado || !numeroCompleto || !icon) return;

    const mostrandoCompleto = numeroCompleto.style.display !== 'none';
    if (!mostrandoCompleto) {
        numeroMascarado.style.display = 'none';
        numeroCompleto.style.display = 'inline';
        if (cvv) cvv.style.display = 'block';
        icon.innerHTML = `
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
            <line x1="1" y1="1" x2="23" y2="23"></line>
        `;
    } else {
        numeroMascarado.style.display = 'inline';
        numeroCompleto.style.display = 'none';
        if (cvv) cvv.style.display = 'none';
        icon.innerHTML = `
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
        `;
    }
}

function abrirModalCredenciais() {
    const modal = document.getElementById('modal-credenciais');
    const modalContent = modal ? modal.querySelector('.modal-credenciais-content') : null;
    if (!modal) return;

    renderizarListaPessoas();
    modal.style.display = 'block';
    document.body.classList.add('modal-open');
    setTimeout(() => { if (modalContent) modalContent.scrollTop = 0; }, 0);
}

function fecharModalCredenciais() {
    const modal = document.getElementById('modal-credenciais');
    if (!modal) return;
    modal.style.display = 'none';
    document.body.classList.remove('modal-open');
    voltarListaPessoas();
}

const credenciaisBox = document.getElementById('credenciais-analisadas-box');
const credenciaisBoxAnotacao = document.getElementById('credenciais-analisadas-box-anotacao');
const fecharCredenciaisBtn = document.getElementById('fechar-credenciais');
const modalCredenciais = document.getElementById('modal-credenciais');

if (credenciaisBox) credenciaisBox.addEventListener('click', abrirModalCredenciais);
if (credenciaisBoxAnotacao) credenciaisBoxAnotacao.addEventListener('click', abrirModalCredenciais);
if (fecharCredenciaisBtn) fecharCredenciaisBtn.addEventListener('click', fecharModalCredenciais);
if (modalCredenciais) {
    modalCredenciais.addEventListener('click', (e) => {
        if (e.target === modalCredenciais) fecharModalCredenciais();
    });
}

</script>

<style>

.notas-box {
    padding: 14px;
    margin: 12px auto;
    display: block;
    width: calc(100% - 32px);
    max-width: 600px;
    border-radius: var(--border-radius-inner);
    text-align: center; 
}

#modalDesenvolvimento .modalContent {
    width: calc(100% - 40px);
    max-width: 600px; 
    margin: 0 auto;
    padding: 22px;
    border-radius: var(--border-radius-main);
    box-shadow: 0 8px 32px 0 var(--shadow-color);
    background: var(--background-color);
    border: 1px solid var(--border-color);
}

#modalDesenvolvimento .modalButtons {
    margin-top: 20px;
}


#modalObservacoes {
    position: fixed !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    z-index: 1102 !important;
    display: none; 
    max-width: 600px !important;
}

#modalDesenvolvimento {
    z-index: 1100 !important;
}


.message-box.mobile-friendly,
#modalDesenvolvimento .modalContent {
    width: calc(100% - 40px) !important; 
    max-width: 600px !important; 
    margin: 0 auto !important;
    padding: 22px !important;
    border-radius: var(--border-radius-main) !important;
    box-sizing: border-box !important;
    text-align: left !important;
}


#modalDesenvolvimento .modalContent {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
}


@media (max-width: 768px) {
    .message-box {
        padding: 20px !important;
        width: calc(100% - 40px) !important;
        max-width: none !important;
        overflow-y: auto !important;
        max-height: 90vh !important;
        border-radius: calc(var(--border-radius-main) * 0.75) !important;
    }
    .message-box button {
        width: 100% !important;
        margin-top: 15px !important;
        min-height: 44px !important; 
        padding: 12px 0 !important;
        font-size: 1rem !important;
    }
    .message-box h2 {
        font-size: 1.2rem !important;
        margin-bottom: 15px !important;
    }
    .changelog {
        max-height: 40vh !important;
        font-size: 0.9rem !important;
        padding-right: 10px !important;
    }
    .message-box .modalButtons {
        flex-direction: column !important;
        gap: 10px !important;
        margin-top: 15px !important;
    }
    
    .changelog::-webkit-scrollbar {
        width: 6px !important;
    }
    .changelog::-webkit-scrollbar-track {
        background: var(--input-bg) !important;
        border-radius: 3px !important;
    }
    .changelog::-webkit-scrollbar-thumb {
        background: var(--border-color) !important;
        border-radius: 3px !important;
    }
}
</style>
<style>
/* Centralizar botões dentro de modais/caixas (não afeta botões da tela principal) */
/* Aplica-se apenas a botões dentro de .modal, .modalContent e .message-box */
.modal .modalButtons,
.modalContent .modalButtons,
.message-box .modalButtons,
.message-box .modal-footer,
.message-box footer,
.modal .modal-footer,
.modalContent .modal-footer {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 12px !important;
    flex-wrap: wrap !important;
}

/* Caso o botão seja único dentro do container, garantir que ele fique centralizado */
.message-box > button,
.modal .modalContent > button,
.modal > .modalContent > .modalButtons > button,
.message-box .btn-primary,
.message-box .btn-secondary {
    margin: 0 auto !important;
}

/* Não tocar botões da interface principal: escopo limitado aos modais e message-box */
</style>
<style>
/* Forçar tamanho mais amigável do modal de Desenvolvimento em telas pequenas */
@media (max-width: 480px) {
    /* Centraliza o modal e limita sua altura para evitar tela cheia estranha */
    #modalDesenvolvimento {
        align-items: center !important;
        justify-content: center !important;
        padding: 0 !important;
    }

    #modalDesenvolvimento .modalContent {
        width: calc(100% - 40px) !important;
        max-width: 360px !important; /* largura confortável em celular */
        margin: 0 auto !important;
        padding: 16px !important;
        box-shadow: 0 14px 40px rgba(0,0,0,0.45) !important;
        border-radius: 16px !important;
        max-height: 80vh !important; /* evita ocupar toda a viewport */
        overflow-y: auto !important;
        align-self: center !important;
    }

    /* Evita que regras globais de .modalContent para mobile (min-height:100vh) causem full-screen */
    .modal .modalContent {
        min-height: auto !important;
    }

    /* Ajustes internos: reduzir gaps que podem empurrar o conteúdo para fora */
    #modalDesenvolvimento .action-grid {
        gap: 8px !important;
    }
}
</style>
<style>
/* Manter os botões Salvar/Time/Updates SEMPRE lado a lado (mobile inclusive) */
@media (max-width: 480px) {
    #modalObservacoes .action-buttons {
        display: flex !important;
        flex-direction: row !important;
        justify-content: center !important;
        align-items: center !important;
        gap: 8px !important;
        flex-wrap: nowrap !important;
    }
    /* Tamanhos icon-only já ajustados acima; aqui apenas reforço se necessário */
    #modalObservacoes .action-buttons > button {
        height: 40px !important;
        padding: 0 8px !important;
        min-width: 0 !important;
        white-space: nowrap !important;
        flex: 1 1 0 !important; /* dividir igualmente a largura, sem scroll */
        width: auto !important; /* neutraliza qualquer width:100% herdado */
    }
}
</style>
<style>
/* Garantir que os botões 'Leitura' e 'Sair' nas top-bars de app e anotacoes fiquem lado-a-lado */
#app .top-bar > div,
#anotacoesApp .top-bar > div {
    display: flex !important;
    flex-direction: row !important;
    gap: 8px !important;
    align-items: center !important;
    justify-content: flex-end !important; /* mantém à direita, ao lado do título */
    flex-wrap: nowrap !important; /* força ficar em linha */
}

#app .top-bar > div button,
#anotacoesApp .top-bar > div button {
    min-width: 0 !important;
}

/* Em telas extremamente estreitas permitimos overflow horizontal dentro da top-bar */
@media (max-width: 320px) {
    #app .top-bar > div,
    #anotacoesApp .top-bar > div {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }
}
</style>
<style>
/* Centralizar botões específicos solicitados pelo usuário */
/* Botão Voltar na caixa de senha numérica */
#anotacoesLogin #btnVoltarLoginAnotacoes {
    display: block !important;
    margin: 16px auto !important;
}

/* Botões na caixa de certificado: Iniciar Instalação e Voltar */
#certificado #btnInstalar,
#certificado #btnVoltarLogin {
    display: block !important;
    margin: 12px auto !important;
}

/* Em telas muito pequenas, garantir toque confortável */
@media (max-width: 360px) {
    #anotacoesLogin #btnVoltarLoginAnotacoes,
    #certificado #btnInstalar,
    #certificado #btnVoltarLogin {
        width: calc(100% - 40px) !important;
        min-width: 160px !important;
    }
}
    /* Tornar os textos dos botões na caixa de certificado em MAIÚSCULAS */
    #certificado #btnInstalar,
    #certificado #btnVoltarLogin {
        text-transform: uppercase !important;
        min-width: 96px;
        padding: 6px 10px;
        letter-spacing: 0.6px !important;
    }
</style>
    <style>
    /* 1) Colocar os botões INICIAR INSTALAÇÃO e VOLTAR lado a lado no certificado */
    #certificado {
        text-align: center !important; /* centraliza conteúdos inline como botões */
    }
    /* Novo container para os botões do certificado */
    #certificado .cert-buttons {
        display: flex !important;
        gap: 20px !important;
        justify-content: center !important;
        align-items: center !important;
        margin-top: 36px !important;
        flex-wrap: wrap !important;
    }
    #certificado .cert-buttons button {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 6px 6px !important;
        padding: 10px 14px !important;
        min-width: 120px !important;
        font-size: 0.95rem !important;
        border-radius: 10px !important;
        box-sizing: border-box !important;
    }

    /* 2) Mais espaçamento para o botão Preencher Automaticamente no modal de senha */
    #btn-autofill-trigger {
        margin-bottom: 28px !important; /* maior espaçamento abaixo */
        padding: 12px 18px !important; /* mais confortável para toque */
    }

    /* 3) Formulário Automático: botões lado a lado */
    #autoFillForm .modalButtons {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: wrap !important;
        gap: 12px !important;
        align-items: center !important;
        justify-content: center !important;
    }
    #autoFillForm .modalButtons button {
        width: auto !important;
        min-width: 130px !important;
        padding: 10px 14px !important;
        flex: 0 0 auto !important;
    }
    #autoFillForm .modalButtons #btn-autofill-form-back {
        margin: 0 !important;
        display: inline-flex !important;
    }

    @media (max-width: 540px) {
        #autoFillForm .modalButtons {
            justify-content: center !important;
        }
        #autoFillForm .modalButtons button {
            flex: 1 1 48% !important;
            min-width: 0 !important;
        }
    }

    /* Em telas muito pequenas, garantir toque confortável - reduzir largura dos botões do certificado */
    @media (max-width: 360px) {
        #anotacoesLogin #btnVoltarLoginAnotacoes,
        #certificado .cert-buttons button {
            width: calc(100% - 40px) !important;
            min-width: 140px !important;
        }
    }
    
    /* Espaçamento extra entre textos e botões de upload/download */
    #btnRealizarUpload {
        margin-top: 40px !important;
    }
    .message-box p {
        margin-bottom: 26px !important;
    }
    /* Mais espaço abaixo do texto "CERTIFICADO DIGITAL" antes dos botões */
    #certificado .codigo-box {
        margin-bottom: 36px !important;
    }
    /* Reduzir espaçamento especificamente entre CERTIFICADO DIGITAL e PLUG-IN DIGITAL */
    #certificado #certTitulo {
        margin-bottom: 8px !important;
    }
    #pluginDigitalBox {
        margin-top: 8px !important;
        /* manter um espaçamento razoável abaixo para os próximos elementos */
        margin-bottom: 20px !important;
    }
        </style>
        <style>
        /* Ajustes de visualização dos formulários no celular */
        @media (max-width: 768px) {
            /* Usar largura quase total da viewport com margens laterais seguras */
            #login, #certificado, #anotacoesLogin, #acessoEspecial, #recuperarPin,
            #app, #anotacoesApp, #autoFillSettings, #autoFillForm,
            .modalContent {
                max-width: none !important;
                width: calc(100vw - 24px) !important; /* 12px de margem em cada lado */
                margin: 16px auto !important; /* espaço superior e inferior */
                border-radius: var(--border-radius-main) !important; /* garantir cantos arredondados */
                overflow: hidden !important; /* clipe do conteúdo para exibir o arredondamento */
            }

            /* Mais respiro vertical interno nos formulários e modais */
            #login, #certificado, #anotacoesLogin, #acessoEspecial, #recuperarPin,
            #app, #anotacoesApp, #autoFillSettings, #autoFillForm,
            .modalContent {
                padding-top: 24px !important;
                padding-bottom: 24px !important;
            }
        }
        </style>
            <style>
            /* Botões com estilo Liquid Glass consistente com o tema do site */
                .modalButtons {
                background: transparent !important;
                padding: 0 !important;
                }
                .modalButtons button {
                background: var(--button-bg) !important;
                border: none !important;
                color: var(--button-text-color) !important;
                border-radius: var(--border-radius-inner) !important;
                transition: all 0.3s ease !important;
                box-sizing: border-box !important;
                -webkit-appearance: none !important;
                appearance: none !important;
                box-shadow: none !important;
                outline: none !important;
                -webkit-tap-highlight-color: transparent !important;
                text-decoration: none !important;
                position: relative !important;
                z-index: 1 !important;
            }
            .modalButtons button:hover {
                background: var(--button-hover-bg) !important;
                transform: translateY(-2px) !important;
                box-shadow: none !important;
                outline: none !important;
            }
            .modalButtons button.primary-action,
            .modalButtons button[type="submit"],
            #btn-autofill-save {
                background: var(--primary-accent) !important;
                border: none !important;
                color: #fff !important;
                box-shadow: none !important;
                outline: none !important;
            }
            .modalButtons button.primary-action:hover,
            .modalButtons button[type="submit"]:hover,
            #btn-autofill-save:hover {
                background: var(--primary-accent-hover) !important;
                transform: translateY(-2px) !important;
                box-shadow: none !important;
                outline: none !important;
            }
            .modalButtons button:focus,
            .modalButtons button:active,
            #btn-autofill-save:focus,
            #btn-autofill-save:active {
                outline: none !important;
                box-shadow: none !important;
                border: none !important;
            }
            </style>
                <style>
                /* Formulário Automático: padronizar largura do botão Voltar */
                #autoFillSettings #btn-autofill-back-to-app {
                    width: 100% !important;
                    padding: 14px 0 !important;
                    font-size: 1rem !important;
                    border-radius: var(--border-radius-inner) !important;
                    display: block !important;
                }
                </style>
                    <style>
                    /* Estilo para botões apenas com ícone nas cartas */
                            .card-buttons button.icon-only {
                            width: 38px !important;
                            height: 38px !important;
                            min-width: 38px !important;
                            padding: 6px !important;
                            display: inline-flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                                border-radius: 10px !important; /* quadrado com cantos arredondados */
                            background: var(--button-bg) !important;
                            border: 1px solid var(--border-color) !important;
                            color: var(--button-text-color) !important;
                            transition: transform .15s ease, box-shadow .2s ease, background-color .2s ease, color .2s ease !important;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.12) !important;
                            backdrop-filter: blur(4px);
                            -webkit-backdrop-filter: blur(4px);
                        }
                        .card-buttons button.icon-only:hover {
                            background: var(--button-hover-bg) !important;
                            transform: translateY(-1px) scale(1.03);
                            box-shadow: 0 6px 18px rgba(0,0,0,0.18) !important;
                        }
                        .card-buttons button.icon-only:active {
                            transform: translateY(0) scale(0.98);
                            box-shadow: 0 2px 8px rgba(0,0,0,0.12) !important;
                        }
                        .card-buttons button.icon-only svg {
                            width: 20px;
                            height: 20px;
                            display: block;
                        }

                        /* Variantes por ação */
                        .card-buttons button.icon-only.view:hover,
                        .card-buttons button.icon-only.download:hover,
                        .card-buttons button.icon-only.edit:hover {
                            color: var(--primary-accent) !important;
                        }

                        /* Excluir com visual de perigo sutil */
                        .card-buttons button.icon-only.excluir,
                        .card-buttons button.icon-only.delete {
                            background-color: rgba(255, 59, 48, 0.08) !important; /* danger-accent com leve transparência */
                            border-color: rgba(255, 59, 48, 0.35) !important;
                            color: var(--danger-accent) !important;
                        }
                        .card-buttons button.icon-only.excluir:hover,
                        .card-buttons button.icon-only.delete:hover {
                            background-color: rgba(255, 59, 48, 0.15) !important;
                            box-shadow: 0 6px 18px rgba(255, 59, 48, 0.25) !important;
                            transform: translateY(-1px) scale(1.03);
                        }
                        .card-buttons button.icon-only.excluir:active,
                        .card-buttons button.icon-only.delete:active {
                            transform: translateY(0) scale(0.98);
                        }
                    </style>
                        <style>
                        /* Mais espaço entre o título da categoria e o conteúdo */
                        .board-column h3 {
                            margin-bottom: 14px !important;
                        }
                        </style>
                        <style>
                        /* Visualização completa com o mesmo estilo das caixinhas */
                        #visualizacao-content.view-content {
                            text-align: left;
                            margin-top: 10px;
                        }
                        #visualizacao-content .view-meta {
                            display: flex;
                            flex-direction: column;
                            gap: 12px;
                            margin-top: 12px;
                        }
                        #visualizacao-content .chip {
                            display: flex;
                            align-items: center;
                            justify-content: flex-start;
                            gap: 10px;
                            width: 100%;
                            min-height: 42px;
                            padding: 10px 12px;
                            border: 1px solid var(--border-color);
                            background: var(--input-bg);
                            border-radius: var(--border-radius-inner);
                            font-size: 0.95rem;
                        }
                        #visualizacao-content .chip-label {
                            opacity: 0.7;
                        }
                        #visualizacao-content .chip-label::after {
                            content: ":";
                            margin: 0 4px 0 2px;
                            opacity: 0.6;
                        }
                        #visualizacao-content .chip-value {
                            font-weight: 600;
                            flex: 1 1 auto;
                            min-width: 0;
                            overflow: hidden;
                            white-space: nowrap;
                            text-overflow: ellipsis;
                        }
                        #visualizacao-content .links-chip a {
                            display: block;
                            width: 100%;
                            padding: 10px 12px;
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius-inner);
                            background: var(--input-bg);
                            color: var(--primary-accent);
                            text-decoration: none;
                            font-size: 0.95rem;
                            overflow: hidden;
                            white-space: nowrap;
                            text-overflow: ellipsis;
                        }
                        #visualizacao-content .links-chip a:hover {
                            text-decoration: underline;
                        }
                        #visualizacao-content .notes-full {
                            padding: 10px 12px;
                            border: 1px solid var(--border-color);
                            border-radius: var(--border-radius-inner);
                            background: var(--input-bg);
                            font-size: 0.95rem;
                            line-height: 1.5;
                            color: var(--text-color);
                            word-wrap: break-word;
                        }
                        #visualizacao-content .view-cards {
                            display: flex;
                            flex-direction: column;
                            gap: 12px;
                            align-items: stretch;
                            width: 100%;
                        }
                        #visualizacao-content .view-card {
                            box-shadow: 0 4px 14px rgba(0,0,0,0.18);
                        }
                        #visualizacao-content .btn-revelar-cartao {
                            position: absolute !important;
                            top: 8px !important;
                            right: 8px !important;
                            width: 22px !important;
                            height: 22px !important;
                            padding: 4px !important;
                            display: inline-flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            flex: 0 0 auto !important;
                            box-sizing: border-box !important;
                        }
                        #visualizacao-content .view-card .card-icon {
                            width: 24px;
                            height: 24px;
                            flex-shrink: 0;
                            color: var(--primary-accent);
                        }
                        #visualizacao-content .view-card .card-icon svg {
                            width: 100%;
                            height: 100%;
                        }
                        #visualizacao-content .view-card .card-body {
                            flex: 1;
                            min-width: 0;
                        }
                        #visualizacao-content .view-card .card-title {
                            font-weight: 600;
                            opacity: 0.9;
                            margin-bottom: 6px;
                        }
                        #visualizacao-content .view-card .card-number {
                            font-weight: 700;
                            letter-spacing: 1.4px;
                            color: var(--text-color);
                        }
                        #visualizacao-content .view-card .card-meta {
                            display: flex;
                            gap: 12px;
                            flex-wrap: wrap;
                            font-size: 0.9rem;
                            opacity: 0.8;
                            margin-top: 6px;
                        }
                        
                        .board-column[data-marcador-importante="true"] {
                            border: 3px solid var(--marcador-cor-importante) !important;
                        }
                        
                        .alerta-revisao {
                            background: rgba(255, 159, 0, 0.15);
                            border: 2px solid rgba(255, 159, 0, 0.5);
                            border-radius: var(--border-radius-inner);
                            padding: 12px 16px;
                            margin: 16px 0;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            color: var(--text-color);
                        }
                        
                        .alerta-revisao svg {
                            flex-shrink: 0;
                            stroke: #FF9500;
                        }
                        
                        .alerta-revisao span {
                            flex: 1;
                            font-size: 0.95rem;
                        }
                        
                        .alerta-revisao button {
                            background: rgba(255, 159, 0, 0.3);
                            border: 1px solid rgba(255, 159, 0, 0.6);
                            color: var(--text-color);
                            padding: 8px 16px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.3s ease;
                            white-space: nowrap;
                        }
                        
                        .alerta-revisao button:hover {
                            background: rgba(255, 159, 0, 0.5);
                            border-color: #FF9500;
                        }
                        </style>
</body>
</html>
